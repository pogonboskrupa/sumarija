<!DOCTYPE html>
<html lang="bs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>≈†umarija - Preglednik</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #F6F7F9; min-height: 100vh; color: #1f2937; }
        .login-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; }
        .login-box { background: white; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); padding: 40px; max-width: 400px; width: 100%; }
        .login-box h1 { text-align: center; font-size: 64px; margin-bottom: 16px; }
        .login-box h2 { text-align: center; font-size: 32px; font-weight: bold; color: #1f2937; margin-bottom: 8px; }
        .login-box p { text-align: center; color: #6b7280; margin-bottom: 30px; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 4px; }
        .form-group input { width: 100%; padding: 12px 16px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 16px; }
        .btn { width: 100%; background: #059669; color: white; padding: 12px; border-radius: 8px; border: none; font-size: 16px; font-weight: 600; cursor: pointer; }
        .btn:hover { background: #047857; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .error { background: #fee2e2; border: 1px solid #fecaca; color: #991b1b; padding: 12px; border-radius: 8px; font-size: 14px; margin-bottom: 16px; }
        .header { background: white; color: #1f2937; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 16px 24px; border-bottom: 1px solid #e5e7eb; }
        .header-content { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px; }
        .header-left { display: flex; align-items: center; gap: 12px; }
        .header-logo { font-size: 28px; }
        .header-title h1 { font-size: 18px; font-weight: 700; margin-bottom: 2px; color: #047857; }
        .header-title p { font-size: 12px; color: #6b7280; }
        .header-right { display: flex; align-items: center; gap: 16px; }
        .header-user { text-align: right; }
        .header-user-name { font-size: 13px; font-weight: 600; color: #1f2937; }
        .header-user-role { font-size: 11px; color: #6b7280; }
        .user-menu { position: relative; }
        .user-menu-button { background: #f3f4f6; color: #374151; padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .user-menu-button:hover { background: #e5e7eb; }
        .user-menu-dropdown { display: none; position: absolute; right: 0; top: 100%; margin-top: 8px; background: white; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); min-width: 200px; z-index: 1000; }
        .user-menu-dropdown.show { display: block; }
        .user-menu-item { padding: 12px 16px; cursor: pointer; font-size: 14px; color: #374151; border-bottom: 1px solid #f3f4f6; }
        .user-menu-item:hover { background: #f9fafb; }
        .user-menu-item:last-child { border-bottom: none; }
        .user-menu-item.danger { color: #dc2626; }
        .user-menu-item.danger:hover { background: #fee2e2; }
        .btn-logout { background: #dc2626; color: white; padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-size: 13px; font-weight: 600; }
        .btn-logout:hover { background: #b91c1c; }
        .container { max-width: 1200px; margin: 0 auto; padding: 32px 24px; }
        .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 28px; }
        .card { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 24px; border: 1px solid #f3f4f6; transition: all 0.2s; }
        .card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-color: #e5e7eb; }
        .card-label { font-size: 13px; color: #6b7280; margin-bottom: 8px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.05em; }
        .card-value { font-size: 32px; font-weight: 700; }
        .card-value.green { color: #059669; }
        .card-value.blue { color: #2563eb; }
        .card-value.red { color: #dc2626; }
        .section { background: white; border-radius: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 32px; margin-bottom: 24px; }
        .section h2 { font-size: 20px; font-weight: bold; margin-bottom: 8px; color: #1f2937; }
        .section p { font-size: 14px; color: #6b7280; margin-bottom: 24px; }

        /* Page Header */
        .page-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px; flex-wrap: wrap; gap: 16px; }
        .page-header-left h1 { font-size: 24px; font-weight: 700; color: #1f2937; margin-bottom: 4px; }
        .page-header-left p { font-size: 14px; color: #6b7280; }
        .page-header-right { display: flex; gap: 8px; align-items: center; }
        .badge { display: inline-block; padding: 6px 12px; background: #e0e7ff; color: #3730a3; border-radius: 12px; font-size: 12px; font-weight: 600; }
        .notification-badge { position: relative; display: inline-block; }
        .notification-badge .badge-count { position: absolute; top: -8px; right: -8px; background: #dc2626; color: white; border-radius: 10px; padding: 2px 6px; font-size: 11px; font-weight: 700; min-width: 18px; text-align: center; display: none; }
        .notification-badge .badge-count.show { display: block; }
        .badge.success { background: #d1fae5; color: #047857; }
        .badge.warning { background: #fef3c7; color: #92400e; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; }
        thead { background: #f9fafb; position: sticky; top: 0; z-index: 10; }
        thead::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 2px; background: #e5e7eb; }
        th { padding: 14px 12px; text-align: left; font-size: 11px; font-weight: 700; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; white-space: nowrap; }
        th.right { text-align: right; }
        td { padding: 14px 12px; font-size: 14px; border-bottom: 1px solid #f3f4f6; color: #374151; }
        td.right { text-align: right; font-variant-numeric: tabular-nums; font-weight: 500; }
        tbody tr:nth-child(even) { background: #f9fafb; }
        tbody tr:hover { background: #f0f9ff; }
        td.green { color: #059669; }
        td.blue { color: #2563eb; }
        td.red { color: #dc2626; }
        .loading { text-align: center; padding: 60px 20px; }
        .loading-icon { font-size: 48px; margin-bottom: 16px; }
        .loading-text { font-size: 18px; color: #374151; font-weight: 600; }
        .loading-sub { font-size: 14px; color: #6b7280; margin-top: 8px; }
        .hidden { display: none; }
        .chart-container { margin-top: 20px; }
        .bar { display: flex; gap: 8px; margin-bottom: 12px; align-items: center; }
        .bar-label { width: 100px; font-size: 13px; color: #374151; font-weight: 500; }
        .bar-group { flex: 1; display: flex; gap: 4px; }
        .bar-item { height: 30px; border-radius: 4px; display: flex; align-items: center; justify-content: flex-end; padding: 0 8px; color: white; font-size: 12px; font-weight: 600; }
        .bar-item.green { background: #059669; }
        .bar-item.blue { background: #2563eb; }
        .chart-svg { width: 100%; height: 300px; margin-top: 20px; }
        .monthly-table { margin-top: 20px; }
        .monthly-table tbody tr:hover { background: #f9fafb; }
        .progress-bar-container { background: #e5e7eb; height: 8px; border-radius: 4px; overflow: hidden; margin-top: 4px; }
        .progress-bar-fill { background: #059669; height: 100%; border-radius: 4px; transition: width 0.3s ease; }
        .odjel-detail { font-size: 12px; color: #6b7280; margin-top: 4px; }
        .line-legend { display: flex; gap: 20px; justify-content: center; margin-bottom: 16px; font-size: 14px; }
        .line-legend-item { display: flex; align-items: center; gap: 8px; }
        .line-legend-color { width: 30px; height: 3px; border-radius: 2px; }
        .line-legend-color.green { background: #059669; }
        .line-legend-color.blue { background: #2563eb; }

        /* Tabs navigation */
        .tabs-container { background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-bottom: 1px solid #e5e7eb; }
        .tabs { max-width: 1200px; margin: 0 auto; display: flex; gap: 4px; padding: 0 24px; overflow-x: auto; }
        .tab { background: transparent; border: none; padding: 14px 20px; font-size: 14px; font-weight: 600; color: #6b7280; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; white-space: nowrap; }
        .tab:hover { color: #374151; background: #f9fafb; }
        .tab.active { color: #047857; border-bottom-color: #047857; background: #f0fdf4; }

        /* Submenu styles */
        .submenu { display: flex; gap: 8px; margin-bottom: 24px; padding: 12px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb; }
        .submenu-tab { background: white; border: 1px solid #d1d5db; padding: 10px 18px; font-size: 13px; font-weight: 600; color: #6b7280; cursor: pointer; border-radius: 6px; transition: all 0.2s; white-space: nowrap; }
        .submenu-tab:hover { color: #047857; background: #f0fdf4; border-color: #059669; }
        .submenu-tab.active { color: white; background: #047857; border-color: #047857; box-shadow: 0 2px 4px rgba(5, 150, 105, 0.2); }
        .submenu-content { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* Sub-tabs for IZVJE≈†TAJI */
        .sub-tabs { display: flex; gap: 12px; padding: 16px; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); flex-wrap: wrap; }
        .sub-tab { background: white; border: 2px solid #e5e7eb; padding: 12px 24px; font-size: 14px; font-weight: 600; color: #6b7280; cursor: pointer; border-radius: 8px; transition: all 0.2s; white-space: nowrap; }
        .sub-tab:hover { color: #047857; background: #f0fdf4; border-color: #10b981; }
        .sub-tab.active { color: white; background: #047857; border-color: #047857; box-shadow: 0 2px 8px rgba(5, 150, 105, 0.3); }
        .sub-content { animation: fadeIn 0.3s ease-in; }
        .sub-content.hidden { display: none; }

        /* Month selector */
        .month-selector { margin-bottom: 16px; padding: 12px; background: #f0fdf4; border-radius: 8px; border: 1px solid #bbf7d0; display: flex; align-items: center; gap: 12px; }
        .month-selector label { font-weight: 600; color: #047857; font-size: 14px; }
        .month-select { padding: 8px 12px; border: 1px solid #059669; border-radius: 6px; font-size: 14px; font-weight: 600; color: #047857; background: white; cursor: pointer; min-width: 150px; }
        .month-select:hover { background: #f0fdf4; }
        .month-select:focus { outline: none; border-color: #047857; box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1); }

        /* Summary cards */
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 28px; }
        .summary-card { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #f3f4f6; transition: all 0.2s; }
        .summary-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-color: #e5e7eb; }
        .summary-card-title { font-size: 12px; color: #6b7280; margin-bottom: 8px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
        .summary-card-value { font-size: 28px; font-weight: 700; color: #1f2937; font-variant-numeric: tabular-nums; }
        .summary-card-subtitle { font-size: 12px; color: #9ca3af; margin-top: 6px; }
        .summary-card.green .summary-card-value { color: #059669; }
        .summary-card.blue .summary-card-value { color: #2563eb; }
        .summary-card.red .summary-card-value { color: #dc2626; }

        /* Chart container */
        .chart-container { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 24px; height: 400px; }

        /* Search and controls */
        .controls-bar { display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; align-items: center; }
        .search-input { padding: 10px 16px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; flex: 1; min-width: 200px; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: #047857; color: white; }
        .btn-primary:hover { background: #059669; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-secondary:hover { background: #4b5563; }

        /* Filter Bar - Advanced */
        .filter-bar { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        .filter-bar-title { font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.05em; }
        .filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; }
        .filter-group { display: flex; flex-direction: column; gap: 6px; }
        .filter-label { font-size: 12px; font-weight: 600; color: #6b7280; }
        .filter-input, .filter-select { padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; background: white; color: #1f2937; }
        .filter-input:focus, .filter-select:focus { outline: none; border-color: #047857; box-shadow: 0 0 0 3px rgba(4, 120, 87, 0.1); }
        .filter-actions { display: flex; gap: 8px; align-items: flex-end; }
        .filter-actions .btn { padding: 10px 16px; font-size: 13px; }
        .btn-clear { background: #f3f4f6; color: #374151; }
        .btn-clear:hover { background: #e5e7eb; }

        /* Row Actions Dropdown */
        .row-actions { position: relative; }
        .row-actions-btn { background: transparent; border: none; cursor: pointer; padding: 8px; border-radius: 6px; color: #6b7280; font-size: 18px; line-height: 1; }
        .row-actions-btn:hover { background: #f3f4f6; color: #374151; }
        .row-actions-dropdown { display: none; position: absolute; right: 0; top: 100%; margin-top: 4px; background: white; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); min-width: 160px; z-index: 100; border: 1px solid #e5e7eb; }
        .row-actions-dropdown.show { display: block; }
        .row-actions-item { padding: 10px 14px; cursor: pointer; font-size: 13px; color: #374151; border-bottom: 1px solid #f3f4f6; display: flex; align-items: center; gap: 8px; }
        .row-actions-item:hover { background: #f9fafb; }
        .row-actions-item:last-child { border-bottom: none; }
        .row-actions-item.danger { color: #dc2626; }
        .row-actions-item.danger:hover { background: #fee2e2; }

        /* Confirm Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal-overlay.show { display: flex; }
        .modal { background: white; border-radius: 16px; padding: 24px; max-width: 400px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .modal-header { margin-bottom: 16px; }
        .modal-title { font-size: 18px; font-weight: 700; color: #1f2937; }
        .modal-body { margin-bottom: 24px; font-size: 14px; color: #6b7280; line-height: 1.6; }
        .modal-footer { display: flex; gap: 12px; justify-content: flex-end; }
        .modal-footer .btn { padding: 10px 20px; }
        .btn-danger { background: #dc2626; color: white; }
        .btn-danger:hover { background: #b91c1c; }

        /* Column Grouping */
        .col-group-cetinari { background: linear-gradient(to bottom, #f0fdf4 0%, #dcfce7 100%); border-left: 2px solid #10b981; border-right: 2px solid #10b981; }
        .col-group-liscari { background: linear-gradient(to bottom, #fef3c7 0%, #fde68a 100%); border-left: 2px solid #f59e0b; border-right: 2px solid #f59e0b; }
        body.dark-mode .col-group-cetinari { background: linear-gradient(to bottom, #064e3b 0%, #065f46 100%); }
        body.dark-mode .col-group-liscari { background: linear-gradient(to bottom, #78350f 0%, #92400e 100%); }

        /* Dark mode */
        body.dark-mode { background: #1f2937; color: #f3f4f6; }
        body.dark-mode .container, body.dark-mode .section, body.dark-mode table,
        body.dark-mode .summary-card, body.dark-mode .chart-container,
        body.dark-mode .tabs-container { background: #374151; color: #f3f4f6; border-color: #4b5563; }
        body.dark-mode table thead { background: #1f2937; }
        body.dark-mode .search-input { background: #4b5563; color: #f3f4f6; border-color: #6b7280; }

        /* Progress bar in table */
        .table-progress-bar { background: #e5e7eb; height: 4px; border-radius: 2px; overflow: hidden; margin-top: 4px; }
        .table-progress-fill { background: #059669; height: 100%; border-radius: 2px; }

        /* Kupci tables optimization */
        .kupci-table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; margin: 0 -24px; padding: 0 24px; }
        .kupci-table { font-size: 11px; white-space: nowrap; width: 100%; border-collapse: separate; border-spacing: 0; }
        .kupci-table th, .kupci-table td { padding: 8px 6px; border-bottom: 1px solid #e5e7eb; }
        .kupci-table th:first-child, .kupci-table td:first-child {
            position: sticky; left: 0; background: white; z-index: 2;
            min-width: 140px; max-width: 200px; white-space: normal;
            border-right: 2px solid #d1d5db; padding-right: 12px; font-weight: 600;
        }
        .kupci-table th:nth-child(2), .kupci-table td:nth-child(2) {
            position: sticky; left: 140px; background: white; z-index: 2;
            min-width: 90px; border-right: 2px solid #d1d5db; font-weight: 500;
        }
        body.dark-mode .kupci-table th:first-child, body.dark-mode .kupci-table td:first-child,
        body.dark-mode .kupci-table th:nth-child(2), body.dark-mode .kupci-table td:nth-child(2) { background: #374151; }
        .kupci-table thead th {
            background: linear-gradient(to bottom, #f9fafb 0%, #f3f4f6 100%);
            position: sticky !important; top: 0; z-index: 15 !important; font-weight: 700;
            border-top: 2px solid #10b981; border-bottom: 2px solid #10b981;
            padding: 12px 6px; text-transform: uppercase; font-size: 10px; letter-spacing: 0.5px;
        }
        /* Enhanced sticky for kupci godisnji and mjesecni tables */
        #kupci-godisnji-table thead th,
        #kupci-mjesecni-table thead th {
            position: sticky !important;
            top: 0;
            z-index: 15 !important;
        }
        #kupci-godisnji-table td:first-child,
        #kupci-mjesecni-table td:first-child {
            position: sticky !important;
            left: 0 !important;
            z-index: 10 !important;
        }
        #kupci-godisnji-table th:first-child,
        #kupci-mjesecni-table th:first-child {
            z-index: 20 !important;
        }
        body.dark-mode .kupci-table thead th { background: linear-gradient(to bottom, #1f2937 0%, #111827 100%); }
        .kupci-table tbody tr:nth-child(even) { background: #f9fafb; }
        body.dark-mode .kupci-table tbody tr:nth-child(even) { background: #2d3748; }
        .kupci-table tbody tr:hover { background: #f0fdf4; }
        body.dark-mode .kupci-table tbody tr:hover { background: #064e3b; }
        .kupci-table tbody tr:nth-child(even):hover { background: #ecfdf5; }
        body.dark-mode .kupci-table tbody tr:nth-child(even):hover { background: #065f46; }
        .kupci-table .sortiment-col { min-width: 62px; max-width: 75px; text-align: right; font-family: 'Courier New', monospace; }
        .kupci-table .ukupno-col {
            font-weight: bold; background: linear-gradient(to right, #f0fdf4 0%, #dcfce7 100%);
            min-width: 95px; border-left: 3px solid #10b981; text-align: right;
            font-size: 12px; font-family: 'Courier New', monospace;
        }
        body.dark-mode .kupci-table .ukupno-col { background: linear-gradient(to right, #064e3b 0%, #065f46 100%); }
        .kupci-table .totals-row {
            background: linear-gradient(to bottom, #dcfce7 0%, #bbf7d0 100%);
            font-weight: 700; font-size: 12px; border-top: 3px solid #10b981;
        }
        body.dark-mode .kupci-table .totals-row { background: linear-gradient(to bottom, #065f46 0%, #047857 100%); }
        .kupci-table .totals-row td { border-bottom: 3px solid #10b981; padding: 12px 6px; }

        /* ============================================
           MONTHLY SORTIMENTI TABLE STYLES
           ============================================ */
        .mjesecni-table-wrapper table {
            font-size: 11px !important;
            border-collapse: collapse;
            width: 100%;
        }
        .mjesecni-table-wrapper th {
            background: #1e40af !important;
            color: white !important;
            padding: 8px 4px !important;
            font-size: 11px !important;
            text-align: center;
            border: 1px solid #1e3a8a;
            position: sticky !important;
            top: 0;
            z-index: 10;
            white-space: nowrap;
            max-width: 70px;
        }
        .mjesecni-table-wrapper td {
            padding: 6px 3px !important;
            font-size: 11px !important;
            text-align: right;
            border: 1px solid #e5e7eb;
            white-space: nowrap;
        }
        .mjesecni-table-wrapper tbody tr:hover {
            background: #dbeafe !important;
        }
        /* Bold columns styling */
        .mjesecni-table-wrapper .col-cetinari { background: #fef3c7; font-weight: 700; }
        .mjesecni-table-wrapper .col-liscari { background: #d1fae5; font-weight: 700; }
        .mjesecni-table-wrapper .col-sveukupno { background: #e0e7ff; font-weight: 700; }
        /* Group separators */
        .mjesecni-table-wrapper .group-cetvrti th,
        .mjesecni-table-wrapper .group-cetvrti td {
            border-left: 2px solid #2563eb !important;
        }
        .mjesecni-table-wrapper .group-ogrevno th,
        .mjesecni-table-wrapper .group-ogrevno td {
            border-left: 2px solid #059669 !important;
        }
        /* Mobile optimization */
        @media (max-width: 768px) {
            .mjesecni-table-wrapper th,
            .mjesecni-table-wrapper td {
                font-size: 9px !important;
                padding: 4px 2px !important;
            }
            .mjesecni-table-wrapper th {
                max-width: 55px;
            }
        }

        /* ============================================
           PRIMACI & OTPREMACI TABLE STYLES
           ============================================ */
        #primaci-table, #otpremaci-table {
            border-collapse: collapse;
            width: 100%;
        }
        #primaci-table thead th, #otpremaci-table thead th {
            position: sticky !important;
            top: 0;
            z-index: 15 !important;
        }
        #primaci-table tbody tr, #otpremaci-table tbody tr {
            border-bottom: 1px solid #e5e7eb;
        }
        /* Ensure sticky columns work properly */
        #primaci-table td:first-child, #otpremaci-table td:first-child {
            position: sticky !important;
            left: 0 !important;
        }
        #primaci-table th:first-child, #otpremaci-table th:first-child {
            position: sticky !important;
            left: 0 !important;
        }
        /* Add box shadow for sticky elements */
        #primaci-table td:first-child::after, #otpremaci-table td:first-child::after {
            content: '';
            position: absolute;
            right: -1px;
            top: 0;
            bottom: 0;
            width: 1px;
            box-shadow: 2px 0 4px rgba(0,0,0,0.1);
        }

        /* ============================================
           MOBILE OPTIMIZATIONS (< 768px)
           ============================================ */
        @media (max-width: 768px) {
            /* Container & spacing */
            .container { padding: 12px; max-width: 100%; }
            .section { padding: 16px; margin-bottom: 16px; }
            .section h2 { font-size: 18px; margin-bottom: 12px; }

            /* Header */
            .header { flex-direction: column; gap: 12px; padding: 16px 12px; }
            .header-logo h1 { font-size: 20px; }
            .header-logo p { font-size: 13px; }
            .header-user { font-size: 12px; }
            .btn-logout { padding: 8px 16px; font-size: 13px; }

            /* Tabs - scrollable horizontal */
            .tabs { overflow-x: auto; -webkit-overflow-scrolling: touch; gap: 2px; padding: 0 12px; white-space: nowrap; }
            .tab { padding: 12px 16px; font-size: 13px; flex-shrink: 0; }

            /* Summary cards - stack vertically */
            .summary-cards { grid-template-columns: 1fr; gap: 12px; }
            .summary-card { padding: 16px; }
            .summary-card-title { font-size: 12px; }
            .summary-card-value { font-size: 24px; }

            /* Chart */
            .chart-container { height: 280px; padding: 16px; }

            /* Controls bar - stack vertically */
            .controls-bar { flex-direction: column; gap: 8px; }
            .search-input { width: 100%; min-width: auto; }
            .btn { width: 100%; padding: 12px; }

            /* Tables */
            table { font-size: 11px; }
            table th, table td { padding: 6px 4px; }
            .monthly-table th, .monthly-table td { font-size: 10px; padding: 6px 3px; }

            /* Kupci tables - optimized for mobile */
            .kupci-table-wrapper { margin: 0 -12px; padding: 0 12px; }
            .kupci-table { font-size: 10px; }
            .kupci-table th, .kupci-table td { padding: 6px 3px; }
            .kupci-table th:first-child, .kupci-table td:first-child {
                min-width: 100px; max-width: 140px; font-size: 10px;
            }
            .kupci-table th:nth-child(2), .kupci-table td:nth-child(2) {
                left: 100px; min-width: 70px; font-size: 10px;
            }
            .kupci-table thead th { font-size: 9px; padding: 8px 3px; }
            .kupci-table .sortiment-col { min-width: 50px; max-width: 60px; font-size: 10px; }
            .kupci-table .ukupno-col { min-width: 75px; font-size: 10px; }
            .kupci-table .totals-row { font-size: 10px; }

            /* Login */
            .login-box { padding: 30px 24px; }
            .login-box h1 { font-size: 48px; }
            .login-box h2 { font-size: 24px; }

            /* Loading */
            .loading-icon { font-size: 48px; }
            .loading-text { font-size: 16px; }

            /* Hide dark mode button text on mobile */
            .btn[onclick="toggleDarkMode()"] { font-size: 20px; padding: 8px 12px; }
        }

        /* Extra small devices (< 480px) */
        @media (max-width: 480px) {
            .section h2 { font-size: 16px; }
            .header-logo h1 { font-size: 18px; }
            .tab { padding: 10px 12px; font-size: 12px; }
            .summary-card-value { font-size: 20px; }
            .chart-container { height: 240px; padding: 12px; }

            .kupci-table { font-size: 9px; }
            .kupci-table th:first-child, .kupci-table td:first-child {
                min-width: 90px; max-width: 120px; font-size: 9px;
            }
            .kupci-table th:nth-child(2), .kupci-table td:nth-child(2) {
                left: 90px; min-width: 60px; font-size: 9px;
            }
            .kupci-table .sortiment-col { min-width: 45px; font-size: 9px; }
            .kupci-table .ukupno-col { min-width: 70px; font-size: 9px; }
        }

        /* Cache indicator */
        .cache-indicator {
            padding: 12px 24px;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            border-bottom: 2px solid #e5e7eb;
            transition: all 0.3s ease;
        }
        .btn-clear-cache {
            background: #f59e0b;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }
        .btn-clear-cache:hover {
            background: #d97706;
        }
        /* ============================================ */
        /* MOBILE RESPONSIVE DESIGN */
        /* ============================================ */

        @media (max-width: 768px) {
            /* Container and layout */
            .container { max-width: 100%; padding: 12px; }
            .section { padding: 16px; margin-bottom: 16px; border-radius: 12px; }

            /* Header */
            .header { padding: 12px 16px; flex-direction: column; }
            .header-content { flex-direction: column; gap: 12px; width: 100%; }
            .header-left { width: 100%; }
            .header-right { width: 100%; justify-content: space-between; }
            .header-logo { font-size: 24px; }
            .header-title h1 { font-size: 16px; }
            .header-title p { font-size: 11px; }
            .header-user-name { font-size: 13px; }
            .header-user-role { font-size: 11px; }

            /* Tabs */
            .tabs-container { overflow-x: auto; -webkit-overflow-scrolling: touch; padding: 8px 12px; }
            .tab { font-size: 12px; padding: 8px 12px; white-space: nowrap; }

            /* Summary cards */
            .summary-cards { grid-template-columns: 1fr; gap: 12px; }
            .summary-card { padding: 16px; }
            .summary-card-title { font-size: 11px; }
            .summary-card-value { font-size: 24px; }
            .summary-card-subtitle { font-size: 11px; }

            /* Cards */
            .cards { grid-template-columns: 1fr; gap: 12px; }
            .card { padding: 16px; }
            .card-label { font-size: 11px; }
            .card-value { font-size: 24px; }

            /* Tables */
            table { font-size: 11px; }
            th, td { padding: 8px 6px; }
            th { font-size: 10px; }

            /* Table wrappers - enable horizontal scroll */
            .kupci-table-wrapper {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                margin: 0 -16px;
                padding: 0 16px;
            }

            /* Month table - make scrollable */
            .mjesecni-table-wrapper {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                margin: 0 -16px;
                padding: 0 16px;
            }

            /* Make sortiment columns narrower on mobile */
            .sortiment-col {
                min-width: 50px !important;
                font-size: 10px;
            }

            /* Page header */
            .page-header { flex-direction: column; gap: 12px; }
            .page-header-left h1 { font-size: 18px; }
            .page-header-left p { font-size: 12px; }

            /* Buttons */
            .btn { padding: 10px 16px; font-size: 13px; }

            /* Forms */
            .form-group label { font-size: 12px; }
            .form-group input, .form-group select, .form-group textarea {
                font-size: 14px;
                padding: 8px;
            }

            /* Filter bar */
            .filter-bar { padding: 12px; }
            .filter-grid { grid-template-columns: 1fr; gap: 8px; }
            .filter-label { font-size: 11px; }
            .filter-input, .filter-select { font-size: 13px; padding: 8px; }

            /* Modal */
            .modal { width: 95%; padding: 16px; }
            .modal-title { font-size: 16px; }
            .modal-body { font-size: 13px; }

            /* User menu */
            .user-menu-button { padding: 6px 12px; font-size: 12px; }
            .user-menu-dropdown { min-width: 180px; }

            /* Hide or adjust specific elements on mobile */
            .badge { padding: 4px 8px; font-size: 10px; }

            /* Export button */
            .export-btn { width: 100%; margin-bottom: 12px; }

            /* Search input */
            .search-container { margin-bottom: 12px; }
            .search-input { font-size: 14px; }
        }

        /* Extra small devices (phones in portrait, less than 576px) */
        @media (max-width: 576px) {
            .container { padding: 8px; }
            .section { padding: 12px; }
            .header { padding: 8px 12px; }
            .header-title h1 { font-size: 14px; }

            /* Make tables even more compact */
            table { font-size: 10px; }
            th, td { padding: 6px 4px; }
            th { font-size: 9px; }

            /* Summary cards */
            .summary-card-value { font-size: 20px; }

            /* Buttons */
            .btn { padding: 8px 12px; font-size: 12px; }
        }

        /* ============================================ */
        /* TOAST NOTIFICATIONS */
        /* ============================================ */

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        .toast {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 16px 20px;
            min-width: 300px;
            max-width: 400px;
            display: flex;
            align-items: center;
            gap: 12px;
            pointer-events: auto;
            opacity: 0;
            transform: translateX(400px);
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast.hide {
            opacity: 0;
            transform: translateX(400px);
        }

        .toast-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .toast-message {
            font-size: 13px;
            color: #6b7280;
            line-height: 1.4;
        }

        .toast-close {
            background: none;
            border: none;
            font-size: 20px;
            color: #9ca3af;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .toast-close:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .toast.success {
            border-left: 4px solid #10b981;
        }

        .toast.success .toast-icon {
            color: #10b981;
        }

        .toast.error {
            border-left: 4px solid #ef4444;
        }

        .toast.error .toast-icon {
            color: #ef4444;
        }

        .toast.info {
            border-left: 4px solid #3b82f6;
        }

        .toast.info .toast-icon {
            color: #3b82f6;
        }

        .toast.warning {
            border-left: 4px solid #f59e0b;
        }

        .toast.warning .toast-icon {
            color: #f59e0b;
        }

        /* Mobile adjustments for toasts */
        @media (max-width: 576px) {
            .toast-container {
                top: 10px;
                right: 10px;
                left: 10px;
            }

            .toast {
                min-width: auto;
                max-width: none;
                padding: 12px 16px;
            }

            .toast-title {
                font-size: 13px;
            }

            .toast-message {
                font-size: 12px;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <!-- Toast Notification Container -->
    <div id="toast-container" class="toast-container"></div>

    <div id="login-screen" class="login-container">
        <div class="login-box">
            <h1>üå≤</h1>
            <h2>≈†umarija</h2>
            <p>Evidencija sjeƒçe i otpreme</p>
            
            <form id="login-form">
                <div id="error-msg" class="error hidden"></div>
                
                <div class="form-group">
                    <label>Korisniƒçko ime</label>
                    <input type="text" id="username" placeholder="Email ili username" required>
                </div>
                
                <div class="form-group">
                    <label>≈†ifra</label>
                    <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                
                <button type="submit" class="btn" id="login-btn">Prijavi se</button>
            </form>
        </div>
    </div>
    
    <div id="app-screen" class="hidden">
        <div class="header">
            <div class="header-content">
                <div class="header-left">
                    <div class="header-logo">üå≤</div>
                    <div class="header-title">
                        <h1>Pogon gospodarenja Bos. Krupa</h1>
                        <p>Evidencija sjeƒçe i otpreme</p>
                    </div>
                </div>
                <div class="header-right">
                    <div class="header-user">
                        <div class="header-user-name" id="user-name"></div>
                        <div class="header-user-role" id="user-role"></div>
                    </div>
                    <div class="user-menu">
                        <button class="user-menu-button" onclick="toggleUserMenu()">
                            <span>‚öôÔ∏è</span>
                            <span>Meni</span>
                        </button>
                        <div class="user-menu-dropdown" id="user-menu-dropdown">
                            <div class="user-menu-item" onclick="toggleDarkMode(); toggleUserMenu();">üåô Dark Mode</div>
                            <div class="user-menu-item" onclick="clearAllCache()">üóëÔ∏è Obri≈°i ke≈°</div>
                            <div class="user-menu-item danger" onclick="logout()">üö™ Odjavi se</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cache indicator -->
        <div id="cache-indicator" class="cache-indicator hidden"></div>

        <div class="tabs-container">
            <div class="tabs" id="tabs-menu">
                <!-- Tabs will be dynamically populated based on user type -->
            </div>
        </div>

        <div id="loading-screen" class="loading">
            <div class="loading-icon">‚è≥</div>
            <div class="loading-text">Uƒçitavam podatke...</div>
        </div>
        
        <!-- DASHBOARD CONTENT (≈†umarija Krupa) -->
        <div id="dashboard-content" class="container hidden">
            <!-- Summary Cards -->
            <div class="summary-cards" id="summary-cards"></div>

            <!-- Monthly Table -->
            <div class="section">
                <h2>üìä Mjeseƒçni pregled</h2>
                <div class="controls-bar">
                    <input type="text" class="search-input" id="dashboard-search" placeholder="üîç Pretra≈æi po mjesecu..." onkeyup="filterDashboardTable()">
                    <button class="btn btn-primary" onclick="exportTableToCSV('dashboard')">üì• Export CSV</button>
                </div>
                <table class="monthly-table" id="dashboard-table">
                    <thead>
                        <tr>
                            <th onclick="sortTable(0, 'dashboard-table')">Mjesec ‚áÖ</th>
                            <th class="right" onclick="sortTable(1, 'dashboard-table')">Ukupna Sjeƒça (m¬≥) ‚áÖ</th>
                            <th class="right" onclick="sortTable(2, 'dashboard-table')">Ukupna Otprema (m¬≥) ‚áÖ</th>
                            <th class="right" onclick="sortTable(3, 'dashboard-table')">≈†uma Panj+Meƒëustovari≈°te ‚áÖ</th>
                            <th class="right" onclick="sortTable(4, 'dashboard-table')">Dinamika ‚áÖ</th>
                            <th class="right" onclick="sortTable(5, 'dashboard-table')">Razlika Sjeƒça - Dinamika ‚áÖ</th>
                            <th class="right" onclick="sortTable(6, 'dashboard-table')">Razlika Otprema - Dinamika ‚áÖ</th>
                        </tr>
                    </thead>
                    <tbody id="dashboard-monthly-table"></tbody>
                </table>
            </div>

            <!-- Odjeli Table -->
            <div class="section">
                <h2>üè≠ Pregled po odjelima</h2>
                <div class="controls-bar">
                    <input type="text" class="search-input" id="odjeli-search" placeholder="üîç Pretra≈æi po odjelu..." onkeyup="filterOdjeliTable()">
                    <button class="btn btn-primary" onclick="exportTableToCSV('odjeli')">üì• Export CSV</button>
                </div>
                <table class="monthly-table" id="odjeli-table">
                    <thead>
                        <tr>
                            <th onclick="sortTable(0, 'odjeli-table')">Odjel ‚áÖ</th>
                            <th class="right" onclick="sortTable(1, 'odjeli-table')">Sjeƒça (m¬≥) ‚áÖ</th>
                            <th class="right" onclick="sortTable(2, 'odjeli-table')">Otprema (m¬≥) ‚áÖ</th>
                            <th class="right" onclick="sortTable(3, 'odjeli-table')">≈†uma Panj+Meƒëustovari≈°te ‚áÖ</th>
                            <th onclick="sortTable(4, 'odjeli-table')">Radili≈°te ‚áÖ</th>
                            <th onclick="sortTable(5, 'odjeli-table')">Izvoƒëaƒç Radova ‚áÖ</th>
                            <th onclick="sortTable(6, 'odjeli-table')">Datum Zadnje Sjeƒçe ‚áÖ</th>
                            <th class="right" onclick="sortTable(7, 'odjeli-table')">Realizacija % ‚áÖ</th>
                        </tr>
                    </thead>
                    <tbody id="odjeli-table-body"></tbody>
                </table>
            </div>

            <!-- Chart -->
            <div class="section">
                <h2>üìà Trendovi sjeƒçe i otpreme</h2>
                <div class="chart-container">
                    <canvas id="trendsChart"></canvas>
                </div>
            </div>
        </div>

        <!-- MJESEƒåNI SORTIMENTI CONTENT -->
        <div id="mjesecni-sortimenti-content" class="container hidden">
            <!-- SJEƒåA PO MJESECIMA -->
            <div class="section">
                <div class="page-header">
                    <div class="page-header-left">
                        <h1>üìä Sjeƒça po mjesecima i sortimentima</h1>
                        <p>Prikaz mjeseƒçnih podataka za tekuƒáu godinu</p>
                    </div>
                    <div class="page-header-right">
                        <button class="btn btn-primary" onclick="exportTableToCSV('mjesecna-sjeca')">üì• Export CSV</button>
                    </div>
                </div>
                <div class="kupci-table-wrapper mjesecni-table-wrapper">
                    <table class="kupci-table" id="mjesecna-sjeca-table">
                        <thead id="mjesecna-sjeca-header"></thead>
                        <tbody id="mjesecna-sjeca-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- OTPREMA PO MJESECIMA -->
            <div class="section">
                <div class="page-header">
                    <div class="page-header-left">
                        <h1>üöõ Otprema po mjesecima i sortimentima</h1>
                        <p>Prikaz mjeseƒçnih podataka za tekuƒáu godinu</p>
                    </div>
                    <div class="page-header-right">
                        <button class="btn btn-primary" onclick="exportTableToCSV('mjesecna-otprema')">üì• Export CSV</button>
                    </div>
                </div>
                <div class="kupci-table-wrapper mjesecni-table-wrapper">
                    <table class="kupci-table" id="mjesecna-otprema-table">
                        <thead id="mjesecna-otprema-header"></thead>
                        <tbody id="mjesecna-otprema-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- PRIMACI CONTENT (Prikaz po primaƒçima) -->
        <div id="primaci-content" class="container hidden">
            <h2>üë∑ Prikaz sjeƒçe</h2>

            <!-- Submenu -->
            <div class="submenu">
                <button class="submenu-tab active" onclick="switchPrimaciSubmenu('monthly')">üìä Mjeseƒçni prikaz</button>
                <button class="submenu-tab" onclick="switchPrimaciSubmenu('daily')">üìÖ Po danima</button>
                <button class="submenu-tab" onclick="switchPrimaciSubmenu('radilista')">üèóÔ∏è Radili≈°ta</button>
                <button class="submenu-tab" onclick="switchPrimaciSubmenu('izvodjaci')">üë∑ Izvoƒëaƒçi</button>
            </div>

            <!-- Mjeseƒçni prikaz -->
            <div id="primaci-monthly-view" class="submenu-content">
                <div class="section">
                    <div class="controls-bar">
                        <input type="text" class="search-input" id="primaci-search" placeholder="üîç Pretra≈æi po imenu primaƒça..." onkeyup="filterPrimaciTable()">
                        <button class="btn btn-primary" onclick="exportTableToCSV('primaci')">üì• Export CSV</button>
                    </div>
                    <table class="monthly-table" id="primaci-table">
                        <thead id="primaci-header"></thead>
                        <tbody id="primaci-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- Dnevni prikaz - tekuƒái mjesec -->
            <div id="primaci-daily-view" class="submenu-content hidden">
                <div class="section">
                    <div class="month-selector">
                        <label for="primaci-month-select">üìÖ Izaberi mjesec:</label>
                        <select id="primaci-month-select" class="month-select" onchange="loadPrimaciDaily(this.value)">
                            <option value="0">Januar</option>
                            <option value="1">Februar</option>
                            <option value="2">Mart</option>
                            <option value="3">April</option>
                            <option value="4">Maj</option>
                            <option value="5">Juni</option>
                            <option value="6">Juli</option>
                            <option value="7">Avgust</option>
                            <option value="8">Septembar</option>
                            <option value="9">Oktobar</option>
                            <option value="10">Novembar</option>
                            <option value="11">Decembar</option>
                        </select>
                    </div>
                    <div class="controls-bar">
                        <input type="text" class="search-input" id="primaci-daily-search" placeholder="üîç Pretra≈æi..." onkeyup="filterPrimaciDailyTable()">
                        <button class="btn btn-primary" onclick="exportTableToCSV('primaci-daily')">üì• Export CSV</button>
                    </div>
                    <div class="kupci-table-wrapper">
                        <table class="kupci-table" id="primaci-daily-table">
                            <thead id="primaci-daily-header"></thead>
                            <tbody id="primaci-daily-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Prikaz po radili≈°tima -->
            <div id="primaci-radilista-view" class="submenu-content hidden">
                <div class="section">
                    <h3 style="color: #ea580c; text-align: center; margin-bottom: 20px;">üèóÔ∏è Prikaz sjeƒçe po radili≈°tima</h3>
                    <div class="controls-bar">
                        <button class="btn btn-primary" onclick="exportTableToCSV('primaci-radilista')">üì• Export CSV</button>
                    </div>
                    <table class="monthly-table" id="primaci-radilista-table">
                        <thead id="primaci-radilista-header"></thead>
                        <tbody id="primaci-radilista-body"></tbody>
                    </table>
                    <h4 style="color: #7c2d12; margin-top: 30px; margin-bottom: 15px;">üìä Godi≈°nja rekapitulacija po sortimentima</h4>
                    <table class="monthly-table" id="primaci-radilista-recap">
                        <thead id="primaci-radilista-recap-header"></thead>
                        <tbody id="primaci-radilista-recap-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- Prikaz po izvoƒëaƒçima -->
            <div id="primaci-izvodjaci-view" class="submenu-content hidden">
                <div class="section">
                    <h3 style="color: #ea580c; text-align: center; margin-bottom: 20px;">üë∑ Prikaz sjeƒçe po izvoƒëaƒçima radova</h3>
                    <div class="controls-bar">
                        <button class="btn btn-primary" onclick="exportTableToCSV('primaci-izvodjaci')">üì• Export CSV</button>
                    </div>
                    <table class="monthly-table" id="primaci-izvodjaci-table">
                        <thead id="primaci-izvodjaci-header"></thead>
                        <tbody id="primaci-izvodjaci-body"></tbody>
                    </table>
                    <h4 style="color: #7c2d12; margin-top: 30px; margin-bottom: 15px;">üìä Godi≈°nja rekapitulacija po sortimentima</h4>
                    <table class="monthly-table" id="primaci-izvodjaci-recap">
                        <thead id="primaci-izvodjaci-recap-header"></thead>
                        <tbody id="primaci-izvodjaci-recap-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- OTPREMACI CONTENT (Prikaz po otpremaƒçima) -->
        <div id="otpremaci-content" class="container hidden">
            <h2>üöõ Prikaz otpreme</h2>

            <!-- Submenu -->
            <div class="submenu">
                <button class="submenu-tab active" onclick="switchOtremaciSubmenu('monthly')">üìä Mjeseƒçni prikaz</button>
                <button class="submenu-tab" onclick="switchOtremaciSubmenu('daily')">üìÖ Po danima</button>
                <button class="submenu-tab" onclick="switchOtremaciSubmenu('radilista')">üèóÔ∏è Radili≈°ta</button>
            </div>

            <!-- Mjeseƒçni prikaz -->
            <div id="otpremaci-monthly-view" class="submenu-content">
                <div class="section">
                    <div class="controls-bar">
                        <input type="text" class="search-input" id="otpremaci-search" placeholder="üîç Pretra≈æi po imenu otpremaƒça..." onkeyup="filterOtremaciTable()">
                        <button class="btn btn-primary" onclick="exportTableToCSV('otpremaci')">üì• Export CSV</button>
                    </div>
                    <table class="monthly-table" id="otpremaci-table">
                        <thead id="otpremaci-header"></thead>
                        <tbody id="otpremaci-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- Dnevni prikaz - tekuƒái mjesec -->
            <div id="otpremaci-daily-view" class="submenu-content hidden">
                <div class="section">
                    <div class="month-selector">
                        <label for="otpremaci-month-select">üìÖ Izaberi mjesec:</label>
                        <select id="otpremaci-month-select" class="month-select" onchange="loadOtremaciDaily(this.value)">
                            <option value="0">Januar</option>
                            <option value="1">Februar</option>
                            <option value="2">Mart</option>
                            <option value="3">April</option>
                            <option value="4">Maj</option>
                            <option value="5">Juni</option>
                            <option value="6">Juli</option>
                            <option value="7">Avgust</option>
                            <option value="8">Septembar</option>
                            <option value="9">Oktobar</option>
                            <option value="10">Novembar</option>
                            <option value="11">Decembar</option>
                        </select>
                    </div>
                    <div class="controls-bar">
                        <input type="text" class="search-input" id="otpremaci-daily-search" placeholder="üîç Pretra≈æi..." onkeyup="filterOtremaciDailyTable()">
                        <button class="btn btn-primary" onclick="exportTableToCSV('otpremaci-daily')">üì• Export CSV</button>
                    </div>
                    <div class="kupci-table-wrapper">
                        <table class="kupci-table" id="otpremaci-daily-table">
                            <thead id="otpremaci-daily-header"></thead>
                            <tbody id="otpremaci-daily-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Prikaz po radili≈°tima -->
            <div id="otpremaci-radilista-view" class="submenu-content hidden">
                <div class="section">
                    <h3 style="color: #0891b2; text-align: center; margin-bottom: 20px;">üèóÔ∏è Prikaz otpreme po radili≈°tima</h3>
                    <div class="controls-bar">
                        <button class="btn btn-primary" onclick="exportTableToCSV('otpremaci-radilista')">üì• Export CSV</button>
                    </div>
                    <table class="monthly-table" id="otpremaci-radilista-table">
                        <thead id="otpremaci-radilista-header"></thead>
                        <tbody id="otpremaci-radilista-body"></tbody>
                    </table>
                    <h4 style="color: #155e75; margin-top: 30px; margin-bottom: 15px;">üìä Godi≈°nja rekapitulacija po sortimentima</h4>
                    <table class="monthly-table" id="otpremaci-radilista-recap">
                        <thead id="otpremaci-radilista-recap-header"></thead>
                        <tbody id="otpremaci-radilista-recap-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- KUPCI CONTENT (Prikaz po kupcima) -->
        <div id="kupci-content" class="container hidden">
            <!-- Godi≈°nji pregled -->
            <div class="section">
                <h2>üè¢ Godi≈°nji pregled po kupcima</h2>
                <div class="controls-bar">
                    <input type="text" class="search-input" id="kupci-godisnji-search" placeholder="üîç Pretra≈æi po kupcu..." onkeyup="filterKupciGodisnjiTable()">
                    <button class="btn btn-primary" onclick="exportTableToCSV('kupci-godisnji')">üì• Export CSV</button>
                </div>
                <div class="kupci-table-wrapper">
                    <table class="kupci-table" id="kupci-godisnji-table">
                        <thead id="kupci-godisnji-header"></thead>
                        <tbody id="kupci-godisnji-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- Mjeseƒçni pregled -->
            <div class="section">
                <h2>üìÖ Mjeseƒçni pregled po kupcima</h2>
                <div class="controls-bar">
                    <input type="text" class="search-input" id="kupci-mjesecni-search" placeholder="üîç Pretra≈æi po kupcu..." onkeyup="filterKupciMjesecniTable()">
                    <button class="btn btn-primary" onclick="exportTableToCSV('kupci-mjesecni')">üì• Export CSV</button>
                </div>
                <div class="kupci-table-wrapper">
                    <table class="kupci-table" id="kupci-mjesecni-table">
                        <thead id="kupci-mjesecni-header"></thead>
                        <tbody id="kupci-mjesecni-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- PRIMAC PERSONAL VIEW -->
        <div id="primac-personal-content" class="container hidden">
            <div class="section">
                <h2>üë∑ Pregled sjeƒçe u tekuƒáoj godini</h2>
                <div class="controls-bar">
                    <input type="text" class="search-input" id="primac-personal-search" placeholder="üîç Pretra≈æi po odjelu..." onkeyup="filterPrimacPersonalTable()">
                    <button class="btn btn-primary" onclick="exportTableToCSV('primac-personal')">üì• Export CSV</button>
                </div>
                <div class="kupci-table-wrapper">
                    <table class="kupci-table" id="primac-personal-table">
                        <thead id="primac-personal-header"></thead>
                        <tbody id="primac-personal-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- OTPREMAC PERSONAL VIEW -->
        <div id="otpremac-personal-content" class="container hidden">
            <div class="section">
                <h2>üöõ Pregled otpreme u tekuƒáoj godini</h2>
                <div class="controls-bar">
                    <input type="text" class="search-input" id="otpremac-personal-search" placeholder="üîç Pretra≈æi po odjelu/kupcu..." onkeyup="filterOtpremacPersonalTable()">
                    <button class="btn btn-primary" onclick="exportTableToCSV('otpremac-personal')">üì• Export CSV</button>
                </div>
                <div class="kupci-table-wrapper">
                    <table class="kupci-table" id="otpremac-personal-table">
                        <thead id="otpremac-personal-header"></thead>
                        <tbody id="otpremac-personal-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- PRIMAC ODJELI VIEW (By Department) -->
        <div id="primac-odjeli-content" class="container hidden">
            <div class="section">
                <h2>üè≠ Prikaz sjeƒçe po odjelima</h2>
                <div id="primac-odjeli-container"></div>
                <div class="controls-bar" style="justify-content: center; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="prevPagePrimacOdjeli()" id="primac-odjeli-prev">‚Üê Prethodna</button>
                    <span style="margin: 0 20px; font-weight: 600;" id="primac-odjeli-page-info">Stranica 1</span>
                    <button class="btn btn-secondary" onclick="nextPagePrimacOdjeli()" id="primac-odjeli-next">Sledeƒáa ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- OTPREMAC ODJELI VIEW (By Department) -->
        <div id="otpremac-odjeli-content" class="container hidden">
            <div class="section">
                <h2>üè≠ Prikaz otpreme po odjelima</h2>
                <div id="otpremac-odjeli-container"></div>
                <div class="controls-bar" style="justify-content: center; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="prevPageOtpremacOdjeli()" id="otpremac-odjeli-prev">‚Üê Prethodna</button>
                    <span style="margin: 0 20px; font-weight: 600;" id="otpremac-odjeli-page-info">Stranica 1</span>
                    <button class="btn btn-secondary" onclick="nextPageOtpremacOdjeli()" id="otpremac-odjeli-next">Sledeƒáa ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- ADD SJECA FORM (For Primaƒçi) -->
        <div id="add-sjeca-content" class="container hidden">
            <div class="section">
                <h2>‚ûï Dodaj novu sjeƒçu</h2>
                <form id="add-sjeca-form" onsubmit="submitSjeca(event)">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label>Datum:</label>
                            <input type="date" id="sjeca-datum" required style="padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>Odjel:</label>
                            <select id="sjeca-odjel" required style="padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; width: 100%;">
                                <option value="">Izaberi odjel...</option>
                            </select>
                        </div>
                    </div>

                    <h3 style="margin: 20px 0 10px 0; color: #047857;">Sortimenti (m¬≥):</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                        <div class="form-group">
                            <label>F/L ƒå:</label>
                            <input type="number" step="0.01" id="sjeca-FL-C" value="0" min="0" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>I ƒå:</label>
                            <input type="number" step="0.01" id="sjeca-I-C" value="0" min="0" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>II ƒå:</label>
                            <input type="number" step="0.01" id="sjeca-II-C" value="0" min="0" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>III ƒå:</label>
                            <input type="number" step="0.01" id="sjeca-III-C" value="0" min="0" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>RUDNO:</label>
                            <input type="number" step="0.01" id="sjeca-RUDNO" value="0" min="0" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>TRUPCI ƒå: <span style="color: #6b7280; font-size: 0.85em;">(auto)</span></label>
                            <input type="number" step="0.01" id="sjeca-TRUPCI-C" value="0" min="0" readonly style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%; background: #f3f4f6; color: #374151; font-weight: 600;">
                        </div>
                        <div class="form-group">
                            <label>CEL.DUGA:</label>
                            <input type="number" step="0.01" id="sjeca-CEL-DUGA" value="0" min="0" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>CEL.CIJEPANA:</label>
                            <input type="number" step="0.01" id="sjeca-CEL-CIJEPANA" value="0" min="0" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>ƒåETINARI: <span style="color: #6b7280; font-size: 0.85em;">(auto)</span></label>
                            <input type="number" step="0.01" id="sjeca-CETINARI" value="0" min="0" readonly style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%; background: #f3f4f6; color: #374151; font-weight: 600;">
                        </div>
                        <div class="form-group">
                            <label>F/L L:</label>
                            <input type="number" step="0.01" id="sjeca-FL-L" value="0" min="0" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>I L:</label>
                            <input type="number" step="0.01" id="sjeca-I-L" value="0" min="0" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>II L:</label>
                            <input type="number" step="0.01" id="sjeca-II-L" value="0" min="0" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>III L:</label>
                            <input type="number" step="0.01" id="sjeca-III-L" value="0" min="0" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>TRUPCI: <span style="color: #6b7280; font-size: 0.85em;">(auto)</span></label>
                            <input type="number" step="0.01" id="sjeca-TRUPCI" value="0" min="0" readonly style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%; background: #f3f4f6; color: #374151; font-weight: 600;">
                        </div>
                        <div class="form-group">
                            <label>OGR.DUGI:</label>
                            <input type="number" step="0.01" id="sjeca-OGR-DUGI" value="0" min="0" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>OGR.CIJEPANI:</label>
                            <input type="number" step="0.01" id="sjeca-OGR-CIJEPANI" value="0" min="0" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>LI≈†ƒÜARI: <span style="color: #6b7280; font-size: 0.85em;">(auto)</span></label>
                            <input type="number" step="0.01" id="sjeca-LISCARI" value="0" min="0" readonly style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%; background: #f3f4f6; color: #374151; font-weight: 600;">
                        </div>
                    </div>

                    <div style="margin-top: 20px; padding: 20px; background: #fef3c7; border: 2px solid #f59e0b; border-radius: 10px;">
                        <label style="font-size: 1.2em; font-weight: bold; color: #92400e;">SVEUKUPNO (m¬≥):</label>
                        <input type="number" step="0.01" id="sjeca-SVEUKUPNO" value="0" readonly style="padding: 12px; border: 2px solid #f59e0b; border-radius: 8px; width: 100%; background: #fffbeb; color: #92400e; font-size: 1.5em; font-weight: bold; text-align: center;">
                    </div>

                    <div style="margin-top: 30px; display: flex; gap: 12px; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="resetSjecaForm()">Poni≈°ti</button>
                        <button type="submit" class="btn btn-primary" id="submit-sjeca-btn">Dodaj sjeƒçu</button>
                    </div>

                    <div id="sjeca-message" class="hidden" style="margin-top: 20px; padding: 12px; border-radius: 8px;"></div>
                </form>
            </div>
        </div>

        <!-- ADD OTPREMA FORM (For Otpremaƒçi) -->
        <div id="add-otprema-content" class="container hidden">
            <div class="section">
                <h2>‚ûï Dodaj novu otpremu</h2>
                <form id="add-otprema-form" onsubmit="submitOtprema(event)">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label>Datum:</label>
                            <input type="date" id="otprema-datum" required style="padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>Odjel:</label>
                            <select id="otprema-odjel" required style="padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; width: 100%;">
                                <option value="">Izaberi odjel...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Kupac:</label>
                            <input type="text" id="otprema-kupac" placeholder="Naziv kupca" style="padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>Broj otpremnice:</label>
                            <input type="text" id="otprema-broj-otpremnice" placeholder="Unesite broj otpremnice" style="padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; width: 100%;">
                        </div>
                    </div>

                    <h3 style="margin: 20px 0 10px 0; color: #2563eb;">Sortimenti (m¬≥):</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                        <div class="form-group">
                            <label>F/L ƒå:</label>
                            <input type="number" step="0.01" id="otprema-FL-C" value="0" min="0" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>I ƒå:</label>
                            <input type="number" step="0.01" id="otprema-I-C" value="0" min="0" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>II ƒå:</label>
                            <input type="number" step="0.01" id="otprema-II-C" value="0" min="0" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>III ƒå:</label>
                            <input type="number" step="0.01" id="otprema-III-C" value="0" min="0" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>RUDNO:</label>
                            <input type="number" step="0.01" id="otprema-RUDNO" value="0" min="0" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>TRUPCI ƒå: <span style="color: #6b7280; font-size: 0.85em;">(auto)</span></label>
                            <input type="number" step="0.01" id="otprema-TRUPCI-C" value="0" min="0" readonly style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%; background: #f3f4f6; color: #374151; font-weight: 600;">
                        </div>
                        <div class="form-group">
                            <label>CEL.DUGA:</label>
                            <input type="number" step="0.01" id="otprema-CEL-DUGA" value="0" min="0" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>CEL.CIJEPANA:</label>
                            <input type="number" step="0.01" id="otprema-CEL-CIJEPANA" value="0" min="0" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>ƒåETINARI: <span style="color: #6b7280; font-size: 0.85em;">(auto)</span></label>
                            <input type="number" step="0.01" id="otprema-CETINARI" value="0" min="0" readonly style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%; background: #f3f4f6; color: #374151; font-weight: 600;">
                        </div>
                        <div class="form-group">
                            <label>F/L L:</label>
                            <input type="number" step="0.01" id="otprema-FL-L" value="0" min="0" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>I L:</label>
                            <input type="number" step="0.01" id="otprema-I-L" value="0" min="0" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>II L:</label>
                            <input type="number" step="0.01" id="otprema-II-L" value="0" min="0" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>III L:</label>
                            <input type="number" step="0.01" id="otprema-III-L" value="0" min="0" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>TRUPCI: <span style="color: #6b7280; font-size: 0.85em;">(auto)</span></label>
                            <input type="number" step="0.01" id="otprema-TRUPCI" value="0" min="0" readonly style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%; background: #f3f4f6; color: #374151; font-weight: 600;">
                        </div>
                        <div class="form-group">
                            <label>OGR.DUGI:</label>
                            <input type="number" step="0.01" id="otprema-OGR-DUGI" value="0" min="0" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>OGR.CIJEPANI:</label>
                            <input type="number" step="0.01" id="otprema-OGR-CIJEPANI" value="0" min="0" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>LI≈†ƒÜARI: <span style="color: #6b7280; font-size: 0.85em;">(auto)</span></label>
                            <input type="number" step="0.01" id="otprema-LISCARI" value="0" min="0" readonly style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%; background: #f3f4f6; color: #374151; font-weight: 600;">
                        </div>
                    </div>

                    <div style="margin-top: 20px; padding: 20px; background: #fef3c7; border: 2px solid #f59e0b; border-radius: 10px;">
                        <label style="font-size: 1.2em; font-weight: bold; color: #92400e;">SVEUKUPNO (m¬≥):</label>
                        <input type="number" step="0.01" id="otprema-SVEUKUPNO" value="0" readonly style="padding: 12px; border: 2px solid #f59e0b; border-radius: 8px; width: 100%; background: #fffbeb; color: #92400e; font-size: 1.5em; font-weight: bold; text-align: center;">
                    </div>

                    <div style="margin-top: 30px; display: flex; gap: 12px; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="resetOtpremaForm()">Poni≈°ti</button>
                        <button type="submit" class="btn btn-primary" id="submit-otprema-btn">Dodaj otpremu</button>
                    </div>

                    <div id="otprema-message" class="hidden" style="margin-top: 20px; padding: 12px; border-radius: 8px;"></div>
                </form>
            </div>
        </div>

        <!-- MY SJECE VIEW (For Primaƒç) -->
        <div id="my-sjece-content" class="container hidden">
            <div class="section">
                <h2>üìù Moje sjeƒçe - Zadnjih 10 unosa</h2>
                <p style="color: #6b7280; margin-bottom: 20px;">Ovdje mo≈æete pregledati i ispraviti va≈°e nedavne unose</p>
                <div id="my-sjece-container"></div>
            </div>
        </div>

        <!-- MY OTPREME VIEW (For Otpremaƒç) -->
        <div id="my-otpreme-content" class="container hidden">
            <div class="section">
                <h2>üìù Moje otpreme - Zadnjih 10 unosa</h2>
                <p style="color: #6b7280; margin-bottom: 20px;">Ovdje mo≈æete pregledati i ispraviti va≈°e nedavne unose</p>
                <div id="my-otpreme-container"></div>
            </div>
        </div>

        <!-- EDIT SJECA FORM (For editing existing entry) -->
        <div id="edit-sjeca-content" class="container hidden">
            <div class="section">
                <h2>‚úèÔ∏è Uredi sjeƒçu</h2>
                <form id="edit-sjeca-form" onsubmit="submitEditSjeca(event)">
                    <input type="hidden" id="edit-sjeca-rowIndex">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label>Datum:</label>
                            <input type="date" id="edit-sjeca-datum" required style="padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>Odjel:</label>
                            <select id="edit-sjeca-odjel" required style="padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; width: 100%;">
                                <option value="">Izaberi odjel...</option>
                            </select>
                        </div>
                    </div>

                    <h3 style="margin: 20px 0 10px 0; color: #047857;">Sortimenti (m¬≥):</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;" id="edit-sjeca-sortimenti">
                        <!-- Sortimenti fields will be dynamically added here -->
                    </div>

                    <div style="margin-top: 20px; padding: 20px; background: #fef3c7; border: 2px solid #f59e0b; border-radius: 10px;">
                        <label style="font-size: 1.2em; font-weight: bold; color: #92400e;">SVEUKUPNO (m¬≥):</label>
                        <input type="number" step="0.01" id="edit-sjeca-SVEUKUPNO" value="0" readonly style="padding: 12px; border: 2px solid #f59e0b; border-radius: 8px; width: 100%; background: #fffbeb; color: #92400e; font-size: 1.5em; font-weight: bold; text-align: center;">
                    </div>

                    <div style="margin-top: 30px; display: flex; gap: 12px; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="cancelEditSjeca()">Otka≈æi</button>
                        <button type="submit" class="btn btn-primary" id="submit-edit-sjeca-btn">Saƒçuvaj izmjene</button>
                    </div>

                    <div id="edit-sjeca-message" class="hidden" style="margin-top: 20px; padding: 12px; border-radius: 8px;"></div>
                </form>
            </div>
        </div>

        <!-- EDIT OTPREMA FORM (For editing existing entry) -->
        <div id="edit-otprema-content" class="container hidden">
            <div class="section">
                <h2>‚úèÔ∏è Uredi otpremu</h2>
                <form id="edit-otprema-form" onsubmit="submitEditOtprema(event)">
                    <input type="hidden" id="edit-otprema-rowIndex">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label>Datum:</label>
                            <input type="date" id="edit-otprema-datum" required style="padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>Odjel:</label>
                            <select id="edit-otprema-odjel" required style="padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; width: 100%;">
                                <option value="">Izaberi odjel...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Kupac:</label>
                            <input type="text" id="edit-otprema-kupac" placeholder="Naziv kupca" style="padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>Broj otpremnice:</label>
                            <input type="text" id="edit-otprema-broj-otpremnice" placeholder="Unesite broj otpremnice" style="padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; width: 100%;">
                        </div>
                    </div>

                    <h3 style="margin: 20px 0 10px 0; color: #2563eb;">Sortimenti (m¬≥):</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;" id="edit-otprema-sortimenti">
                        <!-- Sortimenti fields will be dynamically added here -->
                    </div>

                    <div style="margin-top: 20px; padding: 20px; background: #fef3c7; border: 2px solid #f59e0b; border-radius: 10px;">
                        <label style="font-size: 1.2em; font-weight: bold; color: #92400e;">SVEUKUPNO (m¬≥):</label>
                        <input type="number" step="0.01" id="edit-otprema-SVEUKUPNO" value="0" readonly style="padding: 12px; border: 2px solid #f59e0b; border-radius: 8px; width: 100%; background: #fffbeb; color: #92400e; font-size: 1.5em; font-weight: bold; text-align: center;">
                    </div>

                    <div style="margin-top: 30px; display: flex; gap: 12px; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="cancelEditOtprema()">Otka≈æi</button>
                        <button type="submit" class="btn btn-primary" id="submit-edit-otprema-btn">Saƒçuvaj izmjene</button>
                    </div>

                    <div id="edit-otprema-message" class="hidden" style="margin-top: 20px; padding: 12px; border-radius: 8px;"></div>
                </form>
            </div>
        </div>

        <!-- IZVJE≈†TAJI CONTENT -->
        <div id="izvjestaji-content" class="container hidden">
            <div class="page-header">
                <div class="page-header-left">
                    <h1>üìã Izvje≈°taji</h1>
                    <p>Detaljan prikaz sjeƒçe i otpreme po odjelima</p>
                </div>
            </div>

            <!-- SUB-MENU TABS -->
            <div class="sub-tabs" style="margin-bottom: 30px;">
                <button class="sub-tab active" onclick="switchIzvjestajiSubTab('mjesecni')">üìÖ Mjeseƒçni izvje≈°taj</button>
                <button class="sub-tab" onclick="switchIzvjestajiSubTab('sedmicni-sjeca')">üìä Sedmiƒçni izvje≈°taj sjeƒçe</button>
                <button class="sub-tab" onclick="switchIzvjestajiSubTab('sedmicni-otprema')">üìä Sedmiƒçni izvje≈°taj otpreme</button>
                <button class="sub-tab" onclick="switchIzvjestajiSubTab('stanje-odjela')">üì¶ Stanje odjela</button>
            </div>

            <!-- MJESEƒåNI IZVJE≈†TAJ -->
            <div id="mjesecni-izvjestaj" class="sub-content">
                <div class="page-header" style="margin-top: 0;">
                    <div class="page-header-left">
                        <h2>üìÖ Mjeseƒçni izvje≈°taj</h2>
                    </div>
                    <div class="page-header-right">
                        <select id="izvjestaji-year-select" class="year-select" onchange="loadIzvjestaji()">
                            <option value="2025">2025</option>
                            <option value="2024">2024</option>
                        </select>
                        <select id="izvjestaji-month-select" class="month-select" onchange="loadIzvjestaji()">
                            <option value="0">Januar</option>
                            <option value="1">Februar</option>
                            <option value="2">Mart</option>
                            <option value="3">April</option>
                            <option value="4">Maj</option>
                            <option value="5">Juni</option>
                            <option value="6">Juli</option>
                            <option value="7">August</option>
                            <option value="8">Septembar</option>
                            <option value="9">Oktobar</option>
                            <option value="10">Novembar</option>
                            <option value="11">Decembar</option>
                        </select>
                    </div>
                </div>

                <!-- SJEƒåA (PRIMKA) PO ODJELIMA -->
                <div class="section">
                    <h2>üå≤ Sjeƒça po odjelima - <span id="izvjestaji-primka-title"></span></h2>
                    <p style="color: #6b7280; margin-bottom: 20px;">Spisak odjela sa sortimentnim prikazom</p>
                    <div class="controls-bar">
                        <input type="text" class="search-input" id="izvjestaji-primka-search" placeholder="üîç Pretra≈æi po odjelu..." onkeyup="filterIzvjestajiPrimkaTable()">
                        <button class="btn btn-primary" onclick="exportTableToCSV('izvjestaji-primka')">üì• Export CSV</button>
                    </div>
                    <div style="overflow-x: auto;">
                        <table id="izvjestaji-primka-table">
                            <thead id="izvjestaji-primka-header"></thead>
                            <tbody id="izvjestaji-primka-body"></tbody>
                        </table>
                    </div>
                </div>

                <!-- OTPREMA PO ODJELIMA -->
                <div class="section">
                    <h2>üöõ Otprema po odjelima - <span id="izvjestaji-otprema-title"></span></h2>
                    <p style="color: #6b7280; margin-bottom: 20px;">Spisak odjela sa sortimentnim prikazom</p>
                    <div class="controls-bar">
                        <input type="text" class="search-input" id="izvjestaji-otprema-search" placeholder="üîç Pretra≈æi po odjelu..." onkeyup="filterIzvjestajiOtpremaTable()">
                        <button class="btn btn-primary" onclick="exportTableToCSV('izvjestaji-otprema')">üì• Export CSV</button>
                    </div>
                    <div style="overflow-x: auto;">
                        <table id="izvjestaji-otprema-table">
                            <thead id="izvjestaji-otprema-header"></thead>
                            <tbody id="izvjestaji-otprema-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- SEDMIƒåNI IZVJE≈†TAJ SJEƒåE -->
            <div id="sedmicni-sjeca-izvjestaj" class="sub-content hidden">
                <div class="page-header" style="margin-top: 0;">
                    <div class="page-header-left">
                        <h2>üìä Sedmiƒçni izvje≈°taj sjeƒçe</h2>
                        <p style="color: #6b7280;">Sve sedmice u mjesecu - od najnovije ka najstarijoj</p>
                    </div>
                    <div class="page-header-right">
                        <select id="sedmicni-sjeca-year-select" class="year-select" onchange="loadSedmicniIzvjestajSjeca()">
                            <option value="2025">2025</option>
                            <option value="2024">2024</option>
                        </select>
                        <select id="sedmicni-sjeca-month-select" class="month-select" onchange="loadSedmicniIzvjestajSjeca()">
                            <option value="0">Januar</option>
                            <option value="1">Februar</option>
                            <option value="2">Mart</option>
                            <option value="3">April</option>
                            <option value="4">Maj</option>
                            <option value="5">Juni</option>
                            <option value="6">Juli</option>
                            <option value="7">August</option>
                            <option value="8">Septembar</option>
                            <option value="9">Oktobar</option>
                            <option value="10">Novembar</option>
                            <option value="11">Decembar</option>
                        </select>
                    </div>
                </div>

                <div id="sedmicni-sjeca-container"></div>
            </div>

            <!-- SEDMIƒåNI IZVJE≈†TAJ OTPREME -->
            <div id="sedmicni-otprema-izvjestaj" class="sub-content hidden">
                <div class="page-header" style="margin-top: 0;">
                    <div class="page-header-left">
                        <h2>üìä Sedmiƒçni izvje≈°taj otpreme</h2>
                        <p style="color: #6b7280;">Sve sedmice u mjesecu - od najnovije ka najstarijoj</p>
                    </div>
                    <div class="page-header-right">
                        <select id="sedmicni-otprema-year-select" class="year-select" onchange="loadSedmicniIzvjestajOtprema()">
                            <option value="2025">2025</option>
                            <option value="2024">2024</option>
                        </select>
                        <select id="sedmicni-otprema-month-select" class="month-select" onchange="loadSedmicniIzvjestajOtprema()">
                            <option value="0">Januar</option>
                            <option value="1">Februar</option>
                            <option value="2">Mart</option>
                            <option value="3">April</option>
                            <option value="4">Maj</option>
                            <option value="5">Juni</option>
                            <option value="6">Juli</option>
                            <option value="7">August</option>
                            <option value="8">Septembar</option>
                            <option value="9">Oktobar</option>
                            <option value="10">Novembar</option>
                            <option value="11">Decembar</option>
                        </select>
                    </div>
                </div>

                <div id="sedmicni-otprema-container"></div>
            </div>

            <!-- STANJE ODJELA -->
            <div id="stanje-odjela-izvjestaj" class="sub-content hidden">
                <div class="page-header" style="margin-top: 0;">
                    <div class="page-header-left">
                        <h2>üì¶ Stanje odjela</h2>
                        <p style="color: #6b7280;">Trenutno stanje radili≈°ta - sortirano po najsvje≈æijim unosima sjeƒçe</p>
                    </div>
                    <div class="page-header-right">
                        <select id="stanje-odjela-select" class="year-select" style="min-width: 250px; margin-right: 12px;" onchange="filterStanjeOdjela()">
                            <option value="">Sva radili≈°ta</option>
                        </select>
                        <button class="btn btn-primary" onclick="loadStanjeOdjela()">üîÑ Osvje≈æi</button>
                    </div>
                </div>

                <!-- Container za sve odjele -->
                <div id="stanje-odjela-container"></div>
            </div>
        </div>

        <!-- DODANI UNOSI VIEW (For Rukovodilac/Admin) -->
        <div id="pending-unosi-content" class="container hidden">
            <div class="section">
                <h2>üìã Dodani Unosi - Pregled</h2>
                <p style="color: #6b7280; margin-bottom: 20px;">Unosi koje su radnici poslali na pregled</p>

                <!-- Filter Bar -->
                <div class="filter-bar">
                    <div class="filter-bar-title">üîç Filteri</div>
                    <div class="filter-grid">
                        <div class="filter-group">
                            <label class="filter-label">Datum od:</label>
                            <input type="date" class="filter-input" id="filter-datum-od">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Datum do:</label>
                            <input type="date" class="filter-input" id="filter-datum-do">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Tip:</label>
                            <select class="filter-select" id="filter-tip">
                                <option value="">Sve</option>
                                <option value="SJEƒåA">Sjeƒça</option>
                                <option value="OTPREMA">Otprema</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Pretraga:</label>
                            <input type="text" class="filter-input" id="filter-search" placeholder="Odjel, radnik, kupac...">
                        </div>
                        <div class="filter-actions">
                            <button class="btn btn-primary" onclick="applyFilters()">Filtriraj</button>
                            <button class="btn btn-clear" onclick="clearFilters()">Oƒçisti</button>
                        </div>
                    </div>
                </div>

                <div id="pending-unosi-container"></div>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div class="modal-overlay" id="confirm-modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="modal-title">Potvrda brisanja</div>
            </div>
            <div class="modal-body" id="modal-body">
                Da li ste sigurni da ≈æelite obrisati ovaj unos?
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeConfirmModal()">Otka≈æi</button>
                <button class="btn btn-danger" id="modal-confirm-btn">Obri≈°i</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbwOyqKvRtbQWQFABXe1Q8fWf2XP9K-msArcOU8BwoyN28fSGfLnPGskR1G8qBIZrMsy/exec';

        // ========== TOAST NOTIFICATIONS ==========

        function showToast(type, title, message, duration = 4000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const icons = {
                success: '‚úì',
                error: '‚úï',
                info: '‚Ñπ',
                warning: '‚ö†'
            };

            toast.innerHTML = `
                <div class="toast-icon">${icons[type] || '‚Ñπ'}</div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    ${message ? `<div class="toast-message">${message}</div>` : ''}
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
            `;

            container.appendChild(toast);

            // Trigger animation
            setTimeout(() => toast.classList.add('show'), 10);

            // Auto remove after duration
            if (duration > 0) {
                setTimeout(() => {
                    toast.classList.remove('show');
                    toast.classList.add('hide');
                    setTimeout(() => toast.remove(), 300);
                }, duration);
            }

            return toast;
        }

        // Convenience functions
        function showSuccess(title, message, duration) {
            return showToast('success', title, message, duration);
        }

        function showError(title, message, duration) {
            return showToast('error', title, message, duration);
        }

        function showInfo(title, message, duration) {
            return showToast('info', title, message, duration);
        }

        function showWarning(title, message, duration) {
            return showToast('warning', title, message, duration);
        }

        // ========== CACHING & OFFLINE SUPPORT ==========

        // Register Service Worker for offline support
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js')
                .then(registration => {
                    console.log('Service Worker registered:', registration);
                })
                .catch(error => {
                    console.error('Service Worker registration failed:', error);
                });
        }

        // Cache configuration - different TTLs for different endpoints
        const CACHE_CONFIG = {
            'dashboard': 5 * 60 * 1000,        // 5 minutes
            'primaci': 10 * 60 * 1000,         // 10 minutes
            'otpremaci': 10 * 60 * 1000,       // 10 minutes
            'kupci': 10 * 60 * 1000,           // 10 minutes
            'odjeli': 15 * 60 * 1000,          // 15 minutes
            'primac-detail': 5 * 60 * 1000,    // 5 minutes
            'otpremac-detail': 5 * 60 * 1000,  // 5 minutes
            'primac-odjeli': 10 * 60 * 1000,   // 10 minutes
            'otpremac-odjeli': 10 * 60 * 1000, // 10 minutes
            'default': 5 * 60 * 1000           // 5 minutes default
        };

        // Fetch with cache - cache-first strategy
        async function fetchWithCache(url, cacheKey, forceRefresh = false) {
            // Determine cache TTL based on endpoint
            const path = new URL(url).searchParams.get('path');
            const cacheTTL = CACHE_CONFIG[path] || CACHE_CONFIG.default;

            // If force refresh, clear cache for this key
            if (forceRefresh) {
                localStorage.removeItem(cacheKey);
                console.log(`üîÑ Force refresh: cleared cache for ${cacheKey}`);
            }

            // Check cache first
            const cached = localStorage.getItem(cacheKey);
            if (cached) {
                try {
                    const cachedData = JSON.parse(cached);
                    const now = Date.now();
                    const age = now - cachedData.timestamp;

                    // If cache is fresh, return it immediately
                    if (age < cacheTTL) {
                        console.log(`‚úì Cache hit (${path}): ${Math.round(age / 1000)}s old`);
                        showCacheIndicator(age);
                        return cachedData.data;
                    } else {
                        console.log(`‚ö† Cache stale (${path}): ${Math.round(age / 1000)}s old, fetching fresh...`);
                    }
                } catch (e) {
                    console.error('Cache parse error:', e);
                }
            }

            // Cache miss or stale - fetch from network
            try {
                console.log(`‚Üª Fetching fresh data (${path})...`);
                const response = await fetch(url);
                const data = await response.json();

                // Store in cache
                localStorage.setItem(cacheKey, JSON.stringify({
                    data: data,
                    timestamp: Date.now()
                }));

                console.log(`‚úì Fresh data cached (${path})`);
                hideCacheIndicator();
                return data;

            } catch (error) {
                console.error('Network error:', error);

                // If network fails and we have stale cache, use it
                if (cached) {
                    try {
                        const cachedData = JSON.parse(cached);
                        const age = Date.now() - cachedData.timestamp;
                        console.log(`‚ö† Network failed, using stale cache (${Math.round(age / 60000)} min old)`);
                        showCacheIndicator(age, true);
                        return cachedData.data;
                    } catch (e) {
                        console.error('Stale cache parse error:', e);
                    }
                }

                throw error;
            }
        }

        // Show cache indicator
        function showCacheIndicator(age, isStale = false) {
            const indicator = document.getElementById('cache-indicator');
            if (!indicator) return;

            const minutes = Math.round(age / 60000);
            const seconds = Math.round(age / 1000);

            if (isStale) {
                indicator.innerHTML = `‚ö†Ô∏è Offline - koristeƒái ke≈°irane podatke (${minutes} min staro)`;
                indicator.style.background = '#fef3c7';
                indicator.style.color = '#92400e';
            } else {
                indicator.innerHTML = `üì¶ Ke≈°irani podaci (${seconds}s staro)`;
                indicator.style.background = '#dbeafe';
                indicator.style.color = '#1e40af';
            }
            indicator.classList.remove('hidden');
        }

        // Hide cache indicator
        function hideCacheIndicator() {
            const indicator = document.getElementById('cache-indicator');
            if (indicator) {
                indicator.classList.add('hidden');
            }
        }

        // Clear cache by pattern
        function clearCacheByPattern(pattern) {
            const keys = Object.keys(localStorage);
            const matchingKeys = keys.filter(k => k.includes(pattern));
            matchingKeys.forEach(k => localStorage.removeItem(k));
            console.log(`üóëÔ∏è  Cleared ${matchingKeys.length} cache entries matching '${pattern}'`);
            return matchingKeys.length;
        }

        // Clear all cache
        function clearAllCache() {
            const keys = Object.keys(localStorage);
            const cacheKeys = keys.filter(k => k.startsWith('cache_'));
            cacheKeys.forEach(k => localStorage.removeItem(k));
            console.log(`Cleared ${cacheKeys.length} cache entries`);

            // Clear Service Worker cache
            if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                navigator.serviceWorker.controller.postMessage({ type: 'CLEAR_CACHE' });
            }

            toggleUserMenu(); // Close menu
            showInfo('Ke≈° obrisan', 'Stranica ƒáe se osvje≈æiti.');
            window.location.reload();
        }

        // Toggle user menu dropdown
        function toggleUserMenu() {
            const dropdown = document.getElementById('user-menu-dropdown');
            dropdown.classList.toggle('show');
        }

        // Close user menu when clicking outside
        document.addEventListener('click', function(event) {
            const userMenu = document.querySelector('.user-menu');
            const dropdown = document.getElementById('user-menu-dropdown');
            if (userMenu && !userMenu.contains(event.target) && dropdown) {
                dropdown.classList.remove('show');
            }
        });

        // ========== END CACHING ==========

        let currentUser = null;
        let currentPassword = null;
        let odjeliList = [];

        // Load odjeli list from API
        async function loadOdjeli() {
            try {
                const url = API_URL + '?path=get-odjeli-list';
                const response = await fetch(url);
                const data = await response.json();

                if (data.success && data.odjeli) {
                    odjeliList = data.odjeli;
                    populateOdjeliDropdowns();
                }
            } catch (error) {
                console.error('Error loading odjeli:', error);
            }
        }

        // Populate all odjel dropdowns
        function populateOdjeliDropdowns() {
            const dropdowns = [
                'sjeca-odjel',
                'otprema-odjel',
                'edit-sjeca-odjel',
                'edit-otprema-odjel'
            ];

            dropdowns.forEach(dropdownId => {
                const dropdown = document.getElementById(dropdownId);
                if (dropdown) {
                    // Keep the first "Izaberi odjel..." option
                    const currentValue = dropdown.value;
                    dropdown.innerHTML = '<option value="">Izaberi odjel...</option>';

                    odjeliList.forEach(odjel => {
                        const option = document.createElement('option');
                        option.value = odjel;
                        option.textContent = odjel;
                        dropdown.appendChild(option);
                    });

                    // Restore previously selected value if it exists
                    if (currentValue && odjeliList.includes(currentValue)) {
                        dropdown.value = currentValue;
                    }
                }
            });
        }

        // Check if already logged in
        window.addEventListener('DOMContentLoaded', () => {
            const savedUser = localStorage.getItem('sumarija_user');
            const savedPass = localStorage.getItem('sumarija_pass');

            if (savedUser && savedPass) {
                currentUser = JSON.parse(savedUser);
                currentPassword = savedPass;
                showApp();
                loadData();
                loadOdjeli(); // Load odjeli list after auto-login
            }
        });
        
        // Login form
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorMsg = document.getElementById('error-msg');
            const loginBtn = document.getElementById('login-btn');
            
            errorMsg.classList.add('hidden');
            loginBtn.disabled = true;
            loginBtn.textContent = 'Prijavljivanje...';
            
            try {
                const response = await fetch(`${API_URL}?path=login&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`);
                const data = await response.json();
                
                if (data.success) {
                    currentUser = data;
                    currentPassword = password;
                    localStorage.setItem('sumarija_user', JSON.stringify(data));
                    localStorage.setItem('sumarija_pass', password);
                    showApp();
                    loadData();
                    loadOdjeli(); // Load odjeli list after manual login
                } else {
                    errorMsg.textContent = data.error || 'Gre≈°ka pri prijavi';
                    errorMsg.classList.remove('hidden');
                }
            } catch (error) {
                errorMsg.textContent = 'Gre≈°ka u komunikaciji sa serverom: ' + error.message;
                errorMsg.classList.remove('hidden');
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Prijavi se';
            }
        });
        
        function showApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            document.getElementById('user-name').textContent = currentUser.fullName;
            document.getElementById('user-role').textContent = currentUser.role === 'admin' ? 'Administrator' : currentUser.type;

            // Dinamiƒçki kreiraj tab-ove na osnovu tipa korisnika
            const tabsMenu = document.getElementById('tabs-menu');
            const userType = currentUser.type; // 'primac', 'otpremac', ili ne≈°to drugo

            if (userType === 'primac') {
                // Primaƒç vidi ƒçetiri prikaza: pregled, po odjelima, dodavanje, i moje sjeƒçe
                tabsMenu.innerHTML = `
                    <button class="tab active" onclick="switchTab('primac-personal')">üë∑ Pregled sjeƒçe u tekuƒáoj godini</button>
                    <button class="tab" onclick="switchTab('primac-odjeli')">üè≠ Prikaz po odjelima</button>
                    <button class="tab" onclick="switchTab('add-sjeca')">‚ûï Dodaj sjeƒçu</button>
                    <button class="tab" onclick="switchTab('my-sjece')">üìù Moje sjeƒçe</button>
                `;
            } else if (userType === 'otpremac') {
                // Otpremaƒç vidi ƒçetiri prikaza: pregled, po odjelima, dodavanje, i moje otpreme
                tabsMenu.innerHTML = `
                    <button class="tab active" onclick="switchTab('otpremac-personal')">üöõ Pregled otpreme u tekuƒáoj godini</button>
                    <button class="tab" onclick="switchTab('otpremac-odjeli')">üè≠ Prikaz po odjelima</button>
                    <button class="tab" onclick="switchTab('add-otprema')">‚ûï Dodaj otpremu</button>
                    <button class="tab" onclick="switchTab('my-otpreme')">üìù Moje otpreme</button>
                `;
            } else {
                // Admin ili drugi korisnici vide sve tab-ove
                tabsMenu.innerHTML = `
                    <button class="tab active" onclick="switchTab('dashboard')">üå≤ ≈†umarija Krupa</button>
                    <button class="tab" onclick="switchTab('mjesecni-sortimenti')">üìä Sjeƒça/otprema po mjesecima</button>
                    <button class="tab" onclick="switchTab('primaci')">üë∑ Prikaz sjeƒçe</button>
                    <button class="tab" onclick="switchTab('otpremaci')">üöõ Prikaz otpreme</button>
                    <button class="tab" onclick="switchTab('kupci')">üè¢ Prikaz po kupcima</button>
                    <button class="tab" onclick="switchTab('izvjestaji')">üìã Izvje≈°taji</button>
                    <button class="tab notification-badge" onclick="switchTab('pending-unosi')">
                        üìã Dodani unosi
                        <span class="badge-count" id="pending-count-badge"></span>
                    </button>
                `;
            }
        }
        
        function logout() {
            currentUser = null;
            currentPassword = null;
            localStorage.removeItem('sumarija_user');
            localStorage.removeItem('sumarija_pass');
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('app-screen').classList.add('hidden');
            document.getElementById('dashboard-content').classList.add('hidden');
            document.getElementById('primaci-content').classList.add('hidden');
            document.getElementById('otpremaci-content').classList.add('hidden');
            document.getElementById('kupci-content').classList.add('hidden');
            document.getElementById('primac-personal-content').classList.add('hidden');
            document.getElementById('otpremac-personal-content').classList.add('hidden');
            document.getElementById('primac-odjeli-content').classList.add('hidden');
            document.getElementById('otpremac-odjeli-content').classList.add('hidden');
            document.getElementById('add-sjeca-content').classList.add('hidden');
            document.getElementById('add-otprema-content').classList.add('hidden');
            document.getElementById('my-sjece-content').classList.add('hidden');
            document.getElementById('my-otpreme-content').classList.add('hidden');
            document.getElementById('edit-sjeca-content').classList.add('hidden');
            document.getElementById('edit-otprema-content').classList.add('hidden');
            document.getElementById('pending-unosi-content').classList.add('hidden');
            document.getElementById('loading-screen').classList.remove('hidden');
        }
        
        // Load initial data based on user type
        function loadData() {
            const userType = currentUser.type;
            if (userType === 'primac') {
                loadPrimacPersonal();
            } else if (userType === 'otpremac') {
                loadOtpremacPersonal();
            } else {
                loadDashboard();
            }
        }

        // Switch between tabs
        function switchTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            // Hide all content sections
            document.getElementById('dashboard-content').classList.add('hidden');
            document.getElementById('primaci-content').classList.add('hidden');
            document.getElementById('otpremaci-content').classList.add('hidden');
            document.getElementById('kupci-content').classList.add('hidden');
            document.getElementById('primac-personal-content').classList.add('hidden');
            document.getElementById('otpremac-personal-content').classList.add('hidden');
            document.getElementById('primac-odjeli-content').classList.add('hidden');
            document.getElementById('otpremac-odjeli-content').classList.add('hidden');
            document.getElementById('add-sjeca-content').classList.add('hidden');
            document.getElementById('add-otprema-content').classList.add('hidden');
            document.getElementById('my-sjece-content').classList.add('hidden');
            document.getElementById('my-otpreme-content').classList.add('hidden');
            document.getElementById('edit-sjeca-content').classList.add('hidden');
            document.getElementById('edit-otprema-content').classList.add('hidden');
            document.getElementById('pending-unosi-content').classList.add('hidden');
            document.getElementById('mjesecni-sortimenti-content').classList.add('hidden');
            document.getElementById('izvjestaji-content').classList.add('hidden');

            // Load appropriate content
            if (tab === 'dashboard') {
                loadDashboard();
            } else if (tab === 'primaci') {
                loadPrimaci();
            } else if (tab === 'otpremaci') {
                loadOtpremaci();
            } else if (tab === 'kupci') {
                loadKupci();
            } else if (tab === 'primac-personal') {
                loadPrimacPersonal();
            } else if (tab === 'otpremac-personal') {
                loadOtpremacPersonal();
            } else if (tab === 'primac-odjeli') {
                loadPrimacOdjeli();
            } else if (tab === 'otpremac-odjeli') {
                loadOtpremacOdjeli();
            } else if (tab === 'add-sjeca') {
                showAddSjecaForm();
            } else if (tab === 'add-otprema') {
                showAddOtpremaForm();
            } else if (tab === 'my-sjece') {
                loadMySjece();
            } else if (tab === 'my-otpreme') {
                loadMyOtpreme();
            } else if (tab === 'pending-unosi') {
                loadPendingUnosi();
            } else if (tab === 'mjesecni-sortimenti') {
                loadMjesecniSortimenti();
            } else if (tab === 'izvjestaji') {
                // Initialize dropdowns to current month/year if not already set
                const currentDate = new Date();
                const currentYear = currentDate.getFullYear();
                const currentMonth = currentDate.getMonth();

                // Set defaults for all izvjestaji dropdowns
                if (!document.getElementById('izvjestaji-year-select').value) {
                    document.getElementById('izvjestaji-year-select').value = currentYear;
                }
                if (!document.getElementById('izvjestaji-month-select').value) {
                    document.getElementById('izvjestaji-month-select').value = currentMonth;
                }
                if (!document.getElementById('sedmicni-sjeca-year-select').value) {
                    document.getElementById('sedmicni-sjeca-year-select').value = currentYear;
                }
                if (!document.getElementById('sedmicni-sjeca-month-select').value) {
                    document.getElementById('sedmicni-sjeca-month-select').value = currentMonth;
                }
                if (!document.getElementById('sedmicni-otprema-year-select').value) {
                    document.getElementById('sedmicni-otprema-year-select').value = currentYear;
                }
                if (!document.getElementById('sedmicni-otprema-month-select').value) {
                    document.getElementById('sedmicni-otprema-month-select').value = currentMonth;
                }

                // Load mjeseƒçni izvje≈°taj by default
                switchIzvjestajiSubTab('mjesecni');
            }
        }

        // Switch between primaci submenus
        function switchPrimaciSubmenu(view) {
            // Update submenu buttons
            const submenuTabs = document.querySelectorAll('#primaci-content .submenu-tab');
            submenuTabs.forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Hide all submenu content
            document.getElementById('primaci-monthly-view').classList.add('hidden');
            document.getElementById('primaci-daily-view').classList.add('hidden');
            document.getElementById('primaci-radilista-view').classList.add('hidden');
            document.getElementById('primaci-izvodjaci-view').classList.add('hidden');

            // Show selected view
            if (view === 'monthly') {
                document.getElementById('primaci-monthly-view').classList.remove('hidden');
            } else if (view === 'daily') {
                document.getElementById('primaci-daily-view').classList.remove('hidden');
                // Load daily data if not already loaded
                if (!document.getElementById('primaci-daily-header').innerHTML) {
                    loadPrimaciDaily();
                }
            } else if (view === 'radilista') {
                document.getElementById('primaci-radilista-view').classList.remove('hidden');
                // Load radilista data if not already loaded
                if (!document.getElementById('primaci-radilista-header').innerHTML) {
                    loadPrimaciByRadiliste();
                }
            } else if (view === 'izvodjaci') {
                document.getElementById('primaci-izvodjaci-view').classList.remove('hidden');
                // Load izvodjaci data if not already loaded
                if (!document.getElementById('primaci-izvodjaci-header').innerHTML) {
                    loadPrimaciByIzvodjac();
                }
            }
        }

        // Switch between otpremaci submenus
        function switchOtremaciSubmenu(view) {
            // Update submenu buttons
            const submenuTabs = document.querySelectorAll('#otpremaci-content .submenu-tab');
            submenuTabs.forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Hide all submenu content
            document.getElementById('otpremaci-monthly-view').classList.add('hidden');
            document.getElementById('otpremaci-daily-view').classList.add('hidden');
            document.getElementById('otpremaci-radilista-view').classList.add('hidden');

            // Show selected view
            if (view === 'monthly') {
                document.getElementById('otpremaci-monthly-view').classList.remove('hidden');
            } else if (view === 'daily') {
                document.getElementById('otpremaci-daily-view').classList.remove('hidden');
                // Load daily data if not already loaded
                if (!document.getElementById('otpremaci-daily-header').innerHTML) {
                    loadOtremaciDaily();
                }
            } else if (view === 'radilista') {
                document.getElementById('otpremaci-radilista-view').classList.remove('hidden');
                // Load radilista data if not already loaded
                if (!document.getElementById('otpremaci-radilista-header').innerHTML) {
                    loadOtremaciByRadiliste();
                }
            }
        }

        // Load dashboard data
        async function loadDashboard() {
            document.getElementById('loading-screen').classList.remove('hidden');
            document.getElementById('dashboard-content').classList.add('hidden');

            try {
                const year = new Date().getFullYear();

                // Fetch dashboard data with caching
                const url = `${API_URL}?path=dashboard&year=${year}&username=${currentUser.username}&password=${currentPassword}`;
                const data = await fetchWithCache(url, 'cache_dashboard_' + year);

                console.log('Dashboard data:', data);

                // Check for errors
                if (data.error) {
                    throw new Error('Dashboard API error: ' + data.error);
                }

                // Check if data is valid
                if (!data.mjesecnaStatistika) {
                    throw new Error('Dashboard data missing mjesecnaStatistika');
                }

                // Calculate summary statistics
                const totalSjeca = data.mjesecnaStatistika.reduce((sum, m) => sum + m.sjeca, 0);
                const totalOtprema = data.mjesecnaStatistika.reduce((sum, m) => sum + m.otprema, 0);
                const totalStanje = totalSjeca - totalOtprema;
                const totalDinamika = data.mjesecnaStatistika.reduce((sum, m) => sum + m.dinamika, 0);
                const razlikaDinamika = totalSjeca - totalDinamika;
                const percentDinamika = ((totalSjeca / totalDinamika) * 100).toFixed(1);

                // Create summary cards
                const summaryHTML = `
                    <div class="summary-card green">
                        <div class="summary-card-title">Ukupna Sjeƒça</div>
                        <div class="summary-card-value">${totalSjeca.toFixed(0)} m¬≥</div>
                        <div class="summary-card-subtitle">${percentDinamika}% dinamike</div>
                    </div>
                    <div class="summary-card blue">
                        <div class="summary-card-title">Ukupna Otprema</div>
                        <div class="summary-card-value">${totalOtprema.toFixed(0)} m¬≥</div>
                        <div class="summary-card-subtitle">${((totalOtprema/totalSjeca)*100).toFixed(1)}% od sjeƒçe</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-card-title">≈†uma/Panj</div>
                        <div class="summary-card-value">${totalStanje.toFixed(0)} m¬≥</div>
                        <div class="summary-card-subtitle">Preostalo u ≈°umi</div>
                    </div>
                    <div class="summary-card ${razlikaDinamika >= 0 ? 'green' : 'red'}">
                        <div class="summary-card-title">Razlika sa Dinamikom</div>
                        <div class="summary-card-value">${(razlikaDinamika >= 0 ? '+' : '') + razlikaDinamika.toFixed(0)} m¬≥</div>
                        <div class="summary-card-subtitle">${razlikaDinamika >= 0 ? 'Iznad plana' : 'Ispod plana'}</div>
                    </div>
                `;
                document.getElementById('summary-cards').innerHTML = summaryHTML;

                // Create chart
                const labels = data.mjesecnaStatistika.map(m => m.mjesec);
                const sjecaData = data.mjesecnaStatistika.map(m => m.sjeca);
                const otpremaData = data.mjesecnaStatistika.map(m => m.otprema);
                const dinamikaData = data.mjesecnaStatistika.map(m => m.dinamika);

                const ctx = document.getElementById('trendsChart');
                if (window.dashboardChart) {
                    window.dashboardChart.destroy();
                }
                window.dashboardChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Sjeƒça',
                            data: sjecaData,
                            borderColor: '#059669',
                            backgroundColor: 'rgba(5, 150, 105, 0.1)',
                            tension: 0.4,
                            fill: true
                        }, {
                            label: 'Otprema',
                            data: otpremaData,
                            borderColor: '#2563eb',
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            tension: 0.4,
                            fill: true
                        }, {
                            label: 'Dinamika',
                            data: dinamikaData,
                            borderColor: '#dc2626',
                            borderDash: [5, 5],
                            tension: 0.4,
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top' },
                            tooltip: { mode: 'index', intersect: false }
                        },
                        scales: {
                            y: { beginAtZero: true, title: { display: true, text: 'm¬≥' } }
                        }
                    }
                });

                // Populate monthly table
                const monthlyHTML = data.mjesecnaStatistika.map(m => {
                    const razlikaSjeca = m.razlikaSjeca || 0;
                    const razlikaOtprema = m.razlikaOtprema || 0;
                    const progressPercent = ((m.sjeca / m.dinamika) * 100).toFixed(1);
                    return `
                        <tr>
                            <td style="font-weight: 500;">${m.mjesec}</td>
                            <td class="right green">${m.sjeca.toFixed(2)}</td>
                            <td class="right blue">${m.otprema.toFixed(2)}</td>
                            <td class="right">${m.stanje.toFixed(2)}</td>
                            <td class="right">
                                ${m.dinamika.toFixed(2)}
                                <div class="table-progress-bar">
                                    <div class="table-progress-fill" style="width: ${Math.min(progressPercent, 100)}%"></div>
                                </div>
                            </td>
                            <td class="right ${razlikaSjeca >= 0 ? 'green' : 'red'}">${(razlikaSjeca >= 0 ? '+' : '') + razlikaSjeca.toFixed(2)}</td>
                            <td class="right ${razlikaOtprema >= 0 ? 'green' : 'red'}">${(razlikaOtprema >= 0 ? '+' : '') + razlikaOtprema.toFixed(2)}</td>
                        </tr>
                    `;
                }).join('');
                document.getElementById('dashboard-monthly-table').innerHTML = monthlyHTML;

                // Fetch and populate odjeli table with caching
                const odjeliUrl = `${API_URL}?path=odjeli&year=${year}&username=${currentUser.username}&password=${currentPassword}`;
                const odjeliData = await fetchWithCache(odjeliUrl, 'cache_odjeli_' + year);

                console.log('Odjeli data:', odjeliData);

                if (odjeliData.error) {
                    console.error('Odjeli API error:', odjeliData.error);
                    document.getElementById('odjeli-table-body').innerHTML = '<tr><td colspan="8" style="text-align: center; color: #dc2626;">Gre≈°ka pri uƒçitavanju podataka o odjelima</td></tr>';
                } else if (odjeliData.odjeli && odjeliData.odjeli.length > 0) {
                    const odjeliHTML = odjeliData.odjeli.map(o => {
                        const realizacijaColor = o.realizacija >= 100 ? 'green' : (o.realizacija >= 80 ? 'blue' : 'red');
                        return `
                            <tr>
                                <td style="font-weight: 500;">${o.odjel}</td>
                                <td class="right green">${o.sjeca.toFixed(2)}</td>
                                <td class="right blue">${o.otprema.toFixed(2)}</td>
                                <td class="right">${o.sumaPanj.toFixed(2)}</td>
                                <td>${o.radiliste || '-'}</td>
                                <td>${o.izvoƒëaƒç || '-'}</td>
                                <td>${o.datumZadnjeSjece || '-'}</td>
                                <td class="right ${realizacijaColor}">${o.realizacija > 0 ? o.realizacija.toFixed(1) + '%' : '-'}</td>
                            </tr>
                        `;
                    }).join('');
                    document.getElementById('odjeli-table-body').innerHTML = odjeliHTML;
                } else {
                    document.getElementById('odjeli-table-body').innerHTML = '<tr><td colspan="8" style="text-align: center; color: #6b7280;">Nema podataka o odjelima</td></tr>';
                }

                // Load pending count for badge (admin only)
                loadPendingCount();

                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('dashboard-content').classList.remove('hidden');

            } catch (error) {
                console.error('Dashboard error:', error);
                showError('Gre≈°ka', 'Gre≈°ka pri uƒçitavanju dashboard podataka: ' + error.message);
                document.getElementById('loading-screen').innerHTML = '<div class="loading-icon">‚ùå</div><div class="loading-text">Gre≈°ka pri uƒçitavanju</div><div class="loading-sub">' + error.message + '</div>';
            }
        }

        // Load primaci data
        async function loadPrimaci() {
            document.getElementById('loading-screen').classList.remove('hidden');
            document.getElementById('primaci-content').classList.add('hidden');

            try {
                const year = new Date().getFullYear();
                const url = `${API_URL}?path=primaci&year=${year}&username=${currentUser.username}&password=${currentPassword}`;
                const data = await fetchWithCache(url, 'cache_primaci_' + year);

                // Calculate totals per month
                const monthTotals = new Array(12).fill(0);
                let grandTotal = 0;

                data.primaci.forEach(p => {
                    p.mjeseci.forEach((val, idx) => {
                        monthTotals[idx] += val;
                    });
                    grandTotal += p.ukupno;
                });

                // Create header with sticky styling
                const headerHTML = `
                    <tr>
                        <th style="position: sticky; left: 0; background: #059669; z-index: 20; border-right: 3px solid #047857; min-width: 150px;">
                            üë∑ Primaƒç
                        </th>
                        ${data.mjeseci.map((m, idx) => `
                            <th class="right" style="min-width: 80px; background: #059669; color: white; font-weight: 700; border: 1px solid #047857;">
                                ${m}
                            </th>
                        `).join('')}
                        <th class="right" style="min-width: 100px; background: #047857; color: white; font-weight: 900; border: 2px solid #065f46;">
                            üìä UKUPNO
                        </th>
                    </tr>
                `;
                document.getElementById('primaci-header').innerHTML = headerHTML;

                // Create body with enhanced styling
                const bodyHTML = data.primaci.map((p, idx) => {
                    const rowBg = idx % 2 === 0 ? '#f0fdf4' : 'white';
                    const hoverBg = idx % 2 === 0 ? '#dcfce7' : '#f0fdf4';

                    return `
                        <tr style="background: ${rowBg}; transition: all 0.2s;" onmouseover="this.style.background='${hoverBg}'" onmouseout="this.style.background='${rowBg}'">
                            <td style="font-weight: 600; position: sticky; left: 0; background: ${rowBg}; z-index: 10; border-right: 2px solid #059669; padding: 10px; font-size: 11px;">
                                ${p.primac}
                            </td>
                            ${p.mjeseci.map((v, mIdx) => {
                                const displayVal = v > 0 ? v.toFixed(2) : '-';
                                const fontWeight = v > 0 ? 'font-weight: 500;' : 'color: #9ca3af;';
                                return `<td class="right" style="${fontWeight} border: 1px solid #d1fae5; padding: 8px; font-size: 10px; font-family: 'Courier New', monospace;">${displayVal}</td>`;
                            }).join('')}
                            <td class="right" style="font-weight: 700; background: linear-gradient(to right, #d1fae5, #a7f3d0); border: 2px solid #059669; padding: 10px; font-size: 11px; color: #065f46;">
                                ${p.ukupno.toFixed(2)} m¬≥
                            </td>
                        </tr>
                    `;
                }).join('');

                // Add totals row with softer colors
                const totalsRow = `
                    <tr style="background: linear-gradient(to bottom, #d1fae5, #a7f3d0); color: #065f46; font-weight: 700; border-top: 3px solid #34d399;">
                        <td style="position: sticky; left: 0; background: #d1fae5; z-index: 10; border-right: 3px solid #34d399; padding: 12px; font-size: 12px;">
                            üìà UKUPNO
                        </td>
                        ${monthTotals.map(total => `
                            <td class="right" style="border: 1px solid #6ee7b7; padding: 10px; font-size: 11px;">
                                ${total > 0 ? total.toFixed(2) : '-'}
                            </td>
                        `).join('')}
                        <td class="right" style="background: #a7f3d0; border: 2px solid #34d399; padding: 12px; font-size: 13px; font-weight: 900;">
                            ${grandTotal.toFixed(2)} m¬≥
                        </td>
                    </tr>
                `;

                document.getElementById('primaci-body').innerHTML = bodyHTML + totalsRow;

                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('primaci-content').classList.remove('hidden');

            } catch (error) {
                showError('Gre≈°ka', 'Gre≈°ka pri uƒçitavanju primaƒça: ' + error.message);
                document.getElementById('loading-screen').innerHTML = '<div class="loading-icon">‚ùå</div><div class="loading-text">Gre≈°ka pri uƒçitavanju</div><div class="loading-sub">' + error.message + '</div>';
            }
        }

        // Load otpremaci data
        async function loadOtpremaci() {
            document.getElementById('loading-screen').classList.remove('hidden');
            document.getElementById('otpremaci-content').classList.add('hidden');

            try {
                const year = new Date().getFullYear();
                const url = `${API_URL}?path=otpremaci&year=${year}&username=${currentUser.username}&password=${currentPassword}`;
                const data = await fetchWithCache(url, 'cache_otpremaci_' + year);

                // Calculate totals per month
                const monthTotals = new Array(12).fill(0);
                let grandTotal = 0;

                data.otpremaci.forEach(o => {
                    o.mjeseci.forEach((val, idx) => {
                        monthTotals[idx] += val;
                    });
                    grandTotal += o.ukupno;
                });

                // Create header with sticky styling (blue theme)
                const headerHTML = `
                    <tr>
                        <th style="position: sticky; left: 0; background: #2563eb; z-index: 20; border-right: 3px solid #1e40af; min-width: 150px;">
                            üöõ Otpremaƒç
                        </th>
                        ${data.mjeseci.map((m, idx) => `
                            <th class="right" style="min-width: 80px; background: #2563eb; color: white; font-weight: 700; border: 1px solid #1e40af;">
                                ${m}
                            </th>
                        `).join('')}
                        <th class="right" style="min-width: 100px; background: #1e40af; color: white; font-weight: 900; border: 2px solid #1e3a8a;">
                            üìä UKUPNO
                        </th>
                    </tr>
                `;
                document.getElementById('otpremaci-header').innerHTML = headerHTML;

                // Create body with enhanced styling (blue theme)
                const bodyHTML = data.otpremaci.map((o, idx) => {
                    const rowBg = idx % 2 === 0 ? '#eff6ff' : 'white';
                    const hoverBg = idx % 2 === 0 ? '#dbeafe' : '#eff6ff';

                    return `
                        <tr style="background: ${rowBg}; transition: all 0.2s;" onmouseover="this.style.background='${hoverBg}'" onmouseout="this.style.background='${rowBg}'">
                            <td style="font-weight: 600; position: sticky; left: 0; background: ${rowBg}; z-index: 10; border-right: 2px solid #2563eb; padding: 10px; font-size: 11px;">
                                ${o.otpremac}
                            </td>
                            ${o.mjeseci.map((v, mIdx) => {
                                const displayVal = v > 0 ? v.toFixed(2) : '-';
                                const fontWeight = v > 0 ? 'font-weight: 500;' : 'color: #9ca3af;';
                                return `<td class="right" style="${fontWeight} border: 1px solid #dbeafe; padding: 8px; font-size: 10px; font-family: 'Courier New', monospace;">${displayVal}</td>`;
                            }).join('')}
                            <td class="right" style="font-weight: 700; background: linear-gradient(to right, #dbeafe, #bfdbfe); border: 2px solid #2563eb; padding: 10px; font-size: 11px; color: #1e40af;">
                                ${o.ukupno.toFixed(2)} m¬≥
                            </td>
                        </tr>
                    `;
                }).join('');

                // Add totals row with softer colors
                const totalsRow = `
                    <tr style="background: linear-gradient(to bottom, #dbeafe, #bfdbfe); color: #1e40af; font-weight: 700; border-top: 3px solid #60a5fa;">
                        <td style="position: sticky; left: 0; background: #dbeafe; z-index: 10; border-right: 3px solid #60a5fa; padding: 12px; font-size: 12px;">
                            üìà UKUPNO
                        </td>
                        ${monthTotals.map(total => `
                            <td class="right" style="border: 1px solid #93c5fd; padding: 10px; font-size: 11px;">
                                ${total > 0 ? total.toFixed(2) : '-'}
                            </td>
                        `).join('')}
                        <td class="right" style="background: #bfdbfe; border: 2px solid #60a5fa; padding: 12px; font-size: 13px; font-weight: 900;">
                            ${grandTotal.toFixed(2)} m¬≥
                        </td>
                    </tr>
                `;

                document.getElementById('otpremaci-body').innerHTML = bodyHTML + totalsRow;

                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('otpremaci-content').classList.remove('hidden');

            } catch (error) {
                showError('Gre≈°ka', 'Gre≈°ka pri uƒçitavanju otpremaƒça: ' + error.message);
                document.getElementById('loading-screen').innerHTML = '<div class="loading-icon">‚ùå</div><div class="loading-text">Gre≈°ka pri uƒçitavanju</div><div class="loading-sub">' + error.message + '</div>';
            }
        }

        // Helper function to get month name
        function getMonthName(monthIndex) {
            const months = ['Januar', 'Februar', 'Mart', 'April', 'Maj', 'Juni',
                           'Juli', 'Avgust', 'Septembar', 'Oktobar', 'Novembar', 'Decembar'];
            return months[monthIndex];
        }

        // Load primaci daily data (for selected month)
        async function loadPrimaciDaily(selectedMonth) {
            try {
                const now = new Date();
                const year = now.getFullYear();
                const month = selectedMonth !== undefined ? parseInt(selectedMonth) : now.getMonth(); // 0-11

                // Set the selected month in the dropdown
                const monthSelect = document.getElementById('primaci-month-select');
                if (monthSelect) {
                    monthSelect.value = month;
                }

                const url = `${API_URL}?path=primaci-daily&year=${year}&month=${month}&username=${currentUser.username}&password=${currentPassword}`;
                console.log('Loading primaci daily from:', url);
                const data = await fetchWithCache(url, `cache_primaci_daily_${year}_${month}`);

                console.log('Primaci daily data received:', data);

                if (data.error) {
                    console.error('Error loading primaci daily:', data.error);
                    document.getElementById('primaci-daily-body').innerHTML = `
                        <tr><td colspan="100" style="text-align: center; padding: 40px; color: #dc2626;">
                            Gre≈°ka: ${data.error}
                        </td></tr>
                    `;
                    return;
                }

                if (!data.data || data.data.length === 0) {
                    console.log('No data available for current month');
                    document.getElementById('primaci-daily-header').innerHTML = `
                        <tr>
                            <th style="background: #ea580c; color: white; padding: 12px;">
                                üìÖ Sjeƒça po danima - ${getMonthName(month)} ${year}
                            </th>
                        </tr>
                    `;
                    document.getElementById('primaci-daily-body').innerHTML = `
                        <tr><td style="text-align: center; padding: 40px; color: #6b7280;">
                            Nema podataka za tekuƒái mjesec
                        </td></tr>
                    `;
                    return;
                }

                // ‚úÖ NOVO: Header bez kolone Datum
                const headerHTML = `
                    <tr>
                        <th style="position: sticky; top: 0; left: 0; background: linear-gradient(135deg, #ea580c 0%, #dc2626 100%); z-index: 30; border-right: 3px solid #7c2d12; min-width: 70px; box-shadow: 2px 0 5px rgba(0,0,0,0.1); font-size: 10px; padding: 8px 6px; font-weight: 800; color: white; text-transform: uppercase; letter-spacing: 0.5px;">
                            üè¢ Odjel
                        </th>
                        <th style="position: sticky; top: 0; min-width: 110px; background: linear-gradient(135deg, #ea580c 0%, #dc2626 100%); color: white; font-weight: 800; border: 1px solid #7c2d12; font-size: 10px; padding: 8px 6px; z-index: 20; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-transform: uppercase; letter-spacing: 0.5px;">
                            üë∑ Primaƒç
                        </th>
                        ${data.sortimentiNazivi.map(s => `
                            <th style="position: sticky; top: 0; min-width: 52px; background: linear-gradient(135deg, #ea580c 0%, #dc2626 100%); color: white; font-weight: 700; border: 1px solid #7c2d12; font-size: 8.5px; padding: 8px 3px; z-index: 20; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-transform: uppercase; line-height: 1.1;">
                                ${s}
                            </th>
                        `).join('')}
                    </tr>
                `;
                document.getElementById('primaci-daily-header').innerHTML = headerHTML;

                // ‚úÖ NOVO: Grupi≈°i podatke po datumu
                const groupedByDate = {};
                data.data.forEach(row => {
                    if (!groupedByDate[row.datum]) {
                        groupedByDate[row.datum] = [];
                    }
                    groupedByDate[row.datum].push(row);
                });

                // ‚úÖ NOVO: Helper funkcija za dan u sedmici
                function getDayName(dateStr) {
                    const parts = dateStr.split('.');
                    const day = parseInt(parts[0]);
                    const month = parseInt(parts[1]) - 1;
                    const yearPart = parts[2] ? parseInt(parts[2]) : year;
                    const date = new Date(yearPart, month, day);
                    const days = ['Nedjelja', 'Ponedjeljak', 'Utorak', 'Srijeda', 'ƒåetvrtak', 'Petak', 'Subota'];
                    return days[date.getDay()];
                }

                // ‚úÖ NOVO: Build body sa grupisanjem po datumu
                let bodyHTML = '';
                const dates = Object.keys(groupedByDate).sort((a, b) => {
                    const [dayA, monthA] = a.split('.').map(Number);
                    const [dayB, monthB] = b.split('.').map(Number);
                    return monthA !== monthB ? monthB - monthA : dayB - dayA;  // Obrnut redosled - od najnovijeg ka najstarijem
                });

                dates.forEach(datum => {
                    const rows = groupedByDate[datum];
                    const dayName = getDayName(datum);

                    // ‚úÖ Zaglavlje datuma
                    const numSortimenti = data.sortimentiNazivi.length;
                    bodyHTML += `
                        <tr style="background: linear-gradient(135deg, #c2410c 0%, #9a3412 50%, #7c2d12 100%); box-shadow: 0 2px 8px rgba(124, 45, 18, 0.4);">
                            <td colspan="${2 + numSortimenti}" style="font-weight: 800; font-size: 14px; padding: 10px 12px; text-align: center; border-top: 3px solid #451a03; color: white; letter-spacing: 1px; text-shadow: 0 2px 4px rgba(0,0,0,0.5);">
                                üìÖ ${datum} - ${dayName}
                            </td>
                        </tr>
                    `;

                    // ‚úÖ Kalkuli≈°i totale za ovaj dan
                    const dailyTotals = {};
                    data.sortimentiNazivi.forEach(s => dailyTotals[s] = 0);
                    rows.forEach(row => {
                        data.sortimentiNazivi.forEach(s => {
                            dailyTotals[s] += row.sortimenti[s] || 0;
                        });
                    });

                    // üé® EXPERT: Data rows sa hover animations
                    rows.forEach((row, idx) => {
                        const rowBg = idx % 2 === 0 ? '#fff7ed' : '#ffffff';
                        const hoverBg = '#ffedd5';

                        const sortimentiCells = data.sortimentiNazivi.map(sortiment => {
                            const val = row.sortimenti[sortiment] || 0;
                            const displayVal = val > 0 ? val.toFixed(2) : '-';
                            const fontWeight = val > 0 ? 'font-weight: 600; color: #7c2d12;' : 'color: #d1d5db;';
                            return `<td style="${fontWeight} border: 1px solid #fed7aa; font-family: 'Courier New', monospace; font-size: 10px; text-align: right; padding: 6px 3px; transition: all 0.15s;">${displayVal}</td>`;
                        }).join('');

                        bodyHTML += `
                            <tr style="background: ${rowBg}; transition: all 0.15s ease;" onmouseover="this.style.background='${hoverBg}'; this.style.transform='scale(1.005)'; this.style.boxShadow='0 2px 8px rgba(234,88,12,0.15)';" onmouseout="this.style.background='${rowBg}'; this.style.transform='scale(1)'; this.style.boxShadow='none';">
                                <td style="font-weight: 700; font-size: 10px; position: sticky; left: 0; background: ${rowBg}; z-index: 10; border-right: 2px solid #ea580c; padding: 6px 5px; border: 1px solid #fed7aa; color: #7c2d12; box-shadow: 2px 0 3px rgba(0,0,0,0.05);">
                                    ${row.odjel}
                                </td>
                                <td style="font-weight: 600; font-size: 10px; border: 1px solid #fed7aa; padding: 6px 5px; color: #9a3412;">${row.primac}</td>
                                ${sortimentiCells}
                            </tr>
                        `;
                    });

                    // üé® EXPERT: Daily recap sa gradient i shadow
                    const dailyTotalsCells = data.sortimentiNazivi.map(s => {
                        const val = dailyTotals[s];
                        const displayVal = val > 0 ? val.toFixed(2) : '-';
                        return `<td style="border: 1px solid #fb923c; font-family: 'Courier New', monospace; font-size: 10px; text-align: right; padding: 7px 3px; font-weight: 800; background: #fed7aa; color: #7c2d12;">${displayVal}</td>`;
                    }).join('');

                    bodyHTML += `
                        <tr style="background: linear-gradient(to bottom, #fed7aa 0%, #fdba74 100%); box-shadow: 0 1px 4px rgba(251,146,60,0.3);">
                            <td style="position: sticky; left: 0; background: linear-gradient(to right, #fed7aa 0%, #fdba74 100%); z-index: 10; border-right: 2px solid #ea580c; padding: 8px 5px; font-size: 11px; font-weight: 800; color: #7c2d12; box-shadow: 2px 0 4px rgba(0,0,0,0.1);">
                                üìä UKUPNO ${datum}
                            </td>
                            <td style="background: transparent;"></td>
                            ${dailyTotalsCells}
                        </tr>
                    `;
                });

                // ‚úÖ Grand total za cijeli mjesec (na kraju)
                const grandTotals = {};
                data.sortimentiNazivi.forEach(s => grandTotals[s] = 0);
                data.data.forEach(row => {
                    data.sortimentiNazivi.forEach(s => {
                        grandTotals[s] += row.sortimenti[s] || 0;
                    });
                });

                const grandTotalsCells = data.sortimentiNazivi.map(s => {
                    const val = grandTotals[s];
                    const displayVal = val > 0 ? val.toFixed(2) : '-';
                    return `<td style="border: 2px solid #7c2d12; font-family: 'Courier New', monospace; text-align: right; padding: 9px 3px; font-weight: 800; font-size: 11px; background: #dcfce7; color: #065f46;">${displayVal}</td>`;
                }).join('');

                bodyHTML += `
                    <tr style="background: linear-gradient(135deg, #16a34a 0%, #059669 50%, #047857 100%); color: white; font-weight: 800; border-top: 4px solid #065f46; box-shadow: 0 -2px 8px rgba(22,163,74,0.3);">
                        <td colspan="2" style="padding: 12px; font-size: 13px; text-align: center; font-weight: 900; letter-spacing: 1.5px; text-shadow: 0 1px 3px rgba(0,0,0,0.4);">
                            üìà UKUPNO ${getMonthName(month).toUpperCase()}
                        </td>
                        ${grandTotalsCells}
                    </tr>
                `;

                document.getElementById('primaci-daily-body').innerHTML = bodyHTML;

                console.log('Primaci daily table rendered with', data.data.length, 'rows');

            } catch (error) {
                console.error('Error in loadPrimaciDaily:', error);
                document.getElementById('primaci-daily-body').innerHTML = `
                    <tr><td colspan="100" style="text-align: center; padding: 40px; color: #dc2626;">
                        Gre≈°ka pri uƒçitavanju: ${error.message}
                    </td></tr>
                `;
            }
        }

        // Load otpremaci daily data (for selected month)
        async function loadOtremaciDaily(selectedMonth) {
            try {
                const now = new Date();
                const year = now.getFullYear();
                const month = selectedMonth !== undefined ? parseInt(selectedMonth) : now.getMonth(); // 0-11

                // Set the selected month in the dropdown
                const monthSelect = document.getElementById('otpremaci-month-select');
                if (monthSelect) {
                    monthSelect.value = month;
                }

                const url = `${API_URL}?path=otpremaci-daily&year=${year}&month=${month}&username=${currentUser.username}&password=${currentPassword}`;
                console.log('Loading otpremaci daily from:', url);
                const data = await fetchWithCache(url, `cache_otpremaci_daily_${year}_${month}`);

                console.log('Otpremaci daily data received:', data);

                if (data.error) {
                    console.error('Error loading otpremaci daily:', data.error);
                    document.getElementById('otpremaci-daily-body').innerHTML = `
                        <tr><td colspan="100" style="text-align: center; padding: 40px; color: #dc2626;">
                            Gre≈°ka: ${data.error}
                        </td></tr>
                    `;
                    return;
                }

                if (!data.data || data.data.length === 0) {
                    console.log('No data available for current month');
                    document.getElementById('otpremaci-daily-header').innerHTML = `
                        <tr>
                            <th style="background: #0891b2; color: white; padding: 12px;">
                                üìÖ Otprema po danima - ${getMonthName(month)} ${year}
                            </th>
                        </tr>
                    `;
                    document.getElementById('otpremaci-daily-body').innerHTML = `
                        <tr><td style="text-align: center; padding: 40px; color: #6b7280;">
                            Nema podataka za tekuƒái mjesec
                        </td></tr>
                    `;
                    return;
                }

                // ‚úÖ NOVO: Header bez kolone Datum
                const headerHTML = `
                    <tr>
                        <th style="position: sticky; top: 0; left: 0; background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%); z-index: 30; border-right: 3px solid #164e63; min-width: 70px; box-shadow: 2px 0 5px rgba(0,0,0,0.1); font-size: 10px; padding: 8px 6px; font-weight: 800; color: white; text-transform: uppercase; letter-spacing: 0.5px;">
                            üè¢ Odjel
                        </th>
                        <th style="position: sticky; top: 0; min-width: 105px; background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%); color: white; font-weight: 800; border: 1px solid #164e63; font-size: 9px; padding: 8px 6px; z-index: 20; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-transform: uppercase; letter-spacing: 0.5px;">
                            üöõ Otpremaƒç
                        </th>
                        <th style="position: sticky; top: 0; min-width: 105px; background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%); color: white; font-weight: 800; border: 1px solid #164e63; font-size: 9px; padding: 8px 6px; z-index: 20; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-transform: uppercase; letter-spacing: 0.5px;">
                            üë§ Kupac
                        </th>
                        ${data.sortimentiNazivi.map(s => `
                            <th style="position: sticky; top: 0; min-width: 52px; background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%); color: white; font-weight: 700; border: 1px solid #164e63; font-size: 8.5px; padding: 8px 3px; z-index: 20; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-transform: uppercase; line-height: 1.1;">
                                ${s}
                            </th>
                        `).join('')}
                    </tr>
                `;
                document.getElementById('otpremaci-daily-header').innerHTML = headerHTML;

                // ‚úÖ NOVO: Grupi≈°i podatke po datumu
                const groupedByDate = {};
                data.data.forEach(row => {
                    if (!groupedByDate[row.datum]) {
                        groupedByDate[row.datum] = [];
                    }
                    groupedByDate[row.datum].push(row);
                });

                // ‚úÖ NOVO: Helper funkcija za dan u sedmici
                function getDayName(dateStr) {
                    const parts = dateStr.split('.');
                    const day = parseInt(parts[0]);
                    const month = parseInt(parts[1]) - 1;
                    const yearPart = parts[2] ? parseInt(parts[2]) : year;
                    const date = new Date(yearPart, month, day);
                    const days = ['Nedjelja', 'Ponedjeljak', 'Utorak', 'Srijeda', 'ƒåetvrtak', 'Petak', 'Subota'];
                    return days[date.getDay()];
                }

                // ‚úÖ NOVO: Build body sa grupisanjem po datumu
                let bodyHTML = '';
                const dates = Object.keys(groupedByDate).sort((a, b) => {
                    const [dayA, monthA] = a.split('.').map(Number);
                    const [dayB, monthB] = b.split('.').map(Number);
                    return monthA !== monthB ? monthB - monthA : dayB - dayA;  // Obrnut redosled - od najnovijeg ka najstarijem
                });

                dates.forEach(datum => {
                    const rows = groupedByDate[datum];
                    const dayName = getDayName(datum);

                    // ‚úÖ Zaglavlje datuma
                    const numSortimenti = data.sortimentiNazivi.length;
                    bodyHTML += `
                        <tr style="background: linear-gradient(135deg, #0e7490 0%, #155e75 50%, #164e63 100%); box-shadow: 0 2px 8px rgba(22, 78, 99, 0.4);">
                            <td colspan="${3 + numSortimenti}" style="font-weight: 800; font-size: 14px; padding: 10px 12px; text-align: center; border-top: 3px solid #083344; color: white; letter-spacing: 1px; text-shadow: 0 2px 4px rgba(0,0,0,0.5);">
                                üìÖ ${datum} - ${dayName}
                            </td>
                        </tr>
                    `;

                    // ‚úÖ Kalkuli≈°i totale za ovaj dan
                    const dailyTotals = {};
                    data.sortimentiNazivi.forEach(s => dailyTotals[s] = 0);
                    rows.forEach(row => {
                        data.sortimentiNazivi.forEach(s => {
                            dailyTotals[s] += row.sortimenti[s] || 0;
                        });
                    });

                    // ‚úÖ Redovi za ovaj dan (bez kolone Datum)
                    rows.forEach((row, idx) => {
                        const rowBg = idx % 2 === 0 ? '#ecfeff' : '#ffffff';
                        const hoverBg = '#cffafe';

                        const sortimentiCells = data.sortimentiNazivi.map(sortiment => {
                            const val = row.sortimenti[sortiment] || 0;
                            const displayVal = val > 0 ? val.toFixed(2) : '-';
                            const fontWeight = val > 0 ? 'font-weight: 600; color: #164e63;' : 'color: #d1d5db;';
                            return `<td style="${fontWeight} border: 1px solid #a5f3fc; font-family: 'Courier New', monospace; font-size: 10px; text-align: right; padding: 6px 3px; transition: all 0.15s;">${displayVal}</td>`;
                        }).join('');

                        bodyHTML += `
                            <tr style="background: ${rowBg}; transition: all 0.15s ease;" onmouseover="this.style.background='${hoverBg}'; this.style.transform='scale(1.005)'; this.style.boxShadow='0 2px 8px rgba(8,145,178,0.15)';" onmouseout="this.style.background='${rowBg}'; this.style.transform='scale(1)'; this.style.boxShadow='none';">
                                <td style="font-weight: 700; font-size: 10px; position: sticky; left: 0; background: ${rowBg}; z-index: 10; border-right: 2px solid #0891b2; padding: 6px 5px; border: 1px solid #a5f3fc; color: #164e63; box-shadow: 2px 0 3px rgba(0,0,0,0.05);">
                                    ${row.odjel}
                                </td>
                                <td style="font-weight: 600; font-size: 10px; border: 1px solid #a5f3fc; padding: 6px 5px; color: #0e7490;">${row.otpremac}</td>
                                <td style="border: 1px solid #a5f3fc; color: #155e75; font-weight: 600; font-size: 10px; padding: 6px 5px;">${row.kupac || '-'}</td>
                                ${sortimentiCells}
                            </tr>
                        `;
                    });

                    // ‚úÖ Rekapitulacija za ovaj dan
                    const dailyTotalsCells = data.sortimentiNazivi.map(s => {
                        const val = dailyTotals[s];
                        const displayVal = val > 0 ? val.toFixed(2) : '-';
                        return `<td style="border: 1px solid #22d3ee; font-family: 'Courier New', monospace; text-align: right; padding: 7px 3px; font-size: 10px; font-weight: 800; color: #164e63; background: #a5f3fc;">${displayVal}</td>`;
                    }).join('');

                    bodyHTML += `
                        <tr style="background: linear-gradient(to bottom, #a5f3fc, #67e8f9); color: #0e7490; font-weight: 700;">
                            <td style="position: sticky; left: 0; background: #a5f3fc; z-index: 10; border-right: 2px solid #0891b2; padding: 10px; font-size: 13px;">
                                üìä UKUPNO ${datum}
                            </td>
                            <td style="background: transparent;"></td>
                            <td style="background: #a5f3fc;"></td>
                            ${dailyTotalsCells}
                        </tr>
                    `;
                });

                // ‚úÖ Grand total za cijeli mjesec (na kraju)
                const grandTotals = {};
                data.sortimentiNazivi.forEach(s => grandTotals[s] = 0);
                data.data.forEach(row => {
                    data.sortimentiNazivi.forEach(s => {
                        grandTotals[s] += row.sortimenti[s] || 0;
                    });
                });

                const grandTotalsCells = data.sortimentiNazivi.map(s => {
                    const val = grandTotals[s];
                    const displayVal = val > 0 ? val.toFixed(2) : '-';
                    return `<td style="border: 2px solid #164e63; font-family: 'Courier New', monospace; text-align: right; padding: 9px 3px; font-weight: 800; font-size: 11px; background: #bfdbfe; color: #1e3a8a;">${displayVal}</td>`;
                }).join('');

                bodyHTML += `
                    <tr style="background: linear-gradient(135deg, #0e7490, #0891b2); color: white; font-weight: 700; border-top: 4px solid #164e63;">
                        <td colspan="3" style="padding: 12px; font-size: 13px; font-weight: 900; letter-spacing: 1.5px; text-shadow: 0 1px 3px rgba(0,0,0,0.4); text-align: center;">
                            üìà UKUPNO ${getMonthName(month).toUpperCase()}
                        </td>
                        ${grandTotalsCells}
                    </tr>
                `;

                document.getElementById('otpremaci-daily-body').innerHTML = bodyHTML;

                console.log('Otpremaci daily table rendered with', data.data.length, 'rows');

            } catch (error) {
                console.error('Error in loadOtremaciDaily:', error);
                document.getElementById('otpremaci-daily-body').innerHTML = `
                    <tr><td colspan="100" style="text-align: center; padding: 40px; color: #dc2626;">
                        Gre≈°ka pri uƒçitavanju: ${error.message}
                    </td></tr>
                `;
            }
        }

        // ========================================
        // PRIKAZI PO RADILI≈†TIMA I IZVOƒêAƒåIMA
        // ========================================

        // Load primaci by radiliste
        async function loadPrimaciByRadiliste() {
            try {
                const year = new Date().getFullYear();
                const url = `${API_URL}?path=primaci-by-radiliste&year=${year}&username=${currentUser.username}&password=${currentPassword}`;

                const data = await fetchWithCache(url, `cache_primaci_radiliste_${year}`);

                console.log('Primaci by radiliste data received:', data);

                if (data.error) {
                    console.error('Error loading primaci by radiliste:', data.error);
                    document.getElementById('primaci-radilista-body').innerHTML = `
                        <tr><td colspan="100" style="text-align: center; padding: 40px; color: #dc2626;">
                            Gre≈°ka: ${data.error}
                        </td></tr>
                    `;
                    return;
                }

                if (!data.radilista || data.radilista.length === 0) {
                    document.getElementById('primaci-radilista-header').innerHTML = `
                        <tr><th style="background: #ea580c; color: white; padding: 12px;">
                            üèóÔ∏è Prikaz po radili≈°tima - ${year}
                        </th></tr>
                    `;
                    document.getElementById('primaci-radilista-body').innerHTML = `
                        <tr><td style="text-align: center; padding: 40px; color: #6b7280;">
                            Nema podataka o radili≈°tima
                        </td></tr>
                    `;
                    return;
                }

                // Render mjeseƒçnu tabelu
                const mjeseci = ['Jan', 'Feb', 'Mar', 'Apr', 'Maj', 'Jun', 'Jul', 'Avg', 'Sep', 'Okt', 'Nov', 'Dec'];

                let headerHTML = `
                    <tr>
                        <th style="background: linear-gradient(135deg, #ea580c, #dc2626); color: white; padding: 12px; position: sticky; top: 0; z-index: 20;">
                            üèóÔ∏è Radili≈°te
                        </th>
                `;
                mjeseci.forEach(mj => {
                    headerHTML += `<th style="background: linear-gradient(135deg, #ea580c, #dc2626); color: white; padding: 12px; position: sticky; top: 0; z-index: 20; font-size: 12px;">${mj}</th>`;
                });
                headerHTML += `
                    <th style="background: linear-gradient(135deg, #7c2d12, #451a03); color: white; padding: 12px; font-weight: 900; position: sticky; top: 0; z-index: 20;">
                        UKUPNO
                    </th>
                </tr>
                `;
                document.getElementById('primaci-radilista-header').innerHTML = headerHTML;

                let bodyHTML = '';
                data.radilista.forEach((radiliste, idx) => {
                    const rowBg = idx % 2 === 0 ? '#fff7ed' : '#ffffff';
                    const hoverBg = '#ffedd5';

                    const mjeseciCells = radiliste.mjeseci.map(val => {
                        const displayVal = val > 0 ? val.toFixed(2) : '-';
                        const fontWeight = val > 0 ? 'font-weight: 700; color: #7c2d12;' : 'color: #d1d5db;';
                        return `<td style="${fontWeight} border: 1px solid #fed7aa; font-family: 'Courier New', monospace; font-size: 11px; text-align: right; padding: 8px;">${displayVal}</td>`;
                    }).join('');

                    bodyHTML += `
                        <tr style="background: ${rowBg}; transition: all 0.15s ease;" onmouseover="this.style.background='${hoverBg}';" onmouseout="this.style.background='${rowBg}';">
                            <td style="font-weight: 700; font-size: 12px; border: 1px solid #fed7aa; padding: 10px; color: #7c2d12;">
                                ${radiliste.naziv}
                            </td>
                            ${mjeseciCells}
                            <td style="background: #fef3c7; border: 2px solid #f59e0b; font-family: 'Courier New', monospace; text-align: right; padding: 10px; font-weight: 900; font-size: 13px; color: #92400e;">
                                ${radiliste.ukupno.toFixed(2)}
                            </td>
                        </tr>
                    `;
                });
                document.getElementById('primaci-radilista-body').innerHTML = bodyHTML;

                // Render godi≈°nju rekapitulaciju po sortimentima
                let recapHeaderHTML = `
                    <tr>
                        <th style="background: linear-gradient(135deg, #ea580c, #dc2626); color: white; padding: 12px; position: sticky; top: 0; z-index: 20;">
                            üèóÔ∏è Radili≈°te
                        </th>
                `;
                data.sortimentiNazivi.forEach(s => {
                    recapHeaderHTML += `<th style="background: linear-gradient(135deg, #ea580c, #dc2626); color: white; padding: 12px; position: sticky; top: 0; z-index: 20; font-size: 10px;">${s}</th>`;
                });
                recapHeaderHTML += `</tr>`;
                document.getElementById('primaci-radilista-recap-header').innerHTML = recapHeaderHTML;

                let recapBodyHTML = '';
                data.radilista.forEach((radiliste, idx) => {
                    const rowBg = idx % 2 === 0 ? '#fff7ed' : '#ffffff';

                    const sortimentiCells = data.sortimentiNazivi.map(s => {
                        const val = radiliste.sortimentiUkupno[s] || 0;
                        const displayVal = val > 0 ? val.toFixed(2) : '-';
                        const fontWeight = val > 0 ? 'font-weight: 700; color: #7c2d12;' : 'color: #d1d5db;';
                        return `<td style="${fontWeight} border: 1px solid #fed7aa; font-family: 'Courier New', monospace; font-size: 10px; text-align: right; padding: 8px;">${displayVal}</td>`;
                    }).join('');

                    recapBodyHTML += `
                        <tr style="background: ${rowBg};">
                            <td style="font-weight: 700; font-size: 12px; border: 1px solid #fed7aa; padding: 10px; color: #7c2d12;">
                                ${radiliste.naziv}
                            </td>
                            ${sortimentiCells}
                        </tr>
                    `;
                });
                document.getElementById('primaci-radilista-recap-body').innerHTML = recapBodyHTML;

                console.log('Primaci by radiliste rendered');

            } catch (error) {
                console.error('Error in loadPrimaciByRadiliste:', error);
                document.getElementById('primaci-radilista-body').innerHTML = `
                    <tr><td colspan="100" style="text-align: center; padding: 40px; color: #dc2626;">
                        Gre≈°ka pri uƒçitavanju: ${error.message}
                    </td></tr>
                `;
            }
        }

        // Load primaci by izvodjac
        async function loadPrimaciByIzvodjac() {
            try {
                const year = new Date().getFullYear();
                const url = `${API_URL}?path=primaci-by-izvodjac&year=${year}&username=${currentUser.username}&password=${currentPassword}`;

                const data = await fetchWithCache(url, `cache_primaci_izvodjac_${year}`);

                console.log('Primaci by izvodjac data received:', data);

                if (data.error) {
                    console.error('Error loading primaci by izvodjac:', data.error);
                    document.getElementById('primaci-izvodjaci-body').innerHTML = `
                        <tr><td colspan="100" style="text-align: center; padding: 40px; color: #dc2626;">
                            Gre≈°ka: ${data.error}
                        </td></tr>
                    `;
                    return;
                }

                if (!data.izvodjaci || data.izvodjaci.length === 0) {
                    document.getElementById('primaci-izvodjaci-header').innerHTML = `
                        <tr><th style="background: #ea580c; color: white; padding: 12px;">
                            üë∑ Prikaz po izvoƒëaƒçima - ${year}
                        </th></tr>
                    `;
                    document.getElementById('primaci-izvodjaci-body').innerHTML = `
                        <tr><td style="text-align: center; padding: 40px; color: #6b7280;">
                            Nema podataka o izvoƒëaƒçima
                        </td></tr>
                    `;
                    return;
                }

                // Render mjeseƒçnu tabelu
                const mjeseci = ['Jan', 'Feb', 'Mar', 'Apr', 'Maj', 'Jun', 'Jul', 'Avg', 'Sep', 'Okt', 'Nov', 'Dec'];

                let headerHTML = `
                    <tr>
                        <th style="background: linear-gradient(135deg, #ea580c, #dc2626); color: white; padding: 12px; position: sticky; top: 0; z-index: 20;">
                            üë∑ Izvoƒëaƒç radova
                        </th>
                `;
                mjeseci.forEach(mj => {
                    headerHTML += `<th style="background: linear-gradient(135deg, #ea580c, #dc2626); color: white; padding: 12px; position: sticky; top: 0; z-index: 20; font-size: 12px;">${mj}</th>`;
                });
                headerHTML += `
                    <th style="background: linear-gradient(135deg, #7c2d12, #451a03); color: white; padding: 12px; font-weight: 900; position: sticky; top: 0; z-index: 20;">
                        UKUPNO
                    </th>
                </tr>
                `;
                document.getElementById('primaci-izvodjaci-header').innerHTML = headerHTML;

                let bodyHTML = '';
                data.izvodjaci.forEach((izvodjac, idx) => {
                    const rowBg = idx % 2 === 0 ? '#fff7ed' : '#ffffff';
                    const hoverBg = '#ffedd5';

                    const mjeseciCells = izvodjac.mjeseci.map(val => {
                        const displayVal = val > 0 ? val.toFixed(2) : '-';
                        const fontWeight = val > 0 ? 'font-weight: 700; color: #7c2d12;' : 'color: #d1d5db;';
                        return `<td style="${fontWeight} border: 1px solid #fed7aa; font-family: 'Courier New', monospace; font-size: 11px; text-align: right; padding: 8px;">${displayVal}</td>`;
                    }).join('');

                    bodyHTML += `
                        <tr style="background: ${rowBg}; transition: all 0.15s ease;" onmouseover="this.style.background='${hoverBg}';" onmouseout="this.style.background='${rowBg}';">
                            <td style="font-weight: 700; font-size: 12px; border: 1px solid #fed7aa; padding: 10px; color: #7c2d12;">
                                ${izvodjac.naziv}
                            </td>
                            ${mjeseciCells}
                            <td style="background: #fef3c7; border: 2px solid #f59e0b; font-family: 'Courier New', monospace; text-align: right; padding: 10px; font-weight: 900; font-size: 13px; color: #92400e;">
                                ${izvodjac.ukupno.toFixed(2)}
                            </td>
                        </tr>
                    `;
                });
                document.getElementById('primaci-izvodjaci-body').innerHTML = bodyHTML;

                // Render godi≈°nju rekapitulaciju po sortimentima
                let recapHeaderHTML = `
                    <tr>
                        <th style="background: linear-gradient(135deg, #ea580c, #dc2626); color: white; padding: 12px; position: sticky; top: 0; z-index: 20;">
                            üë∑ Izvoƒëaƒç radova
                        </th>
                `;
                data.sortimentiNazivi.forEach(s => {
                    recapHeaderHTML += `<th style="background: linear-gradient(135deg, #ea580c, #dc2626); color: white; padding: 12px; position: sticky; top: 0; z-index: 20; font-size: 10px;">${s}</th>`;
                });
                recapHeaderHTML += `</tr>`;
                document.getElementById('primaci-izvodjaci-recap-header').innerHTML = recapHeaderHTML;

                let recapBodyHTML = '';
                data.izvodjaci.forEach((izvodjac, idx) => {
                    const rowBg = idx % 2 === 0 ? '#fff7ed' : '#ffffff';

                    const sortimentiCells = data.sortimentiNazivi.map(s => {
                        const val = izvodjac.sortimentiUkupno[s] || 0;
                        const displayVal = val > 0 ? val.toFixed(2) : '-';
                        const fontWeight = val > 0 ? 'font-weight: 700; color: #7c2d12;' : 'color: #d1d5db;';
                        return `<td style="${fontWeight} border: 1px solid #fed7aa; font-family: 'Courier New', monospace; font-size: 10px; text-align: right; padding: 8px;">${displayVal}</td>`;
                    }).join('');

                    recapBodyHTML += `
                        <tr style="background: ${rowBg};">
                            <td style="font-weight: 700; font-size: 12px; border: 1px solid #fed7aa; padding: 10px; color: #7c2d12;">
                                ${izvodjac.naziv}
                            </td>
                            ${sortimentiCells}
                        </tr>
                    `;
                });
                document.getElementById('primaci-izvodjaci-recap-body').innerHTML = recapBodyHTML;

                console.log('Primaci by izvodjac rendered');

            } catch (error) {
                console.error('Error in loadPrimaciByIzvodjac:', error);
                document.getElementById('primaci-izvodjaci-body').innerHTML = `
                    <tr><td colspan="100" style="text-align: center; padding: 40px; color: #dc2626;">
                        Gre≈°ka pri uƒçitavanju: ${error.message}
                    </td></tr>
                `;
            }
        }

        // Load otpremaci by radiliste
        async function loadOtremaciByRadiliste() {
            try {
                const year = new Date().getFullYear();
                const url = `${API_URL}?path=otpremaci-by-radiliste&year=${year}&username=${currentUser.username}&password=${currentPassword}`;

                const data = await fetchWithCache(url, `cache_otpremaci_radiliste_${year}`);

                console.log('Otpremaci by radiliste data received:', data);

                if (data.error) {
                    console.error('Error loading otpremaci by radiliste:', data.error);
                    document.getElementById('otpremaci-radilista-body').innerHTML = `
                        <tr><td colspan="100" style="text-align: center; padding: 40px; color: #dc2626;">
                            Gre≈°ka: ${data.error}
                        </td></tr>
                    `;
                    return;
                }

                if (!data.radilista || data.radilista.length === 0) {
                    document.getElementById('otpremaci-radilista-header').innerHTML = `
                        <tr><th style="background: #0891b2; color: white; padding: 12px;">
                            üèóÔ∏è Prikaz po radili≈°tima - ${year}
                        </th></tr>
                    `;
                    document.getElementById('otpremaci-radilista-body').innerHTML = `
                        <tr><td style="text-align: center; padding: 40px; color: #6b7280;">
                            Nema podataka o radili≈°tima
                        </td></tr>
                    `;
                    return;
                }

                // Render mjeseƒçnu tabelu
                const mjeseci = ['Jan', 'Feb', 'Mar', 'Apr', 'Maj', 'Jun', 'Jul', 'Avg', 'Sep', 'Okt', 'Nov', 'Dec'];

                let headerHTML = `
                    <tr>
                        <th style="background: linear-gradient(135deg, #0891b2, #0e7490); color: white; padding: 12px; position: sticky; top: 0; z-index: 20;">
                            üèóÔ∏è Radili≈°te
                        </th>
                `;
                mjeseci.forEach(mj => {
                    headerHTML += `<th style="background: linear-gradient(135deg, #0891b2, #0e7490); color: white; padding: 12px; position: sticky; top: 0; z-index: 20; font-size: 12px;">${mj}</th>`;
                });
                headerHTML += `
                    <th style="background: linear-gradient(135deg, #155e75, #164e63); color: white; padding: 12px; font-weight: 900; position: sticky; top: 0; z-index: 20;">
                        UKUPNO
                    </th>
                </tr>
                `;
                document.getElementById('otpremaci-radilista-header').innerHTML = headerHTML;

                let bodyHTML = '';
                data.radilista.forEach((radiliste, idx) => {
                    const rowBg = idx % 2 === 0 ? '#cffafe' : '#ffffff';
                    const hoverBg = '#a5f3fc';

                    const mjeseciCells = radiliste.mjeseci.map(val => {
                        const displayVal = val > 0 ? val.toFixed(2) : '-';
                        const fontWeight = val > 0 ? 'font-weight: 700; color: #155e75;' : 'color: #d1d5db;';
                        return `<td style="${fontWeight} border: 1px solid #a5f3fc; font-family: 'Courier New', monospace; font-size: 11px; text-align: right; padding: 8px;">${displayVal}</td>`;
                    }).join('');

                    bodyHTML += `
                        <tr style="background: ${rowBg}; transition: all 0.15s ease;" onmouseover="this.style.background='${hoverBg}';" onmouseout="this.style.background='${rowBg}';">
                            <td style="font-weight: 700; font-size: 12px; border: 1px solid #a5f3fc; padding: 10px; color: #155e75;">
                                ${radiliste.naziv}
                            </td>
                            ${mjeseciCells}
                            <td style="background: #bfdbfe; border: 2px solid #3b82f6; font-family: 'Courier New', monospace; text-align: right; padding: 10px; font-weight: 900; font-size: 13px; color: #1e3a8a;">
                                ${radiliste.ukupno.toFixed(2)}
                            </td>
                        </tr>
                    `;
                });
                document.getElementById('otpremaci-radilista-body').innerHTML = bodyHTML;

                // Render godi≈°nju rekapitulaciju po sortimentima
                let recapHeaderHTML = `
                    <tr>
                        <th style="background: linear-gradient(135deg, #0891b2, #0e7490); color: white; padding: 12px; position: sticky; top: 0; z-index: 20;">
                            üèóÔ∏è Radili≈°te
                        </th>
                `;
                data.sortimentiNazivi.forEach(s => {
                    recapHeaderHTML += `<th style="background: linear-gradient(135deg, #0891b2, #0e7490); color: white; padding: 12px; position: sticky; top: 0; z-index: 20; font-size: 10px;">${s}</th>`;
                });
                recapHeaderHTML += `</tr>`;
                document.getElementById('otpremaci-radilista-recap-header').innerHTML = recapHeaderHTML;

                let recapBodyHTML = '';
                data.radilista.forEach((radiliste, idx) => {
                    const rowBg = idx % 2 === 0 ? '#cffafe' : '#ffffff';

                    const sortimentiCells = data.sortimentiNazivi.map(s => {
                        const val = radiliste.sortimentiUkupno[s] || 0;
                        const displayVal = val > 0 ? val.toFixed(2) : '-';
                        const fontWeight = val > 0 ? 'font-weight: 700; color: #155e75;' : 'color: #d1d5db;';
                        return `<td style="${fontWeight} border: 1px solid #a5f3fc; font-family: 'Courier New', monospace; font-size: 10px; text-align: right; padding: 8px;">${displayVal}</td>`;
                    }).join('');

                    recapBodyHTML += `
                        <tr style="background: ${rowBg};">
                            <td style="font-weight: 700; font-size: 12px; border: 1px solid #a5f3fc; padding: 10px; color: #155e75;">
                                ${radiliste.naziv}
                            </td>
                            ${sortimentiCells}
                        </tr>
                    `;
                });
                document.getElementById('otpremaci-radilista-recap-body').innerHTML = recapBodyHTML;

                console.log('Otpremaci by radiliste rendered');

            } catch (error) {
                console.error('Error in loadOtremaciByRadiliste:', error);
                document.getElementById('otpremaci-radilista-body').innerHTML = `
                    <tr><td colspan="100" style="text-align: center; padding: 40px; color: #dc2626;">
                        Gre≈°ka pri uƒçitavanju: ${error.message}
                    </td></tr>
                `;
            }
        }


        // Load kupci data
        async function loadKupci() {
            document.getElementById('loading-screen').classList.remove('hidden');
            document.getElementById('kupci-content').classList.add('hidden');

            try {
                const year = new Date().getFullYear();
                const url = `${API_URL}?path=kupci&year=${year}&username=${currentUser.username}&password=${currentPassword}`;
                const data = await fetchWithCache(url, 'cache_kupci_' + year);

                console.log('Kupci data:', data);

                if (data.error) {
                    throw new Error(data.error);
                }

                // ========================================
                // GODI≈†NJI PREGLED
                // ========================================

                // Create godisnji header with expert styling
                const godisnjiHeaderHTML = `
                    <tr>
                        <th onclick="sortTable(0, 'kupci-godisnji-table')" style="position: sticky; left: 0; background: #7c3aed; z-index: 20; border-right: 3px solid #6d28d9; min-width: 180px; cursor: pointer;">
                            üè¢ Kupac ‚áÖ
                        </th>
                        ${data.sortimentiNazivi.map((s, i) => `<th class="sortiment-col" onclick="sortTable(${i+1}, 'kupci-godisnji-table')" style="min-width: 70px; background: #7c3aed; color: white; font-weight: 700; border: 1px solid #6d28d9; cursor: pointer;">${s} ‚áÖ</th>`).join('')}
                        <th class="ukupno-col" onclick="sortTable(${data.sortimentiNazivi.length + 1}, 'kupci-godisnji-table')" style="min-width: 100px; background: #6d28d9; color: white; font-weight: 900; cursor: pointer;">
                            üìä UKUPNO ‚áÖ
                        </th>
                    </tr>
                `;
                document.getElementById('kupci-godisnji-header').innerHTML = godisnjiHeaderHTML;

                // Create godisnji body with totals
                let godisnjiTotals = { sortimenti: {}, ukupno: 0 };
                data.sortimentiNazivi.forEach(s => godisnjiTotals.sortimenti[s] = 0);

                const godisnjiBodyHTML = data.godisnji.map((k, idx) => {
                    // Add to totals
                    data.sortimentiNazivi.forEach(s => {
                        godisnjiTotals.sortimenti[s] += (k.sortimenti[s] || 0);
                    });
                    godisnjiTotals.ukupno += k.ukupno;

                    const rowBg = idx % 2 === 0 ? '#faf5ff' : 'white';
                    const hoverBg = idx % 2 === 0 ? '#f3e8ff' : '#faf5ff';

                    const sortimentiCells = data.sortimentiNazivi.map(sortiment => {
                        const val = k.sortimenti[sortiment] || 0;
                        const displayVal = val > 0 ? val.toFixed(2) : '-';
                        const fontWeight = val > 0 ? 'font-weight: 500;' : 'color: #9ca3af;';
                        return `<td class="sortiment-col" style="${fontWeight} border: 1px solid #e9d5ff; font-family: 'Courier New', monospace;">${displayVal}</td>`;
                    }).join('');

                    return `
                        <tr style="background: ${rowBg}; transition: all 0.2s;" onmouseover="this.style.background='${hoverBg}'" onmouseout="this.style.background='${rowBg}'">
                            <td style="font-weight: 600; position: sticky; left: 0; background: ${rowBg}; z-index: 10; border-right: 2px solid #7c3aed;">${k.kupac}</td>
                            ${sortimentiCells}
                            <td class="ukupno-col" style="font-weight: 700; background: linear-gradient(to right, #e9d5ff, #d8b4fe); color: #6b21a8; font-family: 'Courier New', monospace;">${k.ukupno.toFixed(2)} m¬≥</td>
                        </tr>
                    `;
                }).join('');

                // Add totals row with soft purple colors
                const godisnjiTotalsCells = data.sortimentiNazivi.map(s => {
                    const val = godisnjiTotals.sortimenti[s];
                    const displayVal = val > 0 ? val.toFixed(2) : '-';
                    return `<td class="sortiment-col" style="border: 1px solid #c084fc; font-family: 'Courier New', monospace;">${displayVal}</td>`;
                }).join('');

                const godisnjiBodyWithTotals = godisnjiBodyHTML + `
                    <tr style="background: linear-gradient(to bottom, #e9d5ff, #d8b4fe); color: #6b21a8; font-weight: 700; border-top: 3px solid #a855f7;">
                        <td style="position: sticky; left: 0; background: #e9d5ff; z-index: 10; border-right: 2px solid #7c3aed;">
                            üìà UKUPNO
                        </td>
                        ${godisnjiTotalsCells}
                        <td class="ukupno-col" style="background: #d8b4fe; border: 2px solid #a855f7; font-weight: 900; font-family: 'Courier New', monospace;">${godisnjiTotals.ukupno.toFixed(2)} m¬≥</td>
                    </tr>
                `;

                document.getElementById('kupci-godisnji-body').innerHTML = godisnjiBodyWithTotals;

                // ========================================
                // MJESEƒåNI PREGLED
                // ========================================

                // Create mjesecni header with expert styling
                const mjesecniHeaderHTML = `
                    <tr>
                        <th onclick="sortTable(0, 'kupci-mjesecni-table')" style="position: sticky; left: 0; background: #7c3aed; z-index: 20; border-right: 3px solid #6d28d9; min-width: 150px; cursor: pointer;">
                            üè¢ Kupac ‚áÖ
                        </th>
                        <th onclick="sortTable(1, 'kupci-mjesecni-table')" style="min-width: 80px; background: #7c3aed; color: white; font-weight: 700; border: 1px solid #6d28d9; cursor: pointer;">
                            üìÖ Mjesec ‚áÖ
                        </th>
                        ${data.sortimentiNazivi.map((s, i) => `<th class="sortiment-col" onclick="sortTable(${i+2}, 'kupci-mjesecni-table')" style="min-width: 70px; background: #7c3aed; color: white; font-weight: 700; border: 1px solid #6d28d9; cursor: pointer;">${s} ‚áÖ</th>`).join('')}
                        <th class="ukupno-col" onclick="sortTable(${data.sortimentiNazivi.length + 2}, 'kupci-mjesecni-table')" style="min-width: 100px; background: #6d28d9; color: white; font-weight: 900; cursor: pointer;">
                            üìä UKUPNO ‚áÖ
                        </th>
                    </tr>
                `;
                document.getElementById('kupci-mjesecni-header').innerHTML = mjesecniHeaderHTML;

                // Create mjesecni body with totals
                let mjesecniTotals = { sortimenti: {}, ukupno: 0 };
                data.sortimentiNazivi.forEach(s => mjesecniTotals.sortimenti[s] = 0);

                const mjesecniBodyHTML = data.mjesecni.map((k, idx) => {
                    // Add to totals
                    data.sortimentiNazivi.forEach(s => {
                        mjesecniTotals.sortimenti[s] += (k.sortimenti[s] || 0);
                    });
                    mjesecniTotals.ukupno += k.ukupno;

                    const rowBg = idx % 2 === 0 ? '#faf5ff' : 'white';
                    const hoverBg = idx % 2 === 0 ? '#f3e8ff' : '#faf5ff';

                    const sortimentiCells = data.sortimentiNazivi.map(sortiment => {
                        const val = k.sortimenti[sortiment] || 0;
                        const displayVal = val > 0 ? val.toFixed(2) : '-';
                        const fontWeight = val > 0 ? 'font-weight: 500;' : 'color: #9ca3af;';
                        return `<td class="sortiment-col" style="${fontWeight} border: 1px solid #e9d5ff; font-family: 'Courier New', monospace;">${displayVal}</td>`;
                    }).join('');

                    return `
                        <tr style="background: ${rowBg}; transition: all 0.2s;" onmouseover="this.style.background='${hoverBg}'" onmouseout="this.style.background='${rowBg}'">
                            <td style="font-weight: 600; position: sticky; left: 0; background: ${rowBg}; z-index: 10; border-right: 2px solid #7c3aed;">${k.kupac}</td>
                            <td style="border: 1px solid #e9d5ff;">${k.mjesec}</td>
                            ${sortimentiCells}
                            <td class="ukupno-col" style="font-weight: 700; background: linear-gradient(to right, #e9d5ff, #d8b4fe); color: #6b21a8; font-family: 'Courier New', monospace;">${k.ukupno.toFixed(2)} m¬≥</td>
                        </tr>
                    `;
                }).join('');

                // Add totals row with soft purple colors
                const mjesecniTotalsCells = data.sortimentiNazivi.map(s => {
                    const val = mjesecniTotals.sortimenti[s];
                    const displayVal = val > 0 ? val.toFixed(2) : '-';
                    return `<td class="sortiment-col" style="border: 1px solid #c084fc; font-family: 'Courier New', monospace;">${displayVal}</td>`;
                }).join('');

                const mjesecniBodyWithTotals = mjesecniBodyHTML + `
                    <tr style="background: linear-gradient(to bottom, #e9d5ff, #d8b4fe); color: #6b21a8; font-weight: 700; border-top: 3px solid #a855f7;">
                        <td style="position: sticky; left: 0; background: #e9d5ff; z-index: 10; border-right: 2px solid #7c3aed;">
                            üìà UKUPNO
                        </td>
                        <td style="background: #e9d5ff;"></td>
                        ${mjesecniTotalsCells}
                        <td class="ukupno-col" style="background: #d8b4fe; border: 2px solid #a855f7; font-weight: 900; font-family: 'Courier New', monospace;">${mjesecniTotals.ukupno.toFixed(2)} m¬≥</td>
                    </tr>
                `;

                document.getElementById('kupci-mjesecni-body').innerHTML = mjesecniBodyWithTotals;

                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('kupci-content').classList.remove('hidden');

            } catch (error) {
                showError('Gre≈°ka', 'Gre≈°ka pri uƒçitavanju kupaca: ' + error.message);
                document.getElementById('loading-screen').innerHTML = '<div class="loading-icon">‚ùå</div><div class="loading-text">Gre≈°ka pri uƒçitavanju</div><div class="loading-sub">' + error.message + '</div>';
            }
        }

        // Load primac personal data
        async function loadPrimacPersonal() {
            document.getElementById('loading-screen').classList.remove('hidden');
            document.getElementById('primac-personal-content').classList.add('hidden');

            try {
                const year = new Date().getFullYear();
                const url = `${API_URL}?path=primac-detail&year=${year}&username=${currentUser.username}&password=${currentPassword}`;
                const data = await fetchWithCache(url, 'cache_primac_detail_' + year);

                console.log('Primac personal data:', data);

                if (data.error) {
                    throw new Error(data.error);
                }

                // Create header
                const headerHTML = `
                    <tr>
                        <th onclick="sortTable(0, 'primac-personal-table')">Datum ‚áÖ</th>
                        <th onclick="sortTable(1, 'primac-personal-table')">Odjel ‚áÖ</th>
                        ${data.sortimentiNazivi.map((s, i) => `<th class="sortiment-col" onclick="sortTable(${i+2}, 'primac-personal-table')">${s} ‚áÖ</th>`).join('')}
                        <th class="ukupno-col" onclick="sortTable(${data.sortimentiNazivi.length + 2}, 'primac-personal-table')">Ukupno ‚áÖ</th>
                    </tr>
                `;
                document.getElementById('primac-personal-header').innerHTML = headerHTML;

                // Create body with totals
                let totals = { sortimenti: {}, ukupno: 0 };
                data.sortimentiNazivi.forEach(s => totals.sortimenti[s] = 0);

                const bodyHTML = data.unosi.map(u => {
                    // Add to totals
                    data.sortimentiNazivi.forEach(s => {
                        totals.sortimenti[s] += (u.sortimenti[s] || 0);
                    });
                    totals.ukupno += u.ukupno;

                    const sortimentiCells = data.sortimentiNazivi.map(sortiment => {
                        const val = u.sortimenti[sortiment] || 0;
                        return `<td class="sortiment-col">${val > 0 ? val.toFixed(2) : '-'}</td>`;
                    }).join('');

                    return `
                        <tr>
                            <td style="font-weight: 500;">${u.datum}</td>
                            <td>${u.odjel}</td>
                            ${sortimentiCells}
                            <td class="ukupno-col">${u.ukupno.toFixed(2)}</td>
                        </tr>
                    `;
                }).join('');

                // Add totals row
                const totalsCells = data.sortimentiNazivi.map(s => {
                    const val = totals.sortimenti[s];
                    return `<td class="sortiment-col">${val > 0 ? val.toFixed(2) : '-'}</td>`;
                }).join('');

                const bodyWithTotals = bodyHTML + `
                    <tr class="totals-row">
                        <td colspan="2" style="text-align: left;">UKUPNO</td>
                        ${totalsCells}
                        <td class="ukupno-col">${totals.ukupno.toFixed(2)}</td>
                    </tr>
                `;

                document.getElementById('primac-personal-body').innerHTML = bodyWithTotals;

                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('primac-personal-content').classList.remove('hidden');

            } catch (error) {
                showError('Gre≈°ka', 'Gre≈°ka pri uƒçitavanju podataka: ' + error.message);
                document.getElementById('loading-screen').innerHTML = '<div class="loading-icon">‚ùå</div><div class="loading-text">Gre≈°ka pri uƒçitavanju</div><div class="loading-sub">' + error.message + '</div>';
            }
        }

        // Load otpremac personal data
        async function loadOtpremacPersonal() {
            document.getElementById('loading-screen').classList.remove('hidden');
            document.getElementById('otpremac-personal-content').classList.add('hidden');

            try {
                const year = new Date().getFullYear();
                const url = `${API_URL}?path=otpremac-detail&year=${year}&username=${currentUser.username}&password=${currentPassword}`;
                const data = await fetchWithCache(url, 'cache_otpremac_detail_' + year);

                console.log('Otpremac personal data:', data);

                if (data.error) {
                    throw new Error(data.error);
                }

                // Create header
                const headerHTML = `
                    <tr>
                        <th onclick="sortTable(0, 'otpremac-personal-table')">Datum ‚áÖ</th>
                        <th onclick="sortTable(1, 'otpremac-personal-table')">Odjel ‚áÖ</th>
                        <th onclick="sortTable(2, 'otpremac-personal-table')">Kupac ‚áÖ</th>
                        ${data.sortimentiNazivi.map((s, i) => `<th class="sortiment-col" onclick="sortTable(${i+3}, 'otpremac-personal-table')">${s} ‚áÖ</th>`).join('')}
                        <th class="ukupno-col" onclick="sortTable(${data.sortimentiNazivi.length + 3}, 'otpremac-personal-table')">Ukupno ‚áÖ</th>
                    </tr>
                `;
                document.getElementById('otpremac-personal-header').innerHTML = headerHTML;

                // Create body with totals
                let totals = { sortimenti: {}, ukupno: 0 };
                data.sortimentiNazivi.forEach(s => totals.sortimenti[s] = 0);

                const bodyHTML = data.unosi.map(u => {
                    // Add to totals
                    data.sortimentiNazivi.forEach(s => {
                        totals.sortimenti[s] += (u.sortimenti[s] || 0);
                    });
                    totals.ukupno += u.ukupno;

                    const sortimentiCells = data.sortimentiNazivi.map(sortiment => {
                        const val = u.sortimenti[sortiment] || 0;
                        return `<td class="sortiment-col">${val > 0 ? val.toFixed(2) : '-'}</td>`;
                    }).join('');

                    return `
                        <tr>
                            <td style="font-weight: 500;">${u.datum}</td>
                            <td>${u.odjel}</td>
                            <td>${u.kupac || '-'}</td>
                            ${sortimentiCells}
                            <td class="ukupno-col">${u.ukupno.toFixed(2)}</td>
                        </tr>
                    `;
                }).join('');

                // Add totals row
                const totalsCells = data.sortimentiNazivi.map(s => {
                    const val = totals.sortimenti[s];
                    return `<td class="sortiment-col">${val > 0 ? val.toFixed(2) : '-'}</td>`;
                }).join('');

                const bodyWithTotals = bodyHTML + `
                    <tr class="totals-row">
                        <td colspan="3" style="text-align: left;">UKUPNO</td>
                        ${totalsCells}
                        <td class="ukupno-col">${totals.ukupno.toFixed(2)}</td>
                    </tr>
                `;

                document.getElementById('otpremac-personal-body').innerHTML = bodyWithTotals;

                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('otpremac-personal-content').classList.remove('hidden');

            } catch (error) {
                showError('Gre≈°ka', 'Gre≈°ka pri uƒçitavanju podataka: ' + error.message);
                document.getElementById('loading-screen').innerHTML = '<div class="loading-icon">‚ùå</div><div class="loading-text">Gre≈°ka pri uƒçitavanju</div><div class="loading-sub">' + error.message + '</div>';
            }
        }

        // ========================================
        // ODJELI VIEW (BY DEPARTMENT) - WITH PAGINATION
        // ========================================

        let primacOdjeliData = null;
        let primacOdjeliCurrentPage = 0;
        const primacOdjeliPageSize = 5;

        let otpremacOdjeliData = null;
        let otpremacOdjeliCurrentPage = 0;
        const otpremacOdjeliPageSize = 5;

        // Load primac odjeli data
        async function loadPrimacOdjeli() {
            document.getElementById('loading-screen').classList.remove('hidden');
            document.getElementById('primac-odjeli-content').classList.add('hidden');

            try {
                const year = new Date().getFullYear();
                const url = `${API_URL}?path=primac-odjeli&year=${year}&username=${currentUser.username}&password=${currentPassword}`;
                const data = await fetchWithCache(url, 'cache_primac_odjeli_' + year);

                console.log('Primac odjeli data:', data);

                if (data.error) {
                    throw new Error(data.error);
                }

                primacOdjeliData = data;
                primacOdjeliCurrentPage = 0;
                renderPrimacOdjeliPage();

                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('primac-odjeli-content').classList.remove('hidden');

            } catch (error) {
                showError('Gre≈°ka', 'Gre≈°ka pri uƒçitavanju podataka: ' + error.message);
                document.getElementById('loading-screen').innerHTML = '<div class="loading-icon">‚ùå</div><div class="loading-text">Gre≈°ka pri uƒçitavanju</div><div class="loading-sub">' + error.message + '</div>';
            }
        }

        function renderPrimacOdjeliPage() {
            if (!primacOdjeliData) return;

            const start = primacOdjeliCurrentPage * primacOdjeliPageSize;
            const end = Math.min(start + primacOdjeliPageSize, primacOdjeliData.odjeli.length);
            const pageOdjeli = primacOdjeliData.odjeli.slice(start, end);

            let html = '';

            pageOdjeli.forEach(odjel => {
                // Kreiraj HTML za odjel sa dve tabele
                html += `
                    <div style="margin-bottom: 40px; border: 2px solid #10b981; border-radius: 12px; padding: 20px; background: #f0fdf4;">
                        <h3 style="color: #047857; margin-bottom: 16px;">üìÅ ${odjel.odjel}</h3>
                        <p style="font-size: 13px; color: #6b7280; margin-bottom: 16px;">Zadnji unos: ${odjel.zadnjiDatum || 'N/A'}</p>

                        <!-- Apsolutne vrijednosti -->
                        <h4 style="font-size: 15px; margin-bottom: 8px; color: #059669;">Apsolutne vrijednosti (m¬≥)</h4>
                        <div class="kupci-table-wrapper" style="margin-bottom: 20px;">
                            <table class="kupci-table">
                                <thead>
                                    <tr>
                                        ${primacOdjeliData.sortimentiNazivi.map(s => `<th class="sortiment-col">${s}</th>`).join('')}
                                        <th class="ukupno-col">Ukupno</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        ${primacOdjeliData.sortimentiNazivi.map(s => {
                                            const val = odjel.sortimenti[s] || 0;
                                            return `<td class="sortiment-col">${val > 0 ? val.toFixed(2) : '-'}</td>`;
                                        }).join('')}
                                        <td class="ukupno-col">${odjel.ukupno.toFixed(2)}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Procentualne vrijednosti -->
                        <h4 style="font-size: 15px; margin-bottom: 8px; color: #059669;">Procentualni udio (%)</h4>
                        <div class="kupci-table-wrapper">
                            <table class="kupci-table">
                                <thead>
                                    <tr>
                                        ${primacOdjeliData.sortimentiNazivi.map(s => `<th class="sortiment-col">${s}</th>`).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        ${primacOdjeliData.sortimentiNazivi.map(s => {
                                            const val = odjel.sortimenti[s] || 0;
                                            const percent = odjel.ukupno > 0 ? (val / odjel.ukupno) * 100 : 0;
                                            return `<td class="sortiment-col">${percent > 0 ? percent.toFixed(1) + '%' : '-'}</td>`;
                                        }).join('')}
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            });

            document.getElementById('primac-odjeli-container').innerHTML = html;

            // Update pagination controls
            const totalPages = Math.ceil(primacOdjeliData.odjeli.length / primacOdjeliPageSize);
            document.getElementById('primac-odjeli-page-info').textContent = `Stranica ${primacOdjeliCurrentPage + 1} od ${totalPages}`;
            document.getElementById('primac-odjeli-prev').disabled = primacOdjeliCurrentPage === 0;
            document.getElementById('primac-odjeli-next').disabled = primacOdjeliCurrentPage >= totalPages - 1;
        }

        function prevPagePrimacOdjeli() {
            if (primacOdjeliCurrentPage > 0) {
                primacOdjeliCurrentPage--;
                renderPrimacOdjeliPage();
            }
        }

        function nextPagePrimacOdjeli() {
            const totalPages = Math.ceil(primacOdjeliData.odjeli.length / primacOdjeliPageSize);
            if (primacOdjeliCurrentPage < totalPages - 1) {
                primacOdjeliCurrentPage++;
                renderPrimacOdjeliPage();
            }
        }

        // Load otpremac odjeli data
        async function loadOtpremacOdjeli() {
            document.getElementById('loading-screen').classList.remove('hidden');
            document.getElementById('otpremac-odjeli-content').classList.add('hidden');

            try {
                const year = new Date().getFullYear();
                const url = `${API_URL}?path=otpremac-odjeli&year=${year}&username=${currentUser.username}&password=${currentPassword}`;
                const data = await fetchWithCache(url, 'cache_otpremac_odjeli_' + year);

                console.log('Otpremac odjeli data:', data);

                if (data.error) {
                    throw new Error(data.error);
                }

                otpremacOdjeliData = data;
                otpremacOdjeliCurrentPage = 0;
                renderOtpremacOdjeliPage();

                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('otpremac-odjeli-content').classList.remove('hidden');

            } catch (error) {
                showError('Gre≈°ka', 'Gre≈°ka pri uƒçitavanju podataka: ' + error.message);
                document.getElementById('loading-screen').innerHTML = '<div class="loading-icon">‚ùå</div><div class="loading-text">Gre≈°ka pri uƒçitavanju</div><div class="loading-sub">' + error.message + '</div>';
            }
        }

        function renderOtpremacOdjeliPage() {
            if (!otpremacOdjeliData) return;

            const start = otpremacOdjeliCurrentPage * otpremacOdjeliPageSize;
            const end = Math.min(start + otpremacOdjeliPageSize, otpremacOdjeliData.odjeli.length);
            const pageOdjeli = otpremacOdjeliData.odjeli.slice(start, end);

            let html = '';

            pageOdjeli.forEach(odjel => {
                // Kreiraj HTML za odjel sa dve tabele
                html += `
                    <div style="margin-bottom: 40px; border: 2px solid #2563eb; border-radius: 12px; padding: 20px; background: #eff6ff;">
                        <h3 style="color: #1e40af; margin-bottom: 16px;">üìÅ ${odjel.odjel}</h3>
                        <p style="font-size: 13px; color: #6b7280; margin-bottom: 16px;">Zadnji unos: ${odjel.zadnjiDatum || 'N/A'}</p>

                        <!-- Apsolutne vrijednosti -->
                        <h4 style="font-size: 15px; margin-bottom: 8px; color: #2563eb;">Apsolutne vrijednosti (m¬≥)</h4>
                        <div class="kupci-table-wrapper" style="margin-bottom: 20px;">
                            <table class="kupci-table">
                                <thead>
                                    <tr>
                                        ${otpremacOdjeliData.sortimentiNazivi.map(s => `<th class="sortiment-col">${s}</th>`).join('')}
                                        <th class="ukupno-col">Ukupno</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        ${otpremacOdjeliData.sortimentiNazivi.map(s => {
                                            const val = odjel.sortimenti[s] || 0;
                                            return `<td class="sortiment-col">${val > 0 ? val.toFixed(2) : '-'}</td>`;
                                        }).join('')}
                                        <td class="ukupno-col">${odjel.ukupno.toFixed(2)}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Procentualne vrijednosti -->
                        <h4 style="font-size: 15px; margin-bottom: 8px; color: #2563eb;">Procentualni udio (%)</h4>
                        <div class="kupci-table-wrapper">
                            <table class="kupci-table">
                                <thead>
                                    <tr>
                                        ${otpremacOdjeliData.sortimentiNazivi.map(s => `<th class="sortiment-col">${s}</th>`).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        ${otpremacOdjeliData.sortimentiNazivi.map(s => {
                                            const val = odjel.sortimenti[s] || 0;
                                            const percent = odjel.ukupno > 0 ? (val / odjel.ukupno) * 100 : 0;
                                            return `<td class="sortiment-col">${percent > 0 ? percent.toFixed(1) + '%' : '-'}</td>`;
                                        }).join('')}
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            });

            document.getElementById('otpremac-odjeli-container').innerHTML = html;

            // Update pagination controls
            const totalPages = Math.ceil(otpremacOdjeliData.odjeli.length / otpremacOdjeliPageSize);
            document.getElementById('otpremac-odjeli-page-info').textContent = `Stranica ${otpremacOdjeliCurrentPage + 1} od ${totalPages}`;
            document.getElementById('otpremac-odjeli-prev').disabled = otpremacOdjeliCurrentPage === 0;
            document.getElementById('otpremac-odjeli-next').disabled = otpremacOdjeliCurrentPage >= totalPages - 1;
        }

        function prevPageOtpremacOdjeli() {
            if (otpremacOdjeliCurrentPage > 0) {
                otpremacOdjeliCurrentPage--;
                renderOtpremacOdjeliPage();
            }
        }

        function nextPageOtpremacOdjeli() {
            const totalPages = Math.ceil(otpremacOdjeliData.odjeli.length / otpremacOdjeliPageSize);
            if (otpremacOdjeliCurrentPage < totalPages - 1) {
                otpremacOdjeliCurrentPage++;
                renderOtpremacOdjeliPage();
            }
        }

        // ========================================
        // UTILITY FUNCTIONS
        // ========================================

        // Dark mode toggle
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('dark-mode', isDark ? 'enabled' : 'disabled');
        }

        // Load dark mode preference
        window.addEventListener('DOMContentLoaded', () => {
            const darkMode = localStorage.getItem('dark-mode');
            if (darkMode === 'enabled') {
                document.body.classList.add('dark-mode');
            }
        });

        // Filter dashboard table
        function filterDashboardTable() {
            const input = document.getElementById('dashboard-search');
            const filter = input.value.toUpperCase();
            const table = document.getElementById('dashboard-table');
            const tr = table.getElementsByTagName('tr');

            for (let i = 1; i < tr.length; i++) {
                const td = tr[i].getElementsByTagName('td')[0];
                if (td) {
                    const txtValue = td.textContent || td.innerText;
                    tr[i].style.display = txtValue.toUpperCase().indexOf(filter) > -1 ? '' : 'none';
                }
            }
        }

        // Filter odjeli table
        function filterOdjeliTable() {
            const input = document.getElementById('odjeli-search');
            const filter = input.value.toUpperCase();
            const table = document.getElementById('odjeli-table');
            const tr = table.getElementsByTagName('tr');

            for (let i = 1; i < tr.length; i++) {
                const td = tr[i].getElementsByTagName('td')[0];
                if (td) {
                    const txtValue = td.textContent || td.innerText;
                    tr[i].style.display = txtValue.toUpperCase().indexOf(filter) > -1 ? '' : 'none';
                }
            }
        }

        // Filter primaci table
        function filterPrimaciTable() {
            const input = document.getElementById('primaci-search');
            const filter = input.value.toUpperCase();
            const table = document.getElementById('primaci-table');
            const tr = table.getElementsByTagName('tr');

            for (let i = 1; i < tr.length; i++) {
                const td = tr[i].getElementsByTagName('td')[0];
                if (td) {
                    const txtValue = td.textContent || td.innerText;
                    tr[i].style.display = txtValue.toUpperCase().indexOf(filter) > -1 ? '' : 'none';
                }
            }
        }

        // Filter otpremaci table
        function filterOtremaciTable() {
            const input = document.getElementById('otpremaci-search');
            const filter = input.value.toUpperCase();
            const table = document.getElementById('otpremaci-table');
            const tr = table.getElementsByTagName('tr');

            for (let i = 1; i < tr.length; i++) {
                const td = tr[i].getElementsByTagName('td')[0];
                if (td) {
                    const txtValue = td.textContent || td.innerText;
                    tr[i].style.display = txtValue.toUpperCase().indexOf(filter) > -1 ? '' : 'none';
                }
            }
        }

        // Filter primaci daily table
        function filterPrimaciDailyTable() {
            const input = document.getElementById('primaci-daily-search');
            const filter = input.value.toUpperCase();
            const table = document.getElementById('primaci-daily-table');
            const tbody = table.getElementsByTagName('tbody')[0];
            if (!tbody) return;
            const tr = tbody.getElementsByTagName('tr');

            for (let i = 0; i < tr.length - 1; i++) { // -1 to exclude UKUPNO row
                const tds = tr[i].getElementsByTagName('td');
                let found = false;
                // Search in datum, odjel, and primac columns
                for (let j = 0; j < 3 && j < tds.length; j++) {
                    const txtValue = tds[j].textContent || tds[j].innerText;
                    if (txtValue.toUpperCase().indexOf(filter) > -1) {
                        found = true;
                        break;
                    }
                }
                tr[i].style.display = found ? '' : 'none';
            }
        }

        // Filter otpremaci daily table
        function filterOtremaciDailyTable() {
            const input = document.getElementById('otpremaci-daily-search');
            const filter = input.value.toUpperCase();
            const table = document.getElementById('otpremaci-daily-table');
            const tbody = table.getElementsByTagName('tbody')[0];
            if (!tbody) return;
            const tr = tbody.getElementsByTagName('tr');

            for (let i = 0; i < tr.length - 1; i++) { // -1 to exclude UKUPNO row
                const tds = tr[i].getElementsByTagName('td');
                let found = false;
                // Search in datum, odjel, otpremac, and kupac columns
                for (let j = 0; j < 4 && j < tds.length; j++) {
                    const txtValue = tds[j].textContent || tds[j].innerText;
                    if (txtValue.toUpperCase().indexOf(filter) > -1) {
                        found = true;
                        break;
                    }
                }
                tr[i].style.display = found ? '' : 'none';
            }
        }

        // Filter kupci godisnji table
        function filterKupciGodisnjiTable() {
            const input = document.getElementById('kupci-godisnji-search');
            const filter = input.value.toUpperCase();
            const table = document.getElementById('kupci-godisnji-table');
            const tr = table.getElementsByTagName('tr');

            for (let i = 1; i < tr.length; i++) {
                const td = tr[i].getElementsByTagName('td')[0];
                if (td) {
                    const txtValue = td.textContent || td.innerText;
                    tr[i].style.display = txtValue.toUpperCase().indexOf(filter) > -1 ? '' : 'none';
                }
            }
        }

        // Filter kupci mjesecni table
        function filterKupciMjesecniTable() {
            const input = document.getElementById('kupci-mjesecni-search');
            const filter = input.value.toUpperCase();
            const table = document.getElementById('kupci-mjesecni-table');
            const tr = table.getElementsByTagName('tr');

            for (let i = 1; i < tr.length; i++) {
                const td = tr[i].getElementsByTagName('td')[0];
                if (td) {
                    const txtValue = td.textContent || td.innerText;
                    tr[i].style.display = txtValue.toUpperCase().indexOf(filter) > -1 ? '' : 'none';
                }
            }
        }

        // Filter primac personal table
        function filterPrimacPersonalTable() {
            const input = document.getElementById('primac-personal-search');
            const filter = input.value.toUpperCase();
            const table = document.getElementById('primac-personal-table');
            const tr = table.getElementsByTagName('tr');

            for (let i = 1; i < tr.length; i++) {
                // Search in both datum and odjel columns (0 and 1)
                const td0 = tr[i].getElementsByTagName('td')[0];
                const td1 = tr[i].getElementsByTagName('td')[1];
                if (td0 || td1) {
                    const txtValue = (td0 ? (td0.textContent || td0.innerText) : '') + ' ' +
                                     (td1 ? (td1.textContent || td1.innerText) : '');
                    tr[i].style.display = txtValue.toUpperCase().indexOf(filter) > -1 ? '' : 'none';
                }
            }
        }

        // Filter otpremac personal table
        function filterOtpremacPersonalTable() {
            const input = document.getElementById('otpremac-personal-search');
            const filter = input.value.toUpperCase();
            const table = document.getElementById('otpremac-personal-table');
            const tr = table.getElementsByTagName('tr');

            for (let i = 1; i < tr.length; i++) {
                // Search in datum, odjel, and kupac columns (0, 1, and 2)
                const td0 = tr[i].getElementsByTagName('td')[0];
                const td1 = tr[i].getElementsByTagName('td')[1];
                const td2 = tr[i].getElementsByTagName('td')[2];
                if (td0 || td1 || td2) {
                    const txtValue = (td0 ? (td0.textContent || td0.innerText) : '') + ' ' +
                                     (td1 ? (td1.textContent || td1.innerText) : '') + ' ' +
                                     (td2 ? (td2.textContent || td2.innerText) : '');
                    tr[i].style.display = txtValue.toUpperCase().indexOf(filter) > -1 ? '' : 'none';
                }
            }
        }

        // Export table to CSV
        function exportTableToCSV(tableType) {
            let table, filename;

            if (tableType === 'dashboard') {
                table = document.getElementById('dashboard-table');
                filename = 'dashboard_pregled.csv';
            } else if (tableType === 'odjeli') {
                table = document.getElementById('odjeli-table');
                filename = 'odjeli_pregled.csv';
            } else if (tableType === 'primaci') {
                table = document.getElementById('primaci-table');
                filename = 'primaci_pregled.csv';
            } else if (tableType === 'otpremaci') {
                table = document.getElementById('otpremaci-table');
                filename = 'otpremaci_pregled.csv';
            } else if (tableType === 'kupci-godisnji') {
                table = document.getElementById('kupci-godisnji-table');
                filename = 'kupci_godisnji_pregled.csv';
            } else if (tableType === 'kupci-mjesecni') {
                table = document.getElementById('kupci-mjesecni-table');
                filename = 'kupci_mjesecni_pregled.csv';
            } else if (tableType === 'primac-personal') {
                table = document.getElementById('primac-personal-table');
                filename = 'moja_sjeca_' + new Date().getFullYear() + '.csv';
            } else if (tableType === 'otpremac-personal') {
                table = document.getElementById('otpremac-personal-table');
                filename = 'moja_otprema_' + new Date().getFullYear() + '.csv';
            }

            const rows = table.querySelectorAll('tr');
            const csv = [];

            for (let i = 0; i < rows.length; i++) {
                const row = [], cols = rows[i].querySelectorAll('td, th');

                for (let j = 0; j < cols.length; j++) {
                    let data = cols[j].innerText.replace(/(\r\n|\n|\r)/gm, '').replace(/"/g, '""');
                    row.push('"' + data + '"');
                }

                csv.push(row.join(','));
            }

            const csvString = csv.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Sort table
        function sortTable(columnIndex, tableId) {
            const table = document.getElementById(tableId);
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));

            const sortedRows = rows.sort((a, b) => {
                const aValue = a.querySelectorAll('td')[columnIndex].innerText;
                const bValue = b.querySelectorAll('td')[columnIndex].innerText;

                // Try to parse as number
                const aNum = parseFloat(aValue.replace(/[^\d.-]/g, ''));
                const bNum = parseFloat(bValue.replace(/[^\d.-]/g, ''));

                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return aNum - bNum;
                } else {
                    return aValue.localeCompare(bValue, 'bs');
                }
            });

            // Toggle sort direction
            if (table.dataset.lastSort === columnIndex.toString()) {
                sortedRows.reverse();
                table.dataset.lastSort = '';
            } else {
                table.dataset.lastSort = columnIndex.toString();
            }

            // Re-append sorted rows
            sortedRows.forEach(row => tbody.appendChild(row));
        }

        // ========== DODANI UNOSI VIEW ==========

        // Load Dodani Unosi (Pending entries)
        // Helper to determine column group
        function getColumnGroup(sortiment) {
            const cetinariCols = ['F/L ƒå', 'I ƒå', 'II ƒå', 'III ƒå', 'RUDNO', 'CEL.DUGA', 'CEL.CIJEPANA', 'TRUPCI ƒå', 'ƒåETINARI'];
            const liscariCols = ['F/L L', 'I L', 'II L', 'III L', 'OGR.DUGI', 'OGR.CIJEPANI', 'TRUPCI L', 'LI≈†ƒÜARI'];

            if (cetinariCols.includes(sortiment)) return 'col-group-cetinari';
            if (liscariCols.includes(sortiment)) return 'col-group-liscari';
            return '';
        }

        // Render pending table with filters
        function renderPendingTable(data) {
            let html = '';

            if (!data || data.length === 0) {
                html = '<p style="text-align: center; padding: 40px; color: #6b7280;">Nema dodanih unosa</p>';
            } else {
                // Get sortimenti names from first item
                const sortimentiNazivi = data[0] && data[0].sortimenti ? Object.keys(data[0].sortimenti) : [];

                html = '<div class="kupci-table-wrapper"><table class="kupci-table"><thead><tr>';
                html += '<th style="min-width: 80px;">Tip</th>';
                html += '<th style="min-width: 100px;">Datum</th>';
                html += '<th style="min-width: 80px;">Odjel</th>';
                html += '<th style="min-width: 150px;">Radnik</th>';
                html += '<th style="min-width: 120px;">Kupac</th>';
                html += '<th style="min-width: 120px;">Br. otpremnice</th>';

                // Sortimenti headers with grouping
                for (let i = 0; i < sortimentiNazivi.length; i++) {
                    const colClass = getColumnGroup(sortimentiNazivi[i]);
                    html += '<th class="sortiment-col ' + colClass + '">' + sortimentiNazivi[i] + '</th>';
                }

                html += '<th style="min-width: 130px;">Poslano</th>';
                html += '<th style="min-width: 80px;"></th>'; // Actions column
                html += '</tr></thead><tbody>';

                // Render rows
                for (let i = 0; i < data.length; i++) {
                    const unos = data[i];
                    const tipColor = unos.tip === 'SJEƒåA' ? '#059669' : '#2563eb';

                    html += '<tr>';
                    html += '<td><span style="font-weight: 600; color: ' + tipColor + '">' + unos.tip + '</span></td>';
                    html += '<td>' + unos.datum + '</td>';
                    html += '<td style="font-weight: 600;">' + unos.odjel + '</td>';
                    html += '<td>' + unos.radnik + '</td>';
                    html += '<td>' + (unos.kupac || '-') + '</td>';
                    html += '<td>' + (unos.brojOtpremnice || '-') + '</td>';

                    // Sortimenti values with grouping
                    for (let j = 0; j < sortimentiNazivi.length; j++) {
                        const sortiment = sortimentiNazivi[j];
                        // Use calculated ukupno for SVEUKUPNO instead of saved value
                        const val = sortiment === 'SVEUKUPNO' ? unos.ukupno : (unos.sortimenti[sortiment] || 0);
                        const displayVal = val > 0 ? val.toFixed(2) : '-';
                        const colClass = getColumnGroup(sortiment);
                        html += '<td class="sortiment-col right ' + colClass + '">' + displayVal + '</td>';
                    }

                    html += '<td style="font-size: 11px; color: #6b7280;">' + unos.timestamp + '</td>';

                    // Row actions dropdown
                    html += '<td>';
                    html += '<div class="row-actions">';
                    html += '<button class="row-actions-btn" onclick="toggleRowActions(' + unos.id + ')">‚ãÆ</button>';
                    html += '<div class="row-actions-dropdown" id="row-actions-' + unos.id + '">';
                    html += '<div class="row-actions-item" onclick="editPendingUnos(' + unos.id + ', \'' + unos.tip + '\')">‚úèÔ∏è Uredi</div>';
                    html += '<div class="row-actions-item danger" onclick="deletePendingUnos(' + unos.id + ', \'' + unos.tip + '\')">üóëÔ∏è Obri≈°i</div>';
                    html += '</div>';
                    html += '</div>';
                    html += '</td>';

                    html += '</tr>';
                }

                html += '</tbody></table></div>';

                // Add summary
                html += '<div style="margin-top: 20px; padding: 12px; background: #f9fafb; border-radius: 8px;">';
                html += '<strong>Ukupno dodanih unosa:</strong> ' + data.length;

                let sjecaCount = 0;
                let otpremaCount = 0;
                for (let i = 0; i < data.length; i++) {
                    if (data[i].tip === 'SJEƒåA') sjecaCount++;
                    else if (data[i].tip === 'OTPREMA') otpremaCount++;
                }

                html += ' (Sjeƒça: ' + sjecaCount + ', Otprema: ' + otpremaCount + ')';
                html += '</div>';
            }

            document.getElementById('pending-unosi-container').innerHTML = html;
        }

        async function loadPendingUnosi() {
            document.getElementById('loading-screen').classList.remove('hidden');
            document.getElementById('pending-unosi-content').classList.add('hidden');

            try {
                const year = new Date().getFullYear();
                const url = API_URL + '?path=pending-unosi&year=' + year + '&username=' + currentUser.username + '&password=' + currentPassword;

                // Don't cache pending entries - always fetch fresh
                const response = await fetch(url);
                const data = await response.json();

                console.log('Dodani unosi data:', data);

                if (data.error) {
                    throw new Error(data.error);
                }

                // Store unfiltered data for filtering
                unfilteredPendingData = data.unosi || [];

                // Update badge count
                updatePendingBadge(unfilteredPendingData.length);

                // Render table
                renderPendingTable(unfilteredPendingData);

                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('pending-unosi-content').classList.remove('hidden');

            } catch (error) {
                console.error('Error loading dodani unosi:', error);
                document.getElementById('pending-unosi-container').innerHTML =
                    '<p style="color: #dc2626; text-align: center; padding: 40px;">Gre≈°ka: ' + error.message + '</p>';
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('pending-unosi-content').classList.remove('hidden');
            }
        }

        // Load monthly sortimenti
        async function loadMjesecniSortimenti() {
            document.getElementById('loading-screen').classList.remove('hidden');
            document.getElementById('mjesecni-sortimenti-content').classList.add('hidden');

            try {
                const year = new Date().getFullYear();
                const url = API_URL + '?path=mjesecni-sortimenti&year=' + year + '&username=' + currentUser.username + '&password=' + currentPassword;

                console.log('Fetching mjeseƒçni sortimenti for year:', year);
                const data = await fetchWithCache(url, `cache_mjesecni_sortimenti_${year}`);

                console.log('Mjeseƒçni sortimenti response:', data);

                if (data.error) {
                    throw new Error(data.error);
                }

                if (!data.sjeca || !data.otprema) {
                    throw new Error('Invalid data format received from server');
                }

                console.log('Rendering SJEƒåA table...');
                // Render SJEƒåA table
                renderMjesecnaTabela(data.sjeca, 'mjesecna-sjeca');

                console.log('Rendering OTPREMA table...');
                // Render OTPREMA table
                renderMjesecnaTabela(data.otprema, 'mjesecna-otprema');

                console.log('Tables rendered successfully');
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('mjesecni-sortimenti-content').classList.remove('hidden');

            } catch (error) {
                console.error('Error loading mjeseƒçni sortimenti:', error);
                showError('Gre≈°ka', 'Gre≈°ka pri uƒçitavanju mjeseƒçnih podataka: ' + error.message);
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('mjesecni-sortimenti-content').classList.remove('hidden');
            }
        }

        // Render monthly table (SJEƒåA or OTPREMA)
        function renderMjesecnaTabela(data, tableId) {
            console.log('renderMjesecnaTabela called with tableId:', tableId, 'data:', data);

            const headerElem = document.getElementById(tableId + '-header');
            const bodyElem = document.getElementById(tableId + '-body');

            if (!headerElem || !bodyElem) {
                console.error('Table elements not found for tableId:', tableId);
                return;
            }

            if (!data || !data.sortimenti || data.sortimenti.length === 0) {
                console.log('No data available for table:', tableId);
                headerElem.innerHTML = '';
                bodyElem.innerHTML = '<tr><td colspan="100%" style="text-align: center; padding: 40px; color: #6b7280;">Nema podataka</td></tr>';
                return;
            }

            if (!data.mjeseci || !Array.isArray(data.mjeseci) || data.mjeseci.length !== 12) {
                console.error('Invalid mjeseci data for table:', tableId, data.mjeseci);
                headerElem.innerHTML = '';
                bodyElem.innerHTML = '<tr><td colspan="100%" style="text-align: center; padding: 40px; color: #dc2626;">Gre≈°ka u formatu podataka</td></tr>';
                return;
            }

            const sortimenti = data.sortimenti; // Array of sortiment names
            const mjeseci = ['Jan', 'Feb', 'Mar', 'Apr', 'Maj', 'Jun', 'Jul', 'Avg', 'Sep', 'Okt', 'Nov', 'Dec'];

            console.log('Rendering table with', sortimenti.length, 'sortimenti and', data.mjeseci.length, 'months');

            // Build header
            let headerHtml = '<tr><th style="min-width: 100px; position: sticky; left: 0; background: #1e40af; z-index: 20;">Mjesec</th>';
            for (let i = 0; i < sortimenti.length; i++) {
                const colClass = getColumnGroup(sortimenti[i]);
                let extraClass = '';
                if (sortimenti[i] === 'ƒåETINARI') extraClass = ' col-cetinari';
                else if (sortimenti[i] === 'LI≈†ƒÜARI') extraClass = ' col-liscari';
                else if (sortimenti[i] === 'SVEUKUPNO') extraClass = ' col-sveukupno';

                headerHtml += '<th class="sortiment-col ' + colClass + extraClass + '">' + sortimenti[i] + '</th>';
            }
            headerHtml += '</tr>';
            headerElem.innerHTML = headerHtml;

            // Build body - 12 months + UKUPNO + %UDIO
            let bodyHtml = '';
            const totals = {}; // Total per sortiment

            // Month rows
            for (let m = 0; m < 12; m++) {
                const rowStyle = m % 2 === 0 ? 'background: #f9fafb;' : '';
                bodyHtml += '<tr style="' + rowStyle + '">';
                bodyHtml += '<td style="font-weight: 600; position: sticky; left: 0; background: ' + (m % 2 === 0 ? '#f9fafb' : 'white') + '; z-index: 9; border-right: 2px solid #1e40af;">' + mjeseci[m] + '</td>';

                for (let s = 0; s < sortimenti.length; s++) {
                    const sortiment = sortimenti[s];
                    const value = data.mjeseci[m][sortiment] || 0;
                    const displayVal = value > 0 ? value.toFixed(2) : '-';
                    const colClass = getColumnGroup(sortiment);
                    let extraClass = '';
                    if (sortiment === 'ƒåETINARI') extraClass = ' col-cetinari';
                    else if (sortiment === 'LI≈†ƒÜARI') extraClass = ' col-liscari';
                    else if (sortiment === 'SVEUKUPNO') extraClass = ' col-sveukupno';

                    bodyHtml += '<td class="sortiment-col right ' + colClass + extraClass + '">' + displayVal + '</td>';

                    // Add to totals
                    if (!totals[sortiment]) totals[sortiment] = 0;
                    totals[sortiment] += value;
                }

                bodyHtml += '</tr>';
            }

            // UKUPNO row
            bodyHtml += '<tr style="background: #e5e7eb; font-weight: 700; border-top: 3px solid #374151; border-bottom: 2px solid #374151;">';
            bodyHtml += '<td style="position: sticky; left: 0; background: #e5e7eb; z-index: 9; border-right: 2px solid #1e40af;">UKUPNO</td>';
            for (let s = 0; s < sortimenti.length; s++) {
                const sortiment = sortimenti[s];
                const total = totals[sortiment] || 0;
                const colClass = getColumnGroup(sortiment);
                let extraClass = '';
                if (sortiment === 'ƒåETINARI') extraClass = ' col-cetinari';
                else if (sortiment === 'LI≈†ƒÜARI') extraClass = ' col-liscari';
                else if (sortiment === 'SVEUKUPNO') extraClass = ' col-sveukupno';

                bodyHtml += '<td class="sortiment-col right ' + colClass + extraClass + '">' + total.toFixed(2) + '</td>';
            }
            bodyHtml += '</tr>';

            // Calculate grand total from SVEUKUPNO
            const grandTotal = totals['SVEUKUPNO'] || 0;

            // %UDIO row
            bodyHtml += '<tr style="background: #f3f4f6; font-style: italic; color: #374151; border-bottom: 3px solid #374151;">';
            bodyHtml += '<td style="position: sticky; left: 0; background: #f3f4f6; z-index: 9; border-right: 2px solid #1e40af;">% UDIO</td>';
            for (let s = 0; s < sortimenti.length; s++) {
                const sortiment = sortimenti[s];
                const total = totals[sortiment] || 0;
                const percentage = grandTotal > 0 ? ((total / grandTotal) * 100).toFixed(1) : '0.0';
                const colClass = getColumnGroup(sortiment);
                let extraClass = '';
                if (sortiment === 'ƒåETINARI') extraClass = ' col-cetinari';
                else if (sortiment === 'LI≈†ƒÜARI') extraClass = ' col-liscari';
                else if (sortiment === 'SVEUKUPNO') extraClass = ' col-sveukupno';

                bodyHtml += '<td class="sortiment-col right ' + colClass + extraClass + '">' + percentage + '%</td>';
            }
            bodyHtml += '</tr>';

            bodyElem.innerHTML = bodyHtml;
        }

        // ========================================
        // IZVJE≈†TAJI - Mjeseƒçni prikaz po odjelima sa sortimentima
        // ========================================

        async function loadIzvjestaji() {
            document.getElementById('loading-screen').classList.remove('hidden');
            document.getElementById('izvjestaji-content').classList.add('hidden');

            try {
                const year = document.getElementById('izvjestaji-year-select').value;
                const month = document.getElementById('izvjestaji-month-select').value;

                const mjeseciNazivi = ['Januar', 'Februar', 'Mart', 'April', 'Maj', 'Juni', 'Juli', 'August', 'Septembar', 'Oktobar', 'Novembar', 'Decembar'];

                // Update titles
                document.getElementById('izvjestaji-primka-title').textContent = mjeseciNazivi[month] + ' ' + year;
                document.getElementById('izvjestaji-otprema-title').textContent = mjeseciNazivi[month] + ' ' + year;

                // Load PRIMKA (sjeƒça) data
                const primkaUrl = API_URL + '?path=primaci-daily&year=' + year + '&month=' + month + '&username=' + currentUser.username + '&password=' + currentPassword;
                const primkaData = await fetchWithCache(primkaUrl, `cache_izvjestaji_primka_${year}_${month}`);

                // Load OTPREMA data
                const otpremaUrl = API_URL + '?path=otpremaci-daily&year=' + year + '&month=' + month + '&username=' + currentUser.username + '&password=' + currentPassword;
                const otpremaData = await fetchWithCache(otpremaUrl, `cache_izvjestaji_otprema_${year}_${month}`);

                if (primkaData.error) throw new Error('Primka: ' + primkaData.error);
                if (otpremaData.error) throw new Error('Otprema: ' + otpremaData.error);

                // Aggregate data by odjel
                const primkaByOdjel = aggregateByOdjel(primkaData.data, primkaData.sortimentiNazivi);
                const otpremaByOdjel = aggregateByOdjel(otpremaData.data, otpremaData.sortimentiNazivi);

                // Render tables
                renderIzvjestajiTable(primkaByOdjel, primkaData.sortimentiNazivi, 'primka');
                renderIzvjestajiTable(otpremaByOdjel, otpremaData.sortimentiNazivi, 'otprema');

                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('izvjestaji-content').classList.remove('hidden');

            } catch (error) {
                console.error('Error loading izvjestaji:', error);
                showError('Gre≈°ka', 'Gre≈°ka pri uƒçitavanju izvje≈°taja: ' + error.message);
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('izvjestaji-content').classList.remove('hidden');
            }
        }

        // Aggregate data by odjel (sum sortimenti per odjel)
        function aggregateByOdjel(data, sortimentiNazivi) {
            const odjeliMap = {};

            data.forEach(row => {
                const odjel = row.odjel;
                if (!odjeliMap[odjel]) {
                    odjeliMap[odjel] = {};
                    sortimentiNazivi.forEach(s => odjeliMap[odjel][s] = 0);
                }

                sortimentiNazivi.forEach(sortiment => {
                    const value = parseFloat(row.sortimenti[sortiment]) || 0;
                    odjeliMap[odjel][sortiment] += value;
                });
            });

            // Convert to array
            const result = [];
            for (const odjel in odjeliMap) {
                result.push({
                    odjel: odjel,
                    sortimenti: odjeliMap[odjel]
                });
            }

            // Sort by odjel name
            result.sort((a, b) => a.odjel.localeCompare(b.odjel));

            return result;
        }

        // Render izvjestaji table (primka or otprema)
        function renderIzvjestajiTable(data, sortimentiNazivi, tip) {
            const headerElem = document.getElementById('izvjestaji-' + tip + '-header');
            const bodyElem = document.getElementById('izvjestaji-' + tip + '-body');

            if (data.length === 0) {
                headerElem.innerHTML = '';
                bodyElem.innerHTML = '<tr><td colspan="100%" style="text-align: center; padding: 40px; color: #6b7280;">Nema podataka za odabrani mjesec</td></tr>';
                return;
            }

            // Build header
            let headerHtml = '<tr><th style="position: sticky; left: 0; background: #f9fafb; z-index: 20; min-width: 200px;">Odjel</th>';
            sortimentiNazivi.forEach(sortiment => {
                const colClass = getColumnGroup(sortiment);
                let extraClass = '';
                if (sortiment === 'ƒåETINARI') extraClass = ' col-cetinari';
                else if (sortiment === 'LI≈†ƒÜARI') extraClass = ' col-liscari';
                else if (sortiment === 'SVEUKUPNO') extraClass = ' col-sveukupno';

                headerHtml += '<th class="sortiment-col right ' + colClass + extraClass + '">' + sortiment + '</th>';
            });
            headerHtml += '</tr>';
            headerElem.innerHTML = headerHtml;

            // Build body
            let bodyHtml = '';
            const totals = {};
            sortimentiNazivi.forEach(s => totals[s] = 0);

            data.forEach((row, index) => {
                const rowStyle = index % 2 === 0 ? 'background: #f9fafb;' : '';
                bodyHtml += '<tr style="' + rowStyle + '">';
                bodyHtml += '<td style="font-weight: 600; position: sticky; left: 0; background: ' + (index % 2 === 0 ? '#f9fafb' : 'white') + '; z-index: 9;">' + row.odjel + '</td>';

                sortimentiNazivi.forEach(sortiment => {
                    const value = row.sortimenti[sortiment] || 0;
                    totals[sortiment] += value;

                    const colClass = getColumnGroup(sortiment);
                    let extraClass = '';
                    if (sortiment === 'ƒåETINARI') extraClass = ' col-cetinari';
                    else if (sortiment === 'LI≈†ƒÜARI') extraClass = ' col-liscari';
                    else if (sortiment === 'SVEUKUPNO') extraClass = ' col-sveukupno';

                    const displayValue = value === 0 ? '' : value.toFixed(2);
                    bodyHtml += '<td class="sortiment-col right ' + colClass + extraClass + '">' + displayValue + '</td>';
                });

                bodyHtml += '</tr>';
            });

            // Add UKUPNO row
            bodyHtml += '<tr style="background: #f9fafb; border-top: 3px solid #1f2937; font-weight: 700;">';
            bodyHtml += '<td style="position: sticky; left: 0; background: #f9fafb; z-index: 9; font-size: 15px; padding: 14px;">üìä UKUPNO</td>';

            sortimentiNazivi.forEach(sortiment => {
                const colClass = getColumnGroup(sortiment);
                let extraClass = '';
                if (sortiment === 'ƒåETINARI') extraClass = ' col-cetinari';
                else if (sortiment === 'LI≈†ƒÜARI') extraClass = ' col-liscari';
                else if (sortiment === 'SVEUKUPNO') extraClass = ' col-sveukupno';

                bodyHtml += '<td class="sortiment-col right ' + colClass + extraClass + '" style="font-weight: 700;">' + totals[sortiment].toFixed(2) + '</td>';
            });

            bodyHtml += '</tr>';

            bodyElem.innerHTML = bodyHtml;
        }

        // Filter funkcija za Primka tabelu
        function filterIzvjestajiPrimkaTable() {
            const input = document.getElementById('izvjestaji-primka-search');
            const filter = input.value.toLowerCase();
            const table = document.getElementById('izvjestaji-primka-table');
            const tr = table.getElementsByTagName('tr');

            for (let i = 1; i < tr.length - 1; i++) { // Skip header (0) and total row (last)
                const td = tr[i].getElementsByTagName('td')[0]; // First column (Odjel)
                if (td) {
                    const txtValue = td.textContent || td.innerText;
                    if (txtValue.toLowerCase().indexOf(filter) > -1) {
                        tr[i].style.display = '';
                    } else {
                        tr[i].style.display = 'none';
                    }
                }
            }
        }

        // Filter funkcija za Otprema tabelu
        function filterIzvjestajiOtpremaTable() {
            const input = document.getElementById('izvjestaji-otprema-search');
            const filter = input.value.toLowerCase();
            const table = document.getElementById('izvjestaji-otprema-table');
            const tr = table.getElementsByTagName('tr');

            for (let i = 1; i < tr.length - 1; i++) { // Skip header (0) and total row (last)
                const td = tr[i].getElementsByTagName('td')[0]; // First column (Odjel)
                if (td) {
                    const txtValue = td.textContent || td.innerText;
                    if (txtValue.toLowerCase().indexOf(filter) > -1) {
                        tr[i].style.display = '';
                    } else {
                        tr[i].style.display = 'none';
                    }
                }
            }
        }

        // ========================================
        // IZVJE≈†TAJI - Sub-tab switching
        // ========================================

        function switchIzvjestajiSubTab(subTab) {
            // Remove active class from all sub-tabs
            const subTabs = document.querySelectorAll('.sub-tab');
            subTabs.forEach(tab => tab.classList.remove('active'));

            // Hide all sub-contents
            document.getElementById('mjesecni-izvjestaj').classList.add('hidden');
            document.getElementById('sedmicni-sjeca-izvjestaj').classList.add('hidden');
            document.getElementById('sedmicni-otprema-izvjestaj').classList.add('hidden');
            document.getElementById('stanje-odjela-izvjestaj').classList.add('hidden');

            // Show selected sub-content and activate tab
            if (subTab === 'mjesecni') {
                document.querySelector('.sub-tab[onclick*="mjesecni"]').classList.add('active');
                document.getElementById('mjesecni-izvjestaj').classList.remove('hidden');
                loadIzvjestaji();
            } else if (subTab === 'sedmicni-sjeca') {
                document.querySelector('.sub-tab[onclick*="sedmicni-sjeca"]').classList.add('active');
                document.getElementById('sedmicni-sjeca-izvjestaj').classList.remove('hidden');
                loadSedmicniIzvjestajSjeca();
            } else if (subTab === 'sedmicni-otprema') {
                document.querySelector('.sub-tab[onclick*="sedmicni-otprema"]').classList.add('active');
                document.getElementById('sedmicni-otprema-izvjestaj').classList.remove('hidden');
                loadSedmicniIzvjestajOtprema();
            } else if (subTab === 'stanje-odjela') {
                document.querySelector('.sub-tab[onclick*="stanje-odjela"]').classList.add('active');
                document.getElementById('stanje-odjela-izvjestaj').classList.remove('hidden');
                loadStanjeOdjela();
            }
        }

        // ========================================
        // SEDMIƒåNI IZVJE≈†TAJI - Functions
        // ========================================

        async function loadSedmicniIzvjestajSjeca() {
            document.getElementById('loading-screen').classList.remove('hidden');

            try {
                const year = document.getElementById('sedmicni-sjeca-year-select').value;
                const month = document.getElementById('sedmicni-sjeca-month-select').value;

                // Load PRIMKA (sjeƒça) data
                const primkaUrl = API_URL + '?path=primaci-daily&year=' + year + '&month=' + month + '&username=' + currentUser.username + '&password=' + currentPassword;
                const primkaData = await fetchWithCache(primkaUrl, `cache_sedmicni_sjeca_${year}_${month}`);

                if (primkaData.error) throw new Error('Primka: ' + primkaData.error);

                // Group by weeks (within month boundaries)
                const weeklyData = groupDataByWeeks(primkaData.data, year, month, primkaData.sortimentiNazivi);

                // Render
                renderSedmicniIzvjestaj(weeklyData, primkaData.sortimentiNazivi, 'sedmicni-sjeca-container', year, month);

                document.getElementById('loading-screen').classList.add('hidden');

            } catch (error) {
                console.error('Error loading sedmiƒçni izvje≈°taj sjeƒçe:', error);
                showError('Gre≈°ka', 'Gre≈°ka pri uƒçitavanju sedmiƒçnog izvje≈°taja: ' + error.message);
                document.getElementById('loading-screen').classList.add('hidden');
            }
        }

        async function loadSedmicniIzvjestajOtprema() {
            document.getElementById('loading-screen').classList.remove('hidden');

            try {
                const year = document.getElementById('sedmicni-otprema-year-select').value;
                const month = document.getElementById('sedmicni-otprema-month-select').value;

                // Load OTPREMA data
                const otpremaUrl = API_URL + '?path=otpremaci-daily&year=' + year + '&month=' + month + '&username=' + currentUser.username + '&password=' + currentPassword;
                const otpremaData = await fetchWithCache(otpremaUrl, `cache_sedmicni_otprema_${year}_${month}`);

                if (otpremaData.error) throw new Error('Otprema: ' + otpremaData.error);

                // Group by weeks (within month boundaries)
                const weeklyData = groupDataByWeeks(otpremaData.data, year, month, otpremaData.sortimentiNazivi);

                // Render
                renderSedmicniIzvjestaj(weeklyData, otpremaData.sortimentiNazivi, 'sedmicni-otprema-container', year, month);

                document.getElementById('loading-screen').classList.add('hidden');

            } catch (error) {
                console.error('Error loading sedmiƒçni izvje≈°taj otpreme:', error);
                showError('Gre≈°ka', 'Gre≈°ka pri uƒçitavanju sedmiƒçnog izvje≈°taja: ' + error.message);
                document.getElementById('loading-screen').classList.add('hidden');
            }
        }

        // Group data by weeks (sedmice se ne prelaze preko granica mjeseca)
        function groupDataByWeeks(data, year, month, sortimentiNazivi) {
            const weeks = [];
            const weeksMap = new Map();

            // Parse year and month
            const y = parseInt(year);
            const m = parseInt(month);

            data.forEach(row => {
                // Parse datum (expecting DD/MM/YYYY format)
                const datumStr = row.datum;
                const dateParts = datumStr.split(/[\/\.\-]/);
                const day = parseInt(dateParts[0]);
                const recordMonth = parseInt(dateParts[1]) - 1;
                const recordYear = parseInt(dateParts[2]);

                // Skip if not in selected month
                if (recordYear !== y || recordMonth !== m) return;

                const datum = new Date(recordYear, recordMonth, day);

                // Get week number within the month
                const weekInfo = getWeekWithinMonth(datum, y, m);
                const weekKey = weekInfo.weekNumber;

                if (!weeksMap.has(weekKey)) {
                    weeksMap.set(weekKey, {
                        weekNumber: weekKey,
                        weekStart: weekInfo.weekStart,
                        weekEnd: weekInfo.weekEnd,
                        odjeliMap: {}
                    });
                }

                const week = weeksMap.get(weekKey);
                const odjel = row.odjel;

                if (!week.odjeliMap[odjel]) {
                    week.odjeliMap[odjel] = {};
                    sortimentiNazivi.forEach(s => week.odjeliMap[odjel][s] = 0);
                }

                sortimentiNazivi.forEach(sortiment => {
                    const value = parseFloat(row.sortimenti[sortiment]) || 0;
                    week.odjeliMap[odjel][sortiment] += value;
                });
            });

            // Convert Map to Array and sort by week number
            weeksMap.forEach(week => weeks.push(week));
            weeks.sort((a, b) => a.weekNumber - b.weekNumber);

            return weeks;
        }

        // Get week number within month (sedmica poƒçinje u ponedjeljak)
        function getWeekWithinMonth(date, year, month) {
            // Clone date to avoid mutation
            const d = new Date(date.getTime());

            // Get first day of month
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);

            // Find first Monday of the month (or first day if it's not Monday)
            let weekStart = new Date(firstDay);
            const firstDayOfWeek = firstDay.getDay(); // 0=Sunday, 1=Monday, ...

            // If first day is not Monday, find next Monday (or use first day if it's after Monday)
            if (firstDayOfWeek === 0) { // Sunday
                weekStart.setDate(firstDay.getDate() + 1); // Move to Monday
            } else if (firstDayOfWeek > 1) { // Tuesday-Saturday
                weekStart.setDate(firstDay.getDate() + (8 - firstDayOfWeek)); // Move to next Monday
            }
            // If firstDayOfWeek === 1 (Monday), weekStart is already correct

            // Calculate week number
            let weekNumber = 1;
            let currentWeekStart = new Date(firstDay);

            while (currentWeekStart <= d) {
                let currentWeekEnd = new Date(currentWeekStart);
                currentWeekEnd.setDate(currentWeekEnd.getDate() + 6); // Sunday

                // Ensure week doesn't go beyond month
                if (currentWeekEnd > lastDay) {
                    currentWeekEnd = new Date(lastDay);
                }

                // Check if date falls in this week
                if (d >= currentWeekStart && d <= currentWeekEnd) {
                    return {
                        weekNumber: weekNumber,
                        weekStart: formatDateDDMMYYYY(currentWeekStart),
                        weekEnd: formatDateDDMMYYYY(currentWeekEnd)
                    };
                }

                // Move to next week (always Monday)
                currentWeekStart.setDate(currentWeekStart.getDate() + 7);

                // If next week is in next month, stop
                if (currentWeekStart.getMonth() !== month) {
                    break;
                }

                weekNumber++;
            }

            // Fallback: return week 1
            return {
                weekNumber: 1,
                weekStart: formatDateDDMMYYYY(firstDay),
                weekEnd: formatDateDDMMYYYY(lastDay)
            };
        }

        // Format date as DD/MM/YYYY
        function formatDateDDMMYYYY(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return day + '/' + month + '/' + year;
        }

        // Render sedmiƒçni izvje≈°taj (multiple tables, one per week)
        function renderSedmicniIzvjestaj(weeks, sortimentiNazivi, containerId, year, month) {
            const container = document.getElementById(containerId);
            const mjeseciNazivi = ['Januar', 'Februar', 'Mart', 'April', 'Maj', 'Juni', 'Juli', 'August', 'Septembar', 'Oktobar', 'Novembar', 'Decembar'];

            if (weeks.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280;">Nema podataka za odabrani mjesec</div>';
                return;
            }

            let html = '';

            // Show all weeks in the month, sorted from newest to oldest (reverse chronological)
            const visibleWeeks = weeks.slice().reverse();

            visibleWeeks.forEach(week => {
                // Convert odjeliMap to array
                const odjeliArray = [];
                for (const odjel in week.odjeliMap) {
                    odjeliArray.push({
                        odjel: odjel,
                        sortimenti: week.odjeliMap[odjel]
                    });
                }
                odjeliArray.sort((a, b) => a.odjel.localeCompare(b.odjel));

                html += '<div class="section" style="margin-bottom: 40px;">';
                html += '<h3 style="margin-bottom: 16px; color: #047857;">üìÖ Sedmica ' + week.weekNumber + ': ' + week.weekStart + ' - ' + week.weekEnd + '</h3>';

                if (odjeliArray.length === 0) {
                    html += '<p style="color: #6b7280; padding: 20px;">Nema podataka za ovu sedmicu</p>';
                } else {
                    html += '<div style="overflow-x: auto;"><table class="table">';

                    // Header
                    html += '<thead><tr><th style="position: sticky; left: 0; background: #f9fafb; z-index: 20; min-width: 200px;">Odjel</th>';
                    sortimentiNazivi.forEach(sortiment => {
                        const colClass = getColumnGroup(sortiment);
                        let extraClass = '';
                        if (sortiment === 'ƒåETINARI') extraClass = ' col-cetinari';
                        else if (sortiment === 'LI≈†ƒÜARI') extraClass = ' col-liscari';
                        else if (sortiment === 'SVEUKUPNO') extraClass = ' col-sveukupno';

                        html += '<th class="sortiment-col right ' + colClass + extraClass + '">' + sortiment + '</th>';
                    });
                    html += '</tr></thead>';

                    // Body
                    html += '<tbody>';
                    const totals = {};
                    sortimentiNazivi.forEach(s => totals[s] = 0);

                    odjeliArray.forEach((row, index) => {
                        const rowStyle = index % 2 === 0 ? 'background: #f9fafb;' : '';
                        html += '<tr style="' + rowStyle + '">';
                        html += '<td style="font-weight: 600; position: sticky; left: 0; background: ' + (index % 2 === 0 ? '#f9fafb' : 'white') + '; z-index: 9;">' + row.odjel + '</td>';

                        sortimentiNazivi.forEach(sortiment => {
                            const value = row.sortimenti[sortiment] || 0;
                            totals[sortiment] += value;

                            const colClass = getColumnGroup(sortiment);
                            let extraClass = '';
                            if (sortiment === 'ƒåETINARI') extraClass = ' col-cetinari';
                            else if (sortiment === 'LI≈†ƒÜARI') extraClass = ' col-liscari';
                            else if (sortiment === 'SVEUKUPNO') extraClass = ' col-sveukupno';

                            const displayValue = value === 0 ? '' : value.toFixed(2);
                            html += '<td class="sortiment-col right ' + colClass + extraClass + '">' + displayValue + '</td>';
                        });

                        html += '</tr>';
                    });

                    // UKUPNO row
                    html += '<tr style="background: #f9fafb; border-top: 3px solid #1f2937; font-weight: 700;">';
                    html += '<td style="position: sticky; left: 0; background: #f9fafb; z-index: 9; font-size: 15px; padding: 14px;">üìä UKUPNO</td>';

                    sortimentiNazivi.forEach(sortiment => {
                        const colClass = getColumnGroup(sortiment);
                        let extraClass = '';
                        if (sortiment === 'ƒåETINARI') extraClass = ' col-cetinari';
                        else if (sortiment === 'LI≈†ƒÜARI') extraClass = ' col-liscari';
                        else if (sortiment === 'SVEUKUPNO') extraClass = ' col-sveukupno';

                        html += '<td class="sortiment-col right ' + colClass + extraClass + '" style="font-weight: 700;">' + totals[sortiment].toFixed(2) + '</td>';
                    });

                    html += '</tr>';
                    html += '</tbody></table></div>';
                }

                html += '</div>';
            });

            container.innerHTML = html;
        }

        // ========================================
        // STANJE ODJELA - Trenutno stanje iz fajla ODJELI
        // ========================================

        // Globalne varijable za stanje odjela
        let stanjeOdjelaData = [];
        let stanjeOdjelaSortimenti = [];

        async function loadStanjeOdjela() {
            document.getElementById('loading-screen').classList.remove('hidden');

            try {
                // Load data from backend
                const url = API_URL + '?path=stanje-odjela&username=' + currentUser.username + '&password=' + currentPassword;
                const data = await fetchWithCache(url, `cache_stanje_odjela`);

                if (data.error) throw new Error(data.error);

                // Saƒçuvaj podatke globalno
                stanjeOdjelaData = data.data;
                stanjeOdjelaSortimenti = data.sortimentiNazivi;

                // Populi≈°i dropdown sa radili≈°tima
                populateStanjeOdjelaDropdown(data.data);

                // Render sections
                renderStanjeOdjelaSections(data.data, data.sortimentiNazivi);

                document.getElementById('loading-screen').classList.add('hidden');

            } catch (error) {
                console.error('Error loading stanje odjela:', error);
                showError('Gre≈°ka', 'Gre≈°ka pri uƒçitavanju stanja odjela: ' + error.message);
                document.getElementById('loading-screen').classList.add('hidden');
            }
        }

        function populateStanjeOdjelaDropdown(data) {
            const select = document.getElementById('stanje-odjela-select');

            // Oƒçisti postojeƒáe opcije osim "Sva radili≈°ta"
            select.innerHTML = '<option value="">Sva radili≈°ta</option>';

            // Izvuci unique radili≈°ta
            const radilistaSet = new Set();
            data.forEach(odjel => {
                if (odjel.radiliste) {
                    radilistaSet.add(odjel.radiliste);
                }
            });

            // Sortiraj i dodaj u dropdown
            const radilista = Array.from(radilistaSet).sort();
            radilista.forEach(radiliste => {
                const option = document.createElement('option');
                option.value = radiliste;
                option.textContent = radiliste;
                select.appendChild(option);
            });
        }

        function filterStanjeOdjela() {
            const selectedRadiliste = document.getElementById('stanje-odjela-select').value;

            if (selectedRadiliste === '') {
                // Prika≈æi sve
                renderStanjeOdjelaSections(stanjeOdjelaData, stanjeOdjelaSortimenti);
            } else {
                // Filtriraj samo izabrano radili≈°te
                const filteredData = stanjeOdjelaData.filter(odjel => odjel.radiliste === selectedRadiliste);
                renderStanjeOdjelaSections(filteredData, stanjeOdjelaSortimenti);
            }
        }

        function renderStanjeOdjelaSections(data, sortimentiNazivi) {
            const container = document.getElementById('stanje-odjela-container');

            if (data.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280;">Nema podataka</div>';
                return;
            }

            let html = '';

            // Za svaki odjel kreiraj zasebnu sekciju
            data.forEach((odjelData, odjelIndex) => {
                const radiliste = odjelData.radiliste || odjelData.odjelNaziv;
                const odjelNaziv = odjelData.odjelNaziv;
                const redovi = odjelData.redovi;

                // Sekcija za svaki odjel
                html += '<div class="section" style="margin-bottom: 40px; border: 2px solid #d1d5db; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">';

                // Header radili≈°ta
                html += '<div style="background: linear-gradient(135deg, #047857 0%, #059669 100%); padding: 16px 24px; border-bottom: 3px solid #10b981;">';
                html += '<h3 style="margin: 0; color: white; font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 12px;">';
                html += '<span style="font-size: 24px;">üè≠</span>';
                html += '<div>';
                html += '<div>' + radiliste + '</div>';
                html += '<div style="font-size: 12px; font-weight: 400; opacity: 0.9; margin-top: 4px;">(' + odjelNaziv + ')</div>';
                html += '</div>';
                html += '</h3>';
                html += '</div>';

                // Tabela sa sortimentnim zaglavljem
                html += '<div style="overflow-x: auto;">';
                html += '<table style="width: 100%; border-collapse: collapse; background: white;">';

                // Sortimentno zaglavlje
                html += '<thead>';
                html += '<tr style="background: #f0fdf4; border-bottom: 2px solid #10b981;">';
                html += '<th style="padding: 14px 16px; text-align: left; font-weight: 700; color: #047857; border-right: 1px solid #d1d5db; min-width: 180px; position: sticky; left: 0; background: #f0fdf4; z-index: 10;">Vrsta</th>';

                sortimentiNazivi.forEach((sortiment, index) => {
                    const colClass = getColumnGroup(sortiment);
                    let bgColor = '#f0fdf4';
                    let textColor = '#047857';

                    if (sortiment === 'ƒåETINARI') {
                        bgColor = '#dbeafe';
                        textColor = '#1e40af';
                    } else if (sortiment === 'LI≈†ƒÜARI') {
                        bgColor = '#fef3c7';
                        textColor = '#92400e';
                    } else if (sortiment === 'SVEUKUPNO') {
                        bgColor = '#ede9fe';
                        textColor = '#5b21b6';
                    }

                    const borderRight = index < sortimentiNazivi.length - 1 ? 'border-right: 1px solid #d1d5db;' : '';
                    html += '<th style="padding: 14px 12px; text-align: right; font-weight: 700; font-size: 13px; color: ' + textColor + '; background: ' + bgColor + '; ' + borderRight + ' white-space: nowrap;">' + sortiment + '</th>';
                });

                html += '</tr>';
                html += '</thead>';

                // Body sa 4 reda
                html += '<tbody>';

                const vrste = [
                    { naziv: 'PROJEKAT', data: redovi.projekat, icon: 'üìã', bg: '#fef3c7', color: '#92400e', borderColor: '#fbbf24' },
                    { naziv: 'SJEƒåA', data: redovi.sjeca, icon: 'üå≤', bg: '#d1fae5', color: '#065f46', borderColor: '#10b981' },
                    { naziv: 'OTPREMA', data: redovi.otprema, icon: 'üöõ', bg: '#dbeafe', color: '#1e40af', borderColor: '#3b82f6' },
                    { naziv: '≈†UMA-LAGER', data: redovi.sumaLager, icon: 'üì¶', bg: '#e9d5ff', color: '#6b21a8', borderColor: '#a855f7' }
                ];

                vrste.forEach((vrsta, vrstaIndex) => {
                    const borderBottom = vrstaIndex < vrste.length - 1 ? 'border-bottom: 1px solid #e5e7eb;' : '';

                    html += '<tr style="' + borderBottom + '">';
                    html += '<td style="padding: 12px 16px; font-weight: 700; color: ' + vrsta.color + '; background: ' + vrsta.bg + '; border-right: 3px solid ' + vrsta.borderColor + '; position: sticky; left: 0; z-index: 5;">';
                    html += '<span style="display: inline-flex; align-items: center; gap: 8px;">';
                    html += '<span style="font-size: 20px;">' + vrsta.icon + '</span>';
                    html += '<span>' + vrsta.naziv + '</span>';
                    html += '</span>';
                    html += '</td>';

                    vrsta.data.forEach((value, index) => {
                        const sortiment = sortimentiNazivi[index];
                        let bgColor = 'white';

                        if (sortiment === 'ƒåETINARI') bgColor = '#eff6ff';
                        else if (sortiment === 'LI≈†ƒÜARI') bgColor = '#fffbeb';
                        else if (sortiment === 'SVEUKUPNO') bgColor = '#faf5ff';

                        const borderRight = index < sortimentiNazivi.length - 1 ? 'border-right: 1px solid #e5e7eb;' : '';
                        const displayValue = value === 0 ? '-' : value.toFixed(2);
                        const fontWeight = sortiment === 'SVEUKUPNO' ? 'font-weight: 700;' : '';

                        html += '<td style="padding: 12px; text-align: right; background: ' + bgColor + '; ' + borderRight + ' ' + fontWeight + ' color: #374151;">' + displayValue + '</td>';
                    });

                    html += '</tr>';
                });

                html += '</tbody>';
                html += '</table>';
                html += '</div>';
                html += '</div>';
            });

            container.innerHTML = html;
        }

        // Load pending count (for badge only)
        async function loadPendingCount() {
            try {
                const year = new Date().getFullYear();
                const url = API_URL + '?path=pending-unosi&year=' + year + '&username=' + currentUser.username + '&password=' + currentPassword;
                const response = await fetch(url);
                const data = await response.json();

                if (data.success && data.unosi) {
                    updatePendingBadge(data.unosi.length);
                }
            } catch (error) {
                console.error('Error loading pending count:', error);
            }
        }

        // Update pending badge count
        function updatePendingBadge(count) {
            const badge = document.getElementById('pending-count-badge');
            if (badge) {
                if (count > 0) {
                    badge.textContent = count;
                    badge.classList.add('show');
                } else {
                    badge.classList.remove('show');
                }
            }
        }

        // Edit pending unos (placeholder for future implementation)
        function editPendingUnos(id, tip) {
            showInfo('U razvoju', 'Ureƒëivanje unosa #' + id + ' (Tip: ' + tip + ') - Ova funkcionalnost ƒáe biti dodana uskoro.');
            // Close dropdown
            const dropdown = document.getElementById('row-actions-' + id);
            if (dropdown) dropdown.classList.remove('show');
        }

        // Delete pending unos with modal confirmation
        function deletePendingUnos(id, tip) {
            // Close dropdown first
            const dropdown = document.getElementById('row-actions-' + id);
            if (dropdown) dropdown.classList.remove('show');

            // Show confirmation modal
            showConfirmModal(
                'Potvrda brisanja',
                'Da li ste sigurni da ≈æelite obrisati ovaj unos? (ID: ' + id + ', Tip: ' + tip + ')',
                async function() {
                    try {
                        const formData = new URLSearchParams();
                        formData.append('path', 'delete-pending');
                        formData.append('rowIndex', id);
                        // Convert tip to lowercase: SJEƒåA -> sjeca, OTPREMA -> otprema
                        const tipLower = tip === 'SJEƒåA' ? 'sjeca' : 'otprema';
                        formData.append('tip', tipLower);
                        formData.append('username', currentUser.username);
                        formData.append('password', currentPassword);

                        const url = API_URL + '?' + formData.toString();
                        const response = await fetch(url);
                        const result = await response.json();

                        if (result.success) {
                            showSuccess('Uspjeh', result.message);
                            loadPendingUnosi();
                        } else {
                            throw new Error(result.error || 'Unknown error');
                        }
                    } catch (error) {
                        showError('Gre≈°ka', error.message);
                    }
                }
            );
        }

        // Calculate Sjeca totals automatically
        function calculateSjeca() {
            // Get all ƒçetinar values
            var flC = parseFloat(document.getElementById('sjeca-FL-C').value) || 0;
            var iC = parseFloat(document.getElementById('sjeca-I-C').value) || 0;
            var iiC = parseFloat(document.getElementById('sjeca-II-C').value) || 0;
            var iiiC = parseFloat(document.getElementById('sjeca-III-C').value) || 0;
            var rudno = parseFloat(document.getElementById('sjeca-RUDNO').value) || 0;
            var celDuga = parseFloat(document.getElementById('sjeca-CEL-DUGA').value) || 0;
            var celCijepana = parseFloat(document.getElementById('sjeca-CEL-CIJEPANA').value) || 0;

            // Calculate TRUPCI ƒå = F/L ƒå + I ƒå + II ƒå + III ƒå + RUDNO
            var trupciC = flC + iC + iiC + iiiC + rudno;
            document.getElementById('sjeca-TRUPCI-C').value = trupciC.toFixed(2);

            // Calculate ƒåETINARI = CEL.DUGA + CEL.CIJEPANA + TRUPCI ƒå
            var cetinari = celDuga + celCijepana + trupciC;
            document.getElementById('sjeca-CETINARI').value = cetinari.toFixed(2);

            // Get all li≈°ƒáar values
            var flL = parseFloat(document.getElementById('sjeca-FL-L').value) || 0;
            var iL = parseFloat(document.getElementById('sjeca-I-L').value) || 0;
            var iiL = parseFloat(document.getElementById('sjeca-II-L').value) || 0;
            var iiiL = parseFloat(document.getElementById('sjeca-III-L').value) || 0;
            var ogrDugi = parseFloat(document.getElementById('sjeca-OGR-DUGI').value) || 0;
            var ogrCijepani = parseFloat(document.getElementById('sjeca-OGR-CIJEPANI').value) || 0;

            // Calculate TRUPCI L = F/L L + I L + II L + III L
            var trupciL = flL + iL + iiL + iiiL;
            document.getElementById('sjeca-TRUPCI').value = trupciL.toFixed(2);

            // Calculate LI≈†ƒÜARI = OGR.DUGI + OGR.CIJEPANI + TRUPCI L
            var liscari = ogrDugi + ogrCijepani + trupciL;
            document.getElementById('sjeca-LISCARI').value = liscari.toFixed(2);

            // Calculate SVEUKUPNO = ƒåETINARI + LI≈†ƒÜARI
            var sveukupno = cetinari + liscari;
            document.getElementById('sjeca-SVEUKUPNO').value = sveukupno.toFixed(2);
        }

        // Calculate Otprema totals automatically
        function calculateOtprema() {
            // Get all ƒçetinar values
            var flC = parseFloat(document.getElementById('otprema-FL-C').value) || 0;
            var iC = parseFloat(document.getElementById('otprema-I-C').value) || 0;
            var iiC = parseFloat(document.getElementById('otprema-II-C').value) || 0;
            var iiiC = parseFloat(document.getElementById('otprema-III-C').value) || 0;
            var rudno = parseFloat(document.getElementById('otprema-RUDNO').value) || 0;
            var celDuga = parseFloat(document.getElementById('otprema-CEL-DUGA').value) || 0;
            var celCijepana = parseFloat(document.getElementById('otprema-CEL-CIJEPANA').value) || 0;

            // Calculate TRUPCI ƒå = F/L ƒå + I ƒå + II ƒå + III ƒå + RUDNO
            var trupciC = flC + iC + iiC + iiiC + rudno;
            document.getElementById('otprema-TRUPCI-C').value = trupciC.toFixed(2);

            // Calculate ƒåETINARI = CEL.DUGA + CEL.CIJEPANA + TRUPCI ƒå
            var cetinari = celDuga + celCijepana + trupciC;
            document.getElementById('otprema-CETINARI').value = cetinari.toFixed(2);

            // Get all li≈°ƒáar values
            var flL = parseFloat(document.getElementById('otprema-FL-L').value) || 0;
            var iL = parseFloat(document.getElementById('otprema-I-L').value) || 0;
            var iiL = parseFloat(document.getElementById('otprema-II-L').value) || 0;
            var iiiL = parseFloat(document.getElementById('otprema-III-L').value) || 0;
            var ogrDugi = parseFloat(document.getElementById('otprema-OGR-DUGI').value) || 0;
            var ogrCijepani = parseFloat(document.getElementById('otprema-OGR-CIJEPANI').value) || 0;

            // Calculate TRUPCI L = F/L L + I L + II L + III L
            var trupciL = flL + iL + iiL + iiiL;
            document.getElementById('otprema-TRUPCI').value = trupciL.toFixed(2);

            // Calculate LI≈†ƒÜARI = OGR.DUGI + OGR.CIJEPANI + TRUPCI L
            var liscari = ogrDugi + ogrCijepani + trupciL;
            document.getElementById('otprema-LISCARI').value = liscari.toFixed(2);

            // Calculate SVEUKUPNO = ƒåETINARI + LI≈†ƒÜARI
            var sveukupno = cetinari + liscari;
            document.getElementById('otprema-SVEUKUPNO').value = sveukupno.toFixed(2);
        }

        // Show Add Sjeca Form
        function showAddSjecaForm() {
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('add-sjeca-content').classList.remove('hidden');

            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('sjeca-datum').value = today;

            // Add event listeners to all sortimenti inputs for automatic calculation
            const sjecaInputIds = ['sjeca-FL-C', 'sjeca-I-C', 'sjeca-II-C', 'sjeca-III-C', 'sjeca-RUDNO',
                                   'sjeca-CEL-DUGA', 'sjeca-CEL-CIJEPANA',
                                   'sjeca-FL-L', 'sjeca-I-L', 'sjeca-II-L', 'sjeca-III-L',
                                   'sjeca-OGR-DUGI', 'sjeca-OGR-CIJEPANI'];

            sjecaInputIds.forEach(function(inputId) {
                const element = document.getElementById(inputId);
                if (element && !element.hasAttribute('data-listener-added')) {
                    element.addEventListener('input', calculateSjeca);
                    element.setAttribute('data-listener-added', 'true');
                }
            });

            // Initial calculation
            calculateSjeca();
        }

        // Show Add Otprema Form
        function showAddOtpremaForm() {
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('add-otprema-content').classList.remove('hidden');

            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('otprema-datum').value = today;

            // Add event listeners to all sortimenti inputs for automatic calculation
            const otpremaInputIds = ['otprema-FL-C', 'otprema-I-C', 'otprema-II-C', 'otprema-III-C', 'otprema-RUDNO',
                                     'otprema-CEL-DUGA', 'otprema-CEL-CIJEPANA',
                                     'otprema-FL-L', 'otprema-I-L', 'otprema-II-L', 'otprema-III-L',
                                     'otprema-OGR-DUGI', 'otprema-OGR-CIJEPANI'];

            otpremaInputIds.forEach(function(inputId) {
                const element = document.getElementById(inputId);
                if (element && !element.hasAttribute('data-listener-added')) {
                    element.addEventListener('input', calculateOtprema);
                    element.setAttribute('data-listener-added', 'true');
                }
            });

            // Initial calculation
            calculateOtprema();
        }

        // Submit Sjeca Form
        async function submitSjeca(event) {
            event.preventDefault();

            const submitBtn = document.getElementById('submit-sjeca-btn');
            const messageDiv = document.getElementById('sjeca-message');

            submitBtn.disabled = true;
            submitBtn.textContent = 'Dodavanje...';
            messageDiv.classList.add('hidden');

            try {
                // Collect form data
                const formData = new URLSearchParams();
                formData.append('path', 'add-sjeca');
                formData.append('username', currentUser.username);
                formData.append('password', currentPassword);
                formData.append('datum', document.getElementById('sjeca-datum').value);
                formData.append('odjel', document.getElementById('sjeca-odjel').value);
                formData.append('F/L ƒå', document.getElementById('sjeca-FL-C').value);
                formData.append('I ƒå', document.getElementById('sjeca-I-C').value);
                formData.append('II ƒå', document.getElementById('sjeca-II-C').value);
                formData.append('III ƒå', document.getElementById('sjeca-III-C').value);
                formData.append('RUDNO', document.getElementById('sjeca-RUDNO').value);
                formData.append('TRUPCI ƒå', document.getElementById('sjeca-TRUPCI-C').value);
                formData.append('CEL.DUGA', document.getElementById('sjeca-CEL-DUGA').value);
                formData.append('CEL.CIJEPANA', document.getElementById('sjeca-CEL-CIJEPANA').value);
                formData.append('ƒåETINARI', document.getElementById('sjeca-CETINARI').value);
                formData.append('F/L L', document.getElementById('sjeca-FL-L').value);
                formData.append('I L', document.getElementById('sjeca-I-L').value);
                formData.append('II L', document.getElementById('sjeca-II-L').value);
                formData.append('III L', document.getElementById('sjeca-III-L').value);
                formData.append('TRUPCI', document.getElementById('sjeca-TRUPCI').value);
                formData.append('OGR.DUGI', document.getElementById('sjeca-OGR-DUGI').value);
                formData.append('OGR.CIJEPANI', document.getElementById('sjeca-OGR-CIJEPANI').value);
                formData.append('LI≈†ƒÜARI', document.getElementById('sjeca-LISCARI').value);

                // Send request (don't cache this)
                const url = `${API_URL}?${formData.toString()}`;
                const response = await fetch(url);
                const result = await response.json();

                if (result.success) {
                    messageDiv.innerHTML = `‚úÖ ${result.message}<br>Ukupno: ${result.ukupno.toFixed(2)} m¬≥`;
                    messageDiv.style.background = '#d1fae5';
                    messageDiv.style.color = '#047857';
                    messageDiv.classList.remove('hidden');

                    // Reset form
                    setTimeout(() => {
                        resetSjecaForm();
                        messageDiv.classList.add('hidden');
                    }, 3000);

                    // Clear all sjeƒça-related cache entries so new data shows up
                    clearCacheByPattern('primac');
                    clearCacheByPattern('primaci');
                    clearCacheByPattern('dashboard');
                    clearCacheByPattern('izvjestaji');
                    clearCacheByPattern('sedmicni_sjeca');
                    clearCacheByPattern('stanje_odjela');
                    clearCacheByPattern('my_sjece');
                } else {
                    throw new Error(result.error || 'Unknown error');
                }

            } catch (error) {
                messageDiv.innerHTML = `‚ùå Gre≈°ka: ${error.message}`;
                messageDiv.style.background = '#fee2e2';
                messageDiv.style.color = '#991b1b';
                messageDiv.classList.remove('hidden');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Dodaj sjeƒçu';
            }
        }

        // Submit Otprema Form
        async function submitOtprema(event) {
            event.preventDefault();

            const submitBtn = document.getElementById('submit-otprema-btn');
            const messageDiv = document.getElementById('otprema-message');

            submitBtn.disabled = true;
            submitBtn.textContent = 'Dodavanje...';
            messageDiv.classList.add('hidden');

            try {
                // Collect form data
                const formData = new URLSearchParams();
                formData.append('path', 'add-otprema');
                formData.append('username', currentUser.username);
                formData.append('password', currentPassword);
                formData.append('datum', document.getElementById('otprema-datum').value);
                formData.append('odjel', document.getElementById('otprema-odjel').value);
                formData.append('kupac', document.getElementById('otprema-kupac').value);
                formData.append('brojOtpremnice', document.getElementById('otprema-broj-otpremnice').value);
                formData.append('F/L ƒå', document.getElementById('otprema-FL-C').value);
                formData.append('I ƒå', document.getElementById('otprema-I-C').value);
                formData.append('II ƒå', document.getElementById('otprema-II-C').value);
                formData.append('III ƒå', document.getElementById('otprema-III-C').value);
                formData.append('RUDNO', document.getElementById('otprema-RUDNO').value);
                formData.append('TRUPCI ƒå', document.getElementById('otprema-TRUPCI-C').value);
                formData.append('CEL.DUGA', document.getElementById('otprema-CEL-DUGA').value);
                formData.append('CEL.CIJEPANA', document.getElementById('otprema-CEL-CIJEPANA').value);
                formData.append('ƒåETINARI', document.getElementById('otprema-CETINARI').value);
                formData.append('F/L L', document.getElementById('otprema-FL-L').value);
                formData.append('I L', document.getElementById('otprema-I-L').value);
                formData.append('II L', document.getElementById('otprema-II-L').value);
                formData.append('III L', document.getElementById('otprema-III-L').value);
                formData.append('TRUPCI', document.getElementById('otprema-TRUPCI').value);
                formData.append('OGR.DUGI', document.getElementById('otprema-OGR-DUGI').value);
                formData.append('OGR.CIJEPANI', document.getElementById('otprema-OGR-CIJEPANI').value);
                formData.append('LI≈†ƒÜARI', document.getElementById('otprema-LISCARI').value);

                // Send request (don't cache this)
                const url = `${API_URL}?${formData.toString()}`;
                const response = await fetch(url);
                const result = await response.json();

                if (result.success) {
                    messageDiv.innerHTML = `‚úÖ ${result.message}<br>Ukupno: ${result.ukupno.toFixed(2)} m¬≥`;
                    messageDiv.style.background = '#dbeafe';
                    messageDiv.style.color = '#1e40af';
                    messageDiv.classList.remove('hidden');

                    // Reset form
                    setTimeout(() => {
                        resetOtpremaForm();
                        messageDiv.classList.add('hidden');
                    }, 3000);

                    // Clear all otprema-related cache entries so new data shows up
                    clearCacheByPattern('otpremac');
                    clearCacheByPattern('otpremaci');
                    clearCacheByPattern('dashboard');
                    clearCacheByPattern('kupci');
                    clearCacheByPattern('izvjestaji');
                    clearCacheByPattern('sedmicni_otprema');
                    clearCacheByPattern('stanje_odjela');
                    clearCacheByPattern('my_otpreme');
                } else {
                    throw new Error(result.error || 'Unknown error');
                }

            } catch (error) {
                messageDiv.innerHTML = `‚ùå Gre≈°ka: ${error.message}`;
                messageDiv.style.background = '#fee2e2';
                messageDiv.style.color = '#991b1b';
                messageDiv.classList.remove('hidden');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Dodaj otpremu';
            }
        }

        // Reset Sjeca Form
        function resetSjecaForm() {
            document.getElementById('add-sjeca-form').reset();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('sjeca-datum').value = today;

            // Reset all sortimenti to 0
            document.querySelectorAll('#add-sjeca-form input[type="number"]').forEach(input => {
                input.value = 0;
            });

            // Recalculate totals
            calculateSjeca();
        }

        // Reset Otprema Form
        function resetOtpremaForm() {
            document.getElementById('add-otprema-form').reset();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('otprema-datum').value = today;

            // Reset all sortimenti to 0
            document.querySelectorAll('#add-otprema-form input[type="number"]').forEach(input => {
                input.value = 0;
            });

            // Recalculate totals
            calculateOtprema();
        }

        // ==================== MY PENDING ENTRIES FUNCTIONS ====================

        // Load My Sjece (last 10 pending entries for current user)
        async function loadMySjece() {
            document.getElementById('loading-screen').classList.remove('hidden');
            document.getElementById('my-sjece-content').classList.add('hidden');

            try {
                const url = API_URL + '?path=my-pending&username=' + currentUser.username + '&password=' + currentPassword + '&tip=sjeca';
                const data = await fetchWithCache(url, `cache_my_sjece_${currentUser.username}`);

                if (data.error) {
                    throw new Error(data.error);
                }

                var html = '<div style="overflow-x: auto;">';

                if (data.unosi && data.unosi.length > 0) {
                    html += '<table style="width: 100%; border-collapse: collapse; margin-top: 20px;">';
                    html += '<thead><tr style="background: #047857; color: white;">';
                    html += '<th style="padding: 12px; border: 1px solid #ddd;">Datum</th>';
                    html += '<th style="padding: 12px; border: 1px solid #ddd;">Odjel</th>';
                    html += '<th style="padding: 12px; border: 1px solid #ddd;">ƒåETINARI</th>';
                    html += '<th style="padding: 12px; border: 1px solid #ddd;">LI≈†ƒÜARI</th>';
                    html += '<th style="padding: 12px; border: 1px solid #ddd;">Ukupno</th>';
                    html += '<th style="padding: 12px; border: 1px solid #ddd;">Vrijeme unosa</th>';
                    html += '<th style="padding: 12px; border: 1px solid #ddd;">Akcije</th>';
                    html += '</tr></thead><tbody>';

                    for (var i = 0; i < data.unosi.length; i++) {
                        var unos = data.unosi[i];
                        var cetinari = parseFloat(unos.sortimenti['ƒåETINARI'] || 0);
                        var liscari = parseFloat(unos.sortimenti['LI≈†ƒÜARI'] || 0);
                        var ukupno = cetinari + liscari;

                        html += '<tr style="' + (i % 2 === 0 ? 'background: #f9fafb;' : '') + '">';
                        html += '<td style="padding: 10px; border: 1px solid #ddd;">' + unos.datum + '</td>';
                        html += '<td style="padding: 10px; border: 1px solid #ddd;">' + unos.odjel + '</td>';
                        html += '<td style="padding: 10px; border: 1px solid #ddd;">' + cetinari.toFixed(2) + ' m¬≥</td>';
                        html += '<td style="padding: 10px; border: 1px solid #ddd;">' + liscari.toFixed(2) + ' m¬≥</td>';
                        html += '<td style="padding: 10px; border: 1px solid #ddd; font-weight: bold;">' + ukupno.toFixed(2) + ' m¬≥</td>';
                        html += '<td style="padding: 10px; border: 1px solid #ddd;">' + new Date(unos.timestamp).toLocaleString('hr-HR') + '</td>';
                        html += '<td style="padding: 10px; border: 1px solid #ddd; text-align: center;">';
                        html += '<button class="btn btn-primary" style="margin-right: 8px;" onclick=\'editMySjeca(' + JSON.stringify(unos).replace(/'/g, "\\'") + ')\'><‚úèÔ∏è Uredi</button>';
                        html += '<button class="btn btn-secondary" onclick="deleteMySjeca(' + unos.rowIndex + ')">üóëÔ∏è Obri≈°i</button>';
                        html += '</td>';
                        html += '</tr>';
                    }

                    html += '</tbody></table>';
                } else {
                    html += '<p style="text-align: center; color: #6b7280; padding: 40px;">Nemate pending unosa.</p>';
                }

                html += '</div>';

                document.getElementById('my-sjece-container').innerHTML = html;
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('my-sjece-content').classList.remove('hidden');

            } catch (error) {
                console.error('Error loading my sjece:', error);
                document.getElementById('my-sjece-container').innerHTML = '<p style="color: #dc2626; text-align: center; padding: 40px;">Gre≈°ka: ' + error.message + '</p>';
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('my-sjece-content').classList.remove('hidden');
            }
        }

        // Load My Otpreme (last 10 pending entries for current user)
        async function loadMyOtpreme() {
            document.getElementById('loading-screen').classList.remove('hidden');
            document.getElementById('my-otpreme-content').classList.add('hidden');

            try {
                const url = API_URL + '?path=my-pending&username=' + currentUser.username + '&password=' + currentPassword + '&tip=otprema';
                const data = await fetchWithCache(url, `cache_my_otpreme_${currentUser.username}`);

                if (data.error) {
                    throw new Error(data.error);
                }

                var html = '<div style="overflow-x: auto;">';

                if (data.unosi && data.unosi.length > 0) {
                    html += '<table style="width: 100%; border-collapse: collapse; margin-top: 20px;">';
                    html += '<thead><tr style="background: #2563eb; color: white;">';
                    html += '<th style="padding: 12px; border: 1px solid #ddd;">Datum</th>';
                    html += '<th style="padding: 12px; border: 1px solid #ddd;">Odjel</th>';
                    html += '<th style="padding: 12px; border: 1px solid #ddd;">Kupac</th>';
                    html += '<th style="padding: 12px; border: 1px solid #ddd;">Br. otpremnice</th>';
                    html += '<th style="padding: 12px; border: 1px solid #ddd;">ƒåETINARI</th>';
                    html += '<th style="padding: 12px; border: 1px solid #ddd;">LI≈†ƒÜARI</th>';
                    html += '<th style="padding: 12px; border: 1px solid #ddd;">Ukupno</th>';
                    html += '<th style="padding: 12px; border: 1px solid #ddd;">Vrijeme unosa</th>';
                    html += '<th style="padding: 12px; border: 1px solid #ddd;">Akcije</th>';
                    html += '</tr></thead><tbody>';

                    for (var i = 0; i < data.unosi.length; i++) {
                        var unos = data.unosi[i];
                        var cetinari = parseFloat(unos.sortimenti['ƒåETINARI'] || 0);
                        var liscari = parseFloat(unos.sortimenti['LI≈†ƒÜARI'] || 0);
                        var ukupno = cetinari + liscari;

                        html += '<tr style="' + (i % 2 === 0 ? 'background: #f9fafb;' : '') + '">';
                        html += '<td style="padding: 10px; border: 1px solid #ddd;">' + unos.datum + '</td>';
                        html += '<td style="padding: 10px; border: 1px solid #ddd;">' + unos.odjel + '</td>';
                        html += '<td style="padding: 10px; border: 1px solid #ddd;">' + (unos.kupac || '-') + '</td>';
                        html += '<td style="padding: 10px; border: 1px solid #ddd;">' + (unos.brojOtpremnice || '-') + '</td>';
                        html += '<td style="padding: 10px; border: 1px solid #ddd;">' + cetinari.toFixed(2) + ' m¬≥</td>';
                        html += '<td style="padding: 10px; border: 1px solid #ddd;">' + liscari.toFixed(2) + ' m¬≥</td>';
                        html += '<td style="padding: 10px; border: 1px solid #ddd; font-weight: bold;">' + ukupno.toFixed(2) + ' m¬≥</td>';
                        html += '<td style="padding: 10px; border: 1px solid #ddd;">' + new Date(unos.timestamp).toLocaleString('hr-HR') + '</td>';
                        html += '<td style="padding: 10px; border: 1px solid #ddd; text-align: center;">';
                        html += '<button class="btn btn-primary" style="margin-right: 8px;" onclick=\'editMyOtprema(' + JSON.stringify(unos).replace(/'/g, "\\'") + ')\'>‚úèÔ∏è Uredi</button>';
                        html += '<button class="btn btn-secondary" onclick="deleteMyOtprema(' + unos.rowIndex + ')">üóëÔ∏è Obri≈°i</button>';
                        html += '</td>';
                        html += '</tr>';
                    }

                    html += '</tbody></table>';
                } else {
                    html += '<p style="text-align: center; color: #6b7280; padding: 40px;">Nemate pending unosa.</p>';
                }

                html += '</div>';

                document.getElementById('my-otpreme-container').innerHTML = html;
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('my-otpreme-content').classList.remove('hidden');

            } catch (error) {
                console.error('Error loading my otpreme:', error);
                document.getElementById('my-otpreme-container').innerHTML = '<p style="color: #dc2626; text-align: center; padding: 40px;">Gre≈°ka: ' + error.message + '</p>';
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('my-otpreme-content').classList.remove('hidden');
            }
        }

        // Edit My Sjeca - show edit form
        function editMySjeca(unos) {
            document.getElementById('loading-screen').classList.add('hidden');

            // Hide other content
            document.getElementById('my-sjece-content').classList.add('hidden');

            // Show edit form
            document.getElementById('edit-sjeca-content').classList.remove('hidden');

            // Populate form with existing data
            document.getElementById('edit-sjeca-rowIndex').value = unos.rowIndex;
            document.getElementById('edit-sjeca-datum').value = unos.datum;
            document.getElementById('edit-sjeca-odjel').value = unos.odjel;

            // Build sortimenti fields dynamically
            var sortimentiHtml = '';
            var sortimentiKeys = ['F/L ƒå', 'I ƒå', 'II ƒå', 'III ƒå', 'RUDNO', 'TRUPCI ƒå', 'CEL.DUGA', 'CEL.CIJEPANA', 'ƒåETINARI',
                                 'F/L L', 'I L', 'II L', 'III L', 'TRUPCI', 'OGR.DUGI', 'OGR.CIJEPANI', 'LI≈†ƒÜARI'];

            sortimentiKeys.forEach(function(key) {
                var fieldId = 'edit-sjeca-' + key.replace(/\//g, '').replace(/ /g, '-');
                var value = unos.sortimenti[key] || 0;
                var isCalculated = ['TRUPCI ƒå', 'ƒåETINARI', 'TRUPCI', 'LI≈†ƒÜARI'].indexOf(key) !== -1;
                var readonlyAttr = isCalculated ? 'readonly' : '';
                var styleExtra = isCalculated ? 'background: #f3f4f6; color: #374151; font-weight: 600;' : '';

                sortimentiHtml += '<div class="form-group">';
                sortimentiHtml += '<label>' + key + (isCalculated ? ': <span style="color: #6b7280; font-size: 0.85em;">(auto)</span>' : ':') + '</label>';
                sortimentiHtml += '<input type="number" step="0.01" id="' + fieldId + '" value="' + value + '" min="0" ' + readonlyAttr + ' class="edit-sjeca-input" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%; ' + styleExtra + '">';
                sortimentiHtml += '</div>';
            });

            document.getElementById('edit-sjeca-sortimenti').innerHTML = sortimentiHtml;

            // Add event listeners for auto-calculation
            var inputIds = ['edit-sjeca-FL-ƒå', 'edit-sjeca-I-ƒå', 'edit-sjeca-II-ƒå', 'edit-sjeca-III-ƒå', 'edit-sjeca-RUDNO',
                           'edit-sjeca-CEL.DUGA', 'edit-sjeca-CEL.CIJEPANA',
                           'edit-sjeca-FL-L', 'edit-sjeca-I-L', 'edit-sjeca-II-L', 'edit-sjeca-III-L',
                           'edit-sjeca-OGR.DUGI', 'edit-sjeca-OGR.CIJEPANI'];

            inputIds.forEach(function(inputId) {
                var element = document.getElementById(inputId);
                if (element) {
                    element.addEventListener('input', calculateEditSjeca);
                }
            });

            // Calculate initial totals
            calculateEditSjeca();
        }

        // Calculate Edit Sjeca totals
        function calculateEditSjeca() {
            var flC = parseFloat(document.getElementById('edit-sjeca-FL-ƒå').value) || 0;
            var iC = parseFloat(document.getElementById('edit-sjeca-I-ƒå').value) || 0;
            var iiC = parseFloat(document.getElementById('edit-sjeca-II-ƒå').value) || 0;
            var iiiC = parseFloat(document.getElementById('edit-sjeca-III-ƒå').value) || 0;
            var rudno = parseFloat(document.getElementById('edit-sjeca-RUDNO').value) || 0;
            var celDuga = parseFloat(document.getElementById('edit-sjeca-CEL.DUGA').value) || 0;
            var celCijepana = parseFloat(document.getElementById('edit-sjeca-CEL.CIJEPANA').value) || 0;

            var trupciC = flC + iC + iiC + iiiC + rudno;
            document.getElementById('edit-sjeca-TRUPCI-ƒå').value = trupciC.toFixed(2);

            var cetinari = celDuga + celCijepana + trupciC;
            document.getElementById('edit-sjeca-ƒåETINARI').value = cetinari.toFixed(2);

            var flL = parseFloat(document.getElementById('edit-sjeca-FL-L').value) || 0;
            var iL = parseFloat(document.getElementById('edit-sjeca-I-L').value) || 0;
            var iiL = parseFloat(document.getElementById('edit-sjeca-II-L').value) || 0;
            var iiiL = parseFloat(document.getElementById('edit-sjeca-III-L').value) || 0;
            var ogrDugi = parseFloat(document.getElementById('edit-sjeca-OGR.DUGI').value) || 0;
            var ogrCijepani = parseFloat(document.getElementById('edit-sjeca-OGR.CIJEPANI').value) || 0;

            var trupciL = flL + iL + iiL + iiiL;
            document.getElementById('edit-sjeca-TRUPCI').value = trupciL.toFixed(2);

            var liscari = ogrDugi + ogrCijepani + trupciL;
            document.getElementById('edit-sjeca-LI≈†ƒÜARI').value = liscari.toFixed(2);

            var sveukupno = cetinari + liscari;
            document.getElementById('edit-sjeca-SVEUKUPNO').value = sveukupno.toFixed(2);
        }

        // Submit Edit Sjeca Form
        async function submitEditSjeca(event) {
            event.preventDefault();

            var submitBtn = document.getElementById('submit-edit-sjeca-btn');
            var messageDiv = document.getElementById('edit-sjeca-message');

            submitBtn.disabled = true;
            submitBtn.textContent = 'A≈æuriranje...';
            messageDiv.classList.add('hidden');

            try {
                var formData = new URLSearchParams();
                formData.append('path', 'update-pending');
                formData.append('username', currentUser.username);
                formData.append('password', currentPassword);
                formData.append('tip', 'sjeca');
                formData.append('rowIndex', document.getElementById('edit-sjeca-rowIndex').value);
                formData.append('datum', document.getElementById('edit-sjeca-datum').value);
                formData.append('odjel', document.getElementById('edit-sjeca-odjel').value);

                // Add all sortimenti
                var sortimentiKeys = ['F/L ƒå', 'I ƒå', 'II ƒå', 'III ƒå', 'RUDNO', 'TRUPCI ƒå', 'CEL.DUGA', 'CEL.CIJEPANA', 'ƒåETINARI',
                                     'F/L L', 'I L', 'II L', 'III L', 'TRUPCI', 'OGR.DUGI', 'OGR.CIJEPANI', 'LI≈†ƒÜARI'];

                sortimentiKeys.forEach(function(key) {
                    var fieldId = 'edit-sjeca-' + key.replace(/\//g, '').replace(/ /g, '-');
                    var value = document.getElementById(fieldId).value;
                    formData.append(key, value);
                });

                var url = API_URL + '?' + formData.toString();
                var response = await fetch(url);
                var result = await response.json();

                if (result.success) {
                    messageDiv.innerHTML = '‚úÖ ' + result.message + '<br>Ukupno: ' + result.ukupno.toFixed(2) + ' m¬≥';
                    messageDiv.style.background = '#d1fae5';
                    messageDiv.style.color = '#047857';
                    messageDiv.classList.remove('hidden');

                    setTimeout(function() {
                        switchTab('my-sjece');
                    }, 2000);
                } else {
                    throw new Error(result.error || 'Unknown error');
                }

            } catch (error) {
                messageDiv.innerHTML = '‚ùå Gre≈°ka: ' + error.message;
                messageDiv.style.background = '#fee2e2';
                messageDiv.style.color = '#991b1b';
                messageDiv.classList.remove('hidden');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Saƒçuvaj izmjene';
            }
        }

        // Cancel Edit Sjeca
        function cancelEditSjeca() {
            switchTab('my-sjece');
        }

        // Similar functions for Edit Otprema (abbreviated for space)
        function editMyOtprema(unos) {
            // Similar to editMySjeca but for otprema
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('my-otpreme-content').classList.add('hidden');
            document.getElementById('edit-otprema-content').classList.remove('hidden');

            document.getElementById('edit-otprema-rowIndex').value = unos.rowIndex;
            document.getElementById('edit-otprema-datum').value = unos.datum;
            document.getElementById('edit-otprema-odjel').value = unos.odjel;
            document.getElementById('edit-otprema-kupac').value = unos.kupac || '';
            document.getElementById('edit-otprema-broj-otpremnice').value = unos.brojOtpremnice || '';

            var sortimentiHtml = '';
            var sortimentiKeys = ['F/L ƒå', 'I ƒå', 'II ƒå', 'III ƒå', 'RUDNO', 'TRUPCI ƒå', 'CEL.DUGA', 'CEL.CIJEPANA', 'ƒåETINARI',
                                 'F/L L', 'I L', 'II L', 'III L', 'TRUPCI', 'OGR.DUGI', 'OGR.CIJEPANI', 'LI≈†ƒÜARI'];

            sortimentiKeys.forEach(function(key) {
                var fieldId = 'edit-otprema-' + key.replace(/\//g, '').replace(/ /g, '-');
                var value = unos.sortimenti[key] || 0;
                var isCalculated = ['TRUPCI ƒå', 'ƒåETINARI', 'TRUPCI', 'LI≈†ƒÜARI'].indexOf(key) !== -1;
                var readonlyAttr = isCalculated ? 'readonly' : '';
                var styleExtra = isCalculated ? 'background: #f3f4f6; color: #374151; font-weight: 600;' : '';

                sortimentiHtml += '<div class="form-group">';
                sortimentiHtml += '<label>' + key + (isCalculated ? ': <span style="color: #6b7280; font-size: 0.85em;">(auto)</span>' : ':') + '</label>';
                sortimentiHtml += '<input type="number" step="0.01" id="' + fieldId + '" value="' + value + '" min="0" ' + readonlyAttr + ' style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%; ' + styleExtra + '">';
                sortimentiHtml += '</div>';
            });

            document.getElementById('edit-otprema-sortimenti').innerHTML = sortimentiHtml;

            var inputIds = ['edit-otprema-FL-ƒå', 'edit-otprema-I-ƒå', 'edit-otprema-II-ƒå', 'edit-otprema-III-ƒå', 'edit-otprema-RUDNO',
                           'edit-otprema-CEL.DUGA', 'edit-otprema-CEL.CIJEPANA',
                           'edit-otprema-FL-L', 'edit-otprema-I-L', 'edit-otprema-II-L', 'edit-otprema-III-L',
                           'edit-otprema-OGR.DUGI', 'edit-otprema-OGR.CIJEPANI'];

            inputIds.forEach(function(inputId) {
                var element = document.getElementById(inputId);
                if (element) {
                    element.addEventListener('input', calculateEditOtprema);
                }
            });

            calculateEditOtprema();
        }

        function calculateEditOtprema() {
            var flC = parseFloat(document.getElementById('edit-otprema-FL-ƒå').value) || 0;
            var iC = parseFloat(document.getElementById('edit-otprema-I-ƒå').value) || 0;
            var iiC = parseFloat(document.getElementById('edit-otprema-II-ƒå').value) || 0;
            var iiiC = parseFloat(document.getElementById('edit-otprema-III-ƒå').value) || 0;
            var rudno = parseFloat(document.getElementById('edit-otprema-RUDNO').value) || 0;
            var celDuga = parseFloat(document.getElementById('edit-otprema-CEL.DUGA').value) || 0;
            var celCijepana = parseFloat(document.getElementById('edit-otprema-CEL.CIJEPANA').value) || 0;

            var trupciC = flC + iC + iiC + iiiC + rudno;
            document.getElementById('edit-otprema-TRUPCI-ƒå').value = trupciC.toFixed(2);

            var cetinari = celDuga + celCijepana + trupciC;
            document.getElementById('edit-otprema-ƒåETINARI').value = cetinari.toFixed(2);

            var flL = parseFloat(document.getElementById('edit-otprema-FL-L').value) || 0;
            var iL = parseFloat(document.getElementById('edit-otprema-I-L').value) || 0;
            var iiL = parseFloat(document.getElementById('edit-otprema-II-L').value) || 0;
            var iiiL = parseFloat(document.getElementById('edit-otprema-III-L').value) || 0;
            var ogrDugi = parseFloat(document.getElementById('edit-otprema-OGR.DUGI').value) || 0;
            var ogrCijepani = parseFloat(document.getElementById('edit-otprema-OGR.CIJEPANI').value) || 0;

            var trupciL = flL + iL + iiL + iiiL;
            document.getElementById('edit-otprema-TRUPCI').value = trupciL.toFixed(2);

            var liscari = ogrDugi + ogrCijepani + trupciL;
            document.getElementById('edit-otprema-LI≈†ƒÜARI').value = liscari.toFixed(2);

            var sveukupno = cetinari + liscari;
            document.getElementById('edit-otprema-SVEUKUPNO').value = sveukupno.toFixed(2);
        }

        async function submitEditOtprema(event) {
            event.preventDefault();

            var submitBtn = document.getElementById('submit-edit-otprema-btn');
            var messageDiv = document.getElementById('edit-otprema-message');

            submitBtn.disabled = true;
            submitBtn.textContent = 'A≈æuriranje...';
            messageDiv.classList.add('hidden');

            try {
                var formData = new URLSearchParams();
                formData.append('path', 'update-pending');
                formData.append('username', currentUser.username);
                formData.append('password', currentPassword);
                formData.append('tip', 'otprema');
                formData.append('rowIndex', document.getElementById('edit-otprema-rowIndex').value);
                formData.append('datum', document.getElementById('edit-otprema-datum').value);
                formData.append('odjel', document.getElementById('edit-otprema-odjel').value);
                formData.append('kupac', document.getElementById('edit-otprema-kupac').value);
                formData.append('brojOtpremnice', document.getElementById('edit-otprema-broj-otpremnice').value);

                var sortimentiKeys = ['F/L ƒå', 'I ƒå', 'II ƒå', 'III ƒå', 'RUDNO', 'TRUPCI ƒå', 'CEL.DUGA', 'CEL.CIJEPANA', 'ƒåETINARI',
                                     'F/L L', 'I L', 'II L', 'III L', 'TRUPCI', 'OGR.DUGI', 'OGR.CIJEPANI', 'LI≈†ƒÜARI'];

                sortimentiKeys.forEach(function(key) {
                    var fieldId = 'edit-otprema-' + key.replace(/\//g, '').replace(/ /g, '-');
                    var value = document.getElementById(fieldId).value;
                    formData.append(key, value);
                });

                var url = API_URL + '?' + formData.toString();
                var response = await fetch(url);
                var result = await response.json();

                if (result.success) {
                    messageDiv.innerHTML = '‚úÖ ' + result.message + '<br>Ukupno: ' + result.ukupno.toFixed(2) + ' m¬≥';
                    messageDiv.style.background = '#dbeafe';
                    messageDiv.style.color = '#1e40af';
                    messageDiv.classList.remove('hidden');

                    setTimeout(function() {
                        switchTab('my-otpreme');
                    }, 2000);
                } else {
                    throw new Error(result.error || 'Unknown error');
                }

            } catch (error) {
                messageDiv.innerHTML = '‚ùå Gre≈°ka: ' + error.message;
                messageDiv.style.background = '#fee2e2';
                messageDiv.style.color = '#991b1b';
                messageDiv.classList.remove('hidden');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Saƒçuvaj izmjene';
            }
        }

        function cancelEditOtprema() {
            switchTab('my-otpreme');
        }

        // Delete functions
        async function deleteMySjeca(rowIndex) {
            showConfirmModal(
                'Potvrda brisanja',
                'Da li ste sigurni da ≈æelite obrisati ovaj unos sjeƒçe?',
                async function() {
                    try {
                        var formData = new URLSearchParams();
                        formData.append('path', 'delete-pending');
                        formData.append('username', currentUser.username);
                        formData.append('password', currentPassword);
                        formData.append('tip', 'sjeca');
                        formData.append('rowIndex', rowIndex);

                        var url = API_URL + '?' + formData.toString();
                        var response = await fetch(url);
                        var result = await response.json();

                        if (result.success) {
                            showSuccess('Uspjeh', result.message);
                            loadMySjece();
                        } else {
                            throw new Error(result.error || 'Unknown error');
                        }
                    } catch (error) {
                        showError('Gre≈°ka', error.message);
                    }
                }
            );
        }

        async function deleteMyOtprema(rowIndex) {
            showConfirmModal(
                'Potvrda brisanja',
                'Da li ste sigurni da ≈æelite obrisati ovaj unos otpreme?',
                async function() {
                    try {
                        var formData = new URLSearchParams();
                        formData.append('path', 'delete-pending');
                        formData.append('username', currentUser.username);
                        formData.append('password', currentPassword);
                        formData.append('tip', 'otprema');
                        formData.append('rowIndex', rowIndex);

                        var url = API_URL + '?' + formData.toString();
                        var response = await fetch(url);
                        var result = await response.json();

                        if (result.success) {
                            showSuccess('Uspjeh', result.message);
                            loadMyOtpreme();
                        } else {
                            throw new Error(result.error || 'Unknown error');
                        }
                    } catch (error) {
                        showError('Gre≈°ka', error.message);
                    }
                }
            );
        }

        // ============================================
        // MODAL FUNCTIONS
        // ============================================

        let confirmCallback = null;

        function showConfirmModal(title, message, onConfirm) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-body').textContent = message;
            confirmCallback = onConfirm;
            document.getElementById('confirm-modal').classList.add('show');

            document.getElementById('modal-confirm-btn').onclick = function() {
                if (confirmCallback) confirmCallback();
                closeConfirmModal();
            };
        }

        function closeConfirmModal() {
            document.getElementById('confirm-modal').classList.remove('show');
            confirmCallback = null;
        }

        // Close modal on overlay click
        document.getElementById('confirm-modal').addEventListener('click', function(e) {
            if (e.target.id === 'confirm-modal') {
                closeConfirmModal();
            }
        });

        // ============================================
        // FILTER FUNCTIONS
        // ============================================

        let unfilteredPendingData = [];

        function applyFilters() {
            const datumOd = document.getElementById('filter-datum-od')?.value;
            const datumDo = document.getElementById('filter-datum-do')?.value;
            const tip = document.getElementById('filter-tip')?.value;
            const search = document.getElementById('filter-search')?.value.toLowerCase();

            let filtered = [...unfilteredPendingData];

            // Filter by date range
            if (datumOd) {
                filtered = filtered.filter(item => {
                    const itemDate = new Date(item.timestampObj);
                    return itemDate >= new Date(datumOd);
                });
            }
            if (datumDo) {
                filtered = filtered.filter(item => {
                    const itemDate = new Date(item.timestampObj);
                    return itemDate <= new Date(datumDo + 'T23:59:59');
                });
            }

            // Filter by type
            if (tip) {
                filtered = filtered.filter(item => item.tip === tip);
            }

            // Filter by search text
            if (search) {
                filtered = filtered.filter(item => {
                    const searchText = (
                        (item.odjel || '') + ' ' +
                        (item.radnik || '') + ' ' +
                        (item.kupac || '')
                    ).toLowerCase();
                    return searchText.includes(search);
                });
            }

            // Re-render table with filtered data
            renderPendingTable(filtered);
        }

        function clearFilters() {
            const filterDatumOd = document.getElementById('filter-datum-od');
            const filterDatumDo = document.getElementById('filter-datum-do');
            const filterTip = document.getElementById('filter-tip');
            const filterSearch = document.getElementById('filter-search');

            if (filterDatumOd) filterDatumOd.value = '';
            if (filterDatumDo) filterDatumDo.value = '';
            if (filterTip) filterTip.value = '';
            if (filterSearch) filterSearch.value = '';

            renderPendingTable(unfilteredPendingData);
        }

        // ============================================
        // ROW ACTIONS DROPDOWN
        // ============================================

        function toggleRowActions(id) {
            const dropdown = document.getElementById('row-actions-' + id);
            const allDropdowns = document.querySelectorAll('.row-actions-dropdown');

            // Close all other dropdowns
            allDropdowns.forEach(d => {
                if (d.id !== 'row-actions-' + id) {
                    d.classList.remove('show');
                }
            });

            // Toggle this dropdown
            dropdown.classList.toggle('show');
        }

        // Close row actions when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.row-actions')) {
                const allDropdowns = document.querySelectorAll('.row-actions-dropdown');
                allDropdowns.forEach(d => d.classList.remove('show'));
            }
        });
    </script>
</body>
</html>
