<!DOCTYPE html>
<html lang="bs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>≈†umarija - Preglednik</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #F6F7F9; min-height: 100vh; color: #1f2937; }
        .login-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; }
        .login-box { background: white; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); padding: 40px; max-width: 400px; width: 100%; }
        .login-box h1 { text-align: center; font-size: 64px; margin-bottom: 16px; }
        .login-box h2 { text-align: center; font-size: 32px; font-weight: bold; color: #1f2937; margin-bottom: 8px; }
        .login-box p { text-align: center; color: #6b7280; margin-bottom: 30px; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 4px; }
        .form-group input { width: 100%; padding: 12px 16px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 16px; }
        .btn { width: 100%; background: #059669; color: white; padding: 12px; border-radius: 8px; border: none; font-size: 16px; font-weight: 600; cursor: pointer; }
        .btn:hover { background: #047857; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .error { background: #fee2e2; border: 1px solid #fecaca; color: #991b1b; padding: 12px; border-radius: 8px; font-size: 14px; margin-bottom: 16px; }
        .header { background: white; color: #1f2937; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 16px 24px; border-bottom: 1px solid #e5e7eb; }
        .header-content { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px; }
        .header-left { display: flex; align-items: center; gap: 12px; }
        .header-logo { font-size: 28px; }
        .header-title h1 { font-size: 18px; font-weight: 700; margin-bottom: 2px; color: #047857; }
        .header-title p { font-size: 12px; color: #6b7280; }
        .header-right { display: flex; align-items: center; gap: 16px; }
        .header-user { text-align: right; }
        .header-user-name { font-size: 13px; font-weight: 600; color: #1f2937; }
        .header-user-role { font-size: 11px; color: #6b7280; }
        .user-menu { position: relative; }
        .user-menu-button { background: #f3f4f6; color: #374151; padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .user-menu-button:hover { background: #e5e7eb; }
        .user-menu-dropdown { display: none; position: absolute; right: 0; top: 100%; margin-top: 8px; background: white; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); min-width: 200px; z-index: 1000; }
        .user-menu-dropdown.show { display: block; }
        .user-menu-item { padding: 12px 16px; cursor: pointer; font-size: 14px; color: #374151; border-bottom: 1px solid #f3f4f6; }
        .user-menu-item:hover { background: #f9fafb; }
        .user-menu-item:last-child { border-bottom: none; }
        .user-menu-item.danger { color: #dc2626; }
        .user-menu-item.danger:hover { background: #fee2e2; }
        .btn-logout { background: #dc2626; color: white; padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-size: 13px; font-weight: 600; }
        .btn-logout:hover { background: #b91c1c; }
        .container { max-width: 1200px; margin: 0 auto; padding: 32px 24px; }
        .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 28px; }
        .card { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 24px; border: 1px solid #f3f4f6; transition: all 0.2s; }
        .card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-color: #e5e7eb; }
        .card-label { font-size: 13px; color: #6b7280; margin-bottom: 8px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.05em; }
        .card-value { font-size: 32px; font-weight: 700; }
        .card-value.green { color: #059669; }
        .card-value.blue { color: #2563eb; }
        .card-value.red { color: #dc2626; }
        .section { background: white; border-radius: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 32px; margin-bottom: 24px; }
        .section h2 { font-size: 20px; font-weight: bold; margin-bottom: 8px; color: #1f2937; }
        .section p { font-size: 14px; color: #6b7280; margin-bottom: 24px; }

        /* Page Header */
        .page-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px; flex-wrap: wrap; gap: 16px; }
        .page-header-left h1 { font-size: 24px; font-weight: 700; color: #1f2937; margin-bottom: 4px; }
        .page-header-left p { font-size: 14px; color: #6b7280; }
        .page-header-right { display: flex; gap: 8px; align-items: center; }
        .badge { display: inline-block; padding: 6px 12px; background: #e0e7ff; color: #3730a3; border-radius: 12px; font-size: 12px; font-weight: 600; }
        .badge.success { background: #d1fae5; color: #047857; }
        .badge.warning { background: #fef3c7; color: #92400e; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; }
        thead { background: #f9fafb; position: sticky; top: 0; z-index: 10; }
        thead::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 2px; background: #e5e7eb; }
        th { padding: 14px 12px; text-align: left; font-size: 11px; font-weight: 700; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; white-space: nowrap; }
        th.right { text-align: right; }
        td { padding: 14px 12px; font-size: 14px; border-bottom: 1px solid #f3f4f6; color: #374151; }
        td.right { text-align: right; font-variant-numeric: tabular-nums; font-weight: 500; }
        tbody tr:nth-child(even) { background: #f9fafb; }
        tbody tr:hover { background: #f0f9ff; }
        td.green { color: #059669; }
        td.blue { color: #2563eb; }
        td.red { color: #dc2626; }
        .loading { text-align: center; padding: 60px 20px; }
        .loading-icon { font-size: 48px; margin-bottom: 16px; }
        .loading-text { font-size: 18px; color: #374151; font-weight: 600; }
        .loading-sub { font-size: 14px; color: #6b7280; margin-top: 8px; }
        .hidden { display: none; }
        .chart-container { margin-top: 20px; }
        .bar { display: flex; gap: 8px; margin-bottom: 12px; align-items: center; }
        .bar-label { width: 100px; font-size: 13px; color: #374151; font-weight: 500; }
        .bar-group { flex: 1; display: flex; gap: 4px; }
        .bar-item { height: 30px; border-radius: 4px; display: flex; align-items: center; justify-content: flex-end; padding: 0 8px; color: white; font-size: 12px; font-weight: 600; }
        .bar-item.green { background: #059669; }
        .bar-item.blue { background: #2563eb; }
        .chart-svg { width: 100%; height: 300px; margin-top: 20px; }
        .monthly-table { margin-top: 20px; }
        .monthly-table tbody tr:hover { background: #f9fafb; }
        .progress-bar-container { background: #e5e7eb; height: 8px; border-radius: 4px; overflow: hidden; margin-top: 4px; }
        .progress-bar-fill { background: #059669; height: 100%; border-radius: 4px; transition: width 0.3s ease; }
        .odjel-detail { font-size: 12px; color: #6b7280; margin-top: 4px; }
        .line-legend { display: flex; gap: 20px; justify-content: center; margin-bottom: 16px; font-size: 14px; }
        .line-legend-item { display: flex; align-items: center; gap: 8px; }
        .line-legend-color { width: 30px; height: 3px; border-radius: 2px; }
        .line-legend-color.green { background: #059669; }
        .line-legend-color.blue { background: #2563eb; }

        /* Tabs navigation */
        .tabs-container { background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-bottom: 1px solid #e5e7eb; }
        .tabs { max-width: 1200px; margin: 0 auto; display: flex; gap: 4px; padding: 0 24px; overflow-x: auto; }
        .tab { background: transparent; border: none; padding: 14px 20px; font-size: 14px; font-weight: 600; color: #6b7280; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; white-space: nowrap; }
        .tab:hover { color: #374151; background: #f9fafb; }
        .tab.active { color: #047857; border-bottom-color: #047857; background: #f0fdf4; }

        /* Summary cards */
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 28px; }
        .summary-card { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #f3f4f6; transition: all 0.2s; }
        .summary-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-color: #e5e7eb; }
        .summary-card-title { font-size: 12px; color: #6b7280; margin-bottom: 8px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
        .summary-card-value { font-size: 28px; font-weight: 700; color: #1f2937; font-variant-numeric: tabular-nums; }
        .summary-card-subtitle { font-size: 12px; color: #9ca3af; margin-top: 6px; }
        .summary-card.green .summary-card-value { color: #059669; }
        .summary-card.blue .summary-card-value { color: #2563eb; }
        .summary-card.red .summary-card-value { color: #dc2626; }

        /* Chart container */
        .chart-container { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 24px; height: 400px; }

        /* Search and controls */
        .controls-bar { display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; align-items: center; }
        .search-input { padding: 10px 16px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; flex: 1; min-width: 200px; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: #047857; color: white; }
        .btn-primary:hover { background: #059669; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-secondary:hover { background: #4b5563; }

        /* Filter Bar - Advanced */
        .filter-bar { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        .filter-bar-title { font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.05em; }
        .filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; }
        .filter-group { display: flex; flex-direction: column; gap: 6px; }
        .filter-label { font-size: 12px; font-weight: 600; color: #6b7280; }
        .filter-input, .filter-select { padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; background: white; color: #1f2937; }
        .filter-input:focus, .filter-select:focus { outline: none; border-color: #047857; box-shadow: 0 0 0 3px rgba(4, 120, 87, 0.1); }
        .filter-actions { display: flex; gap: 8px; align-items: flex-end; }
        .filter-actions .btn { padding: 10px 16px; font-size: 13px; }
        .btn-clear { background: #f3f4f6; color: #374151; }
        .btn-clear:hover { background: #e5e7eb; }

        /* Row Actions Dropdown */
        .row-actions { position: relative; }
        .row-actions-btn { background: transparent; border: none; cursor: pointer; padding: 8px; border-radius: 6px; color: #6b7280; font-size: 18px; line-height: 1; }
        .row-actions-btn:hover { background: #f3f4f6; color: #374151; }
        .row-actions-dropdown { display: none; position: absolute; right: 0; top: 100%; margin-top: 4px; background: white; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); min-width: 160px; z-index: 100; border: 1px solid #e5e7eb; }
        .row-actions-dropdown.show { display: block; }
        .row-actions-item { padding: 10px 14px; cursor: pointer; font-size: 13px; color: #374151; border-bottom: 1px solid #f3f4f6; display: flex; align-items: center; gap: 8px; }
        .row-actions-item:hover { background: #f9fafb; }
        .row-actions-item:last-child { border-bottom: none; }
        .row-actions-item.danger { color: #dc2626; }
        .row-actions-item.danger:hover { background: #fee2e2; }

        /* Confirm Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal-overlay.show { display: flex; }
        .modal { background: white; border-radius: 16px; padding: 24px; max-width: 400px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .modal-header { margin-bottom: 16px; }
        .modal-title { font-size: 18px; font-weight: 700; color: #1f2937; }
        .modal-body { margin-bottom: 24px; font-size: 14px; color: #6b7280; line-height: 1.6; }
        .modal-footer { display: flex; gap: 12px; justify-content: flex-end; }
        .modal-footer .btn { padding: 10px 20px; }
        .btn-danger { background: #dc2626; color: white; }
        .btn-danger:hover { background: #b91c1c; }

        /* Column Grouping */
        .col-group-cetinari { background: linear-gradient(to bottom, #f0fdf4 0%, #dcfce7 100%); border-left: 2px solid #10b981; border-right: 2px solid #10b981; }
        .col-group-liscari { background: linear-gradient(to bottom, #fef3c7 0%, #fde68a 100%); border-left: 2px solid #f59e0b; border-right: 2px solid #f59e0b; }
        body.dark-mode .col-group-cetinari { background: linear-gradient(to bottom, #064e3b 0%, #065f46 100%); }
        body.dark-mode .col-group-liscari { background: linear-gradient(to bottom, #78350f 0%, #92400e 100%); }

        /* Dark mode */
        body.dark-mode { background: #1f2937; color: #f3f4f6; }
        body.dark-mode .container, body.dark-mode .section, body.dark-mode table,
        body.dark-mode .summary-card, body.dark-mode .chart-container,
        body.dark-mode .tabs-container { background: #374151; color: #f3f4f6; border-color: #4b5563; }
        body.dark-mode table thead { background: #1f2937; }
        body.dark-mode .search-input { background: #4b5563; color: #f3f4f6; border-color: #6b7280; }

        /* Progress bar in table */
        .table-progress-bar { background: #e5e7eb; height: 4px; border-radius: 2px; overflow: hidden; margin-top: 4px; }
        .table-progress-fill { background: #059669; height: 100%; border-radius: 2px; }

        /* Kupci tables optimization */
        .kupci-table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; margin: 0 -24px; padding: 0 24px; }
        .kupci-table { font-size: 11px; white-space: nowrap; width: 100%; border-collapse: separate; border-spacing: 0; }
        .kupci-table th, .kupci-table td { padding: 8px 6px; border-bottom: 1px solid #e5e7eb; }
        .kupci-table th:first-child, .kupci-table td:first-child {
            position: sticky; left: 0; background: white; z-index: 2;
            min-width: 140px; max-width: 200px; white-space: normal;
            border-right: 2px solid #d1d5db; padding-right: 12px; font-weight: 600;
        }
        .kupci-table th:nth-child(2), .kupci-table td:nth-child(2) {
            position: sticky; left: 140px; background: white; z-index: 2;
            min-width: 90px; border-right: 2px solid #d1d5db; font-weight: 500;
        }
        body.dark-mode .kupci-table th:first-child, body.dark-mode .kupci-table td:first-child,
        body.dark-mode .kupci-table th:nth-child(2), body.dark-mode .kupci-table td:nth-child(2) { background: #374151; }
        .kupci-table thead th {
            background: linear-gradient(to bottom, #f9fafb 0%, #f3f4f6 100%);
            position: sticky; top: 0; z-index: 3; font-weight: 700;
            border-top: 2px solid #10b981; border-bottom: 2px solid #10b981;
            padding: 12px 6px; text-transform: uppercase; font-size: 10px; letter-spacing: 0.5px;
        }
        body.dark-mode .kupci-table thead th { background: linear-gradient(to bottom, #1f2937 0%, #111827 100%); }
        .kupci-table tbody tr:nth-child(even) { background: #f9fafb; }
        body.dark-mode .kupci-table tbody tr:nth-child(even) { background: #2d3748; }
        .kupci-table tbody tr:hover { background: #f0fdf4; }
        body.dark-mode .kupci-table tbody tr:hover { background: #064e3b; }
        .kupci-table tbody tr:nth-child(even):hover { background: #ecfdf5; }
        body.dark-mode .kupci-table tbody tr:nth-child(even):hover { background: #065f46; }
        .kupci-table .sortiment-col { min-width: 62px; max-width: 75px; text-align: right; font-family: 'Courier New', monospace; }
        .kupci-table .ukupno-col {
            font-weight: bold; background: linear-gradient(to right, #f0fdf4 0%, #dcfce7 100%);
            min-width: 95px; border-left: 3px solid #10b981; text-align: right;
            font-size: 12px; font-family: 'Courier New', monospace;
        }
        body.dark-mode .kupci-table .ukupno-col { background: linear-gradient(to right, #064e3b 0%, #065f46 100%); }
        .kupci-table .totals-row {
            background: linear-gradient(to bottom, #dcfce7 0%, #bbf7d0 100%);
            font-weight: 700; font-size: 12px; border-top: 3px solid #10b981;
        }
        body.dark-mode .kupci-table .totals-row { background: linear-gradient(to bottom, #065f46 0%, #047857 100%); }
        .kupci-table .totals-row td { border-bottom: 3px solid #10b981; padding: 12px 6px; }

        /* ============================================
           MOBILE OPTIMIZATIONS (< 768px)
           ============================================ */
        @media (max-width: 768px) {
            /* Container & spacing */
            .container { padding: 12px; max-width: 100%; }
            .section { padding: 16px; margin-bottom: 16px; }
            .section h2 { font-size: 18px; margin-bottom: 12px; }

            /* Header */
            .header { flex-direction: column; gap: 12px; padding: 16px 12px; }
            .header-logo h1 { font-size: 20px; }
            .header-logo p { font-size: 13px; }
            .header-user { font-size: 12px; }
            .btn-logout { padding: 8px 16px; font-size: 13px; }

            /* Tabs - scrollable horizontal */
            .tabs { overflow-x: auto; -webkit-overflow-scrolling: touch; gap: 2px; padding: 0 12px; white-space: nowrap; }
            .tab { padding: 12px 16px; font-size: 13px; flex-shrink: 0; }

            /* Summary cards - stack vertically */
            .summary-cards { grid-template-columns: 1fr; gap: 12px; }
            .summary-card { padding: 16px; }
            .summary-card-title { font-size: 12px; }
            .summary-card-value { font-size: 24px; }

            /* Chart */
            .chart-container { height: 280px; padding: 16px; }

            /* Controls bar - stack vertically */
            .controls-bar { flex-direction: column; gap: 8px; }
            .search-input { width: 100%; min-width: auto; }
            .btn { width: 100%; padding: 12px; }

            /* Tables */
            table { font-size: 11px; }
            table th, table td { padding: 6px 4px; }
            .monthly-table th, .monthly-table td { font-size: 10px; padding: 6px 3px; }

            /* Kupci tables - optimized for mobile */
            .kupci-table-wrapper { margin: 0 -12px; padding: 0 12px; }
            .kupci-table { font-size: 10px; }
            .kupci-table th, .kupci-table td { padding: 6px 3px; }
            .kupci-table th:first-child, .kupci-table td:first-child {
                min-width: 100px; max-width: 140px; font-size: 10px;
            }
            .kupci-table th:nth-child(2), .kupci-table td:nth-child(2) {
                left: 100px; min-width: 70px; font-size: 10px;
            }
            .kupci-table thead th { font-size: 9px; padding: 8px 3px; }
            .kupci-table .sortiment-col { min-width: 50px; max-width: 60px; font-size: 10px; }
            .kupci-table .ukupno-col { min-width: 75px; font-size: 10px; }
            .kupci-table .totals-row { font-size: 10px; }

            /* Login */
            .login-box { padding: 30px 24px; }
            .login-box h1 { font-size: 48px; }
            .login-box h2 { font-size: 24px; }

            /* Loading */
            .loading-icon { font-size: 48px; }
            .loading-text { font-size: 16px; }

            /* Hide dark mode button text on mobile */
            .btn[onclick="toggleDarkMode()"] { font-size: 20px; padding: 8px 12px; }
        }

        /* Extra small devices (< 480px) */
        @media (max-width: 480px) {
            .section h2 { font-size: 16px; }
            .header-logo h1 { font-size: 18px; }
            .tab { padding: 10px 12px; font-size: 12px; }
            .summary-card-value { font-size: 20px; }
            .chart-container { height: 240px; padding: 12px; }

            .kupci-table { font-size: 9px; }
            .kupci-table th:first-child, .kupci-table td:first-child {
                min-width: 90px; max-width: 120px; font-size: 9px;
            }
            .kupci-table th:nth-child(2), .kupci-table td:nth-child(2) {
                left: 90px; min-width: 60px; font-size: 9px;
            }
            .kupci-table .sortiment-col { min-width: 45px; font-size: 9px; }
            .kupci-table .ukupno-col { min-width: 70px; font-size: 9px; }
        }

        /* Cache indicator */
        .cache-indicator {
            padding: 12px 24px;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            border-bottom: 2px solid #e5e7eb;
            transition: all 0.3s ease;
        }
        .btn-clear-cache {
            background: #f59e0b;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }
        .btn-clear-cache:hover {
            background: #d97706;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <div id="login-screen" class="login-container">
        <div class="login-box">
            <h1>üå≤</h1>
            <h2>≈†umarija</h2>
            <p>Evidencija sjeƒçe i otpreme</p>
            
            <form id="login-form">
                <div id="error-msg" class="error hidden"></div>
                
                <div class="form-group">
                    <label>Korisniƒçko ime</label>
                    <input type="text" id="username" placeholder="Email ili username" required>
                </div>
                
                <div class="form-group">
                    <label>≈†ifra</label>
                    <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                
                <button type="submit" class="btn" id="login-btn">Prijavi se</button>
            </form>
        </div>
    </div>
    
    <div id="app-screen" class="hidden">
        <div class="header">
            <div class="header-content">
                <div class="header-left">
                    <div class="header-logo">üå≤</div>
                    <div class="header-title">
                        <h1>Pogon gospodarenja Bos. Krupa</h1>
                        <p>Evidencija sjeƒçe i otpreme</p>
                    </div>
                </div>
                <div class="header-right">
                    <div class="header-user">
                        <div class="header-user-name" id="user-name"></div>
                        <div class="header-user-role" id="user-role"></div>
                    </div>
                    <div class="user-menu">
                        <button class="user-menu-button" onclick="toggleUserMenu()">
                            <span>‚öôÔ∏è</span>
                            <span>Meni</span>
                        </button>
                        <div class="user-menu-dropdown" id="user-menu-dropdown">
                            <div class="user-menu-item" onclick="toggleDarkMode(); toggleUserMenu();">üåô Dark Mode</div>
                            <div class="user-menu-item" onclick="clearAllCache()">üóëÔ∏è Obri≈°i ke≈°</div>
                            <div class="user-menu-item danger" onclick="logout()">üö™ Odjavi se</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cache indicator -->
        <div id="cache-indicator" class="cache-indicator hidden"></div>

        <div class="tabs-container">
            <div class="tabs" id="tabs-menu">
                <!-- Tabs will be dynamically populated based on user type -->
            </div>
        </div>

        <div id="loading-screen" class="loading">
            <div class="loading-icon">‚è≥</div>
            <div class="loading-text">Uƒçitavam podatke...</div>
            <div class="loading-sub">Ovo mo≈æe trajati 2-3 sekunde</div>
        </div>
        
        <!-- DASHBOARD CONTENT (≈†umarija Krupa) -->
        <div id="dashboard-content" class="container hidden">
            <!-- Summary Cards -->
            <div class="summary-cards" id="summary-cards"></div>

            <!-- Monthly Table -->
            <div class="section">
                <h2>üìä Mjeseƒçni pregled</h2>
                <div class="controls-bar">
                    <input type="text" class="search-input" id="dashboard-search" placeholder="üîç Pretra≈æi po mjesecu..." onkeyup="filterDashboardTable()">
                    <button class="btn btn-primary" onclick="exportTableToCSV('dashboard')">üì• Export CSV</button>
                </div>
                <table class="monthly-table" id="dashboard-table">
                    <thead>
                        <tr>
                            <th onclick="sortTable(0, 'dashboard-table')">Mjesec ‚áÖ</th>
                            <th class="right" onclick="sortTable(1, 'dashboard-table')">Ukupna Sjeƒça (m¬≥) ‚áÖ</th>
                            <th class="right" onclick="sortTable(2, 'dashboard-table')">Ukupna Otprema (m¬≥) ‚áÖ</th>
                            <th class="right" onclick="sortTable(3, 'dashboard-table')">≈†uma Panj+Meƒëustovari≈°te ‚áÖ</th>
                            <th class="right" onclick="sortTable(4, 'dashboard-table')">Dinamika ‚áÖ</th>
                            <th class="right" onclick="sortTable(5, 'dashboard-table')">Razlika Sjeƒça - Dinamika ‚áÖ</th>
                            <th class="right" onclick="sortTable(6, 'dashboard-table')">Razlika Otprema - Dinamika ‚áÖ</th>
                        </tr>
                    </thead>
                    <tbody id="dashboard-monthly-table"></tbody>
                </table>
            </div>

            <!-- Odjeli Table -->
            <div class="section">
                <h2>üè≠ Pregled po odjelima</h2>
                <div class="controls-bar">
                    <input type="text" class="search-input" id="odjeli-search" placeholder="üîç Pretra≈æi po odjelu..." onkeyup="filterOdjeliTable()">
                    <button class="btn btn-primary" onclick="exportTableToCSV('odjeli')">üì• Export CSV</button>
                </div>
                <table class="monthly-table" id="odjeli-table">
                    <thead>
                        <tr>
                            <th onclick="sortTable(0, 'odjeli-table')">Odjel ‚áÖ</th>
                            <th class="right" onclick="sortTable(1, 'odjeli-table')">Sjeƒça (m¬≥) ‚áÖ</th>
                            <th class="right" onclick="sortTable(2, 'odjeli-table')">Otprema (m¬≥) ‚áÖ</th>
                            <th class="right" onclick="sortTable(3, 'odjeli-table')">≈†uma Panj+Meƒëustovari≈°te ‚áÖ</th>
                            <th onclick="sortTable(4, 'odjeli-table')">Radili≈°te ‚áÖ</th>
                            <th onclick="sortTable(5, 'odjeli-table')">Izvoƒëaƒç Radova ‚áÖ</th>
                            <th onclick="sortTable(6, 'odjeli-table')">Datum Zadnje Sjeƒçe ‚áÖ</th>
                            <th class="right" onclick="sortTable(7, 'odjeli-table')">Realizacija % ‚áÖ</th>
                        </tr>
                    </thead>
                    <tbody id="odjeli-table-body"></tbody>
                </table>
            </div>

            <!-- Chart -->
            <div class="section">
                <h2>üìà Trendovi sjeƒçe i otpreme</h2>
                <div class="chart-container">
                    <canvas id="trendsChart"></canvas>
                </div>
            </div>
        </div>

        <!-- PRIMACI CONTENT (Prikaz po primaƒçima) -->
        <div id="primaci-content" class="container hidden">
            <div class="section">
                <h2>üë∑ Mjeseƒçni prikaz po primaƒçima</h2>
                <div class="controls-bar">
                    <input type="text" class="search-input" id="primaci-search" placeholder="üîç Pretra≈æi po imenu primaƒça..." onkeyup="filterPrimaciTable()">
                    <button class="btn btn-primary" onclick="exportTableToCSV('primaci')">üì• Export CSV</button>
                </div>
                <table class="monthly-table" id="primaci-table">
                    <thead id="primaci-header"></thead>
                    <tbody id="primaci-body"></tbody>
                </table>
            </div>
        </div>

        <!-- OTPREMACI CONTENT (Prikaz po otpremaƒçima) -->
        <div id="otpremaci-content" class="container hidden">
            <div class="section">
                <h2>üöõ Mjeseƒçni prikaz po otpremaƒçima</h2>
                <div class="controls-bar">
                    <input type="text" class="search-input" id="otpremaci-search" placeholder="üîç Pretra≈æi po imenu otpremaƒça..." onkeyup="filterOtremaciTable()">
                    <button class="btn btn-primary" onclick="exportTableToCSV('otpremaci')">üì• Export CSV</button>
                </div>
                <table class="monthly-table" id="otpremaci-table">
                    <thead id="otpremaci-header"></thead>
                    <tbody id="otpremaci-body"></tbody>
                </table>
            </div>
        </div>

        <!-- KUPCI CONTENT (Prikaz po kupcima) -->
        <div id="kupci-content" class="container hidden">
            <!-- Godi≈°nji pregled -->
            <div class="section">
                <h2>üè¢ Godi≈°nji pregled po kupcima</h2>
                <div class="controls-bar">
                    <input type="text" class="search-input" id="kupci-godisnji-search" placeholder="üîç Pretra≈æi po kupcu..." onkeyup="filterKupciGodisnjiTable()">
                    <button class="btn btn-primary" onclick="exportTableToCSV('kupci-godisnji')">üì• Export CSV</button>
                </div>
                <div class="kupci-table-wrapper">
                    <table class="kupci-table" id="kupci-godisnji-table">
                        <thead id="kupci-godisnji-header"></thead>
                        <tbody id="kupci-godisnji-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- Mjeseƒçni pregled -->
            <div class="section">
                <h2>üìÖ Mjeseƒçni pregled po kupcima</h2>
                <div class="controls-bar">
                    <input type="text" class="search-input" id="kupci-mjesecni-search" placeholder="üîç Pretra≈æi po kupcu..." onkeyup="filterKupciMjesecniTable()">
                    <button class="btn btn-primary" onclick="exportTableToCSV('kupci-mjesecni')">üì• Export CSV</button>
                </div>
                <div class="kupci-table-wrapper">
                    <table class="kupci-table" id="kupci-mjesecni-table">
                        <thead id="kupci-mjesecni-header"></thead>
                        <tbody id="kupci-mjesecni-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- PRIMAC PERSONAL VIEW -->
        <div id="primac-personal-content" class="container hidden">
            <div class="section">
                <h2>üë∑ Pregled sjeƒçe u tekuƒáoj godini</h2>
                <div class="controls-bar">
                    <input type="text" class="search-input" id="primac-personal-search" placeholder="üîç Pretra≈æi po odjelu..." onkeyup="filterPrimacPersonalTable()">
                    <button class="btn btn-primary" onclick="exportTableToCSV('primac-personal')">üì• Export CSV</button>
                </div>
                <div class="kupci-table-wrapper">
                    <table class="kupci-table" id="primac-personal-table">
                        <thead id="primac-personal-header"></thead>
                        <tbody id="primac-personal-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- OTPREMAC PERSONAL VIEW -->
        <div id="otpremac-personal-content" class="container hidden">
            <div class="section">
                <h2>üöõ Pregled otpreme u tekuƒáoj godini</h2>
                <div class="controls-bar">
                    <input type="text" class="search-input" id="otpremac-personal-search" placeholder="üîç Pretra≈æi po odjelu/kupcu..." onkeyup="filterOtpremacPersonalTable()">
                    <button class="btn btn-primary" onclick="exportTableToCSV('otpremac-personal')">üì• Export CSV</button>
                </div>
                <div class="kupci-table-wrapper">
                    <table class="kupci-table" id="otpremac-personal-table">
                        <thead id="otpremac-personal-header"></thead>
                        <tbody id="otpremac-personal-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- PRIMAC ODJELI VIEW (By Department) -->
        <div id="primac-odjeli-content" class="container hidden">
            <div class="section">
                <h2>üè≠ Prikaz sjeƒçe po odjelima</h2>
                <div id="primac-odjeli-container"></div>
                <div class="controls-bar" style="justify-content: center; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="prevPagePrimacOdjeli()" id="primac-odjeli-prev">‚Üê Prethodna</button>
                    <span style="margin: 0 20px; font-weight: 600;" id="primac-odjeli-page-info">Stranica 1</span>
                    <button class="btn btn-secondary" onclick="nextPagePrimacOdjeli()" id="primac-odjeli-next">Sledeƒáa ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- OTPREMAC ODJELI VIEW (By Department) -->
        <div id="otpremac-odjeli-content" class="container hidden">
            <div class="section">
                <h2>üè≠ Prikaz otpreme po odjelima</h2>
                <div id="otpremac-odjeli-container"></div>
                <div class="controls-bar" style="justify-content: center; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="prevPageOtpremacOdjeli()" id="otpremac-odjeli-prev">‚Üê Prethodna</button>
                    <span style="margin: 0 20px; font-weight: 600;" id="otpremac-odjeli-page-info">Stranica 1</span>
                    <button class="btn btn-secondary" onclick="nextPageOtpremacOdjeli()" id="otpremac-odjeli-next">Sledeƒáa ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- ADD SJECA FORM (For Primaƒçi) -->
        <div id="add-sjeca-content" class="container hidden">
            <div class="section">
                <h2>‚ûï Dodaj novu sjeƒçu</h2>
                <form id="add-sjeca-form" onsubmit="submitSjeca(event)">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label>Datum:</label>
                            <input type="date" id="sjeca-datum" required style="padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>Odjel:</label>
                            <select id="sjeca-odjel" required style="padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; width: 100%;">
                                <option value="">Izaberi odjel...</option>
                            </select>
                        </div>
                    </div>

                    <h3 style="margin: 20px 0 10px 0; color: #047857;">Sortimenti (m¬≥):</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                        <div class="form-group">
                            <label>F/L ƒå:</label>
                            <input type="number" step="0.01" id="sjeca-FL-C" value="0" min="0" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>I ƒå:</label>
                            <input type="number" step="0.01" id="sjeca-I-C" value="0" min="0" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>II ƒå:</label>
                            <input type="number" step="0.01" id="sjeca-II-C" value="0" min="0" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>III ƒå:</label>
                            <input type="number" step="0.01" id="sjeca-III-C" value="0" min="0" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>RUDNO:</label>
                            <input type="number" step="0.01" id="sjeca-RUDNO" value="0" min="0" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>TRUPCI ƒå: <span style="color: #6b7280; font-size: 0.85em;">(auto)</span></label>
                            <input type="number" step="0.01" id="sjeca-TRUPCI-C" value="0" min="0" readonly style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%; background: #f3f4f6; color: #374151; font-weight: 600;">
                        </div>
                        <div class="form-group">
                            <label>CEL.DUGA:</label>
                            <input type="number" step="0.01" id="sjeca-CEL-DUGA" value="0" min="0" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>CEL.CIJEPANA:</label>
                            <input type="number" step="0.01" id="sjeca-CEL-CIJEPANA" value="0" min="0" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>ƒåETINARI: <span style="color: #6b7280; font-size: 0.85em;">(auto)</span></label>
                            <input type="number" step="0.01" id="sjeca-CETINARI" value="0" min="0" readonly style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%; background: #f3f4f6; color: #374151; font-weight: 600;">
                        </div>
                        <div class="form-group">
                            <label>F/L L:</label>
                            <input type="number" step="0.01" id="sjeca-FL-L" value="0" min="0" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>I L:</label>
                            <input type="number" step="0.01" id="sjeca-I-L" value="0" min="0" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>II L:</label>
                            <input type="number" step="0.01" id="sjeca-II-L" value="0" min="0" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>III L:</label>
                            <input type="number" step="0.01" id="sjeca-III-L" value="0" min="0" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>TRUPCI: <span style="color: #6b7280; font-size: 0.85em;">(auto)</span></label>
                            <input type="number" step="0.01" id="sjeca-TRUPCI" value="0" min="0" readonly style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%; background: #f3f4f6; color: #374151; font-weight: 600;">
                        </div>
                        <div class="form-group">
                            <label>OGR.DUGI:</label>
                            <input type="number" step="0.01" id="sjeca-OGR-DUGI" value="0" min="0" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>OGR.CIJEPANI:</label>
                            <input type="number" step="0.01" id="sjeca-OGR-CIJEPANI" value="0" min="0" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>LI≈†ƒÜARI: <span style="color: #6b7280; font-size: 0.85em;">(auto)</span></label>
                            <input type="number" step="0.01" id="sjeca-LISCARI" value="0" min="0" readonly style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%; background: #f3f4f6; color: #374151; font-weight: 600;">
                        </div>
                    </div>

                    <div style="margin-top: 20px; padding: 20px; background: #fef3c7; border: 2px solid #f59e0b; border-radius: 10px;">
                        <label style="font-size: 1.2em; font-weight: bold; color: #92400e;">SVEUKUPNO (m¬≥):</label>
                        <input type="number" step="0.01" id="sjeca-SVEUKUPNO" value="0" readonly style="padding: 12px; border: 2px solid #f59e0b; border-radius: 8px; width: 100%; background: #fffbeb; color: #92400e; font-size: 1.5em; font-weight: bold; text-align: center;">
                    </div>

                    <div style="margin-top: 30px; display: flex; gap: 12px; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="resetSjecaForm()">Poni≈°ti</button>
                        <button type="submit" class="btn btn-primary" id="submit-sjeca-btn">Dodaj sjeƒçu</button>
                    </div>

                    <div id="sjeca-message" class="hidden" style="margin-top: 20px; padding: 12px; border-radius: 8px;"></div>
                </form>
            </div>
        </div>

        <!-- ADD OTPREMA FORM (For Otpremaƒçi) -->
        <div id="add-otprema-content" class="container hidden">
            <div class="section">
                <h2>‚ûï Dodaj novu otpremu</h2>
                <form id="add-otprema-form" onsubmit="submitOtprema(event)">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label>Datum:</label>
                            <input type="date" id="otprema-datum" required style="padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>Odjel:</label>
                            <select id="otprema-odjel" required style="padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; width: 100%;">
                                <option value="">Izaberi odjel...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Kupac:</label>
                            <input type="text" id="otprema-kupac" placeholder="Naziv kupca" style="padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; width: 100%;">
                        </div>
                    </div>

                    <h3 style="margin: 20px 0 10px 0; color: #2563eb;">Sortimenti (m¬≥):</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                        <div class="form-group">
                            <label>F/L ƒå:</label>
                            <input type="number" step="0.01" id="otprema-FL-C" value="0" min="0" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>I ƒå:</label>
                            <input type="number" step="0.01" id="otprema-I-C" value="0" min="0" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>II ƒå:</label>
                            <input type="number" step="0.01" id="otprema-II-C" value="0" min="0" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>III ƒå:</label>
                            <input type="number" step="0.01" id="otprema-III-C" value="0" min="0" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>RUDNO:</label>
                            <input type="number" step="0.01" id="otprema-RUDNO" value="0" min="0" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>TRUPCI ƒå: <span style="color: #6b7280; font-size: 0.85em;">(auto)</span></label>
                            <input type="number" step="0.01" id="otprema-TRUPCI-C" value="0" min="0" readonly style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%; background: #f3f4f6; color: #374151; font-weight: 600;">
                        </div>
                        <div class="form-group">
                            <label>CEL.DUGA:</label>
                            <input type="number" step="0.01" id="otprema-CEL-DUGA" value="0" min="0" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>CEL.CIJEPANA:</label>
                            <input type="number" step="0.01" id="otprema-CEL-CIJEPANA" value="0" min="0" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>ƒåETINARI: <span style="color: #6b7280; font-size: 0.85em;">(auto)</span></label>
                            <input type="number" step="0.01" id="otprema-CETINARI" value="0" min="0" readonly style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%; background: #f3f4f6; color: #374151; font-weight: 600;">
                        </div>
                        <div class="form-group">
                            <label>F/L L:</label>
                            <input type="number" step="0.01" id="otprema-FL-L" value="0" min="0" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>I L:</label>
                            <input type="number" step="0.01" id="otprema-I-L" value="0" min="0" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>II L:</label>
                            <input type="number" step="0.01" id="otprema-II-L" value="0" min="0" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>III L:</label>
                            <input type="number" step="0.01" id="otprema-III-L" value="0" min="0" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>TRUPCI: <span style="color: #6b7280; font-size: 0.85em;">(auto)</span></label>
                            <input type="number" step="0.01" id="otprema-TRUPCI" value="0" min="0" readonly style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%; background: #f3f4f6; color: #374151; font-weight: 600;">
                        </div>
                        <div class="form-group">
                            <label>OGR.DUGI:</label>
                            <input type="number" step="0.01" id="otprema-OGR-DUGI" value="0" min="0" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>OGR.CIJEPANI:</label>
                            <input type="number" step="0.01" id="otprema-OGR-CIJEPANI" value="0" min="0" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>LI≈†ƒÜARI: <span style="color: #6b7280; font-size: 0.85em;">(auto)</span></label>
                            <input type="number" step="0.01" id="otprema-LISCARI" value="0" min="0" readonly style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%; background: #f3f4f6; color: #374151; font-weight: 600;">
                        </div>
                    </div>

                    <div style="margin-top: 20px; padding: 20px; background: #fef3c7; border: 2px solid #f59e0b; border-radius: 10px;">
                        <label style="font-size: 1.2em; font-weight: bold; color: #92400e;">SVEUKUPNO (m¬≥):</label>
                        <input type="number" step="0.01" id="otprema-SVEUKUPNO" value="0" readonly style="padding: 12px; border: 2px solid #f59e0b; border-radius: 8px; width: 100%; background: #fffbeb; color: #92400e; font-size: 1.5em; font-weight: bold; text-align: center;">
                    </div>

                    <div style="margin-top: 30px; display: flex; gap: 12px; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="resetOtpremaForm()">Poni≈°ti</button>
                        <button type="submit" class="btn btn-primary" id="submit-otprema-btn">Dodaj otpremu</button>
                    </div>

                    <div id="otprema-message" class="hidden" style="margin-top: 20px; padding: 12px; border-radius: 8px;"></div>
                </form>
            </div>
        </div>

        <!-- MY SJECE VIEW (For Primaƒç) -->
        <div id="my-sjece-content" class="container hidden">
            <div class="section">
                <h2>üìù Moje sjeƒçe - Zadnjih 10 unosa</h2>
                <p style="color: #6b7280; margin-bottom: 20px;">Ovdje mo≈æete pregledati i ispraviti va≈°e nedavne unose</p>
                <div id="my-sjece-container"></div>
            </div>
        </div>

        <!-- MY OTPREME VIEW (For Otpremaƒç) -->
        <div id="my-otpreme-content" class="container hidden">
            <div class="section">
                <h2>üìù Moje otpreme - Zadnjih 10 unosa</h2>
                <p style="color: #6b7280; margin-bottom: 20px;">Ovdje mo≈æete pregledati i ispraviti va≈°e nedavne unose</p>
                <div id="my-otpreme-container"></div>
            </div>
        </div>

        <!-- EDIT SJECA FORM (For editing existing entry) -->
        <div id="edit-sjeca-content" class="container hidden">
            <div class="section">
                <h2>‚úèÔ∏è Uredi sjeƒçu</h2>
                <form id="edit-sjeca-form" onsubmit="submitEditSjeca(event)">
                    <input type="hidden" id="edit-sjeca-rowIndex">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label>Datum:</label>
                            <input type="date" id="edit-sjeca-datum" required style="padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>Odjel:</label>
                            <select id="edit-sjeca-odjel" required style="padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; width: 100%;">
                                <option value="">Izaberi odjel...</option>
                            </select>
                        </div>
                    </div>

                    <h3 style="margin: 20px 0 10px 0; color: #047857;">Sortimenti (m¬≥):</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;" id="edit-sjeca-sortimenti">
                        <!-- Sortimenti fields will be dynamically added here -->
                    </div>

                    <div style="margin-top: 20px; padding: 20px; background: #fef3c7; border: 2px solid #f59e0b; border-radius: 10px;">
                        <label style="font-size: 1.2em; font-weight: bold; color: #92400e;">SVEUKUPNO (m¬≥):</label>
                        <input type="number" step="0.01" id="edit-sjeca-SVEUKUPNO" value="0" readonly style="padding: 12px; border: 2px solid #f59e0b; border-radius: 8px; width: 100%; background: #fffbeb; color: #92400e; font-size: 1.5em; font-weight: bold; text-align: center;">
                    </div>

                    <div style="margin-top: 30px; display: flex; gap: 12px; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="cancelEditSjeca()">Otka≈æi</button>
                        <button type="submit" class="btn btn-primary" id="submit-edit-sjeca-btn">Saƒçuvaj izmjene</button>
                    </div>

                    <div id="edit-sjeca-message" class="hidden" style="margin-top: 20px; padding: 12px; border-radius: 8px;"></div>
                </form>
            </div>
        </div>

        <!-- EDIT OTPREMA FORM (For editing existing entry) -->
        <div id="edit-otprema-content" class="container hidden">
            <div class="section">
                <h2>‚úèÔ∏è Uredi otpremu</h2>
                <form id="edit-otprema-form" onsubmit="submitEditOtprema(event)">
                    <input type="hidden" id="edit-otprema-rowIndex">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label>Datum:</label>
                            <input type="date" id="edit-otprema-datum" required style="padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>Odjel:</label>
                            <select id="edit-otprema-odjel" required style="padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; width: 100%;">
                                <option value="">Izaberi odjel...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Kupac:</label>
                            <input type="text" id="edit-otprema-kupac" placeholder="Naziv kupca" style="padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; width: 100%;">
                        </div>
                    </div>

                    <h3 style="margin: 20px 0 10px 0; color: #2563eb;">Sortimenti (m¬≥):</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;" id="edit-otprema-sortimenti">
                        <!-- Sortimenti fields will be dynamically added here -->
                    </div>

                    <div style="margin-top: 20px; padding: 20px; background: #fef3c7; border: 2px solid #f59e0b; border-radius: 10px;">
                        <label style="font-size: 1.2em; font-weight: bold; color: #92400e;">SVEUKUPNO (m¬≥):</label>
                        <input type="number" step="0.01" id="edit-otprema-SVEUKUPNO" value="0" readonly style="padding: 12px; border: 2px solid #f59e0b; border-radius: 8px; width: 100%; background: #fffbeb; color: #92400e; font-size: 1.5em; font-weight: bold; text-align: center;">
                    </div>

                    <div style="margin-top: 30px; display: flex; gap: 12px; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="cancelEditOtprema()">Otka≈æi</button>
                        <button type="submit" class="btn btn-primary" id="submit-edit-otprema-btn">Saƒçuvaj izmjene</button>
                    </div>

                    <div id="edit-otprema-message" class="hidden" style="margin-top: 20px; padding: 12px; border-radius: 8px;"></div>
                </form>
            </div>
        </div>

        <!-- DODANI UNOSI VIEW (For Rukovodilac/Admin) -->
        <div id="pending-unosi-content" class="container hidden">
            <div class="section">
                <h2>üìã Dodani Unosi - Pregled</h2>
                <p style="color: #6b7280; margin-bottom: 20px;">Unosi koje su radnici poslali na pregled</p>

                <!-- Filter Bar -->
                <div class="filter-bar">
                    <div class="filter-bar-title">üîç Filteri</div>
                    <div class="filter-grid">
                        <div class="filter-group">
                            <label class="filter-label">Datum od:</label>
                            <input type="date" class="filter-input" id="filter-datum-od">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Datum do:</label>
                            <input type="date" class="filter-input" id="filter-datum-do">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Tip:</label>
                            <select class="filter-select" id="filter-tip">
                                <option value="">Sve</option>
                                <option value="SJEƒåA">Sjeƒça</option>
                                <option value="OTPREMA">Otprema</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Pretraga:</label>
                            <input type="text" class="filter-input" id="filter-search" placeholder="Odjel, radnik, kupac...">
                        </div>
                        <div class="filter-actions">
                            <button class="btn btn-primary" onclick="applyFilters()">Filtriraj</button>
                            <button class="btn btn-clear" onclick="clearFilters()">Oƒçisti</button>
                        </div>
                    </div>
                </div>

                <div id="pending-unosi-container"></div>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div class="modal-overlay" id="confirm-modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="modal-title">Potvrda brisanja</div>
            </div>
            <div class="modal-body" id="modal-body">
                Da li ste sigurni da ≈æelite obrisati ovaj unos?
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeConfirmModal()">Otka≈æi</button>
                <button class="btn btn-danger" id="modal-confirm-btn">Obri≈°i</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbwOyqKvRtbQWQFABXe1Q8fWf2XP9K-msArcOU8BwoyN28fSGfLnPGskR1G8qBIZrMsy/exec';

        // ========== CACHING & OFFLINE SUPPORT ==========

        // Register Service Worker for offline support
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js')
                .then(registration => {
                    console.log('Service Worker registered:', registration);
                })
                .catch(error => {
                    console.error('Service Worker registration failed:', error);
                });
        }

        // Cache configuration - different TTLs for different endpoints
        const CACHE_CONFIG = {
            'dashboard': 5 * 60 * 1000,        // 5 minutes
            'primaci': 10 * 60 * 1000,         // 10 minutes
            'otpremaci': 10 * 60 * 1000,       // 10 minutes
            'kupci': 10 * 60 * 1000,           // 10 minutes
            'odjeli': 15 * 60 * 1000,          // 15 minutes
            'primac-detail': 5 * 60 * 1000,    // 5 minutes
            'otpremac-detail': 5 * 60 * 1000,  // 5 minutes
            'primac-odjeli': 10 * 60 * 1000,   // 10 minutes
            'otpremac-odjeli': 10 * 60 * 1000, // 10 minutes
            'default': 5 * 60 * 1000           // 5 minutes default
        };

        // Fetch with cache - cache-first strategy
        async function fetchWithCache(url, cacheKey) {
            // Determine cache TTL based on endpoint
            const path = new URL(url).searchParams.get('path');
            const cacheTTL = CACHE_CONFIG[path] || CACHE_CONFIG.default;

            // Check cache first
            const cached = localStorage.getItem(cacheKey);
            if (cached) {
                try {
                    const cachedData = JSON.parse(cached);
                    const now = Date.now();
                    const age = now - cachedData.timestamp;

                    // If cache is fresh, return it immediately
                    if (age < cacheTTL) {
                        console.log(`‚úì Cache hit (${path}): ${Math.round(age / 1000)}s old`);
                        showCacheIndicator(age);
                        return cachedData.data;
                    } else {
                        console.log(`‚ö† Cache stale (${path}): ${Math.round(age / 1000)}s old, fetching fresh...`);
                    }
                } catch (e) {
                    console.error('Cache parse error:', e);
                }
            }

            // Cache miss or stale - fetch from network
            try {
                console.log(`‚Üª Fetching fresh data (${path})...`);
                const response = await fetch(url);
                const data = await response.json();

                // Store in cache
                localStorage.setItem(cacheKey, JSON.stringify({
                    data: data,
                    timestamp: Date.now()
                }));

                console.log(`‚úì Fresh data cached (${path})`);
                hideCacheIndicator();
                return data;

            } catch (error) {
                console.error('Network error:', error);

                // If network fails and we have stale cache, use it
                if (cached) {
                    try {
                        const cachedData = JSON.parse(cached);
                        const age = Date.now() - cachedData.timestamp;
                        console.log(`‚ö† Network failed, using stale cache (${Math.round(age / 60000)} min old)`);
                        showCacheIndicator(age, true);
                        return cachedData.data;
                    } catch (e) {
                        console.error('Stale cache parse error:', e);
                    }
                }

                throw error;
            }
        }

        // Show cache indicator
        function showCacheIndicator(age, isStale = false) {
            const indicator = document.getElementById('cache-indicator');
            if (!indicator) return;

            const minutes = Math.round(age / 60000);
            const seconds = Math.round(age / 1000);

            if (isStale) {
                indicator.innerHTML = `‚ö†Ô∏è Offline - koristeƒái ke≈°irane podatke (${minutes} min staro)`;
                indicator.style.background = '#fef3c7';
                indicator.style.color = '#92400e';
            } else {
                indicator.innerHTML = `üì¶ Ke≈°irani podaci (${seconds}s staro)`;
                indicator.style.background = '#dbeafe';
                indicator.style.color = '#1e40af';
            }
            indicator.classList.remove('hidden');
        }

        // Hide cache indicator
        function hideCacheIndicator() {
            const indicator = document.getElementById('cache-indicator');
            if (indicator) {
                indicator.classList.add('hidden');
            }
        }

        // Clear all cache
        function clearAllCache() {
            const keys = Object.keys(localStorage);
            const cacheKeys = keys.filter(k => k.startsWith('cache_'));
            cacheKeys.forEach(k => localStorage.removeItem(k));
            console.log(`Cleared ${cacheKeys.length} cache entries`);

            // Clear Service Worker cache
            if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                navigator.serviceWorker.controller.postMessage({ type: 'CLEAR_CACHE' });
            }

            toggleUserMenu(); // Close menu
            alert('Ke≈° je obrisan. Stranica ƒáe se osvje≈æiti.');
            window.location.reload();
        }

        // Toggle user menu dropdown
        function toggleUserMenu() {
            const dropdown = document.getElementById('user-menu-dropdown');
            dropdown.classList.toggle('show');
        }

        // Close user menu when clicking outside
        document.addEventListener('click', function(event) {
            const userMenu = document.querySelector('.user-menu');
            const dropdown = document.getElementById('user-menu-dropdown');
            if (userMenu && !userMenu.contains(event.target) && dropdown) {
                dropdown.classList.remove('show');
            }
        });

        // ========== END CACHING ==========

        let currentUser = null;
        let currentPassword = null;
        let odjeliList = [];

        // Load odjeli list from API
        async function loadOdjeli() {
            try {
                const url = API_URL + '?path=get-odjeli-list';
                const response = await fetch(url);
                const data = await response.json();

                if (data.success && data.odjeli) {
                    odjeliList = data.odjeli;
                    populateOdjeliDropdowns();
                }
            } catch (error) {
                console.error('Error loading odjeli:', error);
            }
        }

        // Populate all odjel dropdowns
        function populateOdjeliDropdowns() {
            const dropdowns = [
                'sjeca-odjel',
                'otprema-odjel',
                'edit-sjeca-odjel',
                'edit-otprema-odjel'
            ];

            dropdowns.forEach(dropdownId => {
                const dropdown = document.getElementById(dropdownId);
                if (dropdown) {
                    // Keep the first "Izaberi odjel..." option
                    const currentValue = dropdown.value;
                    dropdown.innerHTML = '<option value="">Izaberi odjel...</option>';

                    odjeliList.forEach(odjel => {
                        const option = document.createElement('option');
                        option.value = odjel;
                        option.textContent = odjel;
                        dropdown.appendChild(option);
                    });

                    // Restore previously selected value if it exists
                    if (currentValue && odjeliList.includes(currentValue)) {
                        dropdown.value = currentValue;
                    }
                }
            });
        }

        // Check if already logged in
        window.addEventListener('DOMContentLoaded', () => {
            // Load odjeli list
            loadOdjeli();

            const savedUser = localStorage.getItem('sumarija_user');
            const savedPass = localStorage.getItem('sumarija_pass');

            if (savedUser && savedPass) {
                currentUser = JSON.parse(savedUser);
                currentPassword = savedPass;
                showApp();
                loadData();
            }
        });
        
        // Login form
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorMsg = document.getElementById('error-msg');
            const loginBtn = document.getElementById('login-btn');
            
            errorMsg.classList.add('hidden');
            loginBtn.disabled = true;
            loginBtn.textContent = 'Prijavljivanje...';
            
            try {
                const response = await fetch(`${API_URL}?path=login&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`);
                const data = await response.json();
                
                if (data.success) {
                    currentUser = data;
                    currentPassword = password;
                    localStorage.setItem('sumarija_user', JSON.stringify(data));
                    localStorage.setItem('sumarija_pass', password);
                    showApp();
                    loadData();
                } else {
                    errorMsg.textContent = data.error || 'Gre≈°ka pri prijavi';
                    errorMsg.classList.remove('hidden');
                }
            } catch (error) {
                errorMsg.textContent = 'Gre≈°ka u komunikaciji sa serverom: ' + error.message;
                errorMsg.classList.remove('hidden');
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Prijavi se';
            }
        });
        
        function showApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            document.getElementById('user-name').textContent = currentUser.fullName;
            document.getElementById('user-role').textContent = currentUser.role === 'admin' ? 'Administrator' : currentUser.type;

            // Dinamiƒçki kreiraj tab-ove na osnovu tipa korisnika
            const tabsMenu = document.getElementById('tabs-menu');
            const userType = currentUser.type; // 'primac', 'otpremac', ili ne≈°to drugo

            if (userType === 'primac') {
                // Primaƒç vidi ƒçetiri prikaza: pregled, po odjelima, dodavanje, i moje sjeƒçe
                tabsMenu.innerHTML = `
                    <button class="tab active" onclick="switchTab('primac-personal')">üë∑ Pregled sjeƒçe u tekuƒáoj godini</button>
                    <button class="tab" onclick="switchTab('primac-odjeli')">üè≠ Prikaz po odjelima</button>
                    <button class="tab" onclick="switchTab('add-sjeca')">‚ûï Dodaj sjeƒçu</button>
                    <button class="tab" onclick="switchTab('my-sjece')">üìù Moje sjeƒçe</button>
                `;
            } else if (userType === 'otpremac') {
                // Otpremaƒç vidi ƒçetiri prikaza: pregled, po odjelima, dodavanje, i moje otpreme
                tabsMenu.innerHTML = `
                    <button class="tab active" onclick="switchTab('otpremac-personal')">üöõ Pregled otpreme u tekuƒáoj godini</button>
                    <button class="tab" onclick="switchTab('otpremac-odjeli')">üè≠ Prikaz po odjelima</button>
                    <button class="tab" onclick="switchTab('add-otprema')">‚ûï Dodaj otpremu</button>
                    <button class="tab" onclick="switchTab('my-otpreme')">üìù Moje otpreme</button>
                `;
            } else {
                // Admin ili drugi korisnici vide sve tab-ove
                tabsMenu.innerHTML = `
                    <button class="tab active" onclick="switchTab('dashboard')">üå≤ ≈†umarija Krupa</button>
                    <button class="tab" onclick="switchTab('primaci')">üë∑ Prikaz po primaƒçima</button>
                    <button class="tab" onclick="switchTab('otpremaci')">üöõ Prikaz po otpremaƒçima</button>
                    <button class="tab" onclick="switchTab('kupci')">üè¢ Prikaz po kupcima</button>
                    <button class="tab" onclick="switchTab('pending-unosi')">üìã Dodani unosi</button>
                `;
            }
        }
        
        function logout() {
            currentUser = null;
            currentPassword = null;
            localStorage.removeItem('sumarija_user');
            localStorage.removeItem('sumarija_pass');
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('app-screen').classList.add('hidden');
            document.getElementById('dashboard-content').classList.add('hidden');
            document.getElementById('primaci-content').classList.add('hidden');
            document.getElementById('otpremaci-content').classList.add('hidden');
            document.getElementById('kupci-content').classList.add('hidden');
            document.getElementById('primac-personal-content').classList.add('hidden');
            document.getElementById('otpremac-personal-content').classList.add('hidden');
            document.getElementById('primac-odjeli-content').classList.add('hidden');
            document.getElementById('otpremac-odjeli-content').classList.add('hidden');
            document.getElementById('add-sjeca-content').classList.add('hidden');
            document.getElementById('add-otprema-content').classList.add('hidden');
            document.getElementById('my-sjece-content').classList.add('hidden');
            document.getElementById('my-otpreme-content').classList.add('hidden');
            document.getElementById('edit-sjeca-content').classList.add('hidden');
            document.getElementById('edit-otprema-content').classList.add('hidden');
            document.getElementById('pending-unosi-content').classList.add('hidden');
            document.getElementById('loading-screen').classList.remove('hidden');
        }
        
        // Load initial data based on user type
        function loadData() {
            const userType = currentUser.type;
            if (userType === 'primac') {
                loadPrimacPersonal();
            } else if (userType === 'otpremac') {
                loadOtpremacPersonal();
            } else {
                loadDashboard();
            }
        }

        // Switch between tabs
        function switchTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            // Hide all content sections
            document.getElementById('dashboard-content').classList.add('hidden');
            document.getElementById('primaci-content').classList.add('hidden');
            document.getElementById('otpremaci-content').classList.add('hidden');
            document.getElementById('kupci-content').classList.add('hidden');
            document.getElementById('primac-personal-content').classList.add('hidden');
            document.getElementById('otpremac-personal-content').classList.add('hidden');
            document.getElementById('primac-odjeli-content').classList.add('hidden');
            document.getElementById('otpremac-odjeli-content').classList.add('hidden');
            document.getElementById('add-sjeca-content').classList.add('hidden');
            document.getElementById('add-otprema-content').classList.add('hidden');
            document.getElementById('my-sjece-content').classList.add('hidden');
            document.getElementById('my-otpreme-content').classList.add('hidden');
            document.getElementById('edit-sjeca-content').classList.add('hidden');
            document.getElementById('edit-otprema-content').classList.add('hidden');
            document.getElementById('pending-unosi-content').classList.add('hidden');

            // Load appropriate content
            if (tab === 'dashboard') {
                loadDashboard();
            } else if (tab === 'primaci') {
                loadPrimaci();
            } else if (tab === 'otpremaci') {
                loadOtpremaci();
            } else if (tab === 'kupci') {
                loadKupci();
            } else if (tab === 'primac-personal') {
                loadPrimacPersonal();
            } else if (tab === 'otpremac-personal') {
                loadOtpremacPersonal();
            } else if (tab === 'primac-odjeli') {
                loadPrimacOdjeli();
            } else if (tab === 'otpremac-odjeli') {
                loadOtpremacOdjeli();
            } else if (tab === 'add-sjeca') {
                showAddSjecaForm();
            } else if (tab === 'add-otprema') {
                showAddOtpremaForm();
            } else if (tab === 'my-sjece') {
                loadMySjece();
            } else if (tab === 'my-otpreme') {
                loadMyOtpreme();
            } else if (tab === 'pending-unosi') {
                loadPendingUnosi();
            }
        }

        // Load dashboard data
        async function loadDashboard() {
            document.getElementById('loading-screen').classList.remove('hidden');
            document.getElementById('dashboard-content').classList.add('hidden');

            try {
                const year = new Date().getFullYear();

                // Fetch dashboard data with caching
                const url = `${API_URL}?path=dashboard&year=${year}&username=${currentUser.username}&password=${currentPassword}`;
                const data = await fetchWithCache(url, 'cache_dashboard_' + year);

                console.log('Dashboard data:', data);

                // Check for errors
                if (data.error) {
                    throw new Error('Dashboard API error: ' + data.error);
                }

                // Check if data is valid
                if (!data.mjesecnaStatistika) {
                    throw new Error('Dashboard data missing mjesecnaStatistika');
                }

                // Calculate summary statistics
                const totalSjeca = data.mjesecnaStatistika.reduce((sum, m) => sum + m.sjeca, 0);
                const totalOtprema = data.mjesecnaStatistika.reduce((sum, m) => sum + m.otprema, 0);
                const totalStanje = totalSjeca - totalOtprema;
                const totalDinamika = data.mjesecnaStatistika.reduce((sum, m) => sum + m.dinamika, 0);
                const razlikaDinamika = totalSjeca - totalDinamika;
                const percentDinamika = ((totalSjeca / totalDinamika) * 100).toFixed(1);

                // Create summary cards
                const summaryHTML = `
                    <div class="summary-card green">
                        <div class="summary-card-title">Ukupna Sjeƒça</div>
                        <div class="summary-card-value">${totalSjeca.toFixed(0)} m¬≥</div>
                        <div class="summary-card-subtitle">${percentDinamika}% dinamike</div>
                    </div>
                    <div class="summary-card blue">
                        <div class="summary-card-title">Ukupna Otprema</div>
                        <div class="summary-card-value">${totalOtprema.toFixed(0)} m¬≥</div>
                        <div class="summary-card-subtitle">${((totalOtprema/totalSjeca)*100).toFixed(1)}% od sjeƒçe</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-card-title">≈†uma/Panj</div>
                        <div class="summary-card-value">${totalStanje.toFixed(0)} m¬≥</div>
                        <div class="summary-card-subtitle">Preostalo u ≈°umi</div>
                    </div>
                    <div class="summary-card ${razlikaDinamika >= 0 ? 'green' : 'red'}">
                        <div class="summary-card-title">Razlika sa Dinamikom</div>
                        <div class="summary-card-value">${(razlikaDinamika >= 0 ? '+' : '') + razlikaDinamika.toFixed(0)} m¬≥</div>
                        <div class="summary-card-subtitle">${razlikaDinamika >= 0 ? 'Iznad plana' : 'Ispod plana'}</div>
                    </div>
                `;
                document.getElementById('summary-cards').innerHTML = summaryHTML;

                // Create chart
                const labels = data.mjesecnaStatistika.map(m => m.mjesec);
                const sjecaData = data.mjesecnaStatistika.map(m => m.sjeca);
                const otpremaData = data.mjesecnaStatistika.map(m => m.otprema);
                const dinamikaData = data.mjesecnaStatistika.map(m => m.dinamika);

                const ctx = document.getElementById('trendsChart');
                if (window.dashboardChart) {
                    window.dashboardChart.destroy();
                }
                window.dashboardChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Sjeƒça',
                            data: sjecaData,
                            borderColor: '#059669',
                            backgroundColor: 'rgba(5, 150, 105, 0.1)',
                            tension: 0.4,
                            fill: true
                        }, {
                            label: 'Otprema',
                            data: otpremaData,
                            borderColor: '#2563eb',
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            tension: 0.4,
                            fill: true
                        }, {
                            label: 'Dinamika',
                            data: dinamikaData,
                            borderColor: '#dc2626',
                            borderDash: [5, 5],
                            tension: 0.4,
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top' },
                            tooltip: { mode: 'index', intersect: false }
                        },
                        scales: {
                            y: { beginAtZero: true, title: { display: true, text: 'm¬≥' } }
                        }
                    }
                });

                // Populate monthly table
                const monthlyHTML = data.mjesecnaStatistika.map(m => {
                    const razlikaSjeca = m.razlikaSjeca || 0;
                    const razlikaOtprema = m.razlikaOtprema || 0;
                    const progressPercent = ((m.sjeca / m.dinamika) * 100).toFixed(1);
                    return `
                        <tr>
                            <td style="font-weight: 500;">${m.mjesec}</td>
                            <td class="right green">${m.sjeca.toFixed(2)}</td>
                            <td class="right blue">${m.otprema.toFixed(2)}</td>
                            <td class="right">${m.stanje.toFixed(2)}</td>
                            <td class="right">
                                ${m.dinamika.toFixed(2)}
                                <div class="table-progress-bar">
                                    <div class="table-progress-fill" style="width: ${Math.min(progressPercent, 100)}%"></div>
                                </div>
                            </td>
                            <td class="right ${razlikaSjeca >= 0 ? 'green' : 'red'}">${(razlikaSjeca >= 0 ? '+' : '') + razlikaSjeca.toFixed(2)}</td>
                            <td class="right ${razlikaOtprema >= 0 ? 'green' : 'red'}">${(razlikaOtprema >= 0 ? '+' : '') + razlikaOtprema.toFixed(2)}</td>
                        </tr>
                    `;
                }).join('');
                document.getElementById('dashboard-monthly-table').innerHTML = monthlyHTML;

                // Fetch and populate odjeli table with caching
                const odjeliUrl = `${API_URL}?path=odjeli&year=${year}&username=${currentUser.username}&password=${currentPassword}`;
                const odjeliData = await fetchWithCache(odjeliUrl, 'cache_odjeli_' + year);

                console.log('Odjeli data:', odjeliData);

                if (odjeliData.error) {
                    console.error('Odjeli API error:', odjeliData.error);
                    document.getElementById('odjeli-table-body').innerHTML = '<tr><td colspan="8" style="text-align: center; color: #dc2626;">Gre≈°ka pri uƒçitavanju podataka o odjelima</td></tr>';
                } else if (odjeliData.odjeli && odjeliData.odjeli.length > 0) {
                    const odjeliHTML = odjeliData.odjeli.map(o => {
                        const realizacijaColor = o.realizacija >= 100 ? 'green' : (o.realizacija >= 80 ? 'blue' : 'red');
                        return `
                            <tr>
                                <td style="font-weight: 500;">${o.odjel}</td>
                                <td class="right green">${o.sjeca.toFixed(2)}</td>
                                <td class="right blue">${o.otprema.toFixed(2)}</td>
                                <td class="right">${o.sumaPanj.toFixed(2)}</td>
                                <td>${o.radiliste || '-'}</td>
                                <td>${o.izvoƒëaƒç || '-'}</td>
                                <td>${o.datumZadnjeSjece || '-'}</td>
                                <td class="right ${realizacijaColor}">${o.realizacija > 0 ? o.realizacija.toFixed(1) + '%' : '-'}</td>
                            </tr>
                        `;
                    }).join('');
                    document.getElementById('odjeli-table-body').innerHTML = odjeliHTML;
                } else {
                    document.getElementById('odjeli-table-body').innerHTML = '<tr><td colspan="8" style="text-align: center; color: #6b7280;">Nema podataka o odjelima</td></tr>';
                }

                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('dashboard-content').classList.remove('hidden');

            } catch (error) {
                console.error('Dashboard error:', error);
                alert('Gre≈°ka pri uƒçitavanju dashboard podataka: ' + error.message);
                document.getElementById('loading-screen').innerHTML = '<div class="loading-icon">‚ùå</div><div class="loading-text">Gre≈°ka pri uƒçitavanju</div><div class="loading-sub">' + error.message + '</div>';
            }
        }

        // Load primaci data
        async function loadPrimaci() {
            document.getElementById('loading-screen').classList.remove('hidden');
            document.getElementById('primaci-content').classList.add('hidden');

            try {
                const year = new Date().getFullYear();
                const url = `${API_URL}?path=primaci&year=${year}&username=${currentUser.username}&password=${currentPassword}`;
                const data = await fetchWithCache(url, 'cache_primaci_' + year);

                // Create header
                const headerHTML = `
                    <tr>
                        <th>Primaƒç</th>
                        ${data.mjeseci.map(m => `<th class="right">${m}</th>`).join('')}
                        <th class="right">Ukupno</th>
                    </tr>
                `;
                document.getElementById('primaci-header').innerHTML = headerHTML;

                // Create body
                const bodyHTML = data.primaci.map(p => {
                    return `
                        <tr>
                            <td style="font-weight: 500;">${p.primac}</td>
                            ${p.mjeseci.map(v => `<td class="right">${v.toFixed(2)}</td>`).join('')}
                            <td class="right green" style="font-weight: bold;">${p.ukupno.toFixed(2)}</td>
                        </tr>
                    `;
                }).join('');
                document.getElementById('primaci-body').innerHTML = bodyHTML;

                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('primaci-content').classList.remove('hidden');

            } catch (error) {
                alert('Gre≈°ka pri uƒçitavanju primaƒça: ' + error.message);
                document.getElementById('loading-screen').innerHTML = '<div class="loading-icon">‚ùå</div><div class="loading-text">Gre≈°ka pri uƒçitavanju</div><div class="loading-sub">' + error.message + '</div>';
            }
        }

        // Load otpremaci data
        async function loadOtpremaci() {
            document.getElementById('loading-screen').classList.remove('hidden');
            document.getElementById('otpremaci-content').classList.add('hidden');

            try {
                const year = new Date().getFullYear();
                const url = `${API_URL}?path=otpremaci&year=${year}&username=${currentUser.username}&password=${currentPassword}`;
                const data = await fetchWithCache(url, 'cache_otpremaci_' + year);

                // Create header
                const headerHTML = `
                    <tr>
                        <th>Otpremaƒç</th>
                        ${data.mjeseci.map(m => `<th class="right">${m}</th>`).join('')}
                        <th class="right">Ukupno</th>
                    </tr>
                `;
                document.getElementById('otpremaci-header').innerHTML = headerHTML;

                // Create body
                const bodyHTML = data.otpremaci.map(o => {
                    return `
                        <tr>
                            <td style="font-weight: 500;">${o.otpremac}</td>
                            ${o.mjeseci.map(v => `<td class="right">${v.toFixed(2)}</td>`).join('')}
                            <td class="right blue" style="font-weight: bold;">${o.ukupno.toFixed(2)}</td>
                        </tr>
                    `;
                }).join('');
                document.getElementById('otpremaci-body').innerHTML = bodyHTML;

                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('otpremaci-content').classList.remove('hidden');

            } catch (error) {
                alert('Gre≈°ka pri uƒçitavanju otpremaƒça: ' + error.message);
                document.getElementById('loading-screen').innerHTML = '<div class="loading-icon">‚ùå</div><div class="loading-text">Gre≈°ka pri uƒçitavanju</div><div class="loading-sub">' + error.message + '</div>';
            }
        }

        // Load kupci data
        async function loadKupci() {
            document.getElementById('loading-screen').classList.remove('hidden');
            document.getElementById('kupci-content').classList.add('hidden');

            try {
                const year = new Date().getFullYear();
                const url = `${API_URL}?path=kupci&year=${year}&username=${currentUser.username}&password=${currentPassword}`;
                const data = await fetchWithCache(url, 'cache_kupci_' + year);

                console.log('Kupci data:', data);

                if (data.error) {
                    throw new Error(data.error);
                }

                // ========================================
                // GODI≈†NJI PREGLED
                // ========================================

                // Create godisnji header
                const godisnjiHeaderHTML = `
                    <tr>
                        <th onclick="sortTable(0, 'kupci-godisnji-table')">Kupac ‚áÖ</th>
                        ${data.sortimentiNazivi.map((s, i) => `<th class="sortiment-col" onclick="sortTable(${i+1}, 'kupci-godisnji-table')">${s} ‚áÖ</th>`).join('')}
                        <th class="ukupno-col" onclick="sortTable(${data.sortimentiNazivi.length + 1}, 'kupci-godisnji-table')">Ukupno ‚áÖ</th>
                    </tr>
                `;
                document.getElementById('kupci-godisnji-header').innerHTML = godisnjiHeaderHTML;

                // Create godisnji body with totals
                let godisnjiTotals = { sortimenti: {}, ukupno: 0 };
                data.sortimentiNazivi.forEach(s => godisnjiTotals.sortimenti[s] = 0);

                const godisnjiBodyHTML = data.godisnji.map(k => {
                    // Add to totals
                    data.sortimentiNazivi.forEach(s => {
                        godisnjiTotals.sortimenti[s] += (k.sortimenti[s] || 0);
                    });
                    godisnjiTotals.ukupno += k.ukupno;

                    const sortimentiCells = data.sortimentiNazivi.map(sortiment => {
                        const val = k.sortimenti[sortiment] || 0;
                        return `<td class="sortiment-col">${val > 0 ? val.toFixed(2) : '-'}</td>`;
                    }).join('');

                    return `
                        <tr>
                            <td>${k.kupac}</td>
                            ${sortimentiCells}
                            <td class="ukupno-col">${k.ukupno.toFixed(2)}</td>
                        </tr>
                    `;
                }).join('');

                // Add totals row
                const godisnjiTotalsCells = data.sortimentiNazivi.map(s => {
                    const val = godisnjiTotals.sortimenti[s];
                    return `<td class="sortiment-col">${val > 0 ? val.toFixed(2) : '-'}</td>`;
                }).join('');

                const godisnjiBodyWithTotals = godisnjiBodyHTML + `
                    <tr class="totals-row">
                        <td style="text-align: left;">UKUPNO</td>
                        ${godisnjiTotalsCells}
                        <td class="ukupno-col">${godisnjiTotals.ukupno.toFixed(2)}</td>
                    </tr>
                `;

                document.getElementById('kupci-godisnji-body').innerHTML = godisnjiBodyWithTotals;

                // ========================================
                // MJESEƒåNI PREGLED
                // ========================================

                // Create mjesecni header
                const mjesecniHeaderHTML = `
                    <tr>
                        <th onclick="sortTable(0, 'kupci-mjesecni-table')">Kupac ‚áÖ</th>
                        <th onclick="sortTable(1, 'kupci-mjesecni-table')">Mjesec ‚áÖ</th>
                        ${data.sortimentiNazivi.map((s, i) => `<th class="sortiment-col" onclick="sortTable(${i+2}, 'kupci-mjesecni-table')">${s} ‚áÖ</th>`).join('')}
                        <th class="ukupno-col" onclick="sortTable(${data.sortimentiNazivi.length + 2}, 'kupci-mjesecni-table')">Ukupno ‚áÖ</th>
                    </tr>
                `;
                document.getElementById('kupci-mjesecni-header').innerHTML = mjesecniHeaderHTML;

                // Create mjesecni body with totals
                let mjesecniTotals = { sortimenti: {}, ukupno: 0 };
                data.sortimentiNazivi.forEach(s => mjesecniTotals.sortimenti[s] = 0);

                const mjesecniBodyHTML = data.mjesecni.map(k => {
                    // Add to totals
                    data.sortimentiNazivi.forEach(s => {
                        mjesecniTotals.sortimenti[s] += (k.sortimenti[s] || 0);
                    });
                    mjesecniTotals.ukupno += k.ukupno;

                    const sortimentiCells = data.sortimentiNazivi.map(sortiment => {
                        const val = k.sortimenti[sortiment] || 0;
                        return `<td class="sortiment-col">${val > 0 ? val.toFixed(2) : '-'}</td>`;
                    }).join('');

                    return `
                        <tr>
                            <td>${k.kupac}</td>
                            <td>${k.mjesec}</td>
                            ${sortimentiCells}
                            <td class="ukupno-col">${k.ukupno.toFixed(2)}</td>
                        </tr>
                    `;
                }).join('');

                // Add totals row
                const mjesecniTotalsCells = data.sortimentiNazivi.map(s => {
                    const val = mjesecniTotals.sortimenti[s];
                    return `<td class="sortiment-col">${val > 0 ? val.toFixed(2) : '-'}</td>`;
                }).join('');

                const mjesecniBodyWithTotals = mjesecniBodyHTML + `
                    <tr class="totals-row">
                        <td style="text-align: left;">UKUPNO</td>
                        <td></td>
                        ${mjesecniTotalsCells}
                        <td class="ukupno-col">${mjesecniTotals.ukupno.toFixed(2)}</td>
                    </tr>
                `;

                document.getElementById('kupci-mjesecni-body').innerHTML = mjesecniBodyWithTotals;

                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('kupci-content').classList.remove('hidden');

            } catch (error) {
                alert('Gre≈°ka pri uƒçitavanju kupaca: ' + error.message);
                document.getElementById('loading-screen').innerHTML = '<div class="loading-icon">‚ùå</div><div class="loading-text">Gre≈°ka pri uƒçitavanju</div><div class="loading-sub">' + error.message + '</div>';
            }
        }

        // Load primac personal data
        async function loadPrimacPersonal() {
            document.getElementById('loading-screen').classList.remove('hidden');
            document.getElementById('primac-personal-content').classList.add('hidden');

            try {
                const year = new Date().getFullYear();
                const url = `${API_URL}?path=primac-detail&year=${year}&username=${currentUser.username}&password=${currentPassword}`;
                const data = await fetchWithCache(url, 'cache_primac_detail_' + year);

                console.log('Primac personal data:', data);

                if (data.error) {
                    throw new Error(data.error);
                }

                // Create header
                const headerHTML = `
                    <tr>
                        <th onclick="sortTable(0, 'primac-personal-table')">Datum ‚áÖ</th>
                        <th onclick="sortTable(1, 'primac-personal-table')">Odjel ‚áÖ</th>
                        ${data.sortimentiNazivi.map((s, i) => `<th class="sortiment-col" onclick="sortTable(${i+2}, 'primac-personal-table')">${s} ‚áÖ</th>`).join('')}
                        <th class="ukupno-col" onclick="sortTable(${data.sortimentiNazivi.length + 2}, 'primac-personal-table')">Ukupno ‚áÖ</th>
                    </tr>
                `;
                document.getElementById('primac-personal-header').innerHTML = headerHTML;

                // Create body with totals
                let totals = { sortimenti: {}, ukupno: 0 };
                data.sortimentiNazivi.forEach(s => totals.sortimenti[s] = 0);

                const bodyHTML = data.unosi.map(u => {
                    // Add to totals
                    data.sortimentiNazivi.forEach(s => {
                        totals.sortimenti[s] += (u.sortimenti[s] || 0);
                    });
                    totals.ukupno += u.ukupno;

                    const sortimentiCells = data.sortimentiNazivi.map(sortiment => {
                        const val = u.sortimenti[sortiment] || 0;
                        return `<td class="sortiment-col">${val > 0 ? val.toFixed(2) : '-'}</td>`;
                    }).join('');

                    return `
                        <tr>
                            <td style="font-weight: 500;">${u.datum}</td>
                            <td>${u.odjel}</td>
                            ${sortimentiCells}
                            <td class="ukupno-col">${u.ukupno.toFixed(2)}</td>
                        </tr>
                    `;
                }).join('');

                // Add totals row
                const totalsCells = data.sortimentiNazivi.map(s => {
                    const val = totals.sortimenti[s];
                    return `<td class="sortiment-col">${val > 0 ? val.toFixed(2) : '-'}</td>`;
                }).join('');

                const bodyWithTotals = bodyHTML + `
                    <tr class="totals-row">
                        <td colspan="2" style="text-align: left;">UKUPNO</td>
                        ${totalsCells}
                        <td class="ukupno-col">${totals.ukupno.toFixed(2)}</td>
                    </tr>
                `;

                document.getElementById('primac-personal-body').innerHTML = bodyWithTotals;

                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('primac-personal-content').classList.remove('hidden');

            } catch (error) {
                alert('Gre≈°ka pri uƒçitavanju podataka: ' + error.message);
                document.getElementById('loading-screen').innerHTML = '<div class="loading-icon">‚ùå</div><div class="loading-text">Gre≈°ka pri uƒçitavanju</div><div class="loading-sub">' + error.message + '</div>';
            }
        }

        // Load otpremac personal data
        async function loadOtpremacPersonal() {
            document.getElementById('loading-screen').classList.remove('hidden');
            document.getElementById('otpremac-personal-content').classList.add('hidden');

            try {
                const year = new Date().getFullYear();
                const url = `${API_URL}?path=otpremac-detail&year=${year}&username=${currentUser.username}&password=${currentPassword}`;
                const data = await fetchWithCache(url, 'cache_otpremac_detail_' + year);

                console.log('Otpremac personal data:', data);

                if (data.error) {
                    throw new Error(data.error);
                }

                // Create header
                const headerHTML = `
                    <tr>
                        <th onclick="sortTable(0, 'otpremac-personal-table')">Datum ‚áÖ</th>
                        <th onclick="sortTable(1, 'otpremac-personal-table')">Odjel ‚áÖ</th>
                        <th onclick="sortTable(2, 'otpremac-personal-table')">Kupac ‚áÖ</th>
                        ${data.sortimentiNazivi.map((s, i) => `<th class="sortiment-col" onclick="sortTable(${i+3}, 'otpremac-personal-table')">${s} ‚áÖ</th>`).join('')}
                        <th class="ukupno-col" onclick="sortTable(${data.sortimentiNazivi.length + 3}, 'otpremac-personal-table')">Ukupno ‚áÖ</th>
                    </tr>
                `;
                document.getElementById('otpremac-personal-header').innerHTML = headerHTML;

                // Create body with totals
                let totals = { sortimenti: {}, ukupno: 0 };
                data.sortimentiNazivi.forEach(s => totals.sortimenti[s] = 0);

                const bodyHTML = data.unosi.map(u => {
                    // Add to totals
                    data.sortimentiNazivi.forEach(s => {
                        totals.sortimenti[s] += (u.sortimenti[s] || 0);
                    });
                    totals.ukupno += u.ukupno;

                    const sortimentiCells = data.sortimentiNazivi.map(sortiment => {
                        const val = u.sortimenti[sortiment] || 0;
                        return `<td class="sortiment-col">${val > 0 ? val.toFixed(2) : '-'}</td>`;
                    }).join('');

                    return `
                        <tr>
                            <td style="font-weight: 500;">${u.datum}</td>
                            <td>${u.odjel}</td>
                            <td>${u.kupac || '-'}</td>
                            ${sortimentiCells}
                            <td class="ukupno-col">${u.ukupno.toFixed(2)}</td>
                        </tr>
                    `;
                }).join('');

                // Add totals row
                const totalsCells = data.sortimentiNazivi.map(s => {
                    const val = totals.sortimenti[s];
                    return `<td class="sortiment-col">${val > 0 ? val.toFixed(2) : '-'}</td>`;
                }).join('');

                const bodyWithTotals = bodyHTML + `
                    <tr class="totals-row">
                        <td colspan="3" style="text-align: left;">UKUPNO</td>
                        ${totalsCells}
                        <td class="ukupno-col">${totals.ukupno.toFixed(2)}</td>
                    </tr>
                `;

                document.getElementById('otpremac-personal-body').innerHTML = bodyWithTotals;

                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('otpremac-personal-content').classList.remove('hidden');

            } catch (error) {
                alert('Gre≈°ka pri uƒçitavanju podataka: ' + error.message);
                document.getElementById('loading-screen').innerHTML = '<div class="loading-icon">‚ùå</div><div class="loading-text">Gre≈°ka pri uƒçitavanju</div><div class="loading-sub">' + error.message + '</div>';
            }
        }

        // ========================================
        // ODJELI VIEW (BY DEPARTMENT) - WITH PAGINATION
        // ========================================

        let primacOdjeliData = null;
        let primacOdjeliCurrentPage = 0;
        const primacOdjeliPageSize = 5;

        let otpremacOdjeliData = null;
        let otpremacOdjeliCurrentPage = 0;
        const otpremacOdjeliPageSize = 5;

        // Load primac odjeli data
        async function loadPrimacOdjeli() {
            document.getElementById('loading-screen').classList.remove('hidden');
            document.getElementById('primac-odjeli-content').classList.add('hidden');

            try {
                const year = new Date().getFullYear();
                const url = `${API_URL}?path=primac-odjeli&year=${year}&username=${currentUser.username}&password=${currentPassword}`;
                const data = await fetchWithCache(url, 'cache_primac_odjeli_' + year);

                console.log('Primac odjeli data:', data);

                if (data.error) {
                    throw new Error(data.error);
                }

                primacOdjeliData = data;
                primacOdjeliCurrentPage = 0;
                renderPrimacOdjeliPage();

                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('primac-odjeli-content').classList.remove('hidden');

            } catch (error) {
                alert('Gre≈°ka pri uƒçitavanju podataka: ' + error.message);
                document.getElementById('loading-screen').innerHTML = '<div class="loading-icon">‚ùå</div><div class="loading-text">Gre≈°ka pri uƒçitavanju</div><div class="loading-sub">' + error.message + '</div>';
            }
        }

        function renderPrimacOdjeliPage() {
            if (!primacOdjeliData) return;

            const start = primacOdjeliCurrentPage * primacOdjeliPageSize;
            const end = Math.min(start + primacOdjeliPageSize, primacOdjeliData.odjeli.length);
            const pageOdjeli = primacOdjeliData.odjeli.slice(start, end);

            let html = '';

            pageOdjeli.forEach(odjel => {
                // Kreiraj HTML za odjel sa dve tabele
                html += `
                    <div style="margin-bottom: 40px; border: 2px solid #10b981; border-radius: 12px; padding: 20px; background: #f0fdf4;">
                        <h3 style="color: #047857; margin-bottom: 16px;">üìÅ ${odjel.odjel}</h3>
                        <p style="font-size: 13px; color: #6b7280; margin-bottom: 16px;">Zadnji unos: ${odjel.zadnjiDatum || 'N/A'}</p>

                        <!-- Apsolutne vrijednosti -->
                        <h4 style="font-size: 15px; margin-bottom: 8px; color: #059669;">Apsolutne vrijednosti (m¬≥)</h4>
                        <div class="kupci-table-wrapper" style="margin-bottom: 20px;">
                            <table class="kupci-table">
                                <thead>
                                    <tr>
                                        ${primacOdjeliData.sortimentiNazivi.map(s => `<th class="sortiment-col">${s}</th>`).join('')}
                                        <th class="ukupno-col">Ukupno</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        ${primacOdjeliData.sortimentiNazivi.map(s => {
                                            const val = odjel.sortimenti[s] || 0;
                                            return `<td class="sortiment-col">${val > 0 ? val.toFixed(2) : '-'}</td>`;
                                        }).join('')}
                                        <td class="ukupno-col">${odjel.ukupno.toFixed(2)}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Procentualne vrijednosti -->
                        <h4 style="font-size: 15px; margin-bottom: 8px; color: #059669;">Procentualni udio (%)</h4>
                        <div class="kupci-table-wrapper">
                            <table class="kupci-table">
                                <thead>
                                    <tr>
                                        ${primacOdjeliData.sortimentiNazivi.map(s => `<th class="sortiment-col">${s}</th>`).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        ${primacOdjeliData.sortimentiNazivi.map(s => {
                                            const val = odjel.sortimenti[s] || 0;
                                            const percent = odjel.ukupno > 0 ? (val / odjel.ukupno) * 100 : 0;
                                            return `<td class="sortiment-col">${percent > 0 ? percent.toFixed(1) + '%' : '-'}</td>`;
                                        }).join('')}
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            });

            document.getElementById('primac-odjeli-container').innerHTML = html;

            // Update pagination controls
            const totalPages = Math.ceil(primacOdjeliData.odjeli.length / primacOdjeliPageSize);
            document.getElementById('primac-odjeli-page-info').textContent = `Stranica ${primacOdjeliCurrentPage + 1} od ${totalPages}`;
            document.getElementById('primac-odjeli-prev').disabled = primacOdjeliCurrentPage === 0;
            document.getElementById('primac-odjeli-next').disabled = primacOdjeliCurrentPage >= totalPages - 1;
        }

        function prevPagePrimacOdjeli() {
            if (primacOdjeliCurrentPage > 0) {
                primacOdjeliCurrentPage--;
                renderPrimacOdjeliPage();
            }
        }

        function nextPagePrimacOdjeli() {
            const totalPages = Math.ceil(primacOdjeliData.odjeli.length / primacOdjeliPageSize);
            if (primacOdjeliCurrentPage < totalPages - 1) {
                primacOdjeliCurrentPage++;
                renderPrimacOdjeliPage();
            }
        }

        // Load otpremac odjeli data
        async function loadOtpremacOdjeli() {
            document.getElementById('loading-screen').classList.remove('hidden');
            document.getElementById('otpremac-odjeli-content').classList.add('hidden');

            try {
                const year = new Date().getFullYear();
                const url = `${API_URL}?path=otpremac-odjeli&year=${year}&username=${currentUser.username}&password=${currentPassword}`;
                const data = await fetchWithCache(url, 'cache_otpremac_odjeli_' + year);

                console.log('Otpremac odjeli data:', data);

                if (data.error) {
                    throw new Error(data.error);
                }

                otpremacOdjeliData = data;
                otpremacOdjeliCurrentPage = 0;
                renderOtpremacOdjeliPage();

                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('otpremac-odjeli-content').classList.remove('hidden');

            } catch (error) {
                alert('Gre≈°ka pri uƒçitavanju podataka: ' + error.message);
                document.getElementById('loading-screen').innerHTML = '<div class="loading-icon">‚ùå</div><div class="loading-text">Gre≈°ka pri uƒçitavanju</div><div class="loading-sub">' + error.message + '</div>';
            }
        }

        function renderOtpremacOdjeliPage() {
            if (!otpremacOdjeliData) return;

            const start = otpremacOdjeliCurrentPage * otpremacOdjeliPageSize;
            const end = Math.min(start + otpremacOdjeliPageSize, otpremacOdjeliData.odjeli.length);
            const pageOdjeli = otpremacOdjeliData.odjeli.slice(start, end);

            let html = '';

            pageOdjeli.forEach(odjel => {
                // Kreiraj HTML za odjel sa dve tabele
                html += `
                    <div style="margin-bottom: 40px; border: 2px solid #2563eb; border-radius: 12px; padding: 20px; background: #eff6ff;">
                        <h3 style="color: #1e40af; margin-bottom: 16px;">üìÅ ${odjel.odjel}</h3>
                        <p style="font-size: 13px; color: #6b7280; margin-bottom: 16px;">Zadnji unos: ${odjel.zadnjiDatum || 'N/A'}</p>

                        <!-- Apsolutne vrijednosti -->
                        <h4 style="font-size: 15px; margin-bottom: 8px; color: #2563eb;">Apsolutne vrijednosti (m¬≥)</h4>
                        <div class="kupci-table-wrapper" style="margin-bottom: 20px;">
                            <table class="kupci-table">
                                <thead>
                                    <tr>
                                        ${otpremacOdjeliData.sortimentiNazivi.map(s => `<th class="sortiment-col">${s}</th>`).join('')}
                                        <th class="ukupno-col">Ukupno</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        ${otpremacOdjeliData.sortimentiNazivi.map(s => {
                                            const val = odjel.sortimenti[s] || 0;
                                            return `<td class="sortiment-col">${val > 0 ? val.toFixed(2) : '-'}</td>`;
                                        }).join('')}
                                        <td class="ukupno-col">${odjel.ukupno.toFixed(2)}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Procentualne vrijednosti -->
                        <h4 style="font-size: 15px; margin-bottom: 8px; color: #2563eb;">Procentualni udio (%)</h4>
                        <div class="kupci-table-wrapper">
                            <table class="kupci-table">
                                <thead>
                                    <tr>
                                        ${otpremacOdjeliData.sortimentiNazivi.map(s => `<th class="sortiment-col">${s}</th>`).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        ${otpremacOdjeliData.sortimentiNazivi.map(s => {
                                            const val = odjel.sortimenti[s] || 0;
                                            const percent = odjel.ukupno > 0 ? (val / odjel.ukupno) * 100 : 0;
                                            return `<td class="sortiment-col">${percent > 0 ? percent.toFixed(1) + '%' : '-'}</td>`;
                                        }).join('')}
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            });

            document.getElementById('otpremac-odjeli-container').innerHTML = html;

            // Update pagination controls
            const totalPages = Math.ceil(otpremacOdjeliData.odjeli.length / otpremacOdjeliPageSize);
            document.getElementById('otpremac-odjeli-page-info').textContent = `Stranica ${otpremacOdjeliCurrentPage + 1} od ${totalPages}`;
            document.getElementById('otpremac-odjeli-prev').disabled = otpremacOdjeliCurrentPage === 0;
            document.getElementById('otpremac-odjeli-next').disabled = otpremacOdjeliCurrentPage >= totalPages - 1;
        }

        function prevPageOtpremacOdjeli() {
            if (otpremacOdjeliCurrentPage > 0) {
                otpremacOdjeliCurrentPage--;
                renderOtpremacOdjeliPage();
            }
        }

        function nextPageOtpremacOdjeli() {
            const totalPages = Math.ceil(otpremacOdjeliData.odjeli.length / otpremacOdjeliPageSize);
            if (otpremacOdjeliCurrentPage < totalPages - 1) {
                otpremacOdjeliCurrentPage++;
                renderOtpremacOdjeliPage();
            }
        }

        // ========================================
        // UTILITY FUNCTIONS
        // ========================================

        // Dark mode toggle
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('dark-mode', isDark ? 'enabled' : 'disabled');
        }

        // Load dark mode preference
        window.addEventListener('DOMContentLoaded', () => {
            const darkMode = localStorage.getItem('dark-mode');
            if (darkMode === 'enabled') {
                document.body.classList.add('dark-mode');
            }
        });

        // Filter dashboard table
        function filterDashboardTable() {
            const input = document.getElementById('dashboard-search');
            const filter = input.value.toUpperCase();
            const table = document.getElementById('dashboard-table');
            const tr = table.getElementsByTagName('tr');

            for (let i = 1; i < tr.length; i++) {
                const td = tr[i].getElementsByTagName('td')[0];
                if (td) {
                    const txtValue = td.textContent || td.innerText;
                    tr[i].style.display = txtValue.toUpperCase().indexOf(filter) > -1 ? '' : 'none';
                }
            }
        }

        // Filter odjeli table
        function filterOdjeliTable() {
            const input = document.getElementById('odjeli-search');
            const filter = input.value.toUpperCase();
            const table = document.getElementById('odjeli-table');
            const tr = table.getElementsByTagName('tr');

            for (let i = 1; i < tr.length; i++) {
                const td = tr[i].getElementsByTagName('td')[0];
                if (td) {
                    const txtValue = td.textContent || td.innerText;
                    tr[i].style.display = txtValue.toUpperCase().indexOf(filter) > -1 ? '' : 'none';
                }
            }
        }

        // Filter primaci table
        function filterPrimaciTable() {
            const input = document.getElementById('primaci-search');
            const filter = input.value.toUpperCase();
            const table = document.getElementById('primaci-table');
            const tr = table.getElementsByTagName('tr');

            for (let i = 1; i < tr.length; i++) {
                const td = tr[i].getElementsByTagName('td')[0];
                if (td) {
                    const txtValue = td.textContent || td.innerText;
                    tr[i].style.display = txtValue.toUpperCase().indexOf(filter) > -1 ? '' : 'none';
                }
            }
        }

        // Filter otpremaci table
        function filterOtremaciTable() {
            const input = document.getElementById('otpremaci-search');
            const filter = input.value.toUpperCase();
            const table = document.getElementById('otpremaci-table');
            const tr = table.getElementsByTagName('tr');

            for (let i = 1; i < tr.length; i++) {
                const td = tr[i].getElementsByTagName('td')[0];
                if (td) {
                    const txtValue = td.textContent || td.innerText;
                    tr[i].style.display = txtValue.toUpperCase().indexOf(filter) > -1 ? '' : 'none';
                }
            }
        }

        // Filter kupci godisnji table
        function filterKupciGodisnjiTable() {
            const input = document.getElementById('kupci-godisnji-search');
            const filter = input.value.toUpperCase();
            const table = document.getElementById('kupci-godisnji-table');
            const tr = table.getElementsByTagName('tr');

            for (let i = 1; i < tr.length; i++) {
                const td = tr[i].getElementsByTagName('td')[0];
                if (td) {
                    const txtValue = td.textContent || td.innerText;
                    tr[i].style.display = txtValue.toUpperCase().indexOf(filter) > -1 ? '' : 'none';
                }
            }
        }

        // Filter kupci mjesecni table
        function filterKupciMjesecniTable() {
            const input = document.getElementById('kupci-mjesecni-search');
            const filter = input.value.toUpperCase();
            const table = document.getElementById('kupci-mjesecni-table');
            const tr = table.getElementsByTagName('tr');

            for (let i = 1; i < tr.length; i++) {
                const td = tr[i].getElementsByTagName('td')[0];
                if (td) {
                    const txtValue = td.textContent || td.innerText;
                    tr[i].style.display = txtValue.toUpperCase().indexOf(filter) > -1 ? '' : 'none';
                }
            }
        }

        // Filter primac personal table
        function filterPrimacPersonalTable() {
            const input = document.getElementById('primac-personal-search');
            const filter = input.value.toUpperCase();
            const table = document.getElementById('primac-personal-table');
            const tr = table.getElementsByTagName('tr');

            for (let i = 1; i < tr.length; i++) {
                // Search in both datum and odjel columns (0 and 1)
                const td0 = tr[i].getElementsByTagName('td')[0];
                const td1 = tr[i].getElementsByTagName('td')[1];
                if (td0 || td1) {
                    const txtValue = (td0 ? (td0.textContent || td0.innerText) : '') + ' ' +
                                     (td1 ? (td1.textContent || td1.innerText) : '');
                    tr[i].style.display = txtValue.toUpperCase().indexOf(filter) > -1 ? '' : 'none';
                }
            }
        }

        // Filter otpremac personal table
        function filterOtpremacPersonalTable() {
            const input = document.getElementById('otpremac-personal-search');
            const filter = input.value.toUpperCase();
            const table = document.getElementById('otpremac-personal-table');
            const tr = table.getElementsByTagName('tr');

            for (let i = 1; i < tr.length; i++) {
                // Search in datum, odjel, and kupac columns (0, 1, and 2)
                const td0 = tr[i].getElementsByTagName('td')[0];
                const td1 = tr[i].getElementsByTagName('td')[1];
                const td2 = tr[i].getElementsByTagName('td')[2];
                if (td0 || td1 || td2) {
                    const txtValue = (td0 ? (td0.textContent || td0.innerText) : '') + ' ' +
                                     (td1 ? (td1.textContent || td1.innerText) : '') + ' ' +
                                     (td2 ? (td2.textContent || td2.innerText) : '');
                    tr[i].style.display = txtValue.toUpperCase().indexOf(filter) > -1 ? '' : 'none';
                }
            }
        }

        // Export table to CSV
        function exportTableToCSV(tableType) {
            let table, filename;

            if (tableType === 'dashboard') {
                table = document.getElementById('dashboard-table');
                filename = 'dashboard_pregled.csv';
            } else if (tableType === 'odjeli') {
                table = document.getElementById('odjeli-table');
                filename = 'odjeli_pregled.csv';
            } else if (tableType === 'primaci') {
                table = document.getElementById('primaci-table');
                filename = 'primaci_pregled.csv';
            } else if (tableType === 'otpremaci') {
                table = document.getElementById('otpremaci-table');
                filename = 'otpremaci_pregled.csv';
            } else if (tableType === 'kupci-godisnji') {
                table = document.getElementById('kupci-godisnji-table');
                filename = 'kupci_godisnji_pregled.csv';
            } else if (tableType === 'kupci-mjesecni') {
                table = document.getElementById('kupci-mjesecni-table');
                filename = 'kupci_mjesecni_pregled.csv';
            } else if (tableType === 'primac-personal') {
                table = document.getElementById('primac-personal-table');
                filename = 'moja_sjeca_' + new Date().getFullYear() + '.csv';
            } else if (tableType === 'otpremac-personal') {
                table = document.getElementById('otpremac-personal-table');
                filename = 'moja_otprema_' + new Date().getFullYear() + '.csv';
            }

            const rows = table.querySelectorAll('tr');
            const csv = [];

            for (let i = 0; i < rows.length; i++) {
                const row = [], cols = rows[i].querySelectorAll('td, th');

                for (let j = 0; j < cols.length; j++) {
                    let data = cols[j].innerText.replace(/(\r\n|\n|\r)/gm, '').replace(/"/g, '""');
                    row.push('"' + data + '"');
                }

                csv.push(row.join(','));
            }

            const csvString = csv.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Sort table
        function sortTable(columnIndex, tableId) {
            const table = document.getElementById(tableId);
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));

            const sortedRows = rows.sort((a, b) => {
                const aValue = a.querySelectorAll('td')[columnIndex].innerText;
                const bValue = b.querySelectorAll('td')[columnIndex].innerText;

                // Try to parse as number
                const aNum = parseFloat(aValue.replace(/[^\d.-]/g, ''));
                const bNum = parseFloat(bValue.replace(/[^\d.-]/g, ''));

                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return aNum - bNum;
                } else {
                    return aValue.localeCompare(bValue, 'bs');
                }
            });

            // Toggle sort direction
            if (table.dataset.lastSort === columnIndex.toString()) {
                sortedRows.reverse();
                table.dataset.lastSort = '';
            } else {
                table.dataset.lastSort = columnIndex.toString();
            }

            // Re-append sorted rows
            sortedRows.forEach(row => tbody.appendChild(row));
        }

        // ========== DODANI UNOSI VIEW ==========

        // Load Dodani Unosi (Pending entries)
        // Helper to determine column group
        function getColumnGroup(sortiment) {
            const cetinariCols = ['F/L ƒå', 'I ƒå', 'II ƒå', 'III ƒå', 'RUDNO', 'CEL.DUGA', 'CEL.CIJEPANA', 'TRUPCI ƒå', 'ƒåETINARI'];
            const liscariCols = ['F/L L', 'I L', 'II L', 'III L', 'OGR.DUGI', 'OGR.CIJEPANI', 'TRUPCI L', 'LI≈†ƒÜARI'];

            if (cetinariCols.includes(sortiment)) return 'col-group-cetinari';
            if (liscariCols.includes(sortiment)) return 'col-group-liscari';
            return '';
        }

        // Render pending table with filters
        function renderPendingTable(data) {
            let html = '';

            if (!data || data.length === 0) {
                html = '<p style="text-align: center; padding: 40px; color: #6b7280;">Nema dodanih unosa</p>';
            } else {
                // Get sortimenti names from first item
                const sortimentiNazivi = data[0] && data[0].sortimenti ? Object.keys(data[0].sortimenti) : [];

                html = '<div class="kupci-table-wrapper"><table class="kupci-table"><thead><tr>';
                html += '<th style="min-width: 80px;">Tip</th>';
                html += '<th style="min-width: 100px;">Datum</th>';
                html += '<th style="min-width: 80px;">Odjel</th>';
                html += '<th style="min-width: 150px;">Radnik</th>';
                html += '<th style="min-width: 120px;">Kupac</th>';

                // Sortimenti headers with grouping
                for (let i = 0; i < sortimentiNazivi.length; i++) {
                    const colClass = getColumnGroup(sortimentiNazivi[i]);
                    html += '<th class="sortiment-col ' + colClass + '">' + sortimentiNazivi[i] + '</th>';
                }

                html += '<th style="min-width: 130px;">Poslano</th>';
                html += '<th style="min-width: 80px;"></th>'; // Actions column
                html += '</tr></thead><tbody>';

                // Render rows
                for (let i = 0; i < data.length; i++) {
                    const unos = data[i];
                    const tipColor = unos.tip === 'SJEƒåA' ? '#059669' : '#2563eb';

                    html += '<tr>';
                    html += '<td><span style="font-weight: 600; color: ' + tipColor + '">' + unos.tip + '</span></td>';
                    html += '<td>' + unos.datum + '</td>';
                    html += '<td style="font-weight: 600;">' + unos.odjel + '</td>';
                    html += '<td>' + unos.radnik + '</td>';
                    html += '<td>' + (unos.kupac || '-') + '</td>';

                    // Sortimenti values with grouping
                    for (let j = 0; j < sortimentiNazivi.length; j++) {
                        const sortiment = sortimentiNazivi[j];
                        // Use calculated ukupno for SVEUKUPNO instead of saved value
                        const val = sortiment === 'SVEUKUPNO' ? unos.ukupno : (unos.sortimenti[sortiment] || 0);
                        const displayVal = val > 0 ? val.toFixed(2) : '-';
                        const colClass = getColumnGroup(sortiment);
                        html += '<td class="sortiment-col right ' + colClass + '">' + displayVal + '</td>';
                    }

                    html += '<td style="font-size: 11px; color: #6b7280;">' + unos.timestamp + '</td>';

                    // Row actions dropdown
                    html += '<td>';
                    html += '<div class="row-actions">';
                    html += '<button class="row-actions-btn" onclick="toggleRowActions(' + unos.id + ')">‚ãÆ</button>';
                    html += '<div class="row-actions-dropdown" id="row-actions-' + unos.id + '">';
                    html += '<div class="row-actions-item" onclick="editPendingUnos(' + unos.id + ', \'' + unos.tip + '\')">‚úèÔ∏è Uredi</div>';
                    html += '<div class="row-actions-item danger" onclick="deletePendingUnos(' + unos.id + ', \'' + unos.tip + '\')">üóëÔ∏è Obri≈°i</div>';
                    html += '</div>';
                    html += '</div>';
                    html += '</td>';

                    html += '</tr>';
                }

                html += '</tbody></table></div>';

                // Add summary
                html += '<div style="margin-top: 20px; padding: 12px; background: #f9fafb; border-radius: 8px;">';
                html += '<strong>Ukupno dodanih unosa:</strong> ' + data.length;

                let sjecaCount = 0;
                let otpremaCount = 0;
                for (let i = 0; i < data.length; i++) {
                    if (data[i].tip === 'SJEƒåA') sjecaCount++;
                    else if (data[i].tip === 'OTPREMA') otpremaCount++;
                }

                html += ' (Sjeƒça: ' + sjecaCount + ', Otprema: ' + otpremaCount + ')';
                html += '</div>';
            }

            document.getElementById('pending-unosi-container').innerHTML = html;
        }

        async function loadPendingUnosi() {
            document.getElementById('loading-screen').classList.remove('hidden');
            document.getElementById('pending-unosi-content').classList.add('hidden');

            try {
                const year = new Date().getFullYear();
                const url = API_URL + '?path=pending-unosi&year=' + year + '&username=' + currentUser.username + '&password=' + currentPassword;

                // Don't cache pending entries - always fetch fresh
                const response = await fetch(url);
                const data = await response.json();

                console.log('Dodani unosi data:', data);

                if (data.error) {
                    throw new Error(data.error);
                }

                // Store unfiltered data for filtering
                unfilteredPendingData = data.unosi || [];

                // Render table
                renderPendingTable(unfilteredPendingData);

                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('pending-unosi-content').classList.remove('hidden');

            } catch (error) {
                console.error('Error loading dodani unosi:', error);
                document.getElementById('pending-unosi-container').innerHTML =
                    '<p style="color: #dc2626; text-align: center; padding: 40px;">Gre≈°ka: ' + error.message + '</p>';
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('pending-unosi-content').classList.remove('hidden');
            }
        }

        // Edit pending unos (placeholder for future implementation)
        function editPendingUnos(id, tip) {
            alert('üìù Ureƒëivanje unosa #' + id + ' (Tip: ' + tip + ') - Ova funkcionalnost ƒáe biti dodana uskoro.');
            // Close dropdown
            const dropdown = document.getElementById('row-actions-' + id);
            if (dropdown) dropdown.classList.remove('show');
        }

        // Delete pending unos with modal confirmation
        function deletePendingUnos(id, tip) {
            // Close dropdown first
            const dropdown = document.getElementById('row-actions-' + id);
            if (dropdown) dropdown.classList.remove('show');

            // Show confirmation modal
            showConfirmModal(
                'Potvrda brisanja',
                'Da li ste sigurni da ≈æelite obrisati ovaj unos? (ID: ' + id + ', Tip: ' + tip + ')',
                async function() {
                    try {
                        const formData = new URLSearchParams();
                        formData.append('path', 'delete-pending');
                        formData.append('rowIndex', id);
                        // Convert tip to lowercase: SJEƒåA -> sjeca, OTPREMA -> otprema
                        const tipLower = tip === 'SJEƒåA' ? 'sjeca' : 'otprema';
                        formData.append('tip', tipLower);
                        formData.append('username', currentUser.username);
                        formData.append('password', currentPassword);

                        const url = API_URL + '?' + formData.toString();
                        const response = await fetch(url);
                        const result = await response.json();

                        if (result.success) {
                            alert('‚úÖ ' + result.message);
                            loadPendingUnosi();
                        } else {
                            throw new Error(result.error || 'Unknown error');
                        }
                    } catch (error) {
                        alert('‚ùå Gre≈°ka: ' + error.message);
                    }
                }
            );
        }

        // Calculate Sjeca totals automatically
        function calculateSjeca() {
            // Get all ƒçetinar values
            var flC = parseFloat(document.getElementById('sjeca-FL-C').value) || 0;
            var iC = parseFloat(document.getElementById('sjeca-I-C').value) || 0;
            var iiC = parseFloat(document.getElementById('sjeca-II-C').value) || 0;
            var iiiC = parseFloat(document.getElementById('sjeca-III-C').value) || 0;
            var rudno = parseFloat(document.getElementById('sjeca-RUDNO').value) || 0;
            var celDuga = parseFloat(document.getElementById('sjeca-CEL-DUGA').value) || 0;
            var celCijepana = parseFloat(document.getElementById('sjeca-CEL-CIJEPANA').value) || 0;

            // Calculate TRUPCI ƒå = F/L ƒå + I ƒå + II ƒå + III ƒå + RUDNO
            var trupciC = flC + iC + iiC + iiiC + rudno;
            document.getElementById('sjeca-TRUPCI-C').value = trupciC.toFixed(2);

            // Calculate ƒåETINARI = CEL.DUGA + CEL.CIJEPANA + TRUPCI ƒå
            var cetinari = celDuga + celCijepana + trupciC;
            document.getElementById('sjeca-CETINARI').value = cetinari.toFixed(2);

            // Get all li≈°ƒáar values
            var flL = parseFloat(document.getElementById('sjeca-FL-L').value) || 0;
            var iL = parseFloat(document.getElementById('sjeca-I-L').value) || 0;
            var iiL = parseFloat(document.getElementById('sjeca-II-L').value) || 0;
            var iiiL = parseFloat(document.getElementById('sjeca-III-L').value) || 0;
            var ogrDugi = parseFloat(document.getElementById('sjeca-OGR-DUGI').value) || 0;
            var ogrCijepani = parseFloat(document.getElementById('sjeca-OGR-CIJEPANI').value) || 0;

            // Calculate TRUPCI L = F/L L + I L + II L + III L
            var trupciL = flL + iL + iiL + iiiL;
            document.getElementById('sjeca-TRUPCI').value = trupciL.toFixed(2);

            // Calculate LI≈†ƒÜARI = OGR.DUGI + OGR.CIJEPANI + TRUPCI L
            var liscari = ogrDugi + ogrCijepani + trupciL;
            document.getElementById('sjeca-LISCARI').value = liscari.toFixed(2);

            // Calculate SVEUKUPNO = ƒåETINARI + LI≈†ƒÜARI
            var sveukupno = cetinari + liscari;
            document.getElementById('sjeca-SVEUKUPNO').value = sveukupno.toFixed(2);
        }

        // Calculate Otprema totals automatically
        function calculateOtprema() {
            // Get all ƒçetinar values
            var flC = parseFloat(document.getElementById('otprema-FL-C').value) || 0;
            var iC = parseFloat(document.getElementById('otprema-I-C').value) || 0;
            var iiC = parseFloat(document.getElementById('otprema-II-C').value) || 0;
            var iiiC = parseFloat(document.getElementById('otprema-III-C').value) || 0;
            var rudno = parseFloat(document.getElementById('otprema-RUDNO').value) || 0;
            var celDuga = parseFloat(document.getElementById('otprema-CEL-DUGA').value) || 0;
            var celCijepana = parseFloat(document.getElementById('otprema-CEL-CIJEPANA').value) || 0;

            // Calculate TRUPCI ƒå = F/L ƒå + I ƒå + II ƒå + III ƒå + RUDNO
            var trupciC = flC + iC + iiC + iiiC + rudno;
            document.getElementById('otprema-TRUPCI-C').value = trupciC.toFixed(2);

            // Calculate ƒåETINARI = CEL.DUGA + CEL.CIJEPANA + TRUPCI ƒå
            var cetinari = celDuga + celCijepana + trupciC;
            document.getElementById('otprema-CETINARI').value = cetinari.toFixed(2);

            // Get all li≈°ƒáar values
            var flL = parseFloat(document.getElementById('otprema-FL-L').value) || 0;
            var iL = parseFloat(document.getElementById('otprema-I-L').value) || 0;
            var iiL = parseFloat(document.getElementById('otprema-II-L').value) || 0;
            var iiiL = parseFloat(document.getElementById('otprema-III-L').value) || 0;
            var ogrDugi = parseFloat(document.getElementById('otprema-OGR-DUGI').value) || 0;
            var ogrCijepani = parseFloat(document.getElementById('otprema-OGR-CIJEPANI').value) || 0;

            // Calculate TRUPCI L = F/L L + I L + II L + III L
            var trupciL = flL + iL + iiL + iiiL;
            document.getElementById('otprema-TRUPCI').value = trupciL.toFixed(2);

            // Calculate LI≈†ƒÜARI = OGR.DUGI + OGR.CIJEPANI + TRUPCI L
            var liscari = ogrDugi + ogrCijepani + trupciL;
            document.getElementById('otprema-LISCARI').value = liscari.toFixed(2);

            // Calculate SVEUKUPNO = ƒåETINARI + LI≈†ƒÜARI
            var sveukupno = cetinari + liscari;
            document.getElementById('otprema-SVEUKUPNO').value = sveukupno.toFixed(2);
        }

        // Show Add Sjeca Form
        function showAddSjecaForm() {
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('add-sjeca-content').classList.remove('hidden');

            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('sjeca-datum').value = today;

            // Add event listeners to all sortimenti inputs for automatic calculation
            const sjecaInputIds = ['sjeca-FL-C', 'sjeca-I-C', 'sjeca-II-C', 'sjeca-III-C', 'sjeca-RUDNO',
                                   'sjeca-CEL-DUGA', 'sjeca-CEL-CIJEPANA',
                                   'sjeca-FL-L', 'sjeca-I-L', 'sjeca-II-L', 'sjeca-III-L',
                                   'sjeca-OGR-DUGI', 'sjeca-OGR-CIJEPANI'];

            sjecaInputIds.forEach(function(inputId) {
                const element = document.getElementById(inputId);
                if (element && !element.hasAttribute('data-listener-added')) {
                    element.addEventListener('input', calculateSjeca);
                    element.setAttribute('data-listener-added', 'true');
                }
            });

            // Initial calculation
            calculateSjeca();
        }

        // Show Add Otprema Form
        function showAddOtpremaForm() {
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('add-otprema-content').classList.remove('hidden');

            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('otprema-datum').value = today;

            // Add event listeners to all sortimenti inputs for automatic calculation
            const otpremaInputIds = ['otprema-FL-C', 'otprema-I-C', 'otprema-II-C', 'otprema-III-C', 'otprema-RUDNO',
                                     'otprema-CEL-DUGA', 'otprema-CEL-CIJEPANA',
                                     'otprema-FL-L', 'otprema-I-L', 'otprema-II-L', 'otprema-III-L',
                                     'otprema-OGR-DUGI', 'otprema-OGR-CIJEPANI'];

            otpremaInputIds.forEach(function(inputId) {
                const element = document.getElementById(inputId);
                if (element && !element.hasAttribute('data-listener-added')) {
                    element.addEventListener('input', calculateOtprema);
                    element.setAttribute('data-listener-added', 'true');
                }
            });

            // Initial calculation
            calculateOtprema();
        }

        // Submit Sjeca Form
        async function submitSjeca(event) {
            event.preventDefault();

            const submitBtn = document.getElementById('submit-sjeca-btn');
            const messageDiv = document.getElementById('sjeca-message');

            submitBtn.disabled = true;
            submitBtn.textContent = 'Dodavanje...';
            messageDiv.classList.add('hidden');

            try {
                // Collect form data
                const formData = new URLSearchParams();
                formData.append('path', 'add-sjeca');
                formData.append('username', currentUser.username);
                formData.append('password', currentPassword);
                formData.append('datum', document.getElementById('sjeca-datum').value);
                formData.append('odjel', document.getElementById('sjeca-odjel').value);
                formData.append('F/L ƒå', document.getElementById('sjeca-FL-C').value);
                formData.append('I ƒå', document.getElementById('sjeca-I-C').value);
                formData.append('II ƒå', document.getElementById('sjeca-II-C').value);
                formData.append('III ƒå', document.getElementById('sjeca-III-C').value);
                formData.append('RUDNO', document.getElementById('sjeca-RUDNO').value);
                formData.append('TRUPCI ƒå', document.getElementById('sjeca-TRUPCI-C').value);
                formData.append('CEL.DUGA', document.getElementById('sjeca-CEL-DUGA').value);
                formData.append('CEL.CIJEPANA', document.getElementById('sjeca-CEL-CIJEPANA').value);
                formData.append('ƒåETINARI', document.getElementById('sjeca-CETINARI').value);
                formData.append('F/L L', document.getElementById('sjeca-FL-L').value);
                formData.append('I L', document.getElementById('sjeca-I-L').value);
                formData.append('II L', document.getElementById('sjeca-II-L').value);
                formData.append('III L', document.getElementById('sjeca-III-L').value);
                formData.append('TRUPCI', document.getElementById('sjeca-TRUPCI').value);
                formData.append('OGR.DUGI', document.getElementById('sjeca-OGR-DUGI').value);
                formData.append('OGR.CIJEPANI', document.getElementById('sjeca-OGR-CIJEPANI').value);
                formData.append('LI≈†ƒÜARI', document.getElementById('sjeca-LISCARI').value);

                // Send request (don't cache this)
                const url = `${API_URL}?${formData.toString()}`;
                const response = await fetch(url);
                const result = await response.json();

                if (result.success) {
                    messageDiv.innerHTML = `‚úÖ ${result.message}<br>Ukupno: ${result.ukupno.toFixed(2)} m¬≥`;
                    messageDiv.style.background = '#d1fae5';
                    messageDiv.style.color = '#047857';
                    messageDiv.classList.remove('hidden');

                    // Reset form
                    setTimeout(() => {
                        resetSjecaForm();
                        messageDiv.classList.add('hidden');
                    }, 3000);

                    // Clear cache so new data shows up
                    const year = new Date().getFullYear();
                    localStorage.removeItem('cache_primac_detail_' + year);
                    localStorage.removeItem('cache_primac_odjeli_' + year);
                    localStorage.removeItem('cache_dashboard_' + year);
                } else {
                    throw new Error(result.error || 'Unknown error');
                }

            } catch (error) {
                messageDiv.innerHTML = `‚ùå Gre≈°ka: ${error.message}`;
                messageDiv.style.background = '#fee2e2';
                messageDiv.style.color = '#991b1b';
                messageDiv.classList.remove('hidden');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Dodaj sjeƒçu';
            }
        }

        // Submit Otprema Form
        async function submitOtprema(event) {
            event.preventDefault();

            const submitBtn = document.getElementById('submit-otprema-btn');
            const messageDiv = document.getElementById('otprema-message');

            submitBtn.disabled = true;
            submitBtn.textContent = 'Dodavanje...';
            messageDiv.classList.add('hidden');

            try {
                // Collect form data
                const formData = new URLSearchParams();
                formData.append('path', 'add-otprema');
                formData.append('username', currentUser.username);
                formData.append('password', currentPassword);
                formData.append('datum', document.getElementById('otprema-datum').value);
                formData.append('odjel', document.getElementById('otprema-odjel').value);
                formData.append('kupac', document.getElementById('otprema-kupac').value);
                formData.append('F/L ƒå', document.getElementById('otprema-FL-C').value);
                formData.append('I ƒå', document.getElementById('otprema-I-C').value);
                formData.append('II ƒå', document.getElementById('otprema-II-C').value);
                formData.append('III ƒå', document.getElementById('otprema-III-C').value);
                formData.append('RUDNO', document.getElementById('otprema-RUDNO').value);
                formData.append('TRUPCI ƒå', document.getElementById('otprema-TRUPCI-C').value);
                formData.append('CEL.DUGA', document.getElementById('otprema-CEL-DUGA').value);
                formData.append('CEL.CIJEPANA', document.getElementById('otprema-CEL-CIJEPANA').value);
                formData.append('ƒåETINARI', document.getElementById('otprema-CETINARI').value);
                formData.append('F/L L', document.getElementById('otprema-FL-L').value);
                formData.append('I L', document.getElementById('otprema-I-L').value);
                formData.append('II L', document.getElementById('otprema-II-L').value);
                formData.append('III L', document.getElementById('otprema-III-L').value);
                formData.append('TRUPCI', document.getElementById('otprema-TRUPCI').value);
                formData.append('OGR.DUGI', document.getElementById('otprema-OGR-DUGI').value);
                formData.append('OGR.CIJEPANI', document.getElementById('otprema-OGR-CIJEPANI').value);
                formData.append('LI≈†ƒÜARI', document.getElementById('otprema-LISCARI').value);

                // Send request (don't cache this)
                const url = `${API_URL}?${formData.toString()}`;
                const response = await fetch(url);
                const result = await response.json();

                if (result.success) {
                    messageDiv.innerHTML = `‚úÖ ${result.message}<br>Ukupno: ${result.ukupno.toFixed(2)} m¬≥`;
                    messageDiv.style.background = '#dbeafe';
                    messageDiv.style.color = '#1e40af';
                    messageDiv.classList.remove('hidden');

                    // Reset form
                    setTimeout(() => {
                        resetOtpremaForm();
                        messageDiv.classList.add('hidden');
                    }, 3000);

                    // Clear cache so new data shows up
                    const year = new Date().getFullYear();
                    localStorage.removeItem('cache_otpremac_detail_' + year);
                    localStorage.removeItem('cache_otpremac_odjeli_' + year);
                    localStorage.removeItem('cache_dashboard_' + year);
                } else {
                    throw new Error(result.error || 'Unknown error');
                }

            } catch (error) {
                messageDiv.innerHTML = `‚ùå Gre≈°ka: ${error.message}`;
                messageDiv.style.background = '#fee2e2';
                messageDiv.style.color = '#991b1b';
                messageDiv.classList.remove('hidden');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Dodaj otpremu';
            }
        }

        // Reset Sjeca Form
        function resetSjecaForm() {
            document.getElementById('add-sjeca-form').reset();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('sjeca-datum').value = today;

            // Reset all sortimenti to 0
            document.querySelectorAll('#add-sjeca-form input[type="number"]').forEach(input => {
                input.value = 0;
            });

            // Recalculate totals
            calculateSjeca();
        }

        // Reset Otprema Form
        function resetOtpremaForm() {
            document.getElementById('add-otprema-form').reset();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('otprema-datum').value = today;

            // Reset all sortimenti to 0
            document.querySelectorAll('#add-otprema-form input[type="number"]').forEach(input => {
                input.value = 0;
            });

            // Recalculate totals
            calculateOtprema();
        }

        // ==================== MY PENDING ENTRIES FUNCTIONS ====================

        // Load My Sjece (last 10 pending entries for current user)
        async function loadMySjece() {
            document.getElementById('loading-screen').classList.remove('hidden');
            document.getElementById('my-sjece-content').classList.add('hidden');

            try {
                const url = API_URL + '?path=my-pending&username=' + currentUser.username + '&password=' + currentPassword + '&tip=sjeca';
                const response = await fetch(url);
                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                var html = '<div style="overflow-x: auto;">';

                if (data.unosi && data.unosi.length > 0) {
                    html += '<table style="width: 100%; border-collapse: collapse; margin-top: 20px;">';
                    html += '<thead><tr style="background: #047857; color: white;">';
                    html += '<th style="padding: 12px; border: 1px solid #ddd;">Datum</th>';
                    html += '<th style="padding: 12px; border: 1px solid #ddd;">Odjel</th>';
                    html += '<th style="padding: 12px; border: 1px solid #ddd;">ƒåETINARI</th>';
                    html += '<th style="padding: 12px; border: 1px solid #ddd;">LI≈†ƒÜARI</th>';
                    html += '<th style="padding: 12px; border: 1px solid #ddd;">Ukupno</th>';
                    html += '<th style="padding: 12px; border: 1px solid #ddd;">Vrijeme unosa</th>';
                    html += '<th style="padding: 12px; border: 1px solid #ddd;">Akcije</th>';
                    html += '</tr></thead><tbody>';

                    for (var i = 0; i < data.unosi.length; i++) {
                        var unos = data.unosi[i];
                        var cetinari = parseFloat(unos.sortimenti['ƒåETINARI'] || 0);
                        var liscari = parseFloat(unos.sortimenti['LI≈†ƒÜARI'] || 0);
                        var ukupno = cetinari + liscari;

                        html += '<tr style="' + (i % 2 === 0 ? 'background: #f9fafb;' : '') + '">';
                        html += '<td style="padding: 10px; border: 1px solid #ddd;">' + unos.datum + '</td>';
                        html += '<td style="padding: 10px; border: 1px solid #ddd;">' + unos.odjel + '</td>';
                        html += '<td style="padding: 10px; border: 1px solid #ddd;">' + cetinari.toFixed(2) + ' m¬≥</td>';
                        html += '<td style="padding: 10px; border: 1px solid #ddd;">' + liscari.toFixed(2) + ' m¬≥</td>';
                        html += '<td style="padding: 10px; border: 1px solid #ddd; font-weight: bold;">' + ukupno.toFixed(2) + ' m¬≥</td>';
                        html += '<td style="padding: 10px; border: 1px solid #ddd;">' + new Date(unos.timestamp).toLocaleString('hr-HR') + '</td>';
                        html += '<td style="padding: 10px; border: 1px solid #ddd; text-align: center;">';
                        html += '<button class="btn btn-primary" style="margin-right: 8px;" onclick=\'editMySjeca(' + JSON.stringify(unos).replace(/'/g, "\\'") + ')\'><‚úèÔ∏è Uredi</button>';
                        html += '<button class="btn btn-secondary" onclick="deleteMySjeca(' + unos.rowIndex + ')">üóëÔ∏è Obri≈°i</button>';
                        html += '</td>';
                        html += '</tr>';
                    }

                    html += '</tbody></table>';
                } else {
                    html += '<p style="text-align: center; color: #6b7280; padding: 40px;">Nemate pending unosa.</p>';
                }

                html += '</div>';

                document.getElementById('my-sjece-container').innerHTML = html;
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('my-sjece-content').classList.remove('hidden');

            } catch (error) {
                console.error('Error loading my sjece:', error);
                document.getElementById('my-sjece-container').innerHTML = '<p style="color: #dc2626; text-align: center; padding: 40px;">Gre≈°ka: ' + error.message + '</p>';
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('my-sjece-content').classList.remove('hidden');
            }
        }

        // Load My Otpreme (last 10 pending entries for current user)
        async function loadMyOtpreme() {
            document.getElementById('loading-screen').classList.remove('hidden');
            document.getElementById('my-otpreme-content').classList.add('hidden');

            try {
                const url = API_URL + '?path=my-pending&username=' + currentUser.username + '&password=' + currentPassword + '&tip=otprema';
                const response = await fetch(url);
                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                var html = '<div style="overflow-x: auto;">';

                if (data.unosi && data.unosi.length > 0) {
                    html += '<table style="width: 100%; border-collapse: collapse; margin-top: 20px;">';
                    html += '<thead><tr style="background: #2563eb; color: white;">';
                    html += '<th style="padding: 12px; border: 1px solid #ddd;">Datum</th>';
                    html += '<th style="padding: 12px; border: 1px solid #ddd;">Odjel</th>';
                    html += '<th style="padding: 12px; border: 1px solid #ddd;">Kupac</th>';
                    html += '<th style="padding: 12px; border: 1px solid #ddd;">ƒåETINARI</th>';
                    html += '<th style="padding: 12px; border: 1px solid #ddd;">LI≈†ƒÜARI</th>';
                    html += '<th style="padding: 12px; border: 1px solid #ddd;">Ukupno</th>';
                    html += '<th style="padding: 12px; border: 1px solid #ddd;">Vrijeme unosa</th>';
                    html += '<th style="padding: 12px; border: 1px solid #ddd;">Akcije</th>';
                    html += '</tr></thead><tbody>';

                    for (var i = 0; i < data.unosi.length; i++) {
                        var unos = data.unosi[i];
                        var cetinari = parseFloat(unos.sortimenti['ƒåETINARI'] || 0);
                        var liscari = parseFloat(unos.sortimenti['LI≈†ƒÜARI'] || 0);
                        var ukupno = cetinari + liscari;

                        html += '<tr style="' + (i % 2 === 0 ? 'background: #f9fafb;' : '') + '">';
                        html += '<td style="padding: 10px; border: 1px solid #ddd;">' + unos.datum + '</td>';
                        html += '<td style="padding: 10px; border: 1px solid #ddd;">' + unos.odjel + '</td>';
                        html += '<td style="padding: 10px; border: 1px solid #ddd;">' + (unos.kupac || '-') + '</td>';
                        html += '<td style="padding: 10px; border: 1px solid #ddd;">' + cetinari.toFixed(2) + ' m¬≥</td>';
                        html += '<td style="padding: 10px; border: 1px solid #ddd;">' + liscari.toFixed(2) + ' m¬≥</td>';
                        html += '<td style="padding: 10px; border: 1px solid #ddd; font-weight: bold;">' + ukupno.toFixed(2) + ' m¬≥</td>';
                        html += '<td style="padding: 10px; border: 1px solid #ddd;">' + new Date(unos.timestamp).toLocaleString('hr-HR') + '</td>';
                        html += '<td style="padding: 10px; border: 1px solid #ddd; text-align: center;">';
                        html += '<button class="btn btn-primary" style="margin-right: 8px;" onclick=\'editMyOtprema(' + JSON.stringify(unos).replace(/'/g, "\\'") + ')\'>‚úèÔ∏è Uredi</button>';
                        html += '<button class="btn btn-secondary" onclick="deleteMyOtprema(' + unos.rowIndex + ')">üóëÔ∏è Obri≈°i</button>';
                        html += '</td>';
                        html += '</tr>';
                    }

                    html += '</tbody></table>';
                } else {
                    html += '<p style="text-align: center; color: #6b7280; padding: 40px;">Nemate pending unosa.</p>';
                }

                html += '</div>';

                document.getElementById('my-otpreme-container').innerHTML = html;
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('my-otpreme-content').classList.remove('hidden');

            } catch (error) {
                console.error('Error loading my otpreme:', error);
                document.getElementById('my-otpreme-container').innerHTML = '<p style="color: #dc2626; text-align: center; padding: 40px;">Gre≈°ka: ' + error.message + '</p>';
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('my-otpreme-content').classList.remove('hidden');
            }
        }

        // Edit My Sjeca - show edit form
        function editMySjeca(unos) {
            document.getElementById('loading-screen').classList.add('hidden');

            // Hide other content
            document.getElementById('my-sjece-content').classList.add('hidden');

            // Show edit form
            document.getElementById('edit-sjeca-content').classList.remove('hidden');

            // Populate form with existing data
            document.getElementById('edit-sjeca-rowIndex').value = unos.rowIndex;
            document.getElementById('edit-sjeca-datum').value = unos.datum;
            document.getElementById('edit-sjeca-odjel').value = unos.odjel;

            // Build sortimenti fields dynamically
            var sortimentiHtml = '';
            var sortimentiKeys = ['F/L ƒå', 'I ƒå', 'II ƒå', 'III ƒå', 'RUDNO', 'TRUPCI ƒå', 'CEL.DUGA', 'CEL.CIJEPANA', 'ƒåETINARI',
                                 'F/L L', 'I L', 'II L', 'III L', 'TRUPCI', 'OGR.DUGI', 'OGR.CIJEPANI', 'LI≈†ƒÜARI'];

            sortimentiKeys.forEach(function(key) {
                var fieldId = 'edit-sjeca-' + key.replace(/\//g, '').replace(/ /g, '-');
                var value = unos.sortimenti[key] || 0;
                var isCalculated = ['TRUPCI ƒå', 'ƒåETINARI', 'TRUPCI', 'LI≈†ƒÜARI'].indexOf(key) !== -1;
                var readonlyAttr = isCalculated ? 'readonly' : '';
                var styleExtra = isCalculated ? 'background: #f3f4f6; color: #374151; font-weight: 600;' : '';

                sortimentiHtml += '<div class="form-group">';
                sortimentiHtml += '<label>' + key + (isCalculated ? ': <span style="color: #6b7280; font-size: 0.85em;">(auto)</span>' : ':') + '</label>';
                sortimentiHtml += '<input type="number" step="0.01" id="' + fieldId + '" value="' + value + '" min="0" ' + readonlyAttr + ' class="edit-sjeca-input" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%; ' + styleExtra + '">';
                sortimentiHtml += '</div>';
            });

            document.getElementById('edit-sjeca-sortimenti').innerHTML = sortimentiHtml;

            // Add event listeners for auto-calculation
            var inputIds = ['edit-sjeca-FL-ƒå', 'edit-sjeca-I-ƒå', 'edit-sjeca-II-ƒå', 'edit-sjeca-III-ƒå', 'edit-sjeca-RUDNO',
                           'edit-sjeca-CEL.DUGA', 'edit-sjeca-CEL.CIJEPANA',
                           'edit-sjeca-FL-L', 'edit-sjeca-I-L', 'edit-sjeca-II-L', 'edit-sjeca-III-L',
                           'edit-sjeca-OGR.DUGI', 'edit-sjeca-OGR.CIJEPANI'];

            inputIds.forEach(function(inputId) {
                var element = document.getElementById(inputId);
                if (element) {
                    element.addEventListener('input', calculateEditSjeca);
                }
            });

            // Calculate initial totals
            calculateEditSjeca();
        }

        // Calculate Edit Sjeca totals
        function calculateEditSjeca() {
            var flC = parseFloat(document.getElementById('edit-sjeca-FL-ƒå').value) || 0;
            var iC = parseFloat(document.getElementById('edit-sjeca-I-ƒå').value) || 0;
            var iiC = parseFloat(document.getElementById('edit-sjeca-II-ƒå').value) || 0;
            var iiiC = parseFloat(document.getElementById('edit-sjeca-III-ƒå').value) || 0;
            var rudno = parseFloat(document.getElementById('edit-sjeca-RUDNO').value) || 0;
            var celDuga = parseFloat(document.getElementById('edit-sjeca-CEL.DUGA').value) || 0;
            var celCijepana = parseFloat(document.getElementById('edit-sjeca-CEL.CIJEPANA').value) || 0;

            var trupciC = flC + iC + iiC + iiiC + rudno;
            document.getElementById('edit-sjeca-TRUPCI-ƒå').value = trupciC.toFixed(2);

            var cetinari = celDuga + celCijepana + trupciC;
            document.getElementById('edit-sjeca-ƒåETINARI').value = cetinari.toFixed(2);

            var flL = parseFloat(document.getElementById('edit-sjeca-FL-L').value) || 0;
            var iL = parseFloat(document.getElementById('edit-sjeca-I-L').value) || 0;
            var iiL = parseFloat(document.getElementById('edit-sjeca-II-L').value) || 0;
            var iiiL = parseFloat(document.getElementById('edit-sjeca-III-L').value) || 0;
            var ogrDugi = parseFloat(document.getElementById('edit-sjeca-OGR.DUGI').value) || 0;
            var ogrCijepani = parseFloat(document.getElementById('edit-sjeca-OGR.CIJEPANI').value) || 0;

            var trupciL = flL + iL + iiL + iiiL;
            document.getElementById('edit-sjeca-TRUPCI').value = trupciL.toFixed(2);

            var liscari = ogrDugi + ogrCijepani + trupciL;
            document.getElementById('edit-sjeca-LI≈†ƒÜARI').value = liscari.toFixed(2);

            var sveukupno = cetinari + liscari;
            document.getElementById('edit-sjeca-SVEUKUPNO').value = sveukupno.toFixed(2);
        }

        // Submit Edit Sjeca Form
        async function submitEditSjeca(event) {
            event.preventDefault();

            var submitBtn = document.getElementById('submit-edit-sjeca-btn');
            var messageDiv = document.getElementById('edit-sjeca-message');

            submitBtn.disabled = true;
            submitBtn.textContent = 'A≈æuriranje...';
            messageDiv.classList.add('hidden');

            try {
                var formData = new URLSearchParams();
                formData.append('path', 'update-pending');
                formData.append('username', currentUser.username);
                formData.append('password', currentPassword);
                formData.append('tip', 'sjeca');
                formData.append('rowIndex', document.getElementById('edit-sjeca-rowIndex').value);
                formData.append('datum', document.getElementById('edit-sjeca-datum').value);
                formData.append('odjel', document.getElementById('edit-sjeca-odjel').value);

                // Add all sortimenti
                var sortimentiKeys = ['F/L ƒå', 'I ƒå', 'II ƒå', 'III ƒå', 'RUDNO', 'TRUPCI ƒå', 'CEL.DUGA', 'CEL.CIJEPANA', 'ƒåETINARI',
                                     'F/L L', 'I L', 'II L', 'III L', 'TRUPCI', 'OGR.DUGI', 'OGR.CIJEPANI', 'LI≈†ƒÜARI'];

                sortimentiKeys.forEach(function(key) {
                    var fieldId = 'edit-sjeca-' + key.replace(/\//g, '').replace(/ /g, '-');
                    var value = document.getElementById(fieldId).value;
                    formData.append(key, value);
                });

                var url = API_URL + '?' + formData.toString();
                var response = await fetch(url);
                var result = await response.json();

                if (result.success) {
                    messageDiv.innerHTML = '‚úÖ ' + result.message + '<br>Ukupno: ' + result.ukupno.toFixed(2) + ' m¬≥';
                    messageDiv.style.background = '#d1fae5';
                    messageDiv.style.color = '#047857';
                    messageDiv.classList.remove('hidden');

                    setTimeout(function() {
                        switchTab('my-sjece');
                    }, 2000);
                } else {
                    throw new Error(result.error || 'Unknown error');
                }

            } catch (error) {
                messageDiv.innerHTML = '‚ùå Gre≈°ka: ' + error.message;
                messageDiv.style.background = '#fee2e2';
                messageDiv.style.color = '#991b1b';
                messageDiv.classList.remove('hidden');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Saƒçuvaj izmjene';
            }
        }

        // Cancel Edit Sjeca
        function cancelEditSjeca() {
            switchTab('my-sjece');
        }

        // Similar functions for Edit Otprema (abbreviated for space)
        function editMyOtprema(unos) {
            // Similar to editMySjeca but for otprema
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('my-otpreme-content').classList.add('hidden');
            document.getElementById('edit-otprema-content').classList.remove('hidden');

            document.getElementById('edit-otprema-rowIndex').value = unos.rowIndex;
            document.getElementById('edit-otprema-datum').value = unos.datum;
            document.getElementById('edit-otprema-odjel').value = unos.odjel;
            document.getElementById('edit-otprema-kupac').value = unos.kupac || '';

            var sortimentiHtml = '';
            var sortimentiKeys = ['F/L ƒå', 'I ƒå', 'II ƒå', 'III ƒå', 'RUDNO', 'TRUPCI ƒå', 'CEL.DUGA', 'CEL.CIJEPANA', 'ƒåETINARI',
                                 'F/L L', 'I L', 'II L', 'III L', 'TRUPCI', 'OGR.DUGI', 'OGR.CIJEPANI', 'LI≈†ƒÜARI'];

            sortimentiKeys.forEach(function(key) {
                var fieldId = 'edit-otprema-' + key.replace(/\//g, '').replace(/ /g, '-');
                var value = unos.sortimenti[key] || 0;
                var isCalculated = ['TRUPCI ƒå', 'ƒåETINARI', 'TRUPCI', 'LI≈†ƒÜARI'].indexOf(key) !== -1;
                var readonlyAttr = isCalculated ? 'readonly' : '';
                var styleExtra = isCalculated ? 'background: #f3f4f6; color: #374151; font-weight: 600;' : '';

                sortimentiHtml += '<div class="form-group">';
                sortimentiHtml += '<label>' + key + (isCalculated ? ': <span style="color: #6b7280; font-size: 0.85em;">(auto)</span>' : ':') + '</label>';
                sortimentiHtml += '<input type="number" step="0.01" id="' + fieldId + '" value="' + value + '" min="0" ' + readonlyAttr + ' style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%; ' + styleExtra + '">';
                sortimentiHtml += '</div>';
            });

            document.getElementById('edit-otprema-sortimenti').innerHTML = sortimentiHtml;

            var inputIds = ['edit-otprema-FL-ƒå', 'edit-otprema-I-ƒå', 'edit-otprema-II-ƒå', 'edit-otprema-III-ƒå', 'edit-otprema-RUDNO',
                           'edit-otprema-CEL.DUGA', 'edit-otprema-CEL.CIJEPANA',
                           'edit-otprema-FL-L', 'edit-otprema-I-L', 'edit-otprema-II-L', 'edit-otprema-III-L',
                           'edit-otprema-OGR.DUGI', 'edit-otprema-OGR.CIJEPANI'];

            inputIds.forEach(function(inputId) {
                var element = document.getElementById(inputId);
                if (element) {
                    element.addEventListener('input', calculateEditOtprema);
                }
            });

            calculateEditOtprema();
        }

        function calculateEditOtprema() {
            var flC = parseFloat(document.getElementById('edit-otprema-FL-ƒå').value) || 0;
            var iC = parseFloat(document.getElementById('edit-otprema-I-ƒå').value) || 0;
            var iiC = parseFloat(document.getElementById('edit-otprema-II-ƒå').value) || 0;
            var iiiC = parseFloat(document.getElementById('edit-otprema-III-ƒå').value) || 0;
            var rudno = parseFloat(document.getElementById('edit-otprema-RUDNO').value) || 0;
            var celDuga = parseFloat(document.getElementById('edit-otprema-CEL.DUGA').value) || 0;
            var celCijepana = parseFloat(document.getElementById('edit-otprema-CEL.CIJEPANA').value) || 0;

            var trupciC = flC + iC + iiC + iiiC + rudno;
            document.getElementById('edit-otprema-TRUPCI-ƒå').value = trupciC.toFixed(2);

            var cetinari = celDuga + celCijepana + trupciC;
            document.getElementById('edit-otprema-ƒåETINARI').value = cetinari.toFixed(2);

            var flL = parseFloat(document.getElementById('edit-otprema-FL-L').value) || 0;
            var iL = parseFloat(document.getElementById('edit-otprema-I-L').value) || 0;
            var iiL = parseFloat(document.getElementById('edit-otprema-II-L').value) || 0;
            var iiiL = parseFloat(document.getElementById('edit-otprema-III-L').value) || 0;
            var ogrDugi = parseFloat(document.getElementById('edit-otprema-OGR.DUGI').value) || 0;
            var ogrCijepani = parseFloat(document.getElementById('edit-otprema-OGR.CIJEPANI').value) || 0;

            var trupciL = flL + iL + iiL + iiiL;
            document.getElementById('edit-otprema-TRUPCI').value = trupciL.toFixed(2);

            var liscari = ogrDugi + ogrCijepani + trupciL;
            document.getElementById('edit-otprema-LI≈†ƒÜARI').value = liscari.toFixed(2);

            var sveukupno = cetinari + liscari;
            document.getElementById('edit-otprema-SVEUKUPNO').value = sveukupno.toFixed(2);
        }

        async function submitEditOtprema(event) {
            event.preventDefault();

            var submitBtn = document.getElementById('submit-edit-otprema-btn');
            var messageDiv = document.getElementById('edit-otprema-message');

            submitBtn.disabled = true;
            submitBtn.textContent = 'A≈æuriranje...';
            messageDiv.classList.add('hidden');

            try {
                var formData = new URLSearchParams();
                formData.append('path', 'update-pending');
                formData.append('username', currentUser.username);
                formData.append('password', currentPassword);
                formData.append('tip', 'otprema');
                formData.append('rowIndex', document.getElementById('edit-otprema-rowIndex').value);
                formData.append('datum', document.getElementById('edit-otprema-datum').value);
                formData.append('odjel', document.getElementById('edit-otprema-odjel').value);
                formData.append('kupac', document.getElementById('edit-otprema-kupac').value);

                var sortimentiKeys = ['F/L ƒå', 'I ƒå', 'II ƒå', 'III ƒå', 'RUDNO', 'TRUPCI ƒå', 'CEL.DUGA', 'CEL.CIJEPANA', 'ƒåETINARI',
                                     'F/L L', 'I L', 'II L', 'III L', 'TRUPCI', 'OGR.DUGI', 'OGR.CIJEPANI', 'LI≈†ƒÜARI'];

                sortimentiKeys.forEach(function(key) {
                    var fieldId = 'edit-otprema-' + key.replace(/\//g, '').replace(/ /g, '-');
                    var value = document.getElementById(fieldId).value;
                    formData.append(key, value);
                });

                var url = API_URL + '?' + formData.toString();
                var response = await fetch(url);
                var result = await response.json();

                if (result.success) {
                    messageDiv.innerHTML = '‚úÖ ' + result.message + '<br>Ukupno: ' + result.ukupno.toFixed(2) + ' m¬≥';
                    messageDiv.style.background = '#dbeafe';
                    messageDiv.style.color = '#1e40af';
                    messageDiv.classList.remove('hidden');

                    setTimeout(function() {
                        switchTab('my-otpreme');
                    }, 2000);
                } else {
                    throw new Error(result.error || 'Unknown error');
                }

            } catch (error) {
                messageDiv.innerHTML = '‚ùå Gre≈°ka: ' + error.message;
                messageDiv.style.background = '#fee2e2';
                messageDiv.style.color = '#991b1b';
                messageDiv.classList.remove('hidden');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Saƒçuvaj izmjene';
            }
        }

        function cancelEditOtprema() {
            switchTab('my-otpreme');
        }

        // Delete functions
        async function deleteMySjeca(rowIndex) {
            showConfirmModal(
                'Potvrda brisanja',
                'Da li ste sigurni da ≈æelite obrisati ovaj unos sjeƒçe?',
                async function() {
                    try {
                        var formData = new URLSearchParams();
                        formData.append('path', 'delete-pending');
                        formData.append('username', currentUser.username);
                        formData.append('password', currentPassword);
                        formData.append('tip', 'sjeca');
                        formData.append('rowIndex', rowIndex);

                        var url = API_URL + '?' + formData.toString();
                        var response = await fetch(url);
                        var result = await response.json();

                        if (result.success) {
                            alert('‚úÖ ' + result.message);
                            loadMySjece();
                        } else {
                            throw new Error(result.error || 'Unknown error');
                        }
                    } catch (error) {
                        alert('‚ùå Gre≈°ka: ' + error.message);
                    }
                }
            );
        }

        async function deleteMyOtprema(rowIndex) {
            showConfirmModal(
                'Potvrda brisanja',
                'Da li ste sigurni da ≈æelite obrisati ovaj unos otpreme?',
                async function() {
                    try {
                        var formData = new URLSearchParams();
                        formData.append('path', 'delete-pending');
                        formData.append('username', currentUser.username);
                        formData.append('password', currentPassword);
                        formData.append('tip', 'otprema');
                        formData.append('rowIndex', rowIndex);

                        var url = API_URL + '?' + formData.toString();
                        var response = await fetch(url);
                        var result = await response.json();

                        if (result.success) {
                            alert('‚úÖ ' + result.message);
                            loadMyOtpreme();
                        } else {
                            throw new Error(result.error || 'Unknown error');
                        }
                    } catch (error) {
                        alert('‚ùå Gre≈°ka: ' + error.message);
                    }
                }
            );
        }

        // ============================================
        // MODAL FUNCTIONS
        // ============================================

        let confirmCallback = null;

        function showConfirmModal(title, message, onConfirm) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-body').textContent = message;
            confirmCallback = onConfirm;
            document.getElementById('confirm-modal').classList.add('show');

            document.getElementById('modal-confirm-btn').onclick = function() {
                if (confirmCallback) confirmCallback();
                closeConfirmModal();
            };
        }

        function closeConfirmModal() {
            document.getElementById('confirm-modal').classList.remove('show');
            confirmCallback = null;
        }

        // Close modal on overlay click
        document.getElementById('confirm-modal').addEventListener('click', function(e) {
            if (e.target.id === 'confirm-modal') {
                closeConfirmModal();
            }
        });

        // ============================================
        // FILTER FUNCTIONS
        // ============================================

        let unfilteredPendingData = [];

        function applyFilters() {
            const datumOd = document.getElementById('filter-datum-od')?.value;
            const datumDo = document.getElementById('filter-datum-do')?.value;
            const tip = document.getElementById('filter-tip')?.value;
            const search = document.getElementById('filter-search')?.value.toLowerCase();

            let filtered = [...unfilteredPendingData];

            // Filter by date range
            if (datumOd) {
                filtered = filtered.filter(item => {
                    const itemDate = new Date(item.timestampObj);
                    return itemDate >= new Date(datumOd);
                });
            }
            if (datumDo) {
                filtered = filtered.filter(item => {
                    const itemDate = new Date(item.timestampObj);
                    return itemDate <= new Date(datumDo + 'T23:59:59');
                });
            }

            // Filter by type
            if (tip) {
                filtered = filtered.filter(item => item.tip === tip);
            }

            // Filter by search text
            if (search) {
                filtered = filtered.filter(item => {
                    const searchText = (
                        (item.odjel || '') + ' ' +
                        (item.radnik || '') + ' ' +
                        (item.kupac || '')
                    ).toLowerCase();
                    return searchText.includes(search);
                });
            }

            // Re-render table with filtered data
            renderPendingTable(filtered);
        }

        function clearFilters() {
            const filterDatumOd = document.getElementById('filter-datum-od');
            const filterDatumDo = document.getElementById('filter-datum-do');
            const filterTip = document.getElementById('filter-tip');
            const filterSearch = document.getElementById('filter-search');

            if (filterDatumOd) filterDatumOd.value = '';
            if (filterDatumDo) filterDatumDo.value = '';
            if (filterTip) filterTip.value = '';
            if (filterSearch) filterSearch.value = '';

            renderPendingTable(unfilteredPendingData);
        }

        // ============================================
        // ROW ACTIONS DROPDOWN
        // ============================================

        function toggleRowActions(id) {
            const dropdown = document.getElementById('row-actions-' + id);
            const allDropdowns = document.querySelectorAll('.row-actions-dropdown');

            // Close all other dropdowns
            allDropdowns.forEach(d => {
                if (d.id !== 'row-actions-' + id) {
                    d.classList.remove('show');
                }
            });

            // Toggle this dropdown
            dropdown.classList.toggle('show');
        }

        // Close row actions when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.row-actions')) {
                const allDropdowns = document.querySelectorAll('.row-actions-dropdown');
                allDropdowns.forEach(d => d.classList.remove('show'));
            }
        });
    </script>
</body>
</html>
