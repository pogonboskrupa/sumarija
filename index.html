<!DOCTYPE html>
<html lang="bs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Šumarija - Preglednik</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #F6F7F9; min-height: 100vh; color: #1f2937; }
        .login-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; }
        .login-box { background: white; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); padding: 40px; max-width: 400px; width: 100%; }
        .login-box h1 { text-align: center; font-size: 64px; margin-bottom: 16px; }
        .login-box h2 { text-align: center; font-size: 32px; font-weight: bold; color: #1f2937; margin-bottom: 8px; }
        .login-box p { text-align: center; color: #6b7280; margin-bottom: 30px; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 4px; }
        .form-group input { width: 100%; padding: 12px 16px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 16px; }
        .btn { width: 100%; background: #059669; color: white; padding: 12px; border-radius: 8px; border: none; font-size: 16px; font-weight: 600; cursor: pointer; }
        .btn:hover { background: #047857; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .error { background: #fee2e2; border: 1px solid #fecaca; color: #991b1b; padding: 12px; border-radius: 8px; font-size: 14px; margin-bottom: 16px; }
        .header { background: white; color: #1f2937; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 16px 24px; border-bottom: 1px solid #e5e7eb; }
        .header-content { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px; }
        .header-left { display: flex; align-items: center; gap: 12px; }
        .header-logo { font-size: 28px; }
        .header-center { display: flex; align-items: center; justify-content: center; flex: 1; margin: 0 20px; }
        .company-logo { height: 60px; width: auto; object-fit: contain; transition: all 0.3s ease; }
        .company-logo:hover { transform: scale(1.05); }
        .header-title h1 { font-size: 18px; font-weight: 700; margin-bottom: 2px; color: #047857; }
        .header-title p { font-size: 12px; color: #6b7280; }
        .header-right { display: flex; align-items: center; gap: 16px; }
        .header-user { text-align: right; }
        .header-user-name { font-size: 13px; font-weight: 600; color: #1f2937; }
        .header-user-role { font-size: 11px; color: #6b7280; }
        .user-menu { position: relative; }
        .user-menu-button { background: #f3f4f6; color: #374151; padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .user-menu-button:hover { background: #e5e7eb; }
        .user-menu-dropdown { display: none; position: absolute; right: 0; top: 100%; margin-top: 8px; background: white; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); min-width: 200px; z-index: 1000; }
        .user-menu-dropdown.show { display: block; }
        .user-menu-item { padding: 12px 16px; cursor: pointer; font-size: 14px; color: #374151; border-bottom: 1px solid #f3f4f6; }
        .user-menu-item:hover { background: #f9fafb; }
        .user-menu-item:last-child { border-bottom: none; }
        .user-menu-item.danger { color: #dc2626; }
        .user-menu-item.danger:hover { background: #fee2e2; }
        .btn-logout { background: #dc2626; color: white; padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-size: 13px; font-weight: 600; }
        .btn-logout:hover { background: #b91c1c; }
        .container { max-width: 1200px; margin: 0 auto; padding: 32px 24px; }
        .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 28px; }
        .card { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 24px; border: 1px solid #f3f4f6; transition: all 0.2s; }
        .card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-color: #e5e7eb; }
        .card-label { font-size: 13px; color: #6b7280; margin-bottom: 8px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.05em; }
        .card-value { font-size: 32px; font-weight: 700; }
        .card-value.green { color: #059669; }
        .card-value.blue { color: #2563eb; }
        .card-value.red { color: #dc2626; }
        .section { background: white; border-radius: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 32px; margin-bottom: 24px; }
        .section h2 { font-size: 20px; font-weight: bold; margin-bottom: 8px; color: #1f2937; }
        .section p { font-size: 14px; color: #6b7280; margin-bottom: 24px; }

        /* Page Header */
        .page-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px; flex-wrap: wrap; gap: 16px; }
        .page-header-left h1 { font-size: 24px; font-weight: 700; color: #1f2937; margin-bottom: 4px; }
        .page-header-left p { font-size: 14px; color: #6b7280; }
        .page-header-right { display: flex; gap: 8px; align-items: center; }
        .badge { display: inline-block; padding: 6px 12px; background: #e0e7ff; color: #3730a3; border-radius: 12px; font-size: 12px; font-weight: 600; }
        .notification-badge { position: relative; display: inline-block; }
        .notification-badge .badge-count { position: absolute; top: -8px; right: -8px; background: #dc2626; color: white; border-radius: 10px; padding: 2px 6px; font-size: 11px; font-weight: 700; min-width: 18px; text-align: center; display: none; }
        .notification-badge .badge-count.show { display: block; }
        .badge.success { background: #d1fae5; color: #047857; }
        .badge.warning { background: #fef3c7; color: #92400e; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; }
        thead { background: #f9fafb; position: sticky; top: 0; z-index: 10; }
        thead::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 2px; background: #e5e7eb; }
        th { padding: 14px 12px; text-align: left; font-size: 11px; font-weight: 700; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; white-space: nowrap; }
        th.right { text-align: right; }
        td { padding: 14px 12px; font-size: 14px; border-bottom: 1px solid #f3f4f6; color: #374151; }
        td.right { text-align: right; font-variant-numeric: tabular-nums; font-weight: 500; }
        tbody tr:nth-child(even) { background: #f9fafb; }
        tbody tr:hover { background: #f0f9ff; }
        td.green { color: #059669; }
        td.blue { color: #2563eb; }
        td.red { color: #dc2626; }
        .loading { text-align: center; padding: 60px 20px; }
        .loading-icon { font-size: 48px; margin-bottom: 16px; }
        .loading-text { font-size: 18px; color: #374151; font-weight: 600; }
        .loading-sub { font-size: 14px; color: #6b7280; margin-top: 8px; }
        .hidden { display: none; }
        .chart-container { margin-top: 20px; }
        .bar { display: flex; gap: 8px; margin-bottom: 12px; align-items: center; }
        .bar-label { width: 100px; font-size: 13px; color: #374151; font-weight: 500; }
        .bar-group { flex: 1; display: flex; gap: 4px; }
        .bar-item { height: 30px; border-radius: 4px; display: flex; align-items: center; justify-content: flex-end; padding: 0 8px; color: white; font-size: 12px; font-weight: 600; }
        .bar-item.green { background: #059669; }
        .bar-item.blue { background: #2563eb; }
        .chart-svg { width: 100%; height: 300px; margin-top: 20px; }
        .monthly-table { margin-top: 20px; }
        .monthly-table tbody tr:hover { background: #f9fafb; }
        .progress-bar-container { background: #e5e7eb; height: 8px; border-radius: 4px; overflow: hidden; margin-top: 4px; }
        .progress-bar-fill { background: #059669; height: 100%; border-radius: 4px; transition: width 0.3s ease; }
        .odjel-detail { font-size: 12px; color: #6b7280; margin-top: 4px; }
        .line-legend { display: flex; gap: 20px; justify-content: center; margin-bottom: 16px; font-size: 14px; }
        .line-legend-item { display: flex; align-items: center; gap: 8px; }
        .line-legend-color { width: 30px; height: 3px; border-radius: 2px; }
        .line-legend-color.green { background: #059669; }
        .line-legend-color.blue { background: #2563eb; }

        /* Tabs navigation */
        .tabs-container { background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-bottom: 1px solid #e5e7eb; }
        .tabs { max-width: 1200px; margin: 0 auto; display: flex; gap: 4px; padding: 0 24px; overflow-x: auto; }
        .tab { background: transparent; border: none; padding: 14px 20px; font-size: 14px; font-weight: 600; color: #6b7280; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; white-space: nowrap; }
        .tab:hover { color: #374151; background: #f9fafb; }
        .tab.active { color: #047857; border-bottom-color: #047857; background: #f0fdf4; }

        /* Submenu styles */
        .submenu { display: flex; gap: 8px; margin-bottom: 24px; padding: 12px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb; }
        .submenu-tab { background: white; border: 1px solid #d1d5db; padding: 10px 18px; font-size: 13px; font-weight: 600; color: #6b7280; cursor: pointer; border-radius: 6px; transition: all 0.2s; white-space: nowrap; }
        .submenu-tab:hover { color: #047857; background: #f0fdf4; border-color: #059669; }
        .submenu-tab.active { color: white; background: #047857; border-color: #047857; box-shadow: 0 2px 4px rgba(5, 150, 105, 0.2); }
        .submenu-content { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* Sub-tabs for IZVJEŠTAJI */
        .sub-tabs { display: flex; gap: 12px; padding: 16px; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); flex-wrap: wrap; }
        .sub-tab { background: white; border: 2px solid #e5e7eb; padding: 12px 24px; font-size: 14px; font-weight: 600; color: #6b7280; cursor: pointer; border-radius: 8px; transition: all 0.2s; white-space: nowrap; }
        .sub-tab:hover { color: #047857; background: #f0fdf4; border-color: #10b981; }
        .sub-tab.active { color: white; background: #047857; border-color: #047857; box-shadow: 0 2px 8px rgba(5, 150, 105, 0.3); }
        .sub-content { animation: fadeIn 0.3s ease-in; }
        .sub-content.hidden { display: none; }

        /* Month selector */
        .month-selector { margin-bottom: 16px; padding: 12px; background: #f0fdf4; border-radius: 8px; border: 1px solid #bbf7d0; display: flex; align-items: center; gap: 12px; }
        .month-selector label { font-weight: 600; color: #047857; font-size: 14px; }
        .month-select { padding: 8px 12px; border: 1px solid #059669; border-radius: 6px; font-size: 14px; font-weight: 600; color: #047857; background: white; cursor: pointer; min-width: 150px; }
        .month-select:hover { background: #f0fdf4; }
        .month-select:focus { outline: none; border-color: #047857; box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1); }

        /* Summary cards */
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 28px; }
        .summary-card { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #f3f4f6; transition: all 0.2s; }
        .summary-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-color: #e5e7eb; }
        .summary-card-title { font-size: 12px; color: #6b7280; margin-bottom: 8px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
        .summary-card-value { font-size: 28px; font-weight: 700; color: #1f2937; font-variant-numeric: tabular-nums; }
        .summary-card-subtitle { font-size: 12px; color: #9ca3af; margin-top: 6px; }
        .summary-card.green .summary-card-value { color: #059669; }
        .summary-card.blue .summary-card-value { color: #2563eb; }
        .summary-card.red .summary-card-value { color: #dc2626; }

        /* Chart container */
        .chart-container { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 24px; height: 400px; }

        /* Search and controls */
        .controls-bar { display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; align-items: center; }
        .search-input { padding: 10px 16px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; flex: 1; min-width: 200px; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: #047857; color: white; }
        .btn-primary:hover { background: #059669; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-secondary:hover { background: #4b5563; }

        /* Filter Bar - Advanced */
        .filter-bar { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        .filter-bar-title { font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.05em; }
        .filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; }
        .filter-group { display: flex; flex-direction: column; gap: 6px; }
        .filter-label { font-size: 12px; font-weight: 600; color: #6b7280; }
        .filter-input, .filter-select { padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; background: white; color: #1f2937; }
        .filter-input:focus, .filter-select:focus { outline: none; border-color: #047857; box-shadow: 0 0 0 3px rgba(4, 120, 87, 0.1); }
        .filter-actions { display: flex; gap: 8px; align-items: flex-end; }
        .filter-actions .btn { padding: 10px 16px; font-size: 13px; }
        .btn-clear { background: #f3f4f6; color: #374151; }
        .btn-clear:hover { background: #e5e7eb; }

        /* Row Actions Dropdown */
        .row-actions { position: relative; }
        .row-actions-btn { background: transparent; border: none; cursor: pointer; padding: 8px; border-radius: 6px; color: #6b7280; font-size: 18px; line-height: 1; }
        .row-actions-btn:hover { background: #f3f4f6; color: #374151; }
        .row-actions-dropdown { display: none; position: absolute; right: 0; top: 100%; margin-top: 4px; background: white; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); min-width: 160px; z-index: 100; border: 1px solid #e5e7eb; }
        .row-actions-dropdown.show { display: block; }
        .row-actions-item { padding: 10px 14px; cursor: pointer; font-size: 13px; color: #374151; border-bottom: 1px solid #f3f4f6; display: flex; align-items: center; gap: 8px; }
        .row-actions-item:hover { background: #f9fafb; }
        .row-actions-item:last-child { border-bottom: none; }
        .row-actions-item.danger { color: #dc2626; }
        .row-actions-item.danger:hover { background: #fee2e2; }

        /* Confirm Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal-overlay.show { display: flex; }
        .modal { background: white; border-radius: 16px; padding: 24px; max-width: 400px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .modal-header { margin-bottom: 16px; }
        .modal-title { font-size: 18px; font-weight: 700; color: #1f2937; }
        .modal-body { margin-bottom: 24px; font-size: 14px; color: #6b7280; line-height: 1.6; }
        .modal-footer { display: flex; gap: 12px; justify-content: flex-end; }
        .modal-footer .btn { padding: 10px 20px; }
        .btn-danger { background: #dc2626; color: white; }
        .btn-danger:hover { background: #b91c1c; }

        /* Column Grouping */
        .col-group-cetinari { background: linear-gradient(to bottom, #f0fdf4 0%, #dcfce7 100%); border-left: 2px solid #10b981; border-right: 2px solid #10b981; }
        .col-group-liscari { background: linear-gradient(to bottom, #fef3c7 0%, #fde68a 100%); border-left: 2px solid #f59e0b; border-right: 2px solid #f59e0b; }
        body.dark-mode .col-group-cetinari { background: linear-gradient(to bottom, #064e3b 0%, #065f46 100%); }
        body.dark-mode .col-group-liscari { background: linear-gradient(to bottom, #78350f 0%, #92400e 100%); }

        /* Dark mode */
        body.dark-mode { background: #1f2937; color: #f3f4f6; }
        body.dark-mode .container, body.dark-mode .section, body.dark-mode table,
        body.dark-mode .summary-card, body.dark-mode .chart-container,
        body.dark-mode .tabs-container { background: #374151; color: #f3f4f6; border-color: #4b5563; }
        body.dark-mode table thead { background: #1f2937; }
        body.dark-mode .search-input { background: #4b5563; color: #f3f4f6; border-color: #6b7280; }

        /* Progress bar in table */
        .table-progress-bar { background: #e5e7eb; height: 4px; border-radius: 2px; overflow: hidden; margin-top: 4px; }
        .table-progress-fill { background: #059669; height: 100%; border-radius: 2px; }

        /* Kupci tables optimization */
        .kupci-table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; margin: 0 -24px; padding: 0 24px; }
        .kupci-table { font-size: 15px; white-space: nowrap; width: 100%; border-collapse: separate; border-spacing: 0; }
        .kupci-table th, .kupci-table td { padding: 12px 10px; border-bottom: 1px solid #e5e7eb; }
        .kupci-table th:first-child, .kupci-table td:first-child {
            position: sticky; left: 0; background: white; z-index: 2;
            min-width: 140px; max-width: 200px; white-space: normal;
            border-right: 2px solid #d1d5db; padding-right: 12px; font-weight: 600;
        }
        .kupci-table th:nth-child(2), .kupci-table td:nth-child(2) {
            position: sticky; left: 140px; background: white; z-index: 2;
            min-width: 90px; border-right: 2px solid #d1d5db; font-weight: 500;
        }
        body.dark-mode .kupci-table th:first-child, body.dark-mode .kupci-table td:first-child,
        body.dark-mode .kupci-table th:nth-child(2), body.dark-mode .kupci-table td:nth-child(2) { background: #374151; }
        .kupci-table thead th {
            background: linear-gradient(to bottom, #f9fafb 0%, #f3f4f6 100%);
            position: sticky !important; top: 0; z-index: 15 !important; font-weight: 700;
            border-top: 2px solid #10b981; border-bottom: 2px solid #10b981;
            padding: 12px 6px; text-transform: uppercase; font-size: 10px; letter-spacing: 0.5px;
        }
        /* Enhanced sticky for kupci godisnji and mjesecni tables */
        #kupci-godisnji-table thead th,
        #kupci-mjesecni-table thead th {
            position: sticky !important;
            top: 0;
            z-index: 15 !important;
        }
        #kupci-godisnji-table td:first-child,
        #kupci-mjesecni-table td:first-child {
            position: sticky !important;
            left: 0 !important;
            z-index: 10 !important;
        }
        #kupci-godisnji-table th:first-child,
        #kupci-mjesecni-table th:first-child {
            z-index: 20 !important;
        }
        body.dark-mode .kupci-table thead th { background: linear-gradient(to bottom, #1f2937 0%, #111827 100%); }
        .kupci-table tbody tr:nth-child(even) { background: #f9fafb; }
        body.dark-mode .kupci-table tbody tr:nth-child(even) { background: #2d3748; }
        .kupci-table tbody tr:hover { background: #f0fdf4; }
        body.dark-mode .kupci-table tbody tr:hover { background: #064e3b; }
        .kupci-table tbody tr:nth-child(even):hover { background: #ecfdf5; }
        body.dark-mode .kupci-table tbody tr:nth-child(even):hover { background: #065f46; }
        .kupci-table .sortiment-col {
            min-width: 85px;
            max-width: 110px;
            text-align: right;
            font-family: 'Courier New', monospace;
        }
        .kupci-table thead .sortiment-col {
            text-align: center;
            font-size: 11px;
            font-weight: 700;
            padding: 10px 5px;
            white-space: normal;
            word-wrap: break-word;
            line-height: 1.3;
        }
        .kupci-table .ukupno-col {
            font-weight: bold; background: linear-gradient(to right, #f0fdf4 0%, #dcfce7 100%);
            min-width: 95px; border-left: 3px solid #10b981; text-align: right;
            font-size: 12px; font-family: 'Courier New', monospace;
        }
        body.dark-mode .kupci-table .ukupno-col { background: linear-gradient(to right, #064e3b 0%, #065f46 100%); }
        .kupci-table .totals-row {
            background: linear-gradient(to bottom, #dcfce7 0%, #bbf7d0 100%);
            font-weight: 700; font-size: 12px; border-top: 3px solid #10b981;
        }
        body.dark-mode .kupci-table .totals-row { background: linear-gradient(to bottom, #065f46 0%, #047857 100%); }
        .kupci-table .totals-row td { border-bottom: 3px solid #10b981; padding: 12px 6px; }

        /* ============================================
           EXPERT TABLE STYLES - Premium Design
           ============================================ */
        .expert-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 16px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        .expert-table thead th {
            background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%);
            color: white;
            padding: 18px 16px;
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 3px solid #06b6d4;
            position: sticky;
            top: 0;
            z-index: 10;
            text-align: left;
        }
        .expert-table thead th:first-child {
            border-top-left-radius: 8px;
            position: sticky;
            left: 0;
            z-index: 20;
            background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%);
        }
        .expert-table thead th:last-child {
            border-top-right-radius: 8px;
            background: linear-gradient(135deg, #047857 0%, #065f46 100%);
            border-bottom-color: #10b981;
        }
        .expert-table tbody tr {
            transition: all 0.2s ease;
        }
        .expert-table tbody tr:nth-child(odd) {
            background: #f0f9ff;
        }
        .expert-table tbody tr:nth-child(even) {
            background: white;
        }
        .expert-table tbody tr:hover {
            background: #e0f2fe;
            transform: scale(1.005);
            box-shadow: 0 2px 8px rgba(8, 145, 178, 0.15);
        }
        .expert-table tbody td {
            padding: 14px 16px;
            border-bottom: 1px solid #e0e7ff;
            font-size: 15px;
        }
        .expert-table tbody td:first-child {
            font-weight: 600;
            color: #0c4a6e;
            position: sticky;
            left: 0;
            background: inherit;
            z-index: 5;
        }
        .expert-table tbody tr:nth-child(odd) td:first-child {
            background: #f0f9ff;
        }
        .expert-table tbody tr:nth-child(even) td:first-child {
            background: white;
        }
        .expert-table tbody tr:hover td:first-child {
            background: #e0f2fe;
        }
        .expert-table tbody td:last-child {
            font-weight: 700;
            color: #047857;
            background: #f0fdf4;
            text-align: right;
        }
        .expert-table tbody td.sortiment-value {
            text-align: right;
            font-family: 'Courier New', monospace;
            color: #0e7490;
        }
        .expert-table tfoot tr {
            background: linear-gradient(135deg, #047857 0%, #065f46 100%);
            font-weight: 700;
            font-size: 16px;
        }
        .expert-table tfoot td {
            padding: 18px 16px;
            color: white;
            border-top: 3px solid #10b981;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .expert-table tfoot td:first-child {
            font-size: 15px;
            position: sticky;
            left: 0;
            background: linear-gradient(135deg, #047857 0%, #065f46 100%);
            z-index: 15;
        }
        .expert-table tfoot td:last-child {
            text-align: right;
            font-size: 18px;
            background: linear-gradient(135deg, #065f46 0%, #064e3b 100%);
        }

        /* ============================================
           MONTHLY SORTIMENTI TABLE STYLES
           ============================================ */
        .mjesecni-table-wrapper table {
            font-size: 11px !important;
            border-collapse: collapse;
            width: 100%;
        }
        .mjesecni-table-wrapper th {
            background: #1e40af !important;
            color: white !important;
            padding: 12px 8px !important;
            font-size: 12px !important;
            font-weight: 700;
            text-align: center;
            border: 1px solid #1e3a8a;
            position: sticky !important;
            top: 0;
            z-index: 10;
            white-space: normal !important;
            word-wrap: break-word;
            overflow-wrap: break-word;
            line-height: 1.3;
            min-width: 85px;
            max-width: 110px;
            height: auto !important;
            overflow: visible !important;
            vertical-align: middle;
        }
        .mjesecni-table-wrapper td {
            padding: 8px 10px !important;
            font-size: 12px !important;
            text-align: right;
            border: 1px solid #e5e7eb;
            white-space: nowrap;
            min-width: 85px;
            max-width: 110px;
        }
        .mjesecni-table-wrapper tbody tr:hover {
            background: #dbeafe !important;
        }
        /* Bold columns styling - only for body cells */
        .mjesecni-table-wrapper tbody .col-cetinari {
            background: #d1fae5;
            font-weight: 700;
        }
        .mjesecni-table-wrapper tbody .col-liscari {
            background: #fed7aa;
            font-weight: 700;
        }
        .mjesecni-table-wrapper tbody .col-sveukupno {
            background: #fecaca;
            font-weight: 700;
        }
        /* Group separators - thicker for better visibility */
        .mjesecni-table-wrapper .group-cetvrti th,
        .mjesecni-table-wrapper .group-cetvrti td {
            border-left: 3px solid #2563eb !important;
        }
        .mjesecni-table-wrapper .group-ogrevno th,
        .mjesecni-table-wrapper .group-ogrevno td {
            border-left: 3px solid #059669 !important;
        }
        /* Mobile optimization */
        @media (max-width: 768px) {
            .mjesecni-table-wrapper th,
            .mjesecni-table-wrapper td {
                font-size: 9px !important;
                padding: 4px 2px !important;
            }
            .mjesecni-table-wrapper th {
                max-width: 55px;
            }
        }

        /* ============================================
           PRIMACI & OTPREMACI TABLE STYLES
           ============================================ */
        #primaci-table, #otpremaci-table {
            border-collapse: collapse;
            width: 100%;
        }
        #primaci-table thead th, #otpremaci-table thead th {
            position: sticky !important;
            top: 0;
            z-index: 15 !important;
        }
        #primaci-table tbody tr, #otpremaci-table tbody tr {
            border-bottom: 1px solid #e5e7eb;
        }
        /* Ensure sticky columns work properly */
        #primaci-table td:first-child, #otpremaci-table td:first-child {
            position: sticky !important;
            left: 0 !important;
        }
        #primaci-table th:first-child, #otpremaci-table th:first-child {
            position: sticky !important;
            left: 0 !important;
        }
        /* Add box shadow for sticky elements */
        #primaci-table td:first-child::after, #otpremaci-table td:first-child::after {
            content: '';
            position: absolute;
            right: -1px;
            top: 0;
            bottom: 0;
            width: 1px;
            box-shadow: 2px 0 4px rgba(0,0,0,0.1);
        }

        /* ============================================
           MOBILE OPTIMIZATIONS (< 768px)
           ============================================ */
        @media (max-width: 768px) {
            /* Container & spacing */
            .container { padding: 12px; max-width: 100%; }
            .section { padding: 16px; margin-bottom: 16px; }
            .section h2 { font-size: 18px; margin-bottom: 12px; }

            /* Header */
            .header { flex-direction: column; gap: 12px; padding: 16px 12px; }
            .header-logo h1 { font-size: 20px; }
            .header-logo p { font-size: 13px; }
            .header-user { font-size: 12px; }
            .btn-logout { padding: 8px 16px; font-size: 13px; }

            /* Tabs - scrollable horizontal */
            .tabs { overflow-x: auto; -webkit-overflow-scrolling: touch; gap: 2px; padding: 0 12px; white-space: nowrap; }
            .tab { padding: 12px 16px; font-size: 13px; flex-shrink: 0; }

            /* Summary cards - stack vertically */
            .summary-cards { grid-template-columns: 1fr; gap: 12px; }
            .summary-card { padding: 16px; }
            .summary-card-title { font-size: 12px; }
            .summary-card-value { font-size: 24px; }

            /* Chart */
            .chart-container { height: 280px; padding: 16px; }

            /* Controls bar - stack vertically */
            .controls-bar { flex-direction: column; gap: 8px; }
            .search-input { width: 100%; min-width: auto; }
            .btn { width: 100%; padding: 12px; }

            /* Tables */
            table { font-size: 11px; }
            table th, table td { padding: 6px 4px; }
            .monthly-table th, .monthly-table td { font-size: 10px; padding: 6px 3px; }

            /* Kupci tables - optimized for mobile */
            .kupci-table-wrapper { margin: 0 -12px; padding: 0 12px; }
            .kupci-table { font-size: 10px; }
            .kupci-table th, .kupci-table td { padding: 6px 3px; }
            .kupci-table th:first-child, .kupci-table td:first-child {
                min-width: 100px; max-width: 140px; font-size: 10px;
            }
            .kupci-table th:nth-child(2), .kupci-table td:nth-child(2) {
                left: 100px; min-width: 70px; font-size: 10px;
            }
            .kupci-table thead th { font-size: 9px; padding: 8px 3px; }
            .kupci-table .sortiment-col { min-width: 50px; max-width: 60px; font-size: 10px; }
            .kupci-table .ukupno-col { min-width: 75px; font-size: 10px; }
            .kupci-table .totals-row { font-size: 10px; }

            /* Login */
            .login-box { padding: 30px 24px; }
            .login-box h1 { font-size: 48px; }
            .login-box h2 { font-size: 24px; }

            /* Loading */
            .loading-icon { font-size: 48px; }
            .loading-text { font-size: 16px; }

            /* Hide dark mode button text on mobile */
            .btn[onclick="toggleDarkMode()"] { font-size: 20px; padding: 8px 12px; }
        }

        /* Extra small devices (< 480px) */
        @media (max-width: 480px) {
            .section h2 { font-size: 16px; }
            .header-logo h1 { font-size: 18px; }
            .tab { padding: 10px 12px; font-size: 12px; }
            .summary-card-value { font-size: 20px; }
            .chart-container { height: 240px; padding: 12px; }

            .kupci-table { font-size: 9px; }
            .kupci-table th:first-child, .kupci-table td:first-child {
                min-width: 90px; max-width: 120px; font-size: 9px;
            }
            .kupci-table th:nth-child(2), .kupci-table td:nth-child(2) {
                left: 90px; min-width: 60px; font-size: 9px;
            }
            .kupci-table .sortiment-col { min-width: 45px; font-size: 9px; }
            .kupci-table .ukupno-col { min-width: 70px; font-size: 9px; }
        }

        /* Cache indicator */
        .cache-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 4px 8px;
            font-size: 10px;
            font-weight: 500;
            border-radius: 4px;
            z-index: 9999;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-width: 200px;
            transition: all 0.3s ease;
        }
        .btn-clear-cache {
            background: #f59e0b;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }
        .btn-clear-cache:hover {
            background: #d97706;
        }
        /* ============================================ */
        /* MOBILE RESPONSIVE DESIGN */
        /* ============================================ */

        @media (max-width: 768px) {
            /* Container and layout */
            .container { max-width: 100%; padding: 12px; }
            .section { padding: 16px; margin-bottom: 16px; border-radius: 12px; }

            /* Header */
            .header { padding: 12px 16px; flex-direction: column; }
            .header-content { flex-direction: column; gap: 12px; width: 100%; }
            .header-left { width: 100%; }
            .header-center { margin: 10px 0; }
            .company-logo { height: 50px; }
            .header-right { width: 100%; justify-content: space-between; }
            .header-logo { font-size: 24px; }
            .header-title h1 { font-size: 16px; }
            .header-title p { font-size: 11px; }
            .header-user-name { font-size: 13px; }
            .header-user-role { font-size: 11px; }

            /* Tabs */
            .tabs-container { overflow-x: auto; -webkit-overflow-scrolling: touch; padding: 8px 12px; }
            .tab { font-size: 12px; padding: 8px 12px; white-space: nowrap; }

            /* Summary cards */
            .summary-cards { grid-template-columns: 1fr; gap: 12px; }
            .summary-card { padding: 16px; }
            .summary-card-title { font-size: 11px; }
            .summary-card-value { font-size: 24px; }
            .summary-card-subtitle { font-size: 11px; }

            /* Cards */
            .cards { grid-template-columns: 1fr; gap: 12px; }
            .card { padding: 16px; }
            .card-label { font-size: 11px; }
            .card-value { font-size: 24px; }

            /* Tables */
            table { font-size: 11px; }
            th, td { padding: 8px 6px; }
            th { font-size: 10px; }

            /* Table wrappers - enable horizontal scroll */
            .kupci-table-wrapper {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                margin: 0 -16px;
                padding: 0 16px;
            }

            /* Month table - make scrollable */
            .mjesecni-table-wrapper {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                margin: 0 -16px;
                padding: 0 16px;
            }

            /* Make sortiment columns narrower on mobile */
            .sortiment-col {
                min-width: 50px !important;
                font-size: 10px;
            }

            /* Page header */
            .page-header { flex-direction: column; gap: 12px; }
            .page-header-left h1 { font-size: 18px; }
            .page-header-left p { font-size: 12px; }

            /* Buttons */
            .btn { padding: 10px 16px; font-size: 13px; }

            /* Forms */
            .form-group label { font-size: 12px; }
            .form-group input, .form-group select, .form-group textarea {
                font-size: 14px;
                padding: 8px;
            }

            /* Filter bar */
            .filter-bar { padding: 12px; }
            .filter-grid { grid-template-columns: 1fr; gap: 8px; }
            .filter-label { font-size: 11px; }
            .filter-input, .filter-select { font-size: 13px; padding: 8px; }

            /* Modal */
            .modal { width: 95%; padding: 16px; }
            .modal-title { font-size: 16px; }
            .modal-body { font-size: 13px; }

            /* User menu */
            .user-menu-button { padding: 6px 12px; font-size: 12px; }
            .user-menu-dropdown { min-width: 180px; }

            /* Hide or adjust specific elements on mobile */
            .badge { padding: 4px 8px; font-size: 10px; }

            /* Export button */
            .export-btn { width: 100%; margin-bottom: 12px; }

            /* Search input */
            .search-container { margin-bottom: 12px; }
            .search-input { font-size: 14px; }
        }

        /* Extra small devices (phones in portrait, less than 576px) */
        @media (max-width: 576px) {
            .container { padding: 8px; }
            .section { padding: 12px; }
            .header { padding: 8px 12px; }
            .header-title h1 { font-size: 14px; }

            /* Make tables more readable on mobile */
            table {
                font-size: 13px;
                min-width: max-content;
            }
            th, td {
                padding: 10px 8px;
                white-space: nowrap;
            }
            th {
                font-size: 11px;
                font-weight: 700;
            }
            td {
                color: #111827;
                font-weight: 600;
            }

            /* Scroll wrapper for wide tables */
            .section > div:has(table) {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                margin: 0 -8px;
            }

            /* Sticky first column for all tables */
            table th:first-child,
            table td:first-child {
                position: sticky;
                left: 0;
                z-index: 5;
                background: white;
                box-shadow: 2px 0 4px rgba(0, 0, 0, 0.1);
            }

            table thead th:first-child {
                z-index: 15;
                background: linear-gradient(to bottom, #047857 0%, #059669 100%);
            }

            /* Summary cards */
            .summary-card-value { font-size: 20px; }

            /* Buttons */
            .btn { padding: 8px 12px; font-size: 12px; }
        }

        /* ============================================ */
        /* TOAST NOTIFICATIONS */
        /* ============================================ */

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        .toast {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 16px 20px;
            min-width: 300px;
            max-width: 400px;
            display: flex;
            align-items: center;
            gap: 12px;
            pointer-events: auto;
            opacity: 0;
            transform: translateX(400px);
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast.hide {
            opacity: 0;
            transform: translateX(400px);
        }

        .toast-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .toast-message {
            font-size: 13px;
            color: #6b7280;
            line-height: 1.4;
        }

        .toast-close {
            background: none;
            border: none;
            font-size: 20px;
            color: #9ca3af;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .toast-close:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .toast.success {
            border-left: 4px solid #10b981;
        }

        .toast.success .toast-icon {
            color: #10b981;
        }

        .toast.error {
            border-left: 4px solid #ef4444;
        }

        .toast.error .toast-icon {
            color: #ef4444;
        }

        .toast.info {
            border-left: 4px solid #3b82f6;
        }

        .toast.info .toast-icon {
            color: #3b82f6;
        }

        .toast.warning {
            border-left: 4px solid #f59e0b;
        }

        .toast.warning .toast-icon {
            color: #f59e0b;
        }

        /* Mobile adjustments for toasts */
        @media (max-width: 576px) {
            .toast-container {
                top: 10px;
                right: 10px;
                left: 10px;
            }

            .toast {
                min-width: auto;
                max-width: none;
                padding: 12px 16px;
            }

            .toast-title {
                font-size: 13px;
            }

            .toast-message {
                font-size: 12px;
            }
        }

        /* ========================================
           PROFESIONALNI UI ZA PRIMAČE I OTPREMAČE
           ======================================== */

        /* Gradient Headers for Worker Views */
        .worker-header {
            background: linear-gradient(135deg, #047857 0%, #059669 50%, #10b981 100%);
            padding: 20px 24px;
            border-radius: 12px 12px 0 0;
            margin: -24px -24px 20px -24px;
            box-shadow: 0 4px 12px rgba(4, 120, 87, 0.15);
        }

        .worker-header.primac {
            background: linear-gradient(135deg, #047857 0%, #059669 50%, #10b981 100%);
        }

        .worker-header.otpremac {
            background: linear-gradient(135deg, #1e40af 0%, #2563eb 50%, #3b82f6 100%);
        }

        .worker-header-title {
            color: white;
            font-size: 22px;
            font-weight: 800;
            margin: 0 0 6px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .worker-header-subtitle {
            color: #ffffff;
            font-size: 15px;
            margin: 0;
            font-weight: 700;
            text-shadow:
                /* Crni outline za jasnoću */
                -1px -1px 0 rgba(0, 0, 0, 0.9),
                1px -1px 0 rgba(0, 0, 0, 0.9),
                -1px 1px 0 rgba(0, 0, 0, 0.9),
                1px 1px 0 rgba(0, 0, 0, 0.9),
                /* Dodatni crni shadow za dubinu */
                0 2px 8px rgba(0, 0, 0, 0.7),
                0 1px 4px rgba(0, 0, 0, 0.8);
        }

        .worker-header-icon {
            font-size: 28px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
        }

        /* Modern Card-Based Tables */
        .worker-table-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            margin-bottom: 24px;
            border: 1px solid #e5e7eb;
            transition: all 0.3s ease;
        }

        .worker-table-card:hover {
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
        }

        .worker-table-card-header {
            background: linear-gradient(to right, #f9fafb 0%, #f3f4f6 100%);
            padding: 16px 24px;
            border-bottom: 2px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .worker-table-card-title {
            font-size: 16px;
            font-weight: 700;
            color: #1f2937;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .worker-table-card-badge {
            background: #047857;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
        }

        .worker-table-card-badge.blue {
            background: #2563eb;
        }

        /* Enhanced Table Styling for Workers */
        .worker-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 13px;
        }

        .worker-table thead {
            background: linear-gradient(to bottom, #047857 0%, #059669 100%);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .worker-table.otpremac thead {
            background: linear-gradient(to bottom, #1e40af 0%, #2563eb 100%);
        }

        .worker-table th {
            padding: 14px 12px;
            text-align: left;
            font-weight: 700;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 3px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
            color: #ffffff;
            text-shadow:
                /* Crni outline za jasnoću */
                -1px -1px 0 rgba(0, 0, 0, 0.9),
                1px -1px 0 rgba(0, 0, 0, 0.9),
                -1px 1px 0 rgba(0, 0, 0, 0.9),
                1px 1px 0 rgba(0, 0, 0, 0.9),
                /* Dodatni crni shadow za dubinu */
                0 2px 8px rgba(0, 0, 0, 0.7),
                0 1px 4px rgba(0, 0, 0, 0.8);
        }

        .worker-table th:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .worker-table td {
            padding: 12px;
            border-bottom: 1px solid #f3f4f6;
            color: #111827;
            font-weight: 600;
            font-size: 14px;
        }

        .worker-table tbody tr {
            transition: all 0.2s ease;
        }

        .worker-table tbody tr:hover {
            background: linear-gradient(to right, #f0fdf4 0%, #d1fae5 100%);
            box-shadow: inset 4px 0 0 #047857;
        }

        .worker-table.otpremac tbody tr:hover {
            background: linear-gradient(to right, #eff6ff 0%, #dbeafe 100%);
            box-shadow: inset 4px 0 0 #2563eb;
        }

        .worker-table .totals-row {
            background: linear-gradient(to right, #f0fdf4 0%, #dcfce7 100%);
            border-top: 3px solid #047857;
            font-weight: 700;
            font-size: 14px;
        }

        .worker-table.otpremac .totals-row {
            background: linear-gradient(to right, #eff6ff 0%, #dbeafe 100%);
            border-top: 3px solid #2563eb;
        }

        .worker-table .totals-row td {
            padding: 16px 12px;
            color: #047857;
        }

        .worker-table.otpremac .totals-row td {
            color: #1e40af;
        }

        /* Value Highlighting */
        .value-highlight {
            background: #fef3c7;
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: 700;
            color: #92400e;
        }

        .value-highlight.large {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: white;
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);
        }

        /* Mjesečne boje za tabele - 12 različitih svijetlih nijansi */
        .worker-table tbody tr.mjesec-1 { background: linear-gradient(to right, #fce7f3 0%, #fbcfe8 100%); } /* Januar - Розова */
        .worker-table tbody tr.mjesec-2 { background: linear-gradient(to right, #f3e8ff 0%, #e9d5ff 100%); } /* Februar - Ljubičasta */
        .worker-table tbody tr.mjesec-3 { background: linear-gradient(to right, #e0e7ff 0%, #c7d2fe 100%); } /* Mart - Indigo */
        .worker-table tbody tr.mjesec-4 { background: linear-gradient(to right, #dbeafe 0%, #bfdbfe 100%); } /* April - Plava */
        .worker-table tbody tr.mjesec-5 { background: linear-gradient(to right, #cffafe 0%, #a5f3fc 100%); } /* Maj - Cyan */
        .worker-table tbody tr.mjesec-6 { background: linear-gradient(to right, #ccfbf1 0%, #99f6e4 100%); } /* Juni - Teal */
        .worker-table tbody tr.mjesec-7 { background: linear-gradient(to right, #d1fae5 0%, #a7f3d0 100%); } /* Juli - Zelena */
        .worker-table tbody tr.mjesec-8 { background: linear-gradient(to right, #d9f99d 0%, #bef264 100%); } /* August - Lime */
        .worker-table tbody tr.mjesec-9 { background: linear-gradient(to right, #fef9c3 0%, #fef08a 100%); } /* Septembar - Žuta */
        .worker-table tbody tr.mjesec-10 { background: linear-gradient(to right, #fed7aa 0%, #fdba74 100%); } /* Oktobar - Narandžasta */
        .worker-table tbody tr.mjesec-11 { background: linear-gradient(to right, #fecaca 0%, #fca5a5 100%); } /* Novembar - Crvena */
        .worker-table tbody tr.mjesec-12 { background: linear-gradient(to right, #e5e7eb 0%, #d1d5db 100%); } /* Decembar - Siva */

        /* Hover efekat za mjesečne boje */
        .worker-table tbody tr.mjesec-1:hover { background: linear-gradient(to right, #fbcfe8 0%, #f9a8d4 100%); box-shadow: inset 4px 0 0 #ec4899; }
        .worker-table tbody tr.mjesec-2:hover { background: linear-gradient(to right, #e9d5ff 0%, #d8b4fe 100%); box-shadow: inset 4px 0 0 #a855f7; }
        .worker-table tbody tr.mjesec-3:hover { background: linear-gradient(to right, #c7d2fe 0%, #a5b4fc 100%); box-shadow: inset 4px 0 0 #6366f1; }
        .worker-table tbody tr.mjesec-4:hover { background: linear-gradient(to right, #bfdbfe 0%, #93c5fd 100%); box-shadow: inset 4px 0 0 #3b82f6; }
        .worker-table tbody tr.mjesec-5:hover { background: linear-gradient(to right, #a5f3fc 0%, #67e8f9 100%); box-shadow: inset 4px 0 0 #06b6d4; }
        .worker-table tbody tr.mjesec-6:hover { background: linear-gradient(to right, #99f6e4 0%, #5eead4 100%); box-shadow: inset 4px 0 0 #14b8a6; }
        .worker-table tbody tr.mjesec-7:hover { background: linear-gradient(to right, #a7f3d0 0%, #6ee7b7 100%); box-shadow: inset 4px 0 0 #10b981; }
        .worker-table tbody tr.mjesec-8:hover { background: linear-gradient(to right, #bef264 0%, #a3e635 100%); box-shadow: inset 4px 0 0 #84cc16; }
        .worker-table tbody tr.mjesec-9:hover { background: linear-gradient(to right, #fef08a 0%, #fde047 100%); box-shadow: inset 4px 0 0 #eab308; }
        .worker-table tbody tr.mjesec-10:hover { background: linear-gradient(to right, #fdba74 0%, #fb923c 100%); box-shadow: inset 4px 0 0 #f97316; }
        .worker-table tbody tr.mjesec-11:hover { background: linear-gradient(to right, #fca5a5 0%, #f87171 100%); box-shadow: inset 4px 0 0 #ef4444; }
        .worker-table tbody tr.mjesec-12:hover { background: linear-gradient(to right, #d1d5db 0%, #9ca3af 100%); box-shadow: inset 4px 0 0 #6b7280; }

        /* Otpremači tabele također koriste mjesečne boje */
        .worker-table.otpremac tbody tr.mjesec-1:hover { box-shadow: inset 4px 0 0 #ec4899; }
        .worker-table.otpremac tbody tr.mjesec-2:hover { box-shadow: inset 4px 0 0 #a855f7; }
        .worker-table.otpremac tbody tr.mjesec-3:hover { box-shadow: inset 4px 0 0 #6366f1; }
        .worker-table.otpremac tbody tr.mjesec-4:hover { box-shadow: inset 4px 0 0 #3b82f6; }
        .worker-table.otpremac tbody tr.mjesec-5:hover { box-shadow: inset 4px 0 0 #06b6d4; }
        .worker-table.otpremac tbody tr.mjesec-6:hover { box-shadow: inset 4px 0 0 #14b8a6; }
        .worker-table.otpremac tbody tr.mjesec-7:hover { box-shadow: inset 4px 0 0 #10b981; }
        .worker-table.otpremac tbody tr.mjesec-8:hover { box-shadow: inset 4px 0 0 #84cc16; }
        .worker-table.otpremac tbody tr.mjesec-9:hover { box-shadow: inset 4px 0 0 #eab308; }
        .worker-table.otpremac tbody tr.mjesec-10:hover { box-shadow: inset 4px 0 0 #f97316; }
        .worker-table.otpremac tbody tr.mjesec-11:hover { box-shadow: inset 4px 0 0 #ef4444; }
        .worker-table.otpremac tbody tr.mjesec-12:hover { box-shadow: inset 4px 0 0 #6b7280; }

        /* Modern Form Styling */
        .worker-form {
            background: white;
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            border: 1px solid #e5e7eb;
        }

        .worker-form-header {
            margin-bottom: 28px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
        }

        .worker-form-title {
            font-size: 24px;
            font-weight: 800;
            color: #1f2937;
            margin: 0 0 8px 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .worker-form-subtitle {
            font-size: 14px;
            color: #6b7280;
            margin: 0;
        }

        .worker-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .worker-form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .worker-form-label {
            font-size: 13px;
            font-weight: 700;
            color: #374151;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .worker-form-input,
        .worker-form-select {
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 15px;
            color: #1f2937;
            transition: all 0.2s;
            background: white;
        }

        .worker-form-input:focus,
        .worker-form-select:focus {
            outline: none;
            border-color: #047857;
            box-shadow: 0 0 0 4px rgba(4, 120, 87, 0.1);
        }

        .worker-form.otpremac .worker-form-input:focus,
        .worker-form.otpremac .worker-form-select:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        }

        .worker-form-section-title {
            font-size: 18px;
            font-weight: 700;
            color: #047857;
            margin: 28px 0 16px 0;
            padding-bottom: 12px;
            border-bottom: 2px solid #d1fae5;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .worker-form.otpremac .worker-form-section-title {
            color: #2563eb;
            border-bottom-color: #dbeafe;
        }

        .worker-form-total-box {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 3px solid #f59e0b;
            border-radius: 12px;
            padding: 24px;
            margin-top: 28px;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2);
        }

        .worker-form-total-label {
            font-size: 16px;
            font-weight: 800;
            color: #92400e;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .worker-form-total-value {
            font-size: 36px;
            font-weight: 900;
            color: #92400e;
            text-align: center;
            font-family: 'Courier New', monospace;
            text-shadow: 0 2px 4px rgba(146, 64, 14, 0.1);
        }

        .worker-form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 32px;
            padding-top: 24px;
            border-top: 2px solid #e5e7eb;
        }

        .worker-form-btn {
            padding: 14px 32px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .worker-form-btn-primary {
            background: linear-gradient(135deg, #047857 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(4, 120, 87, 0.3);
        }

        .worker-form-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(4, 120, 87, 0.4);
        }

        .worker-form-btn-primary.otpremac {
            background: linear-gradient(135deg, #1e40af 0%, #2563eb 100%);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .worker-form-btn-primary.otpremac:hover {
            box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
        }

        .worker-form-btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: 2px solid #e5e7eb;
        }

        .worker-form-btn-secondary:hover {
            background: #e5e7eb;
            transform: translateY(-2px);
        }

        /* Action Buttons in Tables */
        .worker-action-btn {
            padding: 6px 14px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 6px;
        }

        .worker-action-btn-edit {
            background: #dbeafe;
            color: #1e40af;
        }

        .worker-action-btn-edit:hover {
            background: #3b82f6;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
        }

        .worker-action-btn-delete {
            background: #fee2e2;
            color: #dc2626;
        }

        .worker-action-btn-delete:hover {
            background: #dc2626;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3);
        }

        /* Stats Cards for Workers */
        .worker-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 28px;
        }

        .worker-stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            border: 1px solid #e5e7eb;
            transition: all 0.3s ease;
        }

        .worker-stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        }

        .worker-stat-card.green {
            border-top: 4px solid #047857;
        }

        .worker-stat-card.blue {
            border-top: 4px solid #2563eb;
        }

        .worker-stat-card.yellow {
            border-top: 4px solid #f59e0b;
        }

        .worker-stat-card-label {
            font-size: 12px;
            color: #6b7280;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .worker-stat-card-value {
            font-size: 32px;
            font-weight: 800;
            color: #1f2937;
            font-family: 'Courier New', monospace;
        }

        .worker-stat-card.green .worker-stat-card-value {
            color: #047857;
        }

        .worker-stat-card.blue .worker-stat-card-value {
            color: #2563eb;
        }

        .worker-stat-card.yellow .worker-stat-card-value {
            color: #f59e0b;
        }

        .worker-stat-card-unit {
            font-size: 14px;
            color: #9ca3af;
            font-weight: 600;
            margin-left: 4px;
        }

        /* Worker Chart Container */
        .worker-chart-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
            border: 1px solid #e5e7eb;
        }

        .worker-chart-card.primac {
            border-top: 3px solid #047857;
        }

        .worker-chart-card.otpremac {
            border-top: 3px solid #2563eb;
        }

        .worker-chart-title {
            font-size: 16px;
            font-weight: 700;
            color: #1f2937;
            margin: 0 0 16px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .worker-chart-canvas {
            max-height: 300px;
        }

        /* Responsive Design for Workers */
        @media (max-width: 768px) {
            .worker-header {
                padding: 24px 16px;
                margin: -16px -16px 16px -16px;
            }

            .worker-header-title {
                font-size: 22px;
            }

            .worker-header-subtitle {
                font-size: 13px;
            }

            .worker-form {
                padding: 20px;
            }

            .worker-form-grid {
                grid-template-columns: 1fr;
            }

            .worker-stats-grid {
                grid-template-columns: 1fr;
            }

            /* MOBILNI PREGLED TABELA - Poboljšan */
            .worker-table-card {
                margin-left: -16px;
                margin-right: -16px;
                border-radius: 0;
            }

            .worker-table {
                font-size: 13px;
                min-width: max-content;
            }

            .worker-table th {
                padding: 12px 10px;
                font-size: 11px;
                white-space: nowrap;
            }

            .worker-table td {
                padding: 12px 10px;
                white-space: nowrap;
                color: #111827;
                font-weight: 600;
            }

            /* Sticky prva kolona na mobilnom */
            .worker-table th:first-child,
            .worker-table td:first-child {
                position: sticky;
                left: 0;
                z-index: 5;
                background: inherit;
                box-shadow: 2px 0 4px rgba(0, 0, 0, 0.1);
            }

            .worker-table thead th:first-child {
                z-index: 15;
            }

            /* Pojačan kontrast brojeva na mobilnom */
            .worker-table .sortiment-col,
            .worker-table .ukupno-col {
                font-weight: 700;
                color: #000000;
                font-size: 14px;
            }

            /* Wrapper sa scroll indikatorom */
            .worker-table-card > div {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                position: relative;
            }

            .worker-table-card > div::after {
                content: '← Scroll →';
                position: sticky;
                right: 0;
                bottom: 0;
                background: linear-gradient(90deg, transparent 0%, #047857 20%, #047857 80%, transparent 100%);
                color: white;
                padding: 8px 16px;
                font-size: 11px;
                font-weight: 700;
                text-align: center;
                display: block;
                opacity: 0.8;
                pointer-events: none;
                border-radius: 4px;
                margin: 8px;
            }

            .worker-table.otpremac + div::after {
                background: linear-gradient(90deg, transparent 0%, #2563eb 20%, #2563eb 80%, transparent 100%);
            }

            /* Veći touch targets za sortiranje */
            .worker-table th {
                min-width: 80px;
            }

            /* Totals row čitljiviji */
            .worker-table .totals-row td {
                font-size: 15px;
                font-weight: 800;
                color: #000000;
            }

            /* Chart responsive */
            .worker-chart-card {
                padding: 16px;
            }

            .worker-chart-title {
                font-size: 14px;
            }

            .worker-chart-canvas {
                max-height: 250px;
            }
        }

        /* ============================================
           OPERATIVA & ANALYTICS STYLES
           ============================================ */

        /* Analytics Grid - 2 column responsive layout */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }

        /* Ranking Items for Top 5 Odjela */
        .ranking-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        .ranking-item:last-child { border-bottom: none; }

        .ranking-number {
            font-size: 24px;
            font-weight: 700;
            color: #d1d5db;
            min-width: 40px;
        }
        .ranking-number.top { color: #fbbf24; } /* Gold for top 3 */

        .ranking-info { flex: 1; }
        .ranking-name {
            font-weight: 600;
            color: #1f2937;
            font-size: 15px;
        }
        .ranking-value {
            font-size: 20px;
            font-weight: 700;
            color: #059669;
        }

        /* KPI Cards Grid - 4 columns responsive */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        /* KPI Card Small - Gradient backgrounds */
        .kpi-card-small {
            background: linear-gradient(135deg, #f0fdf4 0%, #d1fae5 100%);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #059669;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.2s;
        }
        .kpi-card-small:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transform: translateY(-2px);
        }
        .kpi-card-small.blue {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border-left-color: #2563eb;
        }
        .kpi-card-small.yellow {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            border-left-color: #f59e0b;
        }
        .kpi-card-small.purple {
            background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
            border-left-color: #9333ea;
        }

        .kpi-label-small {
            font-size: 12px;
            color: #6b7280;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 8px;
            letter-spacing: 0.05em;
        }
        .kpi-value-small {
            font-size: 28px;
            font-weight: 700;
            color: #1f2937;
            font-variant-numeric: tabular-nums;
        }

        /* Professional Monthly Table */
        .professional-monthly-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 15px;
        }
        .professional-monthly-table thead th {
            background: linear-gradient(to bottom, #047857 0%, #059669 100%);
            color: white;
            padding: 16px 14px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 3px solid #10b981;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .professional-monthly-table tbody tr {
            transition: all 0.2s;
        }
        .professional-monthly-table tbody tr:nth-child(even) {
            background: #f9fafb;
        }
        .professional-monthly-table tbody tr:hover {
            background: #f0fdf4;
            box-shadow: 0 2px 8px rgba(5, 150, 105, 0.1);
        }
        .professional-monthly-table tbody td {
            padding: 16px 14px;
            border-bottom: 1px solid #e5e7eb;
        }
        .professional-monthly-table tbody td:first-child {
            font-weight: 700;
            color: #1f2937;
            font-size: 15px;
        }
        .professional-monthly-table tbody td.number {
            text-align: right;
            font-variant-numeric: tabular-nums;
            font-weight: 600;
            font-size: 16px;
        }
        .professional-monthly-table .month-total {
            background: linear-gradient(to bottom, #d1fae5 0%, #a7f3d0 100%);
            font-weight: 700;
            border-top: 2px solid #10b981;
        }
        .professional-monthly-table .month-total td {
            font-size: 17px;
            color: #047857;
        }

        /* Dark mode for OPERATIVA */
        body.dark-mode .kpi-card-small {
            background: linear-gradient(135deg, #064e3b 0%, #065f46 100%);
            border-left-color: #10b981;
        }
        body.dark-mode .kpi-card-small.blue {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
            border-left-color: #3b82f6;
        }
        body.dark-mode .kpi-card-small.yellow {
            background: linear-gradient(135deg, #78350f 0%, #92400e 100%);
            border-left-color: #f59e0b;
        }
        body.dark-mode .kpi-value-small,
        body.dark-mode .ranking-name,
        body.dark-mode .ranking-value {
            color: #f3f4f6;
        }
        body.dark-mode .professional-monthly-table thead th {
            background: linear-gradient(to bottom, #064e3b 0%, #065f46 100%);
        }
        body.dark-mode .professional-monthly-table tbody tr:nth-child(even) {
            background: #1f2937;
        }
        body.dark-mode .professional-monthly-table tbody tr:hover {
            background: #065f46;
        }

        /* Performance Alerts */
        .alert-banner {
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 24px;
            border-left: 4px solid;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
        }
        .alert-banner.danger {
            background: #fee2e2;
            border-left-color: #dc2626;
            color: #991b1b;
        }
        .alert-banner.warning {
            background: #fef3c7;
            border-left-color: #f59e0b;
            color: #92400e;
        }
        .alert-banner.success {
            background: #d1fae5;
            border-left-color: #059669;
            color: #065f46;
        }
        .alert-icon {
            font-size: 24px;
        }
        .alert-content {
            flex: 1;
        }
        .alert-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        .alert-message {
            font-size: 14px;
            opacity: 0.9;
        }

        /* Timeline Item */
        .timeline-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        .timeline-item:last-child {
            border-bottom: none;
        }
        .timeline-date {
            min-width: 120px;
            font-size: 13px;
            font-weight: 600;
            color: #6b7280;
        }
        .timeline-odjel {
            flex: 1;
            font-size: 15px;
            font-weight: 600;
            color: #1f2937;
        }
        .timeline-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .timeline-status.fresh {
            background: #d1fae5;
            color: #065f46;
        }
        .timeline-status.warning {
            background: #fef3c7;
            color: #92400e;
        }
        .timeline-status.old {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Sortimenti Bar */
        .sortimenti-bar-container {
            margin-bottom: 20px;
        }
        .sortimenti-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }
        .sortimenti-label-name {
            font-weight: 600;
            color: #1f2937;
        }
        .sortimenti-label-value {
            font-weight: 700;
            color: #059669;
        }
        .sortimenti-bar {
            height: 40px;
            background: #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
        }
        .sortimenti-bar-cetinari {
            background: linear-gradient(90deg, #059669, #10b981);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            font-weight: 700;
        }
        .sortimenti-bar-liscari {
            background: linear-gradient(90deg, #f59e0b, #fbbf24);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            font-weight: 700;
        }

        /* ============================================ */
        /* PERFORMANCE OPTIMIZATIONS */
        /* ============================================ */

        /* GPU acceleration for animations */
        .tab, .btn, .card, .toast {
            will-change: transform;
            transform: translateZ(0);
            backface-visibility: hidden;
        }

        /* Optimize table rendering */
        table {
            contain: layout style paint;
        }

        /* Reduce repaints during scroll */
        .container {
            contain: layout style;
        }

        /* Optimize transitions */
        * {
            transition-duration: 0.15s !important; /* Faster transitions */
        }

        /* Disable animations during heavy operations */
        .loading * {
            animation: none !important;
            transition: none !important;
        }

        /* Optimize font rendering */
        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
        }

        /* Hardware accelerate scrolling */
        * {
            -webkit-overflow-scrolling: touch;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <!-- Toast Notification Container -->
    <div id="toast-container" class="toast-container"></div>

    <div id="login-screen" class="login-container">
        <div class="login-box">
            <!-- Logo Container -->
            <div style="text-align: center; margin-bottom: 24px;">
                <img src="logo-zuti.png" alt="ŠPD Unsko-Sanske Šume Logo" style="width: 180px; height: auto; margin-bottom: 16px;">
                <h3 style="font-size: 16px; font-weight: 700; color: #047857; margin-bottom: 4px; letter-spacing: 0.5px;">ŠPD "UNSKO-SANSKE ŠUME"</h3>
                <h4 style="font-size: 14px; font-weight: 600; color: #6b7280; margin-bottom: 8px;">BOSANSKA KRUPA</h4>
            </div>

            <h2>Šumarija</h2>
            <p>Evidencija sječe i otpreme</p>

            <form id="login-form">
                <div id="error-msg" class="error hidden"></div>
                
                <div class="form-group">
                    <label>Korisničko ime</label>
                    <input type="text" id="username" placeholder="Email ili username" required>
                </div>
                
                <div class="form-group">
                    <label>Šifra</label>
                    <input type="password" id="password" placeholder="••••••••" required>
                </div>
                
                <button type="submit" class="btn" id="login-btn">Prijavi se</button>
            </form>
        </div>
    </div>
    
    <div id="app-screen" class="hidden">
        <div class="header">
            <div class="header-content">
                <div class="header-left">
                    <div class="header-title">
                        <p style="font-size: 20px; color: #047857; margin-bottom: 4px; font-weight: 700; letter-spacing: 0.5px;">ŠPD "UNSKO-SANSKE ŠUME" D.O.O. BOS.KRUPA</p>
                        <h1>Pogon gospodarenja Bos. Krupa</h1>
                        <p>Evidencija sječe i otpreme</p>
                    </div>
                </div>
                <div class="header-center">
                    <img src="logo-zuti.png" alt="ŠPD Unsko-Sanske Šume Logo" class="company-logo" id="company-logo">
                </div>
                <div class="header-right">
                    <div class="header-user">
                        <div class="header-user-name" id="user-name"></div>
                        <div class="header-user-role" id="user-role"></div>
                    </div>
                    <div class="user-menu">
                        <button class="user-menu-button" onclick="toggleUserMenu()">
                            <span>⚙️</span>
                            <span>Meni</span>
                        </button>
                        <div class="user-menu-dropdown" id="user-menu-dropdown">
                            <div class="user-menu-item" onclick="toggleDarkMode(); toggleUserMenu();">🌙 Dark Mode</div>
                            <div class="user-menu-item" onclick="preloadAllViews(); toggleUserMenu();">⚡ Učitaj sve prikaze</div>
                            <div class="user-menu-item" onclick="clearAllCache()">🗑️ Obriši keš</div>
                            <div class="user-menu-item danger" onclick="logout()">🚪 Odjavi se</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cache indicator -->
        <div id="cache-indicator" class="cache-indicator hidden"></div>

        <div class="tabs-container">
            <div class="tabs" id="tabs-menu">
                <!-- Tabs will be dynamically populated based on user type -->
            </div>
        </div>

        <div id="loading-screen" class="loading">
            <div class="loading-icon">⏳</div>
            <div class="loading-text">Učitavam podatke...</div>
        </div>
        
        <!-- DASHBOARD CONTENT (Šumarija Krupa) -->
        <div id="dashboard-content" class="container hidden">
            <!-- Summary Cards -->
            <div class="summary-cards" id="summary-cards"></div>

            <!-- Monthly Table -->
            <div class="section">
                <h2>📊 Mjesečni pregled</h2>
                <div class="controls-bar">
                    <input type="text" class="search-input" id="dashboard-search" placeholder="🔍 Pretraži po mjesecu..." onkeyup="filterDashboardTable()">
                    <button class="btn btn-primary" onclick="exportTableToCSV('dashboard')">📥 Export CSV</button>
                </div>
                <table class="professional-monthly-table" id="dashboard-table">
                    <thead>
                        <tr>
                            <th onclick="sortTable(0, 'dashboard-table')" style="text-align: left;">Mjesec ⇅</th>
                            <th class="right" onclick="sortTable(1, 'dashboard-table')">Ukupna Sječa (m³) ⇅</th>
                            <th class="right" onclick="sortTable(2, 'dashboard-table')">Ukupna Otprema (m³) ⇅</th>
                            <th class="right" onclick="sortTable(3, 'dashboard-table')">Zaliha ⇅</th>
                            <th class="right" onclick="sortTable(4, 'dashboard-table')">Dinamika ⇅</th>
                            <th class="right" onclick="sortTable(5, 'dashboard-table')">Razlika Sječa - Dinamika ⇅</th>
                            <th class="right" onclick="sortTable(6, 'dashboard-table')">Razlika Otprema - Dinamika ⇅</th>
                        </tr>
                    </thead>
                    <tbody id="dashboard-monthly-table"></tbody>
                </table>
            </div>

            <!-- Odjeli Table -->
            <div class="section">
                <h2>🏭 Pregled po odjelima</h2>
                <div class="controls-bar">
                    <input type="text" class="search-input" id="odjeli-search" placeholder="🔍 Pretraži po odjelu..." onkeyup="filterOdjeliTable()">
                    <button class="btn btn-primary" onclick="exportTableToCSV('odjeli')">📥 Export CSV</button>
                </div>
                <table class="monthly-table" id="odjeli-table">
                    <thead>
                        <tr>
                            <th onclick="sortTable(0, 'odjeli-table')">Odjel ⇅</th>
                            <th class="right" onclick="sortTable(1, 'odjeli-table')">Sječa (m³) ⇅</th>
                            <th class="right" onclick="sortTable(2, 'odjeli-table')">Otprema (m³) ⇅</th>
                            <th class="right" onclick="sortTable(3, 'odjeli-table')">Zaliha ⇅</th>
                            <th onclick="sortTable(4, 'odjeli-table')">Radilište ⇅</th>
                            <th onclick="sortTable(5, 'odjeli-table')">Izvođač Radova ⇅</th>
                            <th onclick="sortTable(6, 'odjeli-table')">Datum Zadnje Sječe ⇅</th>
                            <th class="right" onclick="sortTable(7, 'odjeli-table')">Realizacija % ⇅</th>
                        </tr>
                    </thead>
                    <tbody id="odjeli-table-body"></tbody>
                </table>
            </div>

            <!-- Chart -->
            <div class="section">
                <h2>📈 Trendovi sječe i otpreme</h2>
                <div class="chart-container">
                    <canvas id="trendsChart"></canvas>
                </div>
            </div>
        </div>

        <!-- MJESEČNI SORTIMENTI CONTENT -->
        <div id="mjesecni-sortimenti-content" class="container hidden">
            <!-- SJEČA PO MJESECIMA -->
            <div class="section">
                <div class="page-header">
                    <div class="page-header-left">
                        <h1>📊 Sječa po mjesecima i sortimentima</h1>
                        <p>Prikaz mjesečnih podataka za tekuću godinu</p>
                    </div>
                    <div class="page-header-right">
                        <button class="btn btn-primary" onclick="exportTableToCSV('mjesecna-sjeca')">📥 Export CSV</button>
                    </div>
                </div>
                <div class="kupci-table-wrapper mjesecni-table-wrapper">
                    <table class="kupci-table" id="mjesecna-sjeca-table">
                        <thead id="mjesecna-sjeca-header"></thead>
                        <tbody id="mjesecna-sjeca-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- OTPREMA PO MJESECIMA -->
            <div class="section">
                <div class="page-header">
                    <div class="page-header-left">
                        <h1>🚛 Otprema po mjesecima i sortimentima</h1>
                        <p>Prikaz mjesečnih podataka za tekuću godinu</p>
                    </div>
                    <div class="page-header-right">
                        <button class="btn btn-primary" onclick="exportTableToCSV('mjesecna-otprema')">📥 Export CSV</button>
                    </div>
                </div>
                <div class="kupci-table-wrapper mjesecni-table-wrapper">
                    <table class="kupci-table" id="mjesecna-otprema-table">
                        <thead id="mjesecna-otprema-header"></thead>
                        <tbody id="mjesecna-otprema-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- PRIMACI CONTENT (Prikaz po primačima) -->
        <div id="primaci-content" class="container hidden">
            <h2>👷 Prikaz sječe</h2>

            <!-- Submenu -->
            <div class="submenu">
                <button class="submenu-tab active" onclick="switchPrimaciSubmenu('monthly')">📊 Mjesečni prikaz</button>
                <button class="submenu-tab" onclick="switchPrimaciSubmenu('daily')">📅 Po danima</button>
                <button class="submenu-tab" onclick="switchPrimaciSubmenu('radilista')">🏗️ Radilišta</button>
                <button class="submenu-tab" onclick="switchPrimaciSubmenu('izvodjaci')">👷 Izvođači</button>
            </div>

            <!-- Mjesečni prikaz -->
            <div id="primaci-monthly-view" class="submenu-content">
                <div class="section">
                    <div class="controls-bar">
                        <input type="text" class="search-input" id="primaci-search" placeholder="🔍 Pretraži po imenu primača..." onkeyup="filterPrimaciTable()">
                        <button class="btn btn-primary" onclick="exportTableToCSV('primaci')">📥 Export CSV</button>
                    </div>
                    <table class="monthly-table" id="primaci-table">
                        <thead id="primaci-header"></thead>
                        <tbody id="primaci-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- Dnevni prikaz - tekući mjesec -->
            <div id="primaci-daily-view" class="submenu-content hidden">
                <div class="section">
                    <div class="month-selector">
                        <label for="primaci-month-select">📅 Izaberi mjesec:</label>
                        <select id="primaci-month-select" class="month-select" onchange="loadPrimaciDaily(this.value)">
                            <option value="0">Januar</option>
                            <option value="1">Februar</option>
                            <option value="2">Mart</option>
                            <option value="3">April</option>
                            <option value="4">Maj</option>
                            <option value="5">Juni</option>
                            <option value="6">Juli</option>
                            <option value="7">Avgust</option>
                            <option value="8">Septembar</option>
                            <option value="9">Oktobar</option>
                            <option value="10">Novembar</option>
                            <option value="11">Decembar</option>
                        </select>
                    </div>
                    <div class="controls-bar">
                        <input type="text" class="search-input" id="primaci-daily-search" placeholder="🔍 Pretraži..." onkeyup="filterPrimaciDailyTable()">
                        <button class="btn btn-primary" onclick="exportTableToCSV('primaci-daily')">📥 Export CSV</button>
                    </div>
                    <div class="kupci-table-wrapper">
                        <table class="kupci-table" id="primaci-daily-table">
                            <thead id="primaci-daily-header"></thead>
                            <tbody id="primaci-daily-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Prikaz po radilištima -->
            <div id="primaci-radilista-view" class="submenu-content hidden">
                <div class="section">
                    <h3 style="color: #ea580c; text-align: center; margin-bottom: 20px;">🏗️ Prikaz sječe po radilištima</h3>
                    <div class="controls-bar">
                        <button class="btn btn-primary" onclick="exportTableToCSV('primaci-radilista')">📥 Export CSV</button>
                    </div>
                    <table class="monthly-table" id="primaci-radilista-table">
                        <thead id="primaci-radilista-header"></thead>
                        <tbody id="primaci-radilista-body"></tbody>
                    </table>
                    <h4 style="color: #7c2d12; margin-top: 30px; margin-bottom: 15px;">📊 Godišnja rekapitulacija po sortimentima</h4>
                    <table class="monthly-table" id="primaci-radilista-recap">
                        <thead id="primaci-radilista-recap-header"></thead>
                        <tbody id="primaci-radilista-recap-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- Prikaz po izvođačima -->
            <div id="primaci-izvodjaci-view" class="submenu-content hidden">
                <div class="section">
                    <h3 style="color: #ea580c; text-align: center; margin-bottom: 20px;">👷 Prikaz sječe po izvođačima radova</h3>
                    <div class="controls-bar">
                        <button class="btn btn-primary" onclick="exportTableToCSV('primaci-izvodjaci')">📥 Export CSV</button>
                    </div>
                    <table class="monthly-table" id="primaci-izvodjaci-table">
                        <thead id="primaci-izvodjaci-header"></thead>
                        <tbody id="primaci-izvodjaci-body"></tbody>
                    </table>
                    <h4 style="color: #7c2d12; margin-top: 30px; margin-bottom: 15px;">📊 Godišnja rekapitulacija po sortimentima</h4>
                    <table class="monthly-table" id="primaci-izvodjaci-recap">
                        <thead id="primaci-izvodjaci-recap-header"></thead>
                        <tbody id="primaci-izvodjaci-recap-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- OTPREMACI CONTENT (Prikaz po otpremačima) -->
        <div id="otpremaci-content" class="container hidden">
            <h2>🚛 Prikaz otpreme</h2>

            <!-- Submenu -->
            <div class="submenu">
                <button class="submenu-tab active" onclick="switchOtremaciSubmenu('monthly')">📊 Mjesečni prikaz</button>
                <button class="submenu-tab" onclick="switchOtremaciSubmenu('daily')">📅 Po danima</button>
                <button class="submenu-tab" onclick="switchOtremaciSubmenu('radilista')">🏗️ Radilišta</button>
                <button class="submenu-tab" onclick="switchOtremaciSubmenu('po-kupcima')" id="otpremaci-po-kupcima-tab">🏢 Otprema u <span id="current-month-name">tekućem mjesecu</span></button>
            </div>

            <!-- Mjesečni prikaz -->
            <div id="otpremaci-monthly-view" class="submenu-content">
                <div class="section">
                    <div class="controls-bar">
                        <input type="text" class="search-input" id="otpremaci-search" placeholder="🔍 Pretraži po imenu otpremača..." onkeyup="filterOtremaciTable()">
                        <button class="btn btn-primary" onclick="exportTableToCSV('otpremaci')">📥 Export CSV</button>
                    </div>
                    <table class="monthly-table" id="otpremaci-table">
                        <thead id="otpremaci-header"></thead>
                        <tbody id="otpremaci-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- Dnevni prikaz - tekući mjesec -->
            <div id="otpremaci-daily-view" class="submenu-content hidden">
                <div class="section">
                    <div class="month-selector">
                        <label for="otpremaci-month-select">📅 Izaberi mjesec:</label>
                        <select id="otpremaci-month-select" class="month-select" onchange="loadOtremaciDaily(this.value)">
                            <option value="0">Januar</option>
                            <option value="1">Februar</option>
                            <option value="2">Mart</option>
                            <option value="3">April</option>
                            <option value="4">Maj</option>
                            <option value="5">Juni</option>
                            <option value="6">Juli</option>
                            <option value="7">Avgust</option>
                            <option value="8">Septembar</option>
                            <option value="9">Oktobar</option>
                            <option value="10">Novembar</option>
                            <option value="11">Decembar</option>
                        </select>
                    </div>
                    <div class="controls-bar">
                        <input type="text" class="search-input" id="otpremaci-daily-search" placeholder="🔍 Pretraži..." onkeyup="filterOtremaciDailyTable()">
                        <button class="btn btn-primary" onclick="exportTableToCSV('otpremaci-daily')">📥 Export CSV</button>
                    </div>
                    <div class="kupci-table-wrapper">
                        <table class="kupci-table" id="otpremaci-daily-table">
                            <thead id="otpremaci-daily-header"></thead>
                            <tbody id="otpremaci-daily-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Prikaz po radilištima -->
            <div id="otpremaci-radilista-view" class="submenu-content hidden">
                <div class="section">
                    <h3 style="color: #0891b2; text-align: center; margin-bottom: 20px;">🏗️ Prikaz otpreme po radilištima</h3>
                    <div class="controls-bar">
                        <button class="btn btn-primary" onclick="exportTableToCSV('otpremaci-radilista')">📥 Export CSV</button>
                    </div>
                    <table class="monthly-table" id="otpremaci-radilista-table">
                        <thead id="otpremaci-radilista-header"></thead>
                        <tbody id="otpremaci-radilista-body"></tbody>
                    </table>
                    <h4 style="color: #155e75; margin-top: 30px; margin-bottom: 15px;">📊 Godišnja rekapitulacija po sortimentima</h4>
                    <table class="monthly-table" id="otpremaci-radilista-recap">
                        <thead id="otpremaci-radilista-recap-header"></thead>
                        <tbody id="otpremaci-radilista-recap-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- Prikaz otpreme po kupcima u tekućem mjesecu -->
            <div id="otpremaci-po-kupcima-view" class="submenu-content hidden">
                <div class="section">
                    <h3 style="color: #0891b2; text-align: center; margin-bottom: 20px; font-size: 24px;">
                        🏢 Otprema po kupcima - <span id="otpremaci-po-kupcima-month-title"></span>
                    </h3>
                    <div class="controls-bar">
                        <input type="text" class="search-input" id="otpremaci-po-kupcima-search" placeholder="🔍 Pretraži po kupcu..." onkeyup="filterOtremaciPoKupcimaTable()">
                        <button class="btn btn-primary" onclick="exportTableToCSV('otpremaci-po-kupcima')">📥 Export CSV</button>
                    </div>
                    <div style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
                        <table class="expert-table" id="otpremaci-po-kupcima-table">
                            <thead id="otpremaci-po-kupcima-header"></thead>
                            <tbody id="otpremaci-po-kupcima-body"></tbody>
                            <tfoot id="otpremaci-po-kupcima-footer"></tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- KUPCI CONTENT (Prikaz po kupcima) -->
        <div id="kupci-content" class="container hidden">
            <!-- Godišnji pregled -->
            <div class="section">
                <h2>🏢 Godišnji pregled po kupcima</h2>
                <div class="controls-bar">
                    <input type="text" class="search-input" id="kupci-godisnji-search" placeholder="🔍 Pretraži po kupcu..." onkeyup="filterKupciGodisnjiTable()">
                    <button class="btn btn-primary" onclick="exportTableToCSV('kupci-godisnji')">📥 Export CSV</button>
                </div>
                <div class="kupci-table-wrapper">
                    <table class="kupci-table" id="kupci-godisnji-table">
                        <thead id="kupci-godisnji-header"></thead>
                        <tbody id="kupci-godisnji-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- Mjesečni pregled -->
            <div class="section">
                <h2>📅 Mjesečni pregled po kupcima</h2>
                <div class="controls-bar">
                    <input type="text" class="search-input" id="kupci-mjesecni-search" placeholder="🔍 Pretraži po kupcu..." onkeyup="filterKupciMjesecniTable()">
                    <button class="btn btn-primary" onclick="exportTableToCSV('kupci-mjesecni')">📥 Export CSV</button>
                </div>
                <div class="kupci-table-wrapper">
                    <table class="kupci-table" id="kupci-mjesecni-table">
                        <thead id="kupci-mjesecni-header"></thead>
                        <tbody id="kupci-mjesecni-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- PRIMAC PERSONAL VIEW -->
        <div id="primac-personal-content" class="container hidden">
            <div class="section">
                <!-- Professional Header -->
                <div class="worker-header primac">
                    <div class="worker-header-icon">👷</div>
                    <div style="flex: 1;">
                        <h1 class="worker-header-title">Pregled sječe</h1>
                        <p class="worker-header-subtitle">Pregled primki</p>
                    </div>
                    <div>
                        <select id="primac-personal-year-select" class="year-select" onchange="loadPrimacPersonal()" style="padding: 10px 16px; font-size: 16px; border-radius: 8px; border: 2px solid #047857; min-width: 120px;">
                            <option value="2026" selected>2026</option>
                            <option value="2025">2025</option>
                        </select>
                    </div>
                </div>

                <!-- Mjesečni dijagram sječe -->
                <div class="worker-chart-card primac">
                    <h3 class="worker-chart-title">📊 Mjesečna sječa - Grafički prikaz</h3>
                    <canvas id="primac-chart" class="worker-chart-canvas"></canvas>
                </div>

                <!-- Controls -->
                <div class="controls-bar">
                    <input type="text" class="search-input" id="primac-personal-search" placeholder="🔍 Pretraži po odjelu..." onkeyup="filterPrimacPersonalTable()">
                    <button class="btn btn-primary" onclick="exportTableToCSV('primac-personal')">📥 Export CSV</button>
                </div>

                <!-- Modern Table Card -->
                <div class="worker-table-card">
                    <div class="worker-table-card-header">
                        <h3 class="worker-table-card-title">
                            📋 Sječa po odjelima
                        </h3>
                        <span class="worker-table-card-badge" id="primac-row-count">0 redova</span>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="worker-table" id="primac-personal-table">
                            <thead id="primac-personal-header"></thead>
                            <tbody id="primac-personal-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- PRIMAC GODISNJI VIEW -->
        <div id="primac-godisnji-content" class="container hidden">
            <div class="section">
                <!-- Professional Header -->
                <div class="worker-header primac">
                    <div class="worker-header-icon">📅</div>
                    <div style="flex: 1;">
                        <h1 class="worker-header-title">Godišnji prikaz</h1>
                        <p class="worker-header-subtitle">Mjesečna rekapitulacija sječe</p>
                    </div>
                    <div>
                        <select id="primac-godisnji-year-select" class="year-select" onchange="loadPrimacGodisnji()" style="padding: 10px 16px; font-size: 16px; border-radius: 8px; border: 2px solid #047857; min-width: 120px;">
                            <option value="2026" selected>2026</option>
                            <option value="2025">2025</option>
                        </select>
                    </div>
                </div>

                <!-- Godišnja tabela -->
                <div class="worker-table-card">
                    <div class="worker-table-card-header">
                        <h3 class="worker-table-card-title">
                            📅 Godišnja rekapitulacija po mjesecima
                        </h3>
                        <span class="worker-table-card-badge" id="primac-godisnji-year-badge">2026</span>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="worker-table" id="primac-godisnji-main-table">
                            <thead id="primac-godisnji-main-header"></thead>
                            <tbody id="primac-godisnji-main-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- OTPREMAC PERSONAL VIEW -->
        <div id="otpremac-personal-content" class="container hidden">
            <div class="section">
                <!-- Professional Header -->
                <div class="worker-header otpremac">
                    <div class="worker-header-icon">🚛</div>
                    <div style="flex: 1;">
                        <h1 class="worker-header-title">Pregled otpreme</h1>
                        <p class="worker-header-subtitle">Pregled otpremnica</p>
                    </div>
                    <div>
                        <select id="otpremac-personal-year-select" class="year-select" onchange="loadOtpremacPersonal()" style="padding: 10px 16px; font-size: 16px; border-radius: 8px; border: 2px solid #2563eb; min-width: 120px;">
                            <option value="2026" selected>2026</option>
                            <option value="2025">2025</option>
                        </select>
                    </div>
                </div>

                <!-- Mjesečni dijagram otpreme -->
                <div class="worker-chart-card otpremac">
                    <h3 class="worker-chart-title">📊 Mjesečna otprema - Grafički prikaz</h3>
                    <canvas id="otpremac-chart" class="worker-chart-canvas"></canvas>
                </div>

                <!-- Controls -->
                <div class="controls-bar">
                    <input type="text" class="search-input" id="otpremac-personal-search" placeholder="🔍 Pretraži po odjelu/kupcu..." onkeyup="filterOtpremacPersonalTable()">
                    <button class="btn btn-primary" onclick="exportTableToCSV('otpremac-personal')">📥 Export CSV</button>
                </div>

                <!-- Modern Table Card -->
                <div class="worker-table-card">
                    <div class="worker-table-card-header">
                        <h3 class="worker-table-card-title">
                            📦 Otprema po odjelima i kupcima
                        </h3>
                        <span class="worker-table-card-badge blue" id="otpremac-row-count">0 redova</span>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="worker-table otpremac" id="otpremac-personal-table">
                            <thead id="otpremac-personal-header"></thead>
                            <tbody id="otpremac-personal-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- PRIMAC ODJELI VIEW (By Department) -->
        <div id="primac-odjeli-content" class="container hidden">
            <div class="section">
                <h2>🏭 Prikaz sječe po odjelima</h2>
                <div id="primac-odjeli-container"></div>
                <div class="controls-bar" style="justify-content: center; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="prevPagePrimacOdjeli()" id="primac-odjeli-prev">← Prethodna</button>
                    <span style="margin: 0 20px; font-weight: 600;" id="primac-odjeli-page-info">Stranica 1</span>
                    <button class="btn btn-secondary" onclick="nextPagePrimacOdjeli()" id="primac-odjeli-next">Sledeća →</button>
                </div>
            </div>
        </div>

        <!-- OTPREMAC ODJELI VIEW (By Department) -->
        <div id="otpremac-odjeli-content" class="container hidden">
            <div class="section">
                <h2>🏭 Prikaz otpreme po odjelima</h2>
                <div id="otpremac-odjeli-container"></div>
                <div class="controls-bar" style="justify-content: center; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="prevPageOtpremacOdjeli()" id="otpremac-odjeli-prev">← Prethodna</button>
                    <span style="margin: 0 20px; font-weight: 600;" id="otpremac-odjeli-page-info">Stranica 1</span>
                    <button class="btn btn-secondary" onclick="nextPageOtpremacOdjeli()" id="otpremac-odjeli-next">Sledeća →</button>
                </div>
            </div>
        </div>

        <!-- ADD SJECA FORM (For Primači) -->
        <div id="add-sjeca-content" class="container hidden">
            <div class="section">
                <form id="add-sjeca-form" class="worker-form" onsubmit="submitSjeca(event)">
                    <!-- Professional Header -->
                    <div class="worker-form-header">
                        <h2 class="worker-form-title">
                            <span>➕</span>
                            Dodaj novu sječu
                        </h2>
                        <p class="worker-form-subtitle">Unesite podatke o sječi - sva polja označena automatskim računanjem se automatski popunjavaju</p>
                    </div>

                    <!-- Basic Info -->
                    <div class="worker-form-grid">
                        <div class="worker-form-group">
                            <label class="worker-form-label">📅 Datum</label>
                            <input type="date" id="sjeca-datum" required class="worker-form-input">
                        </div>
                        <div class="worker-form-group">
                            <label class="worker-form-label">🏭 Odjel</label>
                            <select id="sjeca-odjel" required class="worker-form-select">
                                <option value="">Izaberi odjel...</option>
                            </select>
                        </div>
                    </div>

                    <!-- Sortimenti Section -->
                    <h3 class="worker-form-section-title">
                        <span>🌲</span>
                        Sortimenti Četinara (m³)
                    </h3>
                    <div class="worker-form-grid">
                        <div class="worker-form-group">
                            <label class="worker-form-label">F/L Č</label>
                            <input type="number" step="0.01" id="sjeca-FL-C" value="0" min="0" class="worker-form-input">
                        </div>
                        <div class="worker-form-group">
                            <label class="worker-form-label">I Č</label>
                            <input type="number" step="0.01" id="sjeca-I-C" value="0" min="0" class="worker-form-input">
                        </div>
                        <div class="worker-form-group">
                            <label class="worker-form-label">II Č</label>
                            <input type="number" step="0.01" id="sjeca-II-C" value="0" min="0" class="worker-form-input">
                        </div>
                        <div class="worker-form-group">
                            <label class="worker-form-label">III Č</label>
                            <input type="number" step="0.01" id="sjeca-III-C" value="0" min="0" class="worker-form-input">
                        </div>
                        <div class="worker-form-group">
                            <label class="worker-form-label">RUDNO</label>
                            <input type="number" step="0.01" id="sjeca-RUDNO" value="0" min="0" class="worker-form-input">
                        </div>
                        <div class="worker-form-group">
                            <label class="worker-form-label">TRUPCI Č <span style="font-size: 10px; color: #6b7280;">(AUTO)</span></label>
                            <input type="number" step="0.01" id="sjeca-TRUPCI-C" value="0" min="0" readonly class="worker-form-input" style="background: #f3f4f6; font-weight: 600;">
                        </div>
                        <div class="worker-form-group">
                            <label class="worker-form-label">CEL.DUGA</label>
                            <input type="number" step="0.01" id="sjeca-CEL-DUGA" value="0" min="0" class="worker-form-input">
                        </div>
                        <div class="worker-form-group">
                            <label class="worker-form-label">CEL.CIJEPANA</label>
                            <input type="number" step="0.01" id="sjeca-CEL-CIJEPANA" value="0" min="0" class="worker-form-input">
                        </div>
                        <div class="worker-form-group">
                            <label class="worker-form-label">ČETINARI <span style="font-size: 10px; color: #6b7280;">(AUTO)</span></label>
                            <input type="number" step="0.01" id="sjeca-CETINARI" value="0" min="0" readonly class="worker-form-input" style="background: #dbeafe; font-weight: 700; color: #1e40af;">
                        </div>
                    </div>

                    <h3 class="worker-form-section-title">
                        <span>🍂</span>
                        Sortimenti Lišćara (m³)
                    </h3>
                    <div class="worker-form-grid">
                        <div class="worker-form-group">
                            <label class="worker-form-label">F/L L</label>
                            <input type="number" step="0.01" id="sjeca-FL-L" value="0" min="0" class="worker-form-input">
                        </div>
                        <div class="worker-form-group">
                            <label class="worker-form-label">I L</label>
                            <input type="number" step="0.01" id="sjeca-I-L" value="0" min="0" class="worker-form-input">
                        </div>
                        <div class="worker-form-group">
                            <label class="worker-form-label">II L</label>
                            <input type="number" step="0.01" id="sjeca-II-L" value="0" min="0" class="worker-form-input">
                        </div>
                        <div class="worker-form-group">
                            <label class="worker-form-label">III L</label>
                            <input type="number" step="0.01" id="sjeca-III-L" value="0" min="0" class="worker-form-input">
                        </div>
                        <div class="worker-form-group">
                            <label class="worker-form-label">TRUPCI <span style="font-size: 10px; color: #6b7280;">(AUTO)</span></label>
                            <input type="number" step="0.01" id="sjeca-TRUPCI" value="0" min="0" readonly class="worker-form-input" style="background: #f3f4f6; font-weight: 600;">
                        </div>
                        <div class="worker-form-group">
                            <label class="worker-form-label">OGR.DUGI</label>
                            <input type="number" step="0.01" id="sjeca-OGR-DUGI" value="0" min="0" class="worker-form-input">
                        </div>
                        <div class="worker-form-group">
                            <label class="worker-form-label">OGR.CIJEPANI</label>
                            <input type="number" step="0.01" id="sjeca-OGR-CIJEPANI" value="0" min="0" class="worker-form-input">
                        </div>
                        <div class="worker-form-group">
                            <label class="worker-form-label">LIŠĆARI <span style="font-size: 10px; color: #6b7280;">(AUTO)</span></label>
                            <input type="number" step="0.01" id="sjeca-LISCARI" value="0" min="0" readonly class="worker-form-input" style="background: #fef3c7; font-weight: 700; color: #92400e;">
                        </div>
                    </div>

                    <!-- Total Box -->
                    <div class="worker-form-total-box">
                        <div class="worker-form-total-label">📊 SVEUKUPNO</div>
                        <input type="number" step="0.01" id="sjeca-SVEUKUPNO" value="0" readonly class="worker-form-total-value" style="border: none; background: transparent;">
                    </div>

                    <!-- Actions -->
                    <div class="worker-form-actions">
                        <button type="button" class="worker-form-btn worker-form-btn-secondary" onclick="resetSjecaForm()">Poništi</button>
                        <button type="submit" class="worker-form-btn worker-form-btn-primary" id="submit-sjeca-btn">Dodaj sječu</button>
                    </div>

                    <div id="sjeca-message" class="hidden" style="margin-top: 20px; padding: 12px; border-radius: 8px;"></div>
                </form>
            </div>
        </div>

        <!-- ADD OTPREMA FORM (For Otpremači) -->
        <div id="add-otprema-content" class="container hidden">
            <div class="section">
                <form id="add-otprema-form" class="worker-form otpremac" onsubmit="submitOtprema(event)">
                    <!-- Professional Header -->
                    <div class="worker-form-header">
                        <h2 class="worker-form-title">
                            <span>➕</span>
                            Dodaj novu otpremu
                        </h2>
                        <p class="worker-form-subtitle">Unesite podatke o otpremi - uključite kupca i broj otpremnice</p>
                    </div>

                    <!-- Basic Info -->
                    <div class="worker-form-grid">
                        <div class="worker-form-group">
                            <label class="worker-form-label">📅 Datum</label>
                            <input type="date" id="otprema-datum" required class="worker-form-input">
                        </div>
                        <div class="worker-form-group">
                            <label class="worker-form-label">🏭 Odjel</label>
                            <select id="otprema-odjel" required class="worker-form-select">
                                <option value="">Izaberi odjel...</option>
                            </select>
                        </div>
                        <div class="worker-form-group">
                            <label class="worker-form-label">🏢 Kupac</label>
                            <input type="text" id="otprema-kupac" placeholder="Naziv kupca" class="worker-form-input">
                        </div>
                        <div class="worker-form-group">
                            <label class="worker-form-label">📋 Broj otpremnice</label>
                            <input type="text" id="otprema-broj-otpremnice" placeholder="Unesite broj" class="worker-form-input">
                        </div>
                    </div>

                    <!-- Sortimenti Section -->
                    <h3 class="worker-form-section-title">
                        <span>🌲</span>
                        Sortimenti Četinara (m³)
                    </h3>
                    <div class="worker-form-grid">
                        <div class="worker-form-group">
                            <label class="worker-form-label">F/L Č</label>
                            <input type="number" step="0.01" id="otprema-FL-C" value="0" min="0" class="worker-form-input">
                        </div>
                        <div class="worker-form-group">
                            <label class="worker-form-label">I Č</label>
                            <input type="number" step="0.01" id="otprema-I-C" value="0" min="0" class="worker-form-input">
                        </div>
                        <div class="worker-form-group">
                            <label class="worker-form-label">II Č</label>
                            <input type="number" step="0.01" id="otprema-II-C" value="0" min="0" class="worker-form-input">
                        </div>
                        <div class="worker-form-group">
                            <label class="worker-form-label">III Č</label>
                            <input type="number" step="0.01" id="otprema-III-C" value="0" min="0" class="worker-form-input">
                        </div>
                        <div class="worker-form-group">
                            <label class="worker-form-label">RUDNO</label>
                            <input type="number" step="0.01" id="otprema-RUDNO" value="0" min="0" class="worker-form-input">
                        </div>
                        <div class="worker-form-group">
                            <label class="worker-form-label">TRUPCI Č <span style="font-size: 10px; color: #6b7280;">(AUTO)</span></label>
                            <input type="number" step="0.01" id="otprema-TRUPCI-C" value="0" min="0" readonly class="worker-form-input" style="background: #f3f4f6; font-weight: 600;">
                        </div>
                        <div class="worker-form-group">
                            <label class="worker-form-label">CEL.DUGA</label>
                            <input type="number" step="0.01" id="otprema-CEL-DUGA" value="0" min="0" class="worker-form-input">
                        </div>
                        <div class="worker-form-group">
                            <label class="worker-form-label">CEL.CIJEPANA</label>
                            <input type="number" step="0.01" id="otprema-CEL-CIJEPANA" value="0" min="0" class="worker-form-input">
                        </div>
                        <div class="worker-form-group">
                            <label class="worker-form-label">ČETINARI <span style="font-size: 10px; color: #6b7280;">(AUTO)</span></label>
                            <input type="number" step="0.01" id="otprema-CETINARI" value="0" min="0" readonly class="worker-form-input" style="background: #dbeafe; font-weight: 700; color: #1e40af;">
                        </div>
                    </div>

                    <h3 class="worker-form-section-title">
                        <span>🍂</span>
                        Sortimenti Lišćara (m³)
                    </h3>
                    <div class="worker-form-grid">
                        <div class="worker-form-group">
                            <label class="worker-form-label">F/L L</label>
                            <input type="number" step="0.01" id="otprema-FL-L" value="0" min="0" class="worker-form-input">
                        </div>
                        <div class="worker-form-group">
                            <label class="worker-form-label">I L</label>
                            <input type="number" step="0.01" id="otprema-I-L" value="0" min="0" class="worker-form-input">
                        </div>
                        <div class="worker-form-group">
                            <label class="worker-form-label">II L</label>
                            <input type="number" step="0.01" id="otprema-II-L" value="0" min="0" class="worker-form-input">
                        </div>
                        <div class="worker-form-group">
                            <label class="worker-form-label">III L</label>
                            <input type="number" step="0.01" id="otprema-III-L" value="0" min="0" class="worker-form-input">
                        </div>
                        <div class="worker-form-group">
                            <label class="worker-form-label">TRUPCI <span style="font-size: 10px; color: #6b7280;">(AUTO)</span></label>
                            <input type="number" step="0.01" id="otprema-TRUPCI" value="0" min="0" readonly class="worker-form-input" style="background: #f3f4f6; font-weight: 600;">
                        </div>
                        <div class="worker-form-group">
                            <label class="worker-form-label">OGR.DUGI</label>
                            <input type="number" step="0.01" id="otprema-OGR-DUGI" value="0" min="0" class="worker-form-input">
                        </div>
                        <div class="worker-form-group">
                            <label class="worker-form-label">OGR.CIJEPANI</label>
                            <input type="number" step="0.01" id="otprema-OGR-CIJEPANI" value="0" min="0" class="worker-form-input">
                        </div>
                        <div class="worker-form-group">
                            <label class="worker-form-label">LIŠĆARI <span style="font-size: 10px; color: #6b7280;">(AUTO)</span></label>
                            <input type="number" step="0.01" id="otprema-LISCARI" value="0" min="0" readonly class="worker-form-input" style="background: #fef3c7; font-weight: 700; color: #92400e;">
                        </div>
                    </div>

                    <!-- Total Box -->
                    <div class="worker-form-total-box">
                        <div class="worker-form-total-label">📊 SVEUKUPNO</div>
                        <input type="number" step="0.01" id="otprema-SVEUKUPNO" value="0" readonly class="worker-form-total-value" style="border: none; background: transparent;">
                    </div>

                    <!-- Actions -->
                    <div class="worker-form-actions">
                        <button type="button" class="worker-form-btn worker-form-btn-secondary" onclick="resetOtpremaForm()">Poništi</button>
                        <button type="submit" class="worker-form-btn worker-form-btn-primary otpremac" id="submit-otprema-btn">Dodaj otpremu</button>
                    </div>

                    <div id="otprema-message" class="hidden" style="margin-top: 20px; padding: 12px; border-radius: 8px;"></div>
                </form>
            </div>
        </div>

        <!-- MY SJECE VIEW (For Primač) -->
        <div id="my-sjece-content" class="container hidden">
            <div class="section">
                <!-- Professional Header -->
                <div class="worker-header primac">
                    <div class="worker-header-icon">📝</div>
                    <div>
                        <h1 class="worker-header-title">Moje sječe</h1>
                        <p class="worker-header-subtitle">Pregledajte i ispravite vaše nedavne unose - zadnjih 10 zapisa</p>
                    </div>
                </div>

                <!-- Modern Card Container -->
                <div class="worker-table-card">
                    <div class="worker-table-card-header">
                        <h3 class="worker-table-card-title">📋 Nedavni unosi</h3>
                        <span class="worker-table-card-badge" id="my-sjece-count">0 zapisa</span>
                    </div>
                    <div id="my-sjece-container"></div>
                </div>
            </div>
        </div>

        <!-- MY OTPREME VIEW (For Otpremač) -->
        <div id="my-otpreme-content" class="container hidden">
            <div class="section">
                <!-- Professional Header -->
                <div class="worker-header otpremac">
                    <div class="worker-header-icon">📝</div>
                    <div>
                        <h1 class="worker-header-title">Moje otpreme</h1>
                        <p class="worker-header-subtitle">Pregledajte i ispravite vaše nedavne unose - zadnjih 10 zapisa</p>
                    </div>
                </div>

                <!-- Modern Card Container -->
                <div class="worker-table-card">
                    <div class="worker-table-card-header">
                        <h3 class="worker-table-card-title">📦 Nedavni unosi</h3>
                        <span class="worker-table-card-badge blue" id="my-otpreme-count">0 zapisa</span>
                    </div>
                    <div id="my-otpreme-container"></div>
                </div>
            </div>
        </div>

        <!-- EDIT SJECA FORM (For editing existing entry) -->
        <div id="edit-sjeca-content" class="container hidden">
            <div class="section">
                <form id="edit-sjeca-form" class="worker-form" onsubmit="submitEditSjeca(event)">
                    <input type="hidden" id="edit-sjeca-rowIndex">

                    <!-- Professional Header -->
                    <div class="worker-form-header">
                        <h2 class="worker-form-title">
                            <span>✏️</span>
                            Uredi sječu
                        </h2>
                        <p class="worker-form-subtitle">Izmjenite podatke o sječi - automatski totali će se preračunati</p>
                    </div>

                    <!-- Basic Info -->
                    <div class="worker-form-grid">
                        <div class="worker-form-group">
                            <label class="worker-form-label">📅 Datum</label>
                            <input type="date" id="edit-sjeca-datum" required class="worker-form-input">
                        </div>
                        <div class="worker-form-group">
                            <label class="worker-form-label">🏭 Odjel</label>
                            <select id="edit-sjeca-odjel" required class="worker-form-select">
                                <option value="">Izaberi odjel...</option>
                            </select>
                        </div>
                    </div>

                    <!-- Sortimenti Section -->
                    <h3 class="worker-form-section-title">
                        <span>🌲</span>
                        Sortimenti (m³)
                    </h3>
                    <div class="worker-form-grid" id="edit-sjeca-sortimenti">
                        <!-- Sortimenti fields will be dynamically added here -->
                    </div>

                    <!-- Total Box -->
                    <div class="worker-form-total-box">
                        <div class="worker-form-total-label">📊 SVEUKUPNO</div>
                        <input type="number" step="0.01" id="edit-sjeca-SVEUKUPNO" value="0" readonly class="worker-form-total-value" style="border: none; background: transparent;">
                    </div>

                    <!-- Actions -->
                    <div class="worker-form-actions">
                        <button type="button" class="worker-form-btn worker-form-btn-secondary" onclick="cancelEditSjeca()">Otkaži</button>
                        <button type="submit" class="worker-form-btn worker-form-btn-primary" id="submit-edit-sjeca-btn">Sačuvaj izmjene</button>
                    </div>

                    <div id="edit-sjeca-message" class="hidden" style="margin-top: 20px; padding: 12px; border-radius: 8px;"></div>
                </form>
            </div>
        </div>

        <!-- EDIT OTPREMA FORM (For editing existing entry) -->
        <div id="edit-otprema-content" class="container hidden">
            <div class="section">
                <form id="edit-otprema-form" class="worker-form otpremac" onsubmit="submitEditOtprema(event)">
                    <input type="hidden" id="edit-otprema-rowIndex">

                    <!-- Professional Header -->
                    <div class="worker-form-header">
                        <h2 class="worker-form-title">
                            <span>✏️</span>
                            Uredi otpremu
                        </h2>
                        <p class="worker-form-subtitle">Izmjenite podatke o otpremi - automatski totali će se preračunati</p>
                    </div>

                    <!-- Basic Info -->
                    <div class="worker-form-grid">
                        <div class="worker-form-group">
                            <label class="worker-form-label">📅 Datum</label>
                            <input type="date" id="edit-otprema-datum" required class="worker-form-input">
                        </div>
                        <div class="worker-form-group">
                            <label class="worker-form-label">🏭 Odjel</label>
                            <select id="edit-otprema-odjel" required class="worker-form-select">
                                <option value="">Izaberi odjel...</option>
                            </select>
                        </div>
                        <div class="worker-form-group">
                            <label class="worker-form-label">🏢 Kupac</label>
                            <input type="text" id="edit-otprema-kupac" placeholder="Naziv kupca" class="worker-form-input">
                        </div>
                        <div class="worker-form-group">
                            <label class="worker-form-label">📋 Broj otpremnice</label>
                            <input type="text" id="edit-otprema-broj-otpremnice" placeholder="Unesite broj" class="worker-form-input">
                        </div>
                    </div>

                    <!-- Sortimenti Section -->
                    <h3 class="worker-form-section-title">
                        <span>🌲</span>
                        Sortimenti (m³)
                    </h3>
                    <div class="worker-form-grid" id="edit-otprema-sortimenti">
                        <!-- Sortimenti fields will be dynamically added here -->
                    </div>

                    <!-- Total Box -->
                    <div class="worker-form-total-box">
                        <div class="worker-form-total-label">📊 SVEUKUPNO</div>
                        <input type="number" step="0.01" id="edit-otprema-SVEUKUPNO" value="0" readonly class="worker-form-total-value" style="border: none; background: transparent;">
                    </div>

                    <!-- Actions -->
                    <div class="worker-form-actions">
                        <button type="button" class="worker-form-btn worker-form-btn-secondary" onclick="cancelEditOtprema()">Otkaži</button>
                        <button type="submit" class="worker-form-btn worker-form-btn-primary otpremac" id="submit-edit-otprema-btn">Sačuvaj izmjene</button>
                    </div>

                    <div id="edit-otprema-message" class="hidden" style="margin-top: 20px; padding: 12px; border-radius: 8px;"></div>
                </form>
            </div>
        </div>

        <!-- OPERATIVA CONTENT - Analytics Dashboard -->
        <div id="operativa-content" class="container hidden">
            <div class="page-header">
                <div class="page-header-left">
                    <h1>📊 Operativa & Analiza</h1>
                    <p>Napredna analitika i KPI metrike za donošenje odluka</p>
                </div>
                <div class="page-header-right">
                    <span class="badge success">Godišnji pregled</span>
                </div>
            </div>

            <!-- KPI Metrics Cards -->
            <div class="kpi-grid">
                <div class="kpi-card-small">
                    <div class="kpi-label-small">Sječa/Otprema Ratio</div>
                    <div class="kpi-value-small" id="kpi-ratio">0.00</div>
                </div>
                <div class="kpi-card-small blue">
                    <div class="kpi-label-small">Procenat Ostvarenja</div>
                    <div class="kpi-value-small" id="kpi-procenat">0%</div>
                </div>
                <div class="kpi-card-small yellow">
                    <div class="kpi-label-small">Ukupno Odjela</div>
                    <div class="kpi-value-small" id="kpi-odjela">0</div>
                </div>
                <div class="kpi-card-small purple">
                    <div class="kpi-label-small">Prosječna Sječa</div>
                    <div class="kpi-value-small" id="kpi-avg-sjeca">0 m³</div>
                </div>
            </div>

            <!-- Analytics Grid - Top 5 & Projekat Progress -->
            <div class="analytics-grid">
                <!-- Top 5 Odjela by Sječa -->
                <div class="section">
                    <h2>🏆 Top 5 Odjela - Sječa</h2>
                    <p>Najboljih pet odjela po ukupnoj sječi</p>
                    <div id="top-odjeli-list">
                        <div class="ranking-item">
                            <div class="ranking-number">1</div>
                            <div class="ranking-info">
                                <div class="ranking-name">Učitavanje...</div>
                                <div class="ranking-value">0.00 m³</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Projekat vs Ostvareno Progress Bars -->
                <div class="section">
                    <h2>🎯 Projekat vs Ostvareno</h2>
                    <p>Procenat realizacije plana po odjelima</p>
                    <div id="projekat-ostvareno-list">
                        <div style="margin-bottom: 16px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                <span style="font-weight: 600; color: #1f2937;">Učitavanje...</span>
                                <span style="font-weight: 700; color: #059669;">0.0%</span>
                            </div>
                            <div class="progress-bar-container" style="height: 12px;">
                                <div class="progress-bar-fill" style="width: 0%; background: #e5e7eb;"></div>
                            </div>
                            <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">0 / 0 m³</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Monthly Trend Analysis -->
            <div class="section">
                <h2>📈 Monthly Trend - Analiza</h2>
                <p>Mjesečna analiza trendova sječe i otpreme</p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px; margin-top: 20px;">
                    <div>
                        <div style="font-size: 13px; color: #6b7280; font-weight: 600; margin-bottom: 4px;">AVG SJEČA PO MJESECU</div>
                        <div style="font-size: 28px; font-weight: 700; color: #059669;" id="avg-monthly-sjeca">0 m³</div>
                    </div>
                    <div>
                        <div style="font-size: 13px; color: #6b7280; font-weight: 600; margin-bottom: 4px;">AVG OTPREMA PO MJESECU</div>
                        <div style="font-size: 28px; font-weight: 700; color: #2563eb;" id="avg-monthly-otprema">0 m³</div>
                    </div>
                </div>

                <!-- Chart Legend -->
                <div class="line-legend">
                    <div class="line-legend-item">
                        <div class="line-legend-color green"></div>
                        <span>Sječa</span>
                    </div>
                    <div class="line-legend-item">
                        <div class="line-legend-color blue"></div>
                        <span>Otprema</span>
                    </div>
                </div>

                <svg id="analytics-chart" class="chart-svg"></svg>
            </div>

            <!-- Performance Alerts Banner -->
            <div id="performance-alerts-banner" style="display: none;"></div>

            <!-- Izvođači Performance -->
            <div class="section">
                <h2>👷 Top Izvođači Radova</h2>
                <p>Ranking izvođača po ukupnom volume-u sječe</p>
                <div id="izvodjaci-performance-list">
                    <p style="color: #6b7280; text-align: center; padding: 20px;">Učitavanje...</p>
                </div>
            </div>

            <!-- Timeline Analysis -->
            <div class="analytics-grid">
                <div class="section">
                    <h2>📅 Timeline - Zadnji Unosi</h2>
                    <p>Odjeli sortirani po datumu zadnjeg unosa</p>
                    <div id="timeline-unosi-list">
                        <p style="color: #6b7280; text-align: center; padding: 20px;">Učitavanje...</p>
                    </div>
                </div>
            </div>

            <!-- Seasonal Analysis (Q1-Q4) -->
            <div class="section">
                <h2>📅 Sezonska Analiza - Quartali</h2>
                <p>Produktivnost po quarter-ima (Q1: Jan-Mar, Q2: Apr-Jun, Q3: Jul-Sep, Q4: Oct-Dec)</p>
                <div class="kpi-grid" id="seasonal-analysis">
                    <p style="color: #6b7280; text-align: center; padding: 20px;">Učitavanje...</p>
                </div>
            </div>

            <!-- Detaljni Pregled - All Odjeli Table -->
            <div class="section">
                <h2>📊 Detaljni Pregled - Svi Odjeli</h2>
                <p>Kompletna analiza svih odjela sa projekat realizacijom</p>
                <div class="controls-bar" style="margin-top: 20px;">
                    <input type="text" class="search-input" id="analytics-search" placeholder="🔍 Pretraži po odjelu..." onkeyup="filterAnalyticsTable()">
                    <button class="btn btn-primary" onclick="exportTableToCSV('analytics-odjeli')">📥 Export CSV</button>
                </div>
                <table class="monthly-table" id="analytics-odjeli-main-table">
                    <thead>
                        <tr>
                            <th onclick="sortTable(0, 'analytics-odjeli-main-table')">Odjel ⇅</th>
                            <th class="right" onclick="sortTable(1, 'analytics-odjeli-main-table')">Sječa (m³) ⇅</th>
                            <th class="right" onclick="sortTable(2, 'analytics-odjeli-main-table')">Otprema (m³) ⇅</th>
                            <th class="right" onclick="sortTable(3, 'analytics-odjeli-main-table')">Projekat ⇅</th>
                            <th class="right" onclick="sortTable(4, 'analytics-odjeli-main-table')">% Ostvareno ⇅</th>
                            <th class="right" onclick="sortTable(5, 'analytics-odjeli-main-table')">Razlika ⇅</th>
                        </tr>
                    </thead>
                    <tbody id="analytics-odjeli-table"></tbody>
                </table>
            </div>
        </div>

        <!-- KUPCI CONTENT -->
        <div id="kupci-content" class="container hidden">
            <div class="page-header">
                <div class="page-header-left">
                    <h1>📦 Analiza Kupaca</h1>
                    <p>Detaljni pregled kupaca po sortimentima i mjesečni trend</p>
                </div>
            </div>

            <!-- Top 5 Kupaca po Sortimentima -->
            <div class="section">
                <h2>🏆 Top 5 Kupaca po Sortimentima</h2>
                <p>Najbolji kupci za svaku kategoriju sortimenta</p>

                <div class="analytics-grid">
                    <!-- TRUPCI ČETINARA -->
                    <div class="section">
                        <h3>🌲 TRUPCI ČETINARA</h3>
                        <div id="kupci-trupci-cetinara">
                            <p style="color: #6b7280; text-align: center; padding: 20px;">Učitavanje...</p>
                        </div>
                    </div>

                    <!-- CELULOZA DUGA -->
                    <div class="section">
                        <h3>📏 CELULOZA DUGA</h3>
                        <div id="kupci-celuloza-duga">
                            <p style="color: #6b7280; text-align: center; padding: 20px;">Učitavanje...</p>
                        </div>
                    </div>

                    <!-- CELULOZA CIJEPANA -->
                    <div class="section">
                        <h3>🪓 CELULOZA CIJEPANA</h3>
                        <div id="kupci-celuloza-cijepana">
                            <p style="color: #6b7280; text-align: center; padding: 20px;">Učitavanje...</p>
                        </div>
                    </div>

                    <!-- TRUPCI LIŠĆARA -->
                    <div class="section">
                        <h3>🍂 TRUPCI LIŠĆARA</h3>
                        <div id="kupci-trupci-liscara">
                            <p style="color: #6b7280; text-align: center; padding: 20px;">Učitavanje...</p>
                        </div>
                    </div>

                    <!-- OGRIJEV DUGI -->
                    <div class="section">
                        <h3>🔥 OGRIJEV DUGI</h3>
                        <div id="kupci-ogrijev-dugi">
                            <p style="color: #6b7280; text-align: center; padding: 20px;">Učitavanje...</p>
                        </div>
                    </div>

                    <!-- OGRIJEV CIJEPANI -->
                    <div class="section">
                        <h3>🪵 OGRIJEV CIJEPANI</h3>
                        <div id="kupci-ogrijev-cijepani">
                            <p style="color: #6b7280; text-align: center; padding: 20px;">Učitavanje...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Top 10 Kupaca - Ukupna Otprema -->
            <div class="section">
                <h2>📦 Top 10 Kupaca - Ukupna Otprema</h2>
                <p>Kupci rangirani po ukupnom volumenu otpreme</p>
                <div id="kupci-top-10-list">
                    <p style="color: #6b7280; text-align: center; padding: 20px;">Učitavanje...</p>
                </div>
            </div>

            <!-- Mjesečni Trend Kupaca -->
            <div class="section">
                <h2>📈 Mjesečni Trend Kupaca</h2>
                <p>Koji kupci su bili aktivni po mjesecima</p>
                <div style="overflow-x: auto;">
                    <table class="monthly-table" id="kupci-mjesecni-table">
                        <thead>
                            <tr>
                                <th style="text-align: left;">Kupac</th>
                                <th class="right">Jan</th>
                                <th class="right">Feb</th>
                                <th class="right">Mar</th>
                                <th class="right">Apr</th>
                                <th class="right">Maj</th>
                                <th class="right">Jun</th>
                                <th class="right">Jul</th>
                                <th class="right">Avg</th>
                                <th class="right">Sep</th>
                                <th class="right">Okt</th>
                                <th class="right">Nov</th>
                                <th class="right">Dec</th>
                                <th class="right" style="font-weight: 700;">UKUPNO</th>
                            </tr>
                        </thead>
                        <tbody id="kupci-mjesecni-tbody">
                            <tr><td colspan="14" style="text-align: center; color: #6b7280; padding: 20px;">Učitavanje...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- POSLOVOĐA CONTENT - STANJE ODJELA -->
        <div id="poslovodja-stanje-content" class="container hidden">
            <div class="page-header">
                <div class="page-header-left">
                    <h1>📊 Stanje Odjela</h1>
                    <p>Pregled stanja odjela sa vaših radilišta</p>
                </div>
                <div class="page-header-right">
                    <button class="btn btn-primary" onclick="loadPoslovodjaStanje()">🔄 Osvježi</button>
                </div>
            </div>
            <div id="poslovodja-radilista-info" class="section" style="background: #eff6ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <p style="margin: 0; color: #1e40af; font-weight: 600;">📍 Vaša radilišta: <span id="poslovodja-radilista-list"></span></p>
            </div>
            <div class="section">
                <table class="monthly-table" id="poslovodja-stanje-table">
                    <thead id="poslovodja-stanje-header"></thead>
                    <tbody id="poslovodja-stanje-body"></tbody>
                </table>
            </div>
        </div>

        <!-- POSLOVOĐA CONTENT - ODJELI U REALIZACIJI -->
        <div id="poslovodja-realizacija-content" class="container hidden">
            <div class="page-header">
                <div class="page-header-left">
                    <h1>🏗️ Odjeli u realizaciji</h1>
                    <p>Trenutni odjeli u radilištu koji vodite</p>
                </div>
                <div class="page-header-right">
                    <button class="btn btn-primary" onclick="loadPoslovodjaRealizacija()">🔄 Osvježi</button>
                </div>
            </div>
            <div id="poslovodja-radilista-info-2" class="section" style="background: #eff6ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <p style="margin: 0; color: #1e40af; font-weight: 600;">📍 Vaša radilišta: <span id="poslovodja-radilista-list-2"></span></p>
            </div>
            <div class="section">
                <table class="monthly-table" id="poslovodja-realizacija-table">
                    <thead id="poslovodja-realizacija-header"></thead>
                    <tbody id="poslovodja-realizacija-body"></tbody>
                </table>
            </div>
        </div>

        <!-- POSLOVOĐA CONTENT - ZADNJIH 5 DANA -->
        <div id="poslovodja-zadnjih5-content" class="container hidden">
            <div class="page-header">
                <div class="page-header-left">
                    <h1>📅 Zadnjih 5 Dana</h1>
                    <p>Pregled primke i otpreme sa vaših radilišta</p>
                </div>
                <div class="page-header-right">
                    <button class="btn btn-primary" onclick="loadPoslovodjaZadnjih5()">🔄 Osvježi</button>
                </div>
            </div>
            <div id="poslovodja-radilista-info-3" class="section" style="background: #eff6ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <p style="margin: 0; color: #1e40af; font-weight: 600;">📍 Vaša radilišta: <span id="poslovodja-radilista-list-3"></span></p>
            </div>

            <!-- PRIMKA Zadnjih 5 dana -->
            <div class="section">
                <h2 style="color: #059669; margin-bottom: 15px;">🌲 PRIMKA - Zadnjih 5 Dana</h2>
                <table class="monthly-table" id="poslovodja-primka-table">
                    <thead id="poslovodja-primka-header"></thead>
                    <tbody id="poslovodja-primka-body"></tbody>
                </table>
            </div>

            <!-- OTPREMA Zadnjih 5 dana -->
            <div class="section" style="margin-top: 30px;">
                <h2 style="color: #dc2626; margin-bottom: 15px;">🚛 OTPREMA - Zadnjih 5 Dana</h2>
                <table class="monthly-table" id="poslovodja-otprema-table">
                    <thead id="poslovodja-otprema-header"></thead>
                    <tbody id="poslovodja-otprema-body"></tbody>
                </table>
            </div>
        </div>

        <!-- POSLOVOĐA CONTENT - SUMA MJESECA -->
        <div id="poslovodja-suma-content" class="container hidden">
            <div class="page-header">
                <div class="page-header-left">
                    <h1>📈 Suma Mjeseca</h1>
                    <p>Mjesečne sume za odjele i radilišta</p>
                </div>
                <div class="page-header-right">
                    <button class="btn btn-primary" onclick="loadPoslovodjaSuma()">🔄 Osvježi</button>
                </div>
            </div>
            <div id="poslovodja-radilista-info-4" class="section" style="background: #eff6ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <p style="margin: 0; color: #1e40af; font-weight: 600;">📍 Vaša radilišta: <span id="poslovodja-radilista-list-4"></span></p>
            </div>

            <!-- Suma mjeseca za ODJELE -->
            <div class="section">
                <h2 style="color: #059669; margin-bottom: 15px;">📊 SUMA MJESECA - Po Odjelima</h2>
                <table class="monthly-table" id="poslovodja-suma-odjeli-table">
                    <thead id="poslovodja-suma-odjeli-header"></thead>
                    <tbody id="poslovodja-suma-odjeli-body"></tbody>
                </table>
            </div>

            <!-- Suma mjeseca za RADILIŠTE -->
            <div class="section" style="margin-top: 30px;">
                <h2 style="color: #dc2626; margin-bottom: 15px;">📍 SUMA MJESECA - Po Radilištima</h2>
                <table class="monthly-table" id="poslovodja-suma-radiliste-table">
                    <thead id="poslovodja-suma-radiliste-header"></thead>
                    <tbody id="poslovodja-suma-radiliste-body"></tbody>
                </table>
            </div>
        </div>

        <!-- DINAMIKA CONTENT -->
        <div id="dinamika-content" class="container hidden">
            <div class="page-header">
                <div class="page-header-left">
                    <h1>📊 Godišnja dinamika <span id="dinamika-selected-year">2026</span></h1>
                    <p>Planirana mjesečna dinamika sječe (m³) za tekuću godinu</p>
                </div>
            </div>

            <!-- Forma za unos mjesečne dinamike -->
            <div class="section">
                <h2>Mjesečni plan sječe</h2>
                <form id="dinamika-form" onsubmit="saveDinamika(event)">
                    <div style="overflow-x: auto;">
                        <table class="expert-table" id="dinamika-table">
                            <thead>
                                <tr>
                                    <th style="width: 200px;">Mjesec</th>
                                    <th style="width: 250px;">Planirana količina (m³)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>Januar</strong></td>
                                    <td><input type="number" id="dinamika-01" class="form-control" step="0.01" min="0" placeholder="0.00" style="width: 100%;"></td>
                                </tr>
                                <tr>
                                    <td><strong>Februar</strong></td>
                                    <td><input type="number" id="dinamika-02" class="form-control" step="0.01" min="0" placeholder="0.00" style="width: 100%;"></td>
                                </tr>
                                <tr>
                                    <td><strong>Mart</strong></td>
                                    <td><input type="number" id="dinamika-03" class="form-control" step="0.01" min="0" placeholder="0.00" style="width: 100%;"></td>
                                </tr>
                                <tr>
                                    <td><strong>April</strong></td>
                                    <td><input type="number" id="dinamika-04" class="form-control" step="0.01" min="0" placeholder="0.00" style="width: 100%;"></td>
                                </tr>
                                <tr>
                                    <td><strong>Maj</strong></td>
                                    <td><input type="number" id="dinamika-05" class="form-control" step="0.01" min="0" placeholder="0.00" style="width: 100%;"></td>
                                </tr>
                                <tr>
                                    <td><strong>Juni</strong></td>
                                    <td><input type="number" id="dinamika-06" class="form-control" step="0.01" min="0" placeholder="0.00" style="width: 100%;"></td>
                                </tr>
                                <tr>
                                    <td><strong>Juli</strong></td>
                                    <td><input type="number" id="dinamika-07" class="form-control" step="0.01" min="0" placeholder="0.00" style="width: 100%;"></td>
                                </tr>
                                <tr>
                                    <td><strong>Avgust</strong></td>
                                    <td><input type="number" id="dinamika-08" class="form-control" step="0.01" min="0" placeholder="0.00" style="width: 100%;"></td>
                                </tr>
                                <tr>
                                    <td><strong>Septembar</strong></td>
                                    <td><input type="number" id="dinamika-09" class="form-control" step="0.01" min="0" placeholder="0.00" style="width: 100%;"></td>
                                </tr>
                                <tr>
                                    <td><strong>Oktobar</strong></td>
                                    <td><input type="number" id="dinamika-10" class="form-control" step="0.01" min="0" placeholder="0.00" style="width: 100%;"></td>
                                </tr>
                                <tr>
                                    <td><strong>Novembar</strong></td>
                                    <td><input type="number" id="dinamika-11" class="form-control" step="0.01" min="0" placeholder="0.00" style="width: 100%;"></td>
                                </tr>
                                <tr>
                                    <td><strong>Decembar</strong></td>
                                    <td><input type="number" id="dinamika-12" class="form-control" step="0.01" min="0" placeholder="0.00" style="width: 100%;"></td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr style="background: linear-gradient(135deg, #047857 0%, #065f46 100%); color: white; font-weight: bold; font-size: 16px;">
                                    <td style="text-align: right; padding: 16px;">UKUPNO GODIŠNJE:</td>
                                    <td style="padding: 16px;"><span id="dinamika-total">0.00</span> m³</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    <div style="margin-top: 24px; text-align: right;">
                        <button type="submit" class="btn btn-primary" style="font-size: 16px; padding: 12px 32px;">
                            💾 Spremi dinamiku
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- UPOREDBA GODINA CONTENT -->
        <div id="uporedba-godina-content" class="container hidden">
            <div class="page-header">
                <div class="page-header-left">
                    <h1>📊 Uporedba godina</h1>
                    <p>Side-by-side prikaz sječe i otpreme po godinama</p>
                </div>
            </div>

            <!-- Izbor godina za usporedbu -->
            <div class="section">
                <div class="controls-bar" style="justify-content: center; align-items: center; gap: 24px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <label for="uporedba-year1" style="font-weight: 600; font-size: 16px;">📅 Godina 1:</label>
                        <select id="uporedba-year1" class="year-select" onchange="loadUporedbaGodina()" style="padding: 10px 16px; font-size: 16px; border-radius: 8px; border: 2px solid #047857; min-width: 120px;">
                            
                            
                            <option value="2026" selected>2026</option></select>
                    </div>
                    <span style="font-size: 24px; font-weight: bold;">VS</span>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <label for="uporedba-year2" style="font-weight: 600; font-size: 16px;">📅 Godina 2:</label>
                        <select id="uporedba-year2" class="year-select" onchange="loadUporedbaGodina()" style="padding: 10px 16px; font-size: 16px; border-radius: 8px; border: 2px solid #2563eb; min-width: 120px;">
                            
                            
                            <option value="2026" selected>2026</option></select>
                    </div>
                </div>
            </div>

            <!-- Mjesečna usporedba -->
            <div class="section">
                <h2>📅 Mjesečna usporedba sječe i otpreme</h2>
                <div style="overflow-x: auto;">
                    <table class="expert-table" id="uporedba-mjesecna-table">
                        <thead id="uporedba-mjesecna-header"></thead>
                        <tbody id="uporedba-mjesecna-body"></tbody>
                        <tfoot id="uporedba-mjesecna-footer"></tfoot>
                    </table>
                </div>
            </div>

            <!-- Godišnje ukupno -->
            <div class="section">
                <h2>📊 Godišnje ukupno i razlike</h2>
                <div style="overflow-x: auto;">
                    <table class="expert-table" id="uporedba-ukupno-table">
                        <thead id="uporedba-ukupno-header"></thead>
                        <tbody id="uporedba-ukupno-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- Top 10 odjela -->
            <div class="section">
                <h2>🏆 Top 10 odjela po realizaciji</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                    <div>
                        <h3 id="uporedba-top10-year1-title" style="text-align: center; margin-bottom: 16px;">Godina 2025</h3>
                        <div style="overflow-x: auto;">
                            <table class="expert-table" id="uporedba-top10-year1-table">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Odjel</th>
                                        <th style="text-align: right;">Sječa (m³)</th>
                                    </tr>
                                </thead>
                                <tbody id="uporedba-top10-year1-body"></tbody>
                            </table>
                        </div>
                    </div>
                    <div>
                        <h3 id="uporedba-top10-year2-title" style="text-align: center; margin-bottom: 16px;">Godina 2026</h3>
                        <div style="overflow-x: auto;">
                            <table class="expert-table" id="uporedba-top10-year2-table">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Odjel</th>
                                        <th style="text-align: right;">Sječa (m³)</th>
                                    </tr>
                                </thead>
                                <tbody id="uporedba-top10-year2-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ADMIN IZVJEŠTAJI CONTENT - Kartice sa linkovima -->
        <div id="izvjestaji-admin-content" class="container hidden">
            <div class="page-header">
                <div class="page-header-left">
                    <h1>📋 Izvještaji</h1>
                    <p>Odaberite tip izvještaja</p>
                </div>
            </div>

            <!-- Kartice sa opcijama izvještaja -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px; margin-top: 30px;">

                <!-- Dinamika -->
                <div class="card" onclick="switchTab('dinamika')" style="cursor: pointer; transition: transform 0.2s; hover: transform: translateY(-4px);">
                    <div style="padding: 24px;">
                        <h2 style="margin: 0 0 12px 0; font-size: 24px;">📊 Dinamika</h2>
                        <p style="color: #6b7280; margin: 0;">Planirana mjesečna dinamika sječe (m³) za tekuću godinu</p>
                    </div>
                </div>

                <!-- Uporedba godina -->
                <div class="card" onclick="switchTab('uporedba-godina')" style="cursor: pointer; transition: transform 0.2s;">
                    <div style="padding: 24px;">
                        <h2 style="margin: 0 0 12px 0; font-size: 24px;">📊 Uporedba godina</h2>
                        <p style="color: #6b7280; margin: 0;">Side-by-side prikaz sječe i otpreme po godinama</p>
                    </div>
                </div>

                <!-- Mjesečni izvještaj po odjelima -->
                <div class="card" onclick="switchTab('izvjestaji')" style="cursor: pointer; transition: transform 0.2s;">
                    <div style="padding: 24px;">
                        <h2 style="margin: 0 0 12px 0; font-size: 24px;">📅 Mjesečni izvještaj</h2>
                        <p style="color: #6b7280; margin: 0;">Detaljan prikaz sječe i otpreme po odjelima</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- PRIMAC IZVJEŠTAJI CONTENT -->
        <div id="izvjestaji-primac-content" class="container hidden">
            <div class="page-header">
                <div class="page-header-left">
                    <h1>📋 Izvještaji sječe</h1>
                    <p>Sedmični i mjesečni prikazi</p>
                </div>
            </div>

            <!-- SUB-MENU TABS -->
            <div class="sub-tabs" style="margin-bottom: 30px;">
                <button class="sub-tab active" onclick="switchPrimacIzvjestajiSubTab('sedmicni')">📊 Sedmični izvještaj</button>
                <button class="sub-tab" onclick="switchPrimacIzvjestajiSubTab('mjesecni')">📅 Mjesečni izvještaj</button>
            </div>

            <!-- SEDMIČNI IZVJEŠTAJ -->
            <div id="primac-sedmicni-izvjestaj" class="sub-content">
                <div class="page-header" style="margin-top: 0;">
                    <div class="page-header-left">
                        <h2>📊 Sedmični izvještaj sječe</h2>
                        <p>Suma sječe po sortimentima za radnu sedmicu</p>
                    </div>
                    <div class="page-header-right">
                        <select id="primac-sedmicni-year" class="year-select" onchange="loadPrimacSedmicni()">
                            <option value="2026" selected>2026</option></select>
                        <select id="primac-sedmicni-month" class="month-select" onchange="loadPrimacSedmicni()">
                            <option value="0">Januar</option>
                            <option value="1">Februar</option>
                            <option value="2">Mart</option>
                            <option value="3">April</option>
                            <option value="4">Maj</option>
                            <option value="5">Juni</option>
                            <option value="6">Juli</option>
                            <option value="7">August</option>
                            <option value="8">Septembar</option>
                            <option value="9">Oktobar</option>
                            <option value="10">Novembar</option>
                            <option value="11">Decembar</option>
                        </select>
                    </div>
                </div>

                <div class="section">
                    <div style="overflow-x: auto;">
                        <table class="expert-table" id="primac-sedmicni-table">
                            <thead id="primac-sedmicni-header"></thead>
                            <tbody id="primac-sedmicni-body"></tbody>
                            <tfoot id="primac-sedmicni-footer"></tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <!-- MJESEČNI IZVJEŠTAJ -->
            <div id="primac-mjesecni-izvjestaj" class="sub-content hidden">
                <div class="page-header" style="margin-top: 0;">
                    <div class="page-header-left">
                        <h2>📅 Mjesečni izvještaj sječe</h2>
                        <p>Suma sječe po sortimentima za mjesec</p>
                    </div>
                    <div class="page-header-right">
                        <select id="primac-mjesecni-year" class="year-select" onchange="loadPrimacMjesecni()">
                            <option value="2026" selected>2026</option></select>
                        <select id="primac-mjesecni-month" class="month-select" onchange="loadPrimacMjesecni()">
                            <option value="0">Januar</option>
                            <option value="1">Februar</option>
                            <option value="2">Mart</option>
                            <option value="3">April</option>
                            <option value="4">Maj</option>
                            <option value="5">Juni</option>
                            <option value="6">Juli</option>
                            <option value="7">August</option>
                            <option value="8">Septembar</option>
                            <option value="9">Oktobar</option>
                            <option value="10">Novembar</option>
                            <option value="11">Decembar</option>
                        </select>
                    </div>
                </div>

                <div class="section">
                    <div style="overflow-x: auto;">
                        <table class="expert-table" id="primac-mjesecni-table">
                            <thead id="primac-mjesecni-header"></thead>
                            <tbody id="primac-mjesecni-body"></tbody>
                            <tfoot id="primac-mjesecni-footer"></tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- OTPREMAC IZVJEŠTAJI CONTENT -->
        <div id="izvjestaji-otpremac-content" class="container hidden">
            <div class="page-header">
                <div class="page-header-left">
                    <h1>📋 Izvještaji otpreme</h1>
                    <p>Sedmični i mjesečni prikazi</p>
                </div>
            </div>

            <!-- SUB-MENU TABS -->
            <div class="sub-tabs" style="margin-bottom: 30px;">
                <button class="sub-tab active" onclick="switchOtpremacIzvjestajiSubTab('sedmicni')">📊 Sedmični izvještaj</button>
                <button class="sub-tab" onclick="switchOtpremacIzvjestajiSubTab('mjesecni')">📅 Mjesečni izvještaj</button>
            </div>

            <!-- SEDMIČNI IZVJEŠTAJ -->
            <div id="otpremac-sedmicni-izvjestaj" class="sub-content">
                <div class="page-header" style="margin-top: 0;">
                    <div class="page-header-left">
                        <h2>📊 Sedmični izvještaj otpreme</h2>
                        <p>Suma otpreme po sortimentima za radnu sedmicu</p>
                    </div>
                    <div class="page-header-right">
                        <select id="otpremac-sedmicni-year" class="year-select" onchange="loadOtpremacSedmicni()">
                            <option value="2026" selected>2026</option></select>
                        <select id="otpremac-sedmicni-month" class="month-select" onchange="loadOtpremacSedmicni()">
                            <option value="0">Januar</option>
                            <option value="1">Februar</option>
                            <option value="2">Mart</option>
                            <option value="3">April</option>
                            <option value="4">Maj</option>
                            <option value="5">Juni</option>
                            <option value="6">Juli</option>
                            <option value="7">August</option>
                            <option value="8">Septembar</option>
                            <option value="9">Oktobar</option>
                            <option value="10">Novembar</option>
                            <option value="11">Decembar</option>
                        </select>
                    </div>
                </div>

                <div class="section">
                    <div style="overflow-x: auto;">
                        <table class="expert-table" id="otpremac-sedmicni-table">
                            <thead id="otpremac-sedmicni-header"></thead>
                            <tbody id="otpremac-sedmicni-body"></tbody>
                            <tfoot id="otpremac-sedmicni-footer"></tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <!-- MJESEČNI IZVJEŠTAJ -->
            <div id="otpremac-mjesecni-izvjestaj" class="sub-content hidden">
                <div class="page-header" style="margin-top: 0;">
                    <div class="page-header-left">
                        <h2>📅 Mjesečni izvještaj otpreme</h2>
                        <p>Suma otpreme po sortimentima za mjesec</p>
                    </div>
                    <div class="page-header-right">
                        <select id="otpremac-mjesecni-year" class="year-select" onchange="loadOtpremacMjesecni()">
                            <option value="2026" selected>2026</option></select>
                        <select id="otpremac-mjesecni-month" class="month-select" onchange="loadOtpremacMjesecni()">
                            <option value="0">Januar</option>
                            <option value="1">Februar</option>
                            <option value="2">Mart</option>
                            <option value="3">April</option>
                            <option value="4">Maj</option>
                            <option value="5">Juni</option>
                            <option value="6">Juli</option>
                            <option value="7">August</option>
                            <option value="8">Septembar</option>
                            <option value="9">Oktobar</option>
                            <option value="10">Novembar</option>
                            <option value="11">Decembar</option>
                        </select>
                    </div>
                </div>

                <div class="section">
                    <div style="overflow-x: auto;">
                        <table class="expert-table" id="otpremac-mjesecni-table">
                            <thead id="otpremac-mjesecni-header"></thead>
                            <tbody id="otpremac-mjesecni-body"></tbody>
                            <tfoot id="otpremac-mjesecni-footer"></tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- IZVJEŠTAJI CONTENT -->
        <div id="izvjestaji-content" class="container hidden">
            <div class="page-header">
                <div class="page-header-left">
                    <h1>📋 Izvještaji</h1>
                    <p>Detaljan prikaz sječe i otpreme po odjelima</p>
                </div>
            </div>

            <!-- SUB-MENU TABS -->
            <div class="sub-tabs" style="margin-bottom: 30px;">
                <button class="sub-tab active" onclick="switchIzvjestajiSubTab('mjesecni')">📅 Mjesečni izvještaj</button>
                <button class="sub-tab" onclick="switchIzvjestajiSubTab('sedmicni-sjeca')">📊 Sedmični izvještaj sječe</button>
                <button class="sub-tab" onclick="switchIzvjestajiSubTab('sedmicni-otprema')">📊 Sedmični izvještaj otpreme</button>
                <button class="sub-tab" onclick="switchIzvjestajiSubTab('stanje-odjela')">📦 Stanje odjela</button>
            </div>

            <!-- MJESEČNI IZVJEŠTAJ -->
            <div id="mjesecni-izvjestaj" class="sub-content">
                <div class="page-header" style="margin-top: 0;">
                    <div class="page-header-left">
                        <h2>📅 Mjesečni izvještaj</h2>
                    </div>
                    <div class="page-header-right">
                        <select id="izvjestaji-year-select" class="year-select" onchange="loadIzvjestaji()">
                            <option value="2026" selected>2026</option></select>
                        <select id="izvjestaji-month-select" class="month-select" onchange="loadIzvjestaji()">
                            <option value="0">Januar</option>
                            <option value="1">Februar</option>
                            <option value="2">Mart</option>
                            <option value="3">April</option>
                            <option value="4">Maj</option>
                            <option value="5">Juni</option>
                            <option value="6">Juli</option>
                            <option value="7">August</option>
                            <option value="8">Septembar</option>
                            <option value="9">Oktobar</option>
                            <option value="10">Novembar</option>
                            <option value="11">Decembar</option>
                        </select>
                    </div>
                </div>

                <!-- SJEČA (PRIMKA) PO ODJELIMA -->
                <div class="section">
                    <h2>🌲 Sječa po odjelima - <span id="izvjestaji-primka-title"></span></h2>
                    <p style="color: #6b7280; margin-bottom: 20px;">Spisak odjela sa sortimentnim prikazom</p>
                    <div class="controls-bar">
                        <input type="text" class="search-input" id="izvjestaji-primka-search" placeholder="🔍 Pretraži po odjelu..." onkeyup="filterIzvjestajiPrimkaTable()">
                        <button class="btn btn-primary" onclick="exportTableToCSV('izvjestaji-primka')">📥 Export CSV</button>
                    </div>
                    <div style="overflow-x: auto;">
                        <table id="izvjestaji-primka-table">
                            <thead id="izvjestaji-primka-header"></thead>
                            <tbody id="izvjestaji-primka-body"></tbody>
                        </table>
                    </div>
                </div>

                <!-- OTPREMA PO ODJELIMA -->
                <div class="section">
                    <h2>🚛 Otprema po odjelima - <span id="izvjestaji-otprema-title"></span></h2>
                    <p style="color: #6b7280; margin-bottom: 20px;">Spisak odjela sa sortimentnim prikazom</p>
                    <div class="controls-bar">
                        <input type="text" class="search-input" id="izvjestaji-otprema-search" placeholder="🔍 Pretraži po odjelu..." onkeyup="filterIzvjestajiOtpremaTable()">
                        <button class="btn btn-primary" onclick="exportTableToCSV('izvjestaji-otprema')">📥 Export CSV</button>
                    </div>
                    <div style="overflow-x: auto;">
                        <table id="izvjestaji-otprema-table">
                            <thead id="izvjestaji-otprema-header"></thead>
                            <tbody id="izvjestaji-otprema-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- SEDMIČNI IZVJEŠTAJ SJEČE -->
            <div id="sedmicni-sjeca-izvjestaj" class="sub-content hidden">
                <div class="page-header" style="margin-top: 0;">
                    <div class="page-header-left">
                        <h2>📊 Sedmični izvještaj sječe</h2>
                        <p style="color: #6b7280;">Sve sedmice u mjesecu - od najnovije ka najstarijoj</p>
                    </div>
                    <div class="page-header-right">
                        <select id="sedmicni-sjeca-year-select" class="year-select" onchange="loadSedmicniIzvjestajSjeca()">
                            <option value="2026" selected>2026</option></select>
                        <select id="sedmicni-sjeca-month-select" class="month-select" onchange="loadSedmicniIzvjestajSjeca()">
                            <option value="0">Januar</option>
                            <option value="1">Februar</option>
                            <option value="2">Mart</option>
                            <option value="3">April</option>
                            <option value="4">Maj</option>
                            <option value="5">Juni</option>
                            <option value="6">Juli</option>
                            <option value="7">August</option>
                            <option value="8">Septembar</option>
                            <option value="9">Oktobar</option>
                            <option value="10">Novembar</option>
                            <option value="11">Decembar</option>
                        </select>
                    </div>
                </div>

                <div id="sedmicni-sjeca-container"></div>
            </div>

            <!-- SEDMIČNI IZVJEŠTAJ OTPREME -->
            <div id="sedmicni-otprema-izvjestaj" class="sub-content hidden">
                <div class="page-header" style="margin-top: 0;">
                    <div class="page-header-left">
                        <h2>📊 Sedmični izvještaj otpreme</h2>
                        <p style="color: #6b7280;">Sve sedmice u mjesecu - od najnovije ka najstarijoj</p>
                    </div>
                    <div class="page-header-right">
                        <select id="sedmicni-otprema-year-select" class="year-select" onchange="loadSedmicniIzvjestajOtprema()">
                            <option value="2026" selected>2026</option></select>
                        <select id="sedmicni-otprema-month-select" class="month-select" onchange="loadSedmicniIzvjestajOtprema()">
                            <option value="0">Januar</option>
                            <option value="1">Februar</option>
                            <option value="2">Mart</option>
                            <option value="3">April</option>
                            <option value="4">Maj</option>
                            <option value="5">Juni</option>
                            <option value="6">Juli</option>
                            <option value="7">August</option>
                            <option value="8">Septembar</option>
                            <option value="9">Oktobar</option>
                            <option value="10">Novembar</option>
                            <option value="11">Decembar</option>
                        </select>
                    </div>
                </div>

                <div id="sedmicni-otprema-container"></div>
            </div>

            <!-- STANJE ODJELA -->
            <div id="stanje-odjela-izvjestaj" class="sub-content hidden">
                <div class="page-header" style="margin-top: 0;">
                    <div class="page-header-left">
                        <h2>📦 Stanje odjela</h2>
                        <p style="color: #6b7280;">Trenutno stanje radilišta - sortirano po najsvježijim unosima sječe</p>
                    </div>
                    <div class="page-header-right">
                        <select id="stanje-odjela-select" class="year-select" style="min-width: 250px; margin-right: 12px;" onchange="filterStanjeOdjela()">
                            <option value="">Sva radilišta</option>
                        </select>
                        <button class="btn btn-primary" onclick="loadStanjeOdjela()">🔄 Osvježi</button>
                    </div>
                </div>

                <!-- Container za sve odjele -->
                <div id="stanje-odjela-container"></div>
            </div>
        </div>

        <!-- DODANI UNOSI VIEW (For Rukovodilac/Admin) -->
        <div id="pending-unosi-content" class="container hidden">
            <div class="section">
                <h2>📋 Dodani Unosi - Pregled</h2>
                <p style="color: #6b7280; margin-bottom: 20px;">Unosi koje su radnici poslali na pregled</p>

                <!-- Filter Bar -->
                <div class="filter-bar">
                    <div class="filter-bar-title">🔍 Filteri</div>
                    <div class="filter-grid">
                        <div class="filter-group">
                            <label class="filter-label">Datum od:</label>
                            <input type="date" class="filter-input" id="filter-datum-od">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Datum do:</label>
                            <input type="date" class="filter-input" id="filter-datum-do">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Tip:</label>
                            <select class="filter-select" id="filter-tip">
                                <option value="">Sve</option>
                                <option value="SJEČA">Sječa</option>
                                <option value="OTPREMA">Otprema</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Pretraga:</label>
                            <input type="text" class="filter-input" id="filter-search" placeholder="Odjel, radnik, kupac...">
                        </div>
                        <div class="filter-actions">
                            <button class="btn btn-primary" onclick="applyFilters()">Filtriraj</button>
                            <button class="btn btn-clear" onclick="clearFilters()">Očisti</button>
                        </div>
                    </div>
                </div>

                <div id="pending-unosi-container"></div>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div class="modal-overlay" id="confirm-modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="modal-title">Potvrda brisanja</div>
            </div>
            <div class="modal-body" id="modal-body">
                Da li ste sigurni da želite obrisati ovaj unos?
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeConfirmModal()">Otkaži</button>
                <button class="btn btn-danger" id="modal-confirm-btn">Obriši</button>
            </div>
        </div>
    </div>

    <script>
        // VERSION INFO - Dodato 2025 godina u preglede
        const APP_VERSION = '2026-01-05-v11-YEAR-2025-2026';
        const BUILD_COMMIT = 'pending';

        // SUPER VISIBLE VERSION CHECK
        console.clear();
        console.log('%c═══════════════════════════════════════════════', 'color: #059669; font-weight: bold;');
        console.log(`%c🌲 ŠUMARIJA v${APP_VERSION}`, 'background: #059669; color: white; padding: 12px 20px; border-radius: 8px; font-weight: bold; font-size: 18px;');
        console.log(`%cBuild: ${BUILD_COMMIT}`, 'color: #6b7280; font-size: 12px;');
        console.log('%c═══════════════════════════════════════════════', 'color: #059669; font-weight: bold;');
        console.log('%c✅ NAJNOVIJA VERZIJA SA POPRAVKAMA UČITANA!', 'background: #10b981; color: white; padding: 8px 12px; font-weight: bold; font-size: 14px;');
        console.log('%c🔥 AKO VIDIŠ OVO = TIMEOUT FIX JE AKTIVAN!', 'background: #ef4444; color: white; padding: 8px 12px; font-weight: bold; font-size: 14px;');
        console.log('%cAko vidiš ovu poruku, data.filter greška je popravljena!', 'color: #059669; font-weight: bold;');
        console.log('%c═══════════════════════════════════════════════', 'color: #059669; font-weight: bold;');

        const API_URL = 'https://script.google.com/macros/s/AKfycbwkJ4apCi1yf9WNMVboGUtLVK6ZRWzLAAN-CkyfGbUqCyGm4qMjH3-zVifJUUCgUW2t/exec';

        // ========== SORTIMENTI ORDER - BUSINESS LOGIC ==========
        // Fixed order for sortimenti as per business requirements
        const SORTIMENTI_ORDER = [
            "F/L Č", "I Č", "II Č", "III Č", "RUDNO", "TRUPCI Č",
            "CEL.DUGA", "CEL.CIJEPANA", "ČETINARI",
            "F/L L", "I L", "II L", "III L", "TRUPCI",
            "OGR.DUGI", "OGR.CIJEPANI", "LIŠĆARI", "SVEUKUPNO"
        ];

        // ========== PERFORMANCE CONFIGURATION ==========
        const MAX_TABLE_ROWS = 50; // Limit initial table rows for performance
        const LAZY_LOAD_BATCH = 25; // Load additional rows in batches

        // ========== PERFORMANCE OPTIMIZATIONS ==========

        // Batch DOM updates using DocumentFragment
        function batchRender(container, htmlArray) {
            const fragment = document.createDocumentFragment();
            const temp = document.createElement('div');
            temp.innerHTML = htmlArray.join('');
            while (temp.firstChild) {
                fragment.appendChild(temp.firstChild);
            }
            container.appendChild(fragment);
        }

        // Debounce function to limit function calls
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Throttle function for scroll events
        function throttle(func, limit) {
            let inThrottle;
            return function(...args) {
                if (!inThrottle) {
                    func.apply(this, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            };
        }

        // RequestAnimationFrame wrapper for smooth rendering
        function smoothRender(callback) {
            requestAnimationFrame(() => {
                requestAnimationFrame(callback);
            });
        }

        // Lazy load large tables with pagination
        function paginateTable(data, pageSize = 100) {
            const pages = [];
            for (let i = 0; i < data.length; i += pageSize) {
                pages.push(data.slice(i, i + pageSize));
            }
            return pages;
        }

        // Virtual scrolling for large datasets
        let virtualScrollCache = {};
        function enableVirtualScroll(tableId, data, renderRow) {
            const table = document.getElementById(tableId);
            if (!table) return;

            const tbody = table.querySelector('tbody');
            const rowHeight = 40; // Estimated row height
            const viewportHeight = window.innerHeight;
            const visibleRows = Math.ceil(viewportHeight / rowHeight) + 5; // Buffer

            let scrollTop = 0;

            const renderVisible = throttle(() => {
                const startIndex = Math.floor(scrollTop / rowHeight);
                const endIndex = Math.min(startIndex + visibleRows, data.length);

                const visibleData = data.slice(startIndex, endIndex);
                const html = visibleData.map((item, idx) => renderRow(item, startIndex + idx)).join('');

                tbody.innerHTML = html;
                tbody.style.paddingTop = `${startIndex * rowHeight}px`;
                tbody.style.paddingBottom = `${(data.length - endIndex) * rowHeight}px`;
            }, 100);

            window.addEventListener('scroll', () => {
                scrollTop = window.pageYOffset;
                renderVisible();
            });

            renderVisible();
        }

        // Cache DOM elements to avoid repeated queries
        const domCache = {};
        function getCachedElement(id) {
            if (!domCache[id]) {
                domCache[id] = document.getElementById(id);
            }
            return domCache[id];
        }

        // Optimize innerHTML by using textContent where possible
        function safeSetText(element, text) {
            if (element.textContent !== text) {
                element.textContent = text;
            }
        }

        // ========== TOAST NOTIFICATIONS ==========

        function showToast(type, title, message, duration = 4000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const icons = {
                success: '✓',
                error: '✕',
                info: 'ℹ',
                warning: '⚠'
            };

            toast.innerHTML = `
                <div class="toast-icon">${icons[type] || 'ℹ'}</div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    ${message ? `<div class="toast-message">${message}</div>` : ''}
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">×</button>
            `;

            container.appendChild(toast);

            // Trigger animation
            setTimeout(() => toast.classList.add('show'), 10);

            // Auto remove after duration
            if (duration > 0) {
                setTimeout(() => {
                    toast.classList.remove('show');
                    toast.classList.add('hide');
                    setTimeout(() => toast.remove(), 300);
                }, duration);
            }

            return toast;
        }

        // Convenience functions
        function showSuccess(title, message, duration) {
            return showToast('success', title, message, duration);
        }

        function showError(title, message, duration) {
            return showToast('error', title, message, duration);
        }

        function showInfo(title, message, duration) {
            return showToast('info', title, message, duration);
        }

        function showWarning(title, message, duration) {
            return showToast('warning', title, message, duration);
        }

        // ========== CACHING & OFFLINE SUPPORT ==========

        // Register Service Worker for offline support
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js')
                .then(registration => {
                    console.log('Service Worker registered:', registration);
                })
                .catch(error => {
                    console.error('Service Worker registration failed:', error);
                });
        }

        // Smart cache TTL - optimized for data entry patterns
        // Unosi se dodaju radnim danima ujutro do 8h
        function getSmartCacheTTL() {
            const now = new Date();
            const currentHour = now.getHours();
            const currentMinutes = now.getMinutes();

            // Prije 8:00 - unosi se još dodaju, kraći cache
            if (currentHour < 8) {
                console.log('⏰ Prije 8h - cache 30 minuta (unosi se dodaju)');
                return 30 * 60 * 1000; // 30 minuta
            }

            // Poslije 8:00 - podaci stabilni do kraja dana
            // Cache do 18:00 ili maksimalno 10 sati
            const endOfWorkDay = new Date(now);
            endOfWorkDay.setHours(18, 0, 0, 0); // 18:00

            const timeUntilEndOfDay = endOfWorkDay.getTime() - now.getTime();
            const tenHours = 10 * 60 * 60 * 1000;

            // Ako je već poslije 18h, cache do kraja dana (midnight)
            if (currentHour >= 18) {
                console.log('⏰ Poslije 18h - cache 4 sata');
                return 4 * 60 * 60 * 1000; // 4 sata
            }

            // Inače, cache do kraja radnog dana ili max 10h
            const cacheDuration = Math.min(timeUntilEndOfDay, tenHours);
            const hoursRemaining = Math.round(cacheDuration / (60 * 60 * 1000) * 10) / 10;
            console.log(`⏰ Poslije 8h - cache ${hoursRemaining}h (podaci stabilni)`);

            return cacheDuration;
        }

        // Cache configuration - different TTLs for different endpoints
        const CACHE_CONFIG = {
            'dashboard': 5 * 60 * 1000,        // 5 minutes
            'primaci': 10 * 60 * 1000,         // 10 minutes
            'otpremaci': 10 * 60 * 1000,       // 10 minutes
            'kupci': 10 * 60 * 1000,           // 10 minutes
            'odjeli': 15 * 60 * 1000,          // 15 minutes
            'primac-detail': 5 * 60 * 1000,    // 5 minutes
            'otpremac-detail': 5 * 60 * 1000,  // 5 minutes
            'primac-odjeli': 10 * 60 * 1000,   // 10 minutes
            'otpremac-odjeli': 10 * 60 * 1000, // 10 minutes
            'default': 5 * 60 * 1000           // 5 minutes default
        };

        // Fetch with cache - cache-first strategy
        async function fetchWithCache(url, cacheKey, forceRefresh = false, timeout = 8000) {
            // DEBUG: Confirm timeout parameter exists
            if (typeof timeout === 'undefined') {
                console.error('🔴 CRITICAL: timeout is undefined in fetchWithCache!');
                timeout = 8000; // Fallback
            }

            // Use smart cache TTL optimized for data entry patterns
            const path = new URL(url).searchParams.get('path');
            const cacheTTL = getSmartCacheTTL();

            // If force refresh, clear cache for this key
            if (forceRefresh) {
                localStorage.removeItem(cacheKey);
                console.log(`🔄 Force refresh: cleared cache for ${cacheKey}`);
            }

            // Check cache first
            const cached = localStorage.getItem(cacheKey);
            if (cached) {
                try {
                    const cachedData = JSON.parse(cached);
                    const now = Date.now();
                    const age = now - cachedData.timestamp;

                    // If cache is fresh, return it immediately
                    if (age < cacheTTL) {
                        console.log(`✓ Cache hit (${path}): ${Math.round(age / 1000)}s old`);
                        showCacheIndicator(age);
                        return cachedData.data;
                    } else {
                        console.log(`⚠ Cache stale (${path}): ${Math.round(age / 1000)}s old, fetching fresh...`);
                    }
                } catch (e) {
                    console.error('Cache parse error:', e);
                }
            }

            // Cache miss or stale - fetch from network with timeout
            try {
                console.log(`↻ Fetching fresh data (${path})...`);

                // Fetch with configurable timeout (default 8s, but can be higher for heavy endpoints)
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), timeout);

                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                const data = await response.json();

                // Store in cache
                localStorage.setItem(cacheKey, JSON.stringify({
                    data: data,
                    timestamp: Date.now()
                }));

                console.log(`✓ Fresh data cached (${path})`);
                hideCacheIndicator();
                return data;

            } catch (error) {
                // Handle timeout specifically
                if (error.name === 'AbortError') {
                    console.error(`Request timeout (${timeout/1000}s) - server too slow:`, path);
                } else {
                    console.error('Network error:', error);
                }

                // If network fails and we have stale cache, use it
                if (cached) {
                    try {
                        const cachedData = JSON.parse(cached);
                        const age = Date.now() - cachedData.timestamp;
                        console.log(`⚠ Network failed, using stale cache (${Math.round(age / 60000)} min old)`);
                        showCacheIndicator(age, true);
                        return cachedData.data;
                    } catch (e) {
                        console.error('Stale cache parse error:', e);
                    }
                }

                // If timeout, show user-friendly message
                if (error.name === 'AbortError') {
                    throw new Error('Server je spor, molimo pokušajte ponovo ili koristite keširane podatke.');
                }

                throw error;
            }
        }

        // Show cache indicator
        function showCacheIndicator(age, isStale = false) {
            const indicator = document.getElementById('cache-indicator');
            if (!indicator) return;

            const minutes = Math.round(age / 60000);
            const seconds = Math.round(age / 1000);
            const hours = Math.round(age / 3600000);

            if (isStale) {
                indicator.innerHTML = `⚠️ Keš ${minutes}m`;
                indicator.style.background = '#fef3c7';
                indicator.style.color = '#92400e';
            } else {
                // Show time in most appropriate unit
                let timeStr;
                if (hours > 0) {
                    timeStr = `${hours}h`;
                } else if (minutes > 0) {
                    timeStr = `${minutes}m`;
                } else {
                    timeStr = `${seconds}s`;
                }

                indicator.innerHTML = `⚡ ${timeStr}`;
                indicator.style.background = '#d1fae5';
                indicator.style.color = '#047857';
            }
            indicator.classList.remove('hidden');
        }

        // Hide cache indicator
        function hideCacheIndicator() {
            const indicator = document.getElementById('cache-indicator');
            if (indicator) {
                indicator.classList.add('hidden');
            }
        }

        // Clear cache by pattern
        function clearCacheByPattern(pattern) {
            const keys = Object.keys(localStorage);
            const matchingKeys = keys.filter(k => k.includes(pattern));
            matchingKeys.forEach(k => localStorage.removeItem(k));
            console.log(`🗑️  Cleared ${matchingKeys.length} cache entries matching '${pattern}'`);
            return matchingKeys.length;
        }

        // Clear all cache
        function clearAllCache() {
            const keys = Object.keys(localStorage);
            const cacheKeys = keys.filter(k => k.startsWith('cache_'));
            cacheKeys.forEach(k => localStorage.removeItem(k));
            console.log(`Cleared ${cacheKeys.length} cache entries`);

            // Clear Service Worker cache
            if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                navigator.serviceWorker.controller.postMessage({ type: 'CLEAR_CACHE' });
            }

            toggleUserMenu(); // Close menu
            showInfo('Keš obrisan', 'Stranica će se osvježiti.');
            window.location.reload();
        }

        // Preload all views function
        async function preloadAllViews() {
            showInfo('⚡ Učitavanje...', 'Učitavam sve prikaze u pozadini. Ovo može potrajati.');

            const year = new Date().getFullYear();
            let totalLoaded = 0;
            let totalFailed = 0;

            try {
                // Determine user type (case-insensitive)
                const userType = (currentUser.type || '').toLowerCase();

                console.log(`User type detected: ${userType}`);

                if (userType === 'admin') {
                    // Admin views to preload
                    const views = [
                        { name: 'Dashboard', url: `${API_URL}?path=dashboard&year=${year}&username=${currentUser.username}&password=${currentPassword}`, cacheKey: 'cache_dashboard_' + year },
                        { name: 'Primaci', url: `${API_URL}?path=primaci&year=${year}&username=${currentUser.username}&password=${currentPassword}`, cacheKey: 'cache_primaci_' + year },
                        { name: 'Otpremaci', url: `${API_URL}?path=otpremaci&year=${year}&username=${currentUser.username}&password=${currentPassword}`, cacheKey: 'cache_otpremaci_' + year },
                        { name: 'Kupci', url: `${API_URL}?path=kupci&year=${year}&username=${currentUser.username}&password=${currentPassword}`, cacheKey: 'cache_kupci_' + year },
                        { name: 'Odjeli', url: `${API_URL}?path=odjeli&year=${year}&username=${currentUser.username}&password=${currentPassword}`, cacheKey: 'cache_odjeli_' + year },
                        { name: 'Stanje Odjela', url: `${API_URL}?path=stanje_odjela&year=${year}&username=${currentUser.username}&password=${currentPassword}`, cacheKey: 'cache_stanje_odjela_' + year },
                        { name: 'Pending Unosi', url: `${API_URL}?path=pending_unosi&username=${currentUser.username}&password=${currentPassword}`, cacheKey: 'cache_pending_unosi' },
                        { name: 'Mjesečni Sortimenti', url: `${API_URL}?path=mjesecni_sortimenti&year=${year}&username=${currentUser.username}&password=${currentPassword}`, cacheKey: 'cache_mjesecni_sortimenti_' + year },
                        { name: 'Dinamika', url: `${API_URL}?path=get_dinamika&year=${year}&username=${currentUser.username}&password=${currentPassword}`, cacheKey: 'cache_dinamika_' + year }
                    ];

                    console.log(`Preloading ${views.length} admin views...`);

                    for (const view of views) {
                        try {
                            console.log(`Loading ${view.name}...`);
                            // Use 30s timeout for heavy endpoints (dashboard, odjeli), 8s for others
                            const timeout = (view.name === 'Dashboard' || view.name === 'Odjeli') ? 30000 : 8000;
                            await fetchWithCache(view.url, view.cacheKey, false, timeout);
                            totalLoaded++;
                            console.log(`✓ ${view.name} loaded`);
                        } catch (error) {
                            totalFailed++;
                            console.error(`✗ ${view.name} failed:`, error);
                        }
                    }

                } else if (userType === 'poslovođa' || userType === 'poslovodja') {
                    // Poslovodja views to preload
                    const views = [
                        { name: 'Stanje Odjela', url: `${API_URL}?path=odjeli&year=${year}&username=${currentUser.username}&password=${currentPassword}`, cacheKey: 'cache_poslovodja_odjeli_' + year },
                        { name: 'Odjeli u realizaciji', url: `${API_URL}?path=odjeli&year=${year}&username=${currentUser.username}&password=${currentPassword}`, cacheKey: 'cache_poslovodja_realizacija_' + year },
                        { name: 'Zadnjih 5 dana - Primke', url: `${API_URL}?path=primke&username=${currentUser.username}&password=${currentPassword}`, cacheKey: 'cache_poslovodja_primke' },
                        { name: 'Zadnjih 5 dana - Otpreme', url: `${API_URL}?path=otpreme&username=${currentUser.username}&password=${currentPassword}`, cacheKey: 'cache_poslovodja_otpreme' },
                        { name: 'Suma mjeseca', url: `${API_URL}?path=primke&username=${currentUser.username}&password=${currentPassword}`, cacheKey: 'cache_poslovodja_suma_primke' }
                    ];

                    console.log(`Preloading ${views.length} poslovodja views...`);

                    for (const view of views) {
                        try {
                            console.log(`Loading ${view.name}...`);
                            await fetchWithCache(view.url, view.cacheKey);
                            totalLoaded++;
                            console.log(`✓ ${view.name} loaded`);
                        } catch (error) {
                            totalFailed++;
                            console.error(`✗ ${view.name} failed:`, error);
                        }
                    }

                } else if (userType === 'primac' || userType === 'otpremac') {
                    // Worker views to preload
                    const path = userType === 'primac' ? 'primke' : 'otpreme';
                    const views = [
                        { name: 'Moje unose', url: `${API_URL}?path=${path}&username=${currentUser.username}&password=${currentPassword}`, cacheKey: `cache_my_${path}` },
                        { name: 'Godišnji prikaz', url: `${API_URL}?path=${path}&username=${currentUser.username}&password=${currentPassword}`, cacheKey: `cache_godisnji_${path}` }
                    ];

                    console.log(`Preloading ${views.length} worker views...`);

                    for (const view of views) {
                        try {
                            console.log(`Loading ${view.name}...`);
                            await fetchWithCache(view.url, view.cacheKey);
                            totalLoaded++;
                            console.log(`✓ ${view.name} loaded`);
                        } catch (error) {
                            totalFailed++;
                            console.error(`✗ ${view.name} failed:`, error);
                        }
                    }
                } else {
                    console.warn(`Unknown user type: ${userType}`);
                }

                if (totalLoaded > 0) {
                    showSuccess('⚡ Učitano!', `Učitano ${totalLoaded} prikaza. Skrolanje je sada instantno!`);
                } else {
                    showError('Greška', `Nije učitano nijedan prikaz. Provjerite internet konekciju.`);
                }

            } catch (error) {
                console.error('Preload error:', error);
                showError('Greška', 'Nije uspjelo učitavanje svih prikaza.');
            }
        }

        // Toggle user menu dropdown
        function toggleUserMenu() {
            const dropdown = document.getElementById('user-menu-dropdown');
            dropdown.classList.toggle('show');
        }

        // Close user menu when clicking outside
        document.addEventListener('click', function(event) {
            const userMenu = document.querySelector('.user-menu');
            const dropdown = document.getElementById('user-menu-dropdown');
            if (userMenu && !userMenu.contains(event.target) && dropdown) {
                dropdown.classList.remove('show');
            }
        });

        // ========== END CACHING ==========

        let currentUser = null;
        let currentPassword = null;
        let odjeliList = [];

        // POSLOVOĐA RADILIŠTA MAPPING
        const POSLOVODJA_RADILISTA = {
            'HARBAŠ MEHMEDALIJA': ['BJELAJSKE UVALE', 'VOJSKOVA'],
            'JASMIN PORIĆ': ['RADIĆKE UVALE', 'BAŠTRA ĆORKOVAČA'],
            'IRFAN HADŽIPAŠIĆ': ['TURSKE VODE']
        };

        // Load odjeli list from API
        async function loadOdjeli() {
            try {
                const url = API_URL + '?path=get-odjeli-list';
                const response = await fetch(url);
                const data = await response.json();

                if (data.success && data.odjeli) {
                    odjeliList = data.odjeli;
                    populateOdjeliDropdowns();
                }
            } catch (error) {
                console.error('Error loading odjeli:', error);
            }
        }

        // Populate all odjel dropdowns
        function populateOdjeliDropdowns() {
            const dropdowns = [
                'sjeca-odjel',
                'otprema-odjel',
                'edit-sjeca-odjel',
                'edit-otprema-odjel'
            ];

            dropdowns.forEach(dropdownId => {
                const dropdown = document.getElementById(dropdownId);
                if (dropdown) {
                    // Keep the first "Izaberi odjel..." option
                    const currentValue = dropdown.value;
                    dropdown.innerHTML = '<option value="">Izaberi odjel...</option>';

                    odjeliList.forEach(odjel => {
                        const option = document.createElement('option');
                        option.value = odjel;
                        option.textContent = odjel;
                        dropdown.appendChild(option);
                    });

                    // Restore previously selected value if it exists
                    if (currentValue && odjeliList.includes(currentValue)) {
                        dropdown.value = currentValue;
                    }
                }
            });
        }

        // Check if already logged in
        window.addEventListener('DOMContentLoaded', () => {
            const savedUser = localStorage.getItem('sumarija_user');
            const savedPass = localStorage.getItem('sumarija_pass');

            if (savedUser && savedPass) {
                currentUser = JSON.parse(savedUser);
                currentPassword = savedPass;
                showApp();
                loadData();
                loadOdjeli(); // Load odjeli list after auto-login
            }
        });
        
        // Login form
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorMsg = document.getElementById('error-msg');
            const loginBtn = document.getElementById('login-btn');
            
            errorMsg.classList.add('hidden');
            loginBtn.disabled = true;
            loginBtn.textContent = 'Prijavljivanje...';
            
            try {
                const response = await fetch(`${API_URL}?path=login&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`);
                const data = await response.json();
                
                if (data.success) {
                    currentUser = data;
                    currentPassword = password;
                    localStorage.setItem('sumarija_user', JSON.stringify(data));
                    localStorage.setItem('sumarija_pass', password);
                    showApp();
                    loadData();
                    loadOdjeli(); // Load odjeli list after manual login
                } else {
                    errorMsg.textContent = data.error || 'Greška pri prijavi';
                    errorMsg.classList.remove('hidden');
                }
            } catch (error) {
                errorMsg.textContent = 'Greška u komunikaciji sa serverom: ' + error.message;
                errorMsg.classList.remove('hidden');
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Prijavi se';
            }
        });
        
        function showApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            document.getElementById('user-name').textContent = currentUser.fullName;
            document.getElementById('user-role').textContent = currentUser.role === 'admin' ? 'Administrator' : currentUser.type;

            // Dinamički kreiraj tab-ove na osnovu tipa korisnika
            const tabsMenu = document.getElementById('tabs-menu');
            const userType = (currentUser.type || '').toLowerCase(); // Case-insensitive

            if (userType === 'primac') {
                // Primač vidi pet prikaza: pregled, godišnji prikaz, po odjelima, dodavanje, i moje sječe
                tabsMenu.innerHTML = `
                    <button class="tab active" onclick="switchTab('primac-personal')">👷 Pregled sječe u tekućoj godini</button>
                    <button class="tab" onclick="switchTab('primac-godisnji')">📅 Godišnji prikaz</button>
                    <button class="tab" onclick="switchTab('primac-odjeli')">🏭 Prikaz po odjelima</button>
                    <button class="tab" onclick="switchTab('add-sjeca')">➕ Dodaj sječu</button>
                    <button class="tab" onclick="switchTab('my-sjece')">📝 Moje sječe</button>
                    <button class="tab" onclick="switchTab('izvjestaji-primac')">📋 Izvještaji</button>
                `;
            } else if (userType === 'otpremac') {
                // Otpremač vidi četiri prikaza: pregled, po odjelima, dodavanje, i moje otpreme
                tabsMenu.innerHTML = `
                    <button class="tab active" onclick="switchTab('otpremac-personal')">🚛 Pregled otpreme u tekućoj godini</button>
                    <button class="tab" onclick="switchTab('otpremac-odjeli')">🏭 Prikaz po odjelima</button>
                    <button class="tab" onclick="switchTab('add-otprema')">➕ Dodaj otpremu</button>
                    <button class="tab" onclick="switchTab('my-otpreme')">📝 Moje otpreme</button>
                    <button class="tab" onclick="switchTab('izvjestaji-otpremac')">📋 Izvještaji</button>
                `;
            } else if (userType === 'operativa') {
                // OPERATIVA korisnik vidi samo analytics dashboards
                tabsMenu.innerHTML = `
                    <button class="tab active" onclick="switchTab('dashboard')">🌲 Šumarija Krupa</button>
                    <button class="tab" onclick="switchTab('operativa')">📊 Operativa & Analiza</button>
                    <button class="tab" onclick="switchTab('kupci')">📦 Kupci</button>
                    <button class="tab" onclick="switchTab('mjesecni-sortimenti')">📅 Mjesečni pregled</button>
                    <button class="tab" onclick="switchTab('izvjestaji')">📋 Izvještaji</button>
                `;
            } else if (userType === 'poslovođa' || userType === 'poslovodja') {
                // POSLOVOĐA vidi: STANJE ODJELA, ODJELI U REALIZACIJI, ZADNJIH 5 DANA, SUMA MJESECA, IZVJEŠTAJI
                tabsMenu.innerHTML = `
                    <button class="tab active" onclick="switchTab('poslovodja-stanje')">📊 Stanje Odjela</button>
                    <button class="tab" onclick="switchTab('poslovodja-realizacija')">🏗️ Odjeli u realizaciji</button>
                    <button class="tab" onclick="switchTab('poslovodja-zadnjih5')">📅 Zadnjih 5 Dana</button>
                    <button class="tab" onclick="switchTab('poslovodja-suma')">📈 Suma Mjeseca</button>
                    <button class="tab" onclick="switchTab('izvjestaji')">📋 Izvještaji</button>
                `;
            } else {
                // Admin korisnici - bez OPERATIVA tab-a (admin se loguje kao OPERATIVA tip ako želi vidjeti operativa podatke)
                tabsMenu.innerHTML = `
                    <button class="tab active" onclick="switchTab('dashboard')">🌲 Šumarija Krupa</button>
                    <button class="tab" onclick="switchTab('mjesecni-sortimenti')">📅 Sječa/otprema po mjesecima</button>
                    <button class="tab" onclick="switchTab('primaci')">👷 Prikaz sječe</button>
                    <button class="tab" onclick="switchTab('otpremaci')">🚛 Prikaz otpreme</button>
                    <button class="tab" onclick="switchTab('kupci')">🏢 Prikaz po kupcima</button>
                    <button class="tab" onclick="switchTab('izvjestaji-admin')">📋 Izvještaji</button>
                    <button class="tab notification-badge" onclick="switchTab('pending-unosi')">
                        📋 Dodani unosi
                        <span class="badge-count" id="pending-count-badge"></span>
                    </button>
                `;
            }
        }
        
        function logout() {
            currentUser = null;
            currentPassword = null;
            localStorage.removeItem('sumarija_user');
            localStorage.removeItem('sumarija_pass');
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('app-screen').classList.add('hidden');
            document.getElementById('dashboard-content').classList.add('hidden');
            document.getElementById('primaci-content').classList.add('hidden');
            document.getElementById('otpremaci-content').classList.add('hidden');
            document.getElementById('kupci-content').classList.add('hidden');
            document.getElementById('primac-personal-content').classList.add('hidden');
            document.getElementById('otpremac-personal-content').classList.add('hidden');
            document.getElementById('primac-odjeli-content').classList.add('hidden');
            document.getElementById('otpremac-odjeli-content').classList.add('hidden');
            document.getElementById('add-sjeca-content').classList.add('hidden');
            document.getElementById('add-otprema-content').classList.add('hidden');
            document.getElementById('my-sjece-content').classList.add('hidden');
            document.getElementById('my-otpreme-content').classList.add('hidden');
            document.getElementById('edit-sjeca-content').classList.add('hidden');
            document.getElementById('edit-otprema-content').classList.add('hidden');
            document.getElementById('pending-unosi-content').classList.add('hidden');
            document.getElementById('operativa-content').classList.add('hidden');
            document.getElementById('poslovodja-stanje-content').classList.add('hidden');
            document.getElementById('poslovodja-realizacija-content').classList.add('hidden');
            document.getElementById('poslovodja-zadnjih5-content').classList.add('hidden');
            document.getElementById('poslovodja-suma-content').classList.add('hidden');
            document.getElementById('izvjestaji-admin-content').classList.add('hidden');
            document.getElementById('izvjestaji-primac-content').classList.add('hidden');
            document.getElementById('izvjestaji-otpremac-content').classList.add('hidden');
            document.getElementById('loading-screen').classList.remove('hidden');
        }
        
        // Load initial data based on user type (OPTIMIZED - lazy loading)
        function loadData() {
            const userType = (currentUser.type || '').toLowerCase();

            // Show loading screen with progress
            const loadingText = document.querySelector('.loading-text');
            if (loadingText) {
                loadingText.textContent = 'Učitavam početni prikaz...';
            }

            if (userType === 'primac') {
                loadPrimacPersonal();
            } else if (userType === 'otpremac') {
                loadOtpremacPersonal();
            } else if (userType === 'poslovođa' || userType === 'poslovodja') {
                loadPoslovodjaStanje();
            } else {
                loadDashboard();
            }
        }

        // Switch between tabs
        function switchTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            // Hide all content sections
            document.getElementById('dashboard-content').classList.add('hidden');
            document.getElementById('primaci-content').classList.add('hidden');
            document.getElementById('otpremaci-content').classList.add('hidden');
            document.getElementById('kupci-content').classList.add('hidden');
            document.getElementById('primac-personal-content').classList.add('hidden');
            document.getElementById('primac-godisnji-content').classList.add('hidden');
            document.getElementById('otpremac-personal-content').classList.add('hidden');
            document.getElementById('primac-odjeli-content').classList.add('hidden');
            document.getElementById('otpremac-odjeli-content').classList.add('hidden');
            document.getElementById('add-sjeca-content').classList.add('hidden');
            document.getElementById('add-otprema-content').classList.add('hidden');
            document.getElementById('my-sjece-content').classList.add('hidden');
            document.getElementById('my-otpreme-content').classList.add('hidden');
            document.getElementById('edit-sjeca-content').classList.add('hidden');
            document.getElementById('edit-otprema-content').classList.add('hidden');
            document.getElementById('pending-unosi-content').classList.add('hidden');
            document.getElementById('mjesecni-sortimenti-content').classList.add('hidden');
            document.getElementById('izvjestaji-content').classList.add('hidden');
            document.getElementById('izvjestaji-admin-content').classList.add('hidden');
            document.getElementById('izvjestaji-primac-content').classList.add('hidden');
            document.getElementById('izvjestaji-otpremac-content').classList.add('hidden');
            document.getElementById('operativa-content').classList.add('hidden');
            document.getElementById('poslovodja-stanje-content').classList.add('hidden');
            document.getElementById('poslovodja-realizacija-content').classList.add('hidden');
            document.getElementById('poslovodja-zadnjih5-content').classList.add('hidden');
            document.getElementById('poslovodja-suma-content').classList.add('hidden');
            document.getElementById('dinamika-content').classList.add('hidden');
            document.getElementById('uporedba-godina-content').classList.add('hidden');

            // Load appropriate content
            if (tab === 'dashboard') {
                loadDashboard();
            } else if (tab === 'operativa') {
                loadOperativa();
            } else if (tab === 'primaci') {
                loadPrimaci();
            } else if (tab === 'otpremaci') {
                loadOtpremaci();
            } else if (tab === 'kupci') {
                loadKupci();
            } else if (tab === 'primac-personal') {
                loadPrimacPersonal();
            } else if (tab === 'primac-godisnji') {
                loadPrimacGodisnji();
                document.getElementById('primac-godisnji-content').classList.remove('hidden');
            } else if (tab === 'otpremac-personal') {
                loadOtpremacPersonal();
            } else if (tab === 'primac-odjeli') {
                loadPrimacOdjeli();
            } else if (tab === 'otpremac-odjeli') {
                loadOtpremacOdjeli();
            } else if (tab === 'add-sjeca') {
                showAddSjecaForm();
            } else if (tab === 'add-otprema') {
                showAddOtpremaForm();
            } else if (tab === 'my-sjece') {
                loadMySjece();
            } else if (tab === 'my-otpreme') {
                loadMyOtpreme();
            } else if (tab === 'pending-unosi') {
                loadPendingUnosi();
            } else if (tab === 'mjesecni-sortimenti') {
                loadMjesecniSortimenti();
            } else if (tab === 'dinamika') {
                loadDinamika();
            } else if (tab === 'uporedba-godina') {
                loadUporedbaGodina();
            } else if (tab === 'izvjestaji') {
                // Initialize dropdowns to current month/year if not already set
                const currentDate = new Date();
                const currentYear = currentDate.getFullYear();
                const currentMonth = currentDate.getMonth();

                // Set defaults for all izvjestaji dropdowns
                if (!document.getElementById('izvjestaji-year-select').value) {
                    document.getElementById('izvjestaji-year-select').value = currentYear;
                }
                if (!document.getElementById('izvjestaji-month-select').value) {
                    document.getElementById('izvjestaji-month-select').value = currentMonth;
                }
                if (!document.getElementById('sedmicni-sjeca-year-select').value) {
                    document.getElementById('sedmicni-sjeca-year-select').value = currentYear;
                }
                if (!document.getElementById('sedmicni-sjeca-month-select').value) {
                    document.getElementById('sedmicni-sjeca-month-select').value = currentMonth;
                }
                if (!document.getElementById('sedmicni-otprema-year-select').value) {
                    document.getElementById('sedmicni-otprema-year-select').value = currentYear;
                }
                if (!document.getElementById('sedmicni-otprema-month-select').value) {
                    document.getElementById('sedmicni-otprema-month-select').value = currentMonth;
                }

                // Load mjesečni izvještaj by default
                switchIzvjestajiSubTab('mjesecni');
            } else if (tab === 'poslovodja-stanje') {
                loadPoslovodjaStanje();
            } else if (tab === 'poslovodja-realizacija') {
                loadPoslovodjaRealizacija();
            } else if (tab === 'poslovodja-zadnjih5') {
                loadPoslovodjaZadnjih5();
            } else if (tab === 'poslovodja-suma') {
                loadPoslovodjaSuma();
            } else if (tab === 'izvjestaji-admin') {
                document.getElementById('izvjestaji-admin-content').classList.remove('hidden');
            } else if (tab === 'izvjestaji-primac') {
                // Set default to current month/year
                const currentDate = new Date();
                document.getElementById('primac-sedmicni-year').value = currentDate.getFullYear();
                document.getElementById('primac-sedmicni-month').value = currentDate.getMonth();
                document.getElementById('primac-mjesecni-year').value = currentDate.getFullYear();
                document.getElementById('primac-mjesecni-month').value = currentDate.getMonth();

                document.getElementById('izvjestaji-primac-content').classList.remove('hidden');
                switchPrimacIzvjestajiSubTab('sedmicni');
            } else if (tab === 'izvjestaji-otpremac') {
                // Set default to current month/year
                const currentDate = new Date();
                document.getElementById('otpremac-sedmicni-year').value = currentDate.getFullYear();
                document.getElementById('otpremac-sedmicni-month').value = currentDate.getMonth();
                document.getElementById('otpremac-mjesecni-year').value = currentDate.getFullYear();
                document.getElementById('otpremac-mjesecni-month').value = currentDate.getMonth();

                document.getElementById('izvjestaji-otpremac-content').classList.remove('hidden');
                switchOtpremacIzvjestajiSubTab('sedmicni');
            }
        }

        // Switch between primaci submenus
        function switchPrimaciSubmenu(view) {
            // Update submenu buttons
            const submenuTabs = document.querySelectorAll('#primaci-content .submenu-tab');
            submenuTabs.forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Hide all submenu content
            document.getElementById('primaci-monthly-view').classList.add('hidden');
            document.getElementById('primaci-daily-view').classList.add('hidden');
            document.getElementById('primaci-radilista-view').classList.add('hidden');
            document.getElementById('primaci-izvodjaci-view').classList.add('hidden');

            // Show selected view
            if (view === 'monthly') {
                document.getElementById('primaci-monthly-view').classList.remove('hidden');
            } else if (view === 'daily') {
                document.getElementById('primaci-daily-view').classList.remove('hidden');
                // Load daily data if not already loaded
                if (!document.getElementById('primaci-daily-header').innerHTML) {
                    loadPrimaciDaily();
                }
            } else if (view === 'radilista') {
                document.getElementById('primaci-radilista-view').classList.remove('hidden');
                // Load radilista data if not already loaded
                if (!document.getElementById('primaci-radilista-header').innerHTML) {
                    loadPrimaciByRadiliste();
                }
            } else if (view === 'izvodjaci') {
                document.getElementById('primaci-izvodjaci-view').classList.remove('hidden');
                // Load izvodjaci data if not already loaded
                if (!document.getElementById('primaci-izvodjaci-header').innerHTML) {
                    loadPrimaciByIzvodjac();
                }
            }
        }

        // Switch between otpremaci submenus
        function switchOtremaciSubmenu(view) {
            // Update submenu buttons
            const submenuTabs = document.querySelectorAll('#otpremaci-content .submenu-tab');
            submenuTabs.forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Hide all submenu content
            document.getElementById('otpremaci-monthly-view').classList.add('hidden');
            document.getElementById('otpremaci-daily-view').classList.add('hidden');
            document.getElementById('otpremaci-radilista-view').classList.add('hidden');
            document.getElementById('otpremaci-po-kupcima-view').classList.add('hidden');

            // Show selected view
            if (view === 'monthly') {
                document.getElementById('otpremaci-monthly-view').classList.remove('hidden');
            } else if (view === 'daily') {
                document.getElementById('otpremaci-daily-view').classList.remove('hidden');
                // Load daily data if not already loaded
                if (!document.getElementById('otpremaci-daily-header').innerHTML) {
                    loadOtremaciDaily();
                }
            } else if (view === 'radilista') {
                document.getElementById('otpremaci-radilista-view').classList.remove('hidden');
                // Load radilista data if not already loaded
                if (!document.getElementById('otpremaci-radilista-header').innerHTML) {
                    loadOtremaciByRadiliste();
                }
            } else if (view === 'po-kupcima') {
                document.getElementById('otpremaci-po-kupcima-view').classList.remove('hidden');
                // Load kupci data if not already loaded
                if (!document.getElementById('otpremaci-po-kupcima-header').innerHTML) {
                    loadOtremaciPoKupcima();
                }
            }
        }

        // Load dashboard data
        async function loadDashboard() {
            document.getElementById('loading-screen').classList.remove('hidden');
            document.getElementById('dashboard-content').classList.add('hidden');

            try {
                const year = new Date().getFullYear();

                // Fetch dashboard data with caching (30s timeout for heavy endpoint)
                const url = `${API_URL}?path=dashboard&year=${year}&username=${currentUser.username}&password=${currentPassword}`;
                const data = await fetchWithCache(url, 'cache_dashboard_' + year, false, 30000);

                console.log('Dashboard data:', data);

                // Check for errors
                if (data.error) {
                    throw new Error('Dashboard API error: ' + data.error);
                }

                // Check if data is valid
                if (!data.mjesecnaStatistika) {
                    throw new Error('Dashboard data missing mjesecnaStatistika');
                }

                // Calculate summary statistics
                const totalSjeca = data.mjesecnaStatistika.reduce((sum, m) => sum + m.sjeca, 0);
                const totalOtprema = data.mjesecnaStatistika.reduce((sum, m) => sum + m.otprema, 0);
                const totalStanje = totalSjeca - totalOtprema;
                const totalDinamika = data.mjesecnaStatistika.reduce((sum, m) => sum + m.dinamika, 0);
                const razlikaDinamika = totalSjeca - totalDinamika;
                const percentDinamika = ((totalSjeca / totalDinamika) * 100).toFixed(1);

                // Create summary cards
                const summaryHTML = `
                    <div class="summary-card green">
                        <div class="summary-card-title">Ukupna Sječa</div>
                        <div class="summary-card-value">${totalSjeca.toFixed(0)} m³</div>
                        <div class="summary-card-subtitle">${percentDinamika}% dinamike</div>
                    </div>
                    <div class="summary-card blue">
                        <div class="summary-card-title">Ukupna Otprema</div>
                        <div class="summary-card-value">${totalOtprema.toFixed(0)} m³</div>
                        <div class="summary-card-subtitle">${((totalOtprema/totalSjeca)*100).toFixed(1)}% od sječe</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-card-title">Šuma/Panj</div>
                        <div class="summary-card-value">${totalStanje.toFixed(0)} m³</div>
                        <div class="summary-card-subtitle">Preostalo u šumi</div>
                    </div>
                    <div class="summary-card ${razlikaDinamika >= 0 ? 'green' : 'red'}">
                        <div class="summary-card-title">Razlika sa Dinamikom</div>
                        <div class="summary-card-value">${(razlikaDinamika >= 0 ? '+' : '') + razlikaDinamika.toFixed(0)} m³</div>
                        <div class="summary-card-subtitle">${razlikaDinamika >= 0 ? 'Iznad plana' : 'Ispod plana'}</div>
                    </div>
                `;
                document.getElementById('summary-cards').innerHTML = summaryHTML;

                // Create chart
                const labels = data.mjesecnaStatistika.map(m => m.mjesec);
                const sjecaData = data.mjesecnaStatistika.map(m => m.sjeca);
                const otpremaData = data.mjesecnaStatistika.map(m => m.otprema);
                const dinamikaData = data.mjesecnaStatistika.map(m => m.dinamika);

                const ctx = document.getElementById('trendsChart');
                if (window.dashboardChart) {
                    window.dashboardChart.destroy();
                }
                window.dashboardChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Sječa',
                            data: sjecaData,
                            borderColor: '#059669',
                            backgroundColor: 'rgba(5, 150, 105, 0.1)',
                            tension: 0.4,
                            fill: true
                        }, {
                            label: 'Otprema',
                            data: otpremaData,
                            borderColor: '#2563eb',
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            tension: 0.4,
                            fill: true
                        }, {
                            label: 'Dinamika',
                            data: dinamikaData,
                            borderColor: '#dc2626',
                            borderDash: [5, 5],
                            tension: 0.4,
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top' },
                            tooltip: { mode: 'index', intersect: false }
                        },
                        scales: {
                            y: { beginAtZero: true, title: { display: true, text: 'm³' } }
                        }
                    }
                });

                // Populate monthly table
                const monthlyHTML = data.mjesecnaStatistika.map(m => {
                    const razlikaSjeca = m.razlikaSjeca || 0;
                    const razlikaOtprema = m.razlikaOtprema || 0;
                    const progressPercent = ((m.sjeca / m.dinamika) * 100).toFixed(1);
                    return `
                        <tr>
                            <td>${m.mjesec}</td>
                            <td class="number green">${m.sjeca.toFixed(2)}</td>
                            <td class="number blue">${m.otprema.toFixed(2)}</td>
                            <td class="number">${m.stanje.toFixed(2)}</td>
                            <td class="number">
                                ${m.dinamika.toFixed(2)}
                                <div class="table-progress-bar">
                                    <div class="table-progress-fill" style="width: ${Math.min(progressPercent, 100)}%"></div>
                                </div>
                            </td>
                            <td class="number ${razlikaSjeca >= 0 ? 'green' : 'red'}">${(razlikaSjeca >= 0 ? '+' : '') + razlikaSjeca.toFixed(2)}</td>
                            <td class="number ${razlikaOtprema >= 0 ? 'green' : 'red'}">${(razlikaOtprema >= 0 ? '+' : '') + razlikaOtprema.toFixed(2)}</td>
                        </tr>
                    `;
                }).join('');
                document.getElementById('dashboard-monthly-table').innerHTML = monthlyHTML;

                // Fetch and populate odjeli table with caching
                const odjeliUrl = `${API_URL}?path=odjeli&year=${year}&username=${currentUser.username}&password=${currentPassword}`;
                const odjeliData = await fetchWithCache(odjeliUrl, 'cache_odjeli_' + year);

                console.log('Odjeli data:', odjeliData);

                if (odjeliData.error) {
                    console.error('Odjeli API error:', odjeliData.error);
                    document.getElementById('odjeli-table-body').innerHTML = '<tr><td colspan="8" style="text-align: center; color: #dc2626;">Greška pri učitavanju podataka o odjelima</td></tr>';
                } else if (odjeliData.odjeli && odjeliData.odjeli.length > 0) {
                    const odjeliHTML = odjeliData.odjeli.map(o => {
                        const realizacijaColor = o.realizacija >= 100 ? 'green' : (o.realizacija >= 80 ? 'blue' : 'red');
                        return `
                            <tr>
                                <td style="font-weight: 500;">${o.odjel}</td>
                                <td class="right green">${o.sjeca.toFixed(2)}</td>
                                <td class="right blue">${o.otprema.toFixed(2)}</td>
                                <td class="right">${o.sumaPanj.toFixed(2)}</td>
                                <td>${o.radiliste || '-'}</td>
                                <td>${o.izvođač || '-'}</td>
                                <td>${o.datumZadnjeSjece || '-'}</td>
                                <td class="right ${realizacijaColor}">${o.realizacija > 0 ? o.realizacija.toFixed(1) + '%' : '-'}</td>
                            </tr>
                        `;
                    }).join('');
                    document.getElementById('odjeli-table-body').innerHTML = odjeliHTML;
                } else {
                    document.getElementById('odjeli-table-body').innerHTML = '<tr><td colspan="8" style="text-align: center; color: #6b7280;">Nema podataka o odjelima</td></tr>';
                }

                // Load pending count for badge (admin only)
                loadPendingCount();

                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('dashboard-content').classList.remove('hidden');

            } catch (error) {
                console.error('Dashboard error:', error);
                showError('Greška', 'Greška pri učitavanju dashboard podataka: ' + error.message);
                document.getElementById('loading-screen').innerHTML = '<div class="loading-icon">❌</div><div class="loading-text">Greška pri učitavanju</div><div class="loading-sub">' + error.message + '</div>';
            }
        }

        // ========================================
        // POSLOVOĐA FUNCTIONS
        // ========================================

        // Helper: Get radilišta for current poslovodja
        function getPoslovodjaRadilista() {
            if (!currentUser) {
                return [];
            }
            const userType = (currentUser.type || '').toLowerCase();
            if (userType !== 'poslovođa' && userType !== 'poslovodja') {
                return [];
            }
            const fullName = currentUser.fullName.toUpperCase().trim();
            return POSLOVODJA_RADILISTA[fullName] || [];
        }

        // Load STANJE ODJELA za poslovođu
        async function loadPoslovodjaStanje() {
            document.getElementById('loading-screen').classList.remove('hidden');
            document.getElementById('poslovodja-stanje-content').classList.add('hidden');

            try {
                const radilista = getPoslovodjaRadilista();
                console.log('Poslovođa radilišta:', radilista);

                // Display radilišta
                document.getElementById('poslovodja-radilista-list').textContent = radilista.join(', ');

                // Load STANJE ODJELA data
                const url = `${API_URL}?path=odjeli&username=${currentUser.username}&password=${currentPassword}`;
                const data = await fetchWithCache(url, 'cache_odjeli_stanje');

                console.log('Odjeli data:', data);

                if (data.error || !data.odjeli) {
                    throw new Error(data.error || 'Nema podataka o odjelima');
                }

                // Filter odjeli by radilišta
                const filteredOdjeli = data.odjeli.filter(odjel => {
                    const odjelRadiliste = (odjel.radiliste || '').toUpperCase().trim();
                    return radilista.some(r => odjelRadiliste.includes(r.toUpperCase()));
                });

                console.log('Filtered odjeli:', filteredOdjeli);

                // Render stanje odjela table
                renderPoslovodjaStanjeTable(filteredOdjeli);

                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('poslovodja-stanje-content').classList.remove('hidden');

            } catch (error) {
                console.error('Error loading poslovođa stanje:', error);
                showError('Greška', 'Greška pri učitavanju stanja odjela: ' + error.message);
                document.getElementById('loading-screen').classList.add('hidden');
            }
        }

        // Render Stanje Odjela table for poslovođa
        function renderPoslovodjaStanjeTable(odjeli) {
            const headerElem = document.getElementById('poslovodja-stanje-header');
            const bodyElem = document.getElementById('poslovodja-stanje-body');

            if (odjeli.length === 0) {
                headerElem.innerHTML = '';
                bodyElem.innerHTML = '<tr><td colspan="100%" style="text-align: center; padding: 40px; color: #6b7280;">Nema odjela na vašim radilištima</td></tr>';
                return;
            }

            // Build header
            let headerHtml = `
                <tr>
                    <th>Odjel</th>
                    <th>Radilište</th>
                    <th>Izvođač</th>
                    <th>Projekat (m³)</th>
                    <th>Sječa (m³)</th>
                    <th>Otprema (m³)</th>
                    <th>Realizacija (%)</th>
                    <th>Zadnji Unos</th>
                </tr>
            `;
            headerElem.innerHTML = headerHtml;

            // Build body
            let bodyHtml = '';
            odjeli.forEach((odjel, index) => {
                const rowBg = index % 2 === 0 ? '#f9fafb' : 'white';
                const projekat = odjel.projekat || 0;
                const sjeca = odjel.sjeca || 0;
                const procenat = projekat > 0 ? ((sjeca / projekat) * 100).toFixed(1) : '0.0';

                let percentClass = '';
                if (procenat < 50) percentClass = 'style="color: #dc2626; font-weight: 700;"';
                else if (procenat >= 100) percentClass = 'style="color: #059669; font-weight: 700;"';
                else percentClass = 'style="color: #d97706; font-weight: 600;"';

                bodyHtml += `
                    <tr style="background: ${rowBg};">
                        <td style="font-weight: 600;">${odjel.odjel || ''}</td>
                        <td>${odjel.radiliste || '-'}</td>
                        <td>${odjel.izvođač || '-'}</td>
                        <td style="text-align: right; font-family: 'Courier New', monospace;">${projekat.toFixed(2)}</td>
                        <td style="text-align: right; font-family: 'Courier New', monospace; font-weight: 600;">${sjeca.toFixed(2)}</td>
                        <td style="text-align: right; font-family: 'Courier New', monospace;">${(odjel.otprema || 0).toFixed(2)}</td>
                        <td ${percentClass} style="text-align: right; font-family: 'Courier New', monospace;">${procenat}%</td>
                        <td>${odjel.datumZadnjeSjece || '-'}</td>
                    </tr>
                `;
            });

            bodyElem.innerHTML = bodyHtml;
        }

        // Load ODJELI U REALIZACIJI za poslovođu
        async function loadPoslovodjaRealizacija() {
            document.getElementById('loading-screen').classList.remove('hidden');
            document.getElementById('poslovodja-realizacija-content').classList.add('hidden');

            try {
                const radilista = getPoslovodjaRadilista();
                console.log('Poslovođa radilišta:', radilista);

                // Display radilišta
                document.getElementById('poslovodja-radilista-list-2').textContent = radilista.join(', ');

                // Load STANJE ODJELA data (koristimo iste podatke kao za stanje)
                const url = `${API_URL}?path=odjeli&username=${currentUser.username}&password=${currentPassword}`;
                const data = await fetchWithCache(url, 'cache_odjeli_realizacija');

                console.log('Odjeli data:', data);

                if (data.error || !data.odjeli) {
                    throw new Error(data.error || 'Nema podataka o odjelima');
                }

                // Filter odjeli by radilišta - prikazujemo samo odjele koji su u realizaciji (imaju sječu)
                const filteredOdjeli = data.odjeli.filter(odjel => {
                    const odjelRadiliste = (odjel.radiliste || '').toUpperCase().trim();
                    const hasRadiliste = radilista.some(r => odjelRadiliste.includes(r.toUpperCase()));
                    const uRealizaciji = (odjel.sjeca || 0) > 0; // Samo odjeli koji imaju sječu
                    return hasRadiliste && uRealizaciji;
                });

                console.log('Filtered odjeli u realizaciji:', filteredOdjeli);

                // Render realizacija table (isti format kao stanje)
                renderPoslovodjaRealizacijaTable(filteredOdjeli);

                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('poslovodja-realizacija-content').classList.remove('hidden');

            } catch (error) {
                console.error('Error loading poslovođa realizacija:', error);
                showError('Greška', 'Greška pri učitavanju odjela u realizaciji: ' + error.message);
                document.getElementById('loading-screen').classList.add('hidden');
            }
        }

        // Render Odjeli u Realizaciji table for poslovođa
        function renderPoslovodjaRealizacijaTable(odjeli) {
            const headerElem = document.getElementById('poslovodja-realizacija-header');
            const bodyElem = document.getElementById('poslovodja-realizacija-body');

            if (odjeli.length === 0) {
                headerElem.innerHTML = '';
                bodyElem.innerHTML = '<tr><td colspan="100%" style="text-align: center; padding: 40px; color: #6b7280;">Trenutno nema odjela u realizaciji na vašim radilištima</td></tr>';
                return;
            }

            // Build header (isti kao stanje odjela)
            let headerHtml = `
                <tr>
                    <th>Odjel</th>
                    <th>Radilište</th>
                    <th>Izvođač</th>
                    <th>Projekat (m³)</th>
                    <th>Sječa (m³)</th>
                    <th>Otprema (m³)</th>
                    <th>Realizacija (%)</th>
                    <th>Zadnji Unos</th>
                </tr>
            `;
            headerElem.innerHTML = headerHtml;

            // Build body
            let bodyHtml = '';
            odjeli.forEach((odjel, index) => {
                const rowBg = index % 2 === 0 ? '#f9fafb' : 'white';
                const projekat = odjel.projekat || 0;
                const sjeca = odjel.sjeca || 0;
                const procenat = projekat > 0 ? ((sjeca / projekat) * 100).toFixed(1) : '0.0';

                let percentClass = '';
                if (procenat < 50) percentClass = 'style="color: #dc2626; font-weight: 700;"';
                else if (procenat >= 100) percentClass = 'style="color: #059669; font-weight: 700;"';
                else percentClass = 'style="color: #d97706; font-weight: 600;"';

                bodyHtml += `
                    <tr style="background: ${rowBg};">
                        <td style="font-weight: 600;">${odjel.odjel || ''}</td>
                        <td>${odjel.radiliste || '-'}</td>
                        <td>${odjel.izvođač || '-'}</td>
                        <td style="text-align: right; font-family: 'Courier New', monospace;">${projekat.toFixed(2)}</td>
                        <td style="text-align: right; font-family: 'Courier New', monospace; font-weight: 600;">${sjeca.toFixed(2)}</td>
                        <td style="text-align: right; font-family: 'Courier New', monospace;">${(odjel.otprema || 0).toFixed(2)}</td>
                        <td ${percentClass} style="text-align: right; font-family: 'Courier New', monospace;">${procenat}%</td>
                        <td>${odjel.datumZadnjeSjece || '-'}</td>
                    </tr>
                `;
            });

            bodyElem.innerHTML = bodyHtml;
        }

        // Load ZADNJIH 5 DANA (Primka i Otprema) za poslovođu
        async function loadPoslovodjaZadnjih5() {
            document.getElementById('loading-screen').classList.remove('hidden');
            document.getElementById('poslovodja-zadnjih5-content').classList.add('hidden');

            try {
                const radilista = getPoslovodjaRadilista();
                console.log('Poslovođa radilišta:', radilista);

                // Display radilišta
                document.getElementById('poslovodja-radilista-list-3').textContent = radilista.join(', ');

                // Izračunaj datum prije 5 dana
                const today = new Date();
                const fiveDaysAgo = new Date(today);
                fiveDaysAgo.setDate(today.getDate() - 5);

                // Load primke i otpreme
                const primkeUrl = `${API_URL}?path=primke&username=${currentUser.username}&password=${currentPassword}`;
                const otpremeUrl = `${API_URL}?path=otpreme&username=${currentUser.username}&password=${currentPassword}`;

                const [primkeData, otpremeData] = await Promise.all([
                    fetchWithCache(primkeUrl, 'cache_primke_zadnjih5'),
                    fetchWithCache(otpremeUrl, 'cache_otpreme_zadnjih5')
                ]);

                console.log('Primke data:', primkeData);
                console.log('Otpreme data:', otpremeData);

                if (primkeData.error) {
                    throw new Error('Greška pri učitavanju primki: ' + primkeData.error);
                }
                if (otpremeData.error) {
                    throw new Error('Greška pri učitavanju otprema: ' + otpremeData.error);
                }

                // Filter primke by radilišta i datum (zadnjih 5 dana)
                const filteredPrimke = (primkeData.primke || []).filter(primka => {
                    const primkaRadiliste = (primka.radiliste || '').toUpperCase().trim();
                    const hasRadiliste = radilista.some(r => primkaRadiliste.includes(r.toUpperCase()));

                    // Parse datum
                    const primkaDatum = new Date(primka.datum);
                    const withinLast5Days = primkaDatum >= fiveDaysAgo;

                    return hasRadiliste && withinLast5Days;
                });

                // Filter otpreme by radilišta i datum (zadnjih 5 dana)
                const filteredOtpreme = (otpremeData.otpreme || []).filter(otprema => {
                    const otpremaRadiliste = (otprema.radiliste || '').toUpperCase().trim();
                    const hasRadiliste = radilista.some(r => otpremaRadiliste.includes(r.toUpperCase()));

                    // Parse datum
                    const otpremaDatum = new Date(otprema.datum);
                    const withinLast5Days = otpremaDatum >= fiveDaysAgo;

                    return hasRadiliste && withinLast5Days;
                });

                // Sortiraj po datumu (najnoviji prvi)
                filteredPrimke.sort((a, b) => new Date(b.datum) - new Date(a.datum));
                filteredOtpreme.sort((a, b) => new Date(b.datum) - new Date(a.datum));

                console.log('Filtered primke (zadnjih 5 dana):', filteredPrimke);
                console.log('Filtered otpreme (zadnjih 5 dana):', filteredOtpreme);

                // Render tables
                renderPoslovodjaPrimkaTable(filteredPrimke);
                renderPoslovodjaOtpremaTable(filteredOtpreme);

                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('poslovodja-zadnjih5-content').classList.remove('hidden');

            } catch (error) {
                console.error('Error loading poslovođa zadnjih 5:', error);
                showError('Greška', 'Greška pri učitavanju zadnjih 5 dana: ' + error.message);
                document.getElementById('loading-screen').classList.add('hidden');
            }
        }

        // Render Primka table (zadnjih 5 dana)
        function renderPoslovodjaPrimkaTable(primke) {
            const headerElem = document.getElementById('poslovodja-primka-header');
            const bodyElem = document.getElementById('poslovodja-primka-body');

            if (primke.length === 0) {
                headerElem.innerHTML = '';
                bodyElem.innerHTML = '<tr><td colspan="100%" style="text-align: center; padding: 40px; color: #6b7280;">Nema primki u zadnjih 5 dana</td></tr>';
                return;
            }

            // Build header - redosled: Radnik (Primac), Odjel, Datum, Sortiment, Količina
            let headerHtml = `
                <tr style="background: #059669;">
                    <th style="color: white; font-weight: 700;">Primac</th>
                    <th style="color: white; font-weight: 700;">Odjel</th>
                    <th style="color: white; font-weight: 700;">Datum</th>
                    <th style="color: white; font-weight: 700;">Sortiment</th>
                    <th style="color: white; font-weight: 700;">Količina (m³)</th>
                </tr>
            `;
            headerElem.innerHTML = headerHtml;

            // Build body
            let bodyHtml = '';
            primke.forEach((primka, index) => {
                const rowBg = index % 2 === 0 ? '#f0fdf4' : 'white';
                bodyHtml += `
                    <tr style="background: ${rowBg};">
                        <td style="font-weight: 600;">${primka.primac || '-'}</td>
                        <td>${primka.odjel || '-'}</td>
                        <td style="font-weight: 500;">${primka.datum || '-'}</td>
                        <td>${primka.sortiment || '-'}</td>
                        <td style="text-align: right; font-family: 'Courier New', monospace; font-weight: 700; color: #059669;">${(primka.kolicina || 0).toFixed(2)}</td>
                    </tr>
                `;
            });

            bodyElem.innerHTML = bodyHtml;
        }

        // Render Otprema table (zadnjih 5 dana)
        function renderPoslovodjaOtpremaTable(otpreme) {
            const headerElem = document.getElementById('poslovodja-otprema-header');
            const bodyElem = document.getElementById('poslovodja-otprema-body');

            if (otpreme.length === 0) {
                headerElem.innerHTML = '';
                bodyElem.innerHTML = '<tr><td colspan="100%" style="text-align: center; padding: 40px; color: #6b7280;">Nema otprema u zadnjih 5 dana</td></tr>';
                return;
            }

            // Build header - redosled: Radnik (Otpremac), Odjel, Datum, Sortiment, Količina
            let headerHtml = `
                <tr style="background: #dc2626;">
                    <th style="color: white; font-weight: 700;">Otpremac</th>
                    <th style="color: white; font-weight: 700;">Odjel</th>
                    <th style="color: white; font-weight: 700;">Datum</th>
                    <th style="color: white; font-weight: 700;">Sortiment</th>
                    <th style="color: white; font-weight: 700;">Količina (m³)</th>
                </tr>
            `;
            headerElem.innerHTML = headerHtml;

            // Build body
            let bodyHtml = '';
            otpreme.forEach((otprema, index) => {
                const rowBg = index % 2 === 0 ? '#fef2f2' : 'white';
                bodyHtml += `
                    <tr style="background: ${rowBg};">
                        <td style="font-weight: 600;">${otprema.otpremac || '-'}</td>
                        <td>${otprema.odjel || '-'}</td>
                        <td style="font-weight: 500;">${otprema.datum || '-'}</td>
                        <td>${otprema.sortiment || '-'}</td>
                        <td style="text-align: right; font-family: 'Courier New', monospace; font-weight: 700; color: #dc2626;">${(otprema.kolicina || 0).toFixed(2)}</td>
                    </tr>
                `;
            });

            bodyElem.innerHTML = bodyHtml;
        }

        // Load SUMA MJESECA za poslovođu
        async function loadPoslovodjaSuma() {
            document.getElementById('loading-screen').classList.remove('hidden');
            document.getElementById('poslovodja-suma-content').classList.add('hidden');

            try {
                const radilista = getPoslovodjaRadilista();
                console.log('Poslovođa radilišta:', radilista);

                // Display radilišta
                document.getElementById('poslovodja-radilista-list-4').textContent = radilista.join(', ');

                // Get current month/year
                const currentDate = new Date();
                const currentYear = currentDate.getFullYear();
                const currentMonth = currentDate.getMonth(); // 0-11

                // Load primke i otpreme
                const primkeUrl = `${API_URL}?path=primke&username=${currentUser.username}&password=${currentPassword}`;
                const otpremeUrl = `${API_URL}?path=otpreme&username=${currentUser.username}&password=${currentPassword}`;

                const [primkeData, otpremeData] = await Promise.all([
                    fetchWithCache(primkeUrl, 'cache_primke_suma'),
                    fetchWithCache(otpremeUrl, 'cache_otpreme_suma')
                ]);

                console.log('Primke data:', primkeData);
                console.log('Otpreme data:', otpremeData);

                if (primkeData.error) {
                    throw new Error('Greška pri učitavanju primki: ' + primkeData.error);
                }
                if (otpremeData.error) {
                    throw new Error('Greška pri učitavanju otprema: ' + otpremeData.error);
                }

                // Filter by radilišta i tekući mjesec
                const filteredPrimke = (primkeData.primke || []).filter(primka => {
                    const primkaRadiliste = (primka.radiliste || '').toUpperCase().trim();
                    const hasRadiliste = radilista.some(r => primkaRadiliste.includes(r.toUpperCase()));

                    // Parse datum
                    const primkaDatum = new Date(primka.datum);
                    const sameMonth = primkaDatum.getMonth() === currentMonth && primkaDatum.getFullYear() === currentYear;

                    return hasRadiliste && sameMonth;
                });

                const filteredOtpreme = (otpremeData.otpreme || []).filter(otprema => {
                    const otpremaRadiliste = (otprema.radiliste || '').toUpperCase().trim();
                    const hasRadiliste = radilista.some(r => otpremaRadiliste.includes(r.toUpperCase()));

                    // Parse datum
                    const otpremaDatum = new Date(otprema.datum);
                    const sameMonth = otpremaDatum.getMonth() === currentMonth && otpremaDatum.getFullYear() === currentYear;

                    return hasRadiliste && sameMonth;
                });

                console.log('Filtered primke (trenutni mjesec):', filteredPrimke);
                console.log('Filtered otpreme (trenutni mjesec):', filteredOtpreme);

                // Sumiranje po odjelima
                const sumePoOdjelima = {};

                filteredPrimke.forEach(primka => {
                    const odjel = primka.odjel || 'Nepoznato';
                    const radiliste = primka.radiliste || 'Nepoznato';
                    if (!sumePoOdjelima[odjel]) {
                        sumePoOdjelima[odjel] = {
                            odjel: odjel,
                            radiliste: radiliste,
                            primka: 0,
                            otprema: 0
                        };
                    }
                    sumePoOdjelima[odjel].primka += (primka.kolicina || 0);
                });

                filteredOtpreme.forEach(otprema => {
                    const odjel = otprema.odjel || 'Nepoznato';
                    const radiliste = otprema.radiliste || 'Nepoznato';
                    if (!sumePoOdjelima[odjel]) {
                        sumePoOdjelima[odjel] = {
                            odjel: odjel,
                            radiliste: radiliste,
                            primka: 0,
                            otprema: 0
                        };
                    }
                    sumePoOdjelima[odjel].otprema += (otprema.kolicina || 0);
                });

                // Sumiranje po radilištima
                const sumePoRadilistima = {};

                filteredPrimke.forEach(primka => {
                    const radiliste = primka.radiliste || 'Nepoznato';
                    if (!sumePoRadilistima[radiliste]) {
                        sumePoRadilistima[radiliste] = {
                            radiliste: radiliste,
                            primka: 0,
                            otprema: 0
                        };
                    }
                    sumePoRadilistima[radiliste].primka += (primka.kolicina || 0);
                });

                filteredOtpreme.forEach(otprema => {
                    const radiliste = otprema.radiliste || 'Nepoznato';
                    if (!sumePoRadilistima[radiliste]) {
                        sumePoRadilistima[radiliste] = {
                            radiliste: radiliste,
                            primka: 0,
                            otprema: 0
                        };
                    }
                    sumePoRadilistima[radiliste].otprema += (otprema.kolicina || 0);
                });

                // Convert to arrays
                const odjeliArray = Object.values(sumePoOdjelima);
                const radilistaArray = Object.values(sumePoRadilistima);

                console.log('Sume po odjelima:', odjeliArray);
                console.log('Sume po radilištima:', radilistaArray);

                // Render tables
                renderPoslovodjaSumaOdjeliTable(odjeliArray);
                renderPoslovodjaSumaRadilisteTable(radilistaArray);

                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('poslovodja-suma-content').classList.remove('hidden');

            } catch (error) {
                console.error('Error loading poslovođa suma:', error);
                showError('Greška', 'Greška pri učitavanju mjesečnih suma: ' + error.message);
                document.getElementById('loading-screen').classList.add('hidden');
            }
        }

        // Render Suma Mjeseca po Odjelima
        function renderPoslovodjaSumaOdjeliTable(odjeli) {
            const headerElem = document.getElementById('poslovodja-suma-odjeli-header');
            const bodyElem = document.getElementById('poslovodja-suma-odjeli-body');

            if (odjeli.length === 0) {
                headerElem.innerHTML = '';
                bodyElem.innerHTML = '<tr><td colspan="100%" style="text-align: center; padding: 40px; color: #6b7280;">Nema podataka za trenutni mjesec</td></tr>';
                return;
            }

            // Build header
            let headerHtml = `
                <tr>
                    <th>Odjel</th>
                    <th>Radilište</th>
                    <th>Primka (m³)</th>
                    <th>Otprema (m³)</th>
                    <th>Razlika (m³)</th>
                </tr>
            `;
            headerElem.innerHTML = headerHtml;

            // Calculate totals
            let totalPrimka = 0;
            let totalOtprema = 0;

            // Build body
            let bodyHtml = '';
            odjeli.forEach((odjel, index) => {
                const rowBg = index % 2 === 0 ? '#f9fafb' : 'white';
                const razlika = odjel.primka - odjel.otprema;

                totalPrimka += odjel.primka;
                totalOtprema += odjel.otprema;

                let razlikaColor = '#6b7280';
                if (razlika > 0) razlikaColor = '#059669';
                else if (razlika < 0) razlikaColor = '#dc2626';

                bodyHtml += `
                    <tr style="background: ${rowBg};">
                        <td style="font-weight: 600;">${odjel.odjel}</td>
                        <td>${odjel.radiliste}</td>
                        <td style="text-align: right; font-family: 'Courier New', monospace; color: #059669; font-weight: 600;">${odjel.primka.toFixed(2)}</td>
                        <td style="text-align: right; font-family: 'Courier New', monospace; color: #dc2626; font-weight: 600;">${odjel.otprema.toFixed(2)}</td>
                        <td style="text-align: right; font-family: 'Courier New', monospace; color: ${razlikaColor}; font-weight: 700;">${razlika.toFixed(2)}</td>
                    </tr>
                `;
            });

            // Add totals row
            const totalRazlika = totalPrimka - totalOtprema;
            let totalRazlikaColor = '#6b7280';
            if (totalRazlika > 0) totalRazlikaColor = '#059669';
            else if (totalRazlika < 0) totalRazlikaColor = '#dc2626';

            bodyHtml += `
                <tr style="background: #f3f4f6; border-top: 2px solid #1e40af;">
                    <td colspan="2" style="font-weight: 700; text-align: right;">UKUPNO:</td>
                    <td style="text-align: right; font-family: 'Courier New', monospace; color: #059669; font-weight: 700;">${totalPrimka.toFixed(2)}</td>
                    <td style="text-align: right; font-family: 'Courier New', monospace; color: #dc2626; font-weight: 700;">${totalOtprema.toFixed(2)}</td>
                    <td style="text-align: right; font-family: 'Courier New', monospace; color: ${totalRazlikaColor}; font-weight: 700;">${totalRazlika.toFixed(2)}</td>
                </tr>
            `;

            bodyElem.innerHTML = bodyHtml;
        }

        // Render Suma Mjeseca po Radilištima
        function renderPoslovodjaSumaRadilisteTable(radilista) {
            const headerElem = document.getElementById('poslovodja-suma-radiliste-header');
            const bodyElem = document.getElementById('poslovodja-suma-radiliste-body');

            if (radilista.length === 0) {
                headerElem.innerHTML = '';
                bodyElem.innerHTML = '<tr><td colspan="100%" style="text-align: center; padding: 40px; color: #6b7280;">Nema podataka za trenutni mjesec</td></tr>';
                return;
            }

            // Build header
            let headerHtml = `
                <tr>
                    <th>Radilište</th>
                    <th>Primka (m³)</th>
                    <th>Otprema (m³)</th>
                    <th>Razlika (m³)</th>
                </tr>
            `;
            headerElem.innerHTML = headerHtml;

            // Calculate totals
            let totalPrimka = 0;
            let totalOtprema = 0;

            // Build body
            let bodyHtml = '';
            radilista.forEach((radiliste, index) => {
                const rowBg = index % 2 === 0 ? '#f9fafb' : 'white';
                const razlika = radiliste.primka - radiliste.otprema;

                totalPrimka += radiliste.primka;
                totalOtprema += radiliste.otprema;

                let razlikaColor = '#6b7280';
                if (razlika > 0) razlikaColor = '#059669';
                else if (razlika < 0) razlikaColor = '#dc2626';

                bodyHtml += `
                    <tr style="background: ${rowBg};">
                        <td style="font-weight: 600;">${radiliste.radiliste}</td>
                        <td style="text-align: right; font-family: 'Courier New', monospace; color: #059669; font-weight: 600;">${radiliste.primka.toFixed(2)}</td>
                        <td style="text-align: right; font-family: 'Courier New', monospace; color: #dc2626; font-weight: 600;">${radiliste.otprema.toFixed(2)}</td>
                        <td style="text-align: right; font-family: 'Courier New', monospace; color: ${razlikaColor}; font-weight: 700;">${razlika.toFixed(2)}</td>
                    </tr>
                `;
            });

            // Add totals row
            const totalRazlika = totalPrimka - totalOtprema;
            let totalRazlikaColor = '#6b7280';
            if (totalRazlika > 0) totalRazlikaColor = '#059669';
            else if (totalRazlika < 0) totalRazlikaColor = '#dc2626';

            bodyHtml += `
                <tr style="background: #f3f4f6; border-top: 2px solid #1e40af;">
                    <td style="font-weight: 700; text-align: right;">UKUPNO:</td>
                    <td style="text-align: right; font-family: 'Courier New', monospace; color: #059669; font-weight: 700;">${totalPrimka.toFixed(2)}</td>
                    <td style="text-align: right; font-family: 'Courier New', monospace; color: #dc2626; font-weight: 700;">${totalOtprema.toFixed(2)}</td>
                    <td style="text-align: right; font-family: 'Courier New', monospace; color: ${totalRazlikaColor}; font-weight: 700;">${totalRazlika.toFixed(2)}</td>
                </tr>
            `;

            bodyElem.innerHTML = bodyHtml;
        }

        // Load primaci data
        async function loadPrimaci() {
            document.getElementById('loading-screen').classList.remove('hidden');
            document.getElementById('primaci-content').classList.add('hidden');

            try {
                const year = new Date().getFullYear();
                const url = `${API_URL}?path=primaci&year=${year}&username=${currentUser.username}&password=${currentPassword}`;
                const data = await fetchWithCache(url, 'cache_primaci_' + year);

                // Calculate totals per month
                const monthTotals = new Array(12).fill(0);
                let grandTotal = 0;

                data.primaci.forEach(p => {
                    p.mjeseci.forEach((val, idx) => {
                        monthTotals[idx] += val;
                    });
                    grandTotal += p.ukupno;
                });

                // Create header with sticky styling
                const headerHTML = `
                    <tr>
                        <th style="position: sticky; left: 0; background: #059669; z-index: 20; border-right: 3px solid #047857; min-width: 150px;">
                            👷 Primač
                        </th>
                        ${data.mjeseci.map((m, idx) => `
                            <th class="right" style="min-width: 80px; background: #059669; color: white; font-weight: 700; border: 1px solid #047857;">
                                ${m}
                            </th>
                        `).join('')}
                        <th class="right" style="min-width: 100px; background: #047857; color: white; font-weight: 900; border: 2px solid #065f46;">
                            📊 UKUPNO
                        </th>
                    </tr>
                `;
                document.getElementById('primaci-header').innerHTML = headerHTML;

                // Create body with enhanced styling
                const bodyHTML = data.primaci.map((p, idx) => {
                    const rowBg = idx % 2 === 0 ? '#f0fdf4' : 'white';
                    const hoverBg = idx % 2 === 0 ? '#dcfce7' : '#f0fdf4';

                    return `
                        <tr style="background: ${rowBg}; transition: all 0.2s;" onmouseover="this.style.background='${hoverBg}'" onmouseout="this.style.background='${rowBg}'">
                            <td style="font-weight: 600; position: sticky; left: 0; background: ${rowBg}; z-index: 10; border-right: 2px solid #059669; padding: 10px; font-size: 11px;">
                                ${p.primac}
                            </td>
                            ${p.mjeseci.map((v, mIdx) => {
                                const displayVal = v > 0 ? v.toFixed(2) : '-';
                                const fontWeight = v > 0 ? 'font-weight: 500;' : 'color: #9ca3af;';
                                return `<td class="right" style="${fontWeight} border: 1px solid #d1fae5; padding: 8px; font-size: 10px; font-family: 'Courier New', monospace;">${displayVal}</td>`;
                            }).join('')}
                            <td class="right" style="font-weight: 700; background: linear-gradient(to right, #d1fae5, #a7f3d0); border: 2px solid #059669; padding: 10px; font-size: 11px; color: #065f46;">
                                ${p.ukupno.toFixed(2)} m³
                            </td>
                        </tr>
                    `;
                }).join('');

                // Add totals row with softer colors
                const totalsRow = `
                    <tr style="background: linear-gradient(to bottom, #d1fae5, #a7f3d0); color: #065f46; font-weight: 700; border-top: 3px solid #34d399;">
                        <td style="position: sticky; left: 0; background: #d1fae5; z-index: 10; border-right: 3px solid #34d399; padding: 12px; font-size: 12px;">
                            📈 UKUPNO
                        </td>
                        ${monthTotals.map(total => `
                            <td class="right" style="border: 1px solid #6ee7b7; padding: 10px; font-size: 11px;">
                                ${total > 0 ? total.toFixed(2) : '-'}
                            </td>
                        `).join('')}
                        <td class="right" style="background: #a7f3d0; border: 2px solid #34d399; padding: 12px; font-size: 13px; font-weight: 900;">
                            ${grandTotal.toFixed(2)} m³
                        </td>
                    </tr>
                `;

                document.getElementById('primaci-body').innerHTML = bodyHTML + totalsRow;

                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('primaci-content').classList.remove('hidden');

            } catch (error) {
                showError('Greška', 'Greška pri učitavanju primača: ' + error.message);
                document.getElementById('loading-screen').innerHTML = '<div class="loading-icon">❌</div><div class="loading-text">Greška pri učitavanju</div><div class="loading-sub">' + error.message + '</div>';
            }
        }

        // Load otpremaci data
        async function loadOtpremaci() {
            document.getElementById('loading-screen').classList.remove('hidden');
            document.getElementById('otpremaci-content').classList.add('hidden');

            try {
                const year = new Date().getFullYear();
                const url = `${API_URL}?path=otpremaci&year=${year}&username=${currentUser.username}&password=${currentPassword}`;
                const data = await fetchWithCache(url, 'cache_otpremaci_' + year);

                // Calculate totals per month
                const monthTotals = new Array(12).fill(0);
                let grandTotal = 0;

                data.otpremaci.forEach(o => {
                    o.mjeseci.forEach((val, idx) => {
                        monthTotals[idx] += val;
                    });
                    grandTotal += o.ukupno;
                });

                // Create header with sticky styling (blue theme)
                const headerHTML = `
                    <tr>
                        <th style="position: sticky; left: 0; background: #2563eb; z-index: 20; border-right: 3px solid #1e40af; min-width: 150px;">
                            🚛 Otpremač
                        </th>
                        ${data.mjeseci.map((m, idx) => `
                            <th class="right" style="min-width: 80px; background: #2563eb; color: white; font-weight: 700; border: 1px solid #1e40af;">
                                ${m}
                            </th>
                        `).join('')}
                        <th class="right" style="min-width: 100px; background: #1e40af; color: white; font-weight: 900; border: 2px solid #1e3a8a;">
                            📊 UKUPNO
                        </th>
                    </tr>
                `;
                document.getElementById('otpremaci-header').innerHTML = headerHTML;

                // Create body with enhanced styling (blue theme)
                const bodyHTML = data.otpremaci.map((o, idx) => {
                    const rowBg = idx % 2 === 0 ? '#eff6ff' : 'white';
                    const hoverBg = idx % 2 === 0 ? '#dbeafe' : '#eff6ff';

                    return `
                        <tr style="background: ${rowBg}; transition: all 0.2s;" onmouseover="this.style.background='${hoverBg}'" onmouseout="this.style.background='${rowBg}'">
                            <td style="font-weight: 600; position: sticky; left: 0; background: ${rowBg}; z-index: 10; border-right: 2px solid #2563eb; padding: 10px; font-size: 11px;">
                                ${o.otpremac}
                            </td>
                            ${o.mjeseci.map((v, mIdx) => {
                                const displayVal = v > 0 ? v.toFixed(2) : '-';
                                const fontWeight = v > 0 ? 'font-weight: 500;' : 'color: #9ca3af;';
                                return `<td class="right" style="${fontWeight} border: 1px solid #dbeafe; padding: 8px; font-size: 10px; font-family: 'Courier New', monospace;">${displayVal}</td>`;
                            }).join('')}
                            <td class="right" style="font-weight: 700; background: linear-gradient(to right, #dbeafe, #bfdbfe); border: 2px solid #2563eb; padding: 10px; font-size: 11px; color: #1e40af;">
                                ${o.ukupno.toFixed(2)} m³
                            </td>
                        </tr>
                    `;
                }).join('');

                // Add totals row with softer colors
                const totalsRow = `
                    <tr style="background: linear-gradient(to bottom, #dbeafe, #bfdbfe); color: #1e40af; font-weight: 700; border-top: 3px solid #60a5fa;">
                        <td style="position: sticky; left: 0; background: #dbeafe; z-index: 10; border-right: 3px solid #60a5fa; padding: 12px; font-size: 12px;">
                            📈 UKUPNO
                        </td>
                        ${monthTotals.map(total => `
                            <td class="right" style="border: 1px solid #93c5fd; padding: 10px; font-size: 11px;">
                                ${total > 0 ? total.toFixed(2) : '-'}
                            </td>
                        `).join('')}
                        <td class="right" style="background: #bfdbfe; border: 2px solid #60a5fa; padding: 12px; font-size: 13px; font-weight: 900;">
                            ${grandTotal.toFixed(2)} m³
                        </td>
                    </tr>
                `;

                document.getElementById('otpremaci-body').innerHTML = bodyHTML + totalsRow;

                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('otpremaci-content').classList.remove('hidden');

            } catch (error) {
                showError('Greška', 'Greška pri učitavanju otpremača: ' + error.message);
                document.getElementById('loading-screen').innerHTML = '<div class="loading-icon">❌</div><div class="loading-text">Greška pri učitavanju</div><div class="loading-sub">' + error.message + '</div>';
            }
        }

        // Helper function to get month name
        function getMonthName(monthIndex) {
            const months = ['Januar', 'Februar', 'Mart', 'April', 'Maj', 'Juni',
                           'Juli', 'Avgust', 'Septembar', 'Oktobar', 'Novembar', 'Decembar'];
            return months[monthIndex];
        }

        // Load primaci daily data (for selected month)
        async function loadPrimaciDaily(selectedMonth) {
            try {
                const now = new Date();
                const year = now.getFullYear();
                const month = selectedMonth !== undefined ? parseInt(selectedMonth) : now.getMonth(); // 0-11

                // Set the selected month in the dropdown
                const monthSelect = document.getElementById('primaci-month-select');
                if (monthSelect) {
                    monthSelect.value = month;
                }

                const url = `${API_URL}?path=primaci-daily&year=${year}&month=${month}&username=${currentUser.username}&password=${currentPassword}`;
                console.log('Loading primaci daily from:', url);
                const data = await fetchWithCache(url, `cache_primaci_daily_${year}_${month}`);

                console.log('Primaci daily data received:', data);

                if (data.error) {
                    console.error('Error loading primaci daily:', data.error);
                    document.getElementById('primaci-daily-body').innerHTML = `
                        <tr><td colspan="100" style="text-align: center; padding: 40px; color: #dc2626;">
                            Greška: ${data.error}
                        </td></tr>
                    `;
                    return;
                }

                if (!data.data || data.data.length === 0) {
                    console.log('No data available for current month');
                    document.getElementById('primaci-daily-header').innerHTML = `
                        <tr>
                            <th style="background: #ea580c; color: white; padding: 12px;">
                                📅 Sječa po danima - ${getMonthName(month)} ${year}
                            </th>
                        </tr>
                    `;
                    document.getElementById('primaci-daily-body').innerHTML = `
                        <tr><td style="text-align: center; padding: 40px; color: #6b7280;">
                            Nema podataka za tekući mjesec
                        </td></tr>
                    `;
                    return;
                }

                // ✅ NOVO: Header bez kolone Datum
                const headerHTML = `
                    <tr>
                        <th style="position: sticky; top: 0; left: 0; background: linear-gradient(135deg, #ea580c 0%, #dc2626 100%); z-index: 30; border-right: 3px solid #7c2d12; min-width: 70px; box-shadow: 2px 0 5px rgba(0,0,0,0.1); font-size: 10px; padding: 8px 6px; font-weight: 800; color: white; text-transform: uppercase; letter-spacing: 0.5px;">
                            🏢 Odjel
                        </th>
                        <th style="position: sticky; top: 0; min-width: 110px; background: linear-gradient(135deg, #ea580c 0%, #dc2626 100%); color: white; font-weight: 800; border: 1px solid #7c2d12; font-size: 10px; padding: 8px 6px; z-index: 20; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-transform: uppercase; letter-spacing: 0.5px;">
                            👷 Primač
                        </th>
                        ${data.sortimentiNazivi.map(s => `
                            <th style="position: sticky; top: 0; min-width: 52px; background: linear-gradient(135deg, #ea580c 0%, #dc2626 100%); color: white; font-weight: 700; border: 1px solid #7c2d12; font-size: 8.5px; padding: 8px 3px; z-index: 20; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-transform: uppercase; line-height: 1.1;">
                                ${s}
                            </th>
                        `).join('')}
                    </tr>
                `;
                document.getElementById('primaci-daily-header').innerHTML = headerHTML;

                // ✅ NOVO: Grupiši podatke po datumu
                const groupedByDate = {};
                data.data.forEach(row => {
                    if (!groupedByDate[row.datum]) {
                        groupedByDate[row.datum] = [];
                    }
                    groupedByDate[row.datum].push(row);
                });

                // ✅ NOVO: Helper funkcija za dan u sedmici
                function getDayName(dateStr) {
                    const parts = dateStr.split('.');
                    const day = parseInt(parts[0]);
                    const month = parseInt(parts[1]) - 1;
                    const yearPart = parts[2] ? parseInt(parts[2]) : year;
                    const date = new Date(yearPart, month, day);
                    const days = ['Nedjelja', 'Ponedjeljak', 'Utorak', 'Srijeda', 'Četvrtak', 'Petak', 'Subota'];
                    return days[date.getDay()];
                }

                // ✅ NOVO: Build body sa grupisanjem po datumu
                let bodyHTML = '';
                const dates = Object.keys(groupedByDate).sort((a, b) => {
                    const [dayA, monthA] = a.split('.').map(Number);
                    const [dayB, monthB] = b.split('.').map(Number);
                    return monthA !== monthB ? monthB - monthA : dayB - dayA;  // Obrnut redosled - od najnovijeg ka najstarijem
                });

                dates.forEach(datum => {
                    const rows = groupedByDate[datum];
                    const dayName = getDayName(datum);

                    // ✅ Zaglavlje datuma
                    const numSortimenti = data.sortimentiNazivi.length;
                    bodyHTML += `
                        <tr style="background: linear-gradient(135deg, #c2410c 0%, #9a3412 50%, #7c2d12 100%); box-shadow: 0 2px 8px rgba(124, 45, 18, 0.4);">
                            <td colspan="${2 + numSortimenti}" style="font-weight: 800; font-size: 14px; padding: 10px 12px; text-align: center; border-top: 3px solid #451a03; color: white; letter-spacing: 1px; text-shadow: 0 2px 4px rgba(0,0,0,0.5);">
                                📅 ${datum} - ${dayName}
                            </td>
                        </tr>
                    `;

                    // ✅ Kalkuliši totale za ovaj dan
                    const dailyTotals = {};
                    data.sortimentiNazivi.forEach(s => dailyTotals[s] = 0);
                    rows.forEach(row => {
                        data.sortimentiNazivi.forEach(s => {
                            dailyTotals[s] += row.sortimenti[s] || 0;
                        });
                    });

                    // 🎨 EXPERT: Data rows sa hover animations
                    rows.forEach((row, idx) => {
                        const rowBg = idx % 2 === 0 ? '#fff7ed' : '#ffffff';
                        const hoverBg = '#ffedd5';

                        const sortimentiCells = data.sortimentiNazivi.map(sortiment => {
                            const val = row.sortimenti[sortiment] || 0;
                            const displayVal = val > 0 ? val.toFixed(2) : '-';
                            const fontWeight = val > 0 ? 'font-weight: 600; color: #7c2d12;' : 'color: #d1d5db;';
                            return `<td style="${fontWeight} border: 1px solid #fed7aa; font-family: 'Courier New', monospace; font-size: 10px; text-align: right; padding: 6px 3px; transition: all 0.15s;">${displayVal}</td>`;
                        }).join('');

                        bodyHTML += `
                            <tr style="background: ${rowBg}; transition: all 0.15s ease;" onmouseover="this.style.background='${hoverBg}'; this.style.transform='scale(1.005)'; this.style.boxShadow='0 2px 8px rgba(234,88,12,0.15)';" onmouseout="this.style.background='${rowBg}'; this.style.transform='scale(1)'; this.style.boxShadow='none';">
                                <td style="font-weight: 700; font-size: 10px; position: sticky; left: 0; background: ${rowBg}; z-index: 10; border-right: 2px solid #ea580c; padding: 6px 5px; border: 1px solid #fed7aa; color: #7c2d12; box-shadow: 2px 0 3px rgba(0,0,0,0.05);">
                                    ${row.odjel}
                                </td>
                                <td style="font-weight: 600; font-size: 10px; border: 1px solid #fed7aa; padding: 6px 5px; color: #9a3412;">${row.primac}</td>
                                ${sortimentiCells}
                            </tr>
                        `;
                    });

                    // 🎨 EXPERT: Daily recap sa gradient i shadow
                    const dailyTotalsCells = data.sortimentiNazivi.map(s => {
                        const val = dailyTotals[s];
                        const displayVal = val > 0 ? val.toFixed(2) : '-';
                        return `<td style="border: 1px solid #fb923c; font-family: 'Courier New', monospace; font-size: 10px; text-align: right; padding: 7px 3px; font-weight: 800; background: #fed7aa; color: #7c2d12;">${displayVal}</td>`;
                    }).join('');

                    bodyHTML += `
                        <tr style="background: linear-gradient(to bottom, #fed7aa 0%, #fdba74 100%); box-shadow: 0 1px 4px rgba(251,146,60,0.3);">
                            <td style="position: sticky; left: 0; background: linear-gradient(to right, #fed7aa 0%, #fdba74 100%); z-index: 10; border-right: 2px solid #ea580c; padding: 8px 5px; font-size: 11px; font-weight: 800; color: #7c2d12; box-shadow: 2px 0 4px rgba(0,0,0,0.1);">
                                📊 UKUPNO ${datum}
                            </td>
                            <td style="background: transparent;"></td>
                            ${dailyTotalsCells}
                        </tr>
                    `;
                });

                // ✅ Grand total za cijeli mjesec (na kraju)
                const grandTotals = {};
                data.sortimentiNazivi.forEach(s => grandTotals[s] = 0);
                data.data.forEach(row => {
                    data.sortimentiNazivi.forEach(s => {
                        grandTotals[s] += row.sortimenti[s] || 0;
                    });
                });

                const grandTotalsCells = data.sortimentiNazivi.map(s => {
                    const val = grandTotals[s];
                    const displayVal = val > 0 ? val.toFixed(2) : '-';
                    return `<td style="border: 2px solid #7c2d12; font-family: 'Courier New', monospace; text-align: right; padding: 9px 3px; font-weight: 800; font-size: 11px; background: #dcfce7; color: #065f46;">${displayVal}</td>`;
                }).join('');

                bodyHTML += `
                    <tr style="background: linear-gradient(135deg, #16a34a 0%, #059669 50%, #047857 100%); color: white; font-weight: 800; border-top: 4px solid #065f46; box-shadow: 0 -2px 8px rgba(22,163,74,0.3);">
                        <td colspan="2" style="padding: 12px; font-size: 13px; text-align: center; font-weight: 900; letter-spacing: 1.5px; text-shadow: 0 1px 3px rgba(0,0,0,0.4);">
                            📈 UKUPNO ${getMonthName(month).toUpperCase()}
                        </td>
                        ${grandTotalsCells}
                    </tr>
                `;

                document.getElementById('primaci-daily-body').innerHTML = bodyHTML;

                console.log('Primaci daily table rendered with', data.data.length, 'rows');

            } catch (error) {
                console.error('Error in loadPrimaciDaily:', error);
                document.getElementById('primaci-daily-body').innerHTML = `
                    <tr><td colspan="100" style="text-align: center; padding: 40px; color: #dc2626;">
                        Greška pri učitavanju: ${error.message}
                    </td></tr>
                `;
            }
        }

        // Load otpremaci daily data (for selected month)
        async function loadOtremaciDaily(selectedMonth) {
            try {
                const now = new Date();
                const year = now.getFullYear();
                const month = selectedMonth !== undefined ? parseInt(selectedMonth) : now.getMonth(); // 0-11

                // Set the selected month in the dropdown
                const monthSelect = document.getElementById('otpremaci-month-select');
                if (monthSelect) {
                    monthSelect.value = month;
                }

                const url = `${API_URL}?path=otpremaci-daily&year=${year}&month=${month}&username=${currentUser.username}&password=${currentPassword}`;
                console.log('Loading otpremaci daily from:', url);
                const data = await fetchWithCache(url, `cache_otpremaci_daily_${year}_${month}`);

                console.log('Otpremaci daily data received:', data);

                if (data.error) {
                    console.error('Error loading otpremaci daily:', data.error);
                    document.getElementById('otpremaci-daily-body').innerHTML = `
                        <tr><td colspan="100" style="text-align: center; padding: 40px; color: #dc2626;">
                            Greška: ${data.error}
                        </td></tr>
                    `;
                    return;
                }

                if (!data.data || data.data.length === 0) {
                    console.log('No data available for current month');
                    document.getElementById('otpremaci-daily-header').innerHTML = `
                        <tr>
                            <th style="background: #0891b2; color: white; padding: 12px;">
                                📅 Otprema po danima - ${getMonthName(month)} ${year}
                            </th>
                        </tr>
                    `;
                    document.getElementById('otpremaci-daily-body').innerHTML = `
                        <tr><td style="text-align: center; padding: 40px; color: #6b7280;">
                            Nema podataka za tekući mjesec
                        </td></tr>
                    `;
                    return;
                }

                // ✅ NOVO: Header bez kolone Datum
                const headerHTML = `
                    <tr>
                        <th style="position: sticky; top: 0; left: 0; background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%); z-index: 30; border-right: 3px solid #164e63; min-width: 70px; box-shadow: 2px 0 5px rgba(0,0,0,0.1); font-size: 10px; padding: 8px 6px; font-weight: 800; color: white; text-transform: uppercase; letter-spacing: 0.5px;">
                            🏢 Odjel
                        </th>
                        <th style="position: sticky; top: 0; min-width: 105px; background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%); color: white; font-weight: 800; border: 1px solid #164e63; font-size: 9px; padding: 8px 6px; z-index: 20; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-transform: uppercase; letter-spacing: 0.5px;">
                            🚛 Otpremač
                        </th>
                        <th style="position: sticky; top: 0; min-width: 105px; background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%); color: white; font-weight: 800; border: 1px solid #164e63; font-size: 9px; padding: 8px 6px; z-index: 20; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-transform: uppercase; letter-spacing: 0.5px;">
                            👤 Kupac
                        </th>
                        ${data.sortimentiNazivi.map(s => `
                            <th style="position: sticky; top: 0; min-width: 52px; background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%); color: white; font-weight: 700; border: 1px solid #164e63; font-size: 8.5px; padding: 8px 3px; z-index: 20; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-transform: uppercase; line-height: 1.1;">
                                ${s}
                            </th>
                        `).join('')}
                    </tr>
                `;
                document.getElementById('otpremaci-daily-header').innerHTML = headerHTML;

                // ✅ NOVO: Grupiši podatke po datumu
                const groupedByDate = {};
                data.data.forEach(row => {
                    if (!groupedByDate[row.datum]) {
                        groupedByDate[row.datum] = [];
                    }
                    groupedByDate[row.datum].push(row);
                });

                // ✅ NOVO: Helper funkcija za dan u sedmici
                function getDayName(dateStr) {
                    const parts = dateStr.split('.');
                    const day = parseInt(parts[0]);
                    const month = parseInt(parts[1]) - 1;
                    const yearPart = parts[2] ? parseInt(parts[2]) : year;
                    const date = new Date(yearPart, month, day);
                    const days = ['Nedjelja', 'Ponedjeljak', 'Utorak', 'Srijeda', 'Četvrtak', 'Petak', 'Subota'];
                    return days[date.getDay()];
                }

                // ✅ NOVO: Build body sa grupisanjem po datumu
                let bodyHTML = '';
                const dates = Object.keys(groupedByDate).sort((a, b) => {
                    const [dayA, monthA] = a.split('.').map(Number);
                    const [dayB, monthB] = b.split('.').map(Number);
                    return monthA !== monthB ? monthB - monthA : dayB - dayA;  // Obrnut redosled - od najnovijeg ka najstarijem
                });

                dates.forEach(datum => {
                    const rows = groupedByDate[datum];
                    const dayName = getDayName(datum);

                    // ✅ Zaglavlje datuma
                    const numSortimenti = data.sortimentiNazivi.length;
                    bodyHTML += `
                        <tr style="background: linear-gradient(135deg, #0e7490 0%, #155e75 50%, #164e63 100%); box-shadow: 0 2px 8px rgba(22, 78, 99, 0.4);">
                            <td colspan="${3 + numSortimenti}" style="font-weight: 800; font-size: 14px; padding: 10px 12px; text-align: center; border-top: 3px solid #083344; color: white; letter-spacing: 1px; text-shadow: 0 2px 4px rgba(0,0,0,0.5);">
                                📅 ${datum} - ${dayName}
                            </td>
                        </tr>
                    `;

                    // ✅ Kalkuliši totale za ovaj dan
                    const dailyTotals = {};
                    data.sortimentiNazivi.forEach(s => dailyTotals[s] = 0);
                    rows.forEach(row => {
                        data.sortimentiNazivi.forEach(s => {
                            dailyTotals[s] += row.sortimenti[s] || 0;
                        });
                    });

                    // ✅ Redovi za ovaj dan (bez kolone Datum)
                    rows.forEach((row, idx) => {
                        const rowBg = idx % 2 === 0 ? '#ecfeff' : '#ffffff';
                        const hoverBg = '#cffafe';

                        const sortimentiCells = data.sortimentiNazivi.map(sortiment => {
                            const val = row.sortimenti[sortiment] || 0;
                            const displayVal = val > 0 ? val.toFixed(2) : '-';
                            const fontWeight = val > 0 ? 'font-weight: 600; color: #164e63;' : 'color: #d1d5db;';
                            return `<td style="${fontWeight} border: 1px solid #a5f3fc; font-family: 'Courier New', monospace; font-size: 10px; text-align: right; padding: 6px 3px; transition: all 0.15s;">${displayVal}</td>`;
                        }).join('');

                        bodyHTML += `
                            <tr style="background: ${rowBg}; transition: all 0.15s ease;" onmouseover="this.style.background='${hoverBg}'; this.style.transform='scale(1.005)'; this.style.boxShadow='0 2px 8px rgba(8,145,178,0.15)';" onmouseout="this.style.background='${rowBg}'; this.style.transform='scale(1)'; this.style.boxShadow='none';">
                                <td style="font-weight: 700; font-size: 10px; position: sticky; left: 0; background: ${rowBg}; z-index: 10; border-right: 2px solid #0891b2; padding: 6px 5px; border: 1px solid #a5f3fc; color: #164e63; box-shadow: 2px 0 3px rgba(0,0,0,0.05);">
                                    ${row.odjel}
                                </td>
                                <td style="font-weight: 600; font-size: 10px; border: 1px solid #a5f3fc; padding: 6px 5px; color: #0e7490;">${row.otpremac}</td>
                                <td style="border: 1px solid #a5f3fc; color: #155e75; font-weight: 600; font-size: 10px; padding: 6px 5px;">${row.kupac || '-'}</td>
                                ${sortimentiCells}
                            </tr>
                        `;
                    });

                    // ✅ Rekapitulacija za ovaj dan
                    const dailyTotalsCells = data.sortimentiNazivi.map(s => {
                        const val = dailyTotals[s];
                        const displayVal = val > 0 ? val.toFixed(2) : '-';
                        return `<td style="border: 1px solid #22d3ee; font-family: 'Courier New', monospace; text-align: right; padding: 7px 3px; font-size: 10px; font-weight: 800; color: #164e63; background: #a5f3fc;">${displayVal}</td>`;
                    }).join('');

                    bodyHTML += `
                        <tr style="background: linear-gradient(to bottom, #a5f3fc, #67e8f9); color: #0e7490; font-weight: 700;">
                            <td style="position: sticky; left: 0; background: #a5f3fc; z-index: 10; border-right: 2px solid #0891b2; padding: 10px; font-size: 13px;">
                                📊 UKUPNO ${datum}
                            </td>
                            <td style="background: transparent;"></td>
                            <td style="background: #a5f3fc;"></td>
                            ${dailyTotalsCells}
                        </tr>
                    `;
                });

                // ✅ Grand total za cijeli mjesec (na kraju)
                const grandTotals = {};
                data.sortimentiNazivi.forEach(s => grandTotals[s] = 0);
                data.data.forEach(row => {
                    data.sortimentiNazivi.forEach(s => {
                        grandTotals[s] += row.sortimenti[s] || 0;
                    });
                });

                const grandTotalsCells = data.sortimentiNazivi.map(s => {
                    const val = grandTotals[s];
                    const displayVal = val > 0 ? val.toFixed(2) : '-';
                    return `<td style="border: 2px solid #164e63; font-family: 'Courier New', monospace; text-align: right; padding: 9px 3px; font-weight: 800; font-size: 11px; background: #bfdbfe; color: #1e3a8a;">${displayVal}</td>`;
                }).join('');

                bodyHTML += `
                    <tr style="background: linear-gradient(135deg, #0e7490, #0891b2); color: white; font-weight: 700; border-top: 4px solid #164e63;">
                        <td colspan="3" style="padding: 12px; font-size: 13px; font-weight: 900; letter-spacing: 1.5px; text-shadow: 0 1px 3px rgba(0,0,0,0.4); text-align: center;">
                            📈 UKUPNO ${getMonthName(month).toUpperCase()}
                        </td>
                        ${grandTotalsCells}
                    </tr>
                `;

                document.getElementById('otpremaci-daily-body').innerHTML = bodyHTML;

                console.log('Otpremaci daily table rendered with', data.data.length, 'rows');

            } catch (error) {
                console.error('Error in loadOtremaciDaily:', error);
                document.getElementById('otpremaci-daily-body').innerHTML = `
                    <tr><td colspan="100" style="text-align: center; padding: 40px; color: #dc2626;">
                        Greška pri učitavanju: ${error.message}
                    </td></tr>
                `;
            }
        }

        // ========================================
        // PRIKAZI PO RADILIŠTIMA I IZVOĐAČIMA
        // ========================================

        // Load primaci by radiliste
        async function loadPrimaciByRadiliste() {
            try {
                const year = new Date().getFullYear();
                const url = `${API_URL}?path=primaci-by-radiliste&year=${year}&username=${currentUser.username}&password=${currentPassword}`;

                const data = await fetchWithCache(url, `cache_primaci_radiliste_${year}`);

                console.log('Primaci by radiliste data received:', data);

                if (data.error) {
                    console.error('Error loading primaci by radiliste:', data.error);
                    document.getElementById('primaci-radilista-body').innerHTML = `
                        <tr><td colspan="100" style="text-align: center; padding: 40px; color: #dc2626;">
                            Greška: ${data.error}
                        </td></tr>
                    `;
                    return;
                }

                if (!data.radilista || data.radilista.length === 0) {
                    document.getElementById('primaci-radilista-header').innerHTML = `
                        <tr><th style="background: #ea580c; color: white; padding: 12px;">
                            🏗️ Prikaz po radilištima - ${year}
                        </th></tr>
                    `;
                    document.getElementById('primaci-radilista-body').innerHTML = `
                        <tr><td style="text-align: center; padding: 40px; color: #6b7280;">
                            Nema podataka o radilištima
                        </td></tr>
                    `;
                    return;
                }

                // Render mjesečnu tabelu
                const mjeseci = ['Jan', 'Feb', 'Mar', 'Apr', 'Maj', 'Jun', 'Jul', 'Avg', 'Sep', 'Okt', 'Nov', 'Dec'];

                let headerHTML = `
                    <tr>
                        <th style="background: linear-gradient(135deg, #ea580c, #dc2626); color: white; padding: 12px; position: sticky; top: 0; z-index: 20;">
                            🏗️ Radilište
                        </th>
                `;
                mjeseci.forEach(mj => {
                    headerHTML += `<th style="background: linear-gradient(135deg, #ea580c, #dc2626); color: white; padding: 12px; position: sticky; top: 0; z-index: 20; font-size: 12px;">${mj}</th>`;
                });
                headerHTML += `
                    <th style="background: linear-gradient(135deg, #7c2d12, #451a03); color: white; padding: 12px; font-weight: 900; position: sticky; top: 0; z-index: 20;">
                        UKUPNO
                    </th>
                </tr>
                `;
                document.getElementById('primaci-radilista-header').innerHTML = headerHTML;

                let bodyHTML = '';
                data.radilista.forEach((radiliste, idx) => {
                    const rowBg = idx % 2 === 0 ? '#fff7ed' : '#ffffff';
                    const hoverBg = '#ffedd5';

                    const mjeseciCells = radiliste.mjeseci.map(val => {
                        const displayVal = val > 0 ? val.toFixed(2) : '-';
                        const fontWeight = val > 0 ? 'font-weight: 700; color: #7c2d12;' : 'color: #d1d5db;';
                        return `<td style="${fontWeight} border: 1px solid #fed7aa; font-family: 'Courier New', monospace; font-size: 11px; text-align: right; padding: 8px;">${displayVal}</td>`;
                    }).join('');

                    bodyHTML += `
                        <tr style="background: ${rowBg}; transition: all 0.15s ease;" onmouseover="this.style.background='${hoverBg}';" onmouseout="this.style.background='${rowBg}';">
                            <td style="font-weight: 700; font-size: 12px; border: 1px solid #fed7aa; padding: 10px; color: #7c2d12;">
                                ${radiliste.naziv}
                            </td>
                            ${mjeseciCells}
                            <td style="background: #fef3c7; border: 2px solid #f59e0b; font-family: 'Courier New', monospace; text-align: right; padding: 10px; font-weight: 900; font-size: 13px; color: #92400e;">
                                ${radiliste.ukupno.toFixed(2)}
                            </td>
                        </tr>
                    `;
                });
                document.getElementById('primaci-radilista-body').innerHTML = bodyHTML;

                // Render godišnju rekapitulaciju po sortimentima
                let recapHeaderHTML = `
                    <tr>
                        <th style="background: linear-gradient(135deg, #ea580c, #dc2626); color: white; padding: 12px; position: sticky; top: 0; z-index: 20;">
                            🏗️ Radilište
                        </th>
                `;
                data.sortimentiNazivi.forEach(s => {
                    recapHeaderHTML += `<th style="background: linear-gradient(135deg, #ea580c, #dc2626); color: white; padding: 12px; position: sticky; top: 0; z-index: 20; font-size: 10px;">${s}</th>`;
                });
                recapHeaderHTML += `</tr>`;
                document.getElementById('primaci-radilista-recap-header').innerHTML = recapHeaderHTML;

                let recapBodyHTML = '';
                data.radilista.forEach((radiliste, idx) => {
                    const rowBg = idx % 2 === 0 ? '#fff7ed' : '#ffffff';

                    const sortimentiCells = data.sortimentiNazivi.map(s => {
                        const val = radiliste.sortimentiUkupno[s] || 0;
                        const displayVal = val > 0 ? val.toFixed(2) : '-';
                        const fontWeight = val > 0 ? 'font-weight: 700; color: #7c2d12;' : 'color: #d1d5db;';
                        return `<td style="${fontWeight} border: 1px solid #fed7aa; font-family: 'Courier New', monospace; font-size: 10px; text-align: right; padding: 8px;">${displayVal}</td>`;
                    }).join('');

                    recapBodyHTML += `
                        <tr style="background: ${rowBg};">
                            <td style="font-weight: 700; font-size: 12px; border: 1px solid #fed7aa; padding: 10px; color: #7c2d12;">
                                ${radiliste.naziv}
                            </td>
                            ${sortimentiCells}
                        </tr>
                    `;
                });
                document.getElementById('primaci-radilista-recap-body').innerHTML = recapBodyHTML;

                console.log('Primaci by radiliste rendered');

            } catch (error) {
                console.error('Error in loadPrimaciByRadiliste:', error);
                document.getElementById('primaci-radilista-body').innerHTML = `
                    <tr><td colspan="100" style="text-align: center; padding: 40px; color: #dc2626;">
                        Greška pri učitavanju: ${error.message}
                    </td></tr>
                `;
            }
        }

        // Load primaci by izvodjac
        async function loadPrimaciByIzvodjac() {
            try {
                const year = new Date().getFullYear();
                const url = `${API_URL}?path=primaci-by-izvodjac&year=${year}&username=${currentUser.username}&password=${currentPassword}`;

                const data = await fetchWithCache(url, `cache_primaci_izvodjac_${year}`);

                console.log('Primaci by izvodjac data received:', data);

                if (data.error) {
                    console.error('Error loading primaci by izvodjac:', data.error);
                    document.getElementById('primaci-izvodjaci-body').innerHTML = `
                        <tr><td colspan="100" style="text-align: center; padding: 40px; color: #dc2626;">
                            Greška: ${data.error}
                        </td></tr>
                    `;
                    return;
                }

                if (!data.izvodjaci || data.izvodjaci.length === 0) {
                    document.getElementById('primaci-izvodjaci-header').innerHTML = `
                        <tr><th style="background: #ea580c; color: white; padding: 12px;">
                            👷 Prikaz po izvođačima - ${year}
                        </th></tr>
                    `;
                    document.getElementById('primaci-izvodjaci-body').innerHTML = `
                        <tr><td style="text-align: center; padding: 40px; color: #6b7280;">
                            Nema podataka o izvođačima
                        </td></tr>
                    `;
                    return;
                }

                // Render mjesečnu tabelu
                const mjeseci = ['Jan', 'Feb', 'Mar', 'Apr', 'Maj', 'Jun', 'Jul', 'Avg', 'Sep', 'Okt', 'Nov', 'Dec'];

                let headerHTML = `
                    <tr>
                        <th style="background: linear-gradient(135deg, #ea580c, #dc2626); color: white; padding: 12px; position: sticky; top: 0; z-index: 20;">
                            👷 Izvođač radova
                        </th>
                `;
                mjeseci.forEach(mj => {
                    headerHTML += `<th style="background: linear-gradient(135deg, #ea580c, #dc2626); color: white; padding: 12px; position: sticky; top: 0; z-index: 20; font-size: 12px;">${mj}</th>`;
                });
                headerHTML += `
                    <th style="background: linear-gradient(135deg, #7c2d12, #451a03); color: white; padding: 12px; font-weight: 900; position: sticky; top: 0; z-index: 20;">
                        UKUPNO
                    </th>
                </tr>
                `;
                document.getElementById('primaci-izvodjaci-header').innerHTML = headerHTML;

                let bodyHTML = '';
                data.izvodjaci.forEach((izvodjac, idx) => {
                    const rowBg = idx % 2 === 0 ? '#fff7ed' : '#ffffff';
                    const hoverBg = '#ffedd5';

                    const mjeseciCells = izvodjac.mjeseci.map(val => {
                        const displayVal = val > 0 ? val.toFixed(2) : '-';
                        const fontWeight = val > 0 ? 'font-weight: 700; color: #7c2d12;' : 'color: #d1d5db;';
                        return `<td style="${fontWeight} border: 1px solid #fed7aa; font-family: 'Courier New', monospace; font-size: 11px; text-align: right; padding: 8px;">${displayVal}</td>`;
                    }).join('');

                    bodyHTML += `
                        <tr style="background: ${rowBg}; transition: all 0.15s ease;" onmouseover="this.style.background='${hoverBg}';" onmouseout="this.style.background='${rowBg}';">
                            <td style="font-weight: 700; font-size: 12px; border: 1px solid #fed7aa; padding: 10px; color: #7c2d12;">
                                ${izvodjac.naziv}
                            </td>
                            ${mjeseciCells}
                            <td style="background: #fef3c7; border: 2px solid #f59e0b; font-family: 'Courier New', monospace; text-align: right; padding: 10px; font-weight: 900; font-size: 13px; color: #92400e;">
                                ${izvodjac.ukupno.toFixed(2)}
                            </td>
                        </tr>
                    `;
                });
                document.getElementById('primaci-izvodjaci-body').innerHTML = bodyHTML;

                // Render godišnju rekapitulaciju po sortimentima
                let recapHeaderHTML = `
                    <tr>
                        <th style="background: linear-gradient(135deg, #ea580c, #dc2626); color: white; padding: 12px; position: sticky; top: 0; z-index: 20;">
                            👷 Izvođač radova
                        </th>
                `;
                data.sortimentiNazivi.forEach(s => {
                    recapHeaderHTML += `<th style="background: linear-gradient(135deg, #ea580c, #dc2626); color: white; padding: 12px; position: sticky; top: 0; z-index: 20; font-size: 10px;">${s}</th>`;
                });
                recapHeaderHTML += `</tr>`;
                document.getElementById('primaci-izvodjaci-recap-header').innerHTML = recapHeaderHTML;

                let recapBodyHTML = '';
                data.izvodjaci.forEach((izvodjac, idx) => {
                    const rowBg = idx % 2 === 0 ? '#fff7ed' : '#ffffff';

                    const sortimentiCells = data.sortimentiNazivi.map(s => {
                        const val = izvodjac.sortimentiUkupno[s] || 0;
                        const displayVal = val > 0 ? val.toFixed(2) : '-';
                        const fontWeight = val > 0 ? 'font-weight: 700; color: #7c2d12;' : 'color: #d1d5db;';
                        return `<td style="${fontWeight} border: 1px solid #fed7aa; font-family: 'Courier New', monospace; font-size: 10px; text-align: right; padding: 8px;">${displayVal}</td>`;
                    }).join('');

                    recapBodyHTML += `
                        <tr style="background: ${rowBg};">
                            <td style="font-weight: 700; font-size: 12px; border: 1px solid #fed7aa; padding: 10px; color: #7c2d12;">
                                ${izvodjac.naziv}
                            </td>
                            ${sortimentiCells}
                        </tr>
                    `;
                });
                document.getElementById('primaci-izvodjaci-recap-body').innerHTML = recapBodyHTML;

                console.log('Primaci by izvodjac rendered');

            } catch (error) {
                console.error('Error in loadPrimaciByIzvodjac:', error);
                document.getElementById('primaci-izvodjaci-body').innerHTML = `
                    <tr><td colspan="100" style="text-align: center; padding: 40px; color: #dc2626;">
                        Greška pri učitavanju: ${error.message}
                    </td></tr>
                `;
            }
        }

        // Load otpremaci by radiliste
        async function loadOtremaciByRadiliste() {
            try {
                const year = new Date().getFullYear();
                const url = `${API_URL}?path=otpremaci-by-radiliste&year=${year}&username=${currentUser.username}&password=${currentPassword}`;

                const data = await fetchWithCache(url, `cache_otpremaci_radiliste_${year}`);

                console.log('Otpremaci by radiliste data received:', data);

                if (data.error) {
                    console.error('Error loading otpremaci by radiliste:', data.error);
                    document.getElementById('otpremaci-radilista-body').innerHTML = `
                        <tr><td colspan="100" style="text-align: center; padding: 40px; color: #dc2626;">
                            Greška: ${data.error}
                        </td></tr>
                    `;
                    return;
                }

                if (!data.radilista || data.radilista.length === 0) {
                    document.getElementById('otpremaci-radilista-header').innerHTML = `
                        <tr><th style="background: #0891b2; color: white; padding: 12px;">
                            🏗️ Prikaz po radilištima - ${year}
                        </th></tr>
                    `;
                    document.getElementById('otpremaci-radilista-body').innerHTML = `
                        <tr><td style="text-align: center; padding: 40px; color: #6b7280;">
                            Nema podataka o radilištima
                        </td></tr>
                    `;
                    return;
                }

                // Render mjesečnu tabelu
                const mjeseci = ['Jan', 'Feb', 'Mar', 'Apr', 'Maj', 'Jun', 'Jul', 'Avg', 'Sep', 'Okt', 'Nov', 'Dec'];

                let headerHTML = `
                    <tr>
                        <th style="background: linear-gradient(135deg, #0891b2, #0e7490); color: white; padding: 12px; position: sticky; top: 0; z-index: 20;">
                            🏗️ Radilište
                        </th>
                `;
                mjeseci.forEach(mj => {
                    headerHTML += `<th style="background: linear-gradient(135deg, #0891b2, #0e7490); color: white; padding: 12px; position: sticky; top: 0; z-index: 20; font-size: 12px;">${mj}</th>`;
                });
                headerHTML += `
                    <th style="background: linear-gradient(135deg, #155e75, #164e63); color: white; padding: 12px; font-weight: 900; position: sticky; top: 0; z-index: 20;">
                        UKUPNO
                    </th>
                </tr>
                `;
                document.getElementById('otpremaci-radilista-header').innerHTML = headerHTML;

                let bodyHTML = '';
                data.radilista.forEach((radiliste, idx) => {
                    const rowBg = idx % 2 === 0 ? '#cffafe' : '#ffffff';
                    const hoverBg = '#a5f3fc';

                    const mjeseciCells = radiliste.mjeseci.map(val => {
                        const displayVal = val > 0 ? val.toFixed(2) : '-';
                        const fontWeight = val > 0 ? 'font-weight: 700; color: #155e75;' : 'color: #d1d5db;';
                        return `<td style="${fontWeight} border: 1px solid #a5f3fc; font-family: 'Courier New', monospace; font-size: 11px; text-align: right; padding: 8px;">${displayVal}</td>`;
                    }).join('');

                    bodyHTML += `
                        <tr style="background: ${rowBg}; transition: all 0.15s ease;" onmouseover="this.style.background='${hoverBg}';" onmouseout="this.style.background='${rowBg}';">
                            <td style="font-weight: 700; font-size: 12px; border: 1px solid #a5f3fc; padding: 10px; color: #155e75;">
                                ${radiliste.naziv}
                            </td>
                            ${mjeseciCells}
                            <td style="background: #bfdbfe; border: 2px solid #3b82f6; font-family: 'Courier New', monospace; text-align: right; padding: 10px; font-weight: 900; font-size: 13px; color: #1e3a8a;">
                                ${radiliste.ukupno.toFixed(2)}
                            </td>
                        </tr>
                    `;
                });
                document.getElementById('otpremaci-radilista-body').innerHTML = bodyHTML;

                // Render godišnju rekapitulaciju po sortimentima
                let recapHeaderHTML = `
                    <tr>
                        <th style="background: linear-gradient(135deg, #0891b2, #0e7490); color: white; padding: 12px; position: sticky; top: 0; z-index: 20;">
                            🏗️ Radilište
                        </th>
                `;
                data.sortimentiNazivi.forEach(s => {
                    recapHeaderHTML += `<th style="background: linear-gradient(135deg, #0891b2, #0e7490); color: white; padding: 12px; position: sticky; top: 0; z-index: 20; font-size: 10px;">${s}</th>`;
                });
                recapHeaderHTML += `</tr>`;
                document.getElementById('otpremaci-radilista-recap-header').innerHTML = recapHeaderHTML;

                let recapBodyHTML = '';
                data.radilista.forEach((radiliste, idx) => {
                    const rowBg = idx % 2 === 0 ? '#cffafe' : '#ffffff';

                    const sortimentiCells = data.sortimentiNazivi.map(s => {
                        const val = radiliste.sortimentiUkupno[s] || 0;
                        const displayVal = val > 0 ? val.toFixed(2) : '-';
                        const fontWeight = val > 0 ? 'font-weight: 700; color: #155e75;' : 'color: #d1d5db;';
                        return `<td style="${fontWeight} border: 1px solid #a5f3fc; font-family: 'Courier New', monospace; font-size: 10px; text-align: right; padding: 8px;">${displayVal}</td>`;
                    }).join('');

                    recapBodyHTML += `
                        <tr style="background: ${rowBg};">
                            <td style="font-weight: 700; font-size: 12px; border: 1px solid #a5f3fc; padding: 10px; color: #155e75;">
                                ${radiliste.naziv}
                            </td>
                            ${sortimentiCells}
                        </tr>
                    `;
                });
                document.getElementById('otpremaci-radilista-recap-body').innerHTML = recapBodyHTML;

                console.log('Otpremaci by radiliste rendered');

            } catch (error) {
                console.error('Error in loadOtremaciByRadiliste:', error);
                document.getElementById('otpremaci-radilista-body').innerHTML = `
                    <tr><td colspan="100" style="text-align: center; padding: 40px; color: #dc2626;">
                        Greška pri učitavanju: ${error.message}
                    </td></tr>
                `;
            }
        }


        // Load kupci data
        async function loadKupci() {
            console.log('Loading Kupci screen...');
            document.getElementById('kupci-content').classList.remove('hidden');
            document.getElementById('loading-screen').classList.add('hidden');

            try {
                const year = new Date().getFullYear();
                const url = `${API_URL}?path=kupci&year=${year}&username=${currentUser.username}&password=${currentPassword}`;
                const data = await fetchWithCache(url, 'cache_kupci_' + year);

                console.log('Kupci data:', data);

                if (data.error || !data.godisnji || !data.sortimentiNazivi) {
                    throw new Error(data.error || 'Nema podataka');
                }

                // Renderuj godišnju tabelu po kupcima i sortimentima
                renderKupciGodisnjiTable(data.godisnji, data.sortimentiNazivi);

                // Renderuj mjesečnu tabelu za trenutni mjesec
                renderKupciMjesecniTable(data.mjesecni, data.sortimentiNazivi);

            } catch (error) {
                console.error('Error loading kupci:', error);
                document.getElementById('kupci-godisnji-body').innerHTML = '<tr><td colspan="100%" style="text-align: center; padding: 40px; color: #dc2626;">Greška pri učitavanju: ' + error.message + '</td></tr>';
                document.getElementById('kupci-mjesecni-body').innerHTML = '<tr><td colspan="100%" style="text-align: center; padding: 40px; color: #dc2626;">Greška pri učitavanju: ' + error.message + '</td></tr>';
            }
        }

        // Renderuj godišnju tabelu po kupcima i sortimentima
        function renderKupciGodisnjiTable(godisnji, sortimentiNazivi) {
            const headerElem = document.getElementById('kupci-godisnji-header');
            const bodyElem = document.getElementById('kupci-godisnji-body');

            if (!godisnji || godisnji.length === 0) {
                headerElem.innerHTML = '';
                bodyElem.innerHTML = '<tr><td colspan="100%" style="text-align: center; padding: 40px; color: #6b7280;">Nema podataka za godišnji prikaz</td></tr>';
                return;
            }

            // Header sa svim sortimentima
            let headerHtml = '<tr style="background: #047857;"><th style="color: white; font-weight: 700; position: sticky; left: 0; background: #047857; z-index: 10;">Kupac</th>';
            sortimentiNazivi.forEach(sortiment => {
                if (sortiment !== 'SVEUKUPNO') {
                    headerHtml += `<th style="color: white; font-weight: 700; text-align: right;">${sortiment}</th>`;
                }
            });
            headerHtml += '<th style="color: white; font-weight: 700; text-align: right; background: #065f46;">UKUPNO (m³)</th></tr>';
            headerElem.innerHTML = headerHtml;

            // Body redovi
            let bodyHtml = '';
            godisnji.forEach((kupac, index) => {
                const rowBg = index % 2 === 0 ? '#f0fdf4' : 'white';
                bodyHtml += `<tr style="background: ${rowBg};" data-kupac="${(kupac.kupac || '').toLowerCase()}">`;
                bodyHtml += `<td style="font-weight: 600; position: sticky; left: 0; background: ${rowBg}; z-index: 5;">${kupac.kupac || '-'}</td>`;

                sortimentiNazivi.forEach(sortiment => {
                    if (sortiment !== 'SVEUKUPNO') {
                        const kolicina = kupac.sortimenti[sortiment] || 0;
                        const display = kolicina > 0 ? kolicina.toFixed(2) : '-';
                        const color = kolicina > 0 ? '#047857' : '#9ca3af';
                        bodyHtml += `<td style="text-align: right; font-family: 'Courier New', monospace; color: ${color};">${display}</td>`;
                    }
                });

                bodyHtml += `<td style="text-align: right; font-family: 'Courier New', monospace; font-weight: 700; color: #047857; background: #d1fae5;">${(kupac.ukupno || 0).toFixed(2)}</td>`;
                bodyHtml += '</tr>';
            });
            bodyElem.innerHTML = bodyHtml;
        }

        // Renderuj mjesečnu tabelu za trenutni mjesec
        function renderKupciMjesecniTable(mjesecni, sortimentiNazivi) {
            const headerElem = document.getElementById('kupci-mjesecni-header');
            const bodyElem = document.getElementById('kupci-mjesecni-body');

            // Filtruj samo trenutni mjesec
            const currentDate = new Date();
            const mjeseci = ["Januar", "Februar", "Mart", "April", "Maj", "Juni", "Juli", "August", "Septembar", "Oktobar", "Novembar", "Decembar"];
            const currentMjesec = mjeseci[currentDate.getMonth()];

            const filteredData = mjesecni.filter(red => red.mjesec === currentMjesec);

            if (!filteredData || filteredData.length === 0) {
                headerElem.innerHTML = '';
                bodyElem.innerHTML = '<tr><td colspan="100%" style="text-align: center; padding: 40px; color: #6b7280;">Nema podataka za tekući mjesec (' + currentMjesec + ')</td></tr>';
                return;
            }

            // Header sa svim sortimentima
            let headerHtml = '<tr style="background: #0369a1;"><th style="color: white; font-weight: 700; position: sticky; left: 0; background: #0369a1; z-index: 10;">Kupac</th>';
            sortimentiNazivi.forEach(sortiment => {
                if (sortiment !== 'SVEUKUPNO') {
                    headerHtml += `<th style="color: white; font-weight: 700; text-align: right;">${sortiment}</th>`;
                }
            });
            headerHtml += '<th style="color: white; font-weight: 700; text-align: right; background: #075985;">UKUPNO (m³)</th></tr>';
            headerElem.innerHTML = headerHtml;

            // Body redovi
            let bodyHtml = '';
            filteredData.forEach((red, index) => {
                const rowBg = index % 2 === 0 ? '#e0f2fe' : 'white';
                bodyHtml += `<tr style="background: ${rowBg};" data-kupac="${(red.kupac || '').toLowerCase()}">`;
                bodyHtml += `<td style="font-weight: 600; position: sticky; left: 0; background: ${rowBg}; z-index: 5;">${red.kupac || '-'}</td>`;

                sortimentiNazivi.forEach(sortiment => {
                    if (sortiment !== 'SVEUKUPNO') {
                        const kolicina = red.sortimenti[sortiment] || 0;
                        const display = kolicina > 0 ? kolicina.toFixed(2) : '-';
                        const color = kolicina > 0 ? '#0369a1' : '#9ca3af';
                        bodyHtml += `<td style="text-align: right; font-family: 'Courier New', monospace; color: ${color};">${display}</td>`;
                    }
                });

                bodyHtml += `<td style="text-align: right; font-family: 'Courier New', monospace; font-weight: 700; color: #0369a1; background: #bae6fd;">${(red.ukupno || 0).toFixed(2)}</td>`;
                bodyHtml += '</tr>';
            });
            bodyElem.innerHTML = bodyHtml;
        }

        // Filter funkcije za kupce
        function filterKupciGodisnjiTable() {
            const searchInput = document.getElementById('kupci-godisnji-search').value.toLowerCase();
            const rows = document.querySelectorAll('#kupci-godisnji-body tr');

            rows.forEach(row => {
                const kupac = row.getAttribute('data-kupac') || '';
                if (kupac.includes(searchInput)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function filterKupciMjesecniTable() {
            const searchInput = document.getElementById('kupci-mjesecni-search').value.toLowerCase();
            const rows = document.querySelectorAll('#kupci-mjesecni-body tr');

            rows.forEach(row => {
                const kupac = row.getAttribute('data-kupac') || '';
                if (kupac.includes(searchInput)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // Load otpreme po kupcima u tekućem mjesecu
        async function loadOtremaciPoKupcima() {
            console.log('Loading Otpremaci po kupcima...');

            try {
                const year = new Date().getFullYear();
                const url = `${API_URL}?path=kupci&year=${year}&username=${currentUser.username}&password=${currentPassword}`;
                const data = await fetchWithCache(url, 'cache_kupci_' + year);

                console.log('Kupci data for otpreme:', data);

                if (data.error || !data.mjesecni || !data.sortimentiNazivi) {
                    throw new Error(data.error || 'Nema podataka');
                }

                // Update dynamic month name in tab and title
                const mjeseci = ["Januar", "Februar", "Mart", "April", "Maj", "Juni", "Juli", "August", "Septembar", "Oktobar", "Novembar", "Decembar"];
                const currentMjesec = mjeseci[new Date().getMonth()];
                document.getElementById('current-month-name').textContent = currentMjesec;
                document.getElementById('otpremaci-po-kupcima-month-title').textContent = currentMjesec + ' ' + year;

                // Renderuj expert tabelu
                renderOtremaciPoKupcimaExpertTable(data.mjesecni, data.sortimentiNazivi);

            } catch (error) {
                console.error('Error loading otpremaci po kupcima:', error);
                document.getElementById('otpremaci-po-kupcima-body').innerHTML = '<tr><td colspan="100%" style="text-align: center; padding: 40px; color: #dc2626;">Greška pri učitavanju: ' + error.message + '</td></tr>';
            }
        }

        // Renderuj expert tabelu sa sortiranjem i rekapitulacijom
        function renderOtremaciPoKupcimaExpertTable(mjesecni, sortimentiNazivi) {
            const headerElem = document.getElementById('otpremaci-po-kupcima-header');
            const bodyElem = document.getElementById('otpremaci-po-kupcima-body');
            const footerElem = document.getElementById('otpremaci-po-kupcima-footer');

            console.log('renderOtremaciPoKupcimaExpertTable called');
            console.log('Total mjesecni records:', mjesecni.length);

            // Filtruj samo trenutni mjesec
            const currentDate = new Date();
            const mjeseci = ["Januar", "Februar", "Mart", "April", "Maj", "Juni", "Juli", "August", "Septembar", "Oktobar", "Novembar", "Decembar"];
            const currentMjesec = mjeseci[currentDate.getMonth()];

            console.log('Current month:', currentMjesec);
            console.log('Available months in data:', [...new Set(mjesecni.map(r => r.mjesec))]);

            let filteredData = mjesecni.filter(red => red.mjesec === currentMjesec);

            console.log('Filtered data count:', filteredData.length);

            if (!filteredData || filteredData.length === 0) {
                // DEBUG: Show which months are available
                const availableMonths = [...new Set(mjesecni.map(r => r.mjesec))].join(', ');
                headerElem.innerHTML = '';
                bodyElem.innerHTML = `<tr><td colspan="100%" style="text-align: center; padding: 40px; color: #6b7280;">
                    <p>Nema podataka za tekući mjesec: <strong>${currentMjesec}</strong></p>
                    <p style="margin-top: 10px; font-size: 14px;">Dostupni mjeseci u bazi: ${availableMonths || 'Nema podataka'}</p>
                </td></tr>`;
                footerElem.innerHTML = '';
                return;
            }

            // SORTIRANJE: Od najvećeg ka najmanjem po ukupnoj količini
            filteredData.sort((a, b) => (b.ukupno || 0) - (a.ukupno || 0));

            // HEADER sa svim sortimentima
            let headerHtml = '<tr><th>Kupac</th>';
            sortimentiNazivi.forEach(sortiment => {
                if (sortiment !== 'SVEUKUPNO') {
                    headerHtml += `<th style="text-align: right;">${sortiment}</th>`;
                }
            });
            headerHtml += '<th style="text-align: right;">UKUPNO (m³)</th></tr>';
            headerElem.innerHTML = headerHtml;

            // BODY redovi + računanje rekapitulacije
            let bodyHtml = '';
            const totals = {};
            let grandTotal = 0;

            // Inicijalizuj sve sortimente na 0
            sortimentiNazivi.forEach(sortiment => {
                totals[sortiment] = 0;
            });

            filteredData.forEach((red, index) => {
                bodyHtml += `<tr data-kupac="${(red.kupac || '').toLowerCase()}">`;
                bodyHtml += `<td>${red.kupac || '-'}</td>`;

                sortimentiNazivi.forEach(sortiment => {
                    if (sortiment !== 'SVEUKUPNO') {
                        const kolicina = red.sortimenti[sortiment] || 0;
                        totals[sortiment] += kolicina;
                        const display = kolicina > 0 ? kolicina.toFixed(2) : '-';
                        bodyHtml += `<td class="sortiment-value">${display}</td>`;
                    }
                });

                const ukupno = red.ukupno || 0;
                grandTotal += ukupno;
                bodyHtml += `<td>${ukupno.toFixed(2)}</td>`;
                bodyHtml += '</tr>';
            });
            bodyElem.innerHTML = bodyHtml;

            // FOOTER - Rekapitulacija mjeseca
            let footerHtml = '<tr><td>📊 REKAPITULACIJA ' + currentMjesec.toUpperCase() + '</td>';
            sortimentiNazivi.forEach(sortiment => {
                if (sortiment !== 'SVEUKUPNO') {
                    const total = totals[sortiment] || 0;
                    const display = total > 0 ? total.toFixed(2) : '-';
                    footerHtml += `<td style="text-align: right;">${display}</td>`;
                }
            });
            footerHtml += `<td>${grandTotal.toFixed(2)}</td>`;
            footerHtml += '</tr>';
            footerElem.innerHTML = footerHtml;
        }

        // Filter funkcija za otpreme po kupcima
        function filterOtremaciPoKupcimaTable() {
            const searchInput = document.getElementById('otpremaci-po-kupcima-search').value.toLowerCase();
            const rows = document.querySelectorAll('#otpremaci-po-kupcima-body tr');

            rows.forEach(row => {
                const kupac = row.getAttribute('data-kupac') || '';
                if (kupac.includes(searchInput)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // Render Top 5 Kupaca po sortimentima
        function renderKupciTop5BySortimenti(data) {
            console.log('renderKupciTop5BySortimenti called');

            // Define sortimenti categories and their indices
            const sortimentiCategories = {
                'TRUPCI Č': ['TRUPCI Č'],
                'CEL.DUGA': ['CEL.DUGA'],
                'CEL.CIJEPANA': ['CEL.CIJEPANA'],
                'TRUPCI': ['TRUPCI'],
                'OGR. DUGI': ['OGR. DUGI', 'OGR.DUGI'],
                'OGR. CIJEPANI': ['OGR. CIJEPANI', 'OGR.CIJEPANI']
            };

            const divIds = {
                'TRUPCI Č': 'kupci-trupci-cetinara',
                'CEL.DUGA': 'kupci-celuloza-duga',
                'CEL.CIJEPANA': 'kupci-celuloza-cijepana',
                'TRUPCI': 'kupci-trupci-liscara',
                'OGR. DUGI': 'kupci-ogrijev-dugi',
                'OGR. CIJEPANI': 'kupci-ogrijev-cijepani'
            };

            Object.entries(sortimentiCategories).forEach(([category, sortimenti]) => {
                const kupciMap = {};

                data.godisnji.forEach(kupac => {
                    let total = 0;
                    sortimenti.forEach(sortiment => {
                        total += (kupac.sortimenti[sortiment] || 0);
                    });
                    if (total > 0) {
                        kupciMap[kupac.kupac] = total;
                    }
                });

                const sorted = Object.entries(kupciMap)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);

                const html = sorted.length > 0
                    ? sorted.map(([kupac, volume], index) => {
                        const rankClass = index < 3 ? 'top' : '';
                        return `
                            <div class="ranking-item">
                                <div class="ranking-number ${rankClass}">${index + 1}</div>
                                <div class="ranking-info">
                                    <div class="ranking-name">${kupac}</div>
                                    <div class="ranking-value">${volume.toFixed(2)} m³</div>
                                </div>
                            </div>
                        `;
                    }).join('')
                    : '<p style="color: #6b7280; text-align: center; padding: 20px;">Nema podataka</p>';

                const divId = divIds[category];
                if (divId) {
                    document.getElementById(divId).innerHTML = html;
                }
            });
        }

        // Render Top 10 Kupaca - Total Otprema
        function renderKupciTop10(godisnjiData) {
            console.log('renderKupciTop10 called');

            const sorted = godisnjiData
                .sort((a, b) => (b.ukupno || 0) - (a.ukupno || 0))
                .slice(0, 10);

            const html = sorted.length > 0
                ? sorted.map((kupac, index) => {
                    const rankClass = index < 3 ? 'top' : '';
                    return `
                        <div class="ranking-item">
                            <div class="ranking-number ${rankClass}">${index + 1}</div>
                            <div class="ranking-info">
                                <div class="ranking-name">${kupac.kupac || 'Nepoznat'}</div>
                                <div class="ranking-value">${(kupac.ukupno || 0).toFixed(2)} m³</div>
                            </div>
                        </div>
                    `;
                }).join('')
                : '<p style="color: #6b7280; text-align: center; padding: 20px;">Nema podataka</p>';

            document.getElementById('kupci-top-10-list').innerHTML = html;
        }

        // ========================================
        // WORKER MONTHLY CHART
        // ========================================

        let primacChart = null;
        let otpremacChart = null;

        function createWorkerMonthlyChart(canvasId, unosi, colorPrimary, colorSecondary) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;

            // Destroy existing chart if exists
            if (canvasId === 'primac-chart' && primacChart) {
                primacChart.destroy();
            }
            if (canvasId === 'otpremac-chart' && otpremacChart) {
                otpremacChart.destroy();
            }

            // Group by month
            const monthlyData = {};
            const mjeseci = ['Jan', 'Feb', 'Mar', 'Apr', 'Maj', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dec'];

            // Initialize all months to 0
            for (let i = 1; i <= 12; i++) {
                monthlyData[i] = 0;
            }

            // Sum up by month
            unosi.forEach(u => {
                const dateParts = u.datum.split('.');
                if (dateParts.length >= 2) {
                    const mjesec = parseInt(dateParts[1]);
                    monthlyData[mjesec] += u.ukupno || 0;
                }
            });

            // Prepare data for chart
            const labels = mjeseci;
            const values = mjeseci.map((_, idx) => monthlyData[idx + 1]);

            // Create gradient
            const ctx = canvas.getContext('2d');
            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
            gradient.addColorStop(0, colorPrimary);
            gradient.addColorStop(1, colorSecondary);

            // Create chart
            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Količina (m³)',
                        data: values,
                        backgroundColor: gradient,
                        borderColor: colorPrimary,
                        borderWidth: 2,
                        borderRadius: 6,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2.5,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: {
                                size: 14,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: 13
                            },
                            callbacks: {
                                label: function(context) {
                                    return 'Ukupno: ' + context.parsed.y.toFixed(2) + ' m³';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                font: {
                                    size: 11,
                                    weight: '600'
                                },
                                color: '#6b7280',
                                callback: function(value) {
                                    return value.toFixed(0) + ' m³';
                                }
                            },
                            grid: {
                                color: '#f3f4f6',
                                drawBorder: false
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 12,
                                    weight: '700'
                                },
                                color: '#374151'
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });

            // Store chart reference
            if (canvasId === 'primac-chart') {
                primacChart = chart;
            } else if (canvasId === 'otpremac-chart') {
                otpremacChart = chart;
            }
        }

        // Switch between Primac Personal tabs
        function switchPrimacPersonalTab(tab) {
            // Update tab buttons
            const tabs = document.querySelectorAll('#primac-personal-content .submenu-tab');
            tabs.forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            // Hide all content
            document.getElementById('primac-personal-detalji').classList.add('hidden');
            document.getElementById('primac-personal-godisnji').classList.add('hidden');

            // Show selected content
            if (tab === 'detalji') {
                document.getElementById('primac-personal-detalji').classList.remove('hidden');
            } else if (tab === 'godisnji') {
                document.getElementById('primac-personal-godisnji').classList.remove('hidden');
                loadPrimacGodisnji();
            }
        }

        // Load Primac Godišnji Prikaz
        async function loadPrimacGodisnji() {
            try {
                // Get year from selector, default to current year
                const yearSelector = document.getElementById('primac-godisnji-year-select');
                const year = yearSelector ? yearSelector.value : new Date().getFullYear();

                // Update badge
                const badge = document.getElementById('primac-godisnji-year-badge');
                if (badge) badge.textContent = year;

                const url = `${API_URL}?path=primac-detail&year=${year}&username=${currentUser.username}&password=${currentPassword}`;
                const data = await fetchWithCache(url, 'cache_primac_godisnji_' + year);

                if (data.error) {
                    throw new Error(data.error);
                }

                // Group data by month
                const monthlyData = {};
                const mjeseci = ['Januar', 'Februar', 'Mart', 'April', 'Maj', 'Juni', 'Juli', 'August', 'Septembar', 'Oktobar', 'Novembar', 'Decembar'];

                // Initialize all months
                for (let i = 1; i <= 12; i++) {
                    monthlyData[i] = {
                        mjesec: mjeseci[i-1],
                        sortimenti: {},
                        ukupno: 0
                    };
                    data.sortimentiNazivi.forEach(s => monthlyData[i].sortimenti[s] = 0);
                }

                // Sum by month
                data.unosi.forEach(u => {
                    const dateParts = u.datum.split('.');
                    if (dateParts.length >= 2) {
                        const mjesec = parseInt(dateParts[1]);
                        monthlyData[mjesec].ukupno += u.ukupno || 0;
                        data.sortimentiNazivi.forEach(s => {
                            monthlyData[mjesec].sortimenti[s] += (u.sortimenti[s] || 0);
                        });
                    }
                });

                // Create header
                const headerHTML = `
                    <tr>
                        <th>Mjesec</th>
                        ${data.sortimentiNazivi.map(s => `<th class="sortiment-col">${s}</th>`).join('')}
                    </tr>
                `;
                document.getElementById('primac-godisnji-main-header').innerHTML = headerHTML;

                // Create body
                let totalSortimenti = {};
                data.sortimentiNazivi.forEach(s => totalSortimenti[s] = 0);
                let totalUkupno = 0;

                const bodyHTML = mjeseci.map((mjesec, idx) => {
                    const mjesecNum = idx + 1;
                    const monthData = monthlyData[mjesecNum];

                    // Add to totals
                    totalUkupno += monthData.ukupno;
                    data.sortimentiNazivi.forEach(s => {
                        totalSortimenti[s] += monthData.sortimenti[s];
                    });

                    const sortimentiCells = data.sortimentiNazivi.map(s => {
                        const val = monthData.sortimenti[s];
                        return `<td class="sortiment-col">${val > 0 ? val.toFixed(2) : '-'}</td>`;
                    }).join('');

                    return `
                        <tr class="mjesec-${mjesecNum}">
                            <td style="font-weight: 700;">${mjesec}</td>
                            ${sortimentiCells}
                        </tr>
                    `;
                }).join('');

                // Add totals row
                const totalsCells = data.sortimentiNazivi.map(s => {
                    const val = totalSortimenti[s];
                    return `<td class="sortiment-col">${val > 0 ? val.toFixed(2) : '-'}</td>`;
                }).join('');

                const bodyWithTotals = bodyHTML + `
                    <tr class="totals-row">
                        <td style="text-align: left;">GODIŠNJE UKUPNO</td>
                        ${totalsCells}
                    </tr>
                `;

                document.getElementById('primac-godisnji-main-body').innerHTML = bodyWithTotals;
                document.getElementById('primac-godisnji-year-badge').textContent = year;

            } catch (error) {
                showError('Greška', 'Greška pri učitavanju godišnjeg prikaza: ' + error.message);
            }
        }

        // Load primac personal data
        async function loadPrimacPersonal() {
            document.getElementById('loading-screen').classList.remove('hidden');
            document.getElementById('primac-personal-content').classList.add('hidden');

            try {
                // ✅ Čitaj godinu iz selectora umjesto hardkodovane trenutne godine
                const yearSelector = document.getElementById('primac-personal-year-select');
                const year = yearSelector ? yearSelector.value : new Date().getFullYear();

                const url = `${API_URL}?path=primac-detail&year=${year}&username=${currentUser.username}&password=${currentPassword}`;
                const data = await fetchWithCache(url, 'cache_primac_detail_' + year);

                console.log('Primac personal data:', data);

                if (data.error) {
                    throw new Error(data.error);
                }

                // Create header
                const headerHTML = `
                    <tr>
                        <th onclick="sortTable(0, 'primac-personal-table')">Datum ⇅</th>
                        <th onclick="sortTable(1, 'primac-personal-table')">Odjel ⇅</th>
                        ${data.sortimentiNazivi.map((s, i) => `<th class="sortiment-col" onclick="sortTable(${i+2}, 'primac-personal-table')">${s} ⇅</th>`).join('')}
                        <th class="ukupno-col" onclick="sortTable(${data.sortimentiNazivi.length + 2}, 'primac-personal-table')">Ukupno ⇅</th>
                    </tr>
                `;
                document.getElementById('primac-personal-header').innerHTML = headerHTML;

                // Create body with totals
                let totals = { sortimenti: {}, ukupno: 0 };
                data.sortimentiNazivi.forEach(s => totals.sortimenti[s] = 0);

                const bodyHTML = data.unosi.map(u => {
                    // Add to totals
                    data.sortimentiNazivi.forEach(s => {
                        totals.sortimenti[s] += (u.sortimenti[s] || 0);
                    });
                    totals.ukupno += u.ukupno;

                    const sortimentiCells = data.sortimentiNazivi.map(sortiment => {
                        const val = u.sortimenti[sortiment] || 0;
                        return `<td class="sortiment-col">${val > 0 ? val.toFixed(2) : '-'}</td>`;
                    }).join('');

                    // Extract month from date (format: DD.MM.YYYY)
                    const dateParts = u.datum.split('.');
                    const mjesec = dateParts.length >= 2 ? parseInt(dateParts[1]) : 1;

                    return `
                        <tr class="mjesec-${mjesec}">
                            <td style="font-weight: 500;">${u.datum}</td>
                            <td>${u.odjel}</td>
                            ${sortimentiCells}
                            <td class="ukupno-col">${u.ukupno.toFixed(2)}</td>
                        </tr>
                    `;
                }).join('');

                // Add totals row
                const totalsCells = data.sortimentiNazivi.map(s => {
                    const val = totals.sortimenti[s];
                    return `<td class="sortiment-col">${val > 0 ? val.toFixed(2) : '-'}</td>`;
                }).join('');

                const bodyWithTotals = bodyHTML + `
                    <tr class="totals-row">
                        <td colspan="2" style="text-align: left;">UKUPNO</td>
                        ${totalsCells}
                        <td class="ukupno-col">${totals.ukupno.toFixed(2)}</td>
                    </tr>
                `;

                document.getElementById('primac-personal-body').innerHTML = bodyWithTotals;

                // Create monthly chart
                createWorkerMonthlyChart('primac-chart', data.unosi, '#047857', '#10b981');

                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('primac-personal-content').classList.remove('hidden');

                // Load godišnji prikaz by default (it's the first tab)
                loadPrimacGodisnji();

            } catch (error) {
                showError('Greška', 'Greška pri učitavanju podataka: ' + error.message);
                document.getElementById('loading-screen').innerHTML = '<div class="loading-icon">❌</div><div class="loading-text">Greška pri učitavanju</div><div class="loading-sub">' + error.message + '</div>';
            }
        }

        // Load otpremac personal data
        async function loadOtpremacPersonal() {
            document.getElementById('loading-screen').classList.remove('hidden');
            document.getElementById('otpremac-personal-content').classList.add('hidden');

            try {
                // ✅ Čitaj godinu iz selectora umjesto hardkodovane trenutne godine
                const yearSelector = document.getElementById('otpremac-personal-year-select');
                const year = yearSelector ? yearSelector.value : new Date().getFullYear();

                const url = `${API_URL}?path=otpremac-detail&year=${year}&username=${currentUser.username}&password=${currentPassword}`;
                const data = await fetchWithCache(url, 'cache_otpremac_detail_' + year);

                console.log('Otpremac personal data:', data);

                if (data.error) {
                    throw new Error(data.error);
                }

                // Create header
                const headerHTML = `
                    <tr>
                        <th onclick="sortTable(0, 'otpremac-personal-table')">Datum ⇅</th>
                        <th onclick="sortTable(1, 'otpremac-personal-table')">Odjel ⇅</th>
                        <th onclick="sortTable(2, 'otpremac-personal-table')">Kupac ⇅</th>
                        ${data.sortimentiNazivi.map((s, i) => `<th class="sortiment-col" onclick="sortTable(${i+3}, 'otpremac-personal-table')">${s} ⇅</th>`).join('')}
                        <th class="ukupno-col" onclick="sortTable(${data.sortimentiNazivi.length + 3}, 'otpremac-personal-table')">Ukupno ⇅</th>
                    </tr>
                `;
                document.getElementById('otpremac-personal-header').innerHTML = headerHTML;

                // Create body with totals
                let totals = { sortimenti: {}, ukupno: 0 };
                data.sortimentiNazivi.forEach(s => totals.sortimenti[s] = 0);

                const bodyHTML = data.unosi.map(u => {
                    // Add to totals
                    data.sortimentiNazivi.forEach(s => {
                        totals.sortimenti[s] += (u.sortimenti[s] || 0);
                    });
                    totals.ukupno += u.ukupno;

                    const sortimentiCells = data.sortimentiNazivi.map(sortiment => {
                        const val = u.sortimenti[sortiment] || 0;
                        return `<td class="sortiment-col">${val > 0 ? val.toFixed(2) : '-'}</td>`;
                    }).join('');

                    // Extract month from date (format: DD.MM.YYYY)
                    const dateParts = u.datum.split('.');
                    const mjesec = dateParts.length >= 2 ? parseInt(dateParts[1]) : 1;

                    return `
                        <tr class="mjesec-${mjesec}">
                            <td style="font-weight: 500;">${u.datum}</td>
                            <td>${u.odjel}</td>
                            <td>${u.kupac || '-'}</td>
                            ${sortimentiCells}
                            <td class="ukupno-col">${u.ukupno.toFixed(2)}</td>
                        </tr>
                    `;
                }).join('');

                // Add totals row
                const totalsCells = data.sortimentiNazivi.map(s => {
                    const val = totals.sortimenti[s];
                    return `<td class="sortiment-col">${val > 0 ? val.toFixed(2) : '-'}</td>`;
                }).join('');

                const bodyWithTotals = bodyHTML + `
                    <tr class="totals-row">
                        <td colspan="3" style="text-align: left;">UKUPNO</td>
                        ${totalsCells}
                        <td class="ukupno-col">${totals.ukupno.toFixed(2)}</td>
                    </tr>
                `;

                document.getElementById('otpremac-personal-body').innerHTML = bodyWithTotals;

                // Create monthly chart
                createWorkerMonthlyChart('otpremac-chart', data.unosi, '#1e40af', '#3b82f6');

                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('otpremac-personal-content').classList.remove('hidden');

            } catch (error) {
                showError('Greška', 'Greška pri učitavanju podataka: ' + error.message);
                document.getElementById('loading-screen').innerHTML = '<div class="loading-icon">❌</div><div class="loading-text">Greška pri učitavanju</div><div class="loading-sub">' + error.message + '</div>';
            }
        }

        // ========================================
        // ODJELI VIEW (BY DEPARTMENT) - WITH PAGINATION
        // ========================================

        let primacOdjeliData = null;
        let primacOdjeliCurrentPage = 0;
        const primacOdjeliPageSize = 5;

        let otpremacOdjeliData = null;
        let otpremacOdjeliCurrentPage = 0;
        const otpremacOdjeliPageSize = 5;

        // Load primac odjeli data (ZADNJIH 15 ODJELA IZ SVIH GODINA)
        // ✅ OPTIMIZOVANO: Jedan API poziv sa limit=15 (backend procesira sve godine)
        async function loadPrimacOdjeli() {
            document.getElementById('loading-screen').classList.remove('hidden');
            document.getElementById('primac-odjeli-content').classList.add('hidden');

            try {
                // Backend sada vraća top 15 odjela iz svih godina automatski
                const url = `${API_URL}?path=primac-odjeli&limit=15&username=${currentUser.username}&password=${currentPassword}`;
                const data = await fetchWithCache(url, 'cache_primac_odjeli_top15');

                if (data.error) {
                    throw new Error(data.error);
                }

                if (!data.odjeli || data.odjeli.length === 0) {
                    throw new Error('Nema podataka o odjelima');
                }

                // Backend već šalje sortiran i limitiran rezultat sa godinom
                primacOdjeliData = {
                    odjeli: data.odjeli,
                    sortimentiNazivi: data.sortimentiNazivi || []
                };

                primacOdjeliCurrentPage = 0;
                renderPrimacOdjeliPage();

                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('primac-odjeli-content').classList.remove('hidden');

            } catch (error) {
                showError('Greška', 'Greška pri učitavanju podataka: ' + error.message);
                document.getElementById('loading-screen').innerHTML = '<div class="loading-icon">❌</div><div class="loading-text">Greška pri učitavanju</div><div class="loading-sub">' + error.message + '</div>';
            }
        }

        function renderPrimacOdjeliPage() {
            if (!primacOdjeliData) return;

            const start = primacOdjeliCurrentPage * primacOdjeliPageSize;
            const end = Math.min(start + primacOdjeliPageSize, primacOdjeliData.odjeli.length);
            const pageOdjeli = primacOdjeliData.odjeli.slice(start, end);

            let html = '';

            pageOdjeli.forEach(odjel => {
                // Kreiraj HTML za odjel sa dve tabele
                const yearBadge = odjel.godina ? `<span style="background: #fbbf24; color: #78350f; padding: 4px 12px; border-radius: 6px; font-size: 12px; font-weight: 700; margin-left: 10px;">${odjel.godina}</span>` : '';
                html += `
                    <div style="margin-bottom: 40px; border: 2px solid #10b981; border-radius: 12px; padding: 20px; background: #f0fdf4;">
                        <h3 style="color: #047857; margin-bottom: 16px;">📁 ${odjel.odjel} ${yearBadge}</h3>
                        <p style="font-size: 13px; color: #6b7280; margin-bottom: 16px;">Zadnji unos: ${odjel.zadnjiDatum || 'N/A'}</p>

                        <!-- Apsolutne vrijednosti -->
                        <h4 style="font-size: 15px; margin-bottom: 8px; color: #059669;">Apsolutne vrijednosti (m³)</h4>
                        <div class="kupci-table-wrapper" style="margin-bottom: 20px;">
                            <table class="kupci-table">
                                <thead>
                                    <tr>
                                        ${primacOdjeliData.sortimentiNazivi.map(s => `<th class="sortiment-col">${s}</th>`).join('')}
                                        <th class="ukupno-col">Ukupno</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        ${primacOdjeliData.sortimentiNazivi.map(s => {
                                            const val = odjel.sortimenti[s] || 0;
                                            return `<td class="sortiment-col">${val > 0 ? val.toFixed(2) : '-'}</td>`;
                                        }).join('')}
                                        <td class="ukupno-col">${odjel.ukupno.toFixed(2)}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Procentualne vrijednosti -->
                        <h4 style="font-size: 15px; margin-bottom: 8px; color: #059669;">Procentualni udio (%)</h4>
                        <div class="kupci-table-wrapper">
                            <table class="kupci-table">
                                <thead>
                                    <tr>
                                        ${primacOdjeliData.sortimentiNazivi.map(s => `<th class="sortiment-col">${s}</th>`).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        ${primacOdjeliData.sortimentiNazivi.map(s => {
                                            const val = odjel.sortimenti[s] || 0;
                                            const percent = odjel.ukupno > 0 ? (val / odjel.ukupno) * 100 : 0;
                                            return `<td class="sortiment-col">${percent > 0 ? percent.toFixed(1) + '%' : '-'}</td>`;
                                        }).join('')}
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            });

            document.getElementById('primac-odjeli-container').innerHTML = html;

            // Update pagination controls
            const totalPages = Math.ceil(primacOdjeliData.odjeli.length / primacOdjeliPageSize);
            document.getElementById('primac-odjeli-page-info').textContent = `Stranica ${primacOdjeliCurrentPage + 1} od ${totalPages}`;
            document.getElementById('primac-odjeli-prev').disabled = primacOdjeliCurrentPage === 0;
            document.getElementById('primac-odjeli-next').disabled = primacOdjeliCurrentPage >= totalPages - 1;
        }

        function prevPagePrimacOdjeli() {
            if (primacOdjeliCurrentPage > 0) {
                primacOdjeliCurrentPage--;
                renderPrimacOdjeliPage();
            }
        }

        function nextPagePrimacOdjeli() {
            const totalPages = Math.ceil(primacOdjeliData.odjeli.length / primacOdjeliPageSize);
            if (primacOdjeliCurrentPage < totalPages - 1) {
                primacOdjeliCurrentPage++;
                renderPrimacOdjeliPage();
            }
        }

        // Load otpremac odjeli data (ZADNJIH 15 ODJELA IZ SVIH GODINA)
        // ✅ OPTIMIZOVANO: Jedan API poziv sa limit=15 (backend procesira sve godine)
        async function loadOtpremacOdjeli() {
            document.getElementById('loading-screen').classList.remove('hidden');
            document.getElementById('otpremac-odjeli-content').classList.add('hidden');

            try {
                // Backend sada vraća top 15 odjela iz svih godina automatski
                const url = `${API_URL}?path=otpremac-odjeli&limit=15&username=${currentUser.username}&password=${currentPassword}`;
                const data = await fetchWithCache(url, 'cache_otpremac_odjeli_top15');

                if (data.error) {
                    throw new Error(data.error);
                }

                if (!data.odjeli || data.odjeli.length === 0) {
                    throw new Error('Nema podataka o odjelima');
                }

                // Backend već šalje sortiran i limitiran rezultat sa godinom
                otpremacOdjeliData = {
                    odjeli: data.odjeli,
                    sortimentiNazivi: data.sortimentiNazivi || []
                };

                otpremacOdjeliCurrentPage = 0;
                renderOtpremacOdjeliPage();

                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('otpremac-odjeli-content').classList.remove('hidden');

            } catch (error) {
                showError('Greška', 'Greška pri učitavanju podataka: ' + error.message);
                document.getElementById('loading-screen').innerHTML = '<div class="loading-icon">❌</div><div class="loading-text">Greška pri učitavanju</div><div class="loading-sub">' + error.message + '</div>';
            }
        }

        function renderOtpremacOdjeliPage() {
            if (!otpremacOdjeliData) return;

            const start = otpremacOdjeliCurrentPage * otpremacOdjeliPageSize;
            const end = Math.min(start + otpremacOdjeliPageSize, otpremacOdjeliData.odjeli.length);
            const pageOdjeli = otpremacOdjeliData.odjeli.slice(start, end);

            let html = '';

            pageOdjeli.forEach(odjel => {
                // Kreiraj HTML za odjel sa dve tabele
                const yearBadge = odjel.godina ? `<span style="background: #fbbf24; color: #78350f; padding: 4px 12px; border-radius: 6px; font-size: 12px; font-weight: 700; margin-left: 10px;">${odjel.godina}</span>` : '';
                html += `
                    <div style="margin-bottom: 40px; border: 2px solid #2563eb; border-radius: 12px; padding: 20px; background: #eff6ff;">
                        <h3 style="color: #1e40af; margin-bottom: 16px;">📁 ${odjel.odjel} ${yearBadge}</h3>
                        <p style="font-size: 13px; color: #6b7280; margin-bottom: 16px;">Zadnji unos: ${odjel.zadnjiDatum || 'N/A'}</p>

                        <!-- Apsolutne vrijednosti -->
                        <h4 style="font-size: 15px; margin-bottom: 8px; color: #2563eb;">Apsolutne vrijednosti (m³)</h4>
                        <div class="kupci-table-wrapper" style="margin-bottom: 20px;">
                            <table class="kupci-table">
                                <thead>
                                    <tr>
                                        ${otpremacOdjeliData.sortimentiNazivi.map(s => `<th class="sortiment-col">${s}</th>`).join('')}
                                        <th class="ukupno-col">Ukupno</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        ${otpremacOdjeliData.sortimentiNazivi.map(s => {
                                            const val = odjel.sortimenti[s] || 0;
                                            return `<td class="sortiment-col">${val > 0 ? val.toFixed(2) : '-'}</td>`;
                                        }).join('')}
                                        <td class="ukupno-col">${odjel.ukupno.toFixed(2)}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Procentualne vrijednosti -->
                        <h4 style="font-size: 15px; margin-bottom: 8px; color: #2563eb;">Procentualni udio (%)</h4>
                        <div class="kupci-table-wrapper">
                            <table class="kupci-table">
                                <thead>
                                    <tr>
                                        ${otpremacOdjeliData.sortimentiNazivi.map(s => `<th class="sortiment-col">${s}</th>`).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        ${otpremacOdjeliData.sortimentiNazivi.map(s => {
                                            const val = odjel.sortimenti[s] || 0;
                                            const percent = odjel.ukupno > 0 ? (val / odjel.ukupno) * 100 : 0;
                                            return `<td class="sortiment-col">${percent > 0 ? percent.toFixed(1) + '%' : '-'}</td>`;
                                        }).join('')}
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            });

            document.getElementById('otpremac-odjeli-container').innerHTML = html;

            // Update pagination controls
            const totalPages = Math.ceil(otpremacOdjeliData.odjeli.length / otpremacOdjeliPageSize);
            document.getElementById('otpremac-odjeli-page-info').textContent = `Stranica ${otpremacOdjeliCurrentPage + 1} od ${totalPages}`;
            document.getElementById('otpremac-odjeli-prev').disabled = otpremacOdjeliCurrentPage === 0;
            document.getElementById('otpremac-odjeli-next').disabled = otpremacOdjeliCurrentPage >= totalPages - 1;
        }

        function prevPageOtpremacOdjeli() {
            if (otpremacOdjeliCurrentPage > 0) {
                otpremacOdjeliCurrentPage--;
                renderOtpremacOdjeliPage();
            }
        }

        function nextPageOtpremacOdjeli() {
            const totalPages = Math.ceil(otpremacOdjeliData.odjeli.length / otpremacOdjeliPageSize);
            if (otpremacOdjeliCurrentPage < totalPages - 1) {
                otpremacOdjeliCurrentPage++;
                renderOtpremacOdjeliPage();
            }
        }

        // ========================================
        // UTILITY FUNCTIONS
        // ========================================

        // Dark mode toggle
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('dark-mode', isDark ? 'enabled' : 'disabled');
        }

        // Load dark mode preference
        window.addEventListener('DOMContentLoaded', () => {
            const darkMode = localStorage.getItem('dark-mode');
            if (darkMode === 'enabled') {
                document.body.classList.add('dark-mode');
            }
        });

        // Filter dashboard table
        function filterDashboardTable() {
            const input = document.getElementById('dashboard-search');
            const filter = input.value.toUpperCase();
            const table = document.getElementById('dashboard-table');
            const tr = table.getElementsByTagName('tr');

            for (let i = 1; i < tr.length; i++) {
                const td = tr[i].getElementsByTagName('td')[0];
                if (td) {
                    const txtValue = td.textContent || td.innerText;
                    tr[i].style.display = txtValue.toUpperCase().indexOf(filter) > -1 ? '' : 'none';
                }
            }
        }

        // Filter odjeli table
        function filterOdjeliTable() {
            const input = document.getElementById('odjeli-search');
            const filter = input.value.toUpperCase();
            const table = document.getElementById('odjeli-table');
            const tr = table.getElementsByTagName('tr');

            for (let i = 1; i < tr.length; i++) {
                const td = tr[i].getElementsByTagName('td')[0];
                if (td) {
                    const txtValue = td.textContent || td.innerText;
                    tr[i].style.display = txtValue.toUpperCase().indexOf(filter) > -1 ? '' : 'none';
                }
            }
        }

        // Filter primaci table
        function filterPrimaciTable() {
            const input = document.getElementById('primaci-search');
            const filter = input.value.toUpperCase();
            const table = document.getElementById('primaci-table');
            const tr = table.getElementsByTagName('tr');

            for (let i = 1; i < tr.length; i++) {
                const td = tr[i].getElementsByTagName('td')[0];
                if (td) {
                    const txtValue = td.textContent || td.innerText;
                    tr[i].style.display = txtValue.toUpperCase().indexOf(filter) > -1 ? '' : 'none';
                }
            }
        }

        // Filter otpremaci table
        function filterOtremaciTable() {
            const input = document.getElementById('otpremaci-search');
            const filter = input.value.toUpperCase();
            const table = document.getElementById('otpremaci-table');
            const tr = table.getElementsByTagName('tr');

            for (let i = 1; i < tr.length; i++) {
                const td = tr[i].getElementsByTagName('td')[0];
                if (td) {
                    const txtValue = td.textContent || td.innerText;
                    tr[i].style.display = txtValue.toUpperCase().indexOf(filter) > -1 ? '' : 'none';
                }
            }
        }

        // Filter primaci daily table
        function filterPrimaciDailyTable() {
            const input = document.getElementById('primaci-daily-search');
            const filter = input.value.toUpperCase();
            const table = document.getElementById('primaci-daily-table');
            const tbody = table.getElementsByTagName('tbody')[0];
            if (!tbody) return;
            const tr = tbody.getElementsByTagName('tr');

            for (let i = 0; i < tr.length - 1; i++) { // -1 to exclude UKUPNO row
                const tds = tr[i].getElementsByTagName('td');
                let found = false;
                // Search in datum, odjel, and primac columns
                for (let j = 0; j < 3 && j < tds.length; j++) {
                    const txtValue = tds[j].textContent || tds[j].innerText;
                    if (txtValue.toUpperCase().indexOf(filter) > -1) {
                        found = true;
                        break;
                    }
                }
                tr[i].style.display = found ? '' : 'none';
            }
        }

        // Filter otpremaci daily table
        function filterOtremaciDailyTable() {
            const input = document.getElementById('otpremaci-daily-search');
            const filter = input.value.toUpperCase();
            const table = document.getElementById('otpremaci-daily-table');
            const tbody = table.getElementsByTagName('tbody')[0];
            if (!tbody) return;
            const tr = tbody.getElementsByTagName('tr');

            for (let i = 0; i < tr.length - 1; i++) { // -1 to exclude UKUPNO row
                const tds = tr[i].getElementsByTagName('td');
                let found = false;
                // Search in datum, odjel, otpremac, and kupac columns
                for (let j = 0; j < 4 && j < tds.length; j++) {
                    const txtValue = tds[j].textContent || tds[j].innerText;
                    if (txtValue.toUpperCase().indexOf(filter) > -1) {
                        found = true;
                        break;
                    }
                }
                tr[i].style.display = found ? '' : 'none';
            }
        }

        // Filter kupci godisnji table
        function filterKupciGodisnjiTable() {
            const input = document.getElementById('kupci-godisnji-search');
            const filter = input.value.toUpperCase();
            const table = document.getElementById('kupci-godisnji-table');
            const tr = table.getElementsByTagName('tr');

            for (let i = 1; i < tr.length; i++) {
                const td = tr[i].getElementsByTagName('td')[0];
                if (td) {
                    const txtValue = td.textContent || td.innerText;
                    tr[i].style.display = txtValue.toUpperCase().indexOf(filter) > -1 ? '' : 'none';
                }
            }
        }

        // Filter kupci mjesecni table
        function filterKupciMjesecniTable() {
            const input = document.getElementById('kupci-mjesecni-search');
            const filter = input.value.toUpperCase();
            const table = document.getElementById('kupci-mjesecni-table');
            const tr = table.getElementsByTagName('tr');

            for (let i = 1; i < tr.length; i++) {
                const td = tr[i].getElementsByTagName('td')[0];
                if (td) {
                    const txtValue = td.textContent || td.innerText;
                    tr[i].style.display = txtValue.toUpperCase().indexOf(filter) > -1 ? '' : 'none';
                }
            }
        }

        // Filter primac personal table
        function filterPrimacPersonalTable() {
            const input = document.getElementById('primac-personal-search');
            const filter = input.value.toUpperCase();
            const table = document.getElementById('primac-personal-table');
            const tr = table.getElementsByTagName('tr');

            for (let i = 1; i < tr.length; i++) {
                // Search in both datum and odjel columns (0 and 1)
                const td0 = tr[i].getElementsByTagName('td')[0];
                const td1 = tr[i].getElementsByTagName('td')[1];
                if (td0 || td1) {
                    const txtValue = (td0 ? (td0.textContent || td0.innerText) : '') + ' ' +
                                     (td1 ? (td1.textContent || td1.innerText) : '');
                    tr[i].style.display = txtValue.toUpperCase().indexOf(filter) > -1 ? '' : 'none';
                }
            }
        }

        // Filter otpremac personal table
        function filterOtpremacPersonalTable() {
            const input = document.getElementById('otpremac-personal-search');
            const filter = input.value.toUpperCase();
            const table = document.getElementById('otpremac-personal-table');
            const tr = table.getElementsByTagName('tr');

            for (let i = 1; i < tr.length; i++) {
                // Search in datum, odjel, and kupac columns (0, 1, and 2)
                const td0 = tr[i].getElementsByTagName('td')[0];
                const td1 = tr[i].getElementsByTagName('td')[1];
                const td2 = tr[i].getElementsByTagName('td')[2];
                if (td0 || td1 || td2) {
                    const txtValue = (td0 ? (td0.textContent || td0.innerText) : '') + ' ' +
                                     (td1 ? (td1.textContent || td1.innerText) : '') + ' ' +
                                     (td2 ? (td2.textContent || td2.innerText) : '');
                    tr[i].style.display = txtValue.toUpperCase().indexOf(filter) > -1 ? '' : 'none';
                }
            }
        }

        // Export table to CSV
        function exportTableToCSV(tableType) {
            let table, filename;

            if (tableType === 'dashboard') {
                table = document.getElementById('dashboard-table');
                filename = 'dashboard_pregled.csv';
            } else if (tableType === 'odjeli') {
                table = document.getElementById('odjeli-table');
                filename = 'odjeli_pregled.csv';
            } else if (tableType === 'primaci') {
                table = document.getElementById('primaci-table');
                filename = 'primaci_pregled.csv';
            } else if (tableType === 'otpremaci') {
                table = document.getElementById('otpremaci-table');
                filename = 'otpremaci_pregled.csv';
            } else if (tableType === 'kupci-godisnji') {
                table = document.getElementById('kupci-godisnji-table');
                filename = 'kupci_godisnji_pregled.csv';
            } else if (tableType === 'kupci-mjesecni') {
                table = document.getElementById('kupci-mjesecni-table');
                filename = 'kupci_mjesecni_pregled.csv';
            } else if (tableType === 'primac-personal') {
                table = document.getElementById('primac-personal-table');
                filename = 'moja_sjeca_' + new Date().getFullYear() + '.csv';
            } else if (tableType === 'otpremac-personal') {
                table = document.getElementById('otpremac-personal-table');
                filename = 'moja_otprema_' + new Date().getFullYear() + '.csv';
            }

            const rows = table.querySelectorAll('tr');
            const csv = [];

            for (let i = 0; i < rows.length; i++) {
                const row = [], cols = rows[i].querySelectorAll('td, th');

                for (let j = 0; j < cols.length; j++) {
                    let data = cols[j].innerText.replace(/(\r\n|\n|\r)/gm, '').replace(/"/g, '""');
                    row.push('"' + data + '"');
                }

                csv.push(row.join(','));
            }

            const csvString = csv.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Sort table
        function sortTable(columnIndex, tableId) {
            const table = document.getElementById(tableId);
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));

            const sortedRows = rows.sort((a, b) => {
                const aValue = a.querySelectorAll('td')[columnIndex].innerText;
                const bValue = b.querySelectorAll('td')[columnIndex].innerText;

                // Try to parse as number
                const aNum = parseFloat(aValue.replace(/[^\d.-]/g, ''));
                const bNum = parseFloat(bValue.replace(/[^\d.-]/g, ''));

                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return aNum - bNum;
                } else {
                    return aValue.localeCompare(bValue, 'bs');
                }
            });

            // Toggle sort direction
            if (table.dataset.lastSort === columnIndex.toString()) {
                sortedRows.reverse();
                table.dataset.lastSort = '';
            } else {
                table.dataset.lastSort = columnIndex.toString();
            }

            // Re-append sorted rows
            sortedRows.forEach(row => tbody.appendChild(row));
        }

        // ========== DODANI UNOSI VIEW ==========

        // Load Dodani Unosi (Pending entries)
        // Helper to determine column group
        function getColumnGroup(sortiment) {
            const cetinariCols = ['F/L Č', 'I Č', 'II Č', 'III Č', 'RUDNO', 'CEL.DUGA', 'CEL.CIJEPANA', 'TRUPCI Č', 'ČETINARI'];
            const liscariCols = ['F/L L', 'I L', 'II L', 'III L', 'OGR.DUGI', 'OGR.CIJEPANI', 'TRUPCI L', 'LIŠĆARI'];

            if (cetinariCols.includes(sortiment)) return 'col-group-cetinari';
            if (liscariCols.includes(sortiment)) return 'col-group-liscari';
            return '';
        }

        // Render pending table with filters
        function renderPendingTable(data) {
            let html = '';

            if (!data || data.length === 0) {
                html = '<p style="text-align: center; padding: 40px; color: #6b7280;">Nema dodanih unosa</p>';
            } else {
                // Get sortimenti names from first item
                const sortimentiNazivi = data[0] && data[0].sortimenti ? Object.keys(data[0].sortimenti) : [];

                html = '<div class="kupci-table-wrapper"><table class="kupci-table"><thead><tr>';
                html += '<th style="min-width: 80px;">Tip</th>';
                html += '<th style="min-width: 100px;">Datum</th>';
                html += '<th style="min-width: 80px;">Odjel</th>';
                html += '<th style="min-width: 150px;">Radnik</th>';
                html += '<th style="min-width: 120px;">Kupac</th>';
                html += '<th style="min-width: 120px;">Br. otpremnice</th>';

                // Sortimenti headers with grouping
                for (let i = 0; i < sortimentiNazivi.length; i++) {
                    const colClass = getColumnGroup(sortimentiNazivi[i]);
                    html += '<th class="sortiment-col ' + colClass + '">' + sortimentiNazivi[i] + '</th>';
                }

                html += '<th style="min-width: 130px;">Poslano</th>';
                html += '<th style="min-width: 80px;"></th>'; // Actions column
                html += '</tr></thead><tbody>';

                // Render rows
                for (let i = 0; i < data.length; i++) {
                    const unos = data[i];
                    const tipColor = unos.tip === 'SJEČA' ? '#059669' : '#2563eb';

                    html += '<tr>';
                    html += '<td><span style="font-weight: 600; color: ' + tipColor + '">' + unos.tip + '</span></td>';
                    html += '<td>' + unos.datum + '</td>';
                    html += '<td style="font-weight: 600;">' + unos.odjel + '</td>';
                    html += '<td>' + unos.radnik + '</td>';
                    html += '<td>' + (unos.kupac || '-') + '</td>';
                    html += '<td>' + (unos.brojOtpremnice || '-') + '</td>';

                    // Sortimenti values with grouping
                    for (let j = 0; j < sortimentiNazivi.length; j++) {
                        const sortiment = sortimentiNazivi[j];
                        // Use calculated ukupno for SVEUKUPNO instead of saved value
                        const val = sortiment === 'SVEUKUPNO' ? unos.ukupno : (unos.sortimenti[sortiment] || 0);
                        const displayVal = val > 0 ? val.toFixed(2) : '-';
                        const colClass = getColumnGroup(sortiment);
                        html += '<td class="sortiment-col right ' + colClass + '">' + displayVal + '</td>';
                    }

                    html += '<td style="font-size: 11px; color: #6b7280;">' + unos.timestamp + '</td>';

                    // Row actions dropdown
                    html += '<td>';
                    html += '<div class="row-actions">';
                    html += '<button class="row-actions-btn" onclick="toggleRowActions(' + unos.id + ')">⋮</button>';
                    html += '<div class="row-actions-dropdown" id="row-actions-' + unos.id + '">';
                    html += '<div class="row-actions-item" onclick="editPendingUnos(' + unos.id + ', \'' + unos.tip + '\')">✏️ Uredi</div>';
                    html += '<div class="row-actions-item danger" onclick="deletePendingUnos(' + unos.id + ', \'' + unos.tip + '\')">🗑️ Obriši</div>';
                    html += '</div>';
                    html += '</div>';
                    html += '</td>';

                    html += '</tr>';
                }

                html += '</tbody></table></div>';

                // Add summary
                html += '<div style="margin-top: 20px; padding: 12px; background: #f9fafb; border-radius: 8px;">';
                html += '<strong>Ukupno dodanih unosa:</strong> ' + data.length;

                let sjecaCount = 0;
                let otpremaCount = 0;
                for (let i = 0; i < data.length; i++) {
                    if (data[i].tip === 'SJEČA') sjecaCount++;
                    else if (data[i].tip === 'OTPREMA') otpremaCount++;
                }

                html += ' (Sječa: ' + sjecaCount + ', Otprema: ' + otpremaCount + ')';
                html += '</div>';
            }

            document.getElementById('pending-unosi-container').innerHTML = html;
        }

        async function loadPendingUnosi() {
            document.getElementById('loading-screen').classList.remove('hidden');
            document.getElementById('pending-unosi-content').classList.add('hidden');

            try {
                const year = new Date().getFullYear();
                const url = API_URL + '?path=pending-unosi&year=' + year + '&username=' + currentUser.username + '&password=' + currentPassword;

                // Don't cache pending entries - always fetch fresh
                const response = await fetch(url);
                const data = await response.json();

                console.log('Dodani unosi data:', data);

                if (data.error) {
                    throw new Error(data.error);
                }

                // Store unfiltered data for filtering
                unfilteredPendingData = data.unosi || [];

                // Update badge count
                updatePendingBadge(unfilteredPendingData.length);

                // Render table
                renderPendingTable(unfilteredPendingData);

                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('pending-unosi-content').classList.remove('hidden');

            } catch (error) {
                console.error('Error loading dodani unosi:', error);
                document.getElementById('pending-unosi-container').innerHTML =
                    '<p style="color: #dc2626; text-align: center; padding: 40px;">Greška: ' + error.message + '</p>';
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('pending-unosi-content').classList.remove('hidden');
            }
        }

        // Load monthly sortimenti
        async function loadMjesecniSortimenti() {
            document.getElementById('loading-screen').classList.remove('hidden');
            document.getElementById('mjesecni-sortimenti-content').classList.add('hidden');

            try {
                const year = new Date().getFullYear();
                const url = API_URL + '?path=mjesecni-sortimenti&year=' + year + '&username=' + currentUser.username + '&password=' + currentPassword;

                console.log('Fetching mjesečni sortimenti for year:', year);
                const data = await fetchWithCache(url, `cache_mjesecni_sortimenti_${year}`);

                console.log('Mjesečni sortimenti response:', data);

                if (data.error) {
                    throw new Error(data.error);
                }

                if (!data.sjeca || !data.otprema) {
                    throw new Error('Invalid data format received from server');
                }

                console.log('Rendering SJEČA table...');
                // Render SJEČA table
                renderMjesecnaTabela(data.sjeca, 'mjesecna-sjeca');

                console.log('Rendering OTPREMA table...');
                // Render OTPREMA table
                renderMjesecnaTabela(data.otprema, 'mjesecna-otprema');

                console.log('Tables rendered successfully');
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('mjesecni-sortimenti-content').classList.remove('hidden');

            } catch (error) {
                console.error('Error loading mjesečni sortimenti:', error);
                showError('Greška', 'Greška pri učitavanju mjesečnih podataka: ' + error.message);
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('mjesecni-sortimenti-content').classList.remove('hidden');
            }
        }

        // Render monthly table (SJEČA or OTPREMA)
        function renderMjesecnaTabela(data, tableId) {
            console.log('renderMjesecnaTabela called with tableId:', tableId, 'data:', data);

            const headerElem = document.getElementById(tableId + '-header');
            const bodyElem = document.getElementById(tableId + '-body');

            if (!headerElem || !bodyElem) {
                console.error('Table elements not found for tableId:', tableId);
                return;
            }

            if (!data || !data.sortimenti || data.sortimenti.length === 0) {
                console.log('No data available for table:', tableId);
                headerElem.innerHTML = '';
                bodyElem.innerHTML = '<tr><td colspan="100%" style="text-align: center; padding: 40px; color: #6b7280;">Nema podataka</td></tr>';
                return;
            }

            if (!data.mjeseci || !Array.isArray(data.mjeseci) || data.mjeseci.length !== 12) {
                console.error('Invalid mjeseci data for table:', tableId, data.mjeseci);
                headerElem.innerHTML = '';
                bodyElem.innerHTML = '<tr><td colspan="100%" style="text-align: center; padding: 40px; color: #dc2626;">Greška u formatu podataka</td></tr>';
                return;
            }

            const sortimenti = data.sortimenti.filter(s => s && s.trim() !== ''); // Filter out empty sortiment names
            const mjeseci = ['Jan', 'Feb', 'Mar', 'Apr', 'Maj', 'Jun', 'Jul', 'Avg', 'Sep', 'Okt', 'Nov', 'Dec'];

            console.log('Original sortimenti:', data.sortimenti);
            console.log('Filtered sortimenti:', sortimenti);
            console.log('Rendering table with', sortimenti.length, 'sortimenti and', data.mjeseci.length, 'months');

            // Build header with optimized styling
            let headerHtml = '<tr>';
            headerHtml += '<th style="min-width: 80px; max-width: 90px; position: sticky; left: 0; background: #1e40af !important; color: white; z-index: 20; font-size: 12px; font-weight: 700; padding: 12px 8px; text-align: center; border-right: 3px solid #1e3a8a;">MJESEC</th>';

            for (let i = 0; i < sortimenti.length; i++) {
                const colClass = getColumnGroup(sortimenti[i]);
                let extraClass = '';
                let bgColor = '#3b82f6'; // Default blue
                let borderColor = '#2563eb';

                if (sortimenti[i] === 'ČETINARI') {
                    extraClass = ' col-cetinari';
                    bgColor = '#059669'; // Green for četinari aggregate
                    borderColor = '#047857';
                } else if (sortimenti[i] === 'LIŠĆARI') {
                    extraClass = ' col-liscari';
                    bgColor = '#d97706'; // Orange for lišćari aggregate
                    borderColor = '#b45309';
                } else if (sortimenti[i] === 'SVEUKUPNO') {
                    extraClass = ' col-sveukupno';
                    bgColor = '#dc2626'; // Red for total
                    borderColor = '#b91c1c';
                }

                headerHtml += '<th class="sortiment-col ' + colClass + extraClass + '" style="background: ' + bgColor + ' !important; color: white !important; border: 1px solid ' + borderColor + '; min-width: 85px; max-width: 110px; padding: 12px 8px; font-size: 12px; font-weight: 700; text-align: center; white-space: normal !important; word-wrap: break-word; overflow-wrap: break-word; line-height: 1.3; height: auto; overflow: visible; vertical-align: middle;">' + sortimenti[i] + '</th>';
            }
            headerHtml += '</tr>';
            headerElem.innerHTML = headerHtml;

            // Build body - 12 months + UKUPNO + %UDIO
            let bodyHtml = '';
            const totals = {}; // Total per sortiment

            // Month rows with improved styling
            for (let m = 0; m < 12; m++) {
                const rowBg = m % 2 === 0 ? '#f9fafb' : 'white';
                const rowHoverBg = m % 2 === 0 ? '#f3f4f6' : '#f9fafb';
                bodyHtml += '<tr style="background: ' + rowBg + ';" onmouseover="this.style.background=\'' + rowHoverBg + '\'" onmouseout="this.style.background=\'' + rowBg + '\'">';
                bodyHtml += '<td style="font-weight: 700; font-size: 13px; min-width: 80px; max-width: 90px; position: sticky; left: 0; background: ' + rowBg + '; z-index: 9; border-right: 3px solid #1e40af; text-align: center; padding: 10px 8px;">' + mjeseci[m] + '</td>';

                for (let s = 0; s < sortimenti.length; s++) {
                    const sortiment = sortimenti[s];
                    const value = data.mjeseci[m][sortiment] || 0;
                    const displayVal = value > 0 ? value.toFixed(2) : '-';
                    const colClass = getColumnGroup(sortiment);
                    let extraClass = '';
                    let fontWeight = value > 0 ? 'font-weight: 600;' : 'font-weight: 400; color: #9ca3af;';
                    let cellBg = 'transparent';

                    if (sortiment === 'ČETINARI') {
                        extraClass = ' col-cetinari';
                        cellBg = value > 0 ? '#d1fae5' : 'transparent';
                    } else if (sortiment === 'LIŠĆARI') {
                        extraClass = ' col-liscari';
                        cellBg = value > 0 ? '#fed7aa' : 'transparent';
                    } else if (sortiment === 'SVEUKUPNO') {
                        extraClass = ' col-sveukupno';
                        fontWeight = value > 0 ? 'font-weight: 700;' : 'font-weight: 400; color: #9ca3af;';
                        cellBg = value > 0 ? '#fecaca' : 'transparent';
                    }

                    bodyHtml += '<td class="sortiment-col right ' + colClass + extraClass + '" style="' + fontWeight + ' padding: 8px 10px; font-size: 12px; min-width: 85px; max-width: 110px; text-align: right; border: 1px solid #e5e7eb; background: ' + cellBg + ';">' + displayVal + '</td>';

                    // Add to totals
                    if (!totals[sortiment]) totals[sortiment] = 0;
                    totals[sortiment] += value;
                }

                bodyHtml += '</tr>';
            }

            // UKUPNO row with improved styling
            bodyHtml += '<tr style="background: linear-gradient(to bottom, #e5e7eb, #d1d5db); font-weight: 700; border-top: 3px solid #374151; border-bottom: 2px solid #374151;">';
            bodyHtml += '<td style="min-width: 80px; max-width: 90px; position: sticky; left: 0; background: #e5e7eb; z-index: 9; border-right: 3px solid #1e40af; text-align: center; font-size: 13px; padding: 12px 8px; color: #1f2937;">📊 UKUPNO</td>';
            for (let s = 0; s < sortimenti.length; s++) {
                const sortiment = sortimenti[s];
                const total = totals[sortiment] || 0;
                const colClass = getColumnGroup(sortiment);
                let extraClass = '';
                let cellBg = '#e5e7eb';

                if (sortiment === 'ČETINARI') {
                    extraClass = ' col-cetinari';
                    cellBg = '#d1fae5';
                } else if (sortiment === 'LIŠĆARI') {
                    extraClass = ' col-liscari';
                    cellBg = '#fed7aa';
                } else if (sortiment === 'SVEUKUPNO') {
                    extraClass = ' col-sveukupno';
                    cellBg = '#fecaca';
                }

                bodyHtml += '<td class="sortiment-col right ' + colClass + extraClass + '" style="font-weight: 800; font-size: 13px; padding: 12px 10px; background: ' + cellBg + '; min-width: 85px; max-width: 110px; text-align: right; border: 1px solid #9ca3af;">' + total.toFixed(2) + '</td>';
            }
            bodyHtml += '</tr>';

            // Calculate grand total from SVEUKUPNO
            const grandTotal = totals['SVEUKUPNO'] || 0;

            // %UDIO row with improved styling
            bodyHtml += '<tr style="background: #f3f4f6; font-style: italic; color: #374151; border-bottom: 3px solid #374151;">';
            bodyHtml += '<td style="min-width: 80px; max-width: 90px; position: sticky; left: 0; background: #f3f4f6; z-index: 9; border-right: 3px solid #1e40af; text-align: center; font-size: 12px; padding: 10px 8px; font-weight: 600;">% UDIO</td>';
            for (let s = 0; s < sortimenti.length; s++) {
                const sortiment = sortimenti[s];
                const total = totals[sortiment] || 0;
                const percentage = grandTotal > 0 ? ((total / grandTotal) * 100).toFixed(1) : '0.0';
                const colClass = getColumnGroup(sortiment);
                let extraClass = '';
                let cellBg = '#f3f4f6';

                if (sortiment === 'ČETINARI') {
                    extraClass = ' col-cetinari';
                    cellBg = '#ecfdf5';
                } else if (sortiment === 'LIŠĆARI') {
                    extraClass = ' col-liscari';
                    cellBg = '#fff7ed';
                } else if (sortiment === 'SVEUKUPNO') {
                    extraClass = ' col-sveukupno';
                    cellBg = '#fef2f2';
                }

                bodyHtml += '<td class="sortiment-col right ' + colClass + extraClass + '" style="font-weight: 700; font-size: 12px; padding: 10px; background: ' + cellBg + '; min-width: 85px; max-width: 110px; text-align: right; border: 1px solid #d1d5db; font-style: italic;">' + percentage + '%</td>';
            }
            bodyHtml += '</tr>';

            bodyElem.innerHTML = bodyHtml;
        }

        // ========================================
        // IZVJEŠTAJI - Mjesečni prikaz po odjelima sa sortimentima
        // ========================================

        async function loadIzvjestaji() {
            document.getElementById('loading-screen').classList.remove('hidden');
            document.getElementById('izvjestaji-content').classList.add('hidden');

            try {
                const year = document.getElementById('izvjestaji-year-select').value;
                const month = document.getElementById('izvjestaji-month-select').value;

                const mjeseciNazivi = ['Januar', 'Februar', 'Mart', 'April', 'Maj', 'Juni', 'Juli', 'August', 'Septembar', 'Oktobar', 'Novembar', 'Decembar'];

                // Update titles
                document.getElementById('izvjestaji-primka-title').textContent = mjeseciNazivi[month] + ' ' + year;
                document.getElementById('izvjestaji-otprema-title').textContent = mjeseciNazivi[month] + ' ' + year;

                // Load PRIMKA (sječa) data
                const primkaUrl = API_URL + '?path=primaci-daily&year=' + year + '&month=' + month + '&username=' + currentUser.username + '&password=' + currentPassword;
                const primkaData = await fetchWithCache(primkaUrl, `cache_izvjestaji_primka_${year}_${month}`);

                // Load OTPREMA data
                const otpremaUrl = API_URL + '?path=otpremaci-daily&year=' + year + '&month=' + month + '&username=' + currentUser.username + '&password=' + currentPassword;
                const otpremaData = await fetchWithCache(otpremaUrl, `cache_izvjestaji_otprema_${year}_${month}`);

                if (primkaData.error) throw new Error('Primka: ' + primkaData.error);
                if (otpremaData.error) throw new Error('Otprema: ' + otpremaData.error);

                // Aggregate data by odjel
                const primkaByOdjel = aggregateByOdjel(primkaData.data, primkaData.sortimentiNazivi);
                const otpremaByOdjel = aggregateByOdjel(otpremaData.data, otpremaData.sortimentiNazivi);

                // Render tables
                renderIzvjestajiTable(primkaByOdjel, primkaData.sortimentiNazivi, 'primka');
                renderIzvjestajiTable(otpremaByOdjel, otpremaData.sortimentiNazivi, 'otprema');

                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('izvjestaji-content').classList.remove('hidden');

            } catch (error) {
                console.error('Error loading izvjestaji:', error);
                showError('Greška', 'Greška pri učitavanju izvještaja: ' + error.message);
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('izvjestaji-content').classList.remove('hidden');
            }
        }

        // Aggregate data by odjel (sum sortimenti per odjel)
        function aggregateByOdjel(data, sortimentiNazivi) {
            const odjeliMap = {};

            data.forEach(row => {
                // ✅ Convert odjel to string to prevent "localeCompare/includes is not a function" errors
                const odjel = String(row.odjel || '');
                if (!odjeliMap[odjel]) {
                    odjeliMap[odjel] = {};
                    sortimentiNazivi.forEach(s => odjeliMap[odjel][s] = 0);
                }

                sortimentiNazivi.forEach(sortiment => {
                    const value = parseFloat(row.sortimenti[sortiment]) || 0;
                    odjeliMap[odjel][sortiment] += value;
                });
            });

            // Convert to array
            const result = [];
            for (const odjel in odjeliMap) {
                result.push({
                    odjel: odjel,
                    sortimenti: odjeliMap[odjel]
                });
            }

            // Sort by odjel name - safe now because odjel is always a string
            result.sort((a, b) => a.odjel.localeCompare(b.odjel));

            return result;
        }

        // Render izvjestaji table (primka or otprema)
        function renderIzvjestajiTable(data, sortimentiNazivi, tip) {
            const headerElem = document.getElementById('izvjestaji-' + tip + '-header');
            const bodyElem = document.getElementById('izvjestaji-' + tip + '-body');

            if (data.length === 0) {
                headerElem.innerHTML = '';
                bodyElem.innerHTML = '<tr><td colspan="100%" style="text-align: center; padding: 40px; color: #6b7280;">Nema podataka za odabrani mjesec</td></tr>';
                return;
            }

            // Build header
            let headerHtml = '<tr><th style="position: sticky; left: 0; background: #f9fafb; z-index: 20; min-width: 200px;">Odjel</th>';
            sortimentiNazivi.forEach(sortiment => {
                const colClass = getColumnGroup(sortiment);
                let extraClass = '';
                if (sortiment === 'ČETINARI') extraClass = ' col-cetinari';
                else if (sortiment === 'LIŠĆARI') extraClass = ' col-liscari';
                else if (sortiment === 'SVEUKUPNO') extraClass = ' col-sveukupno';

                headerHtml += '<th class="sortiment-col right ' + colClass + extraClass + '">' + sortiment + '</th>';
            });
            headerHtml += '</tr>';
            headerElem.innerHTML = headerHtml;

            // Build body
            let bodyHtml = '';
            const totals = {};
            sortimentiNazivi.forEach(s => totals[s] = 0);

            data.forEach((row, index) => {
                const rowStyle = index % 2 === 0 ? 'background: #f9fafb;' : '';
                bodyHtml += '<tr style="' + rowStyle + '">';
                bodyHtml += '<td style="font-weight: 600; position: sticky; left: 0; background: ' + (index % 2 === 0 ? '#f9fafb' : 'white') + '; z-index: 9;">' + row.odjel + '</td>';

                sortimentiNazivi.forEach(sortiment => {
                    const value = row.sortimenti[sortiment] || 0;
                    totals[sortiment] += value;

                    const colClass = getColumnGroup(sortiment);
                    let extraClass = '';
                    if (sortiment === 'ČETINARI') extraClass = ' col-cetinari';
                    else if (sortiment === 'LIŠĆARI') extraClass = ' col-liscari';
                    else if (sortiment === 'SVEUKUPNO') extraClass = ' col-sveukupno';

                    const displayValue = value === 0 ? '' : value.toFixed(2);
                    bodyHtml += '<td class="sortiment-col right ' + colClass + extraClass + '">' + displayValue + '</td>';
                });

                bodyHtml += '</tr>';
            });

            // Add UKUPNO row
            bodyHtml += '<tr style="background: #f9fafb; border-top: 3px solid #1f2937; font-weight: 700;">';
            bodyHtml += '<td style="position: sticky; left: 0; background: #f9fafb; z-index: 9; font-size: 15px; padding: 14px;">📊 UKUPNO</td>';

            sortimentiNazivi.forEach(sortiment => {
                const colClass = getColumnGroup(sortiment);
                let extraClass = '';
                if (sortiment === 'ČETINARI') extraClass = ' col-cetinari';
                else if (sortiment === 'LIŠĆARI') extraClass = ' col-liscari';
                else if (sortiment === 'SVEUKUPNO') extraClass = ' col-sveukupno';

                bodyHtml += '<td class="sortiment-col right ' + colClass + extraClass + '" style="font-weight: 700;">' + totals[sortiment].toFixed(2) + '</td>';
            });

            bodyHtml += '</tr>';

            bodyElem.innerHTML = bodyHtml;
        }

        // Filter funkcija za Primka tabelu
        function filterIzvjestajiPrimkaTable() {
            const input = document.getElementById('izvjestaji-primka-search');
            const filter = input.value.toLowerCase();
            const table = document.getElementById('izvjestaji-primka-table');
            const tr = table.getElementsByTagName('tr');

            for (let i = 1; i < tr.length - 1; i++) { // Skip header (0) and total row (last)
                const td = tr[i].getElementsByTagName('td')[0]; // First column (Odjel)
                if (td) {
                    const txtValue = td.textContent || td.innerText;
                    if (txtValue.toLowerCase().indexOf(filter) > -1) {
                        tr[i].style.display = '';
                    } else {
                        tr[i].style.display = 'none';
                    }
                }
            }
        }

        // Filter funkcija za Otprema tabelu
        function filterIzvjestajiOtpremaTable() {
            const input = document.getElementById('izvjestaji-otprema-search');
            const filter = input.value.toLowerCase();
            const table = document.getElementById('izvjestaji-otprema-table');
            const tr = table.getElementsByTagName('tr');

            for (let i = 1; i < tr.length - 1; i++) { // Skip header (0) and total row (last)
                const td = tr[i].getElementsByTagName('td')[0]; // First column (Odjel)
                if (td) {
                    const txtValue = td.textContent || td.innerText;
                    if (txtValue.toLowerCase().indexOf(filter) > -1) {
                        tr[i].style.display = '';
                    } else {
                        tr[i].style.display = 'none';
                    }
                }
            }
        }

        // ========================================
        // IZVJEŠTAJI - Sub-tab switching
        // ========================================

        function switchIzvjestajiSubTab(subTab) {
            // Remove active class from all sub-tabs
            const subTabs = document.querySelectorAll('.sub-tab');
            subTabs.forEach(tab => tab.classList.remove('active'));

            // Hide all sub-contents
            document.getElementById('mjesecni-izvjestaj').classList.add('hidden');
            document.getElementById('sedmicni-sjeca-izvjestaj').classList.add('hidden');
            document.getElementById('sedmicni-otprema-izvjestaj').classList.add('hidden');
            document.getElementById('stanje-odjela-izvjestaj').classList.add('hidden');

            // Show selected sub-content and activate tab
            if (subTab === 'mjesecni') {
                document.querySelector('.sub-tab[onclick*="mjesecni"]').classList.add('active');
                document.getElementById('mjesecni-izvjestaj').classList.remove('hidden');
                loadIzvjestaji();
            } else if (subTab === 'sedmicni-sjeca') {
                document.querySelector('.sub-tab[onclick*="sedmicni-sjeca"]').classList.add('active');
                document.getElementById('sedmicni-sjeca-izvjestaj').classList.remove('hidden');
                loadSedmicniIzvjestajSjeca();
            } else if (subTab === 'sedmicni-otprema') {
                document.querySelector('.sub-tab[onclick*="sedmicni-otprema"]').classList.add('active');
                document.getElementById('sedmicni-otprema-izvjestaj').classList.remove('hidden');
                loadSedmicniIzvjestajOtprema();
            } else if (subTab === 'stanje-odjela') {
                document.querySelector('.sub-tab[onclick*="stanje-odjela"]').classList.add('active');
                document.getElementById('stanje-odjela-izvjestaj').classList.remove('hidden');
                loadStanjeOdjela();
            }
        }

        // Sub-tab switching za primača
        function switchPrimacIzvjestajiSubTab(subTab) {
            const subTabs = document.querySelectorAll('#izvjestaji-primac-content .sub-tab');
            subTabs.forEach(tab => tab.classList.remove('active'));

            document.getElementById('primac-sedmicni-izvjestaj').classList.add('hidden');
            document.getElementById('primac-mjesecni-izvjestaj').classList.add('hidden');

            if (subTab === 'sedmicni') {
                document.querySelector('#izvjestaji-primac-content .sub-tab[onclick*="sedmicni"]').classList.add('active');
                document.getElementById('primac-sedmicni-izvjestaj').classList.remove('hidden');
                loadPrimacSedmicni();
            } else if (subTab === 'mjesecni') {
                document.querySelector('#izvjestaji-primac-content .sub-tab[onclick*="mjesecni"]').classList.add('active');
                document.getElementById('primac-mjesecni-izvjestaj').classList.remove('hidden');
                loadPrimacMjesecni();
            }
        }

        // Sub-tab switching za otpremača
        function switchOtpremacIzvjestajiSubTab(subTab) {
            const subTabs = document.querySelectorAll('#izvjestaji-otpremac-content .sub-tab');
            subTabs.forEach(tab => tab.classList.remove('active'));

            document.getElementById('otpremac-sedmicni-izvjestaj').classList.add('hidden');
            document.getElementById('otpremac-mjesecni-izvjestaj').classList.add('hidden');

            if (subTab === 'sedmicni') {
                document.querySelector('#izvjestaji-otpremac-content .sub-tab[onclick*="sedmicni"]').classList.add('active');
                document.getElementById('otpremac-sedmicni-izvjestaj').classList.remove('hidden');
                loadOtpremacSedmicni();
            } else if (subTab === 'mjesecni') {
                document.querySelector('#izvjestaji-otpremac-content .sub-tab[onclick*="mjesecni"]').classList.add('active');
                document.getElementById('otpremac-mjesecni-izvjestaj').classList.remove('hidden');
                loadOtpremacMjesecni();
            }
        }

        // ========================================
        // SEDMIČNI IZVJEŠTAJI - Functions
        // ========================================

        async function loadSedmicniIzvjestajSjeca() {
            document.getElementById('loading-screen').classList.remove('hidden');

            try {
                const year = document.getElementById('sedmicni-sjeca-year-select').value;
                const month = document.getElementById('sedmicni-sjeca-month-select').value;

                // Load PRIMKA (sječa) data
                const primkaUrl = API_URL + '?path=primaci-daily&year=' + year + '&month=' + month + '&username=' + currentUser.username + '&password=' + currentPassword;
                const primkaData = await fetchWithCache(primkaUrl, `cache_sedmicni_sjeca_${year}_${month}`);

                if (primkaData.error) throw new Error('Primka: ' + primkaData.error);

                // Group by weeks (within month boundaries)
                const weeklyData = groupDataByWeeks(primkaData.data, year, month, primkaData.sortimentiNazivi);

                // Render
                renderSedmicniIzvjestaj(weeklyData, primkaData.sortimentiNazivi, 'sedmicni-sjeca-container', year, month);

                document.getElementById('loading-screen').classList.add('hidden');

            } catch (error) {
                console.error('Error loading sedmični izvještaj sječe:', error);
                showError('Greška', 'Greška pri učitavanju sedmičnog izvještaja: ' + error.message);
                document.getElementById('loading-screen').classList.add('hidden');
            }
        }

        async function loadSedmicniIzvjestajOtprema() {
            document.getElementById('loading-screen').classList.remove('hidden');

            try {
                const year = document.getElementById('sedmicni-otprema-year-select').value;
                const month = document.getElementById('sedmicni-otprema-month-select').value;

                // Load OTPREMA data
                const otpremaUrl = API_URL + '?path=otpremaci-daily&year=' + year + '&month=' + month + '&username=' + currentUser.username + '&password=' + currentPassword;
                const otpremaData = await fetchWithCache(otpremaUrl, `cache_sedmicni_otprema_${year}_${month}`);

                if (otpremaData.error) throw new Error('Otprema: ' + otpremaData.error);

                // Group by weeks (within month boundaries)
                const weeklyData = groupDataByWeeks(otpremaData.data, year, month, otpremaData.sortimentiNazivi);

                // Render
                renderSedmicniIzvjestaj(weeklyData, otpremaData.sortimentiNazivi, 'sedmicni-otprema-container', year, month);

                document.getElementById('loading-screen').classList.add('hidden');

            } catch (error) {
                console.error('Error loading sedmični izvještaj otpreme:', error);
                showError('Greška', 'Greška pri učitavanju sedmičnog izvještaja: ' + error.message);
                document.getElementById('loading-screen').classList.add('hidden');
            }
        }

        // Group data by weeks (sedmice se ne prelaze preko granica mjeseca)
        function groupDataByWeeks(data, year, month, sortimentiNazivi) {
            const weeks = [];
            const weeksMap = new Map();

            // Parse year and month
            const y = parseInt(year);
            const m = parseInt(month);

            data.forEach(row => {
                // Parse datum (expecting DD/MM/YYYY format)
                const datumStr = row.datum;
                const dateParts = datumStr.split(/[\/\.\-]/);
                const day = parseInt(dateParts[0]);
                const recordMonth = parseInt(dateParts[1]) - 1;
                const recordYear = parseInt(dateParts[2]);

                // Skip if not in selected month
                if (recordYear !== y || recordMonth !== m) return;

                const datum = new Date(recordYear, recordMonth, day);

                // Get week number within the month
                const weekInfo = getWeekWithinMonth(datum, y, m);
                const weekKey = weekInfo.weekNumber;

                if (!weeksMap.has(weekKey)) {
                    weeksMap.set(weekKey, {
                        weekNumber: weekKey,
                        weekStart: weekInfo.weekStart,
                        weekEnd: weekInfo.weekEnd,
                        odjeliMap: {}
                    });
                }

                const week = weeksMap.get(weekKey);
                // ✅ Convert odjel to string to prevent "localeCompare/includes is not a function" errors
                const odjel = String(row.odjel || '');

                if (!week.odjeliMap[odjel]) {
                    week.odjeliMap[odjel] = {};
                    sortimentiNazivi.forEach(s => week.odjeliMap[odjel][s] = 0);
                }

                sortimentiNazivi.forEach(sortiment => {
                    const value = parseFloat(row.sortimenti[sortiment]) || 0;
                    week.odjeliMap[odjel][sortiment] += value;
                });
            });

            // Convert Map to Array and sort by week number
            weeksMap.forEach(week => weeks.push(week));
            weeks.sort((a, b) => a.weekNumber - b.weekNumber);

            return weeks;
        }

        // Get week number within month (sedmica počinje u ponedjeljak)
        function getWeekWithinMonth(date, year, month) {
            // Clone date to avoid mutation
            const d = new Date(date.getTime());

            // Get first day of month
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);

            // Find first Monday of the month (or first day if it's not Monday)
            let weekStart = new Date(firstDay);
            const firstDayOfWeek = firstDay.getDay(); // 0=Sunday, 1=Monday, ...

            // If first day is not Monday, find next Monday (or use first day if it's after Monday)
            if (firstDayOfWeek === 0) { // Sunday
                weekStart.setDate(firstDay.getDate() + 1); // Move to Monday
            } else if (firstDayOfWeek > 1) { // Tuesday-Saturday
                weekStart.setDate(firstDay.getDate() + (8 - firstDayOfWeek)); // Move to next Monday
            }
            // If firstDayOfWeek === 1 (Monday), weekStart is already correct

            // Calculate week number
            let weekNumber = 1;
            let currentWeekStart = new Date(firstDay);

            while (currentWeekStart <= d) {
                let currentWeekEnd = new Date(currentWeekStart);
                currentWeekEnd.setDate(currentWeekEnd.getDate() + 6); // Sunday

                // Ensure week doesn't go beyond month
                if (currentWeekEnd > lastDay) {
                    currentWeekEnd = new Date(lastDay);
                }

                // Check if date falls in this week
                if (d >= currentWeekStart && d <= currentWeekEnd) {
                    return {
                        weekNumber: weekNumber,
                        weekStart: formatDateDDMMYYYY(currentWeekStart),
                        weekEnd: formatDateDDMMYYYY(currentWeekEnd)
                    };
                }

                // Move to next week (always Monday)
                currentWeekStart.setDate(currentWeekStart.getDate() + 7);

                // If next week is in next month, stop
                if (currentWeekStart.getMonth() !== month) {
                    break;
                }

                weekNumber++;
            }

            // Fallback: return week 1
            return {
                weekNumber: 1,
                weekStart: formatDateDDMMYYYY(firstDay),
                weekEnd: formatDateDDMMYYYY(lastDay)
            };
        }

        // Format date as DD/MM/YYYY
        function formatDateDDMMYYYY(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return day + '/' + month + '/' + year;
        }

        // Render sedmični izvještaj (multiple tables, one per week)
        function renderSedmicniIzvjestaj(weeks, sortimentiNazivi, containerId, year, month) {
            const container = document.getElementById(containerId);
            const mjeseciNazivi = ['Januar', 'Februar', 'Mart', 'April', 'Maj', 'Juni', 'Juli', 'August', 'Septembar', 'Oktobar', 'Novembar', 'Decembar'];

            if (weeks.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280;">Nema podataka za odabrani mjesec</div>';
                return;
            }

            let html = '';

            // Show all weeks in the month, sorted from newest to oldest (reverse chronological)
            const visibleWeeks = weeks.slice().reverse();

            visibleWeeks.forEach(week => {
                // Convert odjeliMap to array
                const odjeliArray = [];
                for (const odjel in week.odjeliMap) {
                    odjeliArray.push({
                        odjel: odjel,
                        sortimenti: week.odjeliMap[odjel]
                    });
                }
                odjeliArray.sort((a, b) => a.odjel.localeCompare(b.odjel));

                html += '<div class="section" style="margin-bottom: 40px;">';
                html += '<h3 style="margin-bottom: 16px; color: #047857;">📅 Sedmica ' + week.weekNumber + ': ' + week.weekStart + ' - ' + week.weekEnd + '</h3>';

                if (odjeliArray.length === 0) {
                    html += '<p style="color: #6b7280; padding: 20px;">Nema podataka za ovu sedmicu</p>';
                } else {
                    html += '<div style="overflow-x: auto;"><table class="table">';

                    // Header
                    html += '<thead><tr><th style="position: sticky; left: 0; background: #f9fafb; z-index: 20; min-width: 200px;">Odjel</th>';
                    sortimentiNazivi.forEach(sortiment => {
                        const colClass = getColumnGroup(sortiment);
                        let extraClass = '';
                        if (sortiment === 'ČETINARI') extraClass = ' col-cetinari';
                        else if (sortiment === 'LIŠĆARI') extraClass = ' col-liscari';
                        else if (sortiment === 'SVEUKUPNO') extraClass = ' col-sveukupno';

                        html += '<th class="sortiment-col right ' + colClass + extraClass + '">' + sortiment + '</th>';
                    });
                    html += '</tr></thead>';

                    // Body
                    html += '<tbody>';
                    const totals = {};
                    sortimentiNazivi.forEach(s => totals[s] = 0);

                    odjeliArray.forEach((row, index) => {
                        const rowStyle = index % 2 === 0 ? 'background: #f9fafb;' : '';
                        html += '<tr style="' + rowStyle + '">';
                        html += '<td style="font-weight: 600; position: sticky; left: 0; background: ' + (index % 2 === 0 ? '#f9fafb' : 'white') + '; z-index: 9;">' + row.odjel + '</td>';

                        sortimentiNazivi.forEach(sortiment => {
                            const value = row.sortimenti[sortiment] || 0;
                            totals[sortiment] += value;

                            const colClass = getColumnGroup(sortiment);
                            let extraClass = '';
                            if (sortiment === 'ČETINARI') extraClass = ' col-cetinari';
                            else if (sortiment === 'LIŠĆARI') extraClass = ' col-liscari';
                            else if (sortiment === 'SVEUKUPNO') extraClass = ' col-sveukupno';

                            const displayValue = value === 0 ? '' : value.toFixed(2);
                            html += '<td class="sortiment-col right ' + colClass + extraClass + '">' + displayValue + '</td>';
                        });

                        html += '</tr>';
                    });

                    // UKUPNO row
                    html += '<tr style="background: #f9fafb; border-top: 3px solid #1f2937; font-weight: 700;">';
                    html += '<td style="position: sticky; left: 0; background: #f9fafb; z-index: 9; font-size: 15px; padding: 14px;">📊 UKUPNO</td>';

                    sortimentiNazivi.forEach(sortiment => {
                        const colClass = getColumnGroup(sortiment);
                        let extraClass = '';
                        if (sortiment === 'ČETINARI') extraClass = ' col-cetinari';
                        else if (sortiment === 'LIŠĆARI') extraClass = ' col-liscari';
                        else if (sortiment === 'SVEUKUPNO') extraClass = ' col-sveukupno';

                        html += '<td class="sortiment-col right ' + colClass + extraClass + '" style="font-weight: 700;">' + totals[sortiment].toFixed(2) + '</td>';
                    });

                    html += '</tr>';
                    html += '</tbody></table></div>';
                }

                html += '</div>';
            });

            container.innerHTML = html;
        }

        // ========================================
        // STANJE ODJELA - Trenutno stanje iz fajla ODJELI
        // ========================================

        // Globalne varijable za stanje odjela
        let stanjeOdjelaData = [];
        let stanjeOdjelaSortimenti = [];

        async function loadStanjeOdjela() {
            document.getElementById('loading-screen').classList.remove('hidden');

            try {
                // Load data from backend
                const url = API_URL + '?path=stanje-odjela&username=' + currentUser.username + '&password=' + currentPassword;
                const data = await fetchWithCache(url, `cache_stanje_odjela`);

                if (data.error) throw new Error(data.error);

                // Sačuvaj podatke globalno
                stanjeOdjelaData = data.data;
                stanjeOdjelaSortimenti = data.sortimentiNazivi;

                // Populiši dropdown sa radilištima
                populateStanjeOdjelaDropdown(data.data);

                // Render sections
                renderStanjeOdjelaSections(data.data, data.sortimentiNazivi);

                document.getElementById('loading-screen').classList.add('hidden');

            } catch (error) {
                console.error('Error loading stanje odjela:', error);
                showError('Greška', 'Greška pri učitavanju stanja odjela: ' + error.message);
                document.getElementById('loading-screen').classList.add('hidden');
            }
        }

        function populateStanjeOdjelaDropdown(data) {
            const select = document.getElementById('stanje-odjela-select');

            // Očisti postojeće opcije osim "Sva radilišta"
            select.innerHTML = '<option value="">Sva radilišta</option>';

            // Izvuci unique radilišta
            const radilistaSet = new Set();
            data.forEach(odjel => {
                if (odjel.radiliste) {
                    radilistaSet.add(odjel.radiliste);
                }
            });

            // Sortiraj i dodaj u dropdown
            const radilista = Array.from(radilistaSet).sort();
            radilista.forEach(radiliste => {
                const option = document.createElement('option');
                option.value = radiliste;
                option.textContent = radiliste;
                select.appendChild(option);
            });
        }

        function filterStanjeOdjela() {
            const selectedRadiliste = document.getElementById('stanje-odjela-select').value;

            if (selectedRadiliste === '') {
                // Prikaži sve
                renderStanjeOdjelaSections(stanjeOdjelaData, stanjeOdjelaSortimenti);
            } else {
                // Filtriraj samo izabrano radilište
                const filteredData = stanjeOdjelaData.filter(odjel => odjel.radiliste === selectedRadiliste);
                renderStanjeOdjelaSections(filteredData, stanjeOdjelaSortimenti);
            }
        }

        function renderStanjeOdjelaSections(data, sortimentiNazivi) {
            const container = document.getElementById('stanje-odjela-container');

            if (data.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280;">Nema podataka</div>';
                return;
            }

            let html = '';

            // Za svaki odjel kreiraj zasebnu sekciju
            data.forEach((odjelData, odjelIndex) => {
                const radiliste = odjelData.radiliste || odjelData.odjelNaziv;
                const odjelNaziv = odjelData.odjelNaziv;
                const redovi = odjelData.redovi;

                // Sekcija za svaki odjel
                html += '<div class="section" style="margin-bottom: 40px; border: 2px solid #d1d5db; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">';

                // Header radilišta
                html += '<div style="background: linear-gradient(135deg, #047857 0%, #059669 100%); padding: 16px 24px; border-bottom: 3px solid #10b981;">';
                html += '<h3 style="margin: 0; color: white; font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 12px;">';
                html += '<span style="font-size: 24px;">🏭</span>';
                html += '<div>';
                html += '<div>' + radiliste + '</div>';
                html += '<div style="font-size: 12px; font-weight: 400; opacity: 0.9; margin-top: 4px;">(' + odjelNaziv + ')</div>';
                html += '</div>';
                html += '</h3>';
                html += '</div>';

                // Tabela sa sortimentnim zaglavljem
                html += '<div style="overflow-x: auto;">';
                html += '<table style="width: 100%; border-collapse: collapse; background: white;">';

                // Sortimentno zaglavlje
                html += '<thead>';
                html += '<tr style="background: #f0fdf4; border-bottom: 2px solid #10b981;">';
                html += '<th style="padding: 14px 16px; text-align: left; font-weight: 700; color: #047857; border-right: 1px solid #d1d5db; min-width: 180px; position: sticky; left: 0; background: #f0fdf4; z-index: 10;">Vrsta</th>';

                sortimentiNazivi.forEach((sortiment, index) => {
                    const colClass = getColumnGroup(sortiment);
                    let bgColor = '#f0fdf4';
                    let textColor = '#047857';

                    if (sortiment === 'ČETINARI') {
                        bgColor = '#dbeafe';
                        textColor = '#1e40af';
                    } else if (sortiment === 'LIŠĆARI') {
                        bgColor = '#fef3c7';
                        textColor = '#92400e';
                    } else if (sortiment === 'SVEUKUPNO') {
                        bgColor = '#ede9fe';
                        textColor = '#5b21b6';
                    }

                    const borderRight = index < sortimentiNazivi.length - 1 ? 'border-right: 1px solid #d1d5db;' : '';
                    html += '<th style="padding: 14px 12px; text-align: right; font-weight: 700; font-size: 13px; color: ' + textColor + '; background: ' + bgColor + '; ' + borderRight + ' white-space: nowrap;">' + sortiment + '</th>';
                });

                html += '</tr>';
                html += '</thead>';

                // Body sa 4 reda
                html += '<tbody>';

                const vrste = [
                    { naziv: 'PROJEKAT', data: redovi.projekat, icon: '📋', bg: '#fef3c7', color: '#92400e', borderColor: '#fbbf24' },
                    { naziv: 'SJEČA', data: redovi.sjeca, icon: '🌲', bg: '#d1fae5', color: '#065f46', borderColor: '#10b981' },
                    { naziv: 'OTPREMA', data: redovi.otprema, icon: '🚛', bg: '#dbeafe', color: '#1e40af', borderColor: '#3b82f6' },
                    { naziv: 'ŠUMA-LAGER', data: redovi.sumaLager, icon: '📦', bg: '#e9d5ff', color: '#6b21a8', borderColor: '#a855f7' }
                ];

                vrste.forEach((vrsta, vrstaIndex) => {
                    const borderBottom = vrstaIndex < vrste.length - 1 ? 'border-bottom: 1px solid #e5e7eb;' : '';

                    html += '<tr style="' + borderBottom + '">';
                    html += '<td style="padding: 12px 16px; font-weight: 700; color: ' + vrsta.color + '; background: ' + vrsta.bg + '; border-right: 3px solid ' + vrsta.borderColor + '; position: sticky; left: 0; z-index: 5;">';
                    html += '<span style="display: inline-flex; align-items: center; gap: 8px;">';
                    html += '<span style="font-size: 20px;">' + vrsta.icon + '</span>';
                    html += '<span>' + vrsta.naziv + '</span>';
                    html += '</span>';
                    html += '</td>';

                    vrsta.data.forEach((value, index) => {
                        const sortiment = sortimentiNazivi[index];
                        let bgColor = 'white';

                        if (sortiment === 'ČETINARI') bgColor = '#eff6ff';
                        else if (sortiment === 'LIŠĆARI') bgColor = '#fffbeb';
                        else if (sortiment === 'SVEUKUPNO') bgColor = '#faf5ff';

                        const borderRight = index < sortimentiNazivi.length - 1 ? 'border-right: 1px solid #e5e7eb;' : '';
                        const displayValue = value === 0 ? '-' : value.toFixed(2);
                        const fontWeight = sortiment === 'SVEUKUPNO' ? 'font-weight: 700;' : '';

                        html += '<td style="padding: 12px; text-align: right; background: ' + bgColor + '; ' + borderRight + ' ' + fontWeight + ' color: #374151;">' + displayValue + '</td>';
                    });

                    html += '</tr>';
                });

                html += '</tbody>';
                html += '</table>';
                html += '</div>';
                html += '</div>';
            });

            container.innerHTML = html;
        }

        // Load pending count (for badge only)
        async function loadPendingCount() {
            try {
                const year = new Date().getFullYear();
                const url = API_URL + '?path=pending-unosi&year=' + year + '&username=' + currentUser.username + '&password=' + currentPassword;
                const response = await fetch(url);
                const data = await response.json();

                if (data.success && data.unosi) {
                    updatePendingBadge(data.unosi.length);
                }
            } catch (error) {
                console.error('Error loading pending count:', error);
            }
        }

        // Update pending badge count
        function updatePendingBadge(count) {
            const badge = document.getElementById('pending-count-badge');
            if (badge) {
                if (count > 0) {
                    badge.textContent = count;
                    badge.classList.add('show');
                } else {
                    badge.classList.remove('show');
                }
            }
        }

        // Edit pending unos (placeholder for future implementation)
        function editPendingUnos(id, tip) {
            showInfo('U razvoju', 'Uređivanje unosa #' + id + ' (Tip: ' + tip + ') - Ova funkcionalnost će biti dodana uskoro.');
            // Close dropdown
            const dropdown = document.getElementById('row-actions-' + id);
            if (dropdown) dropdown.classList.remove('show');
        }

        // Delete pending unos with modal confirmation
        function deletePendingUnos(id, tip) {
            // Close dropdown first
            const dropdown = document.getElementById('row-actions-' + id);
            if (dropdown) dropdown.classList.remove('show');

            // Show confirmation modal
            showConfirmModal(
                'Potvrda brisanja',
                'Da li ste sigurni da želite obrisati ovaj unos? (ID: ' + id + ', Tip: ' + tip + ')',
                async function() {
                    try {
                        const formData = new URLSearchParams();
                        formData.append('path', 'delete-pending');
                        formData.append('rowIndex', id);
                        // Convert tip to lowercase: SJEČA -> sjeca, OTPREMA -> otprema
                        const tipLower = tip === 'SJEČA' ? 'sjeca' : 'otprema';
                        formData.append('tip', tipLower);
                        formData.append('username', currentUser.username);
                        formData.append('password', currentPassword);

                        const url = API_URL + '?' + formData.toString();
                        const response = await fetch(url);
                        const result = await response.json();

                        if (result.success) {
                            showSuccess('Uspjeh', result.message);
                            loadPendingUnosi();
                        } else {
                            throw new Error(result.error || 'Unknown error');
                        }
                    } catch (error) {
                        showError('Greška', error.message);
                    }
                }
            );
        }

        // Calculate Sjeca totals automatically
        function calculateSjeca() {
            // Get all četinar values
            var flC = parseFloat(document.getElementById('sjeca-FL-C').value) || 0;
            var iC = parseFloat(document.getElementById('sjeca-I-C').value) || 0;
            var iiC = parseFloat(document.getElementById('sjeca-II-C').value) || 0;
            var iiiC = parseFloat(document.getElementById('sjeca-III-C').value) || 0;
            var rudno = parseFloat(document.getElementById('sjeca-RUDNO').value) || 0;
            var celDuga = parseFloat(document.getElementById('sjeca-CEL-DUGA').value) || 0;
            var celCijepana = parseFloat(document.getElementById('sjeca-CEL-CIJEPANA').value) || 0;

            // Calculate TRUPCI Č = F/L Č + I Č + II Č + III Č + RUDNO
            var trupciC = flC + iC + iiC + iiiC + rudno;
            document.getElementById('sjeca-TRUPCI-C').value = trupciC.toFixed(2);

            // Calculate ČETINARI = CEL.DUGA + CEL.CIJEPANA + TRUPCI Č
            var cetinari = celDuga + celCijepana + trupciC;
            document.getElementById('sjeca-CETINARI').value = cetinari.toFixed(2);

            // Get all lišćar values
            var flL = parseFloat(document.getElementById('sjeca-FL-L').value) || 0;
            var iL = parseFloat(document.getElementById('sjeca-I-L').value) || 0;
            var iiL = parseFloat(document.getElementById('sjeca-II-L').value) || 0;
            var iiiL = parseFloat(document.getElementById('sjeca-III-L').value) || 0;
            var ogrDugi = parseFloat(document.getElementById('sjeca-OGR-DUGI').value) || 0;
            var ogrCijepani = parseFloat(document.getElementById('sjeca-OGR-CIJEPANI').value) || 0;

            // Calculate TRUPCI L = F/L L + I L + II L + III L
            var trupciL = flL + iL + iiL + iiiL;
            document.getElementById('sjeca-TRUPCI').value = trupciL.toFixed(2);

            // Calculate LIŠĆARI = OGR.DUGI + OGR.CIJEPANI + TRUPCI L
            var liscari = ogrDugi + ogrCijepani + trupciL;
            document.getElementById('sjeca-LISCARI').value = liscari.toFixed(2);

            // Calculate SVEUKUPNO = ČETINARI + LIŠĆARI
            var sveukupno = cetinari + liscari;
            document.getElementById('sjeca-SVEUKUPNO').value = sveukupno.toFixed(2);
        }

        // Calculate Otprema totals automatically
        function calculateOtprema() {
            // Get all četinar values
            var flC = parseFloat(document.getElementById('otprema-FL-C').value) || 0;
            var iC = parseFloat(document.getElementById('otprema-I-C').value) || 0;
            var iiC = parseFloat(document.getElementById('otprema-II-C').value) || 0;
            var iiiC = parseFloat(document.getElementById('otprema-III-C').value) || 0;
            var rudno = parseFloat(document.getElementById('otprema-RUDNO').value) || 0;
            var celDuga = parseFloat(document.getElementById('otprema-CEL-DUGA').value) || 0;
            var celCijepana = parseFloat(document.getElementById('otprema-CEL-CIJEPANA').value) || 0;

            // Calculate TRUPCI Č = F/L Č + I Č + II Č + III Č + RUDNO
            var trupciC = flC + iC + iiC + iiiC + rudno;
            document.getElementById('otprema-TRUPCI-C').value = trupciC.toFixed(2);

            // Calculate ČETINARI = CEL.DUGA + CEL.CIJEPANA + TRUPCI Č
            var cetinari = celDuga + celCijepana + trupciC;
            document.getElementById('otprema-CETINARI').value = cetinari.toFixed(2);

            // Get all lišćar values
            var flL = parseFloat(document.getElementById('otprema-FL-L').value) || 0;
            var iL = parseFloat(document.getElementById('otprema-I-L').value) || 0;
            var iiL = parseFloat(document.getElementById('otprema-II-L').value) || 0;
            var iiiL = parseFloat(document.getElementById('otprema-III-L').value) || 0;
            var ogrDugi = parseFloat(document.getElementById('otprema-OGR-DUGI').value) || 0;
            var ogrCijepani = parseFloat(document.getElementById('otprema-OGR-CIJEPANI').value) || 0;

            // Calculate TRUPCI L = F/L L + I L + II L + III L
            var trupciL = flL + iL + iiL + iiiL;
            document.getElementById('otprema-TRUPCI').value = trupciL.toFixed(2);

            // Calculate LIŠĆARI = OGR.DUGI + OGR.CIJEPANI + TRUPCI L
            var liscari = ogrDugi + ogrCijepani + trupciL;
            document.getElementById('otprema-LISCARI').value = liscari.toFixed(2);

            // Calculate SVEUKUPNO = ČETINARI + LIŠĆARI
            var sveukupno = cetinari + liscari;
            document.getElementById('otprema-SVEUKUPNO').value = sveukupno.toFixed(2);
        }

        // Show Add Sjeca Form
        function showAddSjecaForm() {
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('add-sjeca-content').classList.remove('hidden');

            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('sjeca-datum').value = today;

            // Add event listeners to all sortimenti inputs for automatic calculation
            const sjecaInputIds = ['sjeca-FL-C', 'sjeca-I-C', 'sjeca-II-C', 'sjeca-III-C', 'sjeca-RUDNO',
                                   'sjeca-CEL-DUGA', 'sjeca-CEL-CIJEPANA',
                                   'sjeca-FL-L', 'sjeca-I-L', 'sjeca-II-L', 'sjeca-III-L',
                                   'sjeca-OGR-DUGI', 'sjeca-OGR-CIJEPANI'];

            sjecaInputIds.forEach(function(inputId) {
                const element = document.getElementById(inputId);
                if (element && !element.hasAttribute('data-listener-added')) {
                    element.addEventListener('input', calculateSjeca);
                    element.setAttribute('data-listener-added', 'true');
                }
            });

            // Initial calculation
            calculateSjeca();
        }

        // Show Add Otprema Form
        function showAddOtpremaForm() {
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('add-otprema-content').classList.remove('hidden');

            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('otprema-datum').value = today;

            // Add event listeners to all sortimenti inputs for automatic calculation
            const otpremaInputIds = ['otprema-FL-C', 'otprema-I-C', 'otprema-II-C', 'otprema-III-C', 'otprema-RUDNO',
                                     'otprema-CEL-DUGA', 'otprema-CEL-CIJEPANA',
                                     'otprema-FL-L', 'otprema-I-L', 'otprema-II-L', 'otprema-III-L',
                                     'otprema-OGR-DUGI', 'otprema-OGR-CIJEPANI'];

            otpremaInputIds.forEach(function(inputId) {
                const element = document.getElementById(inputId);
                if (element && !element.hasAttribute('data-listener-added')) {
                    element.addEventListener('input', calculateOtprema);
                    element.setAttribute('data-listener-added', 'true');
                }
            });

            // Initial calculation
            calculateOtprema();
        }

        // Submit Sjeca Form
        async function submitSjeca(event) {
            event.preventDefault();

            const submitBtn = document.getElementById('submit-sjeca-btn');
            const messageDiv = document.getElementById('sjeca-message');

            submitBtn.disabled = true;
            submitBtn.textContent = 'Dodavanje...';
            messageDiv.classList.add('hidden');

            try {
                // Collect form data
                const formData = new URLSearchParams();
                formData.append('path', 'add-sjeca');
                formData.append('username', currentUser.username);
                formData.append('password', currentPassword);
                formData.append('datum', document.getElementById('sjeca-datum').value);
                formData.append('odjel', document.getElementById('sjeca-odjel').value);
                formData.append('F/L Č', document.getElementById('sjeca-FL-C').value);
                formData.append('I Č', document.getElementById('sjeca-I-C').value);
                formData.append('II Č', document.getElementById('sjeca-II-C').value);
                formData.append('III Č', document.getElementById('sjeca-III-C').value);
                formData.append('RUDNO', document.getElementById('sjeca-RUDNO').value);
                formData.append('TRUPCI Č', document.getElementById('sjeca-TRUPCI-C').value);
                formData.append('CEL.DUGA', document.getElementById('sjeca-CEL-DUGA').value);
                formData.append('CEL.CIJEPANA', document.getElementById('sjeca-CEL-CIJEPANA').value);
                formData.append('ČETINARI', document.getElementById('sjeca-CETINARI').value);
                formData.append('F/L L', document.getElementById('sjeca-FL-L').value);
                formData.append('I L', document.getElementById('sjeca-I-L').value);
                formData.append('II L', document.getElementById('sjeca-II-L').value);
                formData.append('III L', document.getElementById('sjeca-III-L').value);
                formData.append('TRUPCI', document.getElementById('sjeca-TRUPCI').value);
                formData.append('OGR.DUGI', document.getElementById('sjeca-OGR-DUGI').value);
                formData.append('OGR.CIJEPANI', document.getElementById('sjeca-OGR-CIJEPANI').value);
                formData.append('LIŠĆARI', document.getElementById('sjeca-LISCARI').value);

                // Send request (don't cache this)
                const url = `${API_URL}?${formData.toString()}`;
                const response = await fetch(url);
                const result = await response.json();

                if (result.success) {
                    messageDiv.innerHTML = `✅ ${result.message}<br>Ukupno: ${result.ukupno.toFixed(2)} m³`;
                    messageDiv.style.background = '#d1fae5';
                    messageDiv.style.color = '#047857';
                    messageDiv.classList.remove('hidden');

                    // Reset form
                    setTimeout(() => {
                        resetSjecaForm();
                        messageDiv.classList.add('hidden');
                    }, 3000);

                    // Clear all sječa-related cache entries so new data shows up
                    clearCacheByPattern('primac');
                    clearCacheByPattern('primaci');
                    clearCacheByPattern('dashboard');
                    clearCacheByPattern('izvjestaji');
                    clearCacheByPattern('sedmicni_sjeca');
                    clearCacheByPattern('stanje_odjela');
                    clearCacheByPattern('my_sjece');
                } else {
                    throw new Error(result.error || 'Unknown error');
                }

            } catch (error) {
                messageDiv.innerHTML = `❌ Greška: ${error.message}`;
                messageDiv.style.background = '#fee2e2';
                messageDiv.style.color = '#991b1b';
                messageDiv.classList.remove('hidden');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Dodaj sječu';
            }
        }

        // Submit Otprema Form
        async function submitOtprema(event) {
            event.preventDefault();

            const submitBtn = document.getElementById('submit-otprema-btn');
            const messageDiv = document.getElementById('otprema-message');

            submitBtn.disabled = true;
            submitBtn.textContent = 'Dodavanje...';
            messageDiv.classList.add('hidden');

            try {
                // Collect form data
                const formData = new URLSearchParams();
                formData.append('path', 'add-otprema');
                formData.append('username', currentUser.username);
                formData.append('password', currentPassword);
                formData.append('datum', document.getElementById('otprema-datum').value);
                formData.append('odjel', document.getElementById('otprema-odjel').value);
                formData.append('kupac', document.getElementById('otprema-kupac').value);
                formData.append('brojOtpremnice', document.getElementById('otprema-broj-otpremnice').value);
                formData.append('F/L Č', document.getElementById('otprema-FL-C').value);
                formData.append('I Č', document.getElementById('otprema-I-C').value);
                formData.append('II Č', document.getElementById('otprema-II-C').value);
                formData.append('III Č', document.getElementById('otprema-III-C').value);
                formData.append('RUDNO', document.getElementById('otprema-RUDNO').value);
                formData.append('TRUPCI Č', document.getElementById('otprema-TRUPCI-C').value);
                formData.append('CEL.DUGA', document.getElementById('otprema-CEL-DUGA').value);
                formData.append('CEL.CIJEPANA', document.getElementById('otprema-CEL-CIJEPANA').value);
                formData.append('ČETINARI', document.getElementById('otprema-CETINARI').value);
                formData.append('F/L L', document.getElementById('otprema-FL-L').value);
                formData.append('I L', document.getElementById('otprema-I-L').value);
                formData.append('II L', document.getElementById('otprema-II-L').value);
                formData.append('III L', document.getElementById('otprema-III-L').value);
                formData.append('TRUPCI', document.getElementById('otprema-TRUPCI').value);
                formData.append('OGR.DUGI', document.getElementById('otprema-OGR-DUGI').value);
                formData.append('OGR.CIJEPANI', document.getElementById('otprema-OGR-CIJEPANI').value);
                formData.append('LIŠĆARI', document.getElementById('otprema-LISCARI').value);

                // Send request (don't cache this)
                const url = `${API_URL}?${formData.toString()}`;
                const response = await fetch(url);
                const result = await response.json();

                if (result.success) {
                    messageDiv.innerHTML = `✅ ${result.message}<br>Ukupno: ${result.ukupno.toFixed(2)} m³`;
                    messageDiv.style.background = '#dbeafe';
                    messageDiv.style.color = '#1e40af';
                    messageDiv.classList.remove('hidden');

                    // Reset form
                    setTimeout(() => {
                        resetOtpremaForm();
                        messageDiv.classList.add('hidden');
                    }, 3000);

                    // Clear all otprema-related cache entries so new data shows up
                    clearCacheByPattern('otpremac');
                    clearCacheByPattern('otpremaci');
                    clearCacheByPattern('dashboard');
                    clearCacheByPattern('kupci');
                    clearCacheByPattern('izvjestaji');
                    clearCacheByPattern('sedmicni_otprema');
                    clearCacheByPattern('stanje_odjela');
                    clearCacheByPattern('my_otpreme');
                } else {
                    throw new Error(result.error || 'Unknown error');
                }

            } catch (error) {
                messageDiv.innerHTML = `❌ Greška: ${error.message}`;
                messageDiv.style.background = '#fee2e2';
                messageDiv.style.color = '#991b1b';
                messageDiv.classList.remove('hidden');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Dodaj otpremu';
            }
        }

        // Reset Sjeca Form
        function resetSjecaForm() {
            document.getElementById('add-sjeca-form').reset();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('sjeca-datum').value = today;

            // Reset all sortimenti to 0
            document.querySelectorAll('#add-sjeca-form input[type="number"]').forEach(input => {
                input.value = 0;
            });

            // Recalculate totals
            calculateSjeca();
        }

        // Reset Otprema Form
        function resetOtpremaForm() {
            document.getElementById('add-otprema-form').reset();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('otprema-datum').value = today;

            // Reset all sortimenti to 0
            document.querySelectorAll('#add-otprema-form input[type="number"]').forEach(input => {
                input.value = 0;
            });

            // Recalculate totals
            calculateOtprema();
        }

        // ==================== MY PENDING ENTRIES FUNCTIONS ====================

        // Load My Sjece (last 10 pending entries for current user)
        async function loadMySjece() {
            document.getElementById('loading-screen').classList.remove('hidden');
            document.getElementById('my-sjece-content').classList.add('hidden');

            try {
                const url = API_URL + '?path=my-pending&username=' + currentUser.username + '&password=' + currentPassword + '&tip=sjeca';
                const data = await fetchWithCache(url, `cache_my_sjece_${currentUser.username}`);

                if (data.error) {
                    throw new Error(data.error);
                }

                var html = '<div style="overflow-x: auto;">';

                if (data.unosi && data.unosi.length > 0) {
                    html += '<table style="width: 100%; border-collapse: collapse; margin-top: 20px;">';
                    html += '<thead><tr style="background: #047857; color: white;">';
                    html += '<th style="padding: 12px; border: 1px solid #ddd;">Datum</th>';
                    html += '<th style="padding: 12px; border: 1px solid #ddd;">Odjel</th>';
                    html += '<th style="padding: 12px; border: 1px solid #ddd;">ČETINARI</th>';
                    html += '<th style="padding: 12px; border: 1px solid #ddd;">LIŠĆARI</th>';
                    html += '<th style="padding: 12px; border: 1px solid #ddd;">Ukupno</th>';
                    html += '<th style="padding: 12px; border: 1px solid #ddd;">Vrijeme unosa</th>';
                    html += '<th style="padding: 12px; border: 1px solid #ddd;">Akcije</th>';
                    html += '</tr></thead><tbody>';

                    for (var i = 0; i < data.unosi.length; i++) {
                        var unos = data.unosi[i];
                        var cetinari = parseFloat(unos.sortimenti['ČETINARI'] || 0);
                        var liscari = parseFloat(unos.sortimenti['LIŠĆARI'] || 0);
                        var ukupno = cetinari + liscari;

                        html += '<tr style="' + (i % 2 === 0 ? 'background: #f9fafb;' : '') + '">';
                        html += '<td style="padding: 10px; border: 1px solid #ddd;">' + unos.datum + '</td>';
                        html += '<td style="padding: 10px; border: 1px solid #ddd;">' + unos.odjel + '</td>';
                        html += '<td style="padding: 10px; border: 1px solid #ddd;">' + cetinari.toFixed(2) + ' m³</td>';
                        html += '<td style="padding: 10px; border: 1px solid #ddd;">' + liscari.toFixed(2) + ' m³</td>';
                        html += '<td style="padding: 10px; border: 1px solid #ddd; font-weight: bold;">' + ukupno.toFixed(2) + ' m³</td>';
                        html += '<td style="padding: 10px; border: 1px solid #ddd;">' + new Date(unos.timestamp).toLocaleString('hr-HR') + '</td>';
                        html += '<td style="padding: 10px; border: 1px solid #ddd; text-align: center;">';
                        html += '<button class="btn btn-primary" style="margin-right: 8px;" onclick=\'editMySjeca(' + JSON.stringify(unos).replace(/'/g, "\\'") + ')\'><✏️ Uredi</button>';
                        html += '<button class="btn btn-secondary" onclick="deleteMySjeca(' + unos.rowIndex + ')">🗑️ Obriši</button>';
                        html += '</td>';
                        html += '</tr>';
                    }

                    html += '</tbody></table>';
                } else {
                    html += '<p style="text-align: center; color: #6b7280; padding: 40px;">Nemate pending unosa.</p>';
                }

                html += '</div>';

                document.getElementById('my-sjece-container').innerHTML = html;
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('my-sjece-content').classList.remove('hidden');

            } catch (error) {
                console.error('Error loading my sjece:', error);
                document.getElementById('my-sjece-container').innerHTML = '<p style="color: #dc2626; text-align: center; padding: 40px;">Greška: ' + error.message + '</p>';
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('my-sjece-content').classList.remove('hidden');
            }
        }

        // Load My Otpreme (last 10 pending entries for current user)
        async function loadMyOtpreme() {
            document.getElementById('loading-screen').classList.remove('hidden');
            document.getElementById('my-otpreme-content').classList.add('hidden');

            try {
                const url = API_URL + '?path=my-pending&username=' + currentUser.username + '&password=' + currentPassword + '&tip=otprema';
                const data = await fetchWithCache(url, `cache_my_otpreme_${currentUser.username}`);

                if (data.error) {
                    throw new Error(data.error);
                }

                var html = '<div style="overflow-x: auto;">';

                if (data.unosi && data.unosi.length > 0) {
                    html += '<table style="width: 100%; border-collapse: collapse; margin-top: 20px;">';
                    html += '<thead><tr style="background: #2563eb; color: white;">';
                    html += '<th style="padding: 12px; border: 1px solid #ddd;">Datum</th>';
                    html += '<th style="padding: 12px; border: 1px solid #ddd;">Odjel</th>';
                    html += '<th style="padding: 12px; border: 1px solid #ddd;">Kupac</th>';
                    html += '<th style="padding: 12px; border: 1px solid #ddd;">Br. otpremnice</th>';
                    html += '<th style="padding: 12px; border: 1px solid #ddd;">ČETINARI</th>';
                    html += '<th style="padding: 12px; border: 1px solid #ddd;">LIŠĆARI</th>';
                    html += '<th style="padding: 12px; border: 1px solid #ddd;">Ukupno</th>';
                    html += '<th style="padding: 12px; border: 1px solid #ddd;">Vrijeme unosa</th>';
                    html += '<th style="padding: 12px; border: 1px solid #ddd;">Akcije</th>';
                    html += '</tr></thead><tbody>';

                    for (var i = 0; i < data.unosi.length; i++) {
                        var unos = data.unosi[i];
                        var cetinari = parseFloat(unos.sortimenti['ČETINARI'] || 0);
                        var liscari = parseFloat(unos.sortimenti['LIŠĆARI'] || 0);
                        var ukupno = cetinari + liscari;

                        html += '<tr style="' + (i % 2 === 0 ? 'background: #f9fafb;' : '') + '">';
                        html += '<td style="padding: 10px; border: 1px solid #ddd;">' + unos.datum + '</td>';
                        html += '<td style="padding: 10px; border: 1px solid #ddd;">' + unos.odjel + '</td>';
                        html += '<td style="padding: 10px; border: 1px solid #ddd;">' + (unos.kupac || '-') + '</td>';
                        html += '<td style="padding: 10px; border: 1px solid #ddd;">' + (unos.brojOtpremnice || '-') + '</td>';
                        html += '<td style="padding: 10px; border: 1px solid #ddd;">' + cetinari.toFixed(2) + ' m³</td>';
                        html += '<td style="padding: 10px; border: 1px solid #ddd;">' + liscari.toFixed(2) + ' m³</td>';
                        html += '<td style="padding: 10px; border: 1px solid #ddd; font-weight: bold;">' + ukupno.toFixed(2) + ' m³</td>';
                        html += '<td style="padding: 10px; border: 1px solid #ddd;">' + new Date(unos.timestamp).toLocaleString('hr-HR') + '</td>';
                        html += '<td style="padding: 10px; border: 1px solid #ddd; text-align: center;">';
                        html += '<button class="btn btn-primary" style="margin-right: 8px;" onclick=\'editMyOtprema(' + JSON.stringify(unos).replace(/'/g, "\\'") + ')\'>✏️ Uredi</button>';
                        html += '<button class="btn btn-secondary" onclick="deleteMyOtprema(' + unos.rowIndex + ')">🗑️ Obriši</button>';
                        html += '</td>';
                        html += '</tr>';
                    }

                    html += '</tbody></table>';
                } else {
                    html += '<p style="text-align: center; color: #6b7280; padding: 40px;">Nemate pending unosa.</p>';
                }

                html += '</div>';

                document.getElementById('my-otpreme-container').innerHTML = html;
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('my-otpreme-content').classList.remove('hidden');

            } catch (error) {
                console.error('Error loading my otpreme:', error);
                document.getElementById('my-otpreme-container').innerHTML = '<p style="color: #dc2626; text-align: center; padding: 40px;">Greška: ' + error.message + '</p>';
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('my-otpreme-content').classList.remove('hidden');
            }
        }

        // Edit My Sjeca - show edit form
        function editMySjeca(unos) {
            document.getElementById('loading-screen').classList.add('hidden');

            // Hide other content
            document.getElementById('my-sjece-content').classList.add('hidden');

            // Show edit form
            document.getElementById('edit-sjeca-content').classList.remove('hidden');

            // Populate form with existing data
            document.getElementById('edit-sjeca-rowIndex').value = unos.rowIndex;
            document.getElementById('edit-sjeca-datum').value = unos.datum;
            document.getElementById('edit-sjeca-odjel').value = unos.odjel;

            // Build sortimenti fields dynamically
            var sortimentiHtml = '';
            var sortimentiKeys = ['F/L Č', 'I Č', 'II Č', 'III Č', 'RUDNO', 'TRUPCI Č', 'CEL.DUGA', 'CEL.CIJEPANA', 'ČETINARI',
                                 'F/L L', 'I L', 'II L', 'III L', 'TRUPCI', 'OGR.DUGI', 'OGR.CIJEPANI', 'LIŠĆARI'];

            sortimentiKeys.forEach(function(key) {
                var fieldId = 'edit-sjeca-' + key.replace(/\//g, '').replace(/ /g, '-');
                var value = unos.sortimenti[key] || 0;
                var isCalculated = ['TRUPCI Č', 'ČETINARI', 'TRUPCI', 'LIŠĆARI'].indexOf(key) !== -1;
                var readonlyAttr = isCalculated ? 'readonly' : '';
                var styleExtra = isCalculated ? 'background: #f3f4f6; color: #374151; font-weight: 600;' : '';

                sortimentiHtml += '<div class="form-group">';
                sortimentiHtml += '<label>' + key + (isCalculated ? ': <span style="color: #6b7280; font-size: 0.85em;">(auto)</span>' : ':') + '</label>';
                sortimentiHtml += '<input type="number" step="0.01" id="' + fieldId + '" value="' + value + '" min="0" ' + readonlyAttr + ' class="edit-sjeca-input" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%; ' + styleExtra + '">';
                sortimentiHtml += '</div>';
            });

            document.getElementById('edit-sjeca-sortimenti').innerHTML = sortimentiHtml;

            // Add event listeners for auto-calculation
            var inputIds = ['edit-sjeca-FL-Č', 'edit-sjeca-I-Č', 'edit-sjeca-II-Č', 'edit-sjeca-III-Č', 'edit-sjeca-RUDNO',
                           'edit-sjeca-CEL.DUGA', 'edit-sjeca-CEL.CIJEPANA',
                           'edit-sjeca-FL-L', 'edit-sjeca-I-L', 'edit-sjeca-II-L', 'edit-sjeca-III-L',
                           'edit-sjeca-OGR.DUGI', 'edit-sjeca-OGR.CIJEPANI'];

            inputIds.forEach(function(inputId) {
                var element = document.getElementById(inputId);
                if (element) {
                    element.addEventListener('input', calculateEditSjeca);
                }
            });

            // Calculate initial totals
            calculateEditSjeca();
        }

        // Calculate Edit Sjeca totals
        function calculateEditSjeca() {
            var flC = parseFloat(document.getElementById('edit-sjeca-FL-Č').value) || 0;
            var iC = parseFloat(document.getElementById('edit-sjeca-I-Č').value) || 0;
            var iiC = parseFloat(document.getElementById('edit-sjeca-II-Č').value) || 0;
            var iiiC = parseFloat(document.getElementById('edit-sjeca-III-Č').value) || 0;
            var rudno = parseFloat(document.getElementById('edit-sjeca-RUDNO').value) || 0;
            var celDuga = parseFloat(document.getElementById('edit-sjeca-CEL.DUGA').value) || 0;
            var celCijepana = parseFloat(document.getElementById('edit-sjeca-CEL.CIJEPANA').value) || 0;

            var trupciC = flC + iC + iiC + iiiC + rudno;
            document.getElementById('edit-sjeca-TRUPCI-Č').value = trupciC.toFixed(2);

            var cetinari = celDuga + celCijepana + trupciC;
            document.getElementById('edit-sjeca-ČETINARI').value = cetinari.toFixed(2);

            var flL = parseFloat(document.getElementById('edit-sjeca-FL-L').value) || 0;
            var iL = parseFloat(document.getElementById('edit-sjeca-I-L').value) || 0;
            var iiL = parseFloat(document.getElementById('edit-sjeca-II-L').value) || 0;
            var iiiL = parseFloat(document.getElementById('edit-sjeca-III-L').value) || 0;
            var ogrDugi = parseFloat(document.getElementById('edit-sjeca-OGR.DUGI').value) || 0;
            var ogrCijepani = parseFloat(document.getElementById('edit-sjeca-OGR.CIJEPANI').value) || 0;

            var trupciL = flL + iL + iiL + iiiL;
            document.getElementById('edit-sjeca-TRUPCI').value = trupciL.toFixed(2);

            var liscari = ogrDugi + ogrCijepani + trupciL;
            document.getElementById('edit-sjeca-LIŠĆARI').value = liscari.toFixed(2);

            var sveukupno = cetinari + liscari;
            document.getElementById('edit-sjeca-SVEUKUPNO').value = sveukupno.toFixed(2);
        }

        // Submit Edit Sjeca Form
        async function submitEditSjeca(event) {
            event.preventDefault();

            var submitBtn = document.getElementById('submit-edit-sjeca-btn');
            var messageDiv = document.getElementById('edit-sjeca-message');

            submitBtn.disabled = true;
            submitBtn.textContent = 'Ažuriranje...';
            messageDiv.classList.add('hidden');

            try {
                var formData = new URLSearchParams();
                formData.append('path', 'update-pending');
                formData.append('username', currentUser.username);
                formData.append('password', currentPassword);
                formData.append('tip', 'sjeca');
                formData.append('rowIndex', document.getElementById('edit-sjeca-rowIndex').value);
                formData.append('datum', document.getElementById('edit-sjeca-datum').value);
                formData.append('odjel', document.getElementById('edit-sjeca-odjel').value);

                // Add all sortimenti
                var sortimentiKeys = ['F/L Č', 'I Č', 'II Č', 'III Č', 'RUDNO', 'TRUPCI Č', 'CEL.DUGA', 'CEL.CIJEPANA', 'ČETINARI',
                                     'F/L L', 'I L', 'II L', 'III L', 'TRUPCI', 'OGR.DUGI', 'OGR.CIJEPANI', 'LIŠĆARI'];

                sortimentiKeys.forEach(function(key) {
                    var fieldId = 'edit-sjeca-' + key.replace(/\//g, '').replace(/ /g, '-');
                    var value = document.getElementById(fieldId).value;
                    formData.append(key, value);
                });

                var url = API_URL + '?' + formData.toString();
                var response = await fetch(url);
                var result = await response.json();

                if (result.success) {
                    messageDiv.innerHTML = '✅ ' + result.message + '<br>Ukupno: ' + result.ukupno.toFixed(2) + ' m³';
                    messageDiv.style.background = '#d1fae5';
                    messageDiv.style.color = '#047857';
                    messageDiv.classList.remove('hidden');

                    setTimeout(function() {
                        switchTab('my-sjece');
                    }, 2000);
                } else {
                    throw new Error(result.error || 'Unknown error');
                }

            } catch (error) {
                messageDiv.innerHTML = '❌ Greška: ' + error.message;
                messageDiv.style.background = '#fee2e2';
                messageDiv.style.color = '#991b1b';
                messageDiv.classList.remove('hidden');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Sačuvaj izmjene';
            }
        }

        // Cancel Edit Sjeca
        function cancelEditSjeca() {
            switchTab('my-sjece');
        }

        // Similar functions for Edit Otprema (abbreviated for space)
        function editMyOtprema(unos) {
            // Similar to editMySjeca but for otprema
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('my-otpreme-content').classList.add('hidden');
            document.getElementById('edit-otprema-content').classList.remove('hidden');

            document.getElementById('edit-otprema-rowIndex').value = unos.rowIndex;
            document.getElementById('edit-otprema-datum').value = unos.datum;
            document.getElementById('edit-otprema-odjel').value = unos.odjel;
            document.getElementById('edit-otprema-kupac').value = unos.kupac || '';
            document.getElementById('edit-otprema-broj-otpremnice').value = unos.brojOtpremnice || '';

            var sortimentiHtml = '';
            var sortimentiKeys = ['F/L Č', 'I Č', 'II Č', 'III Č', 'RUDNO', 'TRUPCI Č', 'CEL.DUGA', 'CEL.CIJEPANA', 'ČETINARI',
                                 'F/L L', 'I L', 'II L', 'III L', 'TRUPCI', 'OGR.DUGI', 'OGR.CIJEPANI', 'LIŠĆARI'];

            sortimentiKeys.forEach(function(key) {
                var fieldId = 'edit-otprema-' + key.replace(/\//g, '').replace(/ /g, '-');
                var value = unos.sortimenti[key] || 0;
                var isCalculated = ['TRUPCI Č', 'ČETINARI', 'TRUPCI', 'LIŠĆARI'].indexOf(key) !== -1;
                var readonlyAttr = isCalculated ? 'readonly' : '';
                var styleExtra = isCalculated ? 'background: #f3f4f6; color: #374151; font-weight: 600;' : '';

                sortimentiHtml += '<div class="form-group">';
                sortimentiHtml += '<label>' + key + (isCalculated ? ': <span style="color: #6b7280; font-size: 0.85em;">(auto)</span>' : ':') + '</label>';
                sortimentiHtml += '<input type="number" step="0.01" id="' + fieldId + '" value="' + value + '" min="0" ' + readonlyAttr + ' style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%; ' + styleExtra + '">';
                sortimentiHtml += '</div>';
            });

            document.getElementById('edit-otprema-sortimenti').innerHTML = sortimentiHtml;

            var inputIds = ['edit-otprema-FL-Č', 'edit-otprema-I-Č', 'edit-otprema-II-Č', 'edit-otprema-III-Č', 'edit-otprema-RUDNO',
                           'edit-otprema-CEL.DUGA', 'edit-otprema-CEL.CIJEPANA',
                           'edit-otprema-FL-L', 'edit-otprema-I-L', 'edit-otprema-II-L', 'edit-otprema-III-L',
                           'edit-otprema-OGR.DUGI', 'edit-otprema-OGR.CIJEPANI'];

            inputIds.forEach(function(inputId) {
                var element = document.getElementById(inputId);
                if (element) {
                    element.addEventListener('input', calculateEditOtprema);
                }
            });

            calculateEditOtprema();
        }

        function calculateEditOtprema() {
            var flC = parseFloat(document.getElementById('edit-otprema-FL-Č').value) || 0;
            var iC = parseFloat(document.getElementById('edit-otprema-I-Č').value) || 0;
            var iiC = parseFloat(document.getElementById('edit-otprema-II-Č').value) || 0;
            var iiiC = parseFloat(document.getElementById('edit-otprema-III-Č').value) || 0;
            var rudno = parseFloat(document.getElementById('edit-otprema-RUDNO').value) || 0;
            var celDuga = parseFloat(document.getElementById('edit-otprema-CEL.DUGA').value) || 0;
            var celCijepana = parseFloat(document.getElementById('edit-otprema-CEL.CIJEPANA').value) || 0;

            var trupciC = flC + iC + iiC + iiiC + rudno;
            document.getElementById('edit-otprema-TRUPCI-Č').value = trupciC.toFixed(2);

            var cetinari = celDuga + celCijepana + trupciC;
            document.getElementById('edit-otprema-ČETINARI').value = cetinari.toFixed(2);

            var flL = parseFloat(document.getElementById('edit-otprema-FL-L').value) || 0;
            var iL = parseFloat(document.getElementById('edit-otprema-I-L').value) || 0;
            var iiL = parseFloat(document.getElementById('edit-otprema-II-L').value) || 0;
            var iiiL = parseFloat(document.getElementById('edit-otprema-III-L').value) || 0;
            var ogrDugi = parseFloat(document.getElementById('edit-otprema-OGR.DUGI').value) || 0;
            var ogrCijepani = parseFloat(document.getElementById('edit-otprema-OGR.CIJEPANI').value) || 0;

            var trupciL = flL + iL + iiL + iiiL;
            document.getElementById('edit-otprema-TRUPCI').value = trupciL.toFixed(2);

            var liscari = ogrDugi + ogrCijepani + trupciL;
            document.getElementById('edit-otprema-LIŠĆARI').value = liscari.toFixed(2);

            var sveukupno = cetinari + liscari;
            document.getElementById('edit-otprema-SVEUKUPNO').value = sveukupno.toFixed(2);
        }

        async function submitEditOtprema(event) {
            event.preventDefault();

            var submitBtn = document.getElementById('submit-edit-otprema-btn');
            var messageDiv = document.getElementById('edit-otprema-message');

            submitBtn.disabled = true;
            submitBtn.textContent = 'Ažuriranje...';
            messageDiv.classList.add('hidden');

            try {
                var formData = new URLSearchParams();
                formData.append('path', 'update-pending');
                formData.append('username', currentUser.username);
                formData.append('password', currentPassword);
                formData.append('tip', 'otprema');
                formData.append('rowIndex', document.getElementById('edit-otprema-rowIndex').value);
                formData.append('datum', document.getElementById('edit-otprema-datum').value);
                formData.append('odjel', document.getElementById('edit-otprema-odjel').value);
                formData.append('kupac', document.getElementById('edit-otprema-kupac').value);
                formData.append('brojOtpremnice', document.getElementById('edit-otprema-broj-otpremnice').value);

                var sortimentiKeys = ['F/L Č', 'I Č', 'II Č', 'III Č', 'RUDNO', 'TRUPCI Č', 'CEL.DUGA', 'CEL.CIJEPANA', 'ČETINARI',
                                     'F/L L', 'I L', 'II L', 'III L', 'TRUPCI', 'OGR.DUGI', 'OGR.CIJEPANI', 'LIŠĆARI'];

                sortimentiKeys.forEach(function(key) {
                    var fieldId = 'edit-otprema-' + key.replace(/\//g, '').replace(/ /g, '-');
                    var value = document.getElementById(fieldId).value;
                    formData.append(key, value);
                });

                var url = API_URL + '?' + formData.toString();
                var response = await fetch(url);
                var result = await response.json();

                if (result.success) {
                    messageDiv.innerHTML = '✅ ' + result.message + '<br>Ukupno: ' + result.ukupno.toFixed(2) + ' m³';
                    messageDiv.style.background = '#dbeafe';
                    messageDiv.style.color = '#1e40af';
                    messageDiv.classList.remove('hidden');

                    setTimeout(function() {
                        switchTab('my-otpreme');
                    }, 2000);
                } else {
                    throw new Error(result.error || 'Unknown error');
                }

            } catch (error) {
                messageDiv.innerHTML = '❌ Greška: ' + error.message;
                messageDiv.style.background = '#fee2e2';
                messageDiv.style.color = '#991b1b';
                messageDiv.classList.remove('hidden');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Sačuvaj izmjene';
            }
        }

        function cancelEditOtprema() {
            switchTab('my-otpreme');
        }

        // Delete functions
        async function deleteMySjeca(rowIndex) {
            showConfirmModal(
                'Potvrda brisanja',
                'Da li ste sigurni da želite obrisati ovaj unos sječe?',
                async function() {
                    try {
                        var formData = new URLSearchParams();
                        formData.append('path', 'delete-pending');
                        formData.append('username', currentUser.username);
                        formData.append('password', currentPassword);
                        formData.append('tip', 'sjeca');
                        formData.append('rowIndex', rowIndex);

                        var url = API_URL + '?' + formData.toString();
                        var response = await fetch(url);
                        var result = await response.json();

                        if (result.success) {
                            showSuccess('Uspjeh', result.message);
                            loadMySjece();
                        } else {
                            throw new Error(result.error || 'Unknown error');
                        }
                    } catch (error) {
                        showError('Greška', error.message);
                    }
                }
            );
        }

        async function deleteMyOtprema(rowIndex) {
            showConfirmModal(
                'Potvrda brisanja',
                'Da li ste sigurni da želite obrisati ovaj unos otpreme?',
                async function() {
                    try {
                        var formData = new URLSearchParams();
                        formData.append('path', 'delete-pending');
                        formData.append('username', currentUser.username);
                        formData.append('password', currentPassword);
                        formData.append('tip', 'otprema');
                        formData.append('rowIndex', rowIndex);

                        var url = API_URL + '?' + formData.toString();
                        var response = await fetch(url);
                        var result = await response.json();

                        if (result.success) {
                            showSuccess('Uspjeh', result.message);
                            loadMyOtpreme();
                        } else {
                            throw new Error(result.error || 'Unknown error');
                        }
                    } catch (error) {
                        showError('Greška', error.message);
                    }
                }
            );
        }

        // ============================================
        // MODAL FUNCTIONS
        // ============================================

        let confirmCallback = null;

        function showConfirmModal(title, message, onConfirm) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-body').textContent = message;
            confirmCallback = onConfirm;
            document.getElementById('confirm-modal').classList.add('show');

            document.getElementById('modal-confirm-btn').onclick = function() {
                if (confirmCallback) confirmCallback();
                closeConfirmModal();
            };
        }

        function closeConfirmModal() {
            document.getElementById('confirm-modal').classList.remove('show');
            confirmCallback = null;
        }

        // Close modal on overlay click
        document.getElementById('confirm-modal').addEventListener('click', function(e) {
            if (e.target.id === 'confirm-modal') {
                closeConfirmModal();
            }
        });

        // ============================================
        // FILTER FUNCTIONS
        // ============================================

        let unfilteredPendingData = [];

        function applyFilters() {
            const datumOd = document.getElementById('filter-datum-od')?.value;
            const datumDo = document.getElementById('filter-datum-do')?.value;
            const tip = document.getElementById('filter-tip')?.value;
            const search = document.getElementById('filter-search')?.value.toLowerCase();

            let filtered = [...unfilteredPendingData];

            // Filter by date range
            if (datumOd) {
                filtered = filtered.filter(item => {
                    const itemDate = new Date(item.timestampObj);
                    return itemDate >= new Date(datumOd);
                });
            }
            if (datumDo) {
                filtered = filtered.filter(item => {
                    const itemDate = new Date(item.timestampObj);
                    return itemDate <= new Date(datumDo + 'T23:59:59');
                });
            }

            // Filter by type
            if (tip) {
                filtered = filtered.filter(item => item.tip === tip);
            }

            // Filter by search text
            if (search) {
                filtered = filtered.filter(item => {
                    const searchText = (
                        (item.odjel || '') + ' ' +
                        (item.radnik || '') + ' ' +
                        (item.kupac || '')
                    ).toLowerCase();
                    return searchText.includes(search);
                });
            }

            // Re-render table with filtered data
            renderPendingTable(filtered);
        }

        function clearFilters() {
            const filterDatumOd = document.getElementById('filter-datum-od');
            const filterDatumDo = document.getElementById('filter-datum-do');
            const filterTip = document.getElementById('filter-tip');
            const filterSearch = document.getElementById('filter-search');

            if (filterDatumOd) filterDatumOd.value = '';
            if (filterDatumDo) filterDatumDo.value = '';
            if (filterTip) filterTip.value = '';
            if (filterSearch) filterSearch.value = '';

            renderPendingTable(unfilteredPendingData);
        }

        // ============================================
        // ROW ACTIONS DROPDOWN
        // ============================================

        function toggleRowActions(id) {
            const dropdown = document.getElementById('row-actions-' + id);
            const allDropdowns = document.querySelectorAll('.row-actions-dropdown');

            // Close all other dropdowns
            allDropdowns.forEach(d => {
                if (d.id !== 'row-actions-' + id) {
                    d.classList.remove('show');
                }
            });

            // Toggle this dropdown
            dropdown.classList.toggle('show');
        }

        // Close row actions when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.row-actions')) {
                const allDropdowns = document.querySelectorAll('.row-actions-dropdown');
                allDropdowns.forEach(d => d.classList.remove('show'));
            }
        });

        // ============================================
        // OPERATIVA & ANALYTICS FUNCTIONS
        // ============================================

        // Load OPERATIVA screen and populate analytics
        function loadOperativa() {
            console.log('Loading Operativa screen...');
            document.getElementById('operativa-content').classList.remove('hidden');
            document.getElementById('loading-screen').classList.add('hidden');

            // Load stats data for current year
            const year = new Date().getFullYear();
            loadStatsForOperativa(year);
        }

        // Load and transform data for OPERATIVA screen
        async function loadStatsForOperativa(year) {
            try {
                // Fetch dashboard data (30s timeout for heavy endpoint)
                const dashboardUrl = `${API_URL}?path=dashboard&year=${year}&username=${currentUser.username}&password=${currentPassword}`;
                const dashboardData = await fetchWithCache(dashboardUrl, 'cache_dashboard_' + year, false, 30000);

                // Fetch odjeli data (30s timeout for heavy endpoint)
                const odjeliUrl = `${API_URL}?path=odjeli&year=${year}&username=${currentUser.username}&password=${currentPassword}`;
                const odjeliResponse = await fetchWithCache(odjeliUrl, 'cache_odjeli_' + year, false, 30000);

                // **NOVO: Fetch STANJE ODJELA data (sa PROJEKAT podacima iz Excel redova 10-13)**
                const stanjeOdjelaUrl = `${API_URL}?path=stanje-odjela&username=${currentUser.username}&password=${currentPassword}`;
                const stanjeOdjelaData = await fetchWithCache(stanjeOdjelaUrl, 'cache_stanje_odjela');

                console.log('Dashboard data for OPERATIVA:', dashboardData);
                console.log('Odjeli data for OPERATIVA:', odjeliResponse);
                console.log('STANJE ODJELA data for OPERATIVA (PROJEKAT source):', stanjeOdjelaData);

                // DEBUG: Log odjeli count and total from API
                if (odjeliResponse && odjeliResponse.odjeli) {
                    const odjeliCount = odjeliResponse.odjeli.length;
                    const totalFromAPI = odjeliResponse.odjeli.reduce((sum, o) => sum + (o.sjeca || 0), 0);
                    console.log(`=== ODJELI API SUMMARY ===`);
                    console.log(`Total odjela in API: ${odjeliCount}`);
                    console.log(`Total sječa from API (direct): ${totalFromAPI.toFixed(2)} m³`);
                    console.log(`Expected total: ~68171 m³`);
                    if (Math.abs(totalFromAPI - 68171) > 1000) {
                        console.warn(`⚠️ SUMA DISCREPANCY: ${(totalFromAPI - 68171).toFixed(2)} m³ difference!`);
                    }
                }

                if (dashboardData.error || odjeliResponse.error) {
                    console.error('Error loading OPERATIVA data');
                    return;
                }

                // Transform dashboard data to OPERATIVA format
                const totalPrimka = dashboardData.mjesecnaStatistika.reduce((sum, m) => sum + (m.sjeca || 0), 0);
                const totalOtprema = dashboardData.mjesecnaStatistika.reduce((sum, m) => sum + (m.otprema || 0), 0);

                // Transform monthly stats: mjesecnaStatistika -> monthlyStats
                const monthlyStats = dashboardData.mjesecnaStatistika.map(m => ({
                    mjesec: m.mjesec,
                    sječa: m.sjeca || 0,
                    otprema: m.otprema || 0,
                    stanje: m.stanje || 0,
                    dinamika: m.dinamika || 0
                }));

                // **IMPROVED: Enrich odjeli data with PROJEKAT from STANJE ODJELA (red 10 Excel)**
                const odjeliStats = {};
                if (odjeliResponse.odjeli && odjeliResponse.odjeli.length > 0) {
                    odjeliResponse.odjeli.forEach(odjel => {
                        // Find matching odjel in STANJE ODJELA data
                        let projekatTotal = 0;
                        let radilisteNaziv = '';
                        let zadnjiDatum = null;

                        if (stanjeOdjelaData && stanjeOdjelaData.data && odjel.odjel) {
                            // ✅ Convert odjel.odjel to string to prevent "includes is not a function" error
                            const odjelStr = String(odjel.odjel || '').toLowerCase();
                            const stanjeMatch = stanjeOdjelaData.data.find(s =>
                                s.odjelNaziv.toLowerCase().includes(odjelStr) ||
                                odjelStr.includes(s.odjelNaziv.replace('.xlsx', '').toLowerCase())
                            );

                            if (stanjeMatch && stanjeMatch.redovi && stanjeMatch.redovi.projekat) {
                                // Sum all sortimenti from projekat row (red 10 iz Excel-a)
                                projekatTotal = stanjeMatch.redovi.projekat.reduce((sum, val) => sum + (val || 0), 0);
                                radilisteNaziv = stanjeMatch.radiliste || '';
                                zadnjiDatum = stanjeMatch.zadnjiDatum;

                                // DEBUG: Log projekat sources za GRMEČ JASENICA 39
                                const odjelDebugStr = String(odjel.odjel || '');
                                if (odjel.odjel && (odjelDebugStr.includes('JASENICA 39') || odjelDebugStr.includes('GRMEČ'))) {
                                    console.log('=== DEBUG GRMEČ JASENICA 39 ===');
                                    console.log('Odjel name:', odjel.odjel);
                                    console.log('odjel.projekat (U11 from handleOdjeli):', odjel.projekat);
                                    console.log('projekatTotal (STANJE ODJELA red 10):', projekatTotal);
                                    console.log('stanjeMatch.odjelNaziv:', stanjeMatch.odjelNaziv);
                                    console.log('stanjeMatch.redovi.projekat:', stanjeMatch.redovi.projekat);
                                }
                            }
                        }

                        // DEBUG: Check for duplicate odjeli
                        if (odjeliStats[odjel.odjel]) {
                            console.warn('DUPLICATE ODJEL DETECTED:', odjel.odjel, 'Previous:', odjeliStats[odjel.odjel], 'New:', odjel);
                        }

                        odjeliStats[odjel.odjel] = {
                            sječa: odjel.sjeca || 0,
                            otprema: odjel.otprema || 0,
                            projekat: (odjel.projekat && odjel.projekat > 0) ? odjel.projekat : projekatTotal, // Use odjel.projekat (U11) as primary source
                            ukupnoPosjeklo: odjel.sjeca || 0,
                            zadnjaSjeca: odjel.zadnjaSjeca || 0,
                            datumZadnjeSjece: odjel.datumZadnjeSjece || '',
                            radiliste: radilisteNaziv || odjel.radiliste || '',
                            izvođač: (odjel.izvođač || '').trim(), // Trim whitespace to prevent duplicates
                            zadnjiDatumUnosa: odjel.datumZadnjeSjece || '' // Use formatted date from odjel, not stanjeMatch
                        };
                    });
                }

                // Create transformed data object
                const transformedData = {
                    totalPrimka,
                    totalOtprema,
                    monthlyStats,
                    odjeliStats,
                    stanjeOdjelaRaw: stanjeOdjelaData // Pass raw data for additional features
                };

                console.log('Transformed data for OPERATIVA (enriched with PROJEKAT):', transformedData);

                // Load OPERATIVA with transformed data
                loadOperativaData(transformedData);

            } catch (error) {
                console.error('Error in loadStatsForOperativa:', error);
            }
        }

        // Main data processing for Operativa screen
        function loadOperativaData(data) {
            console.log('Processing Operativa data:', data);

            // Calculate KPIs
            const totalPrimka = data.totalPrimka || 0;
            const totalOtprema = data.totalOtprema || 0;
            const ratio = totalOtprema > 0 ? (totalPrimka / totalOtprema).toFixed(2) : '0.00';

            // Count odjeli
            const odjeliCount = Object.keys(data.odjeliStats || {}).length;

            // Calculate average projekat completion
            let totalProjekat = 0;
            let totalOstvareno = 0;
            Object.values(data.odjeliStats || {}).forEach(stats => {
                totalProjekat += stats.projekat || 0;
                totalOstvareno += stats.ukupnoPosjeklo || stats.sječa || 0;
            });
            const procenatOstvarenja = totalProjekat > 0
                ? ((totalOstvareno / totalProjekat) * 100).toFixed(0)
                : '0';

            // Calculate monthly averages
            const monthlyStats = data.monthlyStats || [];
            const avgMonthlySjeca = monthlyStats.length > 0
                ? (monthlyStats.reduce((sum, m) => sum + (m.sječa || 0), 0) / monthlyStats.length).toFixed(2)
                : '0.00';
            const avgMonthlyOtprema = monthlyStats.length > 0
                ? (monthlyStats.reduce((sum, m) => sum + (m.otprema || 0), 0) / monthlyStats.length).toFixed(2)
                : '0.00';

            // Update KPI cards
            document.getElementById('kpi-ratio').textContent = ratio;
            document.getElementById('kpi-procenat').textContent = procenatOstvarenja + '%';
            document.getElementById('kpi-odjela').textContent = odjeliCount;
            document.getElementById('kpi-avg-sjeca').textContent = odjeliCount > 0
                ? (totalPrimka / odjeliCount).toFixed(0) + ' m³'
                : '0 m³';

            // Update monthly averages
            document.getElementById('avg-monthly-sjeca').textContent = avgMonthlySjeca + ' m³';
            document.getElementById('avg-monthly-otprema').textContent = avgMonthlyOtprema + ' m³';

            // Render components
            renderTopOdjeli(data.odjeliStats || {});
            renderProjekatOstvareno(data.odjeliStats || {});
            renderAnalyticsChart(monthlyStats);
            renderAnalyticsOdjeliTable(data.odjeliStats || {});

            // Render new features
            renderPerformanceAlerts(data.odjeliStats || {});
            renderIzvodjaciPerformance(data.odjeliStats || {});
            renderTimelineUnosi(data.odjeliStats || {});

            // Render additional analytics features
            renderSeasonalAnalysis(monthlyStats);
        }

        // Render Top 5 Odjela by Sječa
        function renderTopOdjeli(odjeliStats) {
            const sorted = Object.entries(odjeliStats)
                .sort((a, b) => (b[1].sječa || 0) - (a[1].sječa || 0))
                .slice(0, 5);

            const html = sorted.length > 0
                ? sorted.map((entry, index) => {
                    const [odjel, stats] = entry;
                    const rankClass = index < 3 ? 'top' : '';
                    return `
                        <div class="ranking-item">
                            <div class="ranking-number ${rankClass}">${index + 1}</div>
                            <div class="ranking-info">
                                <div class="ranking-name">${odjel}</div>
                                <div class="ranking-value">${(stats.sječa || 0).toFixed(2)} m³</div>
                            </div>
                        </div>
                    `;
                }).join('')
                : '<p style="color: #6b7280; text-align: center; padding: 20px;">Nema podataka</p>';

            document.getElementById('top-odjeli-list').innerHTML = html;
        }

        // Render Projekat vs Ostvareno progress bars
        function renderProjekatOstvareno(odjeliStats) {
            const sorted = Object.entries(odjeliStats)
                .filter(([_, stats]) => (stats.projekat || 0) > 0)
                .map(([odjel, stats]) => ({
                    odjel,
                    projekat: stats.projekat || 0,
                    ostvareno: stats.ukupnoPosjeklo || stats.sječa || 0,
                    procenat: (stats.projekat || 0) > 0
                        ? (((stats.ukupnoPosjeklo || stats.sječa || 0) / stats.projekat) * 100)
                        : 0
                }))
                .sort((a, b) => b.procenat - a.procenat)
                .slice(0, 5);

            const html = sorted.length > 0
                ? sorted.map(item => {
                    const barWidth = Math.min(item.procenat, 100);
                    const colorClass = item.procenat >= 90 ? 'green'
                                     : item.procenat >= 70 ? 'blue'
                                     : 'red';
                    const barColor = item.procenat >= 90 ? '#059669'
                                   : item.procenat >= 70 ? '#2563eb'
                                   : '#dc2626';

                    return `
                        <div style="margin-bottom: 16px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                <span style="font-weight: 600; color: #1f2937;">${item.odjel}</span>
                                <span style="font-weight: 700; color: #059669;">${item.procenat.toFixed(1)}%</span>
                            </div>
                            <div class="progress-bar-container" style="height: 12px;">
                                <div class="progress-bar-fill ${colorClass}" style="width: ${barWidth}%; background: ${barColor};"></div>
                            </div>
                            <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">
                                ${item.ostvareno.toFixed(0)} / ${item.projekat.toFixed(0)} m³
                            </div>
                        </div>
                    `;
                }).join('')
                : '<p style="color: #6b7280; text-align: center; padding: 20px;">Nema podataka o projektu</p>';

            document.getElementById('projekat-ostvareno-list').innerHTML = html;
        }

        // Render SVG Analytics Chart (Monthly Trend)
        function renderAnalyticsChart(monthlyStats) {
            const svg = document.getElementById('analytics-chart');
            if (!svg) return;

            const padding = { top: 20, right: 40, bottom: 40, left: 60 };
            const width = svg.clientWidth || 1000;
            const height = 300;
            const chartWidth = width - padding.left - padding.right;
            const chartHeight = height - padding.top - padding.bottom;

            svg.innerHTML = '';
            svg.setAttribute('viewBox', `0 0 ${width} ${height}`);

            // Empty state
            if (!monthlyStats || monthlyStats.length === 0) {
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', width / 2);
                text.setAttribute('y', height / 2);
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('font-size', '14');
                text.setAttribute('fill', '#6b7280');
                text.textContent = 'Nema podataka za prikaz';
                svg.appendChild(text);
                return;
            }

            // Calculate scales
            const maxValue = Math.max(
                ...monthlyStats.map(m => Math.max(m.sječa || 0, m.otprema || 0)),
                1
            );
            const yScale = chartHeight / (maxValue * 1.1);
            const xStep = chartWidth / (monthlyStats.length - 1);

            // Smooth path function
            function createSmoothPath(data, getValue) {
                const points = data.map((d, i) => ({
                    x: padding.left + i * xStep,
                    y: padding.top + chartHeight - getValue(d) * yScale
                }));

                if (points.length === 0) return '';

                let path = `M ${points[0].x} ${points[0].y}`;

                for (let i = 0; i < points.length - 1; i++) {
                    const current = points[i];
                    const next = points[i + 1];
                    const controlX = (current.x + next.x) / 2;
                    path += ` Q ${controlX} ${current.y}, ${controlX} ${(current.y + next.y) / 2}`;
                    path += ` Q ${controlX} ${next.y}, ${next.x} ${next.y}`;
                }

                return path;
            }

            // Draw grid lines
            const gridLines = 5;
            for (let i = 0; i <= gridLines; i++) {
                const y = padding.top + (chartHeight / gridLines) * i;

                // Grid line
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', padding.left);
                line.setAttribute('y1', y);
                line.setAttribute('x2', width - padding.right);
                line.setAttribute('y2', y);
                line.setAttribute('stroke', '#e5e7eb');
                line.setAttribute('stroke-width', '1');
                svg.appendChild(line);

                // Y-axis label
                const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                const value = (maxValue * 1.1) * (1 - i / gridLines);
                label.setAttribute('x', padding.left - 10);
                label.setAttribute('y', y + 5);
                label.setAttribute('text-anchor', 'end');
                label.setAttribute('font-size', '12');
                label.setAttribute('fill', '#6b7280');
                label.textContent = value.toFixed(0);
                svg.appendChild(label);
            }

            // Draw Sječa line (green)
            const sjecaPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            sjecaPath.setAttribute('d', createSmoothPath(monthlyStats, m => m.sječa || 0));
            sjecaPath.setAttribute('fill', 'none');
            sjecaPath.setAttribute('stroke', '#059669');
            sjecaPath.setAttribute('stroke-width', '3');
            sjecaPath.setAttribute('stroke-linecap', 'round');
            svg.appendChild(sjecaPath);

            // Draw Otprema line (blue)
            const otpremaPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            otpremaPath.setAttribute('d', createSmoothPath(monthlyStats, m => m.otprema || 0));
            otpremaPath.setAttribute('fill', 'none');
            otpremaPath.setAttribute('stroke', '#2563eb');
            otpremaPath.setAttribute('stroke-width', '3');
            otpremaPath.setAttribute('stroke-linecap', 'round');
            svg.appendChild(otpremaPath);

            // Draw data points
            monthlyStats.forEach((m, i) => {
                const x = padding.left + i * xStep;

                // Sječa point
                const sjecaY = padding.top + chartHeight - (m.sječa || 0) * yScale;
                const sjecaCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                sjecaCircle.setAttribute('cx', x);
                sjecaCircle.setAttribute('cy', sjecaY);
                sjecaCircle.setAttribute('r', '4');
                sjecaCircle.setAttribute('fill', '#059669');
                sjecaCircle.setAttribute('stroke', 'white');
                sjecaCircle.setAttribute('stroke-width', '2');
                svg.appendChild(sjecaCircle);

                // Otprema point
                const otpremaY = padding.top + chartHeight - (m.otprema || 0) * yScale;
                const otpremaCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                otpremaCircle.setAttribute('cx', x);
                otpremaCircle.setAttribute('cy', otpremaY);
                otpremaCircle.setAttribute('r', '4');
                otpremaCircle.setAttribute('fill', '#2563eb');
                otpremaCircle.setAttribute('stroke', 'white');
                otpremaCircle.setAttribute('stroke-width', '2');
                svg.appendChild(otpremaCircle);

                // Month label
                const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                label.setAttribute('x', x);
                label.setAttribute('y', height - padding.bottom + 20);
                label.setAttribute('text-anchor', 'middle');
                label.setAttribute('font-size', '11');
                label.setAttribute('fill', '#6b7280');
                label.textContent = (m.mjesec || '').substring(0, 3);
                svg.appendChild(label);
            });
        }

        // Render detailed analytics odjeli table
        function renderAnalyticsOdjeliTable(odjeliStats) {
            const html = Object.entries(odjeliStats).map(([odjel, stats]) => {
                const projekat = stats.projekat || 0;
                const ostvareno = stats.ukupnoPosjeklo || stats.sječa || 0;
                const procenat = projekat > 0 ? ((ostvareno / projekat) * 100).toFixed(1) : '0.0';
                const diff = (stats.sječa || 0) - (stats.otprema || 0);

                const procenatClass = procenat >= 90 ? 'green' : procenat >= 70 ? 'blue' : 'red';
                const diffClass = diff >= 0 ? 'green' : 'red';

                return `
                    <tr>
                        <td style="font-weight: 500;">${odjel}</td>
                        <td class="right green">${(stats.sječa || 0).toFixed(2)}</td>
                        <td class="right blue">${(stats.otprema || 0).toFixed(2)}</td>
                        <td class="right">${projekat.toFixed(2)}</td>
                        <td class="right ${procenatClass}">${procenat}%</td>
                        <td class="right ${diffClass}">${(diff >= 0 ? '+' : '') + diff.toFixed(2)}</td>
                    </tr>
                `;
            }).join('');

            document.getElementById('analytics-odjeli-table').innerHTML = html || '<tr><td colspan="6" style="text-align: center; color: #6b7280;">Nema podataka</td></tr>';
        }

        // Render Performance Alerts Banner
        function renderPerformanceAlerts(odjeliStats) {
            console.log('renderPerformanceAlerts called with:', odjeliStats);
            const criticalAlerts = []; // 🔴 Kritično: > 5 dana bez unosa + projekat >> posječeno
            const warningAlerts = [];  // ⚠️ Upozorenje: posječena masa > 110% projekta (blizu 115% limite)

            const today = new Date();

            Object.entries(odjeliStats).forEach(([odjel, stats]) => {
                const projekat = stats.projekat || 0;
                const ostvareno = stats.sječa || 0;
                const zadnjiDatum = stats.zadnjiDatumUnosa || '';
                const procenat = projekat > 0 ? ((ostvareno / projekat) * 100) : 0;

                // FILTER: Ne prikazuj alerte za odjele gdje je zadnji unos stariji od 30 dana
                if (zadnjiDatum) {
                    const dateParts = zadnjiDatum.split('.');
                    if (dateParts.length === 3) {
                        const lastEntry = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
                        const daysSinceEntry = Math.floor((today - lastEntry) / (1000 * 60 * 60 * 24));

                        if (daysSinceEntry > 30) {
                            console.log(`Skipping alert for ${odjel} - zadnji unos prije ${daysSinceEntry} dana (> 30 dana)`);
                            return; // Skip ovaj odjel kompletno
                        }

                        // Kriterijum 1: KRITIČNO - Nije bilo unosa > 5 dana + projekat daleko veći od posječenog
                        if (projekat > 0 && daysSinceEntry > 5 && procenat < 50) {
                            criticalAlerts.push({
                                odjel,
                                reason: `${daysSinceEntry} dana bez unosa, ${procenat.toFixed(0)}% plana`,
                                days: daysSinceEntry,
                                procenat: procenat.toFixed(0)
                            });
                        }
                    }
                }

                // Kriterijum 2: UPOZORENJE - Posječena masa > 110% projekta (blizu 115% limite za aneks)
                // Samo ako nije preskočen zbog 30-day filtera
                if (projekat > 0 && procenat > 110) {
                    warningAlerts.push({
                        odjel,
                        reason: `${procenat.toFixed(0)}% projekta - blizu limite za aneks (115%)`,
                        procenat: procenat.toFixed(0)
                    });
                }
            });

            console.log('Critical alerts:', criticalAlerts);
            console.log('Warning alerts:', warningAlerts);

            const banner = document.getElementById('performance-alerts-banner');

            // Prikaži kritične alert-e ako postoje, inače upozorenja
            if (criticalAlerts.length > 0) {
                banner.className = 'alert-banner danger';
                banner.style.display = 'flex';
                banner.innerHTML = `
                    <span style="font-size: 24px;">🔴</span>
                    <div style="flex: 1;">
                        <div style="font-weight: 700; font-size: 14px; margin-bottom: 4px;">KRITIČNO - Nema Unosa + Niska Realizacija</div>
                        <div style="font-size: 13px;">
                            ${criticalAlerts.length} odjel${criticalAlerts.length > 1 ? 'a' : ''}:
                            ${criticalAlerts.map(a => `${a.odjel} (${a.reason})`).join(', ')}
                        </div>
                    </div>
                `;
            } else if (warningAlerts.length > 0) {
                banner.className = 'alert-banner warning';
                banner.style.display = 'flex';
                banner.innerHTML = `
                    <span style="font-size: 24px;">⚠️</span>
                    <div style="flex: 1;">
                        <div style="font-weight: 700; font-size: 14px; margin-bottom: 4px;">UPOZORENJE - Premašena Projektovana Masa</div>
                        <div style="font-size: 13px;">
                            ${warningAlerts.length} odjel${warningAlerts.length > 1 ? 'a' : ''} iznad 110% projekta:
                            ${warningAlerts.map(a => `${a.odjel} (${a.procenat}%)`).join(', ')}
                        </div>
                    </div>
                `;
            } else {
                // Sve je dobro - možda prikaži success banner?
                banner.className = 'alert-banner success';
                banner.style.display = 'flex';
                banner.innerHTML = `
                    <span style="font-size: 24px;">✅</span>
                    <div style="flex: 1;">
                        <div style="font-weight: 700; font-size: 14px; margin-bottom: 4px;">SVE U REDU</div>
                        <div style="font-size: 13px;">
                            Nema kritičnih odjela - svi odjeli su unutar dozvoljenih parametara
                        </div>
                    </div>
                `;
            }
        }

        // Render Top Izvođači Performance
        function renderIzvodjaciPerformance(odjeliStats) {
            console.log('renderIzvodjaciPerformance called with:', odjeliStats);
            const izvodjaciMap = {};
            const izvodjaciOriginalNames = {}; // Track original names for display

            // Group by izvođač (normalized to prevent duplicates)
            Object.entries(odjeliStats).forEach(([odjel, stats]) => {
                let izvodjac = stats.izvođač || stats.izvodjac || '';
                izvodjac = izvodjac.trim(); // Remove whitespace

                if (!izvodjac || izvodjac === '') {
                    console.log('Skipping odjel with empty izvođač:', odjel, stats);
                    return; // Skip empty izvođači
                }

                // Normalize for grouping (uppercase, trim)
                const normalizedName = izvodjac.toUpperCase();
                const sjeca = stats.sječa || 0;

                console.log(`Adding odjel ${odjel} to izvođač ${normalizedName}: ${sjeca} m³`);

                if (!izvodjaciMap[normalizedName]) {
                    izvodjaciMap[normalizedName] = 0;
                    izvodjaciOriginalNames[normalizedName] = izvodjac; // Store first encountered name
                }
                izvodjaciMap[normalizedName] += sjeca;
            });

            console.log('Izvođači grouped (normalized):', izvodjaciMap);

            // Calculate and log total suma
            const totalSuma = Object.values(izvodjaciMap).reduce((sum, val) => sum + val, 0);
            console.log('TOTAL SUMA SVIH IZVOĐAČA:', totalSuma.toFixed(2), 'm³');

            // Sort by volume and use original names for display
            const sorted = Object.entries(izvodjaciMap)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10)
                .map(([normalizedName, volume]) => [izvodjaciOriginalNames[normalizedName], volume]);

            console.log('Top izvođači sorted:', sorted);

            const html = sorted.length > 0
                ? sorted.map(([izvodjac, volume], index) => {
                    const rankClass = index < 3 ? 'top' : '';
                    return `
                        <div class="ranking-item">
                            <div class="ranking-number ${rankClass}">${index + 1}</div>
                            <div class="ranking-info">
                                <div class="ranking-name">${izvodjac}</div>
                                <div class="ranking-value">${volume.toFixed(2)} m³</div>
                            </div>
                        </div>
                    `;
                }).join('')
                : '<p style="color: #6b7280; text-align: center; padding: 20px;">Nema podataka o izvođačima</p>';

            document.getElementById('izvodjaci-performance-list').innerHTML = html;
        }

        // Render Timeline - Zadnji Unosi
        function renderTimelineUnosi(odjeliStats) {
            console.log('renderTimelineUnosi called with:', odjeliStats);
            const timeline = [];

            Object.entries(odjeliStats).forEach(([odjel, stats]) => {
                const zadnjiDatum = stats.zadnjiDatumUnosa || stats.zadnjiUnos || '';
                if (zadnjiDatum) {
                    timeline.push({ odjel, datum: zadnjiDatum });
                }
            });

            console.log('Timeline entries:', timeline);

            // Sort by date (most recent first)
            timeline.sort((a, b) => {
                const dateA = new Date(a.datum.split('.').reverse().join('-'));
                const dateB = new Date(b.datum.split('.').reverse().join('-'));
                return dateB - dateA;
            });

            const html = timeline.length > 0
                ? timeline.slice(0, 10).map(item => {
                    // Calculate days since entry
                    const dateParts = item.datum.split('.');
                    const entryDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
                    const today = new Date();
                    const daysDiff = Math.floor((today - entryDate) / (1000 * 60 * 60 * 24));

                    let statusClass = 'fresh';
                    let statusText = 'Svježe';
                    if (daysDiff > 30) {
                        statusClass = 'old';
                        statusText = `${daysDiff} dana`;
                    } else if (daysDiff > 7) {
                        statusClass = 'warning';
                        statusText = `${daysDiff} dana`;
                    } else if (daysDiff > 0) {
                        statusText = `prije ${daysDiff}d`;
                    }

                    return `
                        <div class="timeline-item">
                            <div class="timeline-date">${item.datum}</div>
                            <div class="timeline-content">
                                <div class="timeline-odjel">${item.odjel}</div>
                                <div class="timeline-status ${statusClass}">${statusText}</div>
                            </div>
                        </div>
                    `;
                }).join('')
                : '<p style="color: #6b7280; text-align: center; padding: 20px;">Nema podataka o unosima</p>';

            document.getElementById('timeline-unosi-list').innerHTML = html;
        }

        // Render Seasonal Analysis (Q1-Q4)
        function renderSeasonalAnalysis(monthlyStats) {
            console.log('renderSeasonalAnalysis called with:', monthlyStats);

            // Define quarters
            const quarters = [
                { name: 'Q1', label: 'Jan-Mar', months: [0, 1, 2], icon: '❄️', color: '#3b82f6' },
                { name: 'Q2', label: 'Apr-Jun', months: [3, 4, 5], icon: '🌸', color: '#10b981' },
                { name: 'Q3', label: 'Jul-Sep', months: [6, 7, 8], icon: '☀️', color: '#f59e0b' },
                { name: 'Q4', label: 'Okt-Dec', months: [9, 10, 11], icon: '🍂', color: '#dc2626' }
            ];

            const html = quarters.map(q => {
                const quarterSjeca = q.months.reduce((sum, monthIdx) => {
                    return sum + (monthlyStats[monthIdx]?.sječa || 0);
                }, 0);

                const quarterOtprema = q.months.reduce((sum, monthIdx) => {
                    return sum + (monthlyStats[monthIdx]?.otprema || 0);
                }, 0);

                return `
                    <div class="kpi-card-small" style="background: linear-gradient(135deg, ${q.color}15 0%, ${q.color}25 100%); border-left-color: ${q.color};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <span style="font-size: 28px;">${q.icon}</span>
                            <div style="text-align: right;">
                                <div style="font-size: 11px; color: #6b7280; font-weight: 600; text-transform: uppercase;">${q.name}</div>
                                <div style="font-size: 12px; color: #9ca3af;">${q.label}</div>
                            </div>
                        </div>
                        <div style="margin-bottom: 8px;">
                            <div style="font-size: 11px; color: #6b7280; margin-bottom: 2px;">Sječa</div>
                            <div style="font-size: 18px; font-weight: 700; color: #059669;">${quarterSjeca.toFixed(0)} m³</div>
                        </div>
                        <div>
                            <div style="font-size: 11px; color: #6b7280; margin-bottom: 2px;">Otprema</div>
                            <div style="font-size: 18px; font-weight: 700; color: #2563eb;">${quarterOtprema.toFixed(0)} m³</div>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('seasonal-analysis').innerHTML = html;
        }

        // Render Mjesečni Trend Kupaca
        async function renderKupciMjesecniTrend() {
            console.log('renderKupciMjesecniTrend called - fetching data...');

            try {
                const year = new Date().getFullYear();
                const kupciUrl = `${API_URL}?path=otpremaci&year=${year}&username=${currentUser.username}&password=${currentPassword}`;
                const kupciData = await fetchWithCache(kupciUrl, 'cache_kupci_' + year);

                console.log('Kupci mjesecni data:', kupciData);

                if (!kupciData || !kupciData.mjesecni) {
                    document.getElementById('kupci-mjesecni-tbody').innerHTML = '<tr><td colspan="14" style="text-align: center; color: #6b7280;">Nema podataka</td></tr>';
                    return;
                }

                // Group mjesecni by kupac
                const kupciMap = {};
                kupciData.mjesecni.forEach(entry => {
                    const kupac = entry.kupac || 'Nepoznat';
                    const mjesec = entry.mjesec; // 0-11
                    const ukupno = entry.ukupno || 0;

                    if (!kupciMap[kupac]) {
                        kupciMap[kupac] = new Array(12).fill(0);
                    }
                    kupciMap[kupac][mjesec] = ukupno;
                });

                // Calculate total per kupac and sort
                const kupciArray = Object.entries(kupciMap).map(([kupac, mjeseci]) => {
                    const total = mjeseci.reduce((sum, val) => sum + val, 0);
                    return { kupac, mjeseci, total };
                }).sort((a, b) => b.total - a.total).slice(0, 15); // Top 15 kupaca

                console.log('Top 15 kupaca mjesečno:', kupciArray);

                const html = kupciArray.map(k => {
                    return `
                        <tr>
                            <td style="font-weight: 500;">${k.kupac}</td>
                            ${k.mjeseci.map(val => {
                                const display = val > 0 ? val.toFixed(0) : '-';
                                const color = val > 1000 ? 'color: #059669; font-weight: 600;' : '';
                                return `<td class="right" style="${color}">${display}</td>`;
                            }).join('')}
                            <td class="right" style="font-weight: 700; color: #1f2937;">${k.total.toFixed(0)}</td>
                        </tr>
                    `;
                }).join('');

                document.getElementById('kupci-mjesecni-tbody').innerHTML = html || '<tr><td colspan="14" style="text-align: center; color: #6b7280;">Nema podataka</td></tr>';
            } catch (error) {
                console.error('Error loading kupci mjesecni trend:', error);
                document.getElementById('kupci-mjesecni-tbody').innerHTML = '<tr><td colspan="14" style="text-align: center; color: #dc2626;">Greška pri učitavanju</td></tr>';
            }
        }

        // Filter analytics table by search
        function filterAnalyticsTable() {
            const searchValue = document.getElementById('analytics-search').value.toLowerCase();
            const table = document.getElementById('analytics-odjeli-main-table');
            const rows = table.querySelectorAll('tbody tr');

            rows.forEach(row => {
                const odjelName = row.cells[0].textContent.toLowerCase();
                if (odjelName.includes(searchValue)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // ============================================
        // DINAMIKA FUNKCIJE
        // ============================================

        // Load dinamika data
        async function loadDinamika() {
            console.log('Loading Dinamika...');
            document.getElementById('dinamika-content').classList.remove('hidden');

            const year = new Date().getFullYear(); // Tekuća godina (2026)
            document.getElementById('dinamika-selected-year').textContent = year;

            try {
                const url = `${API_URL}?path=get_dinamika&year=${year}&username=${currentUser.username}&password=${currentPassword}`;
                const data = await fetchWithCache(url, 'cache_dinamika_' + year);

                console.log('Dinamika data:', data);

                if (data.error) {
                    throw new Error(data.error);
                }

                // Popuni input polja sa mjesečnim vrijednostima
                const mjeseci = data.dinamika || {};
                for (let i = 1; i <= 12; i++) {
                    const mjesecKey = String(i).padStart(2, '0');
                    const inputId = 'dinamika-' + mjesecKey;
                    const value = mjeseci[mjesecKey] || 0;
                    document.getElementById(inputId).value = value > 0 ? value : '';
                }

                // Izračunaj ukupno
                calculateDinamikaTotal();

            } catch (error) {
                console.error('Error loading dinamika:', error);
                showError('Greška', 'Greška pri učitavanju dinamike: ' + error.message);
            }
        }

        // Calculate total dinamika
        function calculateDinamikaTotal() {
            let total = 0;
            for (let i = 1; i <= 12; i++) {
                const mjesecKey = String(i).padStart(2, '0');
                const inputId = 'dinamika-' + mjesecKey;
                const value = parseFloat(document.getElementById(inputId).value) || 0;
                total += value;
            }
            document.getElementById('dinamika-total').textContent = total.toFixed(2);
        }

        // Save dinamika
        async function saveDinamika(event) {
            event.preventDefault();

            const year = new Date().getFullYear(); // Tekuća godina (2026)

            // Prikupi mjesečne vrijednosti
            const mjeseci = {};
            for (let i = 1; i <= 12; i++) {
                const mjesecKey = String(i).padStart(2, '0');
                const inputId = 'dinamika-' + mjesecKey;
                const value = parseFloat(document.getElementById(inputId).value) || 0;
                mjeseci[mjesecKey] = value;
            }

            try {
                showInfo('💾 Spremanje...', 'Spremam mjesečnu dinamiku...');

                // Koristi GET sa URL parametrima da izbjegneš CORS problem
                const mjeseciJson = encodeURIComponent(JSON.stringify(mjeseci));
                const url = `${API_URL}?path=save_dinamika&username=${encodeURIComponent(currentUser.username)}&password=${encodeURIComponent(currentPassword)}&godina=${year}&mjeseci=${mjeseciJson}`;

                console.log('Saving dinamika URL:', url);

                const response = await fetch(url, {
                    method: 'GET'
                });

                const result = await response.json();

                console.log('Save response:', result);

                if (result.success) {
                    showSuccess('✅ Spremljeno!', 'Mjesečna dinamika uspješno spremljena.');

                    // Clear cache and reload
                    localStorage.removeItem('cache_dinamika_' + year);
                    localStorage.removeItem('cache_dashboard_' + year);
                    loadDinamika();
                } else {
                    throw new Error(result.error || 'Greška pri spremanju');
                }

            } catch (error) {
                console.error('Error saving dinamika:', error);
                showError('Greška', 'Nije uspjelo spremanje dinamike: ' + error.message);
            }
        }

        // Dodaj event listenere za izračunavanje ukupno nakon što se učita stranica
        document.addEventListener('DOMContentLoaded', function() {
            // Dodaj event listenere na sve input polja za mjesece
            for (let i = 1; i <= 12; i++) {
                const mjesecKey = String(i).padStart(2, '0');
                const inputId = 'dinamika-' + mjesecKey;
                const inputElem = document.getElementById(inputId);
                if (inputElem) {
                    inputElem.addEventListener('input', calculateDinamikaTotal);
                }
            }
        });

        // ============================================
        // UPOREDBA GODINA FUNKCIJE
        // ============================================

        // Load uporedba godina
        async function loadUporedbaGodina() {
            console.log('Loading Uporedba Godina...');
            document.getElementById('uporedba-godina-content').classList.remove('hidden');

            const year1 = parseInt(document.getElementById('uporedba-year1').value);
            const year2 = parseInt(document.getElementById('uporedba-year2').value);

            console.log(`Comparing ${year1} vs ${year2}`);

            try {
                showInfo('🔄 Učitavanje...', 'Učitavam podatke za usporedbu...');

                // Fetch dashboard data za obje godine (paralelno, 30s timeout for heavy endpoints)
                const url1 = `${API_URL}?path=dashboard&year=${year1}&username=${currentUser.username}&password=${currentPassword}`;
                const url2 = `${API_URL}?path=dashboard&year=${year2}&username=${currentUser.username}&password=${currentPassword}`;

                const [data1, data2] = await Promise.all([
                    fetchWithCache(url1, 'cache_dashboard_' + year1, false, 30000),
                    fetchWithCache(url2, 'cache_dashboard_' + year2, false, 30000)
                ]);

                console.log('Data Year 1:', data1);
                console.log('Data Year 2:', data2);

                if (data1.error || data2.error) {
                    throw new Error(data1.error || data2.error);
                }

                // Renderuj tabele
                renderMjesecnaUporedba(data1, data2, year1, year2);
                renderGodisnjuUporedbu(data1, data2, year1, year2);
                renderTop10Odjela(data1, data2, year1, year2);

                hideInfo();

            } catch (error) {
                console.error('Error loading uporedba:', error);
                showError('Greška', 'Greška pri učitavanju usporedbe: ' + error.message);
            }
        }

        // Render mjesečna usporedba
        function renderMjesecnaUporedba(data1, data2, year1, year2) {
            const headerElem = document.getElementById('uporedba-mjesecna-header');
            const bodyElem = document.getElementById('uporedba-mjesecna-body');
            const footerElem = document.getElementById('uporedba-mjesecna-footer');

            const mjeseci1 = data1.mjesecniPregled || [];
            const mjeseci2 = data2.mjesecniPregled || [];

            // Header
            headerElem.innerHTML = `
                <tr>
                    <th rowspan="2">Mjesec</th>
                    <th colspan="3" style="text-align: center; background: #047857; color: white;">${year1}</th>
                    <th colspan="3" style="text-align: center; background: #2563eb; color: white;">${year2}</th>
                    <th colspan="2" style="text-align: center; background: #7c3aed; color: white;">Razlika</th>
                </tr>
                <tr>
                    <th style="text-align: right;">Sječa</th>
                    <th style="text-align: right;">Otprema</th>
                    <th style="text-align: right;">Zaliha</th>
                    <th style="text-align: right;">Sječa</th>
                    <th style="text-align: right;">Otprema</th>
                    <th style="text-align: right;">Zaliha</th>
                    <th style="text-align: right;">Δ Sječa</th>
                    <th style="text-align: right;">Δ Otprema</th>
                </tr>
            `;

            // Body
            let bodyHtml = '';
            let totalSjeca1 = 0, totalOtprema1 = 0;
            let totalSjeca2 = 0, totalOtprema2 = 0;

            for (let i = 0; i < 12; i++) {
                const m1 = mjeseci1[i] || { mjesec: '', ukupnoPrimka: 0, ukupnoOtprema: 0, zaliha: 0 };
                const m2 = mjeseci2[i] || { mjesec: '', ukupnoPrimka: 0, ukupnoOtprema: 0, zaliha: 0 };

                const sjeca1 = parseFloat(m1.ukupnoPrimka) || 0;
                const otprema1 = parseFloat(m1.ukupnoOtprema) || 0;
                const zaliha1 = parseFloat(m1.zaliha) || 0;

                const sjeca2 = parseFloat(m2.ukupnoPrimka) || 0;
                const otprema2 = parseFloat(m2.ukupnoOtprema) || 0;
                const zaliha2 = parseFloat(m2.zaliha) || 0;

                const deltaSjeca = sjeca2 - sjeca1;
                const deltaOtprema = otprema2 - otprema1;

                totalSjeca1 += sjeca1;
                totalOtprema1 += otprema1;
                totalSjeca2 += sjeca2;
                totalOtprema2 += otprema2;

                const deltaClass1 = deltaSjeca >= 0 ? 'positive-diff' : 'negative-diff';
                const deltaClass2 = deltaOtprema >= 0 ? 'positive-diff' : 'negative-diff';

                bodyHtml += `
                    <tr>
                        <td style="font-weight: 600;">${m1.mjesec || m2.mjesec || '-'}</td>
                        <td class="sortiment-value">${sjeca1.toFixed(2)}</td>
                        <td class="sortiment-value">${otprema1.toFixed(2)}</td>
                        <td class="sortiment-value">${zaliha1.toFixed(2)}</td>
                        <td class="sortiment-value">${sjeca2.toFixed(2)}</td>
                        <td class="sortiment-value">${otprema2.toFixed(2)}</td>
                        <td class="sortiment-value">${zaliha2.toFixed(2)}</td>
                        <td class="${deltaClass1}" style="text-align: right; font-weight: 600;">${deltaSjeca >= 0 ? '+' : ''}${deltaSjeca.toFixed(2)}</td>
                        <td class="${deltaClass2}" style="text-align: right; font-weight: 600;">${deltaOtprema >= 0 ? '+' : ''}${deltaOtprema.toFixed(2)}</td>
                    </tr>
                `;
            }
            bodyElem.innerHTML = bodyHtml;

            // Footer
            const totalDeltaSjeca = totalSjeca2 - totalSjeca1;
            const totalDeltaOtprema = totalOtprema2 - totalOtprema1;
            const deltaClass1 = totalDeltaSjeca >= 0 ? 'positive-diff' : 'negative-diff';
            const deltaClass2 = totalDeltaOtprema >= 0 ? 'positive-diff' : 'negative-diff';

            footerElem.innerHTML = `
                <tr style="font-weight: bold; font-size: 16px;">
                    <td>UKUPNO</td>
                    <td class="sortiment-value">${totalSjeca1.toFixed(2)}</td>
                    <td class="sortiment-value">${totalOtprema1.toFixed(2)}</td>
                    <td></td>
                    <td class="sortiment-value">${totalSjeca2.toFixed(2)}</td>
                    <td class="sortiment-value">${totalOtprema2.toFixed(2)}</td>
                    <td></td>
                    <td class="${deltaClass1}" style="text-align: right;">${totalDeltaSjeca >= 0 ? '+' : ''}${totalDeltaSjeca.toFixed(2)}</td>
                    <td class="${deltaClass2}" style="text-align: right;">${totalDeltaOtprema >= 0 ? '+' : ''}${totalDeltaOtprema.toFixed(2)}</td>
                </tr>
            `;
        }

        // Render godišnju usporedbu
        function renderGodisnjuUporedbu(data1, data2, year1, year2) {
            const headerElem = document.getElementById('uporedba-ukupno-header');
            const bodyElem = document.getElementById('uporedba-ukupno-body');

            const mjeseci1 = data1.mjesecniPregled || [];
            const mjeseci2 = data2.mjesecniPregled || [];

            let totalSjeca1 = 0, totalOtprema1 = 0, totalDinamika1 = 0;
            let totalSjeca2 = 0, totalOtprema2 = 0, totalDinamika2 = 0;

            mjeseci1.forEach(m => {
                totalSjeca1 += parseFloat(m.ukupnoPrimka) || 0;
                totalOtprema1 += parseFloat(m.ukupnoOtprema) || 0;
                totalDinamika1 += parseFloat(m.dinamika) || 0;
            });

            mjeseci2.forEach(m => {
                totalSjeca2 += parseFloat(m.ukupnoPrimka) || 0;
                totalOtprema2 += parseFloat(m.ukupnoOtprema) || 0;
                totalDinamika2 += parseFloat(m.dinamika) || 0;
            });

            const realizacijaSjeca1 = totalDinamika1 > 0 ? (totalSjeca1 / totalDinamika1 * 100) : 0;
            const realizacijaSjeca2 = totalDinamika2 > 0 ? (totalSjeca2 / totalDinamika2 * 100) : 0;

            const deltaSjeca = totalSjeca2 - totalSjeca1;
            const deltaOtprema = totalOtprema2 - totalOtprema1;
            const deltaRealizacija = realizacijaSjeca2 - realizacijaSjeca1;

            // Header
            headerElem.innerHTML = `
                <tr>
                    <th>Pokazatelj</th>
                    <th style="text-align: right; background: #047857; color: white;">${year1}</th>
                    <th style="text-align: right; background: #2563eb; color: white;">${year2}</th>
                    <th style="text-align: right; background: #7c3aed; color: white;">Razlika</th>
                    <th style="text-align: right; background: #7c3aed; color: white;">% Promjene</th>
                </tr>
            `;

            // Body
            const percentChangeSjeca = totalSjeca1 > 0 ? ((deltaSjeca / totalSjeca1) * 100) : 0;
            const percentChangeOtprema = totalOtprema1 > 0 ? ((deltaOtprema / totalOtprema1) * 100) : 0;

            bodyElem.innerHTML = `
                <tr>
                    <td style="font-weight: 600;">Ukupna Sječa (m³)</td>
                    <td class="sortiment-value">${totalSjeca1.toFixed(2)}</td>
                    <td class="sortiment-value">${totalSjeca2.toFixed(2)}</td>
                    <td class="${deltaSjeca >= 0 ? 'positive-diff' : 'negative-diff'}" style="text-align: right; font-weight: 600;">${deltaSjeca >= 0 ? '+' : ''}${deltaSjeca.toFixed(2)}</td>
                    <td class="${percentChangeSjeca >= 0 ? 'positive-diff' : 'negative-diff'}" style="text-align: right; font-weight: 600;">${percentChangeSjeca >= 0 ? '+' : ''}${percentChangeSjeca.toFixed(1)}%</td>
                </tr>
                <tr>
                    <td style="font-weight: 600;">Ukupna Otprema (m³)</td>
                    <td class="sortiment-value">${totalOtprema1.toFixed(2)}</td>
                    <td class="sortiment-value">${totalOtprema2.toFixed(2)}</td>
                    <td class="${deltaOtprema >= 0 ? 'positive-diff' : 'negative-diff'}" style="text-align: right; font-weight: 600;">${deltaOtprema >= 0 ? '+' : ''}${deltaOtprema.toFixed(2)}</td>
                    <td class="${percentChangeOtprema >= 0 ? 'positive-diff' : 'negative-diff'}" style="text-align: right; font-weight: 600;">${percentChangeOtprema >= 0 ? '+' : ''}${percentChangeOtprema.toFixed(1)}%</td>
                </tr>
                <tr>
                    <td style="font-weight: 600;">Planirana Dinamika (m³)</td>
                    <td class="sortiment-value">${totalDinamika1.toFixed(2)}</td>
                    <td class="sortiment-value">${totalDinamika2.toFixed(2)}</td>
                    <td style="text-align: right;">-</td>
                    <td style="text-align: right;">-</td>
                </tr>
                <tr style="background: linear-gradient(135deg, #047857 0%, #065f46 100%); color: white;">
                    <td style="font-weight: 700;">Realizacija Sječe (%)</td>
                    <td style="text-align: right; font-weight: 700;">${realizacijaSjeca1.toFixed(1)}%</td>
                    <td style="text-align: right; font-weight: 700;">${realizacijaSjeca2.toFixed(1)}%</td>
                    <td style="text-align: right; font-weight: 700;">${deltaRealizacija >= 0 ? '+' : ''}${deltaRealizacija.toFixed(1)}%</td>
                    <td style="text-align: right;">-</td>
                </tr>
            `;
        }

        // Render Top 10 odjela
        function renderTop10Odjela(data1, data2, year1, year2) {
            const body1 = document.getElementById('uporedba-top10-year1-body');
            const body2 = document.getElementById('uporedba-top10-year2-body');

            document.getElementById('uporedba-top10-year1-title').textContent = `Godina ${year1}`;
            document.getElementById('uporedba-top10-year2-title').textContent = `Godina ${year2}`;

            const odjeli1 = data1.odjeli || [];
            const odjeli2 = data2.odjeli || [];

            // Sort by primka descending
            const top10_1 = odjeli1.sort((a, b) => (parseFloat(b.primka) || 0) - (parseFloat(a.primka) || 0)).slice(0, 10);
            const top10_2 = odjeli2.sort((a, b) => (parseFloat(b.primka) || 0) - (parseFloat(a.primka) || 0)).slice(0, 10);

            // Render Year 1
            let html1 = '';
            top10_1.forEach((odjel, idx) => {
                const primka = parseFloat(odjel.primka) || 0;
                const medalEmoji = idx === 0 ? '🥇' : idx === 1 ? '🥈' : idx === 2 ? '🥉' : '';
                html1 += `
                    <tr>
                        <td style="text-align: center;">${medalEmoji} ${idx + 1}</td>
                        <td style="font-weight: 600;">${odjel.odjel || '-'}</td>
                        <td class="sortiment-value">${primka.toFixed(2)}</td>
                    </tr>
                `;
            });
            body1.innerHTML = html1;

            // Render Year 2
            let html2 = '';
            top10_2.forEach((odjel, idx) => {
                const primka = parseFloat(odjel.primka) || 0;
                const medalEmoji = idx === 0 ? '🥇' : idx === 1 ? '🥈' : idx === 2 ? '🥉' : '';
                html2 += `
                    <tr>
                        <td style="text-align: center;">${medalEmoji} ${idx + 1}</td>
                        <td style="font-weight: 600;">${odjel.odjel || '-'}</td>
                        <td class="sortiment-value">${primka.toFixed(2)}</td>
                    </tr>
                `;
            });
            body2.innerHTML = html2;
        }

        // ========================================
        // PRIMAČ/OTPREMAČ IZVJEŠTAJI - Sedmični i Mjesečni
        // ========================================

        // Load sedmični izvještaj za primača (suma po sortimentima za sedmice)
        async function loadPrimacSedmicni() {
            document.getElementById('loading-screen').classList.remove('hidden');

            try {
                const year = document.getElementById('primac-sedmicni-year').value;
                const month = document.getElementById('primac-sedmicni-month').value;

                // Load primke data
                const url = `${API_URL}?path=primke&username=${currentUser.username}&password=${currentPassword}`;
                const response = await fetchWithCache(url, `cache_primac_sedmicni_${year}_${month}`);

                // 🔍 DEBUG: Log response structure
                console.log('=== PRIMAC SEDMICNI DEBUG ===');
                console.log('Response type:', typeof response);
                console.log('Response keys:', Object.keys(response || {}));
                console.log('Response:', response);
                console.log('response.primke type:', typeof response.primke);
                console.log('Is response.primke array?', Array.isArray(response.primke));
                console.log('response.primke length:', response.primke?.length);

                if (response.error) throw new Error(response.error);

                // ✅ Backend vraća { primke: [...] }, izvuci array
                // Handle different response formats
                let data;
                if (Array.isArray(response)) {
                    // Old backend format: returns array directly
                    data = response;
                    console.log('⚠️ Using old format: response is array');
                } else if (response.primke && Array.isArray(response.primke)) {
                    // New backend format: returns { primke: [...] }
                    data = response.primke;
                    console.log('✅ Using new format: response.primke is array');
                } else {
                    console.error('❌ Unknown response format!', response);
                    data = [];
                }

                console.log('Final data array length:', data.length);

                // Filter by year/month
                const filteredData = data.filter(row => {
                    if (!row.datum) return false;
                    const dateParts = row.datum.split(/[\/\.\-]/);
                    const day = parseInt(dateParts[0]);
                    const recordMonth = parseInt(dateParts[1]) - 1;
                    const recordYear = parseInt(dateParts[2]);
                    return recordYear === parseInt(year) && recordMonth === parseInt(month);
                });

                console.log('🔍 FILTERING DEBUG:');
                console.log(`Selected Year: ${year}, Month: ${month} (0-indexed: ${month})`);
                console.log(`Total primke from backend: ${data.length}`);
                console.log(`After filtering by year/month: ${filteredData.length}`);

                // Sample first 5 filtered records
                if (filteredData.length > 0) {
                    console.log('Sample filtered data (first 5):');
                    filteredData.slice(0, 5).forEach((row, i) => {
                        console.log(`  ${i+1}. Datum: ${row.datum}, Sortiment: ${row.sortiment}, Kolicina: ${row.kolicina}, Odjel: ${row.odjel}`);
                    });
                }

                // Get sortimenti list - use ALL sortimenti from SORTIMENTI_ORDER
                // (not just those that exist in data - show all columns even if zero)
                const sortimentiNazivi = [...SORTIMENTI_ORDER];

                // Group by weeks
                const weeklyData = groupPrimacOtpremacDataByWeeks(filteredData, year, month, sortimentiNazivi);

                // Render table
                renderPrimacOtpremacSedmicni(weeklyData, sortimentiNazivi, 'primac-sedmicni', year, month);

                document.getElementById('loading-screen').classList.add('hidden');

            } catch (error) {
                console.error('Error loading primač sedmični izvještaj:', error);
                showError('Greška', 'Greška pri učitavanju sedmičnog izvještaja: ' + error.message);
                document.getElementById('loading-screen').classList.add('hidden');
            }
        }

        // Load mjesečni izvještaj za primača (suma po sortimentima za mjesec)
        async function loadPrimacMjesecni() {
            document.getElementById('loading-screen').classList.remove('hidden');

            try {
                const year = document.getElementById('primac-mjesecni-year').value;
                const month = document.getElementById('primac-mjesecni-month').value;

                // Load primke data
                const url = `${API_URL}?path=primke&username=${currentUser.username}&password=${currentPassword}`;
                const response = await fetchWithCache(url, `cache_primac_mjesecni_${year}_${month}`);

                if (response.error) throw new Error(response.error);

                // ✅ Backend vraća { primke: [...] }, izvuci array
                // Handle different response formats
                let data;
                if (Array.isArray(response)) {
                    data = response;
                } else if (response.primke && Array.isArray(response.primke)) {
                    data = response.primke;
                } else {
                    console.error('❌ Unknown response format in loadPrimacMjesecni!', response);
                    data = [];
                }

                // Filter by year/month
                const filteredData = data.filter(row => {
                    if (!row.datum) return false;
                    const dateParts = row.datum.split(/[\/\.\-]/);
                    const recordMonth = parseInt(dateParts[1]) - 1;
                    const recordYear = parseInt(dateParts[2]);
                    return recordYear === parseInt(year) && recordMonth === parseInt(month);
                });

                // Get sortimenti list - use ALL sortimenti from SORTIMENTI_ORDER
                // (not just those that exist in data - show all columns even if zero)
                const sortimentiNazivi = [...SORTIMENTI_ORDER];

                // Sum by sortiment
                const sortimentiSums = {};
                sortimentiNazivi.forEach(s => sortimentiSums[s] = 0);

                filteredData.forEach(row => {
                    if (row.sortiment && row.kolicina) {
                        const kolicina = parseFloat(row.kolicina) || 0;
                        sortimentiSums[row.sortiment] += kolicina;
                    }
                });

                // Render table
                renderPrimacOtpremacMjesecni(sortimentiSums, sortimentiNazivi, 'primac-mjesecni', year, month);

                document.getElementById('loading-screen').classList.add('hidden');

            } catch (error) {
                console.error('Error loading primač mjesečni izvještaj:', error);
                showError('Greška', 'Greška pri učitavanju mjesečnog izvještaja: ' + error.message);
                document.getElementById('loading-screen').classList.add('hidden');
            }
        }

        // Load sedmični izvještaj za otpremača (suma po sortimentima za sedmice)
        async function loadOtpremacSedmicni() {
            document.getElementById('loading-screen').classList.remove('hidden');

            try {
                const year = document.getElementById('otpremac-sedmicni-year').value;
                const month = document.getElementById('otpremac-sedmicni-month').value;

                // Load otpreme data
                const url = `${API_URL}?path=otpreme&username=${currentUser.username}&password=${currentPassword}`;
                const response = await fetchWithCache(url, `cache_otpremac_sedmicni_${year}_${month}`);

                if (response.error) throw new Error(response.error);

                // ✅ Backend vraća { otpreme: [...] }, izvuci array
                // Handle different response formats
                let data;
                if (Array.isArray(response)) {
                    data = response;
                } else if (response.otpreme && Array.isArray(response.otpreme)) {
                    data = response.otpreme;
                } else {
                    console.error('❌ Unknown response format in loadOtpremacSedmicni!', response);
                    data = [];
                }

                // Filter by year/month
                const filteredData = data.filter(row => {
                    if (!row.datum) return false;
                    const dateParts = row.datum.split(/[\/\.\-]/);
                    const recordMonth = parseInt(dateParts[1]) - 1;
                    const recordYear = parseInt(dateParts[2]);
                    return recordYear === parseInt(year) && recordMonth === parseInt(month);
                });

                // Get sortimenti list - use ALL sortimenti from SORTIMENTI_ORDER
                // (not just those that exist in data - show all columns even if zero)
                const sortimentiNazivi = [...SORTIMENTI_ORDER];

                // Group by weeks
                const weeklyData = groupPrimacOtpremacDataByWeeks(filteredData, year, month, sortimentiNazivi);

                // Render table
                renderPrimacOtpremacSedmicni(weeklyData, sortimentiNazivi, 'otpremac-sedmicni', year, month);

                document.getElementById('loading-screen').classList.add('hidden');

            } catch (error) {
                console.error('Error loading otpremač sedmični izvještaj:', error);
                showError('Greška', 'Greška pri učitavanju sedmičnog izvještaja: ' + error.message);
                document.getElementById('loading-screen').classList.add('hidden');
            }
        }

        // Load mjesečni izvještaj za otpremača (suma po sortimentima za mjesec)
        async function loadOtpremacMjesecni() {
            document.getElementById('loading-screen').classList.remove('hidden');

            try {
                const year = document.getElementById('otpremac-mjesecni-year').value;
                const month = document.getElementById('otpremac-mjesecni-month').value;

                // Load otpreme data
                const url = `${API_URL}?path=otpreme&username=${currentUser.username}&password=${currentPassword}`;
                const response = await fetchWithCache(url, `cache_otpremac_mjesecni_${year}_${month}`);

                if (response.error) throw new Error(response.error);

                // ✅ Backend vraća { otpreme: [...] }, izvuci array
                // Handle different response formats
                let data;
                if (Array.isArray(response)) {
                    data = response;
                } else if (response.otpreme && Array.isArray(response.otpreme)) {
                    data = response.otpreme;
                } else {
                    console.error('❌ Unknown response format in loadOtpremacMjesecni!', response);
                    data = [];
                }

                // Filter by year/month
                const filteredData = data.filter(row => {
                    if (!row.datum) return false;
                    const dateParts = row.datum.split(/[\/\.\-]/);
                    const recordMonth = parseInt(dateParts[1]) - 1;
                    const recordYear = parseInt(dateParts[2]);
                    return recordYear === parseInt(year) && recordMonth === parseInt(month);
                });

                // Get sortimenti list - use ALL sortimenti from SORTIMENTI_ORDER
                // (not just those that exist in data - show all columns even if zero)
                const sortimentiNazivi = [...SORTIMENTI_ORDER];

                // Sum by sortiment
                const sortimentiSums = {};
                sortimentiNazivi.forEach(s => sortimentiSums[s] = 0);

                filteredData.forEach(row => {
                    if (row.sortiment && row.kolicina) {
                        const kolicina = parseFloat(row.kolicina) || 0;
                        sortimentiSums[row.sortiment] += kolicina;
                    }
                });

                // Render table
                renderPrimacOtpremacMjesecni(sortimentiSums, sortimentiNazivi, 'otpremac-mjesecni', year, month);

                document.getElementById('loading-screen').classList.add('hidden');

            } catch (error) {
                console.error('Error loading otpremač mjesečni izvještaj:', error);
                showError('Greška', 'Greška pri učitavanju mjesečnog izvještaja: ' + error.message);
                document.getElementById('loading-screen').classList.add('hidden');
            }
        }

        // Group primac/otpremac data by weeks (simple version - just sum sortimenti per week)
        function groupPrimacOtpremacDataByWeeks(data, year, month, sortimentiNazivi) {
            const weeksMap = new Map();

            const y = parseInt(year);
            const m = parseInt(month);

            // PRVO: Inicijalizuj SVE sedmice u mjesecu (sa nulama)
            const firstDayOfMonth = new Date(y, m, 1);
            const lastDayOfMonth = new Date(y, m + 1, 0);

            // Prođi kroz sve dane mjeseca i determiniši sedmice
            for (let day = 1; day <= lastDayOfMonth.getDate(); day++) {
                const datum = new Date(y, m, day);
                const weekInfo = getWeekWithinMonth(datum, y, m);
                const weekKey = weekInfo.weekNumber;

                if (!weeksMap.has(weekKey)) {
                    weeksMap.set(weekKey, {
                        weekNumber: weekKey,
                        weekStart: weekInfo.weekStart,
                        weekEnd: weekInfo.weekEnd,
                        sortimentiSums: {}
                    });
                    // Inicijalizuj sve sortimente sa 0
                    sortimentiNazivi.forEach(s => weeksMap.get(weekKey).sortimentiSums[s] = 0);
                }
            }

            // DRUGO: Popuni podatke iz data array-a
            data.forEach(row => {
                if (!row.datum || !row.sortiment || !row.kolicina) return;

                const dateParts = row.datum.split(/[\/\.\-]/);
                const day = parseInt(dateParts[0]);
                const recordMonth = parseInt(dateParts[1]) - 1;
                const recordYear = parseInt(dateParts[2]);

                if (recordYear !== y || recordMonth !== m) return;

                const datum = new Date(recordYear, recordMonth, day);
                const weekInfo = getWeekWithinMonth(datum, y, m);
                const weekKey = weekInfo.weekNumber;

                const week = weeksMap.get(weekKey);
                if (!week) return; // Safety check

                const sortiment = row.sortiment;
                const kolicina = parseFloat(row.kolicina) || 0;

                if (!week.sortimentiSums[sortiment]) {
                    week.sortimentiSums[sortiment] = 0;
                }
                week.sortimentiSums[sortiment] += kolicina;
            });

            // Konvertuj u array i sortiraj po broju sedmice
            const weeks = [];
            weeksMap.forEach(week => weeks.push(week));
            weeks.sort((a, b) => a.weekNumber - b.weekNumber);

            return weeks;
        }

        // Render sedmični izvještaj za primača/otpremača
        function renderPrimacOtpremacSedmicni(weeklyData, sortimentiNazivi, tablePrefix, year, month) {
            const header = document.getElementById(`${tablePrefix}-header`);
            const body = document.getElementById(`${tablePrefix}-body`);
            const footer = document.getElementById(`${tablePrefix}-footer`);

            // Header
            let headerHtml = '<tr><th>Sedmica</th>';
            sortimentiNazivi.forEach(sortiment => {
                headerHtml += `<th style="text-align: right;">${sortiment}</th>`;
            });
            headerHtml += '<th style="text-align: right; font-weight: bold;">UKUPNO</th></tr>';
            header.innerHTML = headerHtml;

            // Body
            let bodyHtml = '';
            const monthTotals = {};
            sortimentiNazivi.forEach(s => monthTotals[s] = 0);
            let monthTotal = 0;

            weeklyData.forEach((week, index) => {
                const rowStyle = index % 2 === 0 ? 'background: #f9fafb;' : '';
                bodyHtml += `<tr style="${rowStyle}">`;
                bodyHtml += `<td><strong>Sedmica ${week.weekNumber}</strong><br><span style="color: #6b7280; font-size: 12px;">${week.weekStart} - ${week.weekEnd}</span></td>`;

                let weekTotal = 0;
                sortimentiNazivi.forEach(sortiment => {
                    const value = week.sortimentiSums[sortiment] || 0;
                    monthTotals[sortiment] += value;
                    weekTotal += value;

                    bodyHtml += `<td style="text-align: right;">${value.toFixed(2)}</td>`;
                });

                monthTotal += weekTotal;
                bodyHtml += `<td style="text-align: right; font-weight: bold;">${weekTotal.toFixed(2)}</td>`;
                bodyHtml += '</tr>';
            });

            body.innerHTML = bodyHtml;

            // Footer (totals)
            let footerHtml = '<tr style="background: linear-gradient(135deg, #047857 0%, #065f46 100%); color: white; font-weight: bold;">';
            footerHtml += '<td>UKUPNO MJESEC</td>';
            sortimentiNazivi.forEach(sortiment => {
                const total = monthTotals[sortiment];
                footerHtml += `<td style="text-align: right;">${total.toFixed(2)}</td>`;
            });
            footerHtml += `<td style="text-align: right;">${monthTotal.toFixed(2)}</td>`;
            footerHtml += '</tr>';
            footer.innerHTML = footerHtml;
        }

        // Render mjesečni izvještaj za primača/otpremača
        function renderPrimacOtpremacMjesecni(sortimentiSums, sortimentiNazivi, tablePrefix, year, month) {
            const header = document.getElementById(`${tablePrefix}-header`);
            const body = document.getElementById(`${tablePrefix}-body`);
            const footer = document.getElementById(`${tablePrefix}-footer`);

            const monthNames = ['Januar', 'Februar', 'Mart', 'April', 'Maj', 'Juni', 'Juli', 'August', 'Septembar', 'Oktobar', 'Novembar', 'Decembar'];

            // Header
            let headerHtml = '<tr><th>Sortiment</th><th style="text-align: right;">Količina (m³)</th></tr>';
            header.innerHTML = headerHtml;

            // Body
            let bodyHtml = '';
            let total = 0;

            sortimentiNazivi.forEach((sortiment, index) => {
                const value = sortimentiSums[sortiment] || 0;
                total += value;
                const rowStyle = index % 2 === 0 ? 'background: #f9fafb;' : '';
                bodyHtml += `<tr style="${rowStyle}">`;
                bodyHtml += `<td><strong>${sortiment}</strong></td>`;
                bodyHtml += `<td style="text-align: right;">${value.toFixed(2)}</td>`;
                bodyHtml += '</tr>';
            });

            body.innerHTML = bodyHtml;

            // Footer (total)
            let footerHtml = '<tr style="background: linear-gradient(135deg, #047857 0%, #065f46 100%); color: white; font-weight: bold;">';
            footerHtml += '<td>UKUPNO</td>';
            footerHtml += `<td style="text-align: right;">${total.toFixed(2)}</td>`;
            footerHtml += '</tr>';
            footer.innerHTML = footerHtml;
        }

    </script>
</body>
</html>
